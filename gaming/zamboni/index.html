<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title
    class="translate"
    data-fr="Olympiques d'hiver — Trilogie switch"
    data-en="Winter Olympics — Switch Trilogy"
    data-ja="冬季オリンピック — スイッチ三部作"
  >Olympiques d'hiver — Trilogie switch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="../../css/otherswitch.css">
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #050510;
      color: #fefefe;
      font-family: 'Nunito', 'Segoe UI', sans-serif;
    }

    #olympic-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      display: block;
    }

    #promptOverlay,
    #finalOverlay {
      position: fixed;
      inset: 0;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: clamp(16px, 2.4vw, 28px);
      padding: clamp(24px, 5vw, 72px);
      background: rgba(6, 12, 26, 0.86);
      backdrop-filter: blur(8px);
    }

    #finalOverlay {
      display: none;
    }

    #promptOverlay h1,
    #finalOverlay h1 {
      margin: 0;
      font-size: clamp(1.5rem, 3vw, 2.8rem);
      letter-spacing: 0.04em;
      color: #f7f2ff;
    }

    #promptOverlay p,
    #finalOverlay p {
      margin: 0;
      font-size: clamp(1rem, 2.1vw, 1.35rem);
      line-height: 1.55;
      max-width: min(720px, 92vw);
      color: rgba(255, 255, 255, 0.9);
    }

    #startButton,
    #restartButton {
      padding: clamp(14px, 2vw, 20px) clamp(36px, 6vw, 60px);
      font-size: clamp(1.1rem, 2.4vw, 1.5rem);
      border: none;
      border-radius: 16px;
      background: linear-gradient(135deg, #4bd1ff, #ffd26f);
      color: #1a1033;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.02em;
      box-shadow: 0 14px 36px rgba(35, 152, 255, 0.35);
      transition: filter 0.2s ease, transform 0.1s ease;
    }

    #startButton:hover,
    #restartButton:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    #hudHint {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9;
      padding: 10px 18px;
      border-radius: 999px;
      background: rgba(10, 15, 30, 0.72);
      color: rgba(255, 255, 255, 0.85);
      font-size: clamp(0.85rem, 1.6vw, 1rem);
      letter-spacing: 0.03em;
      display: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>
<body>
  <div id="promptOverlay">
    <h1 class="translate"
        data-fr="Trilogie olympique"
        data-en="Olympic trilogy"
        data-ja="オリンピック三部作">
      Trilogie olympique
    </h1>
    <p class="translate"
       data-fr="Trois jeux enchaînés : cérémonie d'ouverture, canon à neige, puis Zamboni. Utilise la barre d'espace (ou touche l'écran) pour déclencher les actions. Chaque partie se termine automatiquement et passe à la suivante."
       data-en="Three connected games: opening ceremony, snow cannon, then Zamboni. Use the space bar (or tap) to trigger actions. Each part completes automatically and moves to the next."
       data-ja="開会式、雪砲、ザンボーニの3つのゲームが連続します。スペースキー（またはタップ）でアクションを起動します。各パートは自動で次に進みます。">
      Trois jeux enchaînés : cérémonie d'ouverture, canon à neige, puis Zamboni. Utilise la barre d'espace (ou touche l'écran) pour déclencher les actions. Chaque partie se termine automatiquement et passe à la suivante.
    </p>
    <button id="startButton" class="translate" data-fr="Commencer" data-en="Start" data-ja="開始">Commencer</button>
  </div>

  <div id="finalOverlay">
    <h1 class="translate"
        data-fr="Finale olympique !"
        data-en="Olympic finale!"
        data-ja="オリンピック・フィナーレ！">
      Finale olympique !
    </h1>
    <p class="translate"
       data-fr="Bravo, la patinoire brille et l'esprit des Jeux s'illumine."
       data-en="Well done — the rink shines and the Olympic spirit glows."
       data-ja="よくできました。リンクは輝き、オリンピックの精神が灯ります。">
      Bravo, la patinoire brille et l'esprit des Jeux s'illumine.
    </p>
    <button id="restartButton" class="translate" data-fr="Recommencer" data-en="Restart" data-ja="再スタート">Recommencer</button>
  </div>

  <div id="hudHint" class="translate"
       data-fr="Espace / Tap : action"
       data-en="Space / Tap: action"
       data-ja="スペース / タップ: アクション">
    Espace / Tap : action
  </div>

  <script type="module">
    import { createOpeningCeremony } from './opening-ceremony.js';
    import { createSnowCannon } from './snow-cannon.js';
    import { createZamboniGame } from './zamboni-game.js';

    const startOverlay = document.getElementById('promptOverlay');
    const finalOverlay = document.getElementById('finalOverlay');
    const startButton = document.getElementById('startButton');
    const restartButton = document.getElementById('restartButton');
    const hudHint = document.getElementById('hudHint');

    let games = [];
    let activeIndex = 0;
    let activeGame = null;
    let started = false;
    let transitionStart = null;
    const transitionDuration = 1800;

    const beginTransition = () => {
      transitionStart = performance.now();
    };

    const advanceGame = () => {
      if (!games.length) return;
      activeIndex += 1;
      if (activeIndex >= games.length) {
        activeGame = null;
        finalOverlay.style.display = 'flex';
        hudHint.style.display = 'none';
        return;
      }
      activeGame = games[activeIndex];
      activeGame.enter?.();
    };

    const requestFullscreen = () => {
      const root = document.documentElement;
      const req = root.requestFullscreen || root.webkitRequestFullscreen || root.msRequestFullscreen;
      if (!req) return;
      const result = req.call(root);
      if (result && typeof result.catch === 'function') {
        result.catch(() => {});
      }
    };

    const startExperience = () => {
      if (started) return;
      started = true;
      startOverlay.style.display = 'none';
      hudHint.style.display = 'block';
      finalOverlay.style.display = 'none';
      activeIndex = 0;
      activeGame = games[activeIndex];
      activeGame.enter?.();
      requestFullscreen();
    };

    const restartExperience = () => {
      started = false;
      startOverlay.style.display = 'flex';
      finalOverlay.style.display = 'none';
      hudHint.style.display = 'none';
    };

    const sketch = p => {
      p.setup = () => {
        const canvas = p.createCanvas(window.innerWidth, window.innerHeight);
        canvas.id('olympic-canvas');
        games = [
          createOpeningCeremony(p),
          createSnowCannon(p),
          createZamboniGame(p)
        ];
        games.forEach(game => game.resize?.());
      };

      p.draw = () => {
        if (!started) {
          p.background(8, 10, 25);
          return;
        }
        if (!activeGame) {
          p.background(6, 12, 28);
          return;
        }
        activeGame.draw?.(p);
        if (activeGame.isComplete?.() && !transitionStart) {
          beginTransition();
        }
        if (transitionStart) {
          const elapsed = performance.now() - transitionStart;
          const fade = p.constrain(elapsed / transitionDuration, 0, 1);
          p.noStroke();
          p.fill(6, 8, 22, 200 * fade);
          p.rect(0, 0, p.width, p.height);
          if (elapsed >= transitionDuration) {
            transitionStart = null;
            advanceGame();
          }
        }
      };

      p.windowResized = () => {
        p.resizeCanvas(window.innerWidth, window.innerHeight);
        games.forEach(game => game.resize?.());
      };

      p.keyPressed = () => {
        if (!started || !activeGame) return undefined;
        if (p.key === ' ' || p.keyCode === 32) {
          if (!transitionStart) {
            activeGame.onPress?.();
          }
          return false;
        }
        return undefined;
      };

      p.mousePressed = () => {
        if (!started || !activeGame) return;
        if (!transitionStart) {
          activeGame.onPress?.();
        }
      };

      p.touchStarted = () => {
        if (!started || !activeGame) return;
        if (!transitionStart) {
          activeGame.onPress?.();
        }
        return false;
      };
    };

    new p5(sketch);

    startButton?.addEventListener('click', startExperience);
    startButton?.addEventListener('touchend', evt => {
      evt.preventDefault();
      startExperience();
    });

    restartButton?.addEventListener('click', restartExperience);

    window.addEventListener('keydown', evt => {
      if (evt.code === 'Space') {
        evt.preventDefault();
      }
      if (!started && (evt.code === 'Enter' || evt.code === 'NumpadEnter')) {
        evt.preventDefault();
        startExperience();
      }
    });
  </script>
</body>
</html>
