<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title class="translate" data-fr="Nombre-événement" data-en="Number as Event" data-ja="イベントとしての数">Nombre-événement</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root {
      --night-1: #050915;
      --night-2: #0a1f2e;
      --night-3: #0c3144;
      --accent-1: #5eead4;
      --accent-2: #a5f3fc;
      --accent-3: #f472b6;
      --accent-4: #60a5fa;
    }

    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: radial-gradient(circle at 20% 20%, rgba(37, 99, 235, 0.1), transparent 35%),
                  radial-gradient(circle at 80% 10%, rgba(56, 189, 248, 0.12), transparent 30%),
                  linear-gradient(160deg, var(--night-1), var(--night-2), var(--night-3));
      color: #e2e8f0;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
    }

    #langToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 2000;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 2px solid #14b8a6;
      background: rgba(5, 9, 21, 0.85);
      color: #a5f3fc;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
    }

    #game-options.modal {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #control-panel-options {
      max-width: 980px;
    }

    .intro-text {
      margin: 0 0 12px;
      line-height: 1.5;
      color: #0f172a;
      background: linear-gradient(120deg, rgba(94, 234, 212, 0.18), rgba(96, 165, 250, 0.16));
      border: 1px solid rgba(94, 234, 212, 0.35);
      padding: 12px 14px;
      border-radius: 12px;
    }

    #game-options-controls {
      display: flex;
      justify-content: center;
      gap: 14px;
      padding-bottom: 10px;
    }

    .scene {
      position: fixed;
      inset: 0;
      overflow: hidden;
      background: inherit;
    }

    .layer-glow {
      position: absolute;
      inset: -10%;
      background: radial-gradient(circle at 15% 40%, rgba(94, 234, 212, 0.08), transparent 35%),
                  radial-gradient(circle at 80% 60%, rgba(96, 165, 250, 0.12), transparent 30%),
                  radial-gradient(circle at 50% 20%, rgba(244, 114, 182, 0.08), transparent 35%);
      filter: blur(0px);
      z-index: 0;
      pointer-events: none;
    }

    #hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 14px;
      background: rgba(5, 9, 21, 0.6);
      border: 1px solid rgba(94, 234, 212, 0.35);
      border-radius: 12px;
      color: #e0f2fe;
      font-weight: 600;
      z-index: 3;
      text-align: center;
      backdrop-filter: blur(6px);
    }

    #gazePointer {
      position: absolute;
      width: 60px;
      height: 60px;
      margin-left: -30px;
      margin-top: -30px;
      border-radius: 50%;
      pointer-events: none;
      background: radial-gradient(circle, rgba(94, 234, 212, 0.24) 0%, rgba(94, 234, 212, 0.07) 60%, transparent 70%);
      border: 2px solid rgba(94, 234, 212, 0.9);
      box-shadow: 0 0 20px rgba(94, 234, 212, 0.55), 0 0 40px rgba(96, 165, 250, 0.35);
      transition: transform 0.16s ease, opacity 0.2s ease;
      opacity: 0;
      z-index: 2;
    }

    body.playing #gazePointer { opacity: 1; }
    body.pointer-hidden #gazePointer { opacity: 0 !important; }

    .burst {
      position: absolute;
      pointer-events: none;
      opacity: 0;
      z-index: 1;
      mix-blend-mode: screen;
    }

    .burst.pulse {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid rgba(94, 234, 212, 0.8);
      transform: translate(-50%, -50%) scale(0.5);
      animation: pulse 1.6s ease-out forwards;
    }

    .burst.spark {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(165, 243, 252, 0.95) 0%, rgba(96, 165, 250, 0.4) 70%, transparent 100%);
      transform: translate(-50%, -50%) scale(0.8);
      animation: sparkle 1.4s ease-out forwards;
    }

    .burst.drop {
      width: 12px;
      height: 34px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(96, 165, 250, 0.7), rgba(94, 234, 212, 0.15));
      transform-origin: center;
      transform: translate(-50%, -50%) scale(0.9);
      animation: drop 1.3s ease-out forwards;
      filter: drop-shadow(0 0 10px rgba(94, 234, 212, 0.6));
    }

    .burst.ring {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 3px solid rgba(244, 114, 182, 0.7);
      transform: translate(-50%, -50%) scale(0.5);
      animation: ring 1.5s ease-out forwards;
    }

    @keyframes pulse {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.6); }
      60% { opacity: 0.9; transform: translate(-50%, -50%) scale(2.2); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(2.6); }
    }

    @keyframes sparkle {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.7); }
      40% { opacity: 1; transform: translate(-50%, -50%) scale(1.6); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) translateY(-30px); }
    }

    @keyframes drop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.6) translateY(-10px); }
      20% { opacity: 1; }
      70% { opacity: 1; transform: translate(-50%, -50%) scale(1) translateY(90px); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.05) translateY(120px); }
    }

    @keyframes ring {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.4); }
      70% { opacity: 0.85; transform: translate(-50%, -50%) scale(2); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(2.6); }
    }

    .caption {
      color: #0f172a;
      margin-top: 6px;
      font-size: 14px;
      line-height: 1.4;
    }

    body.playing #game-options { display: none !important; }
  </style>
</head>
<body>
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <div id="game-options" class="modal">
    <div id="options-title-bar">
      <h2 id="options-main-title" class="translate" data-fr="Nombre-événement" data-en="Number as Event" data-ja="イベントとしての数">Nombre-événement</h2>
    </div>

    <div id="control-panel-options">
      <p class="intro-text translate" data-fr="Fixe l'écran : chaque regard déclenche une voix qui annonce un nombre, puis exactement autant d'éclats lumineux." data-en="Look at the screen: every gaze cues a spoken number, followed by the same count of light blooms." data-ja="画面を見つめると、数が読み上げられ、その数だけ光のイベントが起こります。">Fixe l'écran : chaque regard déclenche une voix qui annonce un nombre, puis exactement autant d'éclats lumineux.</p>

      <div id="mode-divider"></div>
      <div id="options-inline-container">
        <div class="options-column">
          <div class="option-item">
            <label for="maxNumber" class="teal-label">
              <span class="translate" data-fr="Nombre maximum" data-en="Highest number" data-ja="最大の数">Nombre maximum</span>:
              <span id="maxNumberVal">5</span>
            </label>
            <input type="range" id="maxNumber" class="styled-slider" min="1" max="9" value="5">
          </div>
          <div class="option-item">
            <label for="cooldown" class="teal-label">
              <span class="translate" data-fr="Rythme minimum" data-en="Minimum pace" data-ja="最小の間隔">Rythme minimum</span>:
              <span id="cooldownVal">1.8</span> s
            </label>
            <input type="range" id="cooldown" class="styled-slider" min="0.8" max="3.5" step="0.1" value="1.8">
            <div class="caption translate" data-fr="Temps minimum entre deux déclenchements." data-en="Minimum time between triggers." data-ja="連続の発動までの最小時間です。">Temps minimum entre deux déclenchements.</div>
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label for="voiceVol" class="teal-label">
              <span class="translate" data-fr="Volume de la voix" data-en="Voice volume" data-ja="音声の音量">Volume de la voix</span>:
              <span id="voiceVolVal">100</span>%
            </label>
            <input type="range" id="voiceVol" class="styled-slider" min="20" max="100" value="100">
          </div>
          <div class="option-item">
            <label class="teal-label">
              <input type="checkbox" id="softChime" checked>
              <span class="translate" data-fr="Tintement doux avec chaque nombre" data-en="Soft chime with each number" data-ja="数ごとにやさしいチャイム">Tintement doux avec chaque nombre</span>
            </label>
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label for="dwellTimeSlider" class="teal-label">
              <span class="translate" data-fr="Temps de fixation" data-en="Dwell time" data-ja="注視時間">Temps de fixation</span>:
              <span id="dwellTimeVal">1500</span> ms
            </label>
            <input type="range" id="dwellTimeSlider" class="styled-slider" min="500" max="4000" step="100" value="1500">
          </div>
          <div class="option-item">
            <label class="teal-label">
              <input type="checkbox" id="showPointer" checked>
              <span class="translate" data-fr="Afficher l'onde du regard" data-en="Show gaze ripple" data-ja="視線の波紋を表示">Afficher l'onde du regard</span>
            </label>
          </div>
        </div>
      </div>

      <div id="mode-divider"></div>
      <div id="game-options-controls">
        <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start" data-ja="開始">Commencer</button>
      </div>
    </div>
  </div>

  <div id="scene" class="scene" aria-live="polite">
    <div class="layer-glow"></div>
    <div id="gazePointer"></div>
    <div id="hint" class="translate" data-fr="Fixe n'importe où : un nombre sera prononcé et la même quantité d'éclats apparaîtra." data-en="Look anywhere: a number will be spoken and the same count of bursts will appear." data-ja="どこを見ても、その数だけ光のイベントが現れます。">Fixe n'importe où : un nombre sera prononcé et la même quantité d'éclats apparaîtra.</div>
  </div>

  <audio id="chimeSound" src="../../sounds/harp.mp3" preload="auto"></audio>

  <script src="../../js/eyegaze-menu.js"></script>
  <script src="../../js/translationmain.js"></script>
  <script>
    const startButton = document.getElementById('startButton');
    const scene = document.getElementById('scene');
    const gazePointer = document.getElementById('gazePointer');
    const maxNumber = document.getElementById('maxNumber');
    const maxNumberVal = document.getElementById('maxNumberVal');
    const cooldown = document.getElementById('cooldown');
    const cooldownVal = document.getElementById('cooldownVal');
    const dwellSlider = document.getElementById('dwellTimeSlider');
    const dwellVal = document.getElementById('dwellTimeVal');
    const voiceVol = document.getElementById('voiceVol');
    const voiceVolVal = document.getElementById('voiceVolVal');
    const softChime = document.getElementById('softChime');
    const showPointer = document.getElementById('showPointer');
    const chimeSound = document.getElementById('chimeSound');
    const langBtn = document.getElementById('langToggle');

    let gazePos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    let lastMove = performance.now();
    let lastTrigger = 0;
    let playing = false;

    const numberWords = {
      fr: ['un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'],
      en: ['one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'],
      ja: ['いち', 'に', 'さん', 'よん', 'ご', 'ろく', 'なな', 'はち', 'きゅう']
    };

    function clamp(num, min, max) {
      return Math.min(Math.max(num, min), max);
    }

    function updateLabels() {
      maxNumberVal.textContent = maxNumber.value;
      cooldownVal.textContent = Number(cooldown.value).toFixed(1);
      voiceVolVal.textContent = voiceVol.value;
      dwellVal.textContent = dwellSlider.value;
    }

    function requestFullscreenIfPossible() {
      const el = document.documentElement;
      if (!document.fullscreenElement && el.requestFullscreen) {
        el.requestFullscreen().catch(() => {});
      }
    }

    function randomBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    function pickPalette() {
      const palettes = [
        ['#5eead4', '#a5f3fc', '#60a5fa'],
        ['#f472b6', '#c4b5fd', '#60a5fa'],
        ['#fcd34d', '#fda4af', '#38bdf8']
      ];
      return palettes[Math.floor(Math.random() * palettes.length)];
    }

    function spawnBurst(x, y, color, type) {
      const el = document.createElement('div');
      el.className = `burst ${type}`;
      el.style.left = `${x + randomBetween(-40, 40)}px`;
      el.style.top = `${y + randomBetween(-40, 40)}px`;
      el.style.filter = `drop-shadow(0 0 14px ${color})`;
      if (type === 'pulse' || type === 'ring') {
        el.style.borderColor = color;
      } else {
        el.style.background = type === 'drop'
          ? `linear-gradient(180deg, ${color}, rgba(94, 234, 212, 0.1))`
          : `radial-gradient(circle, ${color} 0%, rgba(255,255,255,0.35) 70%, transparent 100%)`;
      }
      scene.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }

    function triggerSequence(x, y) {
      const maxVal = parseInt(maxNumber.value, 10) || 1;
      const count = Math.max(1, Math.floor(Math.random() * maxVal) + 1);
      const lang = document.documentElement.lang || 'en';
      const words = numberWords[lang] || numberWords.en;
      const spoken = words[count - 1] || words[words.length - 1] || String(count);

      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(spoken);
        utterance.lang = lang === 'fr' ? 'fr-FR' : (lang === 'ja' ? 'ja-JP' : 'en-US');
        utterance.volume = clamp(parseInt(voiceVol.value, 10) / 100, 0, 1);
        try { speechSynthesis.cancel(); } catch (e) {}
        speechSynthesis.speak(utterance);
      }

      if (softChime.checked) {
        const clone = chimeSound.cloneNode(true);
        clone.volume = 0.6;
        clone.play().catch(() => {});
      }

      if (navigator.vibrate) {
        const pattern = Array(count).fill(120);
        navigator.vibrate(pattern);
      }

      const palette = pickPalette();
      const types = ['pulse', 'spark', 'drop', 'ring'];
      for (let i = 0; i < count; i++) {
        const color = palette[i % palette.length];
        const type = types[i % types.length];
        setTimeout(() => spawnBurst(x, y, color, type), i * 130);
      }
      lastTrigger = performance.now();
    }

    function maybeTrigger(now) {
      if (!playing) return;
      const dwellNeeded = window.eyegazeSettings?.dwellTime || parseInt(dwellSlider.value, 10);
      const gapNeeded = parseFloat(cooldown.value) * 1000;
      if (now - lastMove >= dwellNeeded && now - lastTrigger >= gapNeeded) {
        triggerSequence(gazePos.x, gazePos.y);
      }
      requestAnimationFrame(maybeTrigger);
    }

    function updateGaze(evt) {
      const point = evt.touches ? evt.touches[0] : evt;
      gazePos.x = point.clientX;
      gazePos.y = point.clientY;
      lastMove = performance.now();
      gazePointer.style.transform = `translate(${gazePos.x}px, ${gazePos.y}px)`;
    }

    function startExperience() {
      requestFullscreenIfPossible();
      document.body.classList.add('playing');
      playing = true;
      lastMove = performance.now();
      lastTrigger = 0;
      maybeTrigger(performance.now());
    }

    function togglePointerVisibility() {
      document.body.classList.toggle('pointer-hidden', !showPointer.checked);
    }

    function syncDwellWithMenu() {
      const val = setEyegazeDwellTime(dwellSlider.value);
      dwellVal.textContent = val;
    }

    langBtn?.addEventListener('click', toggleLanguage);
    startButton.addEventListener('click', startExperience);

    scene.addEventListener('pointermove', updateGaze);
    scene.addEventListener('pointerdown', () => { if (playing) triggerSequence(gazePos.x, gazePos.y); });
    scene.addEventListener('touchmove', updateGaze, { passive: true });

    maxNumber.addEventListener('input', updateLabels);
    cooldown.addEventListener('input', updateLabels);
    voiceVol.addEventListener('input', updateLabels);
    dwellSlider.addEventListener('input', syncDwellWithMenu);
    showPointer.addEventListener('change', togglePointerVisibility);

    initEyegazeMenu();
    updateLabels();
    syncDwellWithMenu();
    togglePointerVisibility();
    gazePointer.style.transform = `translate(${gazePos.x}px, ${gazePos.y}px)`;

    window.addEventListener('resize', () => {
      gazePos.x = clamp(gazePos.x, 0, window.innerWidth);
      gazePos.y = clamp(gazePos.y, 0, window.innerHeight);
      gazePointer.style.transform = `translate(${gazePos.x}px, ${gazePos.y}px)`;
    });
  </script>
</body>
</html>
