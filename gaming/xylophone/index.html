<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title class="translate"
         data-fr="Xylophone géant"
         data-en="Giant Xylophone">
    Xylophone géant
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- styles communs (overlay, menu, etc.) -->
  <link rel="stylesheet" href="../../css/otherswitch.css">

  <style>
    :root {
      --c1: #FF595E; --c2: #FF924C; --c3: #FFCA3A; --c4: #8AC926;
      --c5: #1982C4; --c6: #6A4C93; --c7: #B5179E; --c8: #2EC4B6;
      --gap: 3rem;
      --side-pad: 3rem;
      --sel-offset: 6px;
      --sel-border: 4px;
      --corner-length: 1.5rem;
      --corner-radius: 0.5rem;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      touch-action: manipulation;
    }
    body.light {
      background: #fff;
      color: #000;
    }

    /* Xylophone container */
    #xylophone {
      display: flex;
      gap: var(--gap);
      padding: 0 var(--side-pad);
      width: 100%;
      justify-content: center;
      align-items: center;
    }

    /* Bars */
    .bar {
      position: relative;
      width: calc((100% - 7 * var(--gap)) / 8);
      min-width: 70px;
      flex: 0 0 auto;
      border-radius: 1rem;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      cursor: default;
      outline: none;
      transition: transform 0.05s;
      transform-origin: center bottom;
    }
    .bar:active { transform: scale(0.96); }

    /* selection corners */
    .bar .corner {
      position: absolute;
      display: none;
      width: var(--corner-length);
      height: var(--corner-length);
    }
    .bar.selected .corner { display: block; }
    .bar .corner.tl {
      top: calc(var(--sel-offset) * -1);
      left: calc(var(--sel-offset) * -1);
      border-top: var(--sel-border) solid red;
      border-left: var(--sel-border) solid red;
      border-top-left-radius: var(--corner-radius);
    }
    .bar .corner.tr {
      top: calc(var(--sel-offset) * -1);
      right: calc(var(--sel-offset) * -1);
      border-top: var(--sel-border) solid red;
      border-right: var(--sel-border) solid red;
      border-top-right-radius: var(--corner-radius);
    }
    .bar .corner.bl {
      bottom: calc(var(--sel-offset) * -1);
      left: calc(var(--sel-offset) * -1);
      border-bottom: var(--sel-border) solid red;
      border-left: var(--sel-border) solid red;
      border-bottom-left-radius: var(--corner-radius);
    }
    .bar .corner.br {
      bottom: calc(var(--sel-offset) * -1);
      right: calc(var(--sel-offset) * -1);
      border-bottom: var(--sel-border) solid red;
      border-right: var(--sel-border) solid red;
      border-bottom-right-radius: var(--corner-radius);
    }

    /* suspension dots */
    .bar .dot {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 20%;
      aspect-ratio: 1;
      background: #333;
      border-radius: 50%;
    }
    .bar .dot.top { top: 8%; }
    .bar .dot.bottom { bottom: 8%; }

    /* flash effect */
    @keyframes flash {
      0%   { filter: brightness(3); transform: scale(1); }
      50%  { filter: brightness(2); transform: scale(1.08); }
      100% { filter: brightness(1); transform: scale(1); }
    }
    .bar.flash { animation: flash 0.2s ease-out; }

    /* heights & colors */
    #b1 { background: var(--c1); height: 40vh; }
    #b2 { background: var(--c2); height: 45vh; }
    #b3 { background: var(--c3); height: 50vh; }
    #b4 { background: var(--c4); height: 55vh; }
    #b5 { background: var(--c5); height: 60vh; }
    #b6 { background: var(--c6); height: 65vh; }
    #b7 { background: var(--c7); height: 70vh; }
    #b8 { background: var(--c8); height: 75vh; }

    /* Menu */
    #menu {
      position: fixed;
      top: 60px; right: -300px;
      width: 270px;
      background: rgba(0,0,0,0.85);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: right 0.3s ease, opacity 0.3s ease;
      opacity: 0;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
      z-index: 2000;
    }
    #menu.show { right: 10px; opacity: 1; }

    #menu h2 {
      font-size: 20px; text-align: center; margin-bottom: 0.5rem; color: #00bfff;
    }
    #menu label {
      display: flex; flex-direction: column; margin: 10px 0; font-size: 13px; color: #fff;
    }
    #menu label.inline {
      flex-direction: row; align-items: center; justify-content: space-between;
      background: #008080; padding: 5px 8px; border-radius: 4px;
    }
    #menu label.inline span { margin: 0; color: #fff; font-size: 13px; }
    #menu input[type="range"],
    #menu button,
    #menu input[type="checkbox"] {
      width: 100%; margin-top: 5px;
    }

    /* settings icon */
    #settings-icon {
      position: fixed; top: 10px; right: 10px;
      width: 40px; height: 40px; border-radius: 50%;
      display: none; align-items: center; justify-content: center;
      font-size: 20px; cursor: pointer;
      background-color: rgba(0,0,0,0.7);
      transition: transform 0.3s, background-color 0.3s;
      z-index: 1100;
    }
  </style>
</head>

<body class="light">
  <!-- landing overlay with mode selector -->
  <div id="promptOverlay">
    <p data-fr="Choisissez un mode puis appuyez sur Commencer."
       data-en="Select a mode then press Start.">
      Choisissez un mode puis appuyez sur Commencer.
    </p>
    <div id="modeSelect">
      <label>
        <input type="radio" name="mode" value="manual" checked>
        <span data-fr="Mode manuel" data-en="Manual mode">Mode manuel</span>
      </label>
      <label>
        <input type="radio" name="mode" value="scan">
        <span data-fr="Mode balayage" data-en="Scanning mode">Mode balayage</span>
      </label>
      <label>
        <input type="radio" name="mode" value="step">
        <span data-fr="Mode étape" data-en="Step mode">Mode étape</span>
      </label>
      <label id="scanIntervalLabel" style="display:none; margin-top:10px;">
        <span data-fr="Intervalle de balayage (s)" data-en="Scan interval (s)">
          Intervalle de balayage (s)
        </span>
        <span id="scanIntVal">2</span>
        <input type="range" id="scanInterval" min="1" max="10" value="2">
      </label>
    </div>
    <button id="startButton" data-fr="Commencer" data-en="Start">Commencer</button>
  </div>

  <!-- xylophone -->
  <div id="xylophone" role="group" aria-label="Xylophone">
    <div id="b1" class="bar" aria-label="Do">
      <span class="dot top"></span><span class="dot bottom"></span>
      <span class="corner tl"></span><span class="corner tr"></span>
      <span class="corner bl"></span><span class="corner br"></span>
    </div>
    <div id="b2" class="bar" aria-label="Ré">
      <span class="dot top"></span><span class="dot bottom"></span>
      <span class="corner tl"></span><span class="corner tr"></span>
      <span class="corner bl"></span><span class="corner br"></span>
    </div>
    <div id="b3" class="bar" aria-label="Mi">
      <span class="dot top"></span><span class="dot bottom"></span>
      <span class="corner tl"></span><span class="corner tr"></span>
      <span class="corner bl"></span><span class="corner br"></span>
    </div>
    <div id="b4" class="bar" aria-label="Fa">
      <span class="dot top"></span><span class="dot bottom"></span>
      <span class="corner tl"></span><span class="corner tr"></span>
      <span class="corner bl"></span><span class="corner br"></span>
    </div>
    <div id="b5" class="bar" aria-label="Sol">
      <span class="dot top"></span><span class="dot bottom"></span>
      <span class="corner tl"></span><span class="corner tr"></span>
      <span class="corner bl"></span><span class="corner br"></span>
    </div>
    <div id="b6" class="bar" aria-label="La">
      <span class="dot top"></span><span class="dot bottom"></span>
      <span class="corner tl"></span><span class="corner tr"></span>
      <span class="corner bl"></span><span class="corner br"></span>
    </div>
    <div id="b7" class="bar" aria-label="Si">
      <span class="dot top"></span><span class="dot bottom"></span>
      <span class="corner tl"></span><span class="corner tr"></span>
      <span class="corner bl"></span><span class="corner br"></span>
    </div>
    <div id="b8" class="bar" aria-label="Do">
      <span class="dot top"></span><span class="dot bottom"></span>
      <span class="corner tl"></span><span class="corner tr"></span>
      <span class="corner bl"></span><span class="corner br"></span>
    </div>
  </div>

  <!-- settings icon & menu -->
  <div id="settings-icon" class="translate" title="Settings" data-fr="⚙️" data-en="⚙️">⚙️</div>
  <div id="menu">
    <h2 data-fr="Options" data-en="Options">Options</h2>

    <label>
      <span data-fr="Volume" data-en="Volume">Volume</span>
      <span id="volVal">100</span>
      <input type="range" id="volumeSlider" min="0" max="100" value="100">
    </label>

    <label>
      <span>Durée de la note (s)</span>
      <span id="timeVal">1.0s</span>
      <input type="range" id="timeSlider" min="0.1" max="5" step="0.1" value="1">
    </label>

    <label class="inline">
      <span data-fr="Flash lumineux" data-en="Light flash">Flash lumineux</span>
      <input type="checkbox" id="flashToggle" checked>
    </label>

    <label class="inline">
      <span data-fr="Fond clair" data-en="Light background">Fond clair</span>
      <input type="checkbox" id="bgToggle" checked>
    </label>
  </div>

  <script>
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const freqs = [261.63,293.66,329.63,349.23,392,440,493.88,523.25];
    const master = ctx.createGain(); master.gain.value=1; master.connect(ctx.destination);

    function createReverb(d=1.6, decay=2.5){
      const len=ctx.sampleRate*d, buf=ctx.createBuffer(2,len,ctx.sampleRate);
      for(let ch=0; ch<2; ch++){
        const data=buf.getChannelData(ch);
        for(let i=0;i<len;i++){
          data[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay);
        }
      }
      const conv=ctx.createConvolver(); conv.buffer=buf; return conv;
    }
    const wet=ctx.createGain(); wet.gain.value=.35;
    wet.connect(createReverb()).connect(master);

    let timeScale=1,
        mode='manual',
        scanInterval=2000,
        scanTimer=null,
        current=-1,
        direction=1;

    const bars=[...document.querySelectorAll('.bar')];

    function moveIndicator(){
      if(current>=0) bars[current].classList.remove('selected');
      let next=current+direction;
      if(next>=bars.length){ direction=-1; next=current+direction; }
      else if(next<0){ direction=1; next=current+direction; }
      current=next;
      bars[current].classList.add('selected');
    }

    function playNote(i){
      const f0=freqs[i];
      const partials=[
        {r:1,g:1,d:1},{r:3.99,g:.55,d:.9},{r:9,g:.3,d:.75},
        {r:14.37,g:.22,d:.6},{r:19.2,g:.12,d:.45}
      ];
      const dry=ctx.createGain(); dry.gain.value=.9;
      dry.connect(master); dry.connect(wet);
      partials.forEach(p=>{
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='sine'; o.frequency.value=f0*p.r;
        const dur=p.d*timeScale;
        g.gain.setValueAtTime(0,ctx.currentTime);
        g.gain.linearRampToValueAtTime(p.g,ctx.currentTime+0.008);
        g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+dur);
        o.connect(g).connect(dry);
        o.start(); o.stop(ctx.currentTime+dur);
      });
    }

    window.addEventListener('keydown', e=>{
      if(!document.getElementById('promptOverlay')){
        if(mode==='manual' && e.code==='Space'){
          e.preventDefault();
          moveIndicator();
          playNote(current);
        }
        else if(mode==='scan' && e.code==='Space'){
          e.preventDefault();
          if(current>=0) playNote(current);
        }
        else if(mode==='step'){
          if(e.code==='Enter'){
            e.preventDefault();
            moveIndicator();
          }
          else if(e.code==='Space'){
            e.preventDefault();
            if(current>=0){
              playNote(current);
              bars[current].classList.add('flash');
              setTimeout(()=>bars[current].classList.remove('flash'),200);
            }
          }
        }
      }
    });

    window.addEventListener('load', ()=>{
      const overlay=document.getElementById('promptOverlay'),
            startBtn=document.getElementById('startButton'),
            modeRadios=[...document.querySelectorAll('input[name=mode]')],
            scanLabel=document.getElementById('scanIntervalLabel'),
            scanSlider=document.getElementById('scanInterval'),
            scanVal=document.getElementById('scanIntVal'),
            volSlider=document.getElementById('volumeSlider'),
            volVal=document.getElementById('volVal'),
            timeSlider=document.getElementById('timeSlider'),
            timeVal=document.getElementById('timeVal'),
            bgToggle=document.getElementById('bgToggle'),
            icon=document.getElementById('settings-icon'),
            menu=document.getElementById('menu');

      modeRadios.forEach(r=>{
        r.addEventListener('change', ()=>{
          mode=r.value;
          scanLabel.style.display=mode==='scan'?'block':'none';
        });
      });
      scanSlider.addEventListener('input', e=>{
        scanInterval=e.target.value*1000;
        scanVal.textContent=e.target.value;
        if(scanTimer){
          clearInterval(scanTimer);
          scanTimer=setInterval(moveIndicator,scanInterval);
        }
      });
      volSlider.addEventListener('input', e=>{
        master.gain.value=e.target.value/100;
        volVal.textContent=e.target.value;
      });
      timeSlider.addEventListener('input', e=>{
        timeScale=parseFloat(e.target.value);
        timeVal.textContent=`${e.target.value}s`;
      });
      bgToggle.addEventListener('change', e=>{
        document.body.classList.toggle('light', e.target.checked);
      });

      document.body.classList.add('light');

      startBtn.addEventListener('pointerup', e=>{
        e.preventDefault();
        mode=modeRadios.find(r=>r.checked).value;
        overlay.remove();
        icon.style.display='flex';
        document.documentElement.requestFullscreen?.().catch(()=>{});
        if(ctx.state==='suspended') ctx.resume();
        if(mode==='scan'){
          scanInterval=scanSlider.value*1000;
          scanTimer=setInterval(moveIndicator,scanInterval);
        }
      });
      icon.addEventListener('pointerup', ()=>menu.classList.toggle('show'));
    });
  </script>

  <script src="../../js/translationonly.js"></script>
</body>
</html>
