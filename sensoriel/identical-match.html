<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="../images/binou.png">
  <link rel="stylesheet" href="../css/ipadteachh.css">
  <link rel="stylesheet" href="css/sensorial-base.css">
  <title>Images identiques</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; font-family: 'Poppins', 'Segoe UI', sans-serif; }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    #activityNumberOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.85);
      color: #fff;
      font-size: clamp(4rem, 12vw, 9rem);
      z-index: 1000;
    }
    #activityNumberOverlay .number-text { font-weight: 700; }

    .game-container {
      display: none;
      width: 100%;
      height: 100%;
      padding: clamp(20px, 4vh, 36px);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(236, 244, 255, 0.92));
      border-radius: clamp(18px, 2.6vw, 28px);
      box-shadow: inset 0 0 0 1px rgba(15, 30, 60, 0.08);
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 3vh, 28px);
    }

    .identical-game {
      flex: 1 1 auto;
      min-height: 0;
      display: grid;
      grid-template-rows: auto minmax(0, 1fr) auto auto;
      gap: clamp(16px, 3vh, 26px);
      justify-items: center;
      text-align: center;
    }

    .identical-progress {
      display: none;
    }

    .identical-progress-dots {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(10px, 2vw, 18px);
    }

    .identical-progress-dots .dot {
      width: clamp(12px, 1.8vw, 18px);
      height: clamp(12px, 1.8vw, 18px);
      border-radius: 50%;
      background: rgba(148, 163, 184, 0.55);
      box-shadow: inset 0 0 0 2px rgba(15, 23, 42, 0.12);
      transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
    }

    .identical-progress-dots .dot.is-active {
      background: rgba(37, 99, 235, 0.85);
      transform: scale(1.25);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
    }

    .identical-layout {
      width: 100%;
      display: grid;
      grid-template-columns: minmax(clamp(260px, 28vw, 360px), max-content) minmax(0, 1fr);
      gap: clamp(24px, 4vw, 48px);
      align-items: stretch;
    }

    .choice-column {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 3vh, 28px);
    }

    .target-panel {
      width: 100%;
      display: grid;
      justify-items: center;
      align-content: start;
      gap: clamp(12px, 2vh, 20px);
    }

    .target-card {
      width: min(100%, clamp(240px, 38vw, 340px));
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .target-card img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .choice-grid {
      width: 100%;
      max-width: clamp(340px, 65vw, 600px);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(110px, 16vw, 160px), 1fr));
      gap: clamp(16px, 2.6vw, 26px);
      align-items: stretch;
      justify-items: center;
    }

    .choice-card {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: clamp(16px, 3vw, 24px);
      border: 3px solid transparent;
      background: #fff;
      box-shadow: 0 18px 32px rgba(15, 30, 60, 0.16);
      padding: clamp(10px, 2vh, 18px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      touch-action: manipulation;
      user-select: none;
    }

    .choice-card img {
      width: 82%;
      height: 82%;
      object-fit: contain;
      pointer-events: none;
    }

    .choice-card:focus,
    .choice-card:hover {
      outline: none;
      border-color: rgba(28, 140, 214, 0.7);
      transform: translateY(-4px);
    }

    .choice-card.is-correct {
      border-color: #16a34a;
      background: rgba(34, 197, 94, 0.15);
    }

    .choice-card.is-incorrect {
      border-color: #dc2626;
      background: rgba(248, 113, 113, 0.18);
      animation: shake 0.35s ease;
    }

    .choice-card.is-disabled {
      cursor: default;
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }

    .identical-feedback {
      min-height: clamp(28px, 4vh, 36px);
      font-size: clamp(1.05rem, 2vw, 1.3rem);
      font-weight: 600;
      color: #0f172a;
    }

    @media (max-width: 1100px) {
      .identical-layout {
        grid-template-columns: minmax(0, 1fr);
        justify-items: center;
        }
      .target-panel {
        width: min(80vw, 380px);
      }
    }

    @media (max-width: 720px) {
      .choice-column {
        width: 100%;
        align-items: center;
      }
      .choice-grid {
        max-width: 100%;
        grid-template-columns: repeat(auto-fit, minmax(clamp(120px, 44vw, 1fr), 1fr));
      }
      .choice-card img {
        max-width: 92%;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
  </style>
</head>
<body class="sensorial-game">
  <div id="activityNumberOverlay" role="presentation">
    <div class="number-text"></div>
  </div>
  <div class="sensorial-shell">
    <header class="sensorial-header">
      <div class="sensorial-header-main">
        <h1 class="sensorial-title">Images identiques</h1>
        <div class="sensorial-activity-marker" role="group" aria-label="Activité en cours">
          <img src="../images/plasticbasket.png" alt="" />
          <span class="sensorial-activity-number">–</span>
        </div>
      </div>
      <p class="sensorial-subtitle">Observe l’image modèle et touche celle qui est identique.</p>
    </header>
    <main class="sensorial-content">
      <div class="game-container" id="identicalGame" aria-live="polite">
        <section class="identical-game" aria-describedby="identicalProgressStatus identicalFeedback">
          <div class="identical-progress-dots" id="identicalProgressDots" role="presentation"></div>
          <span class="sr-only" id="identicalProgressStatus" aria-live="polite"></span>
          <div class="identical-layout">
            <div class="target-panel">
              <div class="target-card" id="targetCard"></div>
            </div>
            <div class="choice-column">
              <div class="choice-grid" id="choiceGrid"></div>
            </div>
          </div>
          <p class="identical-feedback" id="identicalFeedback" aria-live="assertive"></p>
        </section>
      </div>
    </main>
  </div>
  <audio id="error-sound" src="" preload="auto"></audio>
  <audio id="word-reward-sound" src="" preload="auto"></audio>
  <audio id="final-reward-sound" src="" preload="auto"></audio>
  <script src="../js/themes.js"></script>
  <script src="js/games-config.js"></script>
  <script src="js/session-helpers.js"></script>
  <script src="js/reinforcer-overlay.js"></script>
  <script src="js/fullscreen.js"></script>
  <script>
    (function () {
      'use strict';

      let session = null;
      let themeData = {};
      let reinforcerController = null;
      let reinforcerType = 'shortvideo';
      let totalRounds = 4;
      let choiceCount = 3;
      let currentRound = 0;
      let imagePool = [];
      let poolIndex = 0;
      let isLocked = false;

      const progressDotsEl = document.getElementById('identicalProgressDots');
      const progressStatusEl = document.getElementById('identicalProgressStatus');
      const targetCardEl = document.getElementById('targetCard');
      const choiceGridEl = document.getElementById('choiceGrid');
      const feedbackEl = document.getElementById('identicalFeedback');
      const gameContainer = document.getElementById('identicalGame');

      document.addEventListener('DOMContentLoaded', () => {
        session = sessionHelpers.ensureCurrentGame('identical-match');
        if (!session) { return; }

        sessionHelpers.updateActivityMarker(session);

        themeData = session.themeData || {};
        reinforcerType = (session.selections && session.selections.reinforcerType) || 'shortvideo';

        document.getElementById('error-sound').src = themeData.errorSound || '../sounds/error.mp3';
        document.getElementById('word-reward-sound').src = themeData.reinforcerSound || '../sounds/success3.mp3';
        document.getElementById('final-reward-sound').src = themeData.finalRewardSound || '../sounds/victory.mp3';

        const options = sessionHelpers.getCurrentGameOptions(session);
        const parsedRounds = parseInt(options.roundCount, 10);
        const parsedChoices = parseInt(options.choiceCount, 10);
        if (Number.isFinite(parsedRounds)) {
          totalRounds = Math.min(Math.max(parsedRounds, 1), 10);
        }
        if (Number.isFinite(parsedChoices)) {
          choiceCount = Math.min(Math.max(parsedChoices, 2), 5);
        }

        reinforcerController = sessionHelpers.setupSharedReinforcer(session, {
          reinforcerType,
          onAdvance: sessionHelpers.advanceToNextGame
        });

        imagePool = buildImagePool();
        if (imagePool.length === 0) {
          imagePool = ['../images/binou.png'];
        }
        imagePool = shuffleArray(imagePool);

        sessionHelpers.showActivityOverlay(() => {
          gameContainer.style.display = 'flex';
          startGame();
        }, session);
      });

      function buildImagePool() {
        if (Array.isArray(themeData.transparentPNGs) && themeData.transparentPNGs.length > 0) {
          return themeData.transparentPNGs.slice();
        }
        if (Array.isArray(themeData.images) && themeData.images.length > 0) {
          return themeData.images.slice();
        }
        return [];
      }

      function startGame() {
        currentRound = 0;
        poolIndex = 0;
        nextRound();
      }

      function nextRound() {
        if (currentRound >= totalRounds) {
          finishGame();
          return;
        }
        currentRound += 1;
        buildRound();
      }

      function buildRound() {
        isLocked = false;
        feedbackEl.textContent = '';
        updateProgressIndicators();

        const target = pickTargetImage();
        renderTarget(target);

        const options = buildChoices(target);
        renderChoices(options, target);
      }

      function updateProgressIndicators() {
        if (!progressDotsEl) {
          return;
        }

        const dots = [];
        for (let index = 1; index <= totalRounds; index += 1) {
          const dot = document.createElement('span');
          dot.className = 'dot';
          if (index === currentRound) {
            dot.classList.add('is-active');
          }
          dot.setAttribute('aria-hidden', 'true');
          dots.push(dot);
        }

        progressDotsEl.innerHTML = '';
        dots.forEach((dot) => progressDotsEl.appendChild(dot));

        if (progressStatusEl) {
          progressStatusEl.textContent = `Essai ${currentRound} sur ${totalRounds}`;
        }
      }

      function pickTargetImage() {
        if (poolIndex >= imagePool.length) {
          poolIndex = 0;
          imagePool = shuffleArray(imagePool.slice());
        }
        const image = imagePool[poolIndex];
        poolIndex += 1;
        return image;
      }

      function renderTarget(src) {
        targetCardEl.innerHTML = '';
        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Image modèle';
        targetCardEl.appendChild(img);
      }

      function buildChoices(target) {
        const requiredDistractors = Math.max(choiceCount - 1, 1);
        const available = imagePool.filter((img) => img !== target);
        const distractors = [];
        const shuffled = shuffleArray(available.slice());
        while (distractors.length < requiredDistractors) {
          if (shuffled.length > 0) {
            const candidate = shuffled.shift();
            if (!distractors.includes(candidate)) {
              distractors.push(candidate);
            }
          } else if (available.length > 0) {
            distractors.push(available[distractors.length % available.length]);
          } else {
            distractors.push(target);
          }
        }
        const combined = distractors.concat(target);
        return shuffleArray(combined);
      }

      function renderChoices(images, correctSrc) {
        choiceGridEl.innerHTML = '';
        images.forEach((src, index) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'choice-card';
          button.dataset.image = src;
          button.setAttribute('aria-label', `Choix ${index + 1}`);

          const img = document.createElement('img');
          img.src = src;
          img.alt = '';
          button.appendChild(img);

          button.addEventListener('click', () => handleChoice(button, correctSrc));
          button.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              handleChoice(button, correctSrc);
            }
          });

          choiceGridEl.appendChild(button);
        });
      }

      function handleChoice(button, correctSrc) {
        if (isLocked || !button) {
          return;
        }
        const chosen = button.dataset.image;
        if (chosen === correctSrc) {
          isLocked = true;
          feedbackEl.textContent = 'Bravo ! C’est la bonne image.';
          playSound('word-reward-sound');
          button.classList.add('is-correct', 'is-disabled');
          disableOtherChoices(button);
          setTimeout(() => {
            nextRound();
          }, currentRound >= totalRounds ? 1200 : 900);
        } else {
          button.classList.add('is-incorrect');
          feedbackEl.textContent = 'Essaie encore.';
          playSound('error-sound');
          setTimeout(() => {
            button.classList.remove('is-incorrect');
          }, 600);
        }
      }

      function disableOtherChoices(correctButton) {
        const buttons = Array.from(choiceGridEl.querySelectorAll('.choice-card'));
        buttons.forEach((btn) => {
          btn.disabled = true;
          btn.classList.add('is-disabled');
        });
        correctButton.classList.add('is-correct');
      }

      function finishGame() {
        const finalSound = document.getElementById('final-reward-sound');
        finalSound.currentTime = 0;
        finalSound.play().catch(() => {});
        setTimeout(() => {
          if (reinforcerController && typeof reinforcerController.show === 'function') {
            reinforcerController.show({ reinforcerType });
          } else {
            sessionHelpers.advanceToNextGame();
          }
        }, 300);
      }

      function playSound(id) {
        const audio = document.getElementById(id);
        if (!audio) { return; }
        audio.currentTime = 0;
        audio.play().catch(() => {});
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
    })();
  </script>
</body>
</html>
