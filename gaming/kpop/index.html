<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>K-pop Demon Hunter</title>
  <link rel="stylesheet" href="../../css/games.css" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Quicksand", "Segoe UI", system-ui, sans-serif;
      min-height: 100vh;
      background: #03000a;
      color: #fef6ff;
      overflow: hidden;
    }

    .stage {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center 120%, rgba(180, 120, 255, 0.16), rgba(5, 0, 15, 0.95)),
                  radial-gradient(circle at 50% 20%, rgba(255, 245, 200, 0.12), rgba(0, 0, 0, 0.95));
      overflow: hidden;
    }

    .stage::before,
    .stage::after {
      content: "";
      position: absolute;
      inset: -30%;
      background: conic-gradient(from 120deg, rgba(255, 79, 172, 0.1), rgba(111, 72, 255, 0.25), rgba(255, 79, 172, 0.1));
      opacity: 0.6;
      filter: blur(60px);
      transform-origin: center;
      animation: aurora 14s linear infinite;
      pointer-events: none;
    }
    .stage::after {
      animation-direction: reverse;
      opacity: 0.45;
    }

    @keyframes aurora {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.08); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .stage-entry {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 50%, rgba(15, 3, 30, 0.9) 0%, rgba(3, 0, 10, 0.95) 55%, rgba(0, 0, 0, 1) 100%);
      transform: scale(1.35);
      opacity: 1;
      animation: stageReveal 2.6s cubic-bezier(.23,1,.32,1) forwards;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes stageReveal {
      0% { opacity: 0; transform: scale(1.6); }
      20% { opacity: 1; transform: scale(1.6); }
      55% { opacity: 1; transform: scale(1.15); }
      100% { opacity: 0; transform: scale(1); }
    }

    .silhouette-row {
      position: absolute;
      bottom: clamp(24px, 7vh, 72px);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: clamp(32px, 6vw, 96px);
      align-items: flex-end;
      z-index: 1;
    }

    .silhouette {
      position: relative;
      width: clamp(140px, 18vw, 240px);
      aspect-ratio: 3 / 4;
      background-image: var(--hero-img);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center bottom;
      filter: brightness(0) saturate(130%) contrast(1.6);
      opacity: 0.95;
      transform-origin: bottom center;
      animation: idleBreathe 6s ease-in-out infinite;
      mix-blend-mode: normal;
      transition: transform 220ms ease, opacity 220ms ease;
      overflow: visible;
    }

    .silhouette::before {
      content: "";
      position: absolute;
      inset: -16% -14% -8%;
      background: radial-gradient(circle at 50% 15%, rgba(255, 200, 255, 0.2), rgba(255, 120, 220, 0));
      opacity: 0;
      transform: translateY(18px) scale(0.95);
      filter: blur(12px);
      transition: opacity 260ms ease, transform 260ms ease;
      pointer-events: none;
    }

    .silhouette.active {
      opacity: 1;
      animation: spotlightPulse 1.4s ease-in-out infinite;
    }

    .silhouette.active::before {
      opacity: 0.6;
      transform: translateY(0) scale(1.1);
    }

    .silhouette.engaged {
      transform: translateY(-10px) scale(1.02);
    }

    .silhouette-hero {
      position: absolute;
      inset: 0;
      background: var(--hero-img) center bottom / contain no-repeat;
      opacity: 0;
      transform: translateY(28%) scale(0.68);
      filter: drop-shadow(0 0 32px rgba(255, 120, 220, 0.55));
      pointer-events: none;
      z-index: 1;
    }

    .silhouette-hero.show {
      animation: heroFromShadow 820ms cubic-bezier(.22,1.05,.32,1) forwards;
    }

    .silhouette-hero.present {
      opacity: 1;
      transform: translateY(-6%) scale(1.05);
    }

    .silhouette-hero.retreat {
      animation: heroRetreat 480ms cubic-bezier(.66,.03,.67,.98) forwards;
    }

    @keyframes idleBreathe {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-6px) scale(1.02); }
    }

    @keyframes spotlightPulse {
      0%, 100% { transform: translateY(-10px) scale(1.05); }
      50% { transform: translateY(-4px) scale(1.03); }
    }

    @keyframes heroFromShadow {
      0% {
        opacity: 0;
        transform: translateY(32%) scale(0.62);
      }
      45% {
        opacity: 1;
        transform: translateY(-4%) scale(1.08);
      }
      70% {
        opacity: 1;
        transform: translateY(-10%) scale(0.98);
      }
      100% {
        opacity: 1;
        transform: translateY(-6%) scale(1.05);
      }
    }

    @keyframes heroRetreat {
      0% {
        opacity: 1;
        transform: translateY(-6%) scale(1.05);
      }
      100% {
        opacity: 0;
        transform: translateY(34%) scale(0.64);
      }
    }

    .monster-area {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
      z-index: 2;
    }

    .monster {
      width: clamp(140px, 20vw, 220px);
      aspect-ratio: 1;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 0 28px rgba(255, 55, 155, 0.7));
      opacity: 0;
      transform: scale(0.2) rotate(-14deg);
      animation: monsterRise 1s cubic-bezier(.22,1.13,.59,1) forwards;
    }

    @keyframes monsterRise {
      0% { opacity: 0; transform: translateY(120px) scale(0.35) rotate(-12deg); }
      60% { opacity: 1; transform: translateY(-12px) scale(1.05) rotate(4deg); }
      100% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
    }

    .monster.banish {
      animation: monsterBanish 420ms ease-in forwards;
    }

    @keyframes monsterBanish {
      0% { opacity: 1; transform: scale(1) translateY(0); filter: drop-shadow(0 0 32px rgba(255, 150, 230, 0.8)); }
      70% { opacity: 0.35; transform: scale(0.7) translateY(-40px); }
      100% { opacity: 0; transform: scale(0.35) translateY(-120px); }
    }

    .slash-trail {
      position: absolute;
      width: 260px;
      height: 120px;
      background: radial-gradient(ellipse at left, rgba(255,255,255,0.95) 0%, rgba(255,224,120,0.7) 40%, rgba(255,255,255,0) 75%),
                  linear-gradient(90deg, rgba(255,220,150,0.95), rgba(255,80,190,0));
      border-radius: 120px;
      mix-blend-mode: screen;
      opacity: 0;
      transform-origin: left center;
      pointer-events: none;
      z-index: 4;
      animation: slashStrike 360ms ease-out forwards;
    }

    @keyframes slashStrike {
      0% { opacity: 0; transform: translate(-40px, 40px) rotate(-12deg) scaleX(0.3); }
      40% { opacity: 1; transform: translate(0, 0) rotate(-12deg) scaleX(1.05); }
      100% { opacity: 0; transform: translate(80px, -20px) rotate(-12deg) scaleX(1.4); }
    }

    .hit-flare {
      position: absolute;
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(255,255,255,0.85) 0%, rgba(255,220,120,0.6) 40%, rgba(255,0,165,0) 70%);
      mix-blend-mode: screen;
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.2);
      animation: flare 360ms ease-out forwards;
      pointer-events: none;
      z-index: 3;
    }

    @keyframes flare {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.2); }
      40% { opacity: 0.85; transform: translate(-50%, -50%) scale(1.05); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
    }

    .instructions {
      position: absolute;
      top: clamp(24px, 6vh, 48px);
      left: 50%;
      transform: translateX(-50%);
      padding: 0.85rem 1.6rem;
      background: rgba(20, 4, 32, 0.72);
      border: 1px solid rgba(255, 120, 220, 0.35);
      border-radius: 999px;
      font-size: clamp(1.05rem, 2vw, 1.35rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      box-shadow: 0 0 35px rgba(255, 80, 200, 0.35);
      z-index: 5;
      pointer-events: none;
      transition: opacity 200ms ease;
    }

    .instructions.hidden { opacity: 0; }

    @media (max-width: 768px) {
      .silhouette-row { gap: 28px; }
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="stage-entry" aria-hidden="true"></div>

    <div class="instructions" id="instructions">Press SPACE to unleash your idol</div>

    <div class="silhouette-row" aria-hidden="true">
      <div class="silhouette" data-hero="mira" style="--hero-img:url('../../images/kpop/mira.png')">
        <div class="silhouette-hero"></div>
      </div>
      <div class="silhouette" data-hero="zoey" style="--hero-img:url('../../images/kpop/zoey.png')">
        <div class="silhouette-hero"></div>
      </div>
      <div class="silhouette" data-hero="rumi" style="--hero-img:url('../../images/kpop/rumi.png')">
        <div class="silhouette-hero"></div>
      </div>
    </div>

    <div class="monster-area" id="monsterArea"></div>
  </div>

  <script>
    const heroes = ['mira', 'zoey', 'rumi'];

    const monsters = [
      "../../images/kpop/monster1.png",
      "../../images/kpop/monster2.png"
    ];

    const state = {
      monster: null,
      attackInProgress: false,
      music: null,
      musicStarted: false,
      activeSilhouette: null
    };

    const monsterArea = document.getElementById('monsterArea');
    const instructions = document.getElementById('instructions');

    function ensureMusic() {
      if (!state.music) {
        const audio = new Audio("../../songs/kpop/golden.mp3");
        audio.loop = true;
        audio.volume = 1;
        state.music = audio;
      }
      if (!state.musicStarted && state.music) {
        state.musicStarted = true;
        state.music.play().catch(() => {
          state.musicStarted = false;
        });
      }
    }

    function highlightSilhouette(id) {
      document.querySelectorAll('.silhouette').forEach(el => {
        el.classList.toggle('active', el.dataset.hero === id);
      });
    }

    function clearHighlight() {
      document.querySelectorAll('.silhouette').forEach(el => el.classList.remove('active'));
    }

    function getSilhouetteById(id) {
      return document.querySelector(`.silhouette[data-hero="${id}"]`);
    }

    function startHeroFromSilhouette(id) {
      const silhouette = getSilhouetteById(id);
      if (!silhouette) return null;

      const heroOverlay = silhouette.querySelector('.silhouette-hero');
      silhouette.classList.add('engaged');

      if (!heroOverlay) {
        return silhouette;
      }

      heroOverlay.classList.remove('show', 'present', 'retreat');
      void heroOverlay.offsetWidth;

      heroOverlay.addEventListener('animationend', function handleAnimation(event) {
        if (event.animationName === 'heroFromShadow') {
          heroOverlay.classList.remove('show');
          heroOverlay.classList.add('present');
        }
      }, { once: true });

      heroOverlay.classList.add('show');
      return silhouette;
    }

    function retreatHeroToSilhouette(silhouette) {
      if (!silhouette) return Promise.resolve();

      const heroOverlay = silhouette.querySelector('.silhouette-hero');
      return new Promise(resolve => {
        if (!heroOverlay) {
          silhouette.classList.remove('engaged');
          resolve();
          return;
        }

        heroOverlay.classList.remove('show');
        heroOverlay.classList.remove('retreat');
        if (!heroOverlay.classList.contains('present')) {
          heroOverlay.classList.add('present');
        }

        void heroOverlay.offsetWidth;

        let settled = false;
        const cleanup = () => {
          if (settled) return;
          settled = true;
          heroOverlay.classList.remove('retreat', 'present');
          silhouette.classList.remove('engaged');
          resolve();
        };

        heroOverlay.addEventListener('animationend', event => {
          if (event.animationName === 'heroRetreat') {
            cleanup();
          }
        }, { once: true });

        heroOverlay.classList.add('retreat');
        setTimeout(cleanup, 620);
      });
    }

    function spawnMonster() {
      if (!monsterArea || state.monster) return;

      const monster = document.createElement('div');
      monster.className = 'monster';
      monster.style.backgroundImage = `url('${monsters[Math.floor(Math.random() * monsters.length)]}')`;
      monsterArea.appendChild(monster);
      state.monster = monster;
      instructions?.classList.remove('hidden');
    }

    function removeMonster() {
      if (!state.monster) return;
      const current = state.monster;
      state.monster = null;
      current.classList.add('banish');
      current.addEventListener('animationend', () => current.remove(), { once: true });
    }

    function createSlash(monsterRect) {
      const slash = document.createElement('div');
      slash.className = 'slash-trail';
      slash.style.left = `${monsterRect.left + monsterRect.width * 0.1}px`;
      slash.style.top = `${monsterRect.top + monsterRect.height * 0.3}px`;
      document.body.appendChild(slash);
      slash.addEventListener('animationend', () => slash.remove(), { once: true });

      const flare = document.createElement('div');
      flare.className = 'hit-flare';
      flare.style.left = `${monsterRect.left + monsterRect.width / 2}px`;
      flare.style.top = `${monsterRect.top + monsterRect.height / 2}px`;
      document.body.appendChild(flare);
      flare.addEventListener('animationend', () => flare.remove(), { once: true });
    }

    async function runAttack() {
      if (!state.monster || state.attackInProgress) return;
      state.attackInProgress = true;
      ensureMusic();

      instructions?.classList.add('hidden');
      const heroId = heroes[Math.floor(Math.random() * heroes.length)];
      highlightSilhouette(heroId);
      state.activeSilhouette = startHeroFromSilhouette(heroId);

      await new Promise(resolve => setTimeout(resolve, 620));

      if (state.monster) {
        const rect = state.monster.getBoundingClientRect();
        createSlash(rect);
        removeMonster();
      }

      await new Promise(resolve => setTimeout(resolve, 400));
      await retreatHeroToSilhouette(state.activeSilhouette);
      state.activeSilhouette = null;
      clearHighlight();
      state.attackInProgress = false;

      setTimeout(spawnMonster, 1600);
    }

    function handleKey(event) {
      if (event.code === 'Space') {
        event.preventDefault();
        runAttack();
      }
    }

    window.addEventListener('keydown', handleKey);

    window.addEventListener('pointerdown', () => {
      // allow touch/click users to trigger the same experience
      runAttack();
    });

    window.addEventListener('blur', () => {
      if (state.music && !document.hasFocus()) {
        state.music.pause();
        state.musicStarted = false;
      }
    });

    window.addEventListener('focus', () => {
      if (state.music && state.attackInProgress) {
        ensureMusic();
      }
    });

    setTimeout(spawnMonster, 1800);
  </script>
</body>
</html>
