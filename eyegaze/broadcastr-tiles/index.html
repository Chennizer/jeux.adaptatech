<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title class="translate" data-fr="Diffuseur de tuiles (Broadcastr)" data-en="Tile Broadcaster (Broadcastr)" data-ja="タイル配信（Broadcastr）">Diffuseur de tuiles (Broadcastr)</title>
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: black;
      color: #111;
      font-family: 'Arial', sans-serif;
      overflow: hidden;
      font-size: 13px;
    }

    #options-title-bar h2 {
      font-size: 1.1rem;
      margin: 6px 0;
    }

    /* 3 columns, tighter spacing */
    #game-options #control-panel-options {
      max-width: 1050px;
      width: 96%;
      padding: 14px;
    }

    #options-inline-container {
      grid-template-columns: repeat(3, 1fr);
      width: 100%;
      gap: 12px;
      margin-top: 6px;
      align-items: stretch;
    }

    #options-inline-container .options-column {
      align-items: stretch;
    }

    .section-card {
      width: 100%;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 100%;
    }

    .section-card h3 {
      margin: 0 0 3px 0;
      color: #00695c;
      font-size: 0.96rem;
    }

    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 6px;
      margin-top: 6px;
    }

    .prompt-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
      padding-top: 6px;
      border-top: 2px dashed rgba(0, 150, 136, 0.35);
      padding-right: 8px; /* so fields don’t touch divider */
    }

    .prompt-inline {
      display: grid;
      grid-template-columns: 135px 1fr;
      gap: 6px;
      align-items: center;
    }

    .prompt-controls {
      display: grid;
      grid-template-columns: 135px 1fr;
      gap: 8px;
      align-items: center;
    }

    /* Contenu: champ sous l’étiquette, pas sur la ligne */
    #prompt-text-row {
      grid-template-columns: 1fr;
      padding-right: 4px;
    }

    #prompt-text-row input {
      width: 100%;
    }

    .prompt-controls .button,
    .prompt-controls select,
    .prompt-controls input {
      width: 100%;
    }

    .upload-card {
      border: 2px solid #009688;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }

    .upload-card footer {
      padding: 4px 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      background: #e0f2f1;
      font-size: 0.78rem;
      font-weight: bold;
      color: #004d40;
    }

    .upload-card button {
      border: none;
      background: #c62828;
      color: white;
      border-radius: 6px;
      padding: 3px 6px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.75rem;
    }

    .muted {
      color: #4f5b62;
      font-size: 0.84rem;
      line-height: 1.2;
    }

    .choices-grid {
      display: grid;
      gap: 8px;
      margin-top: 4px;
    }

    .choice-row {
      display: grid;
      grid-template-columns: 110px minmax(150px, 1fr) 100px;
      gap: 8px;
      align-items: center;
    }

    .choice-row > div {
      min-width: 0;
    }

    .choice-row select,
    .choice-row input,
    .choice-row textarea {
      width: 100%;
      padding: 7px 9px;
      border: 2px solid #009688;
      border-radius: 7px;
      font-size: 0.9rem;
      min-height: 34px;
      color: #004d40;
      box-sizing: border-box;
    }

    .choice-row select { background: #fff; }
    .choice-row input { background: #fff; }

    #toast {
      position: fixed;
      bottom: 12px;
      right: 12px;
      background: #009688;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
      z-index: 10;
      font-weight: bold;
      font-size: 0.86rem;
    }

    #toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    #viewer-status {
      color: #00695c;
      font-weight: bold;
      margin-top: 6px;
      font-size: 0.84rem;
    }

    .correct-toggle {
      display: flex;
      align-items: center;
      gap: 3px;
      color: #004d40;
      font-weight: 700;
      font-size: 0.8rem;
    }

    .correct-toggle input[type="checkbox"] {
      transform: scale(0.8);
      accent-color: #009688;
    }

    .reinforcer-card {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .option-item {
      font-size: 0.86rem;
    }

    /* Local video upload layout */
    .video-upload {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .video-upload > label.teal-label {
      display: block;
    }

    /* Center the "Ajouter des vidéos" button in its container */
    .video-upload > div {
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .video-upload .button[for="video-input"] {
      display: inline-block;
    }
  </style>
</head>
<body>
  <div id="options-title-bar">
    <h2 class="translate" data-fr="Activité de diffusion des tuiles" data-en="Tile broadcasting activity" data-ja="タイル配信アクティビティ">Activité de diffusion des tuiles</h2>
  </div>
  <div id="game-options" class="modal" style="display: flex;">
    <div id="control-panel-options">
      <div id="options-inline-container" class="options-inline-container">
        <!-- Colonne 1 : images + prompt + temps de fixation -->
        <div class="options-column">
          <div class="section-card">
            <h3 class="translate" data-fr="1. Ajouter des images" data-en="1. Add images" data-ja="1. 画像を追加">1. Ajouter des images</h3>
            <p class="muted translate" data-fr="Chargez des images réutilisables pour les choix." data-en="Upload reusable images for the choices." data-ja="選択肢で使う画像をアップロードしてください。">Chargez des images réutilisables pour les choix.</p>
            <div>
              <label class="button translate" for="image-input" data-fr="Ajouter des images" data-en="Add images" data-ja="画像を追加">Ajouter des images</label>
              <input type="file" id="image-input" accept="image/*" multiple style="display:none" />
            </div>
            <div id="upload-grid" class="upload-grid"></div>
            <p class="muted translate" id="no-images-hint" data-fr="Aucune image téléversée." data-en="No images uploaded." data-ja="アップロードされた画像はありません。">Aucune image téléversée.</p>

            <div class="prompt-block">
              <label class="teal-label">
                <input type="checkbox" id="enable-prompt" />
                <span class="translate" data-fr="Afficher un prompt au-dessus des tuiles" data-en="Show a prompt above the tiles" data-ja="タイルの上にプロンプトを表示">Afficher un prompt au-dessus des tuiles</span>
              </label>
              <div class="prompt-inline">
                <label for="prompt-type" class="teal-label translate" data-fr="Type de prompt" data-en="Prompt type" data-ja="プロンプトの種類">Type de prompt</label>
                <select id="prompt-type" class="button" style="background: #fff; color: #004d40; font-weight: 700;">
                  <option value="text" class="translate" data-fr="Texte / nombre" data-en="Text / number" data-ja="テキスト／数字">Texte / nombre</option>
                  <option value="image" class="translate" data-fr="Image" data-en="Image" data-ja="画像">Image</option>
                </select>
              </div>
              <!-- Contenu: champ sous l'étiquette -->
              <div class="prompt-controls" id="prompt-text-row">
                <label for="prompt-text" class="teal-label translate" data-fr="Contenu" data-en="Content" data-ja="内容">Contenu</label>
                <input id="prompt-text" type="text" placeholder="Ex: 3 + 4" class="translate" data-fr-placeholder="Ex : 3 + 4" data-en-placeholder="Eg: 3 + 4" data-ja-placeholder="例：3 + 4" />
              </div>
              <div class="prompt-controls" id="prompt-image-row" style="display: none;">
                <label for="prompt-image" class="teal-label translate" data-fr="Image du prompt" data-en="Prompt image" data-ja="プロンプト画像">Image du prompt</label>
                <select id="prompt-image" class="button" style="background: #fff; color: #004d40; font-weight: 700;"></select>
              </div>
            </div>

            <!-- Temps de fixation déplacé à gauche (sous le prompt) -->
            <div class="option-item">
              <label for="dwell-time" class="teal-label translate" data-fr="Temps de fixation (ms) : " data-en="Dwell time (ms): " data-ja="注視時間（ms）：">
                Temps de fixation (ms) : <span id="dwell-time-value">1500</span>
              </label>
              <input
                type="range"
                id="dwell-time"
                min="500"
                max="4000"
                step="100"
                value="1500"
                class="styled-slider"
              />
            </div>
          </div>
        </div>

        <!-- Colonne 2 : choix seulement -->
        <div class="options-column">
          <div class="section-card">
            <h3 class="translate" data-fr="2. Préparer vos choix" data-en="2. Prepare your choices" data-ja="2. 選択肢を作成">2. Préparer vos choix</h3>
            <p class="muted translate" data-fr="Ouvrez la page élève, puis composez les items à envoyer." data-en="Open the student page, then build the items to send." data-ja="学習者ページを開いて、送る項目を作成してください。">Ouvrez la page élève, puis composez les items à envoyer.</p>
            <div class="option-item">
              <label for="choice-count" class="teal-label translate" data-fr="Nombre de choix: " data-en="Number of choices: " data-ja="選択肢の数：">Nombre de choix: <span id="choice-count-value">3</span></label>
              <input type="range" id="choice-count" min="1" max="6" value="3" class="styled-slider" />
            </div>
            <div id="choices" class="choices-grid"></div>
            <div id="viewer-status">En attente du viewer...</div>
          </div>
        </div>

        <!-- Colonne 3 : renforçateur + vidéos locales -->
        <div class="options-column">
          <div class="section-card reinforcer-card">
            <h3 class="translate" data-fr="3. Choisir un renforçateur" data-en="3. Pick a reinforcer" data-ja="3. 強化動画を選択">3. Choisir un renforçateur</h3>
            <p class="muted translate" data-fr="Sélectionnez la vidéo à jouer lorsque la bonne réponse est choisie." data-en="Select the video to play when the correct answer is chosen." data-ja="正解時に再生する動画を選んでください。">Sélectionnez la vidéo à jouer lorsque la bonne réponse est choisie.</p>

            <!-- Category then video selector populated from bucketindex.json -->
            <label for="reinforcer-category" class="teal-label translate" data-fr="Catégorie / thème" data-en="Category / theme" data-ja="カテゴリー／テーマ">Catégorie / thème</label>
            <select id="reinforcer-category" class="button" style="background: #fff; color: #004d40; font-weight: 700;">
              <option value="" class="translate" data-fr="Chargement des catégories..." data-en="Loading categories..." data-ja="カテゴリーを読み込み中...">Chargement des catégories...</option>
            </select>

            <label for="reinforcer" class="teal-label translate" data-fr="Vidéo de renforçateur" data-en="Reinforcer video" data-ja="強化用動画">Vidéo de renforçateur</label>
            <select id="reinforcer" class="button" style="background: #fff; color: #004d40; font-weight: 700;" disabled>
              <option value="" class="translate" data-fr="Choisir d'abord une catégorie" data-en="Choose a category first" data-ja="先にカテゴリーを選んでください">Choisir d'abord une catégorie</option>
            </select>

            <p class="muted translate" data-fr="Cochez l'option correcte dans la liste des choix." data-en="Check the correct option in the choices list." data-ja="選択肢リストで正解をチェックしてください。">Cochez l'option correcte dans la liste des choix.</p>

            <!-- Local videos upload (no list, only dropdown) -->
            <div class="option-item video-upload">
              <label class="teal-label translate" for="video-input" data-fr="Ajouter des vidéos locales (optionnel)" data-en="Add local videos (optional)" data-ja="ローカル動画を追加（任意）">Ajouter des vidéos locales (optionnel)</label>
              <div>
                <label class="button translate" for="video-input" data-fr="Ajouter des vidéos" data-en="Add videos" data-ja="動画を追加">Ajouter des vidéos</label>
                <input type="file" id="video-input" accept="video/*" multiple style="display:none" />
              </div>
              <p class="muted translate" data-fr="Elles apparaîtront dans la catégorie « Vidéos locales (cet appareil) ». Recharger la page pour vider la liste." data-en="They will appear in the 'Local videos (this device)' category. Reload the page to clear the list." data-ja="「ローカル動画（この端末）」カテゴリに表示されます。リストを消すにはページを再読み込みしてください。">Elles apparaîtront dans la catégorie « Vidéos locales (cet appareil) ». Recharger la page pour vider la liste.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="option-item" style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
        <button id="open-viewer" class="button translate" type="button" data-fr="Ouvrir la page élève" data-en="Open student page" data-ja="学習者ページを開く">Ouvrir la page élève</button>
        <button id="startButton" class="translate" type="button" data-fr="Envoyer les tuiles" data-en="Send tiles" data-ja="タイルを送信">Envoyer les tuiles</button>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    const tileLangs=['fr','en','ja'];
    let tileLang=localStorage.getItem('tileLang')||'fr';
    function applyTileTranslations(lang){
      const target=tileLangs.includes(lang)?lang:'fr';
      document.documentElement.lang=target;
      document.querySelectorAll('.translate').forEach(el=>{
        const text=el.dataset[target];
        if(text) el.textContent=text;
        const ph=el.dataset[`${target}Placeholder`];
        if(ph) el.setAttribute('placeholder', ph);
      });
      const toggle=document.getElementById('langToggle');
      if(toggle) toggle.textContent=target.toUpperCase();
    }
    (function initTileToggle(){
      if(document.getElementById('langToggle')){ applyTileTranslations(tileLang); return; }
      const btn=document.createElement('button');
      btn.id='langToggle';
      btn.style.position='fixed'; btn.style.top='10px'; btn.style.right='10px'; btn.style.zIndex='100000';
      btn.style.padding='6px 10px'; btn.style.borderRadius='10px'; btn.style.border='2px solid #009688';
      btn.style.background='#fff'; btn.style.color='#009688'; btn.style.fontWeight='700'; btn.style.cursor='pointer';
      btn.addEventListener('click',()=>{const idx=tileLangs.indexOf(tileLang); tileLang=tileLangs[(idx+1)%tileLangs.length]; localStorage.setItem('tileLang',tileLang); applyTileTranslations(tileLang);});
      document.body.appendChild(btn);
      applyTileTranslations(tileLang);
    })();

    const channelName = 'eyegaze-broadcastr-tiles';
    const channel = typeof BroadcastChannel !== 'undefined' ? new BroadcastChannel(channelName) : null;
    const imageInput = document.getElementById('image-input');
    const uploadGrid = document.getElementById('upload-grid');
    const noImagesHint = document.getElementById('no-images-hint');
    const choicesContainer = document.getElementById('choices');
    const choiceCountInput = document.getElementById('choice-count');
    const choiceCountValue = document.getElementById('choice-count-value');
    const openViewerBtn = document.getElementById('open-viewer');
    const sendChoicesBtn = document.getElementById('startButton');
    const toast = document.getElementById('toast');
    const viewerStatus = document.getElementById('viewer-status');
    const reinforcerCategorySelect = document.getElementById('reinforcer-category');
    const reinforcerSelect = document.getElementById('reinforcer');
    const enablePrompt = document.getElementById('enable-prompt');
    const promptType = document.getElementById('prompt-type');
    const promptText = document.getElementById('prompt-text');
    const promptImage = document.getElementById('prompt-image');
    const promptTextRow = document.getElementById('prompt-text-row');
    const promptImageRow = document.getElementById('prompt-image-row');
    const dwellTimeInput = document.getElementById('dwell-time');
    const dwellTimeValue = document.getElementById('dwell-time-value');
    const videoInput = document.getElementById('video-input');

    function generateId() {
      if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
        return crypto.randomUUID();
      }
      return 'id-' + Math.random().toString(16).slice(2) + '-' + Date.now();
    }

    const LOCAL_CATEGORY_KEY = '__local_videos';

    const CATEGORY_LABELS = {
      kids_fr: 'Comptines / enfants (FR)',
      kids_intl: 'Comptines / enfants (autres)',
      disney: 'Disney',
      music_mainstream: 'Musique grand public',
      travel_space: 'Voyages / espace',
      vehicles_machines: 'Véhicules / machines',
      sports_extreme: 'Sports extrêmes',
      cartoons_tv: 'Dessins animés / TV',
      edu_games_misc: 'Jeux vidéo / divers',
      sensory: 'Sensoriel',
      [LOCAL_CATEGORY_KEY]: 'Vidéos locales (cet appareil)'
    };

    function labelForCategory(cat) {
      return CATEGORY_LABELS[cat] || cat;
    }

    const STORAGE_KEY = 'eyegazeBroadcastrTilesConfig_v1';
    let loadedState = null;
    let stateAppliedToChoices = false;
    let savedReinforcerCategory = '';
    let savedReinforcerUrl = '';

    let viewerWindow = null;
    let viewerReady = false;
    let uploadedImages = [];
    let lastSentTiles = [];
    let allReinforcers = [];
    let localVideos = []; // { id, name, url }

    function setStatus(message) {
      viewerStatus.textContent = message;
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2400);
    }

    function refreshUploadGrid() {
      uploadGrid.innerHTML = '';
      if (uploadedImages.length === 0) {
        noImagesHint.style.display = 'block';
        refreshPromptImageSelect();
        return;
      }
      noImagesHint.style.display = 'none';
      uploadedImages.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'upload-card';

        const footer = document.createElement('footer');
        const nameSpan = document.createElement('span');
        nameSpan.textContent = item.name;
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Retirer';
        removeBtn.addEventListener('click', () => {
          uploadedImages = uploadedImages.filter((img) => img.id !== item.id);
          refreshUploadGrid();
          renderChoices();
          saveState();
        });
        footer.appendChild(nameSpan);
        footer.appendChild(removeBtn);
        card.appendChild(footer);
        uploadGrid.appendChild(card);
      });
      refreshPromptImageSelect();
    }

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    imageInput.addEventListener('change', async (event) => {
      const files = Array.from(event.target.files || []);
      for (const file of files) {
        const dataUrl = await fileToDataUrl(file);
        uploadedImages.push({ id: generateId(), name: file.name, dataUrl });
      }
      imageInput.value = '';
      refreshUploadGrid();
      renderChoices();
      saveState();
    });

    function refreshPromptImageSelect() {
      promptImage.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = uploadedImages.length ? 'Choisir une image' : 'Aucune image disponible';
      promptImage.appendChild(placeholder);
      uploadedImages.forEach((img) => {
        const opt = document.createElement('option');
        opt.value = img.id;
        opt.textContent = img.name;
        promptImage.appendChild(opt);
      });
    }

    function applyChoicesFromState() {
      if (!loadedState || !Array.isArray(loadedState.choices)) return;
      const rows = Array.from(document.querySelectorAll('.choice-row'));
      loadedState.choices.forEach((saved, index) => {
        if (!rows[index] || !saved) return;
        const row = rows[index];
        const typeSelect = row.querySelector('select.choice-type');
        if (!typeSelect) return;

        // Set type and trigger re-render of input
        typeSelect.value = saved.type || 'number';
        typeSelect.dispatchEvent(new Event('change'));

        const valueEl = row.querySelector('.choice-input');
        if (valueEl && typeof saved.value === 'string') {
          valueEl.value = saved.value;
        }
        const correctEl = row.querySelector('input[type="checkbox"][name="correct-choice"]');
        if (correctEl) correctEl.checked = !!saved.correct;
      });
    }

    function renderChoices() {
      const count = Math.max(1, Math.min(6, Number(choiceCountInput.value) || 1));
      choiceCountInput.value = count;
      choiceCountValue.textContent = count;
      choicesContainer.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const row = document.createElement('div');
        row.className = 'choice-row';

        const typeSelect = document.createElement('select');
        typeSelect.className = 'choice-type';
        typeSelect.innerHTML = `
          <option value="image">Image</option>
          <option value="number">Nombre</option>
          <option value="text">Texte</option>
        `;
        typeSelect.value = 'number';

        const contentWrapper = document.createElement('div');

        const inputField = document.createElement('input');
        inputField.type = 'text';
        inputField.placeholder = 'Saisir le texte ou le nombre';
        inputField.className = 'choice-input';

        const imageSelect = document.createElement('select');
        imageSelect.className = 'choice-input';
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = uploadedImages.length ? 'Choisir une image' : 'Aucune image disponible';
        imageSelect.appendChild(emptyOption);
        uploadedImages.forEach((img) => {
          const opt = document.createElement('option');
          opt.value = img.id;
          opt.textContent = img.name;
          imageSelect.appendChild(opt);
        });

        function refreshContentInput(savedValue) {
          const type = typeSelect.value;
          contentWrapper.innerHTML = '';
          if (type === 'image') {
            const selector = imageSelect.cloneNode(true);
            selector.className = 'choice-input';
            if (savedValue) selector.value = savedValue;
            contentWrapper.appendChild(selector);
          } else {
            const clone = inputField.cloneNode();
            clone.className = 'choice-input';
            clone.type = type === 'number' ? 'number' : 'text';
            clone.placeholder = type === 'number' ? 'Entrer un nombre' : 'Entrer un texte';
            if (savedValue) clone.value = savedValue;
            contentWrapper.appendChild(clone);
          }
        }

        typeSelect.addEventListener('change', () => {
          refreshContentInput();
          saveState();
        });

        refreshContentInput();

        row.appendChild(typeSelect);
        row.appendChild(contentWrapper);

        const correctWrapper = document.createElement('label');
        correctWrapper.className = 'correct-toggle';
        const correctInput = document.createElement('input');
        correctInput.type = 'checkbox';
        correctInput.name = 'correct-choice';
        correctInput.addEventListener('change', (e) => {
          if (e.target.checked) {
            document.querySelectorAll('input[name="correct-choice"]').forEach((box) => {
              if (box !== e.target) box.checked = false;
            });
          }
          saveState();
        });
        correctWrapper.appendChild(correctInput);
        const correctLabel = document.createElement('span');
        correctLabel.textContent = 'Bonne réponse';
        correctWrapper.appendChild(correctLabel);
        row.appendChild(correctWrapper);
        choicesContainer.appendChild(row);
      }

      // Première application de l’état sauvegardé sur les lignes
      if (loadedState && !stateAppliedToChoices && Array.isArray(loadedState.choices)) {
        applyChoicesFromState();
        stateAppliedToChoices = true;
      }
    }

    function syncPromptInputs() {
      const wantsImage = promptType.value === 'image';
      promptTextRow.style.display = wantsImage ? 'none' : 'grid';
      promptImageRow.style.display = wantsImage ? 'grid' : 'none';
    }

    function collectChoicesForState() {
      const rows = Array.from(document.querySelectorAll('.choice-row'));
      return rows.map((row) => {
        const typeSelect = row.querySelector('select.choice-type');
        const type = typeSelect ? typeSelect.value : 'number';
        const valueEl = row.querySelector('.choice-input');
        const value = valueEl ? valueEl.value : '';
        const correctEl = row.querySelector('input[type="checkbox"][name="correct-choice"]');
        const correct = !!(correctEl && correctEl.checked);
        return { type, value, correct };
      });
    }

    function saveState() {
      try {
        const state = {
          choiceCount: Number(choiceCountInput.value) || 3,
          dwellTime: Number(dwellTimeInput.value) || 1500,
          enablePrompt: !!enablePrompt.checked,
          promptType: promptType.value,
          promptText: promptText.value || '',
          promptImage: promptImage.value || '',
          reinforcerCategory: reinforcerCategorySelect.value || '',
          reinforcerUrl: reinforcerSelect.value || '',
          choices: collectChoicesForState()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('Erreur saveState', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const state = JSON.parse(raw);
        loadedState = state;

        if (state.choiceCount) {
          choiceCountInput.value = state.choiceCount;
        }
        if (typeof state.dwellTime === 'number') {
          dwellTimeInput.value = state.dwellTime;
          dwellTimeValue.textContent = state.dwellTime;
        }
        if (typeof state.enablePrompt === 'boolean') {
          enablePrompt.checked = state.enablePrompt;
        }
        if (state.promptType) promptType.value = state.promptType;
        if (state.promptText) promptText.value = state.promptText;
        if (state.promptImage) promptImage.value = state.promptImage;

        savedReinforcerCategory = state.reinforcerCategory || '';
        savedReinforcerUrl = state.reinforcerUrl || '';
      } catch (e) {
        console.error('Erreur loadState', e);
      }
    }

    function collectChoices() {
      const rows = Array.from(document.querySelectorAll('.choice-row'));
      const tiles = [];
      for (const row of rows) {
        const typeSelect = row.querySelector('select.choice-type');
        const type = typeSelect ? typeSelect.value : 'number';
        const inputEl = row.querySelector('.choice-input');
        const correct = row.querySelector('input[type="checkbox"]').checked;
        if (!inputEl) continue;

        if (type === 'image') {
          const imageId = inputEl.value;
          const selected = uploadedImages.find((img) => img.id === imageId);
          if (selected) {
            tiles.push({ id: generateId(), type: 'image', url: selected.dataUrl, label: selected.name, correct });
          }
        } else {
          const value = inputEl.value?.trim();
          if (value) {
            tiles.push({ id: generateId(), type, label: value, correct });
          }
        }
      }
      return tiles;
    }

    function buildPromptPayload() {
      if (!enablePrompt.checked) return null;
      const type = promptType.value;

      if (type === 'text') {
        const value = promptText.value.trim();
        if (!value) {
          showToast('Ajoutez un prompt texte.');
          return { error: true };
        }
        return { type: 'text', value };
      }

      const imageId = promptImage.value;
      const selected = uploadedImages.find((img) => img.id === imageId);
      if (!selected) {
        showToast('Choisissez une image pour le prompt.');
        return { error: true };
      }
      return { type: 'image', url: selected.dataUrl, label: selected.name };
    }

    function sendTiles() {
      if (!channel) {
        showToast('BroadcastChannel indisponible.');
        return;
      }
      const tiles = collectChoices();
      if (!tiles.length) {
        showToast('Ajoutez au moins un choix valide.');
        return;
      }
      const promptPayload = buildPromptPayload();
      if (promptPayload?.error) return;
      lastSentTiles = tiles;

      const dwellTimeMs = Number(dwellTimeInput?.value) || 1500;

      channel.postMessage({
        type: 'tiles',
        tiles,
        prompt: promptPayload || null,
        reinforcer: reinforcerSelect.value || null,
        dwellTimeMs
      });
      showToast('Choix envoyés.');
      saveState();
    }

    sendChoicesBtn.addEventListener('click', sendTiles);

    function openViewer() {
      viewerWindow = window.open('viewer.html', '_blank');
      if (!viewerWindow) {
        showToast('Impossible d\'ouvrir la page élève.');
      }
    }

    openViewerBtn.addEventListener('click', openViewer);

    if (channel) {
      channel.onmessage = (event) => {
        const { type, tileId } = event.data || {};
        if (type === 'viewer-ready') {
          viewerReady = true;
          setStatus('Viewer connecté.');
          showToast('Le viewer est prêt.');
        }
        if (type === 'viewer-closed') {
          viewerReady = false;
          setStatus('Viewer fermé.');
        }
        if (type === 'selection' && tileId) {
          const selectedTile = lastSentTiles.find((tile) => tile.id === tileId);
          if (selectedTile?.correct) {
            showToast('Bonne réponse envoyée.');
          }
        }
      };
      setStatus('En attente du viewer...');
    } else {
      setStatus('BroadcastChannel non pris en charge.');
    }

    dwellTimeInput.addEventListener('input', () => {
      dwellTimeValue.textContent = dwellTimeInput.value;
      saveState();
    });

    // ---- Local videos management (no visible list) ----
    if (videoInput) {
      videoInput.addEventListener('change', (event) => {
        const files = Array.from(event.target.files || []);
        for (const file of files) {
          const url = URL.createObjectURL(file);
          localVideos.push({
            id: generateId(),
            name: file.name,
            url
          });
        }
        videoInput.value = '';
        populateReinforcerCategories();
        showToast('Vidéos locales ajoutées.');
        saveState();
      });
    }

    function populateReinforcerCategories() {
      if (!reinforcerCategorySelect || !reinforcerSelect) return;

      const categoriesSet = new Set(allReinforcers.map(item => item.category));
      if (localVideos.length) {
        categoriesSet.add(LOCAL_CATEGORY_KEY);
      }

      const categories = [...categoriesSet].filter(Boolean).sort();

      reinforcerCategorySelect.innerHTML = '';

      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Choisir une catégorie';
      reinforcerCategorySelect.appendChild(placeholder);

      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = labelForCategory(cat);
        reinforcerCategorySelect.appendChild(opt);
      });

      reinforcerSelect.innerHTML = '';
      const vidPlaceholder = document.createElement('option');
      vidPlaceholder.value = '';
      vidPlaceholder.textContent = 'Choisir d\'abord une catégorie';
      reinforcerSelect.appendChild(vidPlaceholder);
      reinforcerSelect.disabled = true;

      // Réappliquer la sélection sauvegardée si possible
      if (savedReinforcerCategory) {
        reinforcerCategorySelect.value = savedReinforcerCategory;
        populateReinforcerOptions(savedReinforcerCategory);
        if (savedReinforcerUrl) {
          reinforcerSelect.value = savedReinforcerUrl;
        }
      }
    }

    function populateReinforcerOptions(category) {
      reinforcerSelect.innerHTML = '';
      const vidPlaceholder = document.createElement('option');
      vidPlaceholder.value = '';
      vidPlaceholder.textContent = category ? 'Choisir une vidéo' : 'Choisir d\'abord une catégorie';
      reinforcerSelect.appendChild(vidPlaceholder);

      if (!category) {
        reinforcerSelect.disabled = true;
        return;
      }

      let sourceList = [];
      if (category === LOCAL_CATEGORY_KEY) {
        sourceList = localVideos;
      } else {
        sourceList = allReinforcers.filter(item => item.category === category);
      }

      sourceList.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.url;
        opt.textContent = item.theme || item.title || item.name || item.url;
        reinforcerSelect.appendChild(opt);
      });
      reinforcerSelect.disabled = sourceList.length === 0;
    }

    if (reinforcerCategorySelect && reinforcerSelect) {
      fetch('../../js/bucketindex.json')
        .then(resp => resp.json())
        .then(data => {
          allReinforcers = Array.isArray(data) ? data : [];
          if (!allReinforcers.length) {
            showToast('Liste de vidéos vide.');
            return;
          }
          populateReinforcerCategories();
        })
        .catch(err => {
          console.error('Erreur de chargement des vidéos', err);
          showToast('Impossible de charger la liste de vidéos.');
        });

      reinforcerCategorySelect.addEventListener('change', () => {
        populateReinforcerOptions(reinforcerCategorySelect.value);
        saveState();
      });

      reinforcerSelect.addEventListener('change', saveState);
    }

    // Sauvegarde sur changement dans la zone de choix
    choicesContainer.addEventListener('input', (e) => {
      if (e.target.matches('select, input, textarea')) saveState();
    });
    choicesContainer.addEventListener('change', (e) => {
      if (e.target.matches('select, input, textarea')) saveState();
    });

    // Sauvegarde sur changements des options de prompt
    enablePrompt.addEventListener('change', saveState);
    promptType.addEventListener('change', () => {
      syncPromptInputs();
      saveState();
    });
    promptText.addEventListener('input', saveState);
    promptImage.addEventListener('change', saveState);

    // Slider nombre de choix
    choiceCountInput.addEventListener('input', () => {
      renderChoices();
      saveState();
    });
    choiceCountInput.addEventListener('change', () => {
      renderChoices();
      saveState();
    });

    // ---- Init ----
    loadState();
    syncPromptInputs();
    renderChoices();
    refreshUploadGrid();
  </script>
</body>
</html>
