<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diffuseur de tuiles (Broadcastr)</title>
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: black;
      color: #111;
      font-family: 'Arial', sans-serif;
      overflow: hidden;
      font-size: 13px;
    }

    #options-title-bar h2 {
      font-size: 1.1rem;
      margin: 6px 0;
    }

    /* 3 columns, tighter spacing */
    #game-options #control-panel-options {
      max-width: 1050px;
      width: 96%;
      padding: 14px;
    }

    #options-inline-container {
      grid-template-columns: repeat(3, 1fr);
      width: 100%;
      gap: 12px;
      margin-top: 6px;
      align-items: stretch;
    }

    #options-inline-container .options-column {
      align-items: stretch;
    }

    .section-card {
      width: 100%;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 100%;
    }

    .section-card h3 {
      margin: 0 0 3px 0;
      color: #00695c;
      font-size: 0.96rem;
    }

    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 6px;
      margin-top: 6px;
    }

    .prompt-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
      padding-top: 6px;
      border-top: 2px dashed rgba(0, 150, 136, 0.35);
      padding-right: 8px; /* so fields don’t touch divider */
    }

    .prompt-inline {
      display: grid;
      grid-template-columns: 135px 1fr;
      gap: 6px;
      align-items: center;
    }

    .prompt-controls {
      display: grid;
      grid-template-columns: 135px 1fr;
      gap: 8px;
      align-items: center;
    }

    /* Contenu: champ sous l’étiquette, pas sur la ligne */
    #prompt-text-row {
      grid-template-columns: 1fr;
      padding-right: 4px;
    }

    #prompt-text-row input {
      width: 100%;
    }

    .prompt-controls .button,
    .prompt-controls select,
    .prompt-controls input {
      width: 100%;
    }

    .upload-card {
      border: 2px solid #009688;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }

    .upload-card footer {
      padding: 4px 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      background: #e0f2f1;
      font-size: 0.78rem;
      font-weight: bold;
      color: #004d40;
    }

    .upload-card button {
      border: none;
      background: #c62828;
      color: white;
      border-radius: 6px;
      padding: 3px 6px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.75rem;
    }

    .muted {
      color: #4f5b62;
      font-size: 0.84rem;
      line-height: 1.2;
    }

    .choices-grid {
      display: grid;
      gap: 8px;
      margin-top: 4px;
    }

    .choice-row {
      display: grid;
      grid-template-columns: 110px minmax(150px, 1fr) 100px;
      gap: 8px;
      align-items: center;
    }

    .choice-row > div {
      min-width: 0;
    }

    .choice-row select,
    .choice-row input,
    .choice-row textarea {
      width: 100%;
      padding: 7px 9px;
      border: 2px solid #009688;
      border-radius: 7px;
      font-size: 0.9rem;
      min-height: 34px;
      color: #004d40;
      box-sizing: border-box;
    }

    .choice-row select { background: #fff; }
    .choice-row input { background: #fff; }

    #toast {
      position: fixed;
      bottom: 12px;
      right: 12px;
      background: #009688;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
      z-index: 10;
      font-weight: bold;
      font-size: 0.86rem;
    }

    #toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Session log */
    .log-card {
      background: #f8fdfc;
      border: 2px solid rgba(0, 150, 136, 0.25);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .log-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    .log-actions .button {
      background: #009688;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: 700;
    }

    .log-table {
      border: 1px solid rgba(0, 150, 136, 0.25);
      border-radius: 6px;
      overflow: hidden;
      background: white;
    }

    .log-header,
    .log-row {
      display: grid;
      grid-template-columns: 140px 1fr 80px 100px;
      gap: 6px;
      padding: 6px 8px;
      align-items: center;
    }

    .log-header {
      background: rgba(0, 150, 136, 0.12);
      font-weight: 800;
      color: #004d40;
      border-bottom: 1px solid rgba(0, 150, 136, 0.25);
    }

    .log-row:nth-child(odd) {
      background: #f5fbfa;
    }

    .log-row .correct-flag {
      font-weight: 800;
      color: #1b5e20;
    }

    .log-row .incorrect-flag {
      font-weight: 800;
      color: #b71c1c;
    }

    #viewer-status {
      color: #00695c;
      font-weight: bold;
      margin-top: 6px;
      font-size: 0.84rem;
    }

    .correct-toggle {
      display: flex;
      align-items: center;
      gap: 3px;
      color: #004d40;
      font-weight: 700;
      font-size: 0.8rem;
    }

    .correct-toggle input[type="checkbox"] {
      transform: scale(0.8);
      accent-color: #009688;
    }

    .reinforcer-card {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .option-item {
      font-size: 0.86rem;
    }

    /* Local video upload layout */
    .video-upload {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .video-upload > label.teal-label {
      display: block;
    }

    /* Center the "Ajouter des vidéos" button in its container */
    .video-upload > div {
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .video-upload .button[for="video-input"] {
      display: inline-block;
    }
  </style>
</head>
<body>
  <div id="options-title-bar">
    <h2>Activité de diffusion des tuiles</h2>
  </div>
  <div id="game-options" class="modal" style="display: flex;">
    <div id="control-panel-options">
      <div id="options-inline-container" class="options-inline-container">
        <!-- Colonne 1 : images + prompt + temps de fixation -->
        <div class="options-column">
          <div class="section-card">
            <h3>1. Ajouter des images</h3>
            <div>
              <label class="button" for="image-input">Ajouter des images</label>
              <input type="file" id="image-input" accept="image/*" multiple style="display:none" />
            </div>
            <div id="upload-grid" class="upload-grid"></div>
            <p class="muted" id="no-images-hint">Aucune image téléversée.</p>

            <div class="prompt-block">
              <label class="teal-label">
                <input type="checkbox" id="enable-prompt" />
                <span>Afficher un prompt au-dessus des tuiles</span>
              </label>
              <div class="prompt-inline">
                <label for="prompt-type" class="teal-label">Type de prompt</label>
                <select id="prompt-type" class="button" style="background: #fff; color: #004d40; font-weight: 700;">
                  <option value="text">Texte / nombre</option>
                  <option value="image">Image</option>
                </select>
              </div>
              <!-- Contenu: champ sous l'étiquette -->
              <div class="prompt-controls" id="prompt-text-row">
                <label for="prompt-text" class="teal-label">Contenu</label>
                <input id="prompt-text" type="text" placeholder="Ex: 3 + 4" />
              </div>
              <div class="prompt-controls" id="prompt-image-row" style="display: none;">
                <label for="prompt-image" class="teal-label">Image du prompt</label>
                <select id="prompt-image" class="button" style="background: #fff; color: #004d40; font-weight: 700;"></select>
              </div>
            </div>

            <!-- Temps de fixation déplacé à gauche (sous le prompt) -->
            <div class="option-item">
              <label for="dwell-time" class="teal-label">
                Temps de fixation (ms) : <span id="dwell-time-value">1500</span>
              </label>
              <input
                type="range"
                id="dwell-time"
                min="500"
                max="4000"
                step="100"
                value="1500"
                class="styled-slider"
              />
            </div>
          </div>
        </div>

        <!-- Colonne 2 : choix seulement -->
        <div class="options-column">
          <div class="section-card">
            <h3>2. Préparer vos choix</h3>
            <div class="option-item">
              <label for="choice-count" class="teal-label">Nombre de choix: <span id="choice-count-value">3</span></label>
              <input type="range" id="choice-count" min="1" max="6" value="3" class="styled-slider" />
            </div>
            <div id="choices" class="choices-grid"></div>
            <div id="viewer-status">En attente du viewer...</div>
          </div>
        </div>

        <!-- Colonne 3 : renforçateur + vidéos locales -->
        <div class="options-column">
          <div class="section-card reinforcer-card">
            <h3>3. Choisir un renforçateur</h3>

            <!-- Category then video selector populated from bucketindex.json -->
            <label for="reinforcer-category" class="teal-label">Catégorie / thème</label>
            <select id="reinforcer-category" class="button" style="background: #fff; color: #004d40; font-weight: 700;">
              <option value="">Chargement des catégories...</option>
            </select>

            <label for="reinforcer" class="teal-label">Vidéo de renforçateur</label>
            <select id="reinforcer" class="button" style="background: #fff; color: #004d40; font-weight: 700;" disabled>
              <option value="">Choisir d'abord une catégorie</option>
            </select>

            <!-- Local videos upload (no list, only dropdown) -->
            <div class="option-item video-upload">
              <label class="teal-label" for="video-input">Ajouter des vidéos locales (optionnel)</label>
              <div>
                <label class="button" for="video-input">Ajouter des vidéos</label>
                <input type="file" id="video-input" accept="video/*" multiple style="display:none" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="option-item" style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
        <button id="open-viewer" class="button" type="button">Ouvrir la page élève</button>
        <button id="startButton" type="button">Envoyer les tuiles</button>
      </div>

      <div class="section-card log-card">
        <h3>4. Journal de session</h3>
        <p class="muted" id="session-log-empty">Les sélections reçues apparaîtront ici.</p>
        <div class="log-actions">
          <button id="export-log-json" class="button" type="button">Exporter en JSON</button>
          <button id="export-log-csv" class="button" type="button">Exporter en CSV</button>
          <button id="clear-log" class="button" type="button" style="background:#c62828;">Vider le journal</button>
        </div>
        <div class="log-table" aria-live="polite">
          <div class="log-header">
            <span>Horodatage</span>
            <span>Tuile</span>
            <span>Correct</span>
            <span>Dwell (ms)</span>
          </div>
          <div id="session-log-entries"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    const channelName = 'eyegaze-broadcastr-tiles';
    const channel = typeof BroadcastChannel !== 'undefined' ? new BroadcastChannel(channelName) : null;
    const imageInput = document.getElementById('image-input');
    const uploadGrid = document.getElementById('upload-grid');
    const noImagesHint = document.getElementById('no-images-hint');
    const choicesContainer = document.getElementById('choices');
    const choiceCountInput = document.getElementById('choice-count');
    const choiceCountValue = document.getElementById('choice-count-value');
    const openViewerBtn = document.getElementById('open-viewer');
    const sendChoicesBtn = document.getElementById('startButton');
    const toast = document.getElementById('toast');
    const viewerStatus = document.getElementById('viewer-status');
    const reinforcerCategorySelect = document.getElementById('reinforcer-category');
    const reinforcerSelect = document.getElementById('reinforcer');
    const enablePrompt = document.getElementById('enable-prompt');
    const promptType = document.getElementById('prompt-type');
    const promptText = document.getElementById('prompt-text');
    const promptImage = document.getElementById('prompt-image');
    const promptTextRow = document.getElementById('prompt-text-row');
    const promptImageRow = document.getElementById('prompt-image-row');
    const dwellTimeInput = document.getElementById('dwell-time');
    const dwellTimeValue = document.getElementById('dwell-time-value');
    const videoInput = document.getElementById('video-input');
    const sessionLogEntries = document.getElementById('session-log-entries');
    const sessionLogEmpty = document.getElementById('session-log-empty');
    const exportJsonBtn = document.getElementById('export-log-json');
    const exportCsvBtn = document.getElementById('export-log-csv');
    const clearLogBtn = document.getElementById('clear-log');

    const LOCAL_CATEGORY_KEY = '__local_videos';

    const CATEGORY_LABELS = {
      kids_fr: 'Comptines / enfants (FR)',
      kids_intl: 'Comptines / enfants (autres)',
      disney: 'Disney',
      music_mainstream: 'Musique grand public',
      travel_space: 'Voyages / espace',
      vehicles_machines: 'Véhicules / machines',
      sports_extreme: 'Sports extrêmes',
      cartoons_tv: 'Dessins animés / TV',
      edu_games_misc: 'Jeux vidéo / divers',
      sensory: 'Sensoriel',
      [LOCAL_CATEGORY_KEY]: 'Vidéos locales (cet appareil)'
    };

    function labelForCategory(cat) {
      return CATEGORY_LABELS[cat] || cat;
    }

    const STORAGE_KEY = 'eyegazeBroadcastrTilesConfig_v1';
    let loadedState = null;
    let stateAppliedToChoices = false;
    let savedReinforcerCategory = '';
    let savedReinforcerUrl = '';

    let viewerWindow = null;
    let viewerReady = false;
    let uploadedImages = [];
    let lastSentTiles = [];
    let allReinforcers = [];
    let localVideos = []; // { id, name, url }
    let selectionLog = [];

    function setStatus(message) {
      viewerStatus.textContent = message;
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2400);
    }

    function formatTimestamp(ts) {
      const date = new Date(ts);
      if (Number.isNaN(date.getTime())) return '—';
      return date.toLocaleTimeString('fr-FR', { hour12: false });
    }

    function formatDwell(ms) {
      if (typeof ms !== 'number' || Number.isNaN(ms)) return '—';
      return Math.round(ms).toString();
    }

    function renderSessionLog() {
      sessionLogEntries.innerHTML = '';
      if (!selectionLog.length) {
        sessionLogEmpty.style.display = 'block';
        return;
      }

      sessionLogEmpty.style.display = 'none';
      selectionLog.forEach((entry) => {
        const row = document.createElement('div');
        row.className = 'log-row';

        const timeCell = document.createElement('span');
        timeCell.textContent = formatTimestamp(entry.timestamp);

        const labelCell = document.createElement('span');
        labelCell.textContent = entry.label || 'Tuile';

        const correctCell = document.createElement('span');
        correctCell.textContent = entry.correct ? 'Oui' : 'Non';
        correctCell.className = entry.correct ? 'correct-flag' : 'incorrect-flag';

        const dwellCell = document.createElement('span');
        dwellCell.textContent = formatDwell(entry.dwellTimeMs);
        if (typeof entry.dwellTimeMs === 'number') {
          dwellCell.title = `${(entry.dwellTimeMs / 1000).toFixed(2)}s`;
        }

        row.appendChild(timeCell);
        row.appendChild(labelCell);
        row.appendChild(correctCell);
        row.appendChild(dwellCell);
        sessionLogEntries.appendChild(row);
      });
    }

    function appendToSessionLog(entry) {
      selectionLog.push(entry);
      renderSessionLog();
    }

    function clearSessionLog() {
      selectionLog = [];
      renderSessionLog();
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function exportLogAsJson() {
      if (!selectionLog.length) {
        showToast('Aucune sélection à exporter.');
        return;
      }
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      downloadFile(JSON.stringify(selectionLog, null, 2), `journal-selection-${timestamp}.json`, 'application/json');
    }

    function exportLogAsCsv() {
      if (!selectionLog.length) {
        showToast('Aucune sélection à exporter.');
        return;
      }
      const header = ['timestamp', 'label', 'correct', 'dwellTimeMs', 'tileId'];
      const rows = selectionLog.map((entry) => [
        new Date(entry.timestamp).toISOString(),
        `"${(entry.label || '').replace(/"/g, '""')}"`,
        entry.correct ? 'true' : 'false',
        typeof entry.dwellTimeMs === 'number' ? Math.round(entry.dwellTimeMs) : '',
        entry.tileId || ''
      ]);
      const csvContent = [header.join(','), ...rows.map((r) => r.join(','))].join('\n');
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      downloadFile(csvContent, `journal-selection-${timestamp}.csv`, 'text/csv');
    }

    function refreshUploadGrid() {
      uploadGrid.innerHTML = '';
      if (uploadedImages.length === 0) {
        noImagesHint.style.display = 'block';
        refreshPromptImageSelect();
        return;
      }
      noImagesHint.style.display = 'none';
      uploadedImages.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'upload-card';

        const footer = document.createElement('footer');
        const nameSpan = document.createElement('span');
        nameSpan.textContent = item.name;
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Retirer';
        removeBtn.addEventListener('click', () => {
          uploadedImages = uploadedImages.filter((img) => img.id !== item.id);
          refreshUploadGrid();
          renderChoices();
          saveState();
        });
        footer.appendChild(nameSpan);
        footer.appendChild(removeBtn);
        card.appendChild(footer);
        uploadGrid.appendChild(card);
      });
      refreshPromptImageSelect();
    }

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    imageInput.addEventListener('change', async (event) => {
      const files = Array.from(event.target.files || []);
      for (const file of files) {
        const dataUrl = await fileToDataUrl(file);
        uploadedImages.push({ id: crypto.randomUUID(), name: file.name, dataUrl });
      }
      imageInput.value = '';
      refreshUploadGrid();
      renderChoices();
      saveState();
    });

    function refreshPromptImageSelect() {
      promptImage.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = uploadedImages.length ? 'Choisir une image' : 'Aucune image disponible';
      promptImage.appendChild(placeholder);
      uploadedImages.forEach((img) => {
        const opt = document.createElement('option');
        opt.value = img.id;
        opt.textContent = img.name;
        promptImage.appendChild(opt);
      });
    }

    function renderChoices() {
      const existingChoices = collectChoicesForState();
      const shouldUseLoadedState = !stateAppliedToChoices && loadedState && Array.isArray(loadedState.choices);
      const sourceChoices = shouldUseLoadedState ? loadedState.choices : existingChoices;
      const count = Math.max(1, Math.min(6, Number(choiceCountInput.value) || 1));
      choiceCountInput.value = count;
      choiceCountValue.textContent = count;
      choicesContainer.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const row = document.createElement('div');
        row.className = 'choice-row';

        const savedChoice = sourceChoices?.[i];
        const initialType = savedChoice?.type || 'number';

        const typeSelect = document.createElement('select');
        typeSelect.className = 'choice-type';
        typeSelect.innerHTML = `
          <option value="image">Image</option>
          <option value="number">Nombre</option>
          <option value="text">Texte</option>
        `;
        typeSelect.value = initialType;

        const contentWrapper = document.createElement('div');

        const inputField = document.createElement('input');
        inputField.type = 'text';
        inputField.placeholder = 'Saisir le texte ou le nombre';
        inputField.className = 'choice-input';

        const imageSelect = document.createElement('select');
        imageSelect.className = 'choice-input';
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = uploadedImages.length ? 'Choisir une image' : 'Aucune image disponible';
        imageSelect.appendChild(emptyOption);
        uploadedImages.forEach((img) => {
          const opt = document.createElement('option');
          opt.value = img.id;
          opt.textContent = img.name;
          imageSelect.appendChild(opt);
        });

        function refreshContentInput(savedValue) {
          const type = typeSelect.value;
          contentWrapper.innerHTML = '';
          if (type === 'image') {
            const selector = imageSelect.cloneNode(true);
            selector.className = 'choice-input';
            if (savedValue) selector.value = savedValue;
            contentWrapper.appendChild(selector);
          } else {
            const clone = inputField.cloneNode();
            clone.className = 'choice-input';
            clone.type = type === 'number' ? 'number' : 'text';
            clone.placeholder = type === 'number' ? 'Entrer un nombre' : 'Entrer un texte';
            if (savedValue) clone.value = savedValue;
            contentWrapper.appendChild(clone);
          }
        }

        typeSelect.addEventListener('change', () => {
          const currentValue = contentWrapper.querySelector('.choice-input')?.value;
          refreshContentInput(currentValue);
          saveState();
        });

        refreshContentInput(savedChoice?.value);

        row.appendChild(typeSelect);
        row.appendChild(contentWrapper);

        const correctWrapper = document.createElement('label');
        correctWrapper.className = 'correct-toggle';
        const correctInput = document.createElement('input');
        correctInput.type = 'checkbox';
        correctInput.name = 'correct-choice';
        correctInput.checked = !!savedChoice?.correct;
        correctInput.addEventListener('change', (e) => {
          if (e.target.checked) {
            document.querySelectorAll('input[name="correct-choice"]').forEach((box) => {
              if (box !== e.target) box.checked = false;
            });
          }
          saveState();
        });
        correctWrapper.appendChild(correctInput);
        const correctLabel = document.createElement('span');
        correctLabel.textContent = 'Bonne réponse';
        correctWrapper.appendChild(correctLabel);
        row.appendChild(correctWrapper);
        choicesContainer.appendChild(row);
      }

      if (shouldUseLoadedState) {
        stateAppliedToChoices = true;
      }
    }

    function syncPromptInputs() {
      const wantsImage = promptType.value === 'image';
      promptTextRow.style.display = wantsImage ? 'none' : 'grid';
      promptImageRow.style.display = wantsImage ? 'grid' : 'none';
    }

    function collectChoicesForState() {
      const rows = Array.from(document.querySelectorAll('.choice-row'));
      return rows.map((row) => {
        const typeSelect = row.querySelector('select.choice-type');
        const type = typeSelect ? typeSelect.value : 'number';
        const valueEl = row.querySelector('.choice-input');
        const value = valueEl ? valueEl.value : '';
        const correctEl = row.querySelector('input[type="checkbox"][name="correct-choice"]');
        const correct = !!(correctEl && correctEl.checked);
        return { type, value, correct };
      });
    }

    function saveState() {
      try {
        const state = {
          choiceCount: Number(choiceCountInput.value) || 3,
          dwellTime: Number(dwellTimeInput.value) || 1500,
          enablePrompt: !!enablePrompt.checked,
          promptType: promptType.value,
          promptText: promptText.value || '',
          promptImage: promptImage.value || '',
          reinforcerCategory: reinforcerCategorySelect.value || '',
          reinforcerUrl: reinforcerSelect.value || '',
          choices: collectChoicesForState()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('Erreur saveState', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const state = JSON.parse(raw);
        loadedState = state;

        if (state.choiceCount) {
          choiceCountInput.value = state.choiceCount;
        }
        if (typeof state.dwellTime === 'number') {
          dwellTimeInput.value = state.dwellTime;
          dwellTimeValue.textContent = state.dwellTime;
        }
        if (typeof state.enablePrompt === 'boolean') {
          enablePrompt.checked = state.enablePrompt;
        }
        if (state.promptType) promptType.value = state.promptType;
        if (state.promptText) promptText.value = state.promptText;
        if (state.promptImage) promptImage.value = state.promptImage;

        savedReinforcerCategory = state.reinforcerCategory || '';
        savedReinforcerUrl = state.reinforcerUrl || '';
      } catch (e) {
        console.error('Erreur loadState', e);
      }
    }

    function collectChoices() {
      const rows = Array.from(document.querySelectorAll('.choice-row'));
      const tiles = [];
      for (const row of rows) {
        const typeSelect = row.querySelector('select.choice-type');
        const type = typeSelect ? typeSelect.value : 'number';
        const inputEl = row.querySelector('.choice-input');
        const correct = row.querySelector('input[type="checkbox"]').checked;
        if (!inputEl) continue;

        if (type === 'image') {
          const imageId = inputEl.value;
          const selected = uploadedImages.find((img) => img.id === imageId);
          if (selected) {
            tiles.push({ id: crypto.randomUUID(), type: 'image', url: selected.dataUrl, label: selected.name, correct });
          }
        } else {
          const value = inputEl.value?.trim();
          if (value) {
            tiles.push({ id: crypto.randomUUID(), type, label: value, correct });
          }
        }
      }
      return tiles;
    }

    function buildPromptPayload() {
      if (!enablePrompt.checked) return null;
      const type = promptType.value;

      if (type === 'text') {
        const value = promptText.value.trim();
        if (!value) {
          showToast('Ajoutez un prompt texte.');
          return { error: true };
        }
        return { type: 'text', value };
      }

      const imageId = promptImage.value;
      const selected = uploadedImages.find((img) => img.id === imageId);
      if (!selected) {
        showToast('Choisissez une image pour le prompt.');
        return { error: true };
      }
      return { type: 'image', url: selected.dataUrl, label: selected.name };
    }

    function sendTiles() {
      if (!channel) {
        showToast('BroadcastChannel indisponible.');
        return;
      }
      const tiles = collectChoices();
      if (!tiles.length) {
        showToast('Ajoutez au moins un choix valide.');
        return;
      }
      const promptPayload = buildPromptPayload();
      if (promptPayload?.error) return;
      lastSentTiles = tiles;

      const dwellTimeMs = Number(dwellTimeInput?.value) || 1500;

      channel.postMessage({
        type: 'tiles',
        tiles,
        prompt: promptPayload || null,
        reinforcer: reinforcerSelect.value || null,
        dwellTimeMs
      });
      showToast('Choix envoyés.');
      saveState();
    }

    sendChoicesBtn.addEventListener('click', sendTiles);

    if (exportJsonBtn) exportJsonBtn.addEventListener('click', exportLogAsJson);
    if (exportCsvBtn) exportCsvBtn.addEventListener('click', exportLogAsCsv);
    if (clearLogBtn) clearLogBtn.addEventListener('click', clearSessionLog);

    function openViewer() {
      viewerWindow = window.open('viewer.html', '_blank');
      if (!viewerWindow) {
        showToast('Impossible d\'ouvrir la page élève.');
      }
    }

    openViewerBtn.addEventListener('click', openViewer);

    if (channel) {
      channel.onmessage = (event) => {
        const { type, tileId, dwellTimeMs: selectionDwell, label: selectionLabel, correct: selectionCorrect } = event.data || {};
        if (type === 'viewer-ready') {
          viewerReady = true;
          setStatus('Viewer connecté.');
          showToast('Le viewer est prêt.');
        }
        if (type === 'viewer-closed') {
          viewerReady = false;
          setStatus('Viewer fermé.');
        }
        if (type === 'selection' && tileId) {
          const selectedTile = lastSentTiles.find((tile) => tile.id === tileId);
          const dwellTimeMs = typeof selectionDwell === 'number' ? selectionDwell : Number(dwellTimeInput.value) || null;
          const label = selectionLabel || selectedTile?.label || 'Tuile';
          const correct = typeof selectionCorrect === 'boolean' ? selectionCorrect : !!selectedTile?.correct;

          appendToSessionLog({
            tileId,
            label,
            correct,
            dwellTimeMs,
            timestamp: Date.now()
          });

          if (correct) {
            showToast('Bonne réponse envoyée.');
          }
        }
      };
      setStatus('En attente du viewer...');
    } else {
      setStatus('BroadcastChannel non pris en charge.');
    }

    dwellTimeInput.addEventListener('input', () => {
      dwellTimeValue.textContent = dwellTimeInput.value;
      saveState();
    });

    // ---- Local videos management (no visible list) ----
    if (videoInput) {
      videoInput.addEventListener('change', (event) => {
        const files = Array.from(event.target.files || []);
        for (const file of files) {
          const url = URL.createObjectURL(file);
          localVideos.push({
            id: crypto.randomUUID(),
            name: file.name,
            url
          });
        }
        videoInput.value = '';
        populateReinforcerCategories();
        showToast('Vidéos locales ajoutées.');
        saveState();
      });
    }

    function populateReinforcerCategories() {
      if (!reinforcerCategorySelect || !reinforcerSelect) return;

      const categoriesSet = new Set(allReinforcers.map(item => item.category));
      if (localVideos.length) {
        categoriesSet.add(LOCAL_CATEGORY_KEY);
      }

      const categories = [...categoriesSet].filter(Boolean).sort();

      reinforcerCategorySelect.innerHTML = '';

      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Choisir une catégorie';
      reinforcerCategorySelect.appendChild(placeholder);

      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = labelForCategory(cat);
        reinforcerCategorySelect.appendChild(opt);
      });

      reinforcerSelect.innerHTML = '';
      const vidPlaceholder = document.createElement('option');
      vidPlaceholder.value = '';
      vidPlaceholder.textContent = 'Choisir d\'abord une catégorie';
      reinforcerSelect.appendChild(vidPlaceholder);
      reinforcerSelect.disabled = true;

      // Réappliquer la sélection sauvegardée si possible
      if (savedReinforcerCategory) {
        reinforcerCategorySelect.value = savedReinforcerCategory;
        populateReinforcerOptions(savedReinforcerCategory);
        if (savedReinforcerUrl) {
          reinforcerSelect.value = savedReinforcerUrl;
        }
      }
    }

    function populateReinforcerOptions(category) {
      reinforcerSelect.innerHTML = '';
      const vidPlaceholder = document.createElement('option');
      vidPlaceholder.value = '';
      vidPlaceholder.textContent = category ? 'Choisir une vidéo' : 'Choisir d\'abord une catégorie';
      reinforcerSelect.appendChild(vidPlaceholder);

      if (!category) {
        reinforcerSelect.disabled = true;
        return;
      }

      let sourceList = [];
      if (category === LOCAL_CATEGORY_KEY) {
        sourceList = localVideos;
      } else {
        sourceList = allReinforcers.filter(item => item.category === category);
      }

      sourceList.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.url;
        opt.textContent = item.theme || item.title || item.name || item.url;
        reinforcerSelect.appendChild(opt);
      });
      reinforcerSelect.disabled = sourceList.length === 0;
    }

    if (reinforcerCategorySelect && reinforcerSelect) {
      fetch('../../js/bucketindex.json')
        .then(resp => resp.json())
        .then(data => {
          allReinforcers = Array.isArray(data) ? data : [];
          if (!allReinforcers.length) {
            showToast('Liste de vidéos vide.');
            return;
          }
          populateReinforcerCategories();
        })
        .catch(err => {
          console.error('Erreur de chargement des vidéos', err);
          showToast('Impossible de charger la liste de vidéos.');
        });

      reinforcerCategorySelect.addEventListener('change', () => {
        populateReinforcerOptions(reinforcerCategorySelect.value);
        saveState();
      });

      reinforcerSelect.addEventListener('change', saveState);
    }

    // Sauvegarde sur changement dans la zone de choix
    choicesContainer.addEventListener('input', (e) => {
      if (e.target.matches('select, input, textarea')) saveState();
    });
    choicesContainer.addEventListener('change', (e) => {
      if (e.target.matches('select, input, textarea')) saveState();
    });

    // Sauvegarde sur changements des options de prompt
    enablePrompt.addEventListener('change', saveState);
    promptType.addEventListener('change', () => {
      syncPromptInputs();
      saveState();
    });
    promptText.addEventListener('input', saveState);
    promptImage.addEventListener('change', saveState);

    // Slider nombre de choix
    choiceCountInput.addEventListener('input', () => {
      renderChoices();
      saveState();
    });
    choiceCountInput.addEventListener('change', () => {
      renderChoices();
      saveState();
    });

    // ---- Init ----
    loadState();
    syncPromptInputs();
    renderChoices();
    refreshUploadGrid();
    renderSessionLog();
  </script>
</body>
</html>
