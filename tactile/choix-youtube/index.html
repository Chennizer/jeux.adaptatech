<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activité de choix multiple (YouTube)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../../css/choix.css">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>

  <style>
    #tile-container.flashcard-mode .tile {
      width: 90vh !important;
      height: 90vh !important;
    }
    #tile-container.this-or-that-mode .tile {
      width: 60vh !important;
      height: 60vh !important;
    }
    #tile-container.grid-2x2 {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr);
      gap: 10vh;
      justify-items: center;
      align-items: center;
    }
    #tile-container.this-or-that-mode {
      gap: 30vh !important;
    }
    #youtube-player {
      width: 100%;
      height: 100%;
      display: none;
      pointer-events: none;
    }
    #tile-picker-grid .empty-state {
      color: #fff;
      font-size: 1.4rem;
      text-align: center;
      padding: 2rem 1rem;
    }
  </style>
</head>
<body>
  <div id="game-options" class="modal" style="display: flex;">
    <div id="control-panel-options">
      <div id="options-title-bar">
        <h2 id="options-main-title" class="translate"
            data-fr="Activité de choix multiple (écran tactile)"
            data-en="Multiple Choice Activity (touchscreen)">
          Activité de choix multiple
        </h2>
      </div>
      <div id="mode-divider"></div>
      <div id="options-inline-container">
        <div id="advanced-options-section">
          <div class="advanced-options-container">
            <div class="option-item">
              <label for="enable-time-limit" class="teal-label">
                <input type="checkbox" id="enable-time-limit">
                <span class="translate" data-fr="Temps limite" data-en="Time Limit">Temps limite</span>
              </label>
            </div>
            <div id="time-limit-container" class="option-item" style="display: none;">
              <label for="time-limit-seconds" class="duration-label">
                <span class="translate" data-fr="Durée (sec):" data-en="Duration (sec):">Durée (sec):</span>
              </label>
              <input type="number" id="time-limit-seconds" min="1" value="30" class="styled-input-small">
            </div>
            <div id="resume-video-container" class="option-item" style="display: none;">
              <label for="enable-resume-video" class="teal-label">
                <input type="checkbox" id="enable-resume-video">
                <span class="translate" data-fr="Reprendre la vidéo" data-en="Resume Video">Reprendre la vidéo</span>
              </label>
            </div>
          </div>
        </div>
        <div id="game-options-controls">
          <div class="option-item" id="tile-slider-container">
            <label for="tile-count" class="control-label">
              <span class="translate" data-fr="Nombre de tuiles:" data-en="Number of Tiles:">Nombre de tuiles:</span>
              <span id="tile-count-value" class="slider-value no-translate">3</span>
            </label>
            <input type="range" id="tile-count" min="1" max="6" value="3" class="styled-slider">
          </div>
        </div>
        <div id="links-column">
          <a href="../../documentation/choix tactile/index.html" target="_blank"
             class="doc-link translate" data-fr="Instructions" data-en="Instructions">Instructions</a>
          <a href="../../documentation/pédagogie choix et scan/index.html" target="_blank"
             class="doc-link translate" data-fr="Pédagogie" data-en="Pedagogy">Pédagogie</a>
        </div>
      </div>
      <div id="mode-divider"></div>
      <button id="choose-tiles-button" class="button translate"
              data-fr="Choix des tuiles" data-en="Tile Selection">Choix des tuiles</button>
    </div>
  </div>

  <div id="tile-picker-modal" class="modal" style="display: none;">
    <div id="control-panel-options">
      <div id="control-panel-title-wrapper">
        <h2 id="control-panel-title" class="translate" data-fr="Choisir les tuiles" data-en="Choose the Tiles">
          Choisir les tuiles
        </h2>
      </div>
      <div id="control-panel-instructions" style="margin-top: 10px;">
        <span class="translate" data-fr="Choisir" data-en="Choose">Choisir</span>
        <span id="tile-count-display" class="no-translate"></span>
        <span class="translate" data-fr="tuiles." data-en="tiles.">tuiles.</span>
      </div>
      <div id="tile-picker-grid"></div>
      <div id="yt-import-controls">
        <div id="yt-input-row">
          <div class="actions-row">
            <input id="add-video-url-input" type="text" placeholder="URL" class="control-panel-input">
            <button id="add-video-url-button" class="button" data-fr="Ajouter URL" data-en="Add URL">Ajouter URL</button>
          </div>
          <div class="actions-row">
            <input id="yt-playlist-url-input" type="text"
                   placeholder="URL de playlist (ex. https://www.youtube.com/playlist?list=...)"
                   class="control-panel-input">
            <button id="yt-playlist-import-button" class="button" data-fr="Importer" data-en="Import">Importer</button>
          </div>
        </div>
        <div class="actions-row">
          <button id="clear-videos-button" class="button translate" data-fr="Tout effacer" data-en="Clear All">Tout effacer</button>
          <button id="start-game-button" class="button translate" data-fr="Commencer" data-en="Start" disabled>Commencer</button>
        </div>
      </div>
    </div>
  </div>

  <div id="tile-container" style="display: none;"></div>

  <div id="video-container" style="display: none;">
    <video id="video-player" autoplay>
      <source id="video-source" type="video/mp4" />
      <span class="translate" data-fr="Votre navigateur ne supporte pas la vidéo." data-en="Your browser does not support video.">
        Votre navigateur ne supporte pas la vidéo.
      </span>
    </video>
    <div id="youtube-player"></div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="../../js/config.js"></script>
  <script src="../../js/customYoutubeChoices.js"></script>
  <script>
    (function() {
      const mediaChoices = window.mediaChoices = window.mediaChoices || [];

      const gameOptionsModal = document.getElementById('game-options');
      const tilePickerModal  = document.getElementById('tile-picker-modal');
      const tileContainer    = document.getElementById('tile-container');
      const videoContainer   = document.getElementById('video-container');
      const videoPlayer      = document.getElementById('video-player');
      const videoSource      = document.getElementById('video-source');
      const youtubeDiv       = document.getElementById('youtube-player');

      const tileCountInput   = document.getElementById('tile-count');
      const tileCountValue   = document.getElementById('tile-count-value');
      const chooseTilesButton = document.getElementById('choose-tiles-button');
      const tileCountDisplay = document.getElementById('tile-count-display');
      const startGameButton  = document.getElementById('start-game-button');
      const tilePickerGrid   = document.getElementById('tile-picker-grid');

      const enableTimeLimitCheckbox = document.getElementById('enable-time-limit');
      const timeLimitContainer      = document.getElementById('time-limit-container');
      const timeLimitInput          = document.getElementById('time-limit-seconds');
      const resumeVideoContainer    = document.getElementById('resume-video-container');
      const enableResumeVideoCheckbox = document.getElementById('enable-resume-video');

      let desiredTileCount    = parseInt(tileCountInput.value, 10) || 3;
      let selectedTileIndices = [];
      let videoPlaying        = false;
      let videoTimeLimitTimeout = null;
      let videoResumePositions  = {};
      let inactivityTimer     = null;
      let loadingDiv          = null;
      let currentVideoUrl     = null;

      let youtubePlayer       = null;
      let youtubeApiReady     = false;
      let pendingYoutubeLoad  = null;

      function isYouTubeUrl(url) {
        return /^(https?:\/\/)?(www\.|m\.)?((youtube\.com\/)|(youtu\.be\/))/.test(url || '');
      }

      function getYouTubeId(url) {
        try {
          const u = new URL(url);
          if (u.hostname.includes('youtu.be')) {
            return u.pathname.slice(1);
          }
          const id = u.searchParams.get('v');
          if (id) return id;
          const match = url.match(/\/embed\/([a-zA-Z0-9_-]+)/);
          return match ? match[1] : null;
        } catch (e) {
          return null;
        }
      }

      function clearInactivityTimer() {
        if (inactivityTimer) {
          clearTimeout(inactivityTimer);
          inactivityTimer = null;
        }
      }

      function startInactivityTimer() {
        clearInactivityTimer();
        inactivityTimer = setTimeout(() => {}, 30000);
      }

      function resetInactivityTimer() {
        if (!videoPlaying) {
          startInactivityTimer();
        }
      }

      tileCountInput.addEventListener('input', () => {
        tileCountValue.textContent = tileCountInput.value;
      });

      enableTimeLimitCheckbox.addEventListener('change', () => {
        if (enableTimeLimitCheckbox.checked) {
          timeLimitContainer.style.display = 'block';
          resumeVideoContainer.style.display = 'block';
        } else {
          timeLimitContainer.style.display = 'none';
          resumeVideoContainer.style.display = 'none';
        }
      });

      chooseTilesButton.addEventListener('click', () => {
        desiredTileCount = parseInt(tileCountInput.value, 10) || 3;
        tileCountDisplay.textContent = desiredTileCount;
        selectedTileIndices = [];
        updateStartButtonState();
        gameOptionsModal.style.display = 'none';
        tilePickerModal.style.display = 'flex';
        populateTilePickerGrid();
        resetInactivityTimer();
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(() => {});
        } else if (document.documentElement.webkitRequestFullscreen) {
          document.documentElement.webkitRequestFullscreen();
        }
      });

      startGameButton.addEventListener('click', () => {
        const chosenUrls = selectedTileIndices.map(i => mediaChoices[i]?.video).filter(Boolean);
        const localVideos = chosenUrls.filter(url => !isYouTubeUrl(url));
        const proceedToGame = () => {
          hideLoadingScreen();
          tilePickerModal.style.display = 'none';
          renderChosenTiles();
          tileContainer.style.display = 'flex';
        };

        if (localVideos.length) {
          showLoadingScreen().then(() => preloadVideos(localVideos)).then(proceedToGame);
        } else {
          proceedToGame();
        }
      });

      function populateTilePickerGrid() {
        if (!tilePickerGrid) return;
        tilePickerGrid.innerHTML = '';
        selectedTileIndices = selectedTileIndices.filter(index => index < mediaChoices.length);

        if (!mediaChoices.length) {
          const empty = document.createElement('div');
          empty.className = 'empty-state translate';
          empty.setAttribute('data-fr', "Ajoutez des vidéos YouTube avec les champs ci-dessous.");
          empty.setAttribute('data-en', 'Add YouTube videos using the fields below.');
          empty.textContent = 'Ajoutez des vidéos YouTube avec les champs ci-dessous.';
          tilePickerGrid.appendChild(empty);
          updateStartButtonState();
          return;
        }

        const grid = document.createElement('div');
        grid.style.display = 'flex';
        grid.style.flexWrap = 'wrap';
        grid.style.gap = '10px';
        grid.style.justifyContent = 'center';

        mediaChoices.forEach((choice, idx) => {
          const tileOption = document.createElement('div');
          tileOption.classList.add('tile');
          tileOption.setAttribute('data-index', idx);
          tileOption.style.backgroundImage = `url(${choice.image})`;

          if (selectedTileIndices.includes(idx)) {
            tileOption.classList.add('selected');
          }

          const caption = document.createElement('div');
          caption.classList.add('caption');
          caption.textContent = choice.name || '';
          tileOption.appendChild(caption);

          tileOption.addEventListener('click', () => {
            resetInactivityTimer();
            if (selectedTileIndices.includes(idx)) {
              selectedTileIndices = selectedTileIndices.filter(i => i !== idx);
            } else if (selectedTileIndices.length < desiredTileCount) {
              selectedTileIndices.push(idx);
            }
            updateStartButtonState();
            populateTilePickerGrid();
          });

          grid.appendChild(tileOption);
        });

        tilePickerGrid.appendChild(grid);
        updateStartButtonState();
      }

      function updateStartButtonState() {
        startGameButton.disabled = (selectedTileIndices.length !== desiredTileCount) || !desiredTileCount;
      }

      function renderChosenTiles() {
        tileContainer.innerHTML = '';
        const chosen = selectedTileIndices.map(i => mediaChoices[i]).filter(Boolean);

        tileContainer.classList.remove('flashcard-mode', 'this-or-that-mode', 'grid-2x2', 'two-tiles', 'tile-count-3', 'tile-count-5', 'tile-count-6');
        if (chosen.length === 1) {
          tileContainer.classList.add('flashcard-mode');
        } else if (chosen.length === 2) {
          tileContainer.classList.add('this-or-that-mode', 'two-tiles');
        } else if (chosen.length === 4) {
          tileContainer.classList.add('grid-2x2');
        } else {
          tileContainer.classList.add(`tile-count-${chosen.length}`);
        }

        chosen.forEach(choice => {
          const tile = document.createElement('div');
          tile.classList.add('tile');
          tile.style.backgroundImage = `url(${choice.image})`;
          const caption = document.createElement('div');
          caption.classList.add('caption');
          caption.textContent = choice.name || '';
          tile.appendChild(caption);
          tile.addEventListener('click', () => {
            playVideo(choice.video);
          });
          tileContainer.appendChild(tile);
        });
        resetInactivityTimer();
      }

      function rememberVideoPosition(videoUrl) {
        if (!enableResumeVideoCheckbox.checked || !videoUrl) {
          return;
        }
        if (isYouTubeUrl(videoUrl)) {
          if (youtubePlayer && typeof youtubePlayer.getCurrentTime === 'function') {
            videoResumePositions[videoUrl] = youtubePlayer.getCurrentTime();
          }
        } else if (videoPlayer) {
          videoResumePositions[videoUrl] = videoPlayer.currentTime;
        }
      }

      function clearVideoPosition(videoUrl) {
        if (videoUrl && videoResumePositions[videoUrl] !== undefined) {
          delete videoResumePositions[videoUrl];
        }
      }

      function playVideo(videoUrl) {
        if (!videoUrl) return;
        videoPlaying = true;
        currentVideoUrl = videoUrl;
        clearInactivityTimer();
        tileContainer.style.display = 'none';
        tilePickerModal.style.display = 'none';
        gameOptionsModal.style.display = 'none';
        videoContainer.style.display = 'flex';
        if (videoContainer.requestFullscreen) {
          videoContainer.requestFullscreen().catch(() => {});
        } else if (videoContainer.webkitRequestFullscreen) {
          videoContainer.webkitRequestFullscreen();
        }

        if (videoTimeLimitTimeout) {
          clearTimeout(videoTimeLimitTimeout);
          videoTimeLimitTimeout = null;
        }

        if (isYouTubeUrl(videoUrl)) {
          const videoId = getYouTubeId(videoUrl);
          const startSeconds = enableResumeVideoCheckbox.checked ? (videoResumePositions[videoUrl] || 0) : 0;
          videoPlayer.pause();
          videoPlayer.currentTime = 0;
          videoPlayer.removeAttribute('src');
          videoPlayer.load();
          videoPlayer.style.display = 'none';
          youtubeDiv.style.display = 'block';
          if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') {
            try { youtubePlayer.stopVideo(); } catch (e) {}
          }
          const loadVideo = () => {
            if (!youtubePlayer) {
              youtubePlayer = new YT.Player('youtube-player', {
                host: 'https://www.youtube-nocookie.com',
                width: '100%',
                height: '100%',
                videoId: videoId || '',
                playerVars: {
                  autoplay: 1,
                  controls: 0,
                  disablekb: 1,
                  rel: 0,
                  fs: 1,
                  modestbranding: 1,
                  playsinline: 1
                },
                events: {
                  onReady: (event) => {
                    if (startSeconds) {
                      event.target.seekTo(startSeconds, true);
                    }
                    event.target.playVideo();
                  },
                  onStateChange: onYoutubeStateChange
                }
              });
            } else if (videoId) {
              youtubePlayer.loadVideoById({ videoId, startSeconds });
              youtubePlayer.playVideo();
            }
          };
          if (videoId) {
            if (youtubeApiReady) {
              loadVideo();
              pendingYoutubeLoad = null;
            } else {
              pendingYoutubeLoad = { id: videoId, startSeconds };
            }
          }
        } else {
          youtubeDiv.style.display = 'none';
          videoSource.src = videoUrl;
          videoPlayer.removeAttribute('controls');
          videoPlayer.load();
          videoPlayer.onloadedmetadata = () => {
            if (enableResumeVideoCheckbox.checked && videoResumePositions[videoUrl]) {
              videoPlayer.currentTime = videoResumePositions[videoUrl];
            }
            videoPlayer.play();
          };
        }

        if (enableTimeLimitCheckbox.checked) {
          const limit = parseInt(timeLimitInput.value, 10) || 60;
          videoTimeLimitTimeout = setTimeout(() => {
            if (!videoPlaying) return;
            rememberVideoPosition(videoUrl);
            if (isYouTubeUrl(videoUrl)) {
              if (youtubePlayer) {
                try { youtubePlayer.pauseVideo(); } catch (e) {}
              }
            } else {
              videoPlayer.pause();
            }
            videoPlaying = false;
            resetToTileScreen();
          }, limit * 1000);
        }
      }

      function onYoutubeStateChange(event) {
        if (!event || !event.data) return;
        if (event.data === YT.PlayerState.ENDED) {
          clearVideoPosition(currentVideoUrl);
          videoPlaying = false;
          resetToTileScreen();
        }
      }

      function resetToTileScreen() {
        if (videoTimeLimitTimeout) {
          clearTimeout(videoTimeLimitTimeout);
          videoTimeLimitTimeout = null;
        }
        if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') {
          try { youtubePlayer.stopVideo(); } catch (e) {}
        }
        youtubeDiv.style.display = 'none';
        videoPlayer.pause();
        videoPlayer.currentTime = 0;
        videoSource.src = '';
        videoContainer.style.display = 'none';
        tileContainer.style.display = 'flex';
        videoPlaying = false;
        if (document.fullscreenElement) {
          document.exitFullscreen().catch(() => {});
        } else if (document.webkitFullscreenElement) {
          document.webkitExitFullscreen();
        }
        resetInactivityTimer();
      }

      videoPlayer.addEventListener('ended', () => {
        clearVideoPosition(videoSource.src);
        videoPlaying = false;
        resetToTileScreen();
      });

      function showLoadingScreen() {
        return new Promise(resolve => {
          loadingDiv = document.createElement('div');
          loadingDiv.id = 'loading-screen';
          loadingDiv.style.position = 'fixed';
          loadingDiv.style.top = '0';
          loadingDiv.style.left = '0';
          loadingDiv.style.width = '100vw';
          loadingDiv.style.height = '100vh';
          loadingDiv.style.backgroundColor = 'rgba(0,0,0,0.8)';
          loadingDiv.style.display = 'flex';
          loadingDiv.style.flexDirection = 'column';
          loadingDiv.style.justifyContent = 'center';
          loadingDiv.style.alignItems = 'center';
          loadingDiv.style.color = '#fff';
          loadingDiv.style.fontSize = '24px';
          loadingDiv.style.zIndex = '9999';
          const indicator = document.createElement('div');
          indicator.id = 'loading-indicator';
          indicator.textContent = 'Chargement... (0/0)';
          loadingDiv.appendChild(indicator);
          document.body.appendChild(loadingDiv);
          setTimeout(resolve, 50);
        });
      }

      function hideLoadingScreen() {
        if (loadingDiv && loadingDiv.parentNode) {
          loadingDiv.parentNode.removeChild(loadingDiv);
          loadingDiv = null;
        }
      }

      function preloadVideos(videoUrls) {
        return new Promise(resolve => {
          if (!videoUrls.length) {
            resolve();
            return;
          }
          const indicator = document.getElementById('loading-indicator');
          let loadedCount = 0;
          const total = videoUrls.length;
          Promise.all(videoUrls.map(url => new Promise(res => {
            const tempVid = document.createElement('video');
            tempVid.preload = 'auto';
            tempVid.src = url;
            const update = () => {
              loadedCount++;
              if (indicator) {
                indicator.textContent = `Chargement... (${loadedCount}/${total})`;
              }
              res();
            };
            tempVid.addEventListener('canplaythrough', update, { once: true });
            tempVid.addEventListener('error', update, { once: true });
          })) ).then(() => resolve());
        });
      }

      window.populateTilePickerGrid = populateTilePickerGrid;
      window.resetTactileYoutubeTiles = () => {
        selectedTileIndices = [];
        populateTilePickerGrid();
      };

      window.onYouTubeIframeAPIReady = function() {
        youtubeApiReady = true;
        if (pendingYoutubeLoad && pendingYoutubeLoad.id) {
          const { id, startSeconds = 0 } = pendingYoutubeLoad;
          pendingYoutubeLoad = null;
          if (!youtubePlayer) {
            youtubePlayer = new YT.Player('youtube-player', {
              host: 'https://www.youtube-nocookie.com',
              width: '100%',
              height: '100%',
              videoId: id,
              playerVars: {
                autoplay: 1,
                controls: 0,
                disablekb: 1,
                rel: 0,
                fs: 1,
                modestbranding: 1,
                playsinline: 1
              },
              events: {
                onReady: (event) => {
                  if (startSeconds) {
                    event.target.seekTo(startSeconds, true);
                  }
                  event.target.playVideo();
                },
                onStateChange: onYoutubeStateChange
              }
            });
          } else {
            youtubePlayer.loadVideoById({ videoId: id, startSeconds });
            youtubePlayer.playVideo();
          }
        }
      };

      populateTilePickerGrid();
      resetInactivityTimer();
    })();
  </script>
  <script src="../../js/translationonly.js"></script>
</body>
</html>
