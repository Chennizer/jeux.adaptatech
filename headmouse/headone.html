<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pop the Stars – head-mouse game</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Tracky Mouse UMD build -->
<script id="trackyScript" src="https://cdn.jsdelivr.net/npm/tracky-mouse@1.2.0/tracky-mouse.js"></script>
<!-- Tone.js for audio feedback -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>

<style>
 html,body{margin:0;height:100%;background:#0f0f1e;overflow:hidden}
 #gameCanvas{display:block}
 #counter{
   position:fixed;top:8px;left:8px;
   font:700 1.2rem/1.4 sans-serif;color:#fff;
   background:#0008;padding:.25rem .75rem;border-radius:.5rem;
   z-index: 10;
 }
 .tracky-mouse-pointer{
   width:80px;height:80px;border-radius:40px!important;
   background:#ffd70080!important;border:4px solid #ffd700!important;
 }
 #instructions {
   position: fixed;
   left: 50%; top: 50%; transform: translate(-50%,-50%);
   color: #fff; background: #000c;
   padding: 2rem 2.5rem; border-radius: 1.5rem; font-size: 1.25rem;
   text-align: center; z-index: 20;
   pointer-events: none;
 }
 #error-msg {
   position: fixed;
   left: 50%; top: 50%; transform: translate(-50%,-50%);
   color: #fff; background: #a00d;
   padding: 2rem 2.5rem; border-radius: 1.5rem; font-size: 1.25rem;
   text-align: center; z-index: 30;
 }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="counter">Stars popped: 0</div>
<div id="instructions">
  <b>Pop the Stars!</b><br>
  <br>
  1. When prompted, allow access to your camera.<br>
  2. Move your head and look for the big yellow pointer.<br>
  3. Dwell on a star (hold the pointer over it) to pop it.<br>
</div>
<div id="error-msg" style="display:none;"></div>

<script>
function startGame() {
  // 1. Start Tracky Mouse (with dwell-click)
  const tracker = createHeadTracker({
      dwellClick: 1000,      // ms pointer must hover before a click is fired
      smoothing: 0.3,        // 0–1; more = steadier but slower
      pointerSize: 80
  });

  tracker.start();

  // Hide instructions once head tracking is working (on pointer appear)
  const instr = document.getElementById("instructions");
  let pointerAppeared = false;
  function hideInstructionsWhenPointerAppears() {
    if (document.querySelector('.tracky-mouse-pointer')) {
      if (!pointerAppeared) {
        pointerAppeared = true;
        instr.style.display = "none";
      }
    } else {
      setTimeout(hideInstructionsWhenPointerAppears, 200);
    }
  }
  hideInstructionsWhenPointerAppears();

  // 2. Canvas setup
  const canvas = document.getElementById("gameCanvas");
  const ctx     = canvas.getContext("2d");
  let W=0,H=0;
  function resize() { W=canvas.width=innerWidth; H=canvas.height=innerHeight; }
  window.addEventListener('resize', resize);
  resize();

  let stars = [], popped = 0;
  function makeStar(){
     const r = 50;
     stars.push({
         x: r + Math.random()*(W-2*r),
         y: r + Math.random()*(H-2*r),
         r
     });
  }
  for(let i=0;i<5;i++) makeStar();

  function drawStar(x,y,r){
     ctx.beginPath();
     for(let i=0;i<5;i++){
        const a = i*Math.PI*2/5 - Math.PI/2;
        ctx.lineTo(x+Math.cos(a)*r,y+Math.sin(a)*r);
        const a2 = a+Math.PI/5;
        ctx.lineTo(x+Math.cos(a2)*r*0.5,y+Math.sin(a2)*r*0.5);
     }
     ctx.closePath();
  }

  // 3. Tone synth for sound
  const synth = new Tone.Synth().toDestination();

  function loop(){
     ctx.clearRect(0,0,W,H);
     ctx.fillStyle="#ffcc00";
     stars.forEach(s=>{
         drawStar(s.x,s.y,s.r);
         ctx.fill();
     });
     requestAnimationFrame(loop);
  }
  loop();

  // 4. Pop star on head-mouse dwell click
  window.addEventListener("pointerdown",e=>{
     const {clientX:mx,clientY:my} = e;
     stars = stars.filter(s=>{
        const hit = (mx-s.x)**2 + (my-s.y)**2 < s.r**2;
        if(hit){
           popped++;
           counter.textContent = `Stars popped: ${popped}`;
           synth.triggerAttackRelease("C5","8n");
           makeStar();
        }
        return !hit;
     });
  },true);
}

// Wait until DOM is ready AND tracky-mouse is loaded
function runWhenReady() {
  if (window.createHeadTracker) {
    startGame();
  } else {
    setTimeout(runWhenReady, 20);
  }
}

// Handle camera errors gracefully
document.getElementById("trackyScript").addEventListener("error", function() {
  document.getElementById("instructions").style.display = "none";
  document.getElementById("error-msg").textContent =
    "Tracky Mouse failed to load. (Check your network or firewall settings.)";
  document.getElementById("error-msg").style.display = "";
});

// Try to launch as soon as everything is loaded
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", runWhenReady);
} else {
  runWhenReady();
}
</script>
</body>
</html>
