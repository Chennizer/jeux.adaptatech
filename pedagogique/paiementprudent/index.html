<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Porte-monnaie élève</title>
<link rel="stylesheet" href="../../css/otherswitch.css" />

<style>
:root{
  --bg-angle : 180deg;
  --bg-start : #ffffff;
  --bg-end   : #d9ecff;

  --sidePad  : 100px;
  --coinSize : 90px;
  --coinFont : 1.8rem;

  --gold: #d4af37;
  --gold-dark: #b78a2c;
  --gold-light: #f6e27a;
  --green:#2e7d32; --red:#d32f2f; --border:transparent;
  --f-base:1.8rem; --lh-base:1.2;
}
body.hc{--green:#007b00;--red:#b90000;--border:#fff;}
body.readable{--f-base:2.2rem;--lh-base:1.5;}

html,body{height:100%;margin:0;font-family:Roboto,sans-serif;
  background:linear-gradient(var(--bg-angle),var(--bg-start)0%,var(--bg-end)100%);}
body{
  padding-left:var(--sidePad);
  padding-right:var(--sidePad);  /* SYMMETRY ADDED */
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:var(--f-base);
  line-height:var(--lh-base);
}
#userName{position:fixed;top:8vh;left:calc(50% + var(--sidePad)/2);
  transform:translateX(-50%);font-size:3rem;font-weight:700;text-transform:uppercase;
  color:#333;z-index:2600;pointer-events:none;}
#startOverlay{position:fixed;inset:0;background:#000;z-index:3000;
  display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-align:center;}
#startOverlay h1{font-size:2.2rem;margin-bottom:1.5rem;}
#startBtn{padding:1.1rem 2.4rem;font-size:1.3rem;border:none;border-radius:10px;background:#008080;color:#fff;cursor:pointer;}
#startBtn:hover{background:#009d9d;}
#adminPanel{position:fixed;top:50%;left:16px;transform:translateY(-50%);
  display:flex;flex-direction:column;gap:1rem;z-index:2500;}
.admin-btn{width:60px;height:60px;border:none;border-radius:50%;background:#4a2c49;
  display:flex;align-items:center;justify-content:center;cursor:pointer;}
.admin-btn svg{width:28px;height:28px;stroke:#fff;stroke-width:2;fill:none;}
.rows{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2.5rem;
  transform:translateY(5vh);
}
.wallet{display:grid;grid-template-columns:repeat(10,1fr);gap:1rem;max-width:90vw;}

/* ----------- Alignment Fix ----------- */
.wallet > * {
  box-sizing: border-box;
  margin: 0;
  justify-self: center;
  align-self: center;
}
/* ------------------------------------- */

/* ----------- PIÈCES DU HAUT ----------- */
.coin {
  width: var(--coinSize);
  height: var(--coinSize);
  border-radius: 50%;
  display: flex;align-items: center;justify-content: center;
  font-size: var(--coinFont);
  user-select: none;
  transition:transform .15s,box-shadow .15s;
  font-family: 'Georgia', serif;
  border: 4px solid var(--gold-dark);
  background: radial-gradient(circle at 30% 30%, var(--gold-light) 55%, var(--gold) 90%, var(--gold-dark) 100%);
  color: #fff9e2;
  box-shadow: 0 3px 12px 0 rgba(160,120,0,0.07);
  position: relative;
  cursor: pointer;
}
.coin.selected{transform:translateY(-8px) scale(1.1);box-shadow:0 0 0 6px rgba(212,175,55,0.18);}
.coin:active{transform:translateY(-4px) scale(1.05);}
.coin.placeholder {
  background: transparent;
  border: none;
  pointer-events: none;
  box-shadow: none;
  color: transparent;
}

/* ----------- COMPTEURS (CHIFFRES CARRÉS) ----------- */
.counter {
  width: var(--coinSize);
  height: var(--coinSize);
  border-radius: 9px;      /* carré avec coins légèrement arrondis */
  display: flex;align-items: center;justify-content: center;
  font-size: calc(var(--coinFont) + 0.25rem); /* Plus gros */
  font-weight: 700;
  user-select: none;
  margin: 0;
  transition: background .12s, color .12s, border .12s;
  border: 3px solid #eee;
  background: #f6f7f8;
  color: #444;
}
.counter.good {
  background: var(--green);
  color: #fff;
  border-color: var(--green);
}
.counter.bad {
  background: var(--red);
  color: #fff;
  border-color: var(--red);
  opacity: 0.7;
}

#priceZone{margin-top:4rem;display:flex;flex-direction:column;align-items:center;}
#priceTag{font-size:1.5rem;margin-bottom:1.5rem;}
#payBtn{padding:1rem 3rem;font-size:2.1rem;border:none;border-radius:12px;background:#c65629;color:#fff;cursor:pointer;}
.modalBox{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:320px;background:#fff;border:2px solid teal;padding:20px;border-radius:10px;z-index:4000;text-align:center;}
.modalBox p{margin:0 0 15px;font-size:1.4rem;}
.modalBox input{width:100%;padding:10px;margin:10px 0;font-size:1.2rem;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;}
.modalBtnRow{display:flex;gap:10px;justify-content:center;margin-top:10px;}
.modalBtnRow button{flex:1;padding:10px;font-size:1rem;border:none;border-radius:6px;cursor:pointer;}
.btnPrimary{background:teal;color:#fff;}
.btnSecondary{background:#ccc;}
@keyframes shakeX16{0%,100%{transform:translateX(0)}
  15%,45%,75%{transform:translateX(-16px)}30%,60%,90%{transform:translateX(16px)}}
@keyframes denyCoin{0%{transform:translateX(0)}
  25%{transform:translateX(-8px)}50%{transform:translateX(8px)}
  75%{transform:translateX(-8px)}100%{transform:translateX(0)}}
</style>
</head>
<body>

<div id="userName"></div>

<!-- overlay -->
<div id="startOverlay"><h1>Paiement prudent</h1><button id="startBtn">COMMENCER</button></div>

<!-- colonne admin -->
<aside id="adminPanel">
  <button id="addBtn"      class="admin-btn" title="Ajouter 1$"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></button>
  <button id="setPriceBtn" class="admin-btn" title="Fixer le prix"><svg viewBox="0 0 24 24"><path d="M12 1v22M17 5H9a4 4 0 000 8h6a4 4 0 010 8H6"/></svg></button>
  <button id="resetPwdBtn" class="admin-btn" title="Réinitialiser"><svg viewBox="0 0 24 24"><path d="M21 12A9 9 0 113 12M3 4v5h5"/></svg></button>
</aside>

<!-- pièces -->
<div class="rows">
  <div class="wallet" id="coinsRow"></div>
  <div class="wallet" id="countRow"></div>

  <div id="priceZone">
    <div id="priceTag"></div>
    <button id="payBtn">PAYER</button>
  </div>
</div>

<!-- setup initial -->
<div id="setupModal" class="modalBox">
  <p>Paramétrage initial</p>
  <input id="setupName" placeholder="Prénom (optionnel)">
  <input id="setupPwd1" type="password" placeholder="Mot de passe admin (facultatif)">
  <input id="setupPwd2" type="password" placeholder="Confirmer le mot de passe">
  <div style="font-size:.85rem;margin-top:-6px;color:#555;">Laissez vide si vous ne voulez pas de mot&nbsp;de&nbsp;passe.</div>
  <div class="modalBtnRow"><button id="setupOk" class="btnPrimary">OK</button></div>
</div>

<!-- password -->
<div id="pwdModal" class="modalBox">
  <p id="pwdMsg"></p>
  <input id="pwd1" type="password" placeholder="Mot de passe">
  <input id="pwd2" type="password" placeholder="Confirmer">
  <div class="modalBtnRow"><button id="pwdOk" class="btnPrimary">OK</button><button id="pwdCancel" class="btnSecondary">Annuler</button></div>
</div>

<!-- price -->
<div id="priceModal" class="modalBox">
  <p>Nouveau prix (0,01 – 10,00 $) :</p>
  <input id="priceInput" type="number" step="0.01" min="0.01" max="10">
  <div class="modalBtnRow"><button id="priceOk" class="btnPrimary">OK</button><button id="priceCancel" class="btnSecondary">Annuler</button></div>
</div>

<!-- alert & confirm -->
<div id="alertModal"   class="modalBox"><p id="alertMsg"></p><div class="modalBtnRow"><button id="alertOk" class="btnPrimary">OK</button></div></div>
<div id="confirmModal" class="modalBox"><p id="confirmMsg"></p><div class="modalBtnRow"><button id="confirmYes" class="btnPrimary">Oui</button><button id="confirmNo" class="btnSecondary">Non</button></div></div>

<script>
const $=id=>document.getElementById(id);

/* ---------- état ---------- */
const stored= parseFloat(localStorage.getItem('itemPrice'));
let price = isNaN(stored)?1:+stored.toFixed(2);
let coins = +localStorage.getItem('studentCoins')||0;
let adminPwd=(localStorage.getItem('adminPwd')||'').trim()||null;
let studentName=(localStorage.getItem('studentName')||'').trim();
const selected=new Set();

/* ---------- helpers ---------- */
function show(el){el.style.display='block';}
function hide(el){el.style.display='none';}
function alertBox(msg,cb){$('alertMsg').textContent=msg;show($('alertModal'));$('alertOk').onclick=()=>{hide($('alertModal'));cb&&cb();};}
function confirmBox(msg,yes){$('confirmMsg').textContent=msg;show($('confirmModal'));
  $('confirmYes').onclick=()=>{hide($('confirmModal'));yes();};
  $('confirmNo').onclick=()=>hide($('confirmModal'));}

const isiIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;
function enterFS(){if(isiIOS||document.fullscreenElement)return;document.documentElement.requestFullscreen?.().catch(()=>{});}
function displayName(){if(studentName)$('userName').textContent=studentName.toUpperCase();}
const payNeeded=()=>Math.ceil(price);

/* ---------- setup initial ---------- */
function openSetup(){show($('setupModal'));$('setupName').focus();}
$('setupOk').onclick=()=>{
  const n=$('setupName').value.trim(),p1=$('setupPwd1').value.trim(),p2=$('setupPwd2').value.trim();
  if(p1||p2){
    if(p1!==p2){alertBox('Les mots de passe diffèrent.');return;}
    adminPwd=p1;localStorage.setItem('adminPwd',adminPwd);
  }
  if(n){studentName=n;localStorage.setItem('studentName',studentName);displayName();}
  localStorage.setItem('setupDone','1');hide($('setupModal'));enterFS();
};

/* ---------- password modal ---------- */
let afterPwd=null;
function openPwd(mode,cb){
  afterPwd=cb||null;$('pwd1').value=$('pwd2').value='';
  $('pwd2').style.display=mode==='create'?'block':'none';
  $('pwdMsg').textContent=mode==='create'?'Créer un mot de passe admin :' :'Mot de passe admin :';
  $('pwdModal').dataset.mode=mode;show($('pwdModal'));$('pwd1').focus();
}
$('pwdCancel').onclick=()=>{hide($('pwdModal'));afterPwd=null;};
$('pwdOk').onclick=()=>{
  const p=$('pwd1').value.trim(),m=$('pwdModal').dataset.mode;if(!p)return;
  if(m==='create'){
    if(p!==$('pwd2').value.trim()){alertBox('Les deux mots diffèrent.');return;}
    adminPwd=p;localStorage.setItem('adminPwd',adminPwd);
  }else if(p!==adminPwd){alertBox('Mot de passe incorrect.',()=>{$('pwd1').value='';$('pwd1').focus();});return;}
  hide($('pwdModal'));afterPwd&&afterPwd();
};
const needPwd=cb=>(adminPwd===null?openPwd('create',cb):openPwd('verify',cb));

/* ---------- price modal ---------- */
function openPriceModal(){
  $('priceInput').value=price.toFixed(2).replace('.',',');
  show($('priceModal'));$('priceInput').focus();
}
$('priceCancel').onclick=()=>hide($('priceModal'));
$('priceOk').onclick=()=>{
  const raw=$('priceInput').value.replace(',','.');const v=parseFloat(raw);
  if(!isNaN(v)&&v>=0.01&&v<=10){price=+v.toFixed(2);hide($('priceModal'));saveRender();}
  else alertBox('Entrez un prix valide entre 0,01 et 10,00.');
};

/* ---------- construction pièces ---------- */
for(let i=0;i<10;i++){
  // top row: coins
  const coin=document.createElement('div');coin.className='circle coin placeholder';coin.dataset.idx=i;
  coin.addEventListener('pointerdown',toggleSelect);$('coinsRow').appendChild(coin);
  // bottom row: numbers (square style)
  const nb=document.createElement('div');nb.className='counter bad';nb.textContent=i+1;$('countRow').appendChild(nb);
}

/* ---------- responsive pièces ---------- */
function updateCoinVars(){
  const gap=parseFloat(getComputedStyle(document.documentElement).fontSize);
  const avail=window.innerWidth-parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sidePad'))-20;
  const border=8;let s=Math.floor((avail-gap*9-border*10)/10);
  s=Math.max(Math.min(s,90),50);
  document.documentElement.style.setProperty('--coinSize',s+'px');
  document.documentElement.style.setProperty('--coinFont',(s*0.22)+'px');
}
window.addEventListener('resize',()=>{updateCoinVars();render();});
updateCoinVars();

/* ---------- sélection ---------- */
function deny(el){el.style.animation='denyCoin .4s';setTimeout(()=>{el.style.animation='';},400);}
function toggleSelect(e){
  const idx=+e.currentTarget.dataset.idx;
  if(idx>=coins){deny(e.currentTarget);return;}
  selected.has(idx)?selected.delete(idx):selected.add(idx);render();
}

/* ---------- rendu & persistance ---------- */
function render(){
  // Rangée du haut : pièces réelles ou vides
  [...$('coinsRow').children].forEach((el,i)=>{
    if(i<coins){
      let cls='circle coin'; if(selected.has(i))cls+=' selected';
      el.className=cls;el.textContent='1$';
    }else{
      el.className='circle coin placeholder';el.textContent='';
    }
  });
  // Rangée du bas : compteurs carrés
  [...$('countRow').children].forEach((el,i)=>{
    el.className='counter '+(i<coins?'good':'bad');
  });

  $('priceTag').textContent=`Prix : ${price.toFixed(2)} $`;
  $('payBtn').classList.toggle('dim',selected.size<payNeeded());
}
function save(){localStorage.setItem('studentCoins',coins);localStorage.setItem('itemPrice',price.toFixed(2));}
function saveRender(){save();selected.clear();render();}
render();

/* ---------- pay ---------- */
$('payBtn').onclick=()=>{
  if(selected.size<payNeeded()){
    $('payBtn').style.animation='shakeX16 .6s';setTimeout(()=>{$('payBtn').style.animation='';selected.clear();render();},600);
    return;
  }
  coins-=payNeeded();
  [...selected].sort((a,b)=>a-b).slice(0,payNeeded()).forEach(i=>selected.delete(i));
  saveRender();
};

/* ---------- admin buttons ---------- */
$('addBtn').onclick =()=>needPwd(()=>{coins<10?coins++:alertBox('Porte-monnaie plein !');saveRender();});
$('setPriceBtn').onclick=()=>needPwd(openPriceModal);
$('resetPwdBtn').onclick=()=>confirmBox('Réinitialiser le mot de passe ?',()=>{localStorage.removeItem('adminPwd');adminPwd=null;openPwd('create');});

/* ---------- démarrage ---------- */
$('startBtn').onclick=()=>{
  hide($('startOverlay'));displayName();enterFS();
  if(!localStorage.getItem('setupDone')) openSetup();
};
if(studentName)displayName();
</script>
</body>
</html>
