<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Samurai Story Journey</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Helvetica Neue", Arial, system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      height: 100%;
    }

    body {
      background: #08090c;
      color: #f9fafb;
      overflow: hidden;
    }

    #app {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .page {
      position: absolute;
      inset: 0;
      display: none;
    }

    .page.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .story-page {
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.25), transparent 60%),
                  radial-gradient(circle at bottom, rgba(249, 115, 22, 0.15), transparent 70%),
                  #07080b;
      padding: clamp(16px, 4vw, 48px);
    }

    .story-media {
      position: relative;
      max-width: min(92vw, 1200px);
      max-height: min(86vh, 760px);
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
    }

    .story-image {
      display: block;
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      filter: grayscale(100%) contrast(1.2) brightness(0.95);
      animation: colorFadeIn 4s ease-in-out forwards;
      transition: filter 0.3s ease, opacity 0.8s ease-in-out;
      opacity: 1;
    }

    .story-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0;
      display: none;
      transition: opacity 1.2s ease-in-out;
      z-index: 2;
    }

    .story-media.video-playing .story-video {
      opacity: 1;
      display: block;
    }

    .story-media.video-playing .story-image {
      opacity: 0;
    }

    @keyframes colorFadeIn {
      0% {
        filter: grayscale(100%) contrast(1.2) brightness(0.95);
      }
      20% {
        filter: grayscale(100%) contrast(1.2) brightness(0.95);
      }
      100% {
        filter: grayscale(0%) contrast(1) brightness(1);
      }
    }

    .page.game-page {
      background: #000;
      padding: 0;
    }

    .game-frame {
      width: 100%;
      height: 100%;
      display: block;
      background: #000;
      position: relative;
      overflow: hidden;
    }

    .next-button {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 26px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(15, 23, 42, 0.85);
      color: #f8fafc;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .next-button:hover,
    .next-button:focus-visible {
      transform: translateY(-2px);
      background: rgba(30, 41, 59, 0.95);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
      outline: none;
    }
  </style>
</head>
<body>
  <div id="app">
    <section class="page story-page active" data-type="story" data-image="paysagejapon.jpg" data-alt="A peaceful Japanese landscape at dawn.">
      <div class="story-media" data-story-media>
        <img class="story-image" alt="" />
        <video class="story-video" muted loop playsinline></video>
      </div>
    </section>

    <section class="page story-page" data-type="story" data-image="boulebleuchi.jpg" data-alt="A samurai focuses on a glowing chi sphere.">
      <div class="story-media" data-story-media>
        <img class="story-image" alt="" />
        <video class="story-video" muted loop playsinline></video>
      </div>
    </section>

    <section class="page game-page" data-type="game" data-game="cherry">
      <div class="game-frame" data-game-host></div>
    </section>

    <section class="page story-page" data-type="story" data-image="maitrechi.jpg" data-alt="A master guides the samurai with calm energy.">
      <div class="story-media" data-story-media>
        <img class="story-image" alt="" />
        <video class="story-video" muted loop playsinline></video>
      </div>
    </section>

    <section class="page game-page" data-type="game" data-game="meditation">
      <div class="game-frame" data-game-host></div>
    </section>

    <section class="page story-page" data-type="story" data-image="lanternesallu.jpg" data-alt="Lanterns glow softly in the night sky.">
      <div class="story-media" data-story-media>
        <img class="story-image" alt="" />
        <video class="story-video" muted loop playsinline></video>
      </div>
    </section>

    <section class="page game-page" data-type="game" data-game="lamp">
      <div class="game-frame" data-game-host></div>
    </section>

    <section class="page story-page" data-type="story" data-image="katanafleurs.jpg" data-alt="A katana rests among drifting cherry blossoms.">
      <div class="story-media" data-story-media>
        <img class="story-image" alt="" />
        <video class="story-video" muted loop playsinline></video>
      </div>
    </section>
  </div>

  <button id="nextButton" class="next-button" type="button">Next</button>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const pages = Array.from(document.querySelectorAll('.page'));
      const nextButton = document.getElementById('nextButton');
      const imageBasePath = '../../images/samuraikata/';
      const videoBasePath = '../../animations/samurai/';
      const fadeDurationMs = 4000;
      let currentIndex = 0;

      const storyTimers = new WeakMap();
      const gameSessions = new Map();

      const clearStoryTimers = (page) => {
        const timers = storyTimers.get(page);
        if (!timers) return;
        if (timers.videoTimeout) {
          clearTimeout(timers.videoTimeout);
        }
        if (timers.checkTimeout) {
          clearTimeout(timers.checkTimeout);
        }
        storyTimers.delete(page);
      };

      const resetStoryMedia = (page) => {
        const media = page.querySelector('[data-story-media]');
        const image = page.querySelector('.story-image');
        const video = page.querySelector('.story-video');
        if (!media || !image || !video) return;
        media.classList.remove('video-playing');
        video.pause();
        video.removeAttribute('src');
        video.load();
        image.style.animation = 'none';
        void image.offsetHeight;
        image.style.animation = 'colorFadeIn 4s ease-in-out forwards';
      };

      const checkVideoExists = (path, callback) => {
        const tester = document.createElement('video');
        let settled = false;
        const clean = () => {
          tester.removeEventListener('loadeddata', onLoad);
          tester.removeEventListener('error', onError);
        };
        const onLoad = () => {
          if (settled) return;
          settled = true;
          clean();
          callback(true);
        };
        const onError = () => {
          if (settled) return;
          settled = true;
          clean();
          callback(false);
        };
        tester.addEventListener('loadeddata', onLoad);
        tester.addEventListener('error', onError);
        tester.src = path;
        tester.preload = 'metadata';
        tester.load();
        const timeoutId = setTimeout(() => {
          if (settled) return;
          settled = true;
          clean();
          callback(false);
        }, 1200);
        return timeoutId;
      };

      const setupStoryPage = (page) => {
        clearStoryTimers(page);
        const imageName = page.dataset.image;
        const altText = page.dataset.alt || '';
        const media = page.querySelector('[data-story-media]');
        const image = page.querySelector('.story-image');
        const video = page.querySelector('.story-video');
        if (!imageName || !media || !image || !video) return;

        resetStoryMedia(page);
        image.src = `${imageBasePath}${imageName}`;
        image.alt = altText;
        media.classList.remove('video-playing');

        const videoName = imageName.replace(/\.(jpg|jpeg|png)$/i, '.mp4');
        const videoPath = `${videoBasePath}${videoName}`;

        const timers = { videoTimeout: null, checkTimeout: null };
        timers.checkTimeout = checkVideoExists(videoPath, (exists) => {
          if (!exists) return;
          video.src = videoPath;
          video.load();
          timers.videoTimeout = setTimeout(() => {
            if (pages[currentIndex] !== page) return;
            media.classList.add('video-playing');
            const playPromise = video.play();
            if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch(() => {});
            }
          }, fadeDurationMs + 300);
        });
        storyTimers.set(page, timers);
      };

      const gameTemplates = {
        cherry: 'tpl-cherryblossom',
        meditation: 'tpl-meditation',
        lamp: 'tpl-lamp'
      };

      const templateCache = {};
      const loadTemplate = (id) => {
        if (!templateCache[id]) {
          const tpl = document.getElementById(id);
          templateCache[id] = tpl ? tpl.innerHTML.trim() : '';
        }
        return templateCache[id];
      };

      const stopGame = (page) => {
        const key = page?.dataset.game;
        if (!key) return;
        const session = gameSessions.get(key);
        if (!session) return;
        const attemptStop = (api) => {
          if (!api || typeof api.stop !== 'function') return;
          try {
            const maybePromise = api.stop();
            if (maybePromise && typeof maybePromise.then === 'function') {
              maybePromise.catch(() => {});
            }
          } catch (error) {
            /* ignore stop errors */
          }
        };
        if (session.api) {
          attemptStop(session.api);
        } else if (session.apiPromise) {
          session.apiPromise.then(attemptStop).catch(() => {});
        }
        if (session.host) {
          session.mountedNodes = Array.from(session.host.childNodes);
          if (session.mountedNodes.length) {
            session.mountedNodes.forEach((node) => {
              if (node.parentNode === session.host) {
                session.host.removeChild(node);
              }
            });
            session.detached = true;
          }
        }
      };

      const mountGameTemplate = async (host, templateId) => {
        const html = loadTemplate(templateId);
        if (!html) return null;
        let scriptPromises = [];
        try {
          host.innerHTML = '';
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const fragment = document.createDocumentFragment();
          const appendChildren = (parent) => {
            if (!parent) return;
            parent.childNodes.forEach((node) => {
              if (node.nodeName === 'TITLE') return;
              fragment.appendChild(node.cloneNode(true));
            });
          };
          appendChildren(doc.head);
          appendChildren(doc.body);
          window.storyGameApi = null;
          host.appendChild(fragment);
          host.querySelectorAll('script').forEach((oldScript) => {
            const newScript = document.createElement('script');
            newScript.async = false;
            Array.from(oldScript.attributes).forEach((attr) => {
              newScript.setAttribute(attr.name, attr.value);
            });
            newScript.textContent = oldScript.textContent;
            const promise = newScript.src
              ? new Promise((resolve) => {
                  newScript.addEventListener('load', resolve, { once: true });
                  newScript.addEventListener('error', resolve, { once: true });
                })
              : Promise.resolve();
            scriptPromises.push(promise);
            oldScript.replaceWith(newScript);
          });
        } catch (error) {
          return null;
        }
        try {
          await Promise.all(scriptPromises);
        } catch (error) {
          /* ignore script load failures */
        }
        return window.storyGameApi || null;
      };

      const loadGame = (key, page) => {
        const host = page.querySelector('[data-game-host]');
        if (!host) return;

        let session = gameSessions.get(key);
        if (!session) {
          const templateId = gameTemplates[key];
          if (!templateId) return;
          const apiPromise = mountGameTemplate(host, templateId);
          const mountedNodes = Array.from(host.childNodes);
          session = { host, api: null, apiPromise, mountedNodes, detached: false };
          gameSessions.set(key, session);
        } else {
          session.host = host;
          if (!session.mountedNodes || !session.mountedNodes.length) {
            session.mountedNodes = Array.from(host.childNodes);
          }
          if (session.detached && session.mountedNodes && session.mountedNodes.length) {
            host.innerHTML = '';
            session.mountedNodes.forEach((node) => {
              host.appendChild(node);
            });
            session.detached = false;
          }
        }

        const startGame = async () => {
          try {
            if (!session.api) {
              session.api = await session.apiPromise;
            }
          } catch (error) {
            return;
          }
          if (pages[currentIndex] !== page) return;
          const api = session.api;
          if (!api || typeof api.start !== 'function') return;
          window.requestAnimationFrame(() => {
            try {
              const maybePromise = api.start();
              if (maybePromise && typeof maybePromise.then === 'function') {
                maybePromise.catch(() => {});
              }
            } catch (error) {
              /* ignore start errors */
            }
          });
        };

        startGame();
      };

      const showPage = (index) => {
        if (index < 0 || index >= pages.length) return;
        if (index === currentIndex) return;

        const previousPage = pages[currentIndex];
        if (previousPage) {
          previousPage.classList.remove('active');
          if (previousPage.dataset.type === 'story') {
            clearStoryTimers(previousPage);
            resetStoryMedia(previousPage);
          }
          if (previousPage.dataset.type === 'game') {
            stopGame(previousPage);
          }
        }

        currentIndex = index;
        const page = pages[currentIndex];
        if (!page) return;
        page.classList.add('active');

        if (page.dataset.type === 'story') {
          setupStoryPage(page);
        }
        if (page.dataset.type === 'game') {
          loadGame(page.dataset.game, page);
        }
      };

      const nextPage = () => {
        const nextIndex = (currentIndex + 1) % pages.length;
        showPage(nextIndex);
      };

      if (nextButton) {
        nextButton.addEventListener('click', () => {
          nextPage();
        });
      }

      document.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowRight' || event.key === ' ') {
          nextPage();
        }
      });

      setupStoryPage(pages[currentIndex]);
    });
  </script>

  <template id="tpl-cherryblossom">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cherry Blossom Cut — Tornado Swirl (Fly-Off) Intro</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    #game {
      display: block;
      width: 100vw; height: 100vh;
      cursor: crosshair;
      background: #000;
    }
    #startOverlay {
      position: fixed; inset: 0;
      background: #000;
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="startOverlay" aria-hidden="true"></div>
  <canvas id="game"></canvas>

  <script src="./cherryblossom.js"></script>
</body>
</html>
  </template>

  <template id="tpl-meditation">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Samurai Focus — One Orb → Moon (Shaded Sphere, Moonrocks, Random Impact SFX, Large Pointer)</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #game { display:block; width:100vw; height:100vh; cursor: none; background:#000; }
    #startOverlay { position:fixed; inset:0; background:#000; z-index:10; pointer-events:none; }

  </style>
</head>
<body>
  <div id="startOverlay" aria-hidden="true"></div>
  <canvas id="game"></canvas>

  <script src="./meditation.js"></script>
</body>
</html>
  </template>

  <template id="tpl-lamp">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sky Lanterns — Dual Lamps + Scattered + Colored Fireflies + BG Lanterns + Shooting Star + Ropes</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { display: flex; }
    #layout { display: flex; width: 100vw; height: 100vh; background: #000; overflow: hidden; }
    #modePanel {
      width: 20vw; min-width: 180px; max-width: 320px; background: #050505;
      border-right: 1px solid rgba(255,255,255,0.04); box-shadow: 10px 0 26px rgba(0,0,0,0.55);
      display: flex; align-items: center; justify-content: center;
      padding: clamp(32px, 5vh, 72px) clamp(16px, 1.8vw, 32px); position: relative; z-index: 12;
    }
    #modePanel .panel-ornaments { position: absolute; inset: 0; pointer-events: none; }
    #modePanel .panel-ornaments img { position: absolute; width: clamp(110px, 14vw, 160px); opacity: 0.18; filter: blur(0.2px) drop-shadow(0 6px 10px rgba(0,0,0,0.55)); }
    #modePanel .panel-ornaments .branch-corner { bottom: clamp(18px, 6vh, 32px); left: clamp(12px, 2vw, 28px); transform: rotate(-12deg); }

    #playArea { flex: 1; position: relative; height: 100vh; background: #000; overflow: hidden; z-index: 20; }
    #game { display: block; width: 100%; height: 100%; background: #000; position: relative; }

    #startOverlay { position: absolute; inset: 0; background: #000; z-index: 30; pointer-events: none; }

    #modeSelector {
      display: flex; flex-direction: column; gap: clamp(24px, 5vh, 48px); width: 100%; align-items: center;
      pointer-events: none; color: #f8eacb; font-size: 16px; text-transform: uppercase; letter-spacing: 0.08em;
    }
    .mode-tile {
      position: relative; width: clamp(120px, 16vw, 220px); aspect-ratio: 1; border-radius: 24px;
      background: rgba(18,18,22,0.92); border: 1px solid rgba(255,255,255,0.08);
      display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto;
      transition: transform 0.22s ease, border-color 0.22s ease, box-shadow 0.22s ease; box-shadow: 0 12px 26px rgba(0,0,0,0.5);
    }
    .mode-tile img { width: 68%; height: 68%; object-fit: contain; filter: drop-shadow(0 6px 10px rgba(0,0,0,0.55)); pointer-events: none; user-select: none; }
    .mode-tile .label {
      position: absolute; bottom: -28px; left: 50%; transform: translateX(-50%);
      font-size: 13px; letter-spacing: 0.12em; color: rgba(255,240,200,0.75); text-shadow: 0 2px 6px rgba(0,0,0,0.6); pointer-events: none;
    }
    .mode-tile.active { border-color: rgba(255,210,120,0.5); box-shadow: 0 16px 36px rgba(255,180,60,0.24); }
    .mode-tile.hovering { transform: translateY(-6px); border-color: rgba(255,120,120,0.65); }
    .mode-tile .progress {
      position: absolute; top: 50%; left: 50%; width: 0; height: 0; opacity: 0; transform: translate(-50%, -50%);
      border-radius: 20px; pointer-events: none; background: rgba(220,20,20,0.55);
      transition: width 0.08s linear, height 0.08s linear, opacity 0.12s ease;
    }
    .mode-tile.hovering .progress { opacity: 0.75; }
  </style>
</head>
<body>
  <div id="layout">
    <aside id="modePanel">
      <div class="panel-ornaments" aria-hidden="true">
        <img src="../../images/samurai/cherryblossom.png" alt="" class="branch-corner" />
      </div>
      <div id="modeSelector" role="group" aria-label="Interaction mode">
        <div class="mode-tile active" data-mode="chi" aria-pressed="true" role="button">
          <img src="../../images/samurai/transparentchi.png" alt="Chi mode" />
          <div class="progress"></div>
          <span class="label">Chi</span>
        </div>
        <div class="mode-tile" data-mode="katana" aria-pressed="false" role="button">
          <img src="../../images/samurai/katana.png" alt="Katana mode" />
          <div class="progress"></div>
          <span class="label">Katana</span>
        </div>
      </div>
    </aside>
    <div id="playArea">
      <div id="startOverlay" aria-hidden="true"></div>
      <canvas id="game"></canvas>
    </div>
  </div>

  <script src="./lamp.js"></script>
</body>
</html>
  </template>
</body>
</html>
