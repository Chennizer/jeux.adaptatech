<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Chasse aux lettres - Cartes imagées</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root {
      --teal: #009688;
      --teal-dark: #00796b;
      --bg: #f5fffd;
      --card-bg: #ffffff;
      --text-main: #063942;
      --dwell-ms: 1600ms;
    }

    body {
      margin: 0;
      font-family: "Quicksand", "Nunito", "Poppins", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: clamp(16px, 4vw, 32px);
      box-sizing: border-box;
    }

    main {
      width: min(960px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: clamp(20px, 4vw, 32px);
    }

    h1 {
      font-size: clamp(1.6rem, 2vw + 1rem, 2.2rem);
      text-align: center;
      margin: 0;
      color: var(--teal-dark);
      letter-spacing: 0.02em;
    }

    .story-card {
      width: 100%;
      background: var(--card-bg);
      border-radius: 28px;
      box-shadow: 0 16px 50px rgba(0, 150, 136, 0.15);
      padding: clamp(18px, 3vw, 28px);
      display: grid;
      grid-template-columns: minmax(180px, 240px) 1fr;
      gap: clamp(16px, 3vw, 32px);
      align-items: center;
    }

    .story-image {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .story-image img {
      width: 100%;
      max-width: clamp(200px, 26vw, 280px);
      aspect-ratio: 1 / 1;
      object-fit: contain;
      background: radial-gradient(circle at 30% 30%, rgba(0, 150, 136, 0.12), rgba(0, 150, 136, 0.03));
      border-radius: 24px;
      padding: clamp(12px, 2vw, 24px);
    }

    .story-text {
      display: flex;
      flex-direction: column;
      gap: clamp(10px, 2vw, 16px);
    }

    .story-sentence {
      font-size: clamp(1.4rem, 2vw + 1rem, 2.4rem);
      font-weight: 600;
      margin: 0;
      line-height: 1.2;
    }

    .story-sentence .sentence-letter {
      font-size: clamp(2.4rem, 4vw + 1rem, 3.2rem);
      color: var(--teal);
      display: inline-block;
      margin-right: 12px;
    }

    .story-sentence .sentence-word {
      color: var(--teal-dark);
    }

    .story-hint {
      font-size: clamp(1rem, 1vw + 0.8rem, 1.2rem);
      margin: 0;
      opacity: 0.75;
    }

    .letter-grid {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(120px, 20vw, 170px), 1fr));
      gap: clamp(16px, 3vw, 28px);
      justify-items: stretch;
    }

    .letter-cell {
      position: relative;
      border-radius: 22px;
      background: #ffffff;
      border: 3px solid rgba(0, 150, 136, 0.15);
      min-height: clamp(120px, 18vw, 180px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(2.4rem, 4vw, 3.4rem);
      font-weight: 700;
      color: var(--text-main);
      transition: transform 200ms ease, box-shadow 200ms ease, border-color 200ms ease;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      overflow: hidden;
    }

    .letter-cell:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 26px rgba(0, 150, 136, 0.14);
      border-color: rgba(0, 150, 136, 0.35);
    }

    .letter-cell.locked {
      pointer-events: none;
    }

    .letter-cell.correct {
      background: var(--teal);
      color: #fff;
      box-shadow: 0 20px 36px rgba(0, 150, 136, 0.35);
    }

    .letter-cell.wrong {
      border-color: rgba(198, 40, 40, 0.6);
      box-shadow: 0 16px 30px rgba(198, 40, 40, 0.18);
    }

    .letter-cell .dwell-fill {
      position: absolute;
      inset: 6px;
      border-radius: 16px;
      background: rgba(0, 150, 136, 0.18);
      transform: scaleX(0);
      transform-origin: left center;
      transition: transform var(--dwell-ms) linear;
      pointer-events: none;
    }

    .letter-cell .dwell-fill.active {
      transform: scaleX(1);
    }

    .letter-grid.disabled .letter-cell {
      pointer-events: none;
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }

    #gazePointer {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--gp-size, 42px);
      height: var(--gp-size, 42px);
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 9999;
      opacity: 0.9;
      transition: opacity 120ms ease;
    }

    #gazePointer::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(255, 0, 0, 0.28);
      border: 3px solid rgba(255, 0, 0, 0.65);
      box-shadow: 0 0 14px rgba(255, 0, 0, 0.45);
    }

    #gazePointer.dwell::before {
      animation: pointerPulse 700ms ease-in-out infinite alternate;
    }

    @keyframes pointerPulse {
      from { transform: scale(0.95); }
      to   { transform: scale(1.05); }
    }

    @media (max-width: 720px) {
      .story-card {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .story-sentence {
        font-size: clamp(1.6rem, 4vw + 1rem, 2.4rem);
      }

      .story-sentence .sentence-letter {
        margin-right: 0;
        display: block;
      }

      .letter-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>On cherche la lettre</h1>

    <section class="story-card">
      <div class="story-image">
        <img id="cardImage" src="" alt="Illustration" />
      </div>
      <div class="story-text">
        <p id="cardSentence" class="story-sentence"></p>
        <p class="story-hint">Fixe la bonne lettre pour la sélectionner.</p>
      </div>
    </section>

    <section id="letterGrid" class="letter-grid" aria-live="polite"></section>
  </main>

  <div id="gazePointer" hidden></div>

  <script>
    const cards = [
      {
        letter: 'S',
        word: 'Sapin',
        image: '../../images/pictos/fir.png'
      },
      {
        letter: 'P',
        word: 'Pomme',
        image: '../../images/pictos/apple.png'
      },
      {
        letter: 'L',
        word: 'Lion',
        image: '../../images/pictos/lion.png'
      },
      {
        letter: 'B',
        word: 'Baleine',
        image: '../../images/pictos/whale.png'
      }
    ];

    const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const dwellDuration = 1600;

    const headingEl = document.querySelector('h1');
    const sentenceEl = document.getElementById('cardSentence');
    const imageEl = document.getElementById('cardImage');
    const gridEl = document.getElementById('letterGrid');
    const pointerEl = document.getElementById('gazePointer');

    let cardIndex = 0;
    let acceptingInput = true;
    let dwellTimeout = null;
    let activeCell = null;
    let activeOverlay = null;

    function buildSentence(card) {
      return `<span class="sentence-letter">${card.letter}</span> comme dans <span class="sentence-word">${card.word}</span>`;
    }

    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function getOptions(target) {
      const letters = new Set([target]);
      while (letters.size < 4) {
        const pick = ALPHABET[Math.floor(Math.random() * ALPHABET.length)];
        letters.add(pick);
      }
      return shuffle([...letters]);
    }

    function clearGrid() {
      gridEl.innerHTML = '';
    }

    function cancelDwell() {
      clearTimeout(dwellTimeout);
      dwellTimeout = null;
      if (activeOverlay && activeOverlay.parentElement) {
        activeOverlay.parentElement.removeChild(activeOverlay);
      }
      activeOverlay = null;
      activeCell = null;
      pointerEl?.classList.remove('dwell');
    }

    function startDwell(cell) {
      if (!acceptingInput) return;
      if (activeCell === cell) return;
      cancelDwell();

      activeCell = cell;
      const overlay = document.createElement('div');
      overlay.className = 'dwell-fill';
      overlay.style.setProperty('--dwell-ms', `${dwellDuration}ms`);
      cell.appendChild(overlay);
      activeOverlay = overlay;

      requestAnimationFrame(() => {
        overlay.classList.add('active');
      });

      pointerEl?.classList.add('dwell');

      dwellTimeout = setTimeout(() => {
        handleSelection(cell);
        cancelDwell();
      }, dwellDuration);
    }

    function handleSelection(cell) {
      if (!acceptingInput) return;
      cancelDwell();
      const expected = cards[cardIndex].letter;
      const picked = cell.dataset.letter;

      if (picked !== expected) {
        cell.classList.add('wrong');
        setTimeout(() => cell.classList.remove('wrong'), 500);
        if (navigator.vibrate) {
          try { navigator.vibrate(80); } catch (e) { /* ignore */ }
        }
        return;
      }

      acceptingInput = false;
      gridEl.classList.add('disabled');
      cell.classList.add('correct');

      setTimeout(() => {
        cell.classList.remove('correct');
        gridEl.classList.remove('disabled');
        cardIndex = (cardIndex + 1) % cards.length;
        acceptingInput = true;
        loadCard();
      }, 1400);
    }

    function createCell(letter) {
      const cell = document.createElement('div');
      cell.className = 'letter-cell';
      cell.dataset.letter = letter;
      cell.textContent = letter;

      cell.addEventListener('pointerenter', () => startDwell(cell));
      cell.addEventListener('pointerleave', cancelDwell);
      cell.addEventListener('pointercancel', cancelDwell);
      cell.addEventListener('click', () => handleSelection(cell));

      return cell;
    }

    function loadCard() {
      cancelDwell();
      const card = cards[cardIndex];
      gridEl.classList.remove('disabled');
      headingEl.textContent = `On cherche la lettre ${card.letter}`;
      sentenceEl.innerHTML = buildSentence(card);
      imageEl.src = card.image;
      imageEl.alt = card.word;

      const options = getOptions(card.letter);
      clearGrid();
      options.forEach(letter => {
        gridEl.appendChild(createCell(letter));
      });
    }

    function setupPointer() {
      if (!pointerEl) return;
      pointerEl.hidden = false;
      pointerEl.style.opacity = 0;
      const move = (event) => {
        pointerEl.style.left = `${event.clientX}px`;
        pointerEl.style.top = `${event.clientY}px`;
      };
      window.addEventListener('pointermove', move, { passive: true });
      window.addEventListener('pointerleave', () => {
        pointerEl.style.opacity = 0;
      });
      window.addEventListener('pointerenter', () => {
        pointerEl.style.opacity = 0.9;
      });
    }

    setupPointer();
    loadCard();
  </script>
</body>
</html>
