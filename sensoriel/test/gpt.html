<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Routine matinale — Reveal BYOL (stable viewport sizing)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/theme/white.css" id="theme">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/monokai.css">
  <style>
    :root{
      --ink:#1a1a1a; --muted:#52606d; --green:#294936; --mint:#ADF1D2; --card-br:#e6eaef; --shadow:0 4px 18px rgba(0,0,0,.10);
      --shell-gap:  clamp(10px, 2vmin, 22px);
      --grid-gap:   clamp(10px, 2vmin, 22px);
      --content-inset: clamp(10px, 3vmin, 36px);

      --safe-top:    max(env(safe-area-inset-top), 18px);
      --safe-bottom: max(env(safe-area-inset-bottom), 18px);
      --ui-reserve:  clamp(48px, 7vh, 84px);

      --side-w:    clamp(120px, 14vw, 220px);
      --side-pad:  clamp(8px, 2vmin, 18px);
      --title-h:   clamp(52px, 9vh, 120px);

      --rows: 2; --cols: 2;
      --tile-min: 160px; --tile-max: 520px;

      --bottom-ui: var(--ui-reserve);
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{ overflow:hidden; }
    .reveal, .reveal .slides { height:100vh; width:100vw; }
    .reveal .slides > section { height:100vh; width:100vw; padding:0; }
    .reveal .slides{ color:var(--ink); text-align:left; }

    .reveal h1, .reveal h2{
      text-align:center; margin:0; color:var(--green); text-transform:uppercase; font-weight:800; letter-spacing:.5px;
      line-height:1.1;
    }
    .reveal h1{ font-size:clamp(2.6rem,6vw,5rem) }
    .reveal h2{ font-size:clamp(2.0rem,4.6vw,3.6rem) }
    .note-tip{ font-size:.95rem; color:var(--muted); }
    a{ color:#D36135; }

    .slide-shell{
      display:grid; height:100vh; width:100vw; overflow:hidden;
      grid-template-columns: calc(100vw - var(--side-w) - var(--shell-gap)) var(--side-w);
      gap: var(--shell-gap);
      padding: var(--safe-top) var(--shell-gap) calc(var(--safe-bottom) + var(--ui-reserve)) var(--shell-gap);
    }
    .shell-main{ display:flex; flex-direction:column; gap: var(--shell-gap); min-width:0; min-height:0; }
    .title-row{ height:var(--title-h); display:flex; align-items:center; justify-content:center; }
    .grid-wrap{ flex:1 1 auto; min-height:0; min-width:0; }
    .inset{ padding: 0 var(--content-inset) var(--content-inset); }

    .shell-side{
      display:grid;
      grid-template-rows: auto auto;
      align-content:start;
      gap: clamp(8px, 1.6vmin, 14px);
      padding: var(--side-pad);
      min-height:0;
      justify-items:stretch;
      align-items:start;
    }
    .side-card, .side-btn{
      background: transparent; border: none; box-shadow:none; padding:0;
      display:flex; align-items:center; justify-content:center; min-height:0;
    }
    .side-btn{ cursor:pointer; }
    .side-card img, .side-btn img{
      width: 100%; height: auto; max-height: min(28vh, 40svh); object-fit: contain; display: block; border-radius:14px;
    }
    .side-btn:focus-visible{ outline:3px solid var(--mint); outline-offset:4px; border-radius:14px; }

    .sized-grid{
      width:100%; height:100%;
      display:grid; gap: var(--grid-gap);
      --avail-w: calc(100vw - var(--side-w) - 3 * var(--shell-gap) - 2 * var(--content-inset));
      --avail-h: calc(100vh - var(--safe-top) - var(--title-h) - var(--shell-gap) - var(--bottom-ui));
      --tile-w: calc((var(--avail-w) - (var(--cols) - 1) * var(--grid-gap)) / var(--cols));
      --tile-h: calc((var(--avail-h) - (var(--rows) - 1) * var(--grid-gap)) / var(--rows));
      --tile-size: clamp(var(--tile-min), min(var(--tile-w), var(--tile-h)), var(--tile-max));
      grid-template-columns: repeat(var(--cols), var(--tile-size));
      grid-template-rows:    repeat(var(--rows), var(--tile-size));
      place-content:center;
      min-width:0; min-height:0;
    }
    .tile{
      width:100%; height:100%; border:2px solid var(--card-br); border-radius:18px; background:#fff; box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center; overflow:hidden; aspect-ratio:1/1;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease; cursor:pointer;
    }
    .tile:hover{ transform:translateY(-1px); border-color:#ADF1D2; box-shadow:0 4px 14px rgba(0,0,0,.12); }
    .tile img{ width:92%; height:92%; object-fit:contain; display:block; }

    .badge{ display:inline-block; padding:1rem 1.6rem; border-radius:16px; border:1px solid #294936; color:#fff; background:#294936; font-weight:700; }

    .vid-slide{ padding:0 !important; background:#000; }
    .vid-wrap{ position:relative; width:100%; height:100%; background:#000; }
    .vid{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; }
    .vid-overlay{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.55); color:#fff; padding:.6rem 1rem; border-radius:10px; font-size:1rem; display:none; z-index:2; cursor:pointer; }

    body.immersive .reveal .controls, body.immersive .reveal .progress, body.immersive .reveal .slide-number { display:none !important; }
    :focus-visible{ outline:3px solid var(--mint); outline-offset:2px; border-radius:10px; }

    @media (max-width: 900px){
      .slide-shell{ grid-template-columns: 1fr; }
      .shell-side{ grid-template-rows: auto auto; grid-auto-rows: 1fr; }
    }

    .transfer-wrap{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--grid-gap);
      align-items:stretch;
      padding-bottom: calc(var(--content-inset) * 0.5);
      column-gap: clamp(24px, 4vmin, 60px);
      row-gap: clamp(16px, 3vmin, 40px);
      padding-inline: clamp(12px, 3vmin, 36px);
    }
    .bin{
      border: 3px solid color-mix(in srgb, var(--bin-accent, #294936) 18%, var(--card-br));
      border-radius: 16px;
      padding: clamp(8px, 1.6vmin, 16px);
      overflow: hidden; /* anti-scroll back in */
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(clamp(120px, 18vmin, 220px), 1fr));
      gap: var(--grid-gap);
      align-content:start;
      background:#fff;
      box-shadow: var(--shadow);
    }
    .bin.drag-over{
      border: 3px solid color-mix(in srgb, var(--bin-accent, #294936) 65%, var(--card-br));
      box-shadow:
        0 0 0 4px color-mix(in srgb, var(--bin-accent, #294936) 20%, transparent) inset,
        0 6px 22px rgba(0,0,0,.10);
    }
    .draggable{ background: transparent; border: none; padding: 0; display:flex; align-items:center; justify-content:center; cursor: grab; border-radius: 14px; }
    .draggable:active{ cursor: grabbing; }
    .draggable img{ width: 100%; height: auto; aspect-ratio: 1/1; object-fit: contain; display: block; border-radius: 14px; }
    .transfer-controls{ margin-bottom: clamp(8px, 1.6vmin, 16px); display:flex; gap:.6rem; align-items:center; justify-content:flex-end; }
    .btn{ border:1px solid var(--card-br); background:#f9fafb; padding:.5em .8em; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:hover{ background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.08); }

    /* BIG date slide */
    .date-giant{
      display:flex;
      gap: .6em;
      align-items: baseline;
      justify-content: center;
      flex-wrap: wrap;
      color: var(--green);
      text-align: center;
    }
    .date-giant .weekday{ font-weight: 900; font-size: clamp(2rem, 6vw, 5rem); text-transform: capitalize; }
    .date-giant .day    { font-weight: 900; font-size: clamp(2.4rem, 8vw, 6rem); }
    .date-giant .month  { font-weight: 800; font-size: clamp(2rem, 6vw, 5rem); text-transform: lowercase; }

    /* Step groups for progressive reveal */
    .step-group{ display:inline-flex; gap:.35em; align-items:baseline; }

    .reveal-step{ opacity:0; transform: translateY(6px); transition: opacity .22s ease, transform .22s ease; }
    .reveal-step.show{ opacity:1; transform:none; }

    /* The dot style inside groups */
    .dot{ font-weight:900; font-size: clamp(2rem, 5vw, 4rem); opacity:.6; }
  </style>
</head>
<body>

<div id="playerPortal" aria-hidden="true" style="position:fixed; inset:0; background:#000; z-index:10000; display:none;"></div>

<div class="reveal">
  <div class="slides">
    <!-- Intro -->
    <section data-background-color="#DFF3E4">
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h1>Routine matinale</h1></div>
          <div class="grid-wrap" style="display:flex; align-items:center; justify-content:center; flex-direction:column;">
            <p class="note-tip">← → ↑ ↓ • <kbd>Esc</kbd> plan • <kbd>S</kbd> notes • Espace = interaction</p>
            <p class="badge" id="startDeckBtn" style="cursor:pointer; font-size:clamp(1rem,2.4vw,1.6rem);">Plein écran & commencer ➡️</p>
          </div>
        </div>
        <aside class="shell-side">
          <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
        </aside>
      </div>
    </section>

    <!-- BIG DATE (progressive: weekday → day → month) -->
    <section id="date-slide">
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h2>Date du jour</h2></div>
          <div class="grid-wrap inset" style="display:flex; align-items:center; justify-content:center; flex-direction:column; gap:1rem;">
            <div id="dateBig" class="date-giant" aria-live="polite">
              <span id="d-weekday" class="weekday reveal-step"></span>
              <span class="step-group reveal-step"><span class="dot">•</span><span id="d-day" class="day"></span></span>
              <span class="step-group reveal-step"><span class="dot">•</span><span id="d-month" class="month"></span></span>
            </div>
            <p id="dateHint" class="note-tip" aria-live="polite">Appuyez sur <kbd>Espace</kbd> pour révéler la date</p>
          </div>
        </div>
        <aside class="shell-side">
          <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
        </aside>
      </div>
    </section>

    <!-- Plan -->
    <section>
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h2>Plan du jour</h2></div>
          <div class="grid-wrap inset">
            <ul style="font-size:clamp(1.1rem,2.2vw,1.6rem); line-height:1.6;">
              <li class="fragment">Accueil &amp; météo</li>
              <li class="fragment">Choix d’activités</li>
              <li class="fragment">Pause sensorielle</li>
              <li class="fragment">Ateliers</li>
            </ul>
          </div>
        </div>
        <aside class="shell-side">
          <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
        </aside>
      </div>
    </section>

    <!-- Weather group -->
    <section>
      <section id="weather-menu" style="--title-h: 9vh;">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>Météo</h2></div>
            <div class="grid-wrap inset">
              <div id="weatherGrid" class="sized-grid" style="--rows:2; --cols:2;">
                <button class="tile" data-goto="1" aria-label="Soleil"><img src="../../images/sun.png" alt="Soleil"/></button>
                <button class="tile" data-goto="2" aria-label="Nuages"><img src="../../images/clouds.png" alt="Nuages"/></button>
                <button class="tile" data-goto="3" aria-label="Pluie"><img src="../../images/rain.png" alt="Pluie"/></button>
                <button class="tile" data-goto="4" aria-label="Neige"><img src="../../images/snow.png" alt="Neige"/></button>
              </div>
            </div>
          </div>
          <aside class="shell-side">
            <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
            <button id="remoteBtnWeather" class="side-btn" title="Demander (contrôleur)"><img src="../../images/ch.png" alt="Contrôleur"/></button>
          </aside>
        </div>
      </section>

      <section id="weather-sun">
        <div class="slide-shell">
          <div class="shell-main"><div class="title-row"><h2>☀️ Il fait soleil</h2></div><div class="grid-wrap inset" style="display:flex;align-items:center;">Prévoyez chapeau et lunettes de soleil 😎</div></div>
          <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
        </div>
      </section>
      <section id="weather-cloud">
        <div class="slide-shell">
          <div class="shell-main"><div class="title-row"><h2>☁️ Ciel nuageux</h2></div><div class="grid-wrap inset" style="display:flex;align-items:center;">Temps gris, mais parfait pour une promenade rapide.</div></div>
          <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
        </div>
      </section>
      <section id="weather-rain">
        <div class="slide-shell">
          <div class="shell-main"><div class="title-row"><h2>🌧️ Il pleut</h2></div><div class="grid-wrap inset" style="display:flex;align-items:center;">Parapluie conseillé !</div></div>
          <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
        </div>
      </section>
      <section id="weather-snow">
        <div class="slide-shell">
          <div class="shell-main"><div class="title-row"><h2>❄️ Il neige</h2></div><div class="grid-wrap inset" style="display:flex;align-items:center;">On s’habille chaudement, bottes et gants !</div></div>
          <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
        </div>
      </section>

      <section id="slide-game" class="vid-slide">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>Activité intégrée</h2></div>
            <div class="grid-wrap inset">
              <div class="vid-wrap">
                <div class="note-tip" id="overlayHint" style="position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.45);color:#fff;padding:.35em .6em;border-radius:8px;">Astuce: ⛶ pour plein écran</div>
                <iframe id="gameFrame" src="../../gaming/cloud/index.html?requiredPresses=5" title="Activité intégrée"
                        allow="autoplay; fullscreen; clipboard-read; clipboard-write; gamepad; accelerometer; gyroscope"
                        style="position:absolute;inset:0;width:100%;height:100%;border:0;background:#000" allowfullscreen referrerpolicy="no-referrer"></iframe>
              </div>
            </div>
          </div>
          <aside class="shell-side">
            <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
          </aside>
        </div>
      </section>
    </section>

    <!-- Branching videos -->
    <section id="branch-group">
      <section id="branch-root">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>Choisis une activité vidéo</h2></div>
            <div class="grid-wrap inset" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;align-content:start;">
              <button class="badge" id="localOpt1" style="padding:1rem;font-size:1.05rem;">🎵 Slippery Fish (local)</button>
              <button class="badge" id="localOpt2" style="padding:1rem;font-size:1.05rem;">🥁 Africa (local)</button>
              <div id="remoteStatus" class="note-tip" aria-live="polite" style="grid-column:1/-1;margin-top:.75rem;"></div>
            </div>
          </div>
          <aside class="shell-side">
            <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
            <button id="remoteBtnVideos" class="side-btn" title="Demander (contrôleur)"><img src="../../images/ch.png" alt="Contrôleur"/></button>
          </aside>
        </div>
      </section>

      <section id="video1" class="vid-slide"><div class="vid-wrap"><div id="overlay1" class="vid-overlay">Cliquez pour lancer en plein écran — appuyez sur <b>Q</b> pour quitter</div><video id="vid1" class="vid" preload="auto" playsinline></video></div></section>
      <section id="video2" class="vid-slide"><div class="vid-wrap"><div id="overlay2" class="vid-overlay">Cliquez pour lancer en plein écran — appuyez sur <b>Q</b> pour quitter</div><video id="vid2" class="vid" preload="auto" playsinline></video></div></section>
    </section>

    <!-- Drag & transfer -->
    <section id="drag-transfer">
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h2>Choisis et déplace les images</h2></div>
          <div class="grid-wrap inset">
            <div class="transfer-controls">
              <button id="resetTransfer" class="btn">Réinitialiser</button>
            </div>
            <div class="transfer-wrap">
              <div id="bin-left"  class="bin" aria-label="Colonne gauche (source)"></div>
              <div id="bin-right" class="bin" aria-label="Colonne droite (cible)"></div>
            </div>
          </div>
        </div>
        <aside class="shell-side">
          <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
        </aside>
      </div>
    </section>

    <!-- Code -->
    <section>
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h2>Extrait de code</h2></div>
          <div class="grid-wrap inset">
            <pre><code class="language-js">
function startMorningRoutine(){["Météo","Choix","Pause","Ateliers"].forEach((s,i)=>console.log(`#${i+1}:`,s));}
startMorningRoutine();
            </code></pre>
          </div>
        </div>
        <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
      </div>
    </section>

    <!-- End -->
    <section data-background-color="#ADF1D2">
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h2>Merci!</h2></div>
          <div class="grid-wrap inset" style="display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1rem;">
            <p>Docs Reveal.js : <a href="https://revealjs.com" target="_blank" rel="noreferrer">revealjs.com</a></p>
            <p class="note-tip">Impression PDF : ajoutez <code>?print-pdf</code> à l’URL.</p>
          </div>
        </div>
        <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/markdown/marked.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/notes/notes.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/highlight.js"></script>
<script>
  const qs = new URL(location.href).searchParams;
  const room = qs.get('room') || 'test';
  const WS_URL = `wss://ws-relay.gui98789.workers.dev/ws/${encodeURIComponent(room)}`;
  const deckTitle = 'Routine matinale';
  const KNOWN_VIDEOS = { v1: 'https://bucket.adaptatech.org/amyliz-slipperyfish.mp4', v2: 'https://bucket.adaptatech.org/africa.mp4' };
  const PICTO_SRC = '../../images/pictos/';
  const TRANSFER_PICTOS = ['apple.png','banana.png','basketball.png','boat.png','book.png','brush.png','bowl.png','broccoli.png'];

  Reveal.initialize({
    disableLayout: true,
    hash: true, slideNumber: true, controls: true, progress: true,
    center: false, history: true, transition: 'slide',
    keyboard: { 32: null }, // keep Space free for our custom handler
    plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
  });

  // Start button
  document.getElementById("startDeckBtn").addEventListener("click", async ()=>{
    try { if (!document.fullscreenElement) await document.documentElement.requestFullscreen(); } catch {}
    Reveal.next();
  });

  // Weather buttons
  document.querySelectorAll('#weatherGrid .tile[data-goto]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const v = parseInt(btn.dataset.goto,10) || 0;
      const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
      const sun = document.getElementById('weather-sun');
      const h = sun ? sections.findIndex(s => s.contains(sun)) : 0;
      if (h >= 0) Reveal.slide(h, v);
    });
  });

  // Game fullscreen handling
  const gameFrame=document.getElementById('gameFrame');
  const overlayHint=document.getElementById('overlayHint');
  function callGame(fnName, ...args){ try{ const cw=gameFrame?.contentWindow; if(cw && typeof cw[fnName]==='function') cw[fnName](...args);}catch{} }
  function enterGameMode(){
    document.body.classList.add('immersive');
    callGame('ADAPTATECH_game_onResume');
    if(gameFrame?.requestFullscreen){
      gameFrame.requestFullscreen().then(()=>{ overlayHint.style.display='none'; }).catch(()=>{ overlayHint.style.display=''; });
    }
  }
  function exitGameMode(){
    document.body.classList.remove('immersive');
    callGame('ADAPTATECH_game_onPause');
    if(document.fullscreenElement===gameFrame) document.exitFullscreen().catch(()=>{});
  }
  window.ADAPTATECH_exitAndNext=async function(){
    exitGameMode();
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else if(document.fullscreenElement!==document.documentElement){ await document.exitFullscreen(); await document.documentElement.requestFullscreen(); }
    }catch{}
    Reveal.next();
  };
  Reveal.on('slidechanged',(evt)=>{
    const now=evt.currentSlide, prev=evt.previousSlide;
    if(now && now.id==='slide-game') enterGameMode();
    else if(prev && prev.id==='slide-game') exitGameMode();
  });

  // Video logic
  const remoteStatus = document.getElementById('remoteStatus');
  const videoElems = { v1: document.getElementById('vid1'), v2: document.getElementById('vid2') };
  const overlays  = { v1: document.getElementById('overlay1'), v2: document.getElementById('overlay2') };
  const portal = document.getElementById('playerPortal');
  const placeholders = { v1: videoElems.v1?.parentElement, v2: videoElems.v2?.parentElement };
  let inputsLocked=false, currentVidKey=null, stickRAF=null, stickTarget=null;
  const blockKeys=new Set([' ','Spacebar','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','PageUp','PageDown','Home','End','Escape','Tab']);

  function onKeyCapture(e){
    if (!inputsLocked) return;
    if (e.key === 'q' || e.key === 'Q'){ e.preventDefault(); e.stopImmediatePropagation(); stopCurrentVideoAndReturn(branchHIndex()); return; }
    if (blockKeys.has(e.key)) { e.preventDefault(); e.stopImmediatePropagation(); }
  }
  function onWheelCapture(e){ if(inputsLocked){ e.preventDefault(); e.stopImmediatePropagation(); } }
  function onTouchMoveCapture(e){ if(inputsLocked){ e.preventDefault(); e.stopImmediatePropagation(); } }
  function onPointerDownCapture(e){
    if (!inputsLocked) return;
    if (e.target.closest('video') || e.target.closest('.vid-overlay')) return;
    e.preventDefault(); e.stopImmediatePropagation();
  }
  function lockDeckInputs(){
    inputsLocked=true;
    Reveal.configure({ keyboard:false, touch:false, controls:false, overview:false });
    window.addEventListener('keydown', onKeyCapture, true);
    window.addEventListener('keyup', onKeyCapture, true);
    window.addEventListener('wheel', onWheelCapture, {capture:true, passive:false});
    window.addEventListener('touchmove', onTouchMoveCapture, {capture:true, passive:false});
    window.addEventListener('pointerdown', onPointerDownCapture, true);
  }
  function unlockDeckInputs(){
    inputsLocked=false;
    Reveal.configure({ keyboard:true, touch:true, controls:true, overview:true });
    window.removeEventListener('keydown', onKeyCapture, true);
    window.removeEventListener('keyup', onKeyCapture, true);
    window.removeEventListener('wheel', onWheelCapture, true);
    window.removeEventListener('touchmove', onTouchMoveCapture, true);
    window.removeEventListener('pointerdown', onPointerDownCapture, true);
    stopStickToSlide();
  }
  function branchHIndex(){
    const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
    return sections.findIndex(s => s.id === 'branch-group');
  }
  async function enterFullscreen(el){ try{ if(el?.requestFullscreen) await el.requestFullscreen(); }catch{} }
  async function exitFullscreenIfOwned(el){ try{ if(document.fullscreenElement===el) await document.exitFullscreen(); }catch{} }
  function startStickToSlide(h, v){
    stickTarget = {h, v};
    const tick = ()=>{
      if (!inputsLocked || !stickTarget) return;
      const cur = Reveal.getIndices();
      if (cur.h !== stickTarget.h || cur.v !== stickTarget.v) Reveal.slide(stickTarget.h, stickTarget.v);
      stickRAF = requestAnimationFrame(tick);
    };
    stopStickToSlide(); stickRAF = requestAnimationFrame(tick);
  }
  function stopStickToSlide(){ if (stickRAF) cancelAnimationFrame(stickRAF); stickRAF = null; stickTarget = null; }
  function usePortal(key){
    const vid = videoElems[key];
    if (!portal.contains(vid)) portal.appendChild(vid);
    portal.style.display = 'block'; portal.setAttribute('aria-hidden','false');
  }
  function restoreFromPortal(key){
    const vid = videoElems[key]; const wrap = placeholders[key];
    if (wrap && !wrap.contains(vid)) wrap.appendChild(vid);
    portal.style.display = 'none'; portal.setAttribute('aria-hidden','true');
  }
  async function playVideoUnderBranch(key, url, {forcePortal=false}={}){
    const h = branchHIndex(); if(h < 0) return;
    const vid = videoElems[key]; const other = videoElems[key === 'v1' ? 'v2' : 'v1'];
    try { other.pause(); } catch {}
    vid.src = url || KNOWN_VIDEOS[key]; vid.currentTime = 0;
    lockDeckInputs();
    const vIndex = (key === 'v1') ? 1 : 2;
    Reveal.slide(h, vIndex); startStickToSlide(h, vIndex);
    await new Promise(r => requestAnimationFrame(r)); try { vid.load(); } catch {}
    currentVidKey = key; const overlay = overlays[key];
    const tryNative = async ()=>{ try { await enterFullscreen(vid); await vid.play(); if(overlay) overlay.style.display='none'; return true; } catch { return false; } };
    const startInPortal = async ()=>{ usePortal(key); await new Promise(r => setTimeout(r, 0)); try { await vid.play(); } catch {} };
    if (forcePortal) { await startInPortal(); }
    else {
      const ok = await tryNative();
      if (!ok){
        if (overlay){ overlay.textContent = 'Cliquez pour lancer la vidéo (plein écran) — appuyez sur Q pour quitter'; overlay.style.display = 'block'; }
        const onFirstPointer = async ()=>{ overlay?.removeEventListener('pointerup', onFirstPointer); vid.removeEventListener('pointerup', onFirstPointer); if (!(await tryNative())) { await startInPortal(); if (overlay) overlay.style.display='none'; } };
        overlay?.addEventListener('pointerup', onFirstPointer, { once:true });
        vid.addEventListener('pointerup', onFirstPointer, { once:true });
        setTimeout(async ()=>{ if (inputsLocked && currentVidKey === key && !document.fullscreenElement) { await startInPortal(); if (overlay) overlay.style.display='none'; } }, 100);
      }
    }
  }
  async function stopCurrentVideoAndReturn(targetH = branchHIndex()){
    stopStickToSlide();
    if(currentVidKey){
      const vid = videoElems[currentVidKey];
      try { await exitFullscreenIfOwned(vid); } catch {}
      try { vid.pause(); } catch {}
      try { vid.removeAttribute('src'); } catch {}
      try { vid.src = ''; vid.load(); vid.currentTime = 0; } catch {}
      restoreFromPortal(currentVidKey);
    }
    if (typeof targetH === 'number' && targetH >= 0){ Reveal.slide(targetH, 0); }
    else { const h = branchHIndex(); if (h >= 0) Reveal.slide(h, 0); }
    currentVidKey = null; unlockDeckInputs(); if(remoteStatus) remoteStatus.textContent = '';
  }
  document.getElementById('localOpt1')?.addEventListener('click', ()=> playVideoUnderBranch('v1', KNOWN_VIDEOS.v1, {forcePortal:false}));
  document.getElementById('localOpt2')?.addEventListener('click', ()=> playVideoUnderBranch('v2', KNOWN_VIDEOS.v2, {forcePortal:false}));
  videoElems.v1.addEventListener('ended', ()=> stopCurrentVideoAndReturn(branchHIndex()));
  videoElems.v2.addEventListener('ended', ()=> stopCurrentVideoAndReturn(branchHIndex()));
  videoElems.v1.addEventListener('pause', ()=>{ if(inputsLocked && !videoElems.v1.ended) videoElems.v1.play().catch(()=>{}); });
  videoElems.v2.addEventListener('pause', ()=>{ if (inputsLocked && !videoElems.v2.ended) videoElems.v2.play().catch(()=>{}); });
  document.addEventListener('fullscreenchange', async ()=>{
    if(!inputsLocked || !currentVidKey) return;
    const vid = videoElems[currentVidKey]; const overlay = overlays[currentVidKey];
    if(!document.fullscreenElement && !vid.ended){
      try { await enterFullscreen(vid); if(overlay) overlay.style.display='none'; }
      catch { usePortal(currentVidKey); if(overlay){ overlay.textContent='Cliquez pour reprendre — Q pour quitter'; overlay.style.display='none'; } }
    }
  });

  // WebSocket remote
  const remoteBtnWeather = document.getElementById('remoteBtnWeather');
  const remoteBtnVideos  = document.getElementById('remoteBtnVideos');
  let WS=null, hbInterval=null, watchdogInterval=null, lastActivity=0, backoffMs=1000, reconnectTimer=null, connecting=false;
  let lastPending=null;
  function setRemoteStatus(txt){ if(remoteStatus) remoteStatus.textContent = txt || ''; }
  function clearWsTimers(){ if(hbInterval){clearInterval(hbInterval); hbInterval=null;} if(watchdogInterval){clearInterval(watchdogInterval); watchdogInterval=null;} if(reconnectTimer){clearTimeout(reconnectTimer); reconnectTimer=null;} }
  function scheduleReconnect(){ if(connecting) return; if(reconnectTimer) return; reconnectTimer=setTimeout(()=>{reconnectTimer=null;connectWS();}, backoffMs); backoffMs=Math.min(backoffMs*2,15000); }
  function wsSend(obj){ const payload=JSON.stringify(obj); if(WS && WS.readyState===1) WS.send(payload); else if(WS) WS.addEventListener('open', ()=> WS.send(payload), {once:true}); }
  function connectWS(){
    if (connecting) return; connecting=true;
    try { WS = new WebSocket(WS_URL); } catch { connecting=false; scheduleReconnect(); return; }
    WS.onopen = ()=>{ connecting=false; lastActivity=Date.now(); clearWsTimers(); setRemoteStatus('Connecté au canal '+room);
      wsSend({ type:'hello', role:'slides', deckTitle });
      hbInterval=setInterval(()=>{ try{ WS.readyState===1 && WS.send(JSON.stringify({type:'ping'})); lastActivity=Date.now(); }catch{} }, 20000);
      if (lastPending) setTimeout(()=> wsSend(lastPending.msg), 200);
      backoffMs=1000;
    };
    WS.onmessage = (e)=>{
      lastActivity=Date.now(); let msg; try{ msg=JSON.parse(e.data);}catch{return;}
      if (msg.type==='ping'){ try{ WS.send(JSON.stringify({type:'pong'})); }catch{} return; }
      if (msg.type==='play_video' && msg.url){ setRemoteStatus('Commande reçue : lecture…'); const key = msg.url.includes('africa') ? 'v2' : 'v1'; playVideoUnderBranch(key, msg.url, {forcePortal:true}); return; }
      if (msg.type==='stop_video'){ stopCurrentVideoAndReturn(branchHIndex()); return; }
      if (msg.type==='weather_choice'){
        const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
        const sun = document.getElementById('weather-sun'); const h = sun ? sections.findIndex(s => s.contains(sun)) : 0;
        const map = { sun:1, cloud:2, rain:3, snow:4 }; const v = map[String(msg.key||'').toLowerCase()] ?? 0;
        Reveal.slide(h, v); if (lastPending?.kind==='weather') lastPending=null; return;
      }
    };
    WS.onerror = ()=> setRemoteStatus('Erreur WebSocket');
    WS.onclose  = ()=>{ clearWsTimers(); setRemoteStatus('WebSocket fermé'); connecting=false; scheduleReconnect(); };
    watchdogInterval=setInterval(()=>{ if(Date.now()-lastActivity>60000){ try{ WS.close(); }catch{} } }, 5000);
  }
  connectWS();
  window.addEventListener('online', ()=>{ if(!WS || WS.readyState !== 1) connectWS(); });
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden && (!WS || WS.readyState !== 1)) connectWS(); });

  function weatherHIndex(){
    const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
    const sun = document.getElementById('weather-sun');
    return sun ? sections.findIndex(s => s.contains(sun)) : 0;
  }
  function sendWeatherRequest(){
    const h = weatherHIndex();
    const msg = { type:'request_weather', from:'slides', deckTitle,
      options:[
        { title:'Soleil', key:'sun',   thumb:'../../images/sun.png',    goto:{h, v:1} },
        { title:'Nuages', key:'cloud', thumb:'../../images/clouds.png', goto:{h, v:2} },
        { title:'Pluie',  key:'rain',  thumb:'../../images/rain.png',   goto:{h, v:3} },
        { title:'Neige',  key:'snow',  thumb:'../../images/snow.png',   goto:{h, v:4} }
      ],
      note:'Choisir la météo' };
    lastPending = { kind:'weather', msg }; wsSend(msg);
    if (h >= 0) Reveal.slide(h, 0);
  }
  function sendVideoRequest(){
    const msg = {
      type: 'request_video',
      from: 'slides',
      deckTitle,
      options: [
        { title:'Slippery Fish', url: KNOWN_VIDEOS.v1, thumb: '../../images/binou.png' },
        { title:'Africa',        url: KNOWN_VIDEOS.v2, thumb: '../../images/africa-image.png' }
      ],
      note: 'Veuillez choisir une vidéo à lancer.'
    };
    lastPending = { kind:'video', msg };
    wsSend(msg);
    setRemoteStatus('Demande envoyée. En attente du choix distant…');
  }
  document.getElementById('remoteBtnWeather')?.addEventListener('click', sendWeatherRequest);
  document.getElementById('remoteBtnVideos')?.addEventListener('click', sendVideoRequest);

  // Hotkeys Q (top of stack) & R (first slide)
  (function enableHotkeys(){
    const isTyping = (el) => el && (el.closest && el.closest('input, textarea, select, [contenteditable="true"]'));
    window.addEventListener('keydown', (e) => {
      if (typeof inputsLocked !== 'undefined' && inputsLocked) return;
      if (isTyping(e.target)) return;
      if (Reveal.isOverview && Reveal.isOverview()) return;
      if (e.key === 'q' || e.key === 'Q') {
        const idx = Reveal.getIndices && Reveal.getIndices();
        if (idx && Number.isInteger(idx.h)) { e.preventDefault(); e.stopImmediatePropagation(); Reveal.slide(idx.h, 0); }
      } else if (e.key === 'r' || e.key === 'R') {
        e.preventDefault(); e.stopImmediatePropagation(); Reveal.slide(0, 0);
      }
    }, true);
  })();

  // Drag & transfer setup
  let transferInitialized = false;
  function setupTransfer(){
    if (transferInitialized) return;
    transferInitialized = true;

    const left  = document.getElementById('bin-left');
    const right = document.getElementById('bin-right');
    const resetBtn = document.getElementById('resetTransfer');

    function createItem(name){
      const btn = document.createElement('button');
      btn.className = 'draggable';
      btn.setAttribute('draggable','true');
      btn.setAttribute('aria-label', name.replace('.png',''));
      btn.dataset.name = name;

      const img = new Image();
      img.src = PICTO_SRC + name;
      img.alt = name.replace('.png','');
      btn.appendChild(img);

      btn.addEventListener('dragstart', (e)=>{
        e.dataTransfer.setData('text/plain', name);
        e.dataTransfer.effectAllowed = 'move';
        btn.classList.add('dragging');
      });
      btn.addEventListener('dragend', ()=> btn.classList.remove('dragging'));
      btn.addEventListener('click', ()=>{
        const parent = btn.parentElement?.id === 'bin-left' ? right : left;
        parent.appendChild(btn);
      });

      return btn;
    }

    left.innerHTML = ''; right.innerHTML = '';
    TRANSFER_PICTOS.forEach(n => left.appendChild(createItem(n)));

    function bindDnD(bin){
      bin.addEventListener('dragover', (e)=>{ e.preventDefault(); bin.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
      bin.addEventListener('dragleave', ()=> bin.classList.remove('drag-over'));
      bin.addEventListener('drop', (e)=>{
        e.preventDefault(); bin.classList.remove('drag-over');
        const dragging = document.querySelector('.draggable.dragging');
        if (dragging) { bin.appendChild(dragging); dragging.classList.remove('dragging'); }
      });
    }
    bindDnD(left); bindDnD(right);

    resetBtn?.addEventListener('click', ()=>{
      const items = Array.from(right.querySelectorAll('.draggable'));
      items.forEach(el => left.appendChild(el));
      const order = new Map(TRANSFER_PICTOS.map((n,i)=>[n,i]));
      const children = Array.from(left.querySelectorAll('.draggable'));
      children.sort((a,b)=> (order.get(a.dataset.name)||0) - (order.get(b.dataset.name)||0));
      children.forEach(el => left.appendChild(el));
    });
  }

  Reveal.on('slidechanged', (e)=>{
    if (e.currentSlide && e.currentSlide.id === 'drag-transfer') setupTransfer();
  });
  Reveal.on('ready', ()=>{
    const cur = Reveal.getCurrentSlide();
    if (cur && cur.id === 'drag-transfer') setupTransfer();
    if (window.hljs) hljs.highlightAll();
  });

  // BIG DATE: render + progressive reveal (Space/Enter)
  (function setupBigDate(){
    const dateSlide = document.getElementById('date-slide');
    const elWeekday = document.getElementById('d-weekday');
    const elDay     = document.getElementById('d-day');
    const elMonth   = document.getElementById('d-month');
    const steps     = Array.from(document.querySelectorAll('#dateBig .reveal-step'));
    const hintEl    = document.getElementById('dateHint');
    let dateProgress = 0;

    const cap = (s)=> s ? s.charAt(0).toUpperCase() + s.slice(1) : s;

    function render(){
      const now     = new Date();
      const weekday = new Intl.DateTimeFormat('fr-CA', { weekday:'long' }).format(now);
      const day     = new Intl.DateTimeFormat('fr-CA', { day:'2-digit' }).format(now);
      const month   = new Intl.DateTimeFormat('fr-CA', { month:'long' }).format(now);

      if (elWeekday) elWeekday.textContent = cap(weekday);
      if (elDay)     elDay.textContent     = day;
      if (elMonth)   elMonth.textContent   = month.toLowerCase();
    }

    function updateHint(){
      if (!hintEl) return;
      if (dateProgress >= steps.length){
        hintEl.textContent = 'Appuyez sur Espace pour passer à la suite';
        hintEl.style.opacity = '0.75';
      } else {
        hintEl.textContent = 'Appuyez sur Espace pour révéler la date';
        hintEl.style.opacity = '1';
      }
    }

    function resetDateReveal(){
      dateProgress = 0;
      steps.forEach(s => s.classList.remove('show'));
      updateHint();
    }

    function isOnDateSlide(){
      const cur = Reveal.getCurrentSlide?.();
      return !!cur && cur.id === 'date-slide';
    }

    function revealNext(){
      if (dateProgress < steps.length){
        steps[dateProgress].classList.add('show');
        dateProgress++;
        updateHint();
      } else {
        // all revealed ⇒ advance deck
        Reveal.next();
      }
    }

    // Render on deck ready and when coming back from background
    Reveal.on('ready', ()=>{ render(); if (isOnDateSlide()) resetDateReveal(); });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ render(); if (isOnDateSlide()) resetDateReveal(); } });

    // Reset when entering/leaving the date slide
    Reveal.on('slidechanged', (e)=>{
      if (e.currentSlide && e.currentSlide.id === 'date-slide'){
        render();
        resetDateReveal();
      }
    });

    // Capture Space / Enter to reveal progressively when on date slide
    const isTyping = (el) => el && (el.closest && el.closest('input, textarea, select, [contenteditable="true"]'));
    window.addEventListener('keydown', (e)=>{
      if (typeof inputsLocked !== 'undefined' && inputsLocked) return;
      if (!isOnDateSlide()) return;
      if (isTyping(e.target)) return;

      if (e.key === ' ' || e.key === 'Spacebar' || e.key === 'Enter'){
        e.preventDefault();
        e.stopImmediatePropagation();
        revealNext();
      }
    }, true);
  })();
</script>
</body>
</html>
