<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="../images/binou.png">
  <link rel="stylesheet" href="../css/ipadteachh.css">
  <link rel="stylesheet" href="css/sensorial-base.css">
  <title>Associer aux ombres</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; font-family: 'Poppins', 'Segoe UI', sans-serif; }

    #activityNumberOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.85);
      color: #fff;
      font-size: clamp(4rem, 12vw, 9rem);
      z-index: 1000;
    }
    #activityNumberOverlay .number-text { font-weight: 700; }

    .game-container {
      display: none;
      width: 100%;
      height: 100%;
      padding: clamp(20px, 4vh, 36px);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(232, 242, 255, 0.9));
      border-radius: clamp(18px, 2.6vw, 28px);
      box-shadow: inset 0 0 0 1px rgba(15, 30, 60, 0.08);
      display: flex;
      flex-direction: column;
      gap: clamp(20px, 4vh, 32px);
    }

    .shadow-layout {
      flex: 1 1 auto;
      min-height: 0;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: clamp(20px, 4vw, 36px);
      align-items: stretch;
    }

    .shadow-board,
    .shadow-pieces {
      background: rgba(255, 255, 255, 0.92);
      border-radius: clamp(16px, 3vw, 26px);
      padding: clamp(18px, 3vh, 26px);
      box-shadow: inset 0 0 0 1px rgba(15, 30, 60, 0.07);
      display: grid;
      gap: clamp(18px, 3vh, 26px);
      align-content: start;
      justify-items: center;
      grid-auto-rows: minmax(clamp(150px, 22vh, 240px), auto);
      overflow-y: auto;
    }

    .shadow-board {
      grid-template-columns: repeat(auto-fit, minmax(clamp(180px, 22vw, 260px), 1fr));
    }

    .shadow-pieces {
      grid-template-columns: repeat(auto-fit, minmax(clamp(150px, 20vw, 210px), 1fr));
    }

    .shadow-slot {
      position: relative;
      width: 100%;
      min-height: clamp(170px, 28vh, 260px);
      border-radius: clamp(18px, 3vw, 26px);
      border: 3px dashed rgba(30, 64, 175, 0.38);
      background: rgba(148, 163, 184, 0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(12px, 3vh, 24px);
      transition: border-color 0.2s ease, transform 0.2s ease;
      cursor: pointer;
    }

    .shadow-slot::before {
      content: '';
      position: absolute;
      inset: clamp(16px, 3vh, 26px);
      background: center / contain no-repeat var(--shadow-image);
      filter: brightness(0) contrast(1.35) opacity(0.9);
      transition: opacity 0.3s ease;
    }

    .shadow-slot:focus,
    .shadow-slot:hover,
    .shadow-slot.is-target {
      outline: none;
      border-color: rgba(30, 64, 175, 0.75);
      transform: translateY(-4px);
    }

    .shadow-slot.needs-token {
      border-color: #f59e0b;
    }

    .shadow-slot.is-incorrect {
      border-color: #dc2626;
      animation: shake 0.35s ease;
    }

    .shadow-slot.is-correct {
      border-style: solid;
      border-color: #16a34a;
      background: rgba(34, 197, 94, 0.12);
    }

    .shadow-slot.is-correct::before {
      opacity: 0;
    }

    .shadow-slot .placed-image {
      position: relative;
      width: clamp(120px, 20vw, 220px);
      max-height: clamp(160px, 24vh, 220px);
      object-fit: contain;
      pointer-events: none;
      z-index: 2;
    }

    .shadow-token {
      width: 100%;
      min-height: clamp(150px, 24vh, 220px);
      border-radius: clamp(16px, 3vw, 24px);
      border: 3px solid transparent;
      background: #fff;
      box-shadow: 0 18px 32px rgba(15, 30, 60, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(12px, 2.4vh, 20px);
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      touch-action: manipulation;
      user-select: none;
      position: relative;
    }

    .shadow-token img {
      width: clamp(110px, 18vw, 200px);
      max-height: clamp(140px, 22vh, 210px);
      object-fit: contain;
      pointer-events: none;
    }

    .shadow-token:focus,
    .shadow-token:hover,
    .shadow-token.is-selected {
      outline: none;
      border-color: rgba(28, 140, 214, 0.7);
      transform: translateY(-4px);
    }

    .shadow-token.is-placed {
      opacity: 0.55;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .shadow-token.is-incorrect {
      border-color: #dc2626;
      animation: shake 0.35s ease;
    }

    .shadow-token.is-correct {
      border-color: #16a34a;
    }

    .shadow-instruction {
      font-size: clamp(1rem, 1.8vw, 1.25rem);
      color: #475569;
      text-align: center;
      margin: 0;
    }

    .shadow-status {
      min-height: clamp(28px, 4vh, 36px);
      font-size: clamp(1.05rem, 2vw, 1.3rem);
      font-weight: 600;
      color: #0f172a;
      text-align: center;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    @media (max-width: 1200px) {
      .shadow-layout {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1.1fr);
      }
    }

    @media (max-width: 980px) {
      .shadow-layout {
        grid-template-columns: 1fr;
      }
      .shadow-board,
      .shadow-pieces {
        grid-template-columns: repeat(auto-fit, minmax(clamp(160px, 42vw, 240px), 1fr));
      }
    }

    @media (max-height: 820px) {
      .shadow-slot {
        min-height: clamp(150px, 26vh, 220px);
      }
      .shadow-token {
        min-height: clamp(140px, 22vh, 200px);
      }
      .shadow-token img {
        max-height: clamp(120px, 20vh, 190px);
      }
    }
  </style>
</head>
<body class="sensorial-game">
  <div id="activityNumberOverlay" role="presentation">
    <div class="number-text"></div>
  </div>
  <div class="sensorial-shell">
    <header class="sensorial-header">
      <div class="sensorial-header-main">
        <h1 class="sensorial-title">Associer aux ombres</h1>
        <div class="sensorial-activity-marker" role="group" aria-label="Activité en cours">
          <img src="../images/plasticbasket.png" alt="" />
          <span class="sensorial-activity-number">–</span>
        </div>
      </div>
      <p class="sensorial-subtitle">Sélectionne une image puis la silhouette qui lui correspond.</p>
    </header>
    <main class="sensorial-content">
      <div class="game-container" id="shadowGame" aria-live="polite">
        <div class="shadow-layout">
          <section class="shadow-board" id="shadowBoard" aria-label="Ombres à compléter"></section>
          <section class="shadow-pieces" id="shadowPieces" aria-label="Images à placer"></section>
        </div>
        <p class="shadow-instruction">Tape sur une image pour la sélectionner, puis sur l’ombre correspondante.</p>
        <p class="shadow-status" id="shadowStatus" aria-live="assertive"></p>
      </div>
    </main>
  </div>
  <audio id="error-sound" src="" preload="auto"></audio>
  <audio id="word-reward-sound" src="" preload="auto"></audio>
  <audio id="final-reward-sound" src="" preload="auto"></audio>
  <script src="../js/themes.js"></script>
  <script src="js/games-config.js"></script>
  <script src="js/session-helpers.js"></script>
  <script src="js/reinforcer-overlay.js"></script>
  <script src="js/fullscreen.js"></script>
  <script>
    (function () {
      'use strict';

      let session = null;
      let themeData = {};
      let reinforcerController = null;
      let reinforcerType = 'shortvideo';
      let targetCount = 3;
      let remainingMatches = 0;
      let activeToken = null;

      const boardEl = document.getElementById('shadowBoard');
      const piecesEl = document.getElementById('shadowPieces');
      const statusEl = document.getElementById('shadowStatus');
      const gameContainer = document.getElementById('shadowGame');

      document.addEventListener('DOMContentLoaded', () => {
        session = sessionHelpers.ensureCurrentGame('shadow-match');
        if (!session) { return; }

        sessionHelpers.updateActivityMarker(session);

        themeData = session.themeData || {};
        reinforcerType = (session.selections && session.selections.reinforcerType) || 'shortvideo';

        document.getElementById('error-sound').src = themeData.errorSound || '../sounds/error.mp3';
        document.getElementById('word-reward-sound').src = themeData.reinforcerSound || '../sounds/success3.mp3';
        document.getElementById('final-reward-sound').src = themeData.finalRewardSound || '../sounds/victory.mp3';

        const options = sessionHelpers.getCurrentGameOptions(session);
        const parsedCount = parseInt(options.pairCount, 10);
        if (Number.isFinite(parsedCount)) {
          targetCount = Math.min(Math.max(parsedCount, 2), 6);
        }

        reinforcerController = sessionHelpers.setupSharedReinforcer(session, {
          reinforcerType,
          onAdvance: sessionHelpers.advanceToNextGame
        });

        sessionHelpers.showActivityOverlay(() => {
          gameContainer.style.display = 'flex';
          startGame();
        }, session);
      });

      function startGame() {
        const images = pickImages(targetCount);
        remainingMatches = images.length;
        statusEl.textContent = '';
        renderBoard(images);
        renderPieces(images);
      }

      function pickImages(count) {
        let pool = [];
        if (Array.isArray(themeData.transparentPNGs) && themeData.transparentPNGs.length > 0) {
          pool = themeData.transparentPNGs.slice();
        } else if (Array.isArray(themeData.images) && themeData.images.length > 0) {
          pool = themeData.images.slice();
        }
        if (pool.length === 0) {
          pool = ['../images/binou.png'];
        }
        const shuffled = shuffleArray(pool.slice());
        if (shuffled.length < count) {
          return shuffled;
        }
        return shuffled.slice(0, count);
      }

      function renderBoard(images) {
        boardEl.innerHTML = '';
        images.forEach((src, index) => {
          const slot = document.createElement('div');
          slot.className = 'shadow-slot';
          slot.style.setProperty('--shadow-image', `url("${src}")`);
          slot.dataset.target = src;
          slot.setAttribute('tabindex', '0');
          slot.setAttribute('role', 'button');
          slot.setAttribute('aria-label', `Ombre ${index + 1}`);

          slot.addEventListener('click', () => tryPlace(slot));
          slot.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              tryPlace(slot);
            }
          });

          boardEl.appendChild(slot);
        });
      }

      function renderPieces(images) {
        piecesEl.innerHTML = '';
        const shuffledPieces = shuffleArray(images.slice());
        shuffledPieces.forEach((src, index) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'shadow-token';
          button.dataset.image = src;
          button.setAttribute('aria-label', `Image ${index + 1}`);
          button.setAttribute('aria-pressed', 'false');

          const img = document.createElement('img');
          img.src = src;
          img.alt = '';
          button.appendChild(img);

          button.addEventListener('click', () => setActiveToken(button));
          button.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              setActiveToken(button);
            }
          });

          piecesEl.appendChild(button);
        });
      }

      function setActiveToken(button) {
        if (!button || button.dataset.locked === 'true') {
          return;
        }
        if (activeToken === button) {
          button.classList.remove('is-selected');
          button.setAttribute('aria-pressed', 'false');
          activeToken = null;
          statusEl.textContent = '';
          return;
        }
        if (activeToken) {
          activeToken.classList.remove('is-selected');
          activeToken.setAttribute('aria-pressed', 'false');
        }
        activeToken = button;
        activeToken.classList.add('is-selected');
        activeToken.setAttribute('aria-pressed', 'true');
        statusEl.textContent = 'Choisis maintenant l’ombre correspondante.';
      }

      function tryPlace(slot) {
        if (slot.dataset.filled === 'true') {
          statusEl.textContent = 'Cette ombre est déjà complétée.';
          return;
        }
        if (!activeToken) {
          statusEl.textContent = 'Sélectionne d’abord une image.';
          slot.classList.add('needs-token');
          setTimeout(() => slot.classList.remove('needs-token'), 550);
          return;
        }

        const expected = slot.dataset.target;
        const candidate = activeToken.dataset.image;
        if (expected === candidate) {
          slot.dataset.filled = 'true';
          slot.classList.add('is-correct');
          activeToken.classList.add('is-correct', 'is-placed');
          activeToken.dataset.locked = 'true';
          activeToken.disabled = true;
          activeToken.classList.remove('is-selected');
          activeToken.setAttribute('aria-pressed', 'true');

          const clone = activeToken.querySelector('img').cloneNode(true);
          clone.classList.add('placed-image');
          slot.appendChild(clone);

          playSound('word-reward-sound');
          remainingMatches -= 1;
          activeToken = null;
          statusEl.textContent = remainingMatches === 0
            ? 'Bravo ! Toutes les ombres sont complétées.'
            : 'Super ! Continue avec les autres ombres.';

          if (remainingMatches === 0) {
            setTimeout(finishGame, 900);
          }
        } else {
          slot.classList.add('is-incorrect');
          activeToken.classList.add('is-incorrect');
          playSound('error-sound');
          statusEl.textContent = 'Ce n’est pas la bonne ombre.';
          setTimeout(() => {
            slot.classList.remove('is-incorrect');
            activeToken.classList.remove('is-incorrect');
          }, 600);
        }
      }

      function playSound(id) {
        const audio = document.getElementById(id);
        if (!audio) { return; }
        audio.currentTime = 0;
        audio.play().catch(() => {});
      }

      function finishGame() {
        const finalSound = document.getElementById('final-reward-sound');
        finalSound.currentTime = 0;
        finalSound.play().catch(() => {});
        setTimeout(() => {
          if (reinforcerController && typeof reinforcerController.show === 'function') {
            reinforcerController.show({ reinforcerType });
          } else {
            sessionHelpers.advanceToNextGame();
          }
        }, 300);
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
    })();
  </script>
</body>
</html>
