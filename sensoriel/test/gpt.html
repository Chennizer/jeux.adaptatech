<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Routine matinale ‚Äî D√©mo Reveal.js (interactif)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- Reveal.js core + theme -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/theme/white.css" id="theme">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/monokai.css">

  <style>
    .reveal .slides { text-align: left; }
    .reveal h1, .reveal h2 { color:#294936; }
    .reveal a { color:#D36135; }
    .badge { display:inline-block; padding:.25em .55em; border-radius:.5em; border:1px solid #623B5A; }
    .note-tip { font-size: .8em; opacity:.8; }
    .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin:.5rem 0 1rem; }
    .row label{ font-weight:600; color:#294936; }
    input[type="range"]{ width:260px; }
    pre code{ font-size:.9em; }

    /* Titles: centered, slides start near top */
    .reveal h1, .reveal h2{ text-align:center; margin:0 0 .7em; }
    .reveal .slides section{ padding-top:24px; }

    /* Pictos */
    .picto-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:1rem; justify-items:center; align-items:center; }
    .picto{
      width:110px; height:110px; display:flex; align-items:center; justify-content:center;
      border-radius:16px; border:2px solid #e6eaef; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.06);
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, outline-color .15s ease;
      outline:4px solid transparent; position:relative; overflow:hidden;
      user-select: none; touch-action: manipulation;
    }
    .picto img{ max-width:100%; max-height:100%; }
    .picto.selected{ outline-color:#ADF1D2; border-color:#294936; box-shadow:0 4px 14px rgba(0,0,0,.12), 0 0 0 4px rgba(173,241,210,.35) inset; transform:translateY(-1px); }
    @keyframes pulse { 0% { transform:scale(1); } 35%{ transform:scale(1.08); } 100%{ transform:scale(1); } }
    .picto.activated{ animation:pulse .6s ease-out both; border-color:#D36135; box-shadow:0 6px 18px rgba(0,0,0,.16), 0 0 0 4px rgba(211,97,53,.25) inset; }

    .gaze .picto::after{
      content:""; position:absolute; inset:-2px; border-radius:18px;
      background:conic-gradient(#D36135 0deg, #D36135 0deg, transparent 0deg);
      mix-blend-mode:normal; opacity:.18; pointer-events:none; transition:opacity .12s ease;
    }
    .gaze .picto.dwell::after{ opacity:.35; }

    /* Fixed controls */
    #fullscreenBtn{
      position:fixed; top:10px; right:10px; z-index:9999;
      background:#294936; color:#fff; border:none; padding:.5em 1em; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    #fullscreenBtn:active{ transform:translateY(1px); }

    /* BIG contextual request image (top-left) */
    #remoteBtn{
      position:fixed; top:10px; left:10px; z-index:9999;
      width:140px; height:140px; cursor:pointer;
      background:transparent; border:none; padding:0; box-shadow:none; object-fit:contain;
      display:none; /* shown only when relevant */
      user-select:none;
    }
    #remoteBtn:active{ transform:translateY(1px); }

    .start-deck-btn{
      margin-top: 1rem; background:#294936; color:#fff; border:none;
      padding:.6em 1em; border-radius:10px; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,.2); font-size:1rem;
    }

    /* Immersive game */
    body.immersive .reveal .controls,
    body.immersive .reveal .progress,
    body.immersive .reveal .slide-number { display:none !important; }
    #slide-game{ padding:0 !important; background:#000; }
    #slide-game .frame-wrap{ position:relative; width:100%; height:100%; }
    #gameFrame{ position:absolute; inset:0; width:100%; height:100%; border:0; background:#000; display:block; }
    #slide-game .overlay-hint{
      position:absolute; left:12px; bottom:12px; z-index:2;
      background:rgba(0,0,0,.45); color:#fff; padding:.35em .6em; border-radius:8px; font-size:.9rem;
    }

    /* Branching (videos) */
    #branch-root .branch-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; margin-top:1rem; }
    .branch-card{
      display:flex; align-items:center; justify-content:center; gap:.6rem;
      padding:1.2rem; border-radius:14px; border:2px solid #e6eaef; background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
      cursor:pointer; font-size:1.05rem; font-weight:600; color:#294936;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .branch-card:hover{ transform:translateY(-1px); border-color:#ADF1D2; box-shadow:0 4px 14px rgba(0,0,0,.12); }
    .waiting-remote{ font-size:.95rem; opacity:.8; margin-top:.75rem; }

    .vid-slide{ padding:0 !important; background:#000; }
    .vid-wrap{ position:relative; width:100%; height:100%; background:#000; }
    .vid{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; }

    .vid-overlay{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.55); color:#fff; padding:.6rem 1rem; border-radius:10px;
      font-size:1rem; display:none; z-index:2; cursor:pointer;
    }

    /* Fixed overlay portal for reliable rendering */
    #playerPortal {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 10000;
      display: none;
    }
    #playerPortal video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    .reorder-row { display:flex; align-items:center; gap:.5rem; margin:.5rem 0 1rem; }
    .reorder-row input[type="checkbox"] { transform: scale(1.2); }

    /* Persistent logo (top-right of slides area) */
    .reveal .slides::after{
      content:"";
      position:fixed; top:0px; right:-10px; width:140px; height:140px;
      background-image:url("../../images/owlval.png");
      background-size:contain; background-repeat:no-repeat; background-position:center;
      z-index:9998; pointer-events:none;
    }
  </style>
</head>
<body>

<button id="fullscreenBtn" title="Plein √©cran (‚õ∂)">‚õ∂</button>
<img id="remoteBtn" alt="Action distante" title="" />

<!-- Portal overlay lives outside Reveal transforms -->
<div id="playerPortal" aria-hidden="true"></div>

<div class="reveal">
  <div class="slides">
    <!-- 1: Intro -->
    <section data-background-color="#DFF3E4" style="padding-top:64px">
      <h1>Routine matinale</h1>
      <p class="note-tip">‚Üê ‚Üí ‚Üë ‚Üì (navigation), <kbd>Esc</kbd> (plan), <kbd>S</kbd> (notes). Espace = interaction.</p>
      <p class="badge">Reveal.js ‚Ä¢ D√©mo pr√™te √† l‚Äôemploi</p>
      <button id="startDeckBtn" class="start-deck-btn">Plein √©cran & commencer ‚û°Ô∏è</button>
      <aside class="notes">Tour de table, m√©t√©o, rappel de l‚Äôhoraire.</aside>
    </section>

    <!-- 2: Plan -->
    <section>
      <h2>Plan du jour</h2>
      <ul>
        <li class="fragment">Accueil &amp; m√©t√©o</li>
        <li class="fragment">Choix d‚Äôactivit√©s</li>
        <li class="fragment">Pause sensorielle</li>
        <li class="fragment">Ateliers</li>
      </ul>
    </section>

    <!-- 3: Vertical group (M√©t√©o + Choix + Jeu) -->
    <section>
      <!-- 3.1 Intro (use global image button) -->
      <section>
        <h2>M√©t√©o</h2>
        <p>Demander √† l‚Äô√©l√®ve de s√©lectionner l‚Äôic√¥ne m√©t√©o.</p>
        <p class="note-tip">Appuyez sur <kbd>‚Üì</kbd> pour descendre vers les options m√©t√©o.</p>
      </section>

      <!-- 3.2 ‚Üí Sun -->
      <section id="weather-sun">
        <h2>‚òÄÔ∏è Il fait soleil</h2>
        <p>Pr√©voyez chapeau et lunettes de soleil üòé</p>
      </section>

      <!-- 3.3 ‚Üí Cloud -->
      <section id="weather-cloud">
        <h2>‚òÅÔ∏è Ciel nuageux</h2>
        <p>Temps gris, mais parfait pour une promenade rapide.</p>
      </section>

      <!-- 3.4 ‚Üí Rain -->
      <section id="weather-rain">
        <h2>üåßÔ∏è Il pleut</h2>
        <p>Parapluie conseill√© !</p>
      </section>

      <!-- 3.5 ‚Üí Snow -->
      <section id="weather-snow">
        <h2>‚ùÑÔ∏è Il neige</h2>
        <p>On s‚Äôhabille chaudement, bottes et gants !</p>
      </section>

      <!-- 3.6 Game -->
      <section id="slide-game">
        <div class="frame-wrap">
          <div class="overlay-hint" id="overlayHint">Astuce: ‚õ∂ pour mode plein √©cran du navigateur</div>
          <iframe id="gameFrame"
                  src="../../gaming/cloud/index.html?requiredPresses=5"
                  title="Activit√© int√©gr√©e"
                  allow="autoplay; fullscreen; clipboard-read; clipboard-write; gamepad; accelerometer; gyroscope"
                  allowfullscreen
                  referrerpolicy="no-referrer"></iframe>
        </div>
      </section>
    </section>

    <!-- 4: Branching group with two videos under it -->
    <section id="branch-group">
      <section id="branch-root">
        <h2>Choisis une activit√© vid√©o</h2>
        <p class="note-tip">Utilisez le bouton image (haut-gauche) pour demander au contr√¥leur.</p>
        <div class="branch-grid">
          <button class="branch-card" id="localOpt1">üéµ Slippery Fish (local)</button>
          <button class="branch-card" id="localOpt2">ü•Å Africa (local)</button>
        </div>
        <div id="remoteStatus" class="waiting-remote" aria-live="polite"></div>
      </section>

      <section id="video1" class="vid-slide">
        <div class="vid-wrap">
          <div id="overlay1" class="vid-overlay">Cliquez pour lancer en plein √©cran ‚Äî appuyez sur <b>Q</b> pour quitter</div>
          <video id="vid1" class="vid" preload="auto" playsinline></video>
        </div>
      </section>

      <section id="video2" class="vid-slide">
        <div class="vid-wrap">
          <div id="overlay2" class="vid-overlay">Cliquez pour lancer en plein √©cran ‚Äî appuyez sur <b>Q</b> pour quitter</div>
          <video id="vid2" class="vid" preload="auto" playsinline></video>
        </div>
      </section>
    </section>

    <!-- 5: Code -->
    <section>
      <h2>Extrait de code</h2>
      <pre><code class="language-js">
// Exemple: initialiser une "sc√®ne" simple
function startMorningRoutine() {
  const steps = ["M√©t√©o", "Choix", "Pause", "Ateliers"];
  steps.forEach((s, i) => console.log(`#${i+1}:`, s));
}
startMorningRoutine();
      </code></pre>
    </section>

    <!-- 6: Buttons -->
    <section>
      <h2>Interaction rapide</h2>
      <p>Boutons de d√©monstration.</p>
      <button onclick="alert('Bonjour üëã')">Dire bonjour</button>
      <button onclick="Reveal.next()">Slide suivant ‚û°Ô∏è</button>
    </section>

    <!-- 7: Keyboard selection + drag & drop -->
    <section id="slide-keyboard">
      <h2>Pictogrammes ‚Äî S√©lection clavier</h2>
      <p class="note-tip">
        <kbd>Entr√©e</kbd> = suivant (‚áß+Entr√©e = pr√©c√©dent) ‚Ä¢ <kbd>Espace</kbd> = activer ‚Ä¢
        üñ±Ô∏è Cliquez pour activer ‚Ä¢ üîÄ Option ci-dessous pour r√©organiser par glisser-d√©poser
      </p>
      <div class="reorder-row">
        <input type="checkbox" id="toggleReorder">
        <label for="toggleReorder">Activer le mode r√©organisation (glisser-d√©poser)</label>
      </div>
      <div class="picto-grid" id="grid-keyboard"></div>
    </section>

    <!-- 8: Eye-gaze (hover/dwell) -->
    <section id="slide-gaze">
      <h2>Pictogrammes ‚Äî Eye-gaze (survol)</h2>
      <div class="row">
        <label for="dwell">Temps de fixation (ms):</label>
        <input id="dwell" type="range" min="400" max="3000" step="100" value="1200">
        <span id="dwellVal">1200</span>
      </div>
      <p class="note-tip">Survolez une image : un court d√©lai d√©clenche l‚Äôactivation.</p>
      <div class="picto-grid gaze" id="grid-gaze"></div>
    </section>

    <!-- 9: Static grid -->
    <section>
      <h2>Pictogrammes (aper√ßu)</h2>
      <div class="picto-grid" id="grid-static"></div>
    </section>

    <!-- 10: End -->
    <section data-background-color="#ADF1D2">
      <h2>Merci!</h2>
      <p>Docs Reveal.js : <a href="https://revealjs.com" target="_blank" rel="noreferrer">revealjs.com</a></p>
      <p class="note-tip">Impression PDF : ajoutez <code>?print-pdf</code> √† l‚ÄôURL.</p>
    </section>
  </div>
</div>

<!-- Scripts: Reveal + Plugins -->
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/markdown/marked.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/notes/notes.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/highlight.js"></script>

<script>
  /* ========= Params & WS ========= */
  const qs = new URL(location.href).searchParams;
  const room = qs.get('room') || 'test';
  const WS_URL = `wss://ws-relay.gui98789.workers.dev/ws/${encodeURIComponent(room)}`;
  const deckTitle = 'Routine matinale';

  const KNOWN_VIDEOS = {
    v1: 'https://bucket.adaptatech.org/amyliz-slipperyfish.mp4',
    v2: 'https://bucket.adaptatech.org/africa.mp4'
  };

  /* ========= Reveal init ========= */
  Reveal.initialize({
    hash: true, slideNumber: true, controls: true, progress: true,
    center: false, history: true, transition: 'slide',
    width: 1280, height: 720,
    keyboard: { 32: null },
    plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
  });

  document.getElementById("startDeckBtn").addEventListener("click", async ()=>{
    try { if (!document.fullscreenElement) await document.documentElement.requestFullscreen(); } catch {}
    Reveal.next();
  });

  document.getElementById("fullscreenBtn").addEventListener("click", ()=>{
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  });

  /* ========= Pictos / gaze / keyboard (helpers) ========= */
  const PICTO_BASE='../../images/pictos/';
  let FILES=['angry.png','apple.png','assistivebike.png','assistiveswitches.png','balloon.png','banana.png','basketball.png','bear.png','beaver.png','bicycle.png','binsensory.png','binwater.png','blackroom.png','boat.png','book.png','book2.png','bowl.png','broccoli.png','brush.png','bus.png'];

  function buildGrid(containerId){
    const el=document.getElementById(containerId);
    el.innerHTML='';
    FILES.forEach(name=>{
      const tile=document.createElement('div'); tile.className='picto';
      const img=document.createElement('img'); img.alt=name.replace('.png',''); img.src=PICTO_BASE+name;
      tile.appendChild(img); el.appendChild(tile);
    });
    return el.querySelectorAll('.picto');
  }
  function makeKeyboardNavigable(gridId){
    const container=document.getElementById(gridId);
    let nodes=buildGrid(gridId);
    if(!nodes.length) return;
    let idx=0;
    const refresh=()=>{ nodes=container.querySelectorAll('.picto'); };
    const select=i=>{
      refresh();
      idx=(i+nodes.length)%nodes.length;
      nodes.forEach(n=>n.classList.remove('selected'));
      nodes[idx].classList.add('selected');
      nodes[idx].scrollIntoView({block:'nearest', inline:'nearest'});
    };
    const activate=()=>{
      refresh();
      const n=nodes[idx]; if(!n) return;
      n.classList.add('activated'); setTimeout(()=>n.classList.remove('activated'),700);
    };
    nodes.forEach((node,i)=>node.addEventListener('click',()=>{ select(i); activate(); }));
    select(0);

    const onKey=(e)=>{
      if(Reveal.getCurrentSlide()?.id!=='slide-keyboard') return;
      if(e.key==='Enter'){ e.preventDefault(); e.stopImmediatePropagation(); select(e.shiftKey?idx-1:idx+1); }
      else if(e.key===' '||e.key==='Spacebar'){ e.preventDefault(); e.stopImmediatePropagation(); activate(); }
    };
    window.addEventListener('keydown', onKey, {capture:true});
  }
  function makeGazeGrid(gridId, sliderId, labelId){
    const nodes=buildGrid(gridId);
    const dwellInput=document.getElementById(sliderId);
    const dwellVal=document.getElementById(labelId);
    let dwellMs=parseInt(dwellInput.value,10)||1200;
    dwellVal.textContent=dwellMs;
    dwellInput.addEventListener('input', ()=>{ dwellMs=parseInt(dwellInput.value,10); dwellVal.textContent=dwellMs; });
    nodes.forEach(tile=>{
      let t=null;
      const start=()=>{ tile.classList.add('dwell'); t=setTimeout(()=>{ tile.classList.remove('dwell'); tile.classList.add('activated'); setTimeout(()=>tile.classList.remove('activated'),700); }, dwellMs); };
      const stop =()=>{ tile.classList.remove('dwell'); if(t){ clearTimeout(t); t=null; } };
      tile.addEventListener('mouseenter', start);
      tile.addEventListener('mouseleave', stop);
      tile.addEventListener('click', ()=>{ tile.classList.add('activated'); setTimeout(()=>tile.classList.remove('activated'),700); });
    });
  }
  function buildStatic(){ buildGrid('grid-static'); }

  /* ========= Game immersive mode ========= */
  const gameFrame=document.getElementById('gameFrame');
  const overlayHint=document.getElementById('overlayHint');
  function callGame(fnName, ...args){ try{ const cw=gameFrame?.contentWindow; if(cw && typeof cw[fnName]==='function') cw[fnName](...args);}catch{} }
  function enterGameMode(){
    document.body.classList.add('immersive');
    callGame('ADAPTATECH_game_onResume');
    if(gameFrame) gameFrame.focus();
    if(gameFrame && gameFrame.requestFullscreen){
      gameFrame.requestFullscreen().then(()=>{ if(overlayHint) overlayHint.style.display='none'; })
                                   .catch(()=>{ if(overlayHint) overlayHint.style.display=''; });
    }
  }
  function exitGameMode(){
    document.body.classList.remove('immersive');
    callGame('ADAPTATECH_game_onPause');
    if(document.fullscreenElement===gameFrame) document.exitFullscreen().catch(()=>{});
  }
  window.ADAPTATECH_exitAndNext=async function(){
    exitGameMode();
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else if(document.fullscreenElement!==document.documentElement){ await document.exitFullscreen(); await document.documentElement.requestFullscreen(); }
    }catch{}
    Reveal.next();
  };
  Reveal.on('slidechanged',(evt)=>{
    const now=evt.currentSlide, prev=evt.previousSlide;
    if(now && now.id==='slide-game') enterGameMode();
    else if(prev && prev.id==='slide-game') exitGameMode();
    updateRemoteBtnVisibility();
  });

  /* ========= Video logic with portal ========= */
  const remoteStatus = document.getElementById('remoteStatus');
  const localOpt1Btn  = document.getElementById('localOpt1');
  const localOpt2Btn  = document.getElementById('localOpt2');

  const videoElems = {
    v1: document.getElementById('vid1'),
    v2: document.getElementById('vid2')
  };
  const overlays = {
    v1: document.getElementById('overlay1'),
    v2: document.getElementById('overlay2')
  };
  overlays.v1.textContent = 'Cliquez pour lancer en plein √©cran ‚Äî appuyez sur Q pour quitter';
  overlays.v2.textContent = 'Cliquez pour lancer en plein √©cran ‚Äî appuyez sur Q pour quitter';

  const portal = document.getElementById('playerPortal');
  const placeholders = {
    v1: videoElems.v1.parentElement,
    v2: videoElems.v2.parentElement
  };

  let inputsLocked=false;
  let currentVidKey=null;
  let stickRAF=null;
  let stickTarget=null;

  const blockKeys=new Set([' ','Spacebar','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','PageUp','PageDown','Home','End','Escape','Tab']);

  function onKeyCapture(e){
    if (!inputsLocked) return;
    if (e.key === 'q' || e.key === 'Q'){
      e.preventDefault();
      e.stopImmediatePropagation();
      stopCurrentVideoAndReturn(branchHIndex());
      return;
    }
    if (blockKeys.has(e.key)) { e.preventDefault(); e.stopImmediatePropagation(); }
  }
  function onWheelCapture(e){ if(inputsLocked){ e.preventDefault(); e.stopImmediatePropagation(); } }
  function onTouchMoveCapture(e){ if(inputsLocked){ e.preventDefault(); e.stopImmediatePropagation(); } }
  function onPointerDownCapture(e){
    if (!inputsLocked) return;
    if (e.target.closest('video') || e.target.closest('.vid-overlay')) return;
    e.preventDefault(); e.stopImmediatePropagation();
  }

  function lockDeckInputs(){
    inputsLocked=true;
    Reveal.configure({ keyboard:false, touch:false, controls:false, overview:false });
    window.addEventListener('keydown', onKeyCapture, true);
    window.addEventListener('keyup', onKeyCapture, true);
    window.addEventListener('wheel', onWheelCapture, {capture:true, passive:false});
    window.addEventListener('touchmove', onTouchMoveCapture, {capture:true, passive:false});
    window.addEventListener('pointerdown', onPointerDownCapture, true);
    updateRemoteBtnVisibility();
  }
  function unlockDeckInputs(){
    inputsLocked=false;
    Reveal.configure({ keyboard:true, touch:true, controls:true, overview:true });
    window.removeEventListener('keydown', onKeyCapture, true);
    window.removeEventListener('keyup', onKeyCapture, true);
    window.removeEventListener('wheel', onWheelCapture, true);
    window.removeEventListener('touchmove', onTouchMoveCapture, true);
    window.removeEventListener('pointerdown', onPointerDownCapture, true);
    stopStickToSlide();
    updateRemoteBtnVisibility();
  }

  function branchHIndex(){
    const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
    return sections.findIndex(s => s.id === 'branch-group');
  }

  async function enterFullscreen(el){ try{ if(el?.requestFullscreen) await el.requestFullscreen(); }catch{} }
  async function exitFullscreenIfOwned(el){ try{ if(document.fullscreenElement===el) await document.exitFullscreen(); }catch{} }

  function whichFromUrl(url){
    if(!url) return 'v1';
    return (url.includes('africa')) ? 'v2' : 'v1';
  }

  function startStickToSlide(h, v){
    stickTarget = {h, v};
    const tick = ()=>{
      if (!inputsLocked || !stickTarget) return;
      const cur = Reveal.getIndices();
      if (cur.h !== stickTarget.h || cur.v !== stickTarget.v){
        Reveal.slide(stickTarget.h, stickTarget.v);
      }
      stickRAF = requestAnimationFrame(tick);
    };
    stopStickToSlide();
    stickRAF = requestAnimationFrame(tick);
  }
  function stopStickToSlide(){
    if (stickRAF) cancelAnimationFrame(stickRAF);
    stickRAF = null;
    stickTarget = null;
  }

  function usePortal(key){
    const vid = videoElems[key];
    if (!portal.contains(vid)){ portal.appendChild(vid); }
    portal.style.display = 'block';
    portal.setAttribute('aria-hidden','false');
  }
  function restoreFromPortal(key){
    const vid = videoElems[key];
    const wrap = placeholders[key];
    if (wrap && !wrap.contains(vid)){ wrap.appendChild(vid); }
    portal.style.display = 'none';
    portal.setAttribute('aria-hidden','true');
  }

  async function playVideoUnderBranch(key, url, {forcePortal=false}={}){
    const h = branchHIndex();
    if(h < 0) return;

    const vid = videoElems[key];
    const other = videoElems[key === 'v1' ? 'v2' : 'v1'];
    try { other.pause(); } catch {}
    vid.src = url || KNOWN_VIDEOS[key];
    vid.currentTime = 0;

    lockDeckInputs();

    const vIndex = (key === 'v1') ? 1 : 2; // 0 = branch-root, 1/2 = videos
    Reveal.slide(h, vIndex);
    startStickToSlide(h, vIndex);

    await new Promise(r => requestAnimationFrame(r));
    try { vid.load(); } catch {}

    currentVidKey = key;

    const overlay = overlays[key];

    const tryNative = async ()=>{
      try {
        await enterFullscreen(vid);
        await vid.play();
        if(overlay) overlay.style.display='none';
        return true;
      } catch { return false; }
    };

    const startInPortal = async ()=>{
      usePortal(key);
      await new Promise(r => setTimeout(r, 0));
      try { await vid.play(); } catch {}
    };

    if (forcePortal) {
      await startInPortal();
    } else {
      const ok = await tryNative();
      if (!ok){
        if (overlay){
          overlay.textContent = 'Cliquez pour lancer la vid√©o (plein √©cran) ‚Äî appuyez sur Q pour quitter';
          overlay.style.display = 'block';
        }
        const onFirstPointer = async ()=>{
          overlay?.removeEventListener('pointerup', onFirstPointer);
          vid.removeEventListener('pointerup', onFirstPointer);
          if (!(await tryNative())) {
            await startInPortal();
            if (overlay) overlay.style.display='none';
          }
        };
        overlay?.addEventListener('pointerup', onFirstPointer, { once:true });
        vid.addEventListener('pointerup', onFirstPointer, { once:true });

        setTimeout(async ()=>{
          if (inputsLocked && currentVidKey === key && !document.fullscreenElement) {
            await startInPortal();
            if (overlay) overlay.style.display='none';
          }
        }, 100);
      }
    }
  }

  async function stopCurrentVideoAndReturn(targetH = branchHIndex()){
    stopStickToSlide();

    if(currentVidKey){
      const vid = videoElems[currentVidKey];
      try { await exitFullscreenIfOwned(vid); } catch {}
      try { vid.pause(); } catch {}
      try { vid.removeAttribute('src'); } catch {}
      try { vid.src = ''; vid.load(); vid.currentTime = 0; } catch {}
      restoreFromPortal(currentVidKey);
    }

    if (typeof targetH === 'number' && targetH >= 0){ Reveal.slide(targetH, 0); }
    else { const h = branchHIndex(); if (h >= 0) Reveal.slide(h, 0); }

    currentVidKey = null;
    unlockDeckInputs();
    const s = document.getElementById('remoteStatus');
    if(s) s.textContent = '';
  }

  videoElems.v1.addEventListener('ended', ()=> stopCurrentVideoAndReturn(branchHIndex()));
  videoElems.v2.addEventListener('ended', ()=> stopCurrentVideoAndReturn(branchHIndex()));
  videoElems.v1.addEventListener('pause', ()=>{ if(inputsLocked && !videoElems.v1.ended) videoElems.v1.play().catch(()=>{}); });
  videoElems.v2.addEventListener('pause', ()=>{ if (inputsLocked && !videoElems.v2.ended) videoElems.v2.play().catch(()=>{}); });

  document.addEventListener('fullscreenchange', async ()=>{
    if(!inputsLocked || !currentVidKey) return;
    const vid = videoElems[currentVidKey];
    const overlay = overlays[currentVidKey];
    if(!document.fullscreenElement && !vid.ended){
      try { await enterFullscreen(vid); if(overlay) overlay.style.display='none'; }
      catch { usePortal(currentVidKey); if(overlay){ overlay.textContent='Cliquez pour reprendre ‚Äî Q pour quitter'; overlay.style.display='none'; } }
    }
  });

  localOpt1Btn.addEventListener('click', ()=> playVideoUnderBranch('v1', KNOWN_VIDEOS.v1, {forcePortal:false}));
  localOpt2Btn.addEventListener('click', ()=> playVideoUnderBranch('v2', KNOWN_VIDEOS.v2, {forcePortal:false}));

  /* ========= WebSocket wiring (robust + pending resend) ========= */
  let WS = null;
  let hbInterval = null;
  let watchdogInterval = null;
  let lastActivity = 0;
  let backoffMs = 1000;
  const backoffMax = 15000;
  let reconnectTimer = null;
  let connecting = false;

  // Remember last pending remote request
  let lastPending = null; // { kind:'video'|'weather', msg:{...} }

  function setRemoteStatus(txt){
    const s = document.getElementById('remoteStatus');
    if (s) s.textContent = txt || '';
  }

  function clearWsTimers(){
    if (hbInterval) { clearInterval(hbInterval); hbInterval = null; }
    if (watchdogInterval) { clearInterval(watchdogInterval); watchdogInterval = null; }
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
  }

  function scheduleReconnect(){
    if (connecting) return;
    if (reconnectTimer) return;
    reconnectTimer = setTimeout(()=>{ reconnectTimer = null; connectWS(); }, backoffMs);
    backoffMs = Math.min(backoffMs * 2, backoffMax);
    console.warn('[slides] WS closed; reconnect in', backoffMs/2, 'ms');
  }

  function wsSend(obj){
    const payload = JSON.stringify(obj);
    if (WS && WS.readyState === WebSocket.OPEN) WS.send(payload);
    else if (WS) WS.addEventListener('open', ()=> WS.send(payload), { once:true });
  }

  function connectWS(){
    if (connecting) return;
    connecting = true;

    try { WS = new WebSocket(WS_URL); }
    catch { connecting = false; scheduleReconnect(); return; }

    WS.onopen = ()=>{
      connecting = false;
      lastActivity = Date.now();
      clearWsTimers();

      setRemoteStatus('Connect√© au canal ' + room);
      wsSend({ type:'hello', role:'slides', deckTitle });

      hbInterval = setInterval(()=>{
        try { WS.readyState===1 && WS.send(JSON.stringify({ type:'ping' })); lastActivity = Date.now(); } catch {}
      }, 20000);

      // resend pending after reconnect
      if (lastPending) setTimeout(()=> wsSend(lastPending.msg), 200);

      backoffMs = 1000;
    };

    WS.onmessage = (e)=>{
      lastActivity = Date.now();
      let msg; try { msg = JSON.parse(e.data); } catch { return; }

      if (msg.type === 'ping') { try { WS.send(JSON.stringify({ type:'pong' })); } catch {} return; }
      if (msg.type === 'pong') return;

      // controller hello ‚Üí resend pending
      if (msg.type === 'hello' && msg.role === 'controller' && lastPending) {
        setTimeout(()=> wsSend(lastPending.msg), 50);
        return;
      }

      if (msg.type === 'play_video' && msg.url){
        setRemoteStatus('Commande re√ßue : lecture‚Ä¶');
        const key = whichFromUrl(msg.url);
        playVideoUnderBranch(key, msg.url, { forcePortal:true });
        return;
      }
      if (msg.type === 'stop_video'){
        stopCurrentVideoAndReturn(branchHIndex());
        return;
      }

      if (msg.type === 'weather_choice') {
        // navigate based on provided goto or key
        let target = msg.goto;
        if (!target && msg.key) {
          const h = weatherColumnIndex();
          const map = { sun:1, cloud:2, rain:3, snow:4 };
          target = { h, v: map[String(msg.key).toLowerCase()] ?? 0 };
        }
        if (target && Number.isInteger(target.h) && Number.isInteger(target.v)) {
          Reveal.slide(target.h, target.v);
        }
        if (lastPending?.kind === 'weather') lastPending = null;
        return;
      }
    };

    WS.onerror = ()=> setRemoteStatus('Erreur WebSocket');
    WS.onclose = ()=>{ clearWsTimers(); setRemoteStatus('WebSocket ferm√©'); connecting = false; scheduleReconnect(); };

    watchdogInterval = setInterval(()=>{
      if (Date.now() - lastActivity > 60000) { try { WS.close(); } catch {} }
    }, 5000);
  }

  connectWS();
  window.addEventListener('online', ()=>{ if(!WS || WS.readyState !== 1) connectWS(); });
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden && (!WS || WS.readyState !== 1)) connectWS(); });

  /* ----- Weather helpers ----- */
  function weatherColumnIndex() {
    const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
    const sun = document.getElementById('weather-sun');
    if (!sun) return -1;
    return sections.findIndex(s => s.contains(sun));
  }

  /* ----- Contextual remote request image (only where relevant) ----- */
  const remoteBtn = document.getElementById('remoteBtn');

  // load ../../images/ch.(png|svg|jpg|jpeg) with graceful fallback
  (function setRemoteBtnSrc(){
    const candidates = ['../../images/ch.png','../../images/ch.svg','../../images/ch.jpg','../../images/ch.jpeg'];
    let i = 0;
    remoteBtn.onerror = ()=>{ if (++i < candidates.length) remoteBtn.src = candidates[i]; };
    remoteBtn.src = candidates[0];
  })();

  function sendVideoRequest(){
    const msg = {
      type: 'request_video',
      from: 'slides',
      deckTitle,
      options: [
        { title:'Slippery Fish', url: KNOWN_VIDEOS.v1, thumb: '../../images/binou.png' },
        { title:'Africa',        url: KNOWN_VIDEOS.v2, thumb: '../../images/africa-image.png' }
      ],
      note: 'Veuillez choisir une vid√©o √† lancer.'
    };
    lastPending = { kind:'video', msg };
    wsSend(msg);
    setRemoteStatus('Demande envoy√©e. En attente du choix distant‚Ä¶');
  }

  function sendWeatherRequest(){
    const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
    const sun = document.getElementById('weather-sun');
    const weatherH = sun ? sections.findIndex(s => s.contains(sun)) : 0;

    const msg = {
      type: 'request_weather',
      from: 'slides',
      deckTitle,
      options: [
        { title:'Soleil', key:'sun',   thumb:'../../images/sun.png',   goto:{h:weatherH, v:1} },
        { title:'Nuages', key:'cloud', thumb:'../../images/cloud.png', goto:{h:weatherH, v:2} },
        { title:'Pluie',  key:'rain',  thumb:'../../images/rain.png',  goto:{h:weatherH, v:3} },
        { title:'Neige',  key:'snow',  thumb:'../../images/snow.png',  goto:{h:weatherH, v:4} }
      ],
      note: 'Choisir la m√©t√©o'
    };
    lastPending = { kind:'weather', msg };
    wsSend(msg);
    if (weatherH >= 0) Reveal.slide(weatherH, 0);
  }

  function updateRemoteBtnVisibility(){
    const idx = Reveal.getIndices();
    const weatherH = weatherColumnIndex();
    const branchH  = branchHIndex();

    // Hide while video controls are locked
    if (inputsLocked) { remoteBtn.style.display = 'none'; return; }

    // Show on any weather slide
    if (idx.h === weatherH && weatherH >= 0) {
      remoteBtn.style.display = 'block';
      remoteBtn.title = 'Demander la m√©t√©o (contr√¥leur)';
      return;
    }

    // Show only on branch root (video chooser)
    if (idx.h === branchH && idx.v === 0 && branchH >= 0) {
      remoteBtn.style.display = 'block';
      remoteBtn.title = 'Demander une vid√©o (contr√¥leur)';
      return;
    }

    remoteBtn.style.display = 'none';
  }

  remoteBtn.addEventListener('click', ()=>{
    const idx = Reveal.getIndices();
    const weatherH = weatherColumnIndex();
    const branchH  = branchHIndex();
    if (idx.h === weatherH && weatherH >= 0) sendWeatherRequest();
    else if (idx.h === branchH && idx.v === 0 && branchH >= 0) sendVideoRequest();
  });

  /* ========= Ready ========= */
  Reveal.on('ready', () => {
    if (window.hljs) { hljs.highlightAll(); }
    buildStatic();
    makeGazeGrid('grid-gaze','dwell','dwellVal');
    updateRemoteBtnVisibility();
  });

  /* ========= Global "Q" ‚Üí go to top of current stack ========= */
  (function enableQToStackTop(){
    const isTyping = (el) =>
      el && (el.closest && el.closest('input, textarea, select, [contenteditable="true"]'));

    window.addEventListener('keydown', (e) => {
      // During video playback, the capture handler owns Q
      if (typeof inputsLocked !== 'undefined' && inputsLocked) return;

      if (e.key === 'q' || e.key === 'Q') {
        // Avoid interfering with typing or overview
        if (isTyping(e.target)) return;
        if (Reveal.isOverview && Reveal.isOverview()) return;

        const idx = Reveal.getIndices && Reveal.getIndices();
        if (idx && Number.isInteger(idx.h)) {
          e.preventDefault();
          e.stopImmediatePropagation();
          Reveal.slide(idx.h, 0); // e.g., 4.3 ‚Üí 4.1
        }
      }
    }, false);
  })();
</script>
</body>
</html>
