<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title class="translate"
         data-fr="Loona : Cause à effet"
         data-en="Loona : Cause-and-effect">
    Loona : Cause-and-effect
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- styles globaux Adaptatech -->
  <link rel="stylesheet" href="../../css/choix.css"/>
  <link rel="stylesheet" href="../../css/otherswitch.css"/>

  <style>
    :root{
      --accent:#D36135;
      --accent-light:#ADF1D2;
      --bg:#DFF3E4;
    }
    body{margin:0;height:100vh;display:flex;flex-direction:column;}
    main{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg);}
    #actionBtn{
      font-size:6rem;padding:1.5rem 3rem;border:none;border-radius:1rem;
      background:var(--accent);color:#fff;cursor:pointer;
      transition:transform .1s;
    }
    #actionBtn:active{transform:scale(.95);}
    #actionBtn:focus{outline:4px solid var(--accent-light);}

    /* ===== overlay mode ===== */
    #modeOverlay{
      position:fixed;inset:0;background:#0008;display:flex;flex-direction:column;
      align-items:center;justify-content:center;z-index:9999;
    }
    #modeOverlay h2{color:#fff;margin-bottom:2rem;font-size:2rem;text-align:center;}
    .mode-btn{
      font-size:1.5rem;margin:.5rem;padding:.8rem 2.2rem;border:none;border-radius:.8rem;
      background:var(--accent);color:#fff;cursor:pointer;width:280px;
    }
    .mode-btn:focus{outline:4px solid var(--accent-light);}
  </style>
</head>
<body>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date()); gtag('config','G-B45TJG4GBJ');
  </script>

  <!-- ===== OVERLAY CHOIX DU MODE ===== -->
  <div id="modeOverlay">
    <h2 class="translate"
        data-fr="Choisissez un mode d’accès"
        data-en="Select an access mode">
      Select an access mode
    </h2>
    <button class="mode-btn translate"
            data-fr="Switch (1)" data-en="Switch (1)"
            data-mode="single">Switch (1)</button>
    <button class="mode-btn translate"
            data-fr="Switchs multiples (2)" data-en="Multiple switches (2)"
            data-mode="multi">Switchs multiples (2)</button>
    <button class="mode-btn translate"
            data-fr="Tablette" data-en="Tablet"
            data-mode="tablet">Tablet</button>
  </div>

  <!-- ===== MENU LATÉRAL MINIMAL ===== -->
  <aside id="menu">
    <button id="infoBtn" class="translate info-icon"
            data-fr="ⓘ" data-en="ⓘ">ⓘ</button>
    <h2 class="translate"
        data-fr="Loona : Cause à effet"
        data-en="Loona : Cause-and-effect">
      Loona : Cause-and-effect
    </h2>

    <!-- Sélecteur de commande -->
    <label style="display:block;margin:1rem 0 0.5rem;">
      <span class="translate"
            data-fr="Animation Loona"
            data-en="Loona action">Loona action</span>
      <select id="cmdSelect">
        <option value="spin"  class="translate" data-fr="Tourner" data-en="Spin">Spin</option>
        <option value="dance" class="translate" data-fr="Danse"   data-en="Dance">Dance</option>
      </select>
    </label>

    <p style="font-size:.9rem;">
      <span id="helpTxt" class="translate"
            data-fr="Appuie sur ESPACE ou clique pour déclencher."
            data-en="Press SPACE or click to trigger.">
        Press SPACE or click to trigger.
      </span>
    </p>
  </aside>

  <!-- ===== ZONE D’ACTION ===== -->
  <main>
    <button id="actionBtn"
            class="translate"
            data-fr="Joue !"
            data-en="Play!">
      Play!
    </button>
  </main>

  <!-- ================= JS ================= -->
  <script src="../../js/translationonly.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded',()=>{

    /* === gestion audio === */
    const audioPath='../../sounds/loona/';
    const sounds={
      wake : new Audio(audioPath+'alloloona1.mp3'),
      spin : new Audio(audioPath+'loonachat.mp3'),
      dance: new Audio(audioPath+'loonaparesseux.mp3')
    };

    // Ajout de gestionnaire d’erreur pour debug facile
    Object.values(sounds).forEach(a=>{
      a.preload='auto'; a.load();
      a.addEventListener('error',()=>console.error('Cannot load',a.src));
    });

    const delayMs=3000;
    const btn   = document.getElementById('actionBtn');
    const select= document.getElementById('cmdSelect');
    const help  = document.getElementById('helpTxt');

    function playSequence(cmd){
      // On utilise de nouveaux objets Audio pour éviter les soucis de cloneNode
      const wakeSrc = sounds.wake.src;
      const actSrc  = sounds[cmd].src;

      const wake = new Audio(wakeSrc);
      const act  = new Audio(actSrc);

      wake.play().catch(err => console.error('Wake error', err));
      setTimeout(()=>{
        act.play().catch(err => console.error('Cmd error', err));
      }, delayMs);

      btn.style.background = 'var(--accent-light)';
      setTimeout(()=>btn.style.background = 'var(--accent)', 300);
    }

    /* === choix du mode === */
    let mode=null;
    const overlay=document.getElementById('modeOverlay');
    overlay.addEventListener('click',e=>{
      if(!e.target.dataset.mode) return;
      mode=e.target.dataset.mode;           // 'single' | 'multi' | 'tablet'
      overlay.style.display='none';
      initMode();
    });

    /* === comportement selon le mode === */
    function initMode(){
      /* nettoyage des anciens écouteurs éventuels */
      document.onkeydown=null;
      btn.onclick=null;

      switch(mode){
        case 'single':
          help.dataset.fr='Appuie sur ESPACE ou clique pour déclencher.';
          help.dataset.en='Press SPACE or click to trigger.';
          if(typeof translateAll==='function') translateAll();
          btn.onclick = ()=>playSequence(select.value);
          document.onkeydown = e=>{
            if(e.code==='Space') playSequence(select.value);
          };
          break;

        case 'tablet':
          help.dataset.fr='Touchez “Joue !” pour déclencher.';
          help.dataset.en='Tap “Play!” to trigger.';
          if(typeof translateAll==='function') translateAll();
          btn.onclick = ()=>playSequence(select.value);
          /* pas de clavier */
          break;

        case 'multi':
          help.dataset.fr='ESPACE : parcourir ; ENTRÉE : déclencher.';
          help.dataset.en='SPACE : scan ; ENTER : trigger.';
          if(typeof translateAll==='function') translateAll();
          /* petit scan deux‐switchs : SPACE fait tourner la liste, ENTER joue */
          const cmds=['spin','dance'];
          let idx=0;
          highlightSelect();
          document.onkeydown = e=>{
            if(e.code==='Space'){ idx=(idx+1)%cmds.length; highlightSelect();}
            else if(e.code==='Enter'){ playSequence(cmds[idx]); }
          };
          break;
      }
    }
    function highlightSelect(){
      select.value = mode==='multi' ? (['spin','dance'][idx]) : select.value;
    }

    /* info modal basique */
    document.getElementById('infoBtn').onclick=()=>{
      alert(document.documentElement.lang.startsWith('fr')
        ?'Place Loona à moins d’un mètre du haut-parleur puis utilise le mode sélectionné.'
        :'Place Loona within one metre of the speaker, then use the selected mode.');
    };

    /* lancer traduction initiale */
    if(typeof translateAll==='function') translateAll();
  });
  </script>
</body>
</html>
