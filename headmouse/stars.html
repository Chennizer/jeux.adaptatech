<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu de Fingerpainting (Explosion)</title>

  <!-- TrackyMouse -->
  <script src="../../lib/tracky-mouse.js"></script>

  <!-- p5.js (no sound) -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>

  <style>
    :root{
      --bg: #DFF3E4;
      --panel-bg: #294936;
      --panel-border: #623B5A;
      --accent: #D36135;
      --accent-2: #ADF1D2;
      --text: #294936;
      --white: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 14px;
    }
    html, body {
      margin:0; padding:0; height:100%;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      overflow:hidden;
      touch-action:none;
    }
    canvas { display:block; }

    /* ---------- Overlay (Start) ---------- */
    #promptOverlay{
      position:fixed; inset:0;
      display:flex; flex-direction:column; gap:1rem;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.65);
      color: var(--white);
      z-index: 1000;
      text-align:center;
      padding: 2rem;
      backdrop-filter: blur(2px);
    }
    #promptOverlay h1{
      margin:0 0 .25rem; font-size: clamp(22px, 3.5vw, 36px);
      letter-spacing:.2px;
    }
    #promptOverlay p{
      margin:0; max-width: 900px; line-height: 1.5;
      opacity:.95;
      font-size: clamp(14px, 1.8vw, 18px);
    }
    #startButton{
      margin-top: .75rem;
      padding: .9rem 1.4rem;
      font-size: 16px;
      border: none; border-radius: var(--radius);
      background: var(--accent);
      color: var(--white);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .12s ease, opacity .2s ease, filter .2s ease;
    }
    #startButton:hover{ filter: brightness(1.05); transform: translateY(-1px); }

    /* ---------- Top Controls ---------- */
    .top-controls{
      position: fixed; top: 14px; right: 14px; z-index: 1100;
      display:flex; align-items:center; gap:10px;
    }
    .icon-btn, .pill-btn{
      display:flex; align-items:center; justify-content:center;
      height:40px; min-width:40px; padding:0 .9rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.8);
      backdrop-filter: blur(6px);
      color:#111;
      box-shadow: var(--shadow);
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, opacity .2s ease;
      user-select:none;
    }
    .icon-btn{ width:40px; padding:0; }
    .icon-btn:hover, .pill-btn:hover{ background:#fff; transform: translateY(-1px); }
    .pill-btn{ font-size: 13px; gap:.5rem; }

    /* ---------- Right Options Panel ---------- */
    #menu{
      position: fixed; top: 70px; right: -320px; width: 300px;
      background: var(--panel-bg);
      color: var(--white);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      transition: right .28s ease, opacity .28s ease;
      opacity: 0;
      max-height: calc(100vh - 90px);
      overflow: auto;
      z-index: 1050;
      pointer-events: none;
    }
    #menu.visible{ right: 14px; opacity: 1; pointer-events:auto; }
    #menu h2{
      margin:0 0 8px; font-size: 18px; font-weight: 600; text-align:center;
      color: var(--accent-2);
    }
    #menu label{ display:flex; flex-direction:column; gap:6px; margin: 14px 0; font-size: 13px; }
    #menu .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; opacity:.9; }
    #menu input[type="range"]{
      -webkit-appearance:none; width:100%; height:4px;
      background: rgba(255,255,255,.25); border-radius: 4px; outline:none;
    }
    #menu input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; width:16px; height:16px; border-radius:50%;
      background: var(--accent); border: 2px solid #fff; cursor:pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    #menu .toggle{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.07); padding:10px 12px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
    }
    #menu button{
      margin-top: 8px; width:100%; padding: .75rem 1rem;
      border-radius: 10px; border: none; cursor:pointer;
      background: var(--accent); color:#fff; box-shadow: var(--shadow);
      transition: transform .12s ease, filter .2s ease;
    }
    #menu button:hover{ filter: brightness(1.05); transform: translateY(-1px); }

    /* ---------- Left Camera Panel ---------- */
    #camMenu{
      position: fixed; top: 70px; left: -360px; width: 340px;
      background: var(--panel-bg);
      color: var(--white);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      transition: left .28s ease, opacity .28s ease;
      opacity: 0;
      max-height: calc(100vh - 90px);
      overflow:auto;
      z-index: 1050;
      pointer-events: none;
    }
    #camMenu.visible{ left: 14px; opacity: 1; pointer-events:auto; }
    #camMenu h2{ margin: 6px 0 10px; text-align:center; font-size: 18px; color: var(--accent-2); }

    /* TrackyMouse sizing */
    #trackyRoot .tracky-mouse-canvas-container,
    #trackyRoot .tracky-mouse-controls{
      width:100%!important; max-width:100%!important;
    }
    #trackyRoot .tracky-mouse-canvas-container video,
    #trackyRoot .tracky-mouse-canvas-container canvas{
      width:100%!important; height:auto!important;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.2);
    }
    #startEnabled,#start-enabled,#mirrorEnabled,#mirror-enabled{ display:none!important; }

    /* ---------- Head pointer ---------- */
    .head-pointer{
      position:fixed; width:26px; height:26px; border-radius:50%;
      background: rgba(211, 97, 53, .9);
      outline: 2px solid rgba(255,255,255,.9);
      box-shadow: 0 0 0 3px rgba(173,241,210,.5), 0 6px 16px rgba(0,0,0,.35);
      will-change: transform;
      pointer-events:none; z-index: 1200; left:0; top:0;
      transform: translate(-50%, -50%);
    }

    .hint{
      position:fixed; left:16px; bottom:16px; z-index: 100;
      font-size: 12px; opacity: .7; color:#0f172a;
      background: rgba(255,255,255,.7); padding: .4rem .6rem;
      border-radius: 8px; border: 1px solid rgba(0,0,0,.08);
      backdrop-filter: blur(4px);
    }
  </style>
</head>
<body>
  <!-- Start overlay -->
  <div id="promptOverlay">
    <h1>Fingerpainting (t√™te)</h1>
    <p>
      D√©placez votre t√™te pour <strong>dessiner</strong>.
      Le trac√© <strong>explose</strong> lorsque vous vous arr√™tez bri√®vement,
      ou cochez ¬´ Garder le trac√© ¬ª pour le conserver.
    </p>
    <button id="startButton">Commencer</button>
  </div>

  <!-- Head pointer -->
  <div id="headDot" class="head-pointer" aria-hidden="true"></div>

  <!-- Top controls -->
  <div class="top-controls">
    <button id="fullscreen-btn" class="pill-btn" title="Plein √©cran">‚§¢ Plein √©cran</button>
    <button id="cameraIcon" class="icon-btn" title="Cam√©ra">üì∑</button>
    <button id="settingsIcon" class="icon-btn" title="Param√®tres">‚öôÔ∏è</button>
  </div>

  <!-- Options panel -->
  <aside id="menu" aria-label="Param√®tres">
    <h2>Param√®tres</h2>
    <label>
      <div class="row"><span>Largeur du trait</span><span id="strokeWidthDisplay">30</span></div>
      <input type="range" id="strokeWidthSlider" min="1" max="200" value="30" />
    </label>
    <label class="toggle">
      <input type="checkbox" id="keepDrawingToggle" />
      <span>Garder le trac√©</span>
    </label>
    <button id="resetButton">R√©initialiser / Exploser les trac√©s</button>
  </aside>

  <!-- Camera / TrackyMouse panel -->
  <aside id="camMenu" aria-label="Cam√©ra">
    <h2>Cam√©ra</h2>
    <div id="trackyRoot"></div>
  </aside>

  <div class="hint">Astuce&nbsp;: faites une pause pour ¬´ rel√¢cher ¬ª le trait.</div>

  <script>
    /* ====== CONFIG ====== */
    const DWELL_RELEASE_MS = 600;   // pause pour rel√¢cher
    const MOVE_START_DIST  = 4;     // seuil pour d√©marrer un trait (px)
    const MOVE_MIN_DIST    = 1.25;  // seuil d‚Äô√©chantillonnage pendant le trait (px)
    const POINTER_SMOOTH   = 0.5;   // 0..1 (plus haut = plus r√©actif)

    /* ====== STATE ====== */
    let state = "idle";              // "idle" | "drawing" | "exploding"
    let strokePoints = [];
    let savedStrokes = [];
    let particles = [];
    let strokeHueOffset = 0;
    let started = false;
    let strokeWidth = 30;
    let keepDrawing = false;
    let menuOpen = false;

    // Pointeur t√™te (liss√©)
    let ptx = innerWidth/2, pty = innerHeight/2; // cible TrackyMouse
    let px  = ptx,          py  = pty;           // position liss√©e
    let prevPx = px, prevPy = py;                // position de la frame pr√©c√©dente
    let lastMoveT = 0;

    // DOM helpers
    const $ = sel => document.querySelector(sel);
    const headDot = $('#headDot');
    const menuEl  = $('#menu');
    const camEl   = $('#camMenu');

    /* ====== p5 Setup/Loop ====== */
    function setup() {
      createCanvas(windowWidth, windowHeight);
      pixelDensity(1);
      frameRate(60);
    }
    function windowResized(){ resizeCanvas(windowWidth, windowHeight); }

    function draw() {
      background(255);
      if (!started) return;

      // Lisser le pointeur -> mouvement plus doux
      const a = 1 - Math.pow(1-POINTER_SMOOTH, deltaTime / (1000/60));
      px += (ptx - px) * a;
      py += (pty - py) * a;

      // D√©placer le point rouge (1 style update/frame, c'est OK)
      headDot.style.transform = `translate3d(${px}px, ${py}px, 0) translate(-50%, -50%)`;

      // Distance du mouvement par rapport √† la frame pr√©c√©dente
      const movedDist = Math.hypot(px - prevPx, py - prevPy);

      // Trac√©s conserv√©s
      for (let s of savedStrokes) drawStroke(s);

      // Logique de dessin par mouvement de t√™te
      if (!menuOpen) {
        if (state === "idle" && movedDist >= MOVE_START_DIST) {
          // D√©marrage du trait
          state = "drawing";
          strokePoints = [];
          strokeHueOffset = random(360);
          lastMoveT = millis();
          strokePoints.push({x:px, y:py});
        } else if (state === "drawing") {
          if (movedDist >= MOVE_MIN_DIST) {
            strokePoints.push({x:px, y:py});
            lastMoveT = millis();
          } else {
            // Pause d√©tect√©e -> rel√¢chement
            if (millis() - lastMoveT > DWELL_RELEASE_MS) {
              if (keepDrawing) {
                savedStrokes.push([...strokePoints]);
                state = "idle";
              } else {
                state = "exploding";
                spawnExplosion(strokePoints);
              }
              strokePoints = [];
            }
          }
        }
      } else {
        if (state === "drawing") { state = "idle"; strokePoints = []; }
      }

      if (state === "drawing") drawStroke(strokePoints);
      if (state === "exploding") updateParticles();

      // M√©moriser la position pour la prochaine frame
      prevPx = px; prevPy = py;
    }

    /* ====== Stroke + Explosion ====== */
    function drawStroke(points) {
      if (points.length < 2) return;
      colorMode(HSB, 360, 100, 100, 255);
      drawingContext.shadowBlur = 10;
      for (let i = 1; i < points.length; i++) {
        let h = (strokeHueOffset + map(i, 0, points.length, 0, 360)) % 360;
        let c = color(h, 80, 100, 255);
        stroke(c);
        strokeWeight(strokeWidth);
        line(points[i - 1].x, points[i - 1].y, points[i].x, points[i].y);
        drawingContext.shadowColor = c.toString();
      }
      drawingContext.shadowBlur = 0;
      colorMode(RGB, 255);
    }

    function spawnExplosion(strokeArr) {
      if (!strokeArr || strokeArr.length === 0) { state = "idle"; return; }
      // √âchantillonnage si tr√®s long
      const maxPts = 300;
      const step = Math.max(1, Math.floor(strokeArr.length / maxPts));
      for (let idx = 0; idx < strokeArr.length; idx += step) {
        const pt = strokeArr[idx];
        for (let i = 0; i < 10; i++) particles.push(new Particle(pt.x, pt.y));
      }
    }

    function updateParticles() {
      for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].display();
        if (particles[i].isDead()) particles.splice(i, 1);
      }
      if (particles.length === 0 && state === "exploding") state = "idle";
    }

    class Particle {
      constructor(x, y) {
        this.x=x; this.y=y;
        this.vx = random(-12, 12);
        this.vy = random(-12, 12);
        this.alpha = 255;
        this.size = random(5, 15);
        this.hue  = random(360);
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.2; // gravit√©
        this.alpha -= 5;
        if (this.alpha < 0) this.alpha = 0;
      }
      display() {
        push();
        colorMode(HSB, 360, 100, 100, 255);
        noStroke();
        fill(this.hue, 80, 100, this.alpha);
        ellipse(this.x, this.y, this.size);
        pop();
      }
      isDead(){ return this.alpha <= 0; }
    }

    function explodeAllSavedStrokes() {
      if (savedStrokes.length === 0) return;
      let allPoints = [];
      for (let s of savedStrokes) allPoints = allPoints.concat(s);
      savedStrokes = [];
      state = "exploding";
      spawnExplosion(allPoints);
    }

    /* ====== Fullscreen ====== */
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => console.error("Plein √©cran:", err));
      } else {
        document.exitFullscreen();
      }
    }

    /* ====== UI events ====== */
    document.getElementById('startButton').addEventListener('click', async () => {
      started = true;
      document.getElementById('promptOverlay').style.display = 'none';
      toggleFullscreen();

      // Init TrackyMouse
      TrackyMouse.dependenciesRoot = "";
      await TrackyMouse.loadDependencies();
      TrackyMouse.init(document.getElementById('trackyRoot'));
      TrackyMouse.useCamera({
        video:{ width:{ideal:320}, height:{ideal:240}, frameRate:{ideal:12, max:12} },
        audio:false
      });
      if ('processingScale' in TrackyMouse) TrackyMouse.processingScale = 0.5;

      // MAJ de la cible du pointeur (ptx/pty) ‚Äî lissage dans draw()
      TrackyMouse.onPointerMove = (x,y) => { ptx = x; pty = y; };

      // Auto start internal button
      requestAnimationFrame(function autoBtn(){
        const b=document.querySelector('#trackyRoot .tracky-mouse-start-stop-button');
        if(b) b.click(); else requestAnimationFrame(autoBtn);
      });
    });

    // Top controls
    document.getElementById('settingsIcon').addEventListener('click', (e)=>{
      e.stopPropagation();
      menuEl.classList.toggle('visible');
      menuOpen = menuEl.classList.contains('visible');
      if (menuOpen && state === 'drawing'){ state='idle'; strokePoints=[]; }
    });
    document.getElementById('cameraIcon').addEventListener('click', (e)=>{
      e.stopPropagation();
      camEl.classList.toggle('visible');
    });
    document.getElementById('fullscreen-btn').addEventListener('click', (e)=>{
      e.stopPropagation(); toggleFullscreen();
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e)=>{
      if (menuOpen && !menuEl.contains(e.target) && e.target !== document.getElementById('settingsIcon')) {
        menuEl.classList.remove('visible'); menuOpen = false;
      }
    });
    menuEl.addEventListener('mousedown', e => e.stopPropagation());
    menuEl.addEventListener('touchstart', e => e.stopPropagation());

    // Controls
    document.getElementById('strokeWidthSlider').addEventListener('input', function(){
      strokeWidth = parseInt(this.value,10);
      document.getElementById('strokeWidthDisplay').innerText = strokeWidth;
    });
    document.getElementById('keepDrawingToggle').addEventListener('change', function(){
      keepDrawing = this.checked;
    });
    document.getElementById('resetButton').addEventListener('click', (e)=>{
      e.stopPropagation(); explodeAllSavedStrokes();
    });

    // Prevent browser scroll on touch
    window.addEventListener('touchmove', e => e.preventDefault(), {passive:false});
  </script>
</body>
</html>
