<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title data-fr="Missions Orbitales" data-en="Orbital Soundstage">Missions Orbitales</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root {
      --space-accent: #38bdf8;
      --space-accent-dark: #0ea5e9;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Poppins", "Segoe UI", sans-serif;
      background: url("../../images/rocket/rocketbackground.png") center/cover fixed #020617;
      color: #e0f2fe;
    }

    body.light { background-color:#f1f5f9; color:#0f172a; }
    body.dark  { background-color:#020617; color:#e0f2fe; }

    #langToggle {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 9999;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-weight: 700;
      letter-spacing: .06em;
      background: rgba(2,6,23,.82);
      color: #e0f2fe;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(2,132,199,.35);
    }
    body.light #langToggle {
      background: rgba(255,255,255,.95);
      color: #0369a1;
    }

    .hide-native-cursor, .hide-native-cursor * { cursor: none !important; }

    #gazePointer {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--gp-size, 40px);
      height: var(--gp-size, 40px);
      transform: translate(-50%, -50%);
      pointer-events: none;
      opacity: 0;
      z-index: 10000;
    }
    #gazePointer::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(56,189,248,.9);
      border: 3px solid rgba(226,232,240,.85);
      box-shadow: 0 0 16px rgba(56,189,248,.65);
    }
    #gazePointer.gp-dwell::before {
      animation: rocketPulse 650ms ease-in-out infinite alternate;
    }
    @keyframes rocketPulse {
      from { transform: scale(1); opacity: .8; }
      to   { transform: scale(1.18); opacity: 1; }
    }

    .options-panel {
      width: min(520px, 92vw);
      margin: 40px auto;
      background: rgba(2,6,23,.82);
      border-radius: 20px;
      padding: 24px;
      border: 2px solid rgba(56,189,248,.25);
      box-shadow: 0 28px 70px rgba(2,6,23,.65);
      backdrop-filter: blur(8px);
    }
    body.light .options-panel {
      background: rgba(255,255,255,.92);
      color: #0f172a;
      border-color: rgba(14,165,233,.4);
      box-shadow: 0 28px 70px rgba(14,165,233,.25);
    }
    .options-panel h1 {
      margin: 0 0 12px;
      font-size: clamp(1.6rem, 2.6vw, 2.1rem);
    }
    .options-panel p { margin: 0 0 18px; }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    .options-grid label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: .95rem;
    }
    .options-grid input,
    .options-grid select {
      border-radius: 12px;
      border: 2px solid rgba(148,163,184,.4);
      padding: 8px 10px;
      background: rgba(15,23,42,.55);
      color: inherit;
    }
    body.light .options-grid input,
    body.light .options-grid select {
      background: rgba(255,255,255,.95);
      border-color: rgba(14,165,233,.45);
      color: #0f172a;
    }

    .options-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      cursor: pointer;
      background: linear-gradient(135deg, var(--space-accent), var(--space-accent-dark));
      color: #f8fafc;
      box-shadow: 0 18px 40px rgba(14,165,233,.35);
    }

    .game-container {
      display: none;
      width: min(1120px, 96vw);
      margin: 0 auto 40px;
      padding: 22px 26px 40px;
      border-radius: 28px;
      background: rgba(15,23,42,.78);
      border: 2px solid rgba(56,189,248,.25);
      box-shadow: 0 30px 80px rgba(2,6,23,.75);
      backdrop-filter: blur(6px);
    }
    body.light .game-container {
      background: rgba(255,255,255,.94);
      color: #0f172a;
      border-color: rgba(14,165,233,.35);
      box-shadow: 0 32px 84px rgba(14,165,233,.28);
    }

    .top-strip {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 18px;
      margin-bottom: 22px;
      padding: 14px 18px;
      border-radius: 18px;
      background: rgba(15,23,42,.7);
      border: 2px solid rgba(56,189,248,.32);
      box-shadow: 0 16px 45px rgba(2,6,23,.65);
    }
    body.light .top-strip {
      background: rgba(255,255,255,.96);
      border-color: rgba(14,165,233,.35);
      box-shadow: 0 18px 45px rgba(14,165,233,.25);
    }

    .mission-card {
      position: relative;
      width: clamp(110px, 16vw, 150px);
      aspect-ratio: 1;
      border-radius: 20px;
      border: 2px solid rgba(56,189,248,.4);
      background: radial-gradient(circle at 50% 30%, rgba(56,189,248,.6), rgba(2,6,23,.85));
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .mission-card img {
      width: 78%;
      height: 78%;
      object-fit: contain;
      transition: transform 320ms ease, filter 320ms ease;
    }
    .mission-card.launch img { transform: translateY(-6px) scale(1.12); filter: drop-shadow(0 14px 18px rgba(56,189,248,.45)); }

    .prompt-text h2 { margin: 0; font-size: clamp(1.4rem, 2.6vw, 2.2rem); }
    .prompt-text span { display:block; margin-top:4px; font-size: clamp(.95rem, 1.8vw, 1.1rem); opacity:.85; }

    .progress-chip {
      justify-self: end;
      background: rgba(56,189,248,.18);
      border: 2px solid rgba(56,189,248,.4);
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      min-width: 130px;
      text-align: center;
    }
    body.light .progress-chip {
      background: rgba(14,165,233,.12);
      border-color: rgba(14,165,233,.45);
      color: #0369a1;
    }

    .grid-outer { display:flex; justify-content:center; }

    .number-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(90px, 1fr));
      gap: clamp(14px, 3vw, 24px);
      width: 100%;
    }

    .number-cell {
      position: relative;
      border-radius: 22px;
      background: rgba(2,6,23,.68);
      border: 2px solid rgba(56,189,248,.32);
      color: #bae6fd;
      font-size: clamp(2.2rem, 6vw, 3.8rem);
      font-weight: 800;
      display: grid;
      place-items: center;
      padding: clamp(14px, 4vw, 24px);
      overflow: hidden;
      cursor: pointer;
      transition: transform 240ms ease, box-shadow 240ms ease;
      text-shadow: 0 10px 24px rgba(2,6,23,.65);
    }
    body.light .number-cell {
      background: rgba(255,255,255,.9);
      color: #0f172a;
      border-color: rgba(14,165,233,.35);
      text-shadow: none;
    }

    .number-cell figure {
      position: absolute;
      inset: 0;
      margin: 0;
      opacity: .2;
      pointer-events: none;
    }
    .number-cell figure img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .number-cell .badge { position: relative; z-index: 2; }

    .number-cell.correct {
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(165,243,252,.85));
      color: #0f172a;
      box-shadow: 0 22px 50px rgba(56,189,248,.45);
    }

    .number-cell.wrong {
      box-shadow: 0 0 0 3px rgba(248,113,113,.65);
    }

    .dwell-fill {
      position: absolute;
      inset: 6px;
      border-radius: 18px;
      background: rgba(56,189,248,.3);
      width: 0;
      height: 0;
    }

    .rocket-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      min-height: 36px;
    }
    .rocket-row img {
      width: clamp(26px, 5vw, 40px);
      filter: drop-shadow(0 6px 12px rgba(56,189,248,.45));
      transition: transform 300ms ease;
    }
    .rocket-row.launch img { transform: translateY(-6px); }

    .hidden { display:none !important; }

    @media (max-width: 680px) {
      .top-strip { grid-template-columns: 1fr; text-align: center; }
      .progress-chip { justify-self: center; }
      .number-grid { grid-template-columns: repeat(2, minmax(90px, 1fr)); }
    }
  </style>
</head>
<body class="dark">
  <button id="langToggle" data-fr="EN" data-en="FR">EN</button>

  <section id="gameOptions" class="options-panel">
    <h1 data-fr="Missions Orbitales" data-en="Orbital Soundstage">Missions Orbitales</h1>
    <p data-fr="Lance des fusées musicales tout en repérant les bons chiffres."
       data-en="Launch musical rockets while spotting the right numbers.">
      Lance des fusées musicales tout en repérant les bons chiffres.
    </p>

    <div class="options-grid">
      <label>
        <span data-fr="Chiffres par grille" data-en="Numbers per grid">Chiffres par grille</span>
        <select id="gridSize" class="compact-field">
          <option value="6">6</option>
          <option value="8">8</option>
          <option value="9" selected>9</option>
          <option value="12">12</option>
        </select>
      </label>
      <label>
        <span data-fr="Temps de fixation (ms)" data-en="Dwell time (ms)">Temps de fixation (ms)</span>
        <input type="range" id="dwellTimeSlider" min="700" max="2200" step="100" value="1500" />
        <small><span id="dwellTimeVal">1500</span> ms</small>
      </label>
      <label>
        <span data-fr="Volume des effets" data-en="Effects volume">Volume des effets</span>
        <input type="range" id="sfxVol" min="0" max="100" value="60" />
        <small><span id="sfxVolVal">60</span>%</small>
      </label>
      <label>
        <span data-fr="Activer la voix" data-en="Enable voice">Activer la voix</span>
        <input type="checkbox" id="ttsEnabled" checked />
      </label>
      <label>
        <span data-fr="Couper les sons" data-en="Mute sounds">Couper les sons</span>
        <input type="checkbox" id="muteSFX" />
      </label>
      <label>
        <span data-fr="Afficher le pointeur" data-en="Show gaze pointer">Afficher le pointeur</span>
        <input type="checkbox" id="showGazePointer" checked />
      </label>
    </div>

    <div class="options-actions">
      <button class="btn-primary" id="startBtn" data-fr="Décollage" data-en="Launch">Décollage</button>
    </div>
  </section>

  <section class="game-container" id="gameContainer">
    <div class="top-strip">
      <div class="mission-card" id="missionCard">
        <img id="missionImage" src="../../images/rocket/rocket1.png" alt="Fusée" />
      </div>
      <div class="prompt-text">
        <h2 id="promptLine">Trouve le nombre</h2>
        <span id="promptHint">Prépare la piste de lancement musicale.</span>
        <div class="rocket-row" id="rocketRow"></div>
      </div>
      <div class="progress-chip" id="progressChip">0 / 10</div>
    </div>

    <div class="grid-outer">
      <div class="number-grid" id="numberGrid"></div>
    </div>
  </section>

  <div id="gazePointer"></div>

  <script src="../../js/eyegaze-menu.js"></script>
  <script>
    const digits = "0123456789".split("");
    const rocketVariants = [
      { labelFr: "Fusée", labelEn: "Rocket", img: "rocket1.png" },
      { labelFr: "Navette", labelEn: "Shuttle", img: "rocket2.png" },
      { labelFr: "Propulseur", labelEn: "Booster", img: "rocket3.png" },
      { labelFr: "Orbite", labelEn: "Orbiter", img: "rocket4.png" },
      { labelFr: "Astronef", labelEn: "Starship", img: "rocket5.png" },
      { labelFr: "Sonde", labelEn: "Probe", img: "rocket6.png" },
      { labelFr: "Comète", labelEn: "Comet", img: "rocket7.png" }
    ];
    const rocketMedia = {};

    digits.forEach((digit, idx) => {
      const variant = rocketVariants[idx % rocketVariants.length];
      rocketMedia[digit] = {
        img: `../../images/rocket/${variant.img}`,
        labelFr: `${variant.labelFr} ${digit}`,
        labelEn: `${variant.labelEn} ${digit}`
      };
    });

    const promptLine = document.getElementById('promptLine');
    const promptHint = document.getElementById('promptHint');
    const rocketRow = document.getElementById('rocketRow');
    const missionCard = document.getElementById('missionCard');
    const missionImage = document.getElementById('missionImage');
    const progressChip = document.getElementById('progressChip');
    const numberGrid = document.getElementById('numberGrid');
    const startBtn = document.getElementById('startBtn');
    const gameOptions = document.getElementById('gameOptions');
    const gameContainer = document.getElementById('gameContainer');
    const gridSizeSelect = document.getElementById('gridSize');
    const dwellSlider = document.getElementById('dwellTimeSlider');
    const dwellVal = document.getElementById('dwellTimeVal');
    const sfxSlider = document.getElementById('sfxVol');
    const sfxVal = document.getElementById('sfxVolVal');
    const muteSFX = document.getElementById('muteSFX');
    const ttsEnabled = document.getElementById('ttsEnabled');
    const showGazePointer = document.getElementById('showGazePointer');
    const langToggle = document.getElementById('langToggle');
    const gazePointer = document.getElementById('gazePointer');

    let lang = localStorage.getItem('siteLanguage') || 'fr';
    let missionQueue = [];
    let currentIndex = -1;
    let currentDigit = null;
    let rounds = 0;
    let hoverTimeout = null;
    let activeCell = null;
    let currentOverlay = null;
    let isReady = false;
    let bgMusic = null;
    const audioCache = new Map();

    function shuffle(array) {
      const clone = [...array];
      for (let i = clone.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [clone[i], clone[j]] = [clone[j], clone[i]];
      }
      return clone;
    }

    function getDwellTime() {
      return (window.eyegazeSettings?.dwellTime) || parseInt(dwellSlider.value, 10) || 1500;
    }

    function updateLangTexts() {
      const isFr = lang === 'fr';
      document.querySelectorAll('[data-fr]').forEach(el => {
        const fr = el.getAttribute('data-fr');
        const en = el.getAttribute('data-en');
        if (!fr || !en) return;
        el.textContent = isFr ? fr : en;
      });
      langToggle.textContent = isFr ? 'EN' : 'FR';
      document.body.classList.toggle('light', !isFr);
      document.body.classList.toggle('dark', isFr);
      refreshPrompt();
    }

    function renderRocketRow(count) {
      rocketRow.innerHTML = '';
      if (count === 0) {
        const img = document.createElement('img');
        img.src = '../../images/rocket/rocketsatellite.png';
        img.alt = lang === 'fr' ? 'Satellite' : 'Satellite';
        rocketRow.appendChild(img);
        return;
      }
      for (let i = 0; i < count; i++) {
        const rocket = document.createElement('img');
        rocket.src = '../../images/rocket/rocketfuel.png';
        rocket.alt = lang === 'fr' ? 'Fusée' : 'Rocket';
        rocketRow.appendChild(rocket);
      }
    }

    function refreshPrompt() {
      if (!currentDigit) return;
      const media = rocketMedia[currentDigit];
      const isFr = lang === 'fr';
      promptLine.textContent = isFr ? `Trouve le nombre ${currentDigit}` : `Find the number ${currentDigit}`;
      promptHint.textContent = isFr ? `Mission ${media.labelFr}` : `Mission ${media.labelEn}`;
      missionImage.src = media.img;
      missionImage.alt = isFr ? media.labelFr : media.labelEn;
      renderRocketRow(parseInt(currentDigit, 10));
    }

    function playBgMusic() {
      if (bgMusic || muteSFX.checked) return;
      bgMusic = new Audio('../../songs/space/spacequest2.mp3');
      bgMusic.loop = true;
      bgMusic.volume = (parseInt(sfxSlider.value, 10) || 60) / 100;
      bgMusic.play().catch(() => {});
    }

    function stopBgMusic() {
      if (bgMusic) {
        bgMusic.pause();
        bgMusic = null;
      }
    }

    function playSfx(src) {
      if (muteSFX.checked) return;
      const vol = (window.eyegazeSettings?.sfxVolume ?? parseInt(sfxSlider.value, 10) ?? 60) / 100;
      let audio = audioCache.get(src);
      if (!audio) {
        audio = new Audio(src);
        audioCache.set(src, audio);
      }
      audio.currentTime = 0;
      audio.volume = vol;
      audio.play().catch(() => {});
    }

    function speak(text) {
      if (!ttsEnabled.checked) return;
      if (!('speechSynthesis' in window)) return;
      try {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang === 'fr' ? 'fr-FR' : 'en-US';
        utterance.rate = 1.0;
        window.speechSynthesis.speak(utterance);
      } catch (e) {}
    }

    function updateProgress() {
      const target = missionQueue.length || digits.length;
      progressChip.textContent = `${rounds} / ${target}`;
    }

    function buildMissionQueue() {
      missionQueue = shuffle(digits);
      currentIndex = -1;
      rounds = 0;
      updateProgress();
    }

    function buildGrid(values) {
      numberGrid.innerHTML = '';
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      values.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'number-cell';
        cell.dataset.digit = num;

        const fig = document.createElement('figure');
        const img = document.createElement('img');
        img.src = rocketMedia[num].img;
        img.alt = '';
        fig.appendChild(img);
        cell.appendChild(fig);

        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = num;
        cell.appendChild(badge);

        cell.addEventListener('mouseenter', () => startHover(cell));
        cell.addEventListener('mouseleave', stopHover);
        cell.addEventListener('click', () => handleSelection(cell));
        cell.addEventListener('touchstart', () => startHover(cell));
        cell.addEventListener('touchend', stopHover);

        if (!reduceMotion) {
          cell.style.transform = 'scale(0.92)';
          requestAnimationFrame(() => {
            cell.style.transition = 'transform 280ms ease';
            cell.style.transform = 'scale(1)';
          });
        }

        numberGrid.appendChild(cell);
      });
    }

    function nextRound() {
      if (missionQueue.length === 0) buildMissionQueue();
      currentIndex++;
      if (currentIndex >= missionQueue.length) {
        buildMissionQueue();
        currentIndex = 0;
      }
      currentDigit = missionQueue[currentIndex];
      const count = parseInt(gridSizeSelect.value, 10) || 9;
      const filler = shuffle(digits.filter(d => d !== currentDigit)).slice(0, Math.max(count - 1, 0));
      const pool = shuffle([currentDigit, ...filler]);
      buildGrid(pool);
      refreshPrompt();
      const phrase = lang === 'fr' ? `Trouve le nombre ${currentDigit}` : `Find the number ${currentDigit}`;
      speak(phrase);
      isReady = true;
    }

    function startHover(cell) {
      if (!isReady) return;
      if (activeCell === cell) return;
      stopHover();
      activeCell = cell;
      const overlay = document.createElement('div');
      overlay.className = 'dwell-fill';
      cell.appendChild(overlay);
      currentOverlay = overlay;

      const dwellTime = getDwellTime();
      requestAnimationFrame(() => {
        overlay.style.transition = `width ${dwellTime}ms linear, height ${dwellTime}ms linear`;
        overlay.style.width = '100%';
        overlay.style.height = '100%';
      });
      if (gazePointer) gazePointer.classList.add('gp-dwell');

      hoverTimeout = setTimeout(() => {
        handleSelection(cell);
      }, dwellTime);
    }

    function stopHover() {
      clearTimeout(hoverTimeout);
      hoverTimeout = null;
      if (currentOverlay && currentOverlay.parentElement) {
        currentOverlay.parentElement.removeChild(currentOverlay);
      }
      currentOverlay = null;
      activeCell = null;
      if (gazePointer) gazePointer.classList.remove('gp-dwell');
    }

    function wrongFeedback(cell) {
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (reduce || !cell.animate) {
        cell.classList.add('wrong');
        setTimeout(() => cell.classList.remove('wrong'), 300);
        return;
      }
      cell.animate([
        { transform: 'translateX(0)' },
        { transform: 'translateX(-10px)' },
        { transform: 'translateX(9px)' },
        { transform: 'translateX(-6px)' },
        { transform: 'translateX(0)' }
      ], { duration: 360, easing: 'ease-out' });
      const prev = cell.style.boxShadow;
      cell.style.boxShadow = '0 0 0 3px rgba(248,113,113,.65)';
      setTimeout(() => { cell.style.boxShadow = prev || ''; }, 360);
    }

    function celebrate(cell) {
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      cell.classList.add('correct');
      if (!reduce) {
        cell.animate([
          { transform: 'scale(1)' },
          { transform: 'scale(1.08)' },
          { transform: 'scale(1)' }
        ], { duration: 420, easing: 'ease-out' });
        missionCard.classList.add('launch');
        rocketRow.classList.add('launch');
        setTimeout(() => {
          missionCard.classList.remove('launch');
          rocketRow.classList.remove('launch');
        }, 420);
      }
      const phrase = lang === 'fr'
        ? `Bravo, lancement ${rocketMedia[currentDigit].labelFr}!`
        : `Great job, launch ${rocketMedia[currentDigit].labelEn}!`;
      speak(phrase);
      playSfx('../../sounds/rocket/rocketlaunch.mp3');
      playSfx('../../sounds/rocket/rocketrumble.mp3');
    }

    function handleSelection(cell) {
      if (!isReady || !cell) return;
      stopHover();
      const digit = cell.dataset.digit;
      if (digit !== currentDigit) {
        wrongFeedback(cell);
        playSfx('../../sounds/rocket/rocketfuel.mp3');
        return;
      }
      isReady = false;
      celebrate(cell);
      rounds = Math.min(rounds + 1, digits.length);
      updateProgress();
      setTimeout(() => {
        nextRound();
      }, 950);
    }

    function updatePointerVisibility() {
      const visible = showGazePointer.checked;
      if (visible) {
        document.body.classList.add('hide-native-cursor');
        gazePointer.style.opacity = '1';
      } else {
        document.body.classList.remove('hide-native-cursor');
        gazePointer.style.opacity = '0';
      }
    }

    document.addEventListener('pointermove', e => {
      if (!showGazePointer.checked) return;
      gazePointer.style.left = `${e.clientX}px`;
      gazePointer.style.top = `${e.clientY}px`;
    });

    langToggle.addEventListener('click', () => {
      lang = lang === 'fr' ? 'en' : 'fr';
      localStorage.setItem('siteLanguage', lang);
      updateLangTexts();
    });

    startBtn.addEventListener('click', () => {
      playBgMusic();
      buildMissionQueue();
      nextRound();
      gameOptions.classList.add('hidden');
      gameContainer.style.display = 'block';
      updateProgress();
      if (window.eyegazeSettings?.hideOverlay) {
        try { window.eyegazeSettings.hideOverlay(); } catch (e) {}
      }
    });

    dwellSlider.addEventListener('input', e => {
      dwellVal.textContent = e.target.value;
      if (window.eyegazeSettings) window.eyegazeSettings.dwellTime = parseInt(e.target.value, 10);
    });

    sfxSlider.addEventListener('input', e => {
      const val = parseInt(e.target.value, 10) || 60;
      sfxVal.textContent = val;
      if (bgMusic) bgMusic.volume = val / 100;
      if (window.eyegazeSettings) window.eyegazeSettings.sfxVolume = val;
    });

    muteSFX.addEventListener('change', () => {
      if (muteSFX.checked) stopBgMusic();
      else playBgMusic();
      if (window.eyegazeSettings) window.eyegazeSettings.sfxMuted = muteSFX.checked;
    });

    showGazePointer.addEventListener('change', updatePointerVisibility);

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopBgMusic();
      else if (!muteSFX.checked && gameContainer.style.display === 'block') playBgMusic();
    });

    window.addEventListener('beforeunload', stopBgMusic);

    function init() {
      updateLangTexts();
      updatePointerVisibility();
      dwellVal.textContent = dwellSlider.value;
      sfxVal.textContent = sfxSlider.value;
      if (window.initEyegazeMenu) initEyegazeMenu();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
