<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Porte-monnaie élève</title>
<style>
:root{
  --bg-angle : 180deg;
  --bg-start : #ffffff;
  --bg-end   : #d9ecff;
  --sidePad  : 100px;
  --coinSize : 90px;
  --coinFont : 1.8rem;
  --gold: #d4af37;
  --gold-dark: #b78a2c;
  --gold-light: #f6e27a;
  --green:#2e7d32; --red:#ff0000; --border:transparent;
  --f-base:1.8rem; --lh-base:1.2;
}
body.hc{--green:#007700;--red:#b90000;--border:#fff;}
body.readable{--f-base:2.2rem;--lh-base:1.5;}
html,body{
  height:100%;
  margin:0;
  font-family:Roboto,sans-serif;
  background:linear-gradient(var(--bg-angle),var(--bg-start)0%,var(--bg-end)100%);
}
body {font-size:var(--f-base);line-height:var(--lh-base);}
#adminBtn {
  position:fixed;left:28px;bottom:36px;
  z-index:2600;width:60px;height:60px;border-radius:50%;background:#4a2c49;
  color:#fff;border:none;box-shadow:0 2px 10px rgba(0,0,0,0.12);
  font-size:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer;
  transition:box-shadow .18s;
}
#adminBtn:active { box-shadow: 0 1px 2px #0002;}
#adminPinPanel {
  display: none;
  position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
  width:300px;max-width:96vw;height:auto;
  background: #fff;box-shadow: 2px 8px 20px rgba(0,0,0,0.18);z-index: 5100;
  border-radius:16px;
  flex-direction: column;align-items: center;justify-content: center;
  padding: 30px 22px 20px 22px;
}
#adminPinPanel.open { display: flex; }
#adminPinClose {
  position:absolute;top:18px;right:18px;background:transparent;border:none;font-size:2.1rem;opacity:.44;cursor:pointer;color:#333;
}
#pinDots {display:flex;justify-content:center;gap:12px;margin-bottom:14px;font-size:2.2rem;}
#pinDots .dot {width:24px;height:24px;border-radius:50%;background:#eee;display:inline-block;box-shadow:0 2px 7px 0 #0002;transition:.1s;}
#pinDots .dot.filled { background:#333; }
#pinDots .dot.wrong { background:var(--red); }
#pinMsg {min-height:28px;color:var(--red);font-size:1.07rem;text-align:center;margin-bottom:4px;margin-top:0;}
#pinKeypad {
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px;
}
.pinbtn {
  background:#fafaf8;
  border:1px solid #e7e7e9;
  border-radius:8px;
  font-size:1.3rem;
  padding:18px 0;
  text-align:center;
  cursor:pointer;
  transition:.13s;
  user-select:none;
}
.pinbtn:active { background:#e2e2f1; }
#pinBtnClear { color:#888;font-size:1.1rem;}
#pinBtnOk { background:#244774;color:#fff;border:none;font-weight:600; }
#pinBtnSet {
  width:100%;padding:9px 0;background:#f5f3f8;border-radius:7px;margin-top:7px;border:1px solid #ece6fa;font-size:1.07rem;cursor:pointer;
  display:none;
}
#adminPanelModal {
  position: fixed;left:0;right:0;bottom:0;
  width:100vw;
  height: 30vh;
  min-height:120px; max-height:400px;
  background: #fff;box-shadow: 0 -4px 40px 0 #0005;
  z-index:5100;
  border-top-left-radius:20px;border-top-right-radius:20px;
  transform: translateY(110%);
  transition: transform .35s cubic-bezier(.42,1.41,.36,1.08);
  pointer-events:none;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
}
#adminPanelModal.open {transform: translateY(0);pointer-events:auto;}
.admin-panel-content {
  width:100vw;max-width:920px;
  padding:18px 10px 10px 10px;box-sizing: border-box;margin:auto;
  display:flex;flex-direction:row;align-items:center;justify-content:center;gap:26px;
}
.admin-option-section {display:flex;align-items:center;gap:14px;}
#dragCoinArea {display:flex;align-items:center;gap:10px;}
#draggableCoin {
  width:62px;height:62px;background:radial-gradient(circle at 30% 30%, #f6e27a 60%, #d4af37 90%, #b78a2c 100%);
  border-radius:50%;box-shadow:0 3px 12px 0 rgba(160,120,0,0.14);
  border:4px solid #b78a2c;display:flex;align-items:center;justify-content:center;
  cursor:grab;font-size:1.55rem;font-family:'Georgia',serif;user-select:none;transition:.13s;z-index:20;position:relative;
}
.admin-option-btn {
  padding: 0.8rem 1.3rem;
  border-radius: 8px;background: #f6f7f8;border: 1px solid #e4e2ef;
  font-size: 1.17rem;color: #333;cursor: pointer;text-align: left;transition: background .14s;
  margin:0 8px;
}
.admin-option-btn:hover {background: #e9e6f8;}
#closeAdminPanel {
  font-size: 2rem;font-weight: 400;opacity: 0.45;right: 16px;top: 14px;
  position: absolute;background:transparent;border:none;color:#333;cursor:pointer;
}
#walletDropArea {
  border: 3px solid #111;
  border-radius: 24px;
  background:rgba(0,0,0,0.02);
  padding: 32px 30px 24px 30px;
  margin-bottom: 30px;
  transition: box-shadow .18s, border-color .15s;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  min-width: 800px;
  max-width: 98vw;
  gap: 2.2rem;
}
#walletDropArea.droptarget {
  box-shadow:0 0 0 8px #25cb28aa;
  border-color:#25cb28;
}
@media (max-width: 1000px) {
  #walletDropArea { min-width: 0; padding: 16px 4vw;}
}
.main-content {margin-left: 0;min-height: 100vh;display: flex;justify-content: center;align-items: center;}
.rows{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2.5rem;transform:translateY(5vh);}
.wallet{display:grid;grid-template-columns:repeat(10,1fr);gap:1rem;max-width:90vw;}
.wallet > * {box-sizing: border-box;margin: 0;justify-self: center;align-self: center;}
.coin {width: var(--coinSize);height: var(--coinSize);border-radius: 50%;display: flex;align-items: center;justify-content: center;font-size: var(--coinFont);user-select: none;transition:transform .15s,box-shadow .15s;font-family: 'Georgia', serif;border: 4px solid var(--gold-dark);background: radial-gradient(circle at 30% 30%, var(--gold-light) 55%, var(--gold) 90%, var(--gold-dark) 100%);color: #fff9e2;box-shadow: 0 3px 12px 0 rgba(160,120,0,0.07);position: relative;cursor: pointer;}
.coin.selected{transform:translateY(-8px) scale(1.1);box-shadow:0 0 0 6px rgba(212,175,55,0.18);}
.coin:active{transform:translateY(-4px) scale(1.05);}
.coin.placeholder {background: transparent;border: none;pointer-events: none;box-shadow: none;color: transparent;}
.counter {width: var(--coinSize);height: var(--coinSize);border-radius: 9px;display: flex;align-items: center;justify-content: center;font-size: calc(var(--coinFont) + 0.25rem);font-weight: 700;user-select: none;margin: 0;transition: background .12s, color .12s, border .12s;border: 3px solid #eee;background: #f6f7f8;color: #444;}
.counter.good {background: var(--green);color: #fff;border-color: var(--green);}
.counter.bad {background: var(--red);color: #fff;border-color: var(--red);opacity: 0.7;}
#userName{position:fixed;top:8vh;left:50%;transform:translateX(-50%);font-size:3rem;font-weight:700;text-transform:uppercase;color:#333;z-index:2600;pointer-events:none;}
#startOverlay{position:fixed;inset:0;background:#000;z-index:3000;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-align:center;}
#startOverlay h1{font-size:2.2rem;margin-bottom:1.5rem;}
#startBtn{padding:1.1rem 2.4rem;font-size:1.3rem;border:none;border-radius:10px;background:#008080;color:#fff;cursor:pointer;}
#startBtn:hover{background:#009d9d;}
#priceZone{margin-top:4rem;display:flex;flex-direction:column;align-items:center;}
#priceTag{font-size:1.5rem;margin-bottom:1.5rem;}
#payBtn{padding:1rem 3rem;font-size:2.1rem;border:none;border-radius:12px;background:#c65629;color:#fff;cursor:pointer;}
.modalBox{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:320px;background:#fff;border:2px solid teal;padding:20px;border-radius:10px;z-index:4000;text-align:center;}
.modalBox p{margin:0 0 15px;font-size:1.4rem;}
.modalBox input{width:100%;padding:10px;margin:10px 0;font-size:1.2rem;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;}
.modalBtnRow{display:flex;gap:10px;justify-content:center;margin-top:10px;}
.modalBtnRow button{flex:1;padding:10px;font-size:1rem;border:none;border-radius:6px;cursor:pointer;}
.btnPrimary{background:teal;color:#fff;}
.btnSecondary{background:#ccc;}
#priceModal {
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:340px;max-width:96vw;background:#fff;border:2px solid teal;padding:24px 18px 18px 18px;border-radius:14px;z-index:4000;text-align:center;
}
#priceDollarGrid {
  display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:1rem;justify-items:center;
}
#priceDollarGrid button, #priceCentGrid button {
  min-width:52px;padding:12px 0;margin:0;border-radius:8px;border:1.7px solid #e2e2e2;background:#f7f6fb;
  font-size:1.18rem;cursor:pointer;transition:.11s;
}
#priceDollarGrid button.selected, #priceCentGrid button.selected {
  background:var(--green);color:#fff;border-color:var(--green);
}
#priceCentGrid {display:flex;gap:7px;justify-content:center;margin-bottom:1.2rem;}
#pricePreview {font-size:1.15rem;margin-bottom:1.4rem;}
@keyframes shakeX16{0%,100%{transform:translateX(0)}
  15%,45%,75%{transform:translateX(-16px)}30%,60%,90%{transform:translateX(16px)}}
@keyframes denyCoin{0%{transform:translateX(0)}
  25%{transform:translateX(-8px)}50%{transform:translateX(8px)}
  75%{transform:translateX(-8px)}100%{transform:translateX(0)}}
</style>
</head>
<body>

<div id="userName"></div>
<div id="startOverlay"><h1>Paiement prudent</h1><button id="startBtn">COMMENCER</button></div>

<button id="adminBtn" title="Admin">
  <svg viewBox="0 0 24 24" style="width:32px;height:32px;stroke:#fff;stroke-width:2;fill:none;">
    <circle cx="12" cy="8" r="4"/><path d="M2 22c0-4 4-7 10-7s10 3 10 7"/>
  </svg>
</button>

<div id="adminPinPanel">
  <button id="adminPinClose" title="Fermer">×</button>
  <div style="width:200px;max-width:90vw;">
    <div style="font-weight:600;margin-bottom:16px;text-align:center;">Entrer le code admin</div>
    <div id="pinMsg"></div>
    <div id="pinDots">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <div id="pinKeypad"></div>
    <button id="pinBtnSet">Créer un code admin</button>
  </div>
</div>

<div id="adminPanelModal">
  <div class="admin-panel-content">
    <button id="closeAdminPanel" title="Fermer">×</button>
    <div class="admin-option-section">
      <div id="dragCoinArea">
        <div id="draggableCoin" tabindex="0" aria-label="Ajouter une pièce de 1$">1$</div>
      </div>
      <button id="setPriceBtn" class="admin-option-btn">Fixer le prix</button>
      <button id="resetPwdBtn" class="admin-option-btn">Réinitialiser le code admin</button>
    </div>
  </div>
</div>

<div class="main-content">
  <div class="rows">
    <div id="walletDropArea">
      <div class="wallet" id="coinsRow"></div>
      <div class="wallet" id="countRow"></div>
    </div>
    <div id="priceZone">
      <div id="priceTag"></div>
      <button id="payBtn">PAYER</button>
    </div>
  </div>
</div>

<div id="setupModal" class="modalBox">
  <p>Paramétrage initial</p>
  <input id="setupName" placeholder="Prénom (optionnel)">
  <div class="modalBtnRow"><button id="setupOk" class="btnPrimary">OK</button></div>
</div>

<div id="priceModal">
  <p style="margin-bottom:1rem;">Choisissez le prix</p>
  <div id="priceDollarGrid"></div>
  <div id="priceCentGrid"></div>
  <div id="pricePreview"></div>
  <div class="modalBtnRow">
    <button id="priceConfirm" class="btnPrimary">OK</button>
    <button id="priceCancel" class="btnSecondary">Annuler</button>
  </div>
</div>

<div id="alertModal"   class="modalBox"><p id="alertMsg"></p><div class="modalBtnRow"><button id="alertOk" class="btnPrimary">OK</button></div></div>
<div id="confirmModal" class="modalBox"><p id="confirmMsg"></p><div class="modalBtnRow"><button id="confirmYes" class="btnPrimary">Oui</button><button id="confirmNo" class="btnSecondary">Non</button></div></div>

<script>
const $=id=>document.getElementById(id);
const stored= parseFloat(localStorage.getItem('itemPrice'));
let price = isNaN(stored)?1:+stored.toFixed(2);
let coins = +localStorage.getItem('studentCoins')||0;
let adminPin=(localStorage.getItem('adminPin')||'').trim()||'1234';
let studentName=(localStorage.getItem('studentName')||'').trim();
const selected=new Set();
const BACKUP_PIN = "8204";

function show(el){el.style.display='flex';}
function hide(el){el.style.display='none';}
function alertBox(msg,cb){$('alertMsg').textContent=msg;show($('alertModal'));$('alertOk').onclick=()=>{hide($('alertModal'));cb&&cb();};}
function confirmBox(msg,yes){$('confirmMsg').textContent=msg;show($('confirmModal'));
  $('confirmYes').onclick=()=>{hide($('confirmModal'));yes();};
  $('confirmNo').onclick=()=>hide($('confirmModal'));}

const isiIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;
function enterFS(){if(isiIOS||document.fullscreenElement)return;document.documentElement.requestFullscreen?.().catch(()=>{});}
function displayName(){if(studentName)$('userName').textContent=studentName.toUpperCase();}
const payNeeded=()=>Math.ceil(price);

/* ---------- setup initial ---------- */
function openSetup(){show($('setupModal'));$('setupName').focus();}
$('setupOk').onclick=()=>{
  const n=$('setupName').value.trim();
  if(n){studentName=n;localStorage.setItem('studentName',studentName);displayName();}
  localStorage.setItem('setupDone','1');hide($('setupModal'));enterFS();
};

/* ---------- construction pièces ---------- */
for(let i=0;i<10;i++){
  const coin=document.createElement('div');coin.className='circle coin placeholder';coin.dataset.idx=i;
  coin.addEventListener('pointerdown',toggleSelect);$('coinsRow').appendChild(coin);
  const nb=document.createElement('div');nb.className='counter bad';nb.textContent=i+1;$('countRow').appendChild(nb);
}

/* ---------- responsive pièces ---------- */
function updateCoinVars(){
  const gap=parseFloat(getComputedStyle(document.documentElement).fontSize);
  const avail=window.innerWidth-parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sidePad'))-20;
  const border=8;let s=Math.floor((avail-gap*9-border*10)/10);
  s=Math.max(Math.min(s,90),50);
  document.documentElement.style.setProperty('--coinSize',s+'px');
  document.documentElement.style.setProperty('--coinFont',(s*0.22)+'px');
}
window.addEventListener('resize',()=>{updateCoinVars();render();});
updateCoinVars();

function deny(el){el.style.animation='denyCoin .4s';setTimeout(()=>{el.style.animation='';},400);}
function toggleSelect(e){
  const idx=+e.currentTarget.dataset.idx;
  if(idx>=coins){deny(e.currentTarget);return;}
  selected.has(idx)?selected.delete(idx):selected.add(idx);render();
}

function render(){
  [...$('coinsRow').children].forEach((el,i)=>{
    if(i<coins){
      let cls='circle coin'; if(selected.has(i))cls+=' selected';
      el.className=cls;el.textContent='1$';
    }else{
      el.className='circle coin placeholder';el.textContent='';
    }
  });
  [...$('countRow').children].forEach((el,i)=>{
    el.className='counter '+(i<coins?'good':'bad');
  });
  $('priceTag').textContent=`Prix : ${price.toFixed(2)} $`;
  $('payBtn').classList.toggle('dim',selected.size<payNeeded());
}
function save(){localStorage.setItem('studentCoins',coins);localStorage.setItem('itemPrice',price.toFixed(2));}
function saveRender(){save();selected.clear();render();}
render();

$('payBtn').onclick=()=>{
  if(selected.size<payNeeded()){
    $('payBtn').style.animation='shakeX16 .6s';setTimeout(()=>{$('payBtn').style.animation='';selected.clear();render();},600);
    return;
  }
  coins-=payNeeded();
  [...selected].sort((a,b)=>a-b).slice(0,payNeeded()).forEach(i=>selected.delete(i));
  saveRender();
};

/* ---------- Admin PIN Panel (virtual keypad, centered modal) ---------- */
const adminBtn = document.getElementById('adminBtn');
const adminPanelModal = document.getElementById('adminPanelModal');
const closeAdminPanelBtn = document.getElementById('closeAdminPanel');
const adminPinPanel = document.getElementById('adminPinPanel');
const adminPinClose = document.getElementById('adminPinClose');
const pinDots = document.getElementById('pinDots');
const pinMsg = document.getElementById('pinMsg');
const pinKeypad = document.getElementById('pinKeypad');
const pinBtnSet = document.getElementById('pinBtnSet');
let pinEntry = '';
let setPinSetMode = false;
function showPinPanel(setMode=false) {
  pinEntry = '';
  pinMsg.textContent = '';
  renderPinDots();
  pinBtnSet.style.display = setMode ? 'block' : 'none';
  adminPinPanel.classList.add('open');
  adminPinPanel.style.display = 'flex';
  setPinSetMode = setMode;
}
function hidePinPanel() {
  adminPinPanel.classList.remove('open');
  setTimeout(()=>{adminPinPanel.style.display='none';},300);
  pinEntry = '';
  setPinSetMode = false;
}
function renderPinDots(error) {
  const dots = pinDots.querySelectorAll('.dot');
  for(let i=0; i<dots.length; i++) {
    dots[i].className = 'dot';
    if(error && i<pinEntry.length) dots[i].classList.add('wrong');
    else if(i<pinEntry.length) dots[i].classList.add('filled');
  }
}
function unlockAdminPanel() {
  hidePinPanel();
  openAdminPanel();
}
function openAdminPanel() {
  adminPanelModal.classList.add('open');
}
function closeAdminPanelFunc() {
  adminPanelModal.classList.remove('open');
}
adminBtn.onclick = () => {
  if (adminPanelModal.classList.contains('open')) {
    closeAdminPanelFunc();
    return;
  }
  showPinPanel(adminPin === '');
  adminPinPanel.style.display = 'flex';
};
closeAdminPanelBtn.onclick = closeAdminPanelFunc;
adminPinClose.onclick = hidePinPanel;

pinBtnSet.onclick = () => {
  if(pinEntry.length < 4) {
    pinMsg.textContent = '4 chiffres minimum';
    renderPinDots(true);
    setTimeout(()=>{renderPinDots();},800);
    return;
  }
  adminPin = pinEntry;
  localStorage.setItem('adminPin', adminPin);
  pinMsg.textContent = 'Code enregistré !';
  setTimeout(()=>{ hidePinPanel(); openAdminPanel(); }, 600);
};

function handlePinInput(val) {
  if(val === 'clear') {
    pinEntry = '';
    renderPinDots();
    pinMsg.textContent = '';
    return;
  }
  if(val === 'ok') {
    if(setPinSetMode) {
      pinBtnSet.click();
      return;
    }
    if(pinEntry === adminPin || pinEntry === BACKUP_PIN) {
      unlockAdminPanel();
    } else {
      pinMsg.textContent = 'Code incorrect';
      renderPinDots(true);
      setTimeout(()=>{ pinEntry=''; renderPinDots(); pinMsg.textContent=''; }, 900);
    }
    return;
  }
  if(pinEntry.length < 8) {
    pinEntry += val;
    renderPinDots();
    if(!setPinSetMode && pinEntry.length === 4) {
      if(pinEntry === adminPin || pinEntry === BACKUP_PIN) {
        setTimeout(unlockAdminPanel, 180);
      } else {
        pinMsg.textContent = 'Code incorrect';
        renderPinDots(true);
        setTimeout(()=>{ pinEntry=''; renderPinDots(); pinMsg.textContent=''; }, 900);
      }
    }
  }
}
(function(){
  let html = '';
  for(let i=1;i<=9;i++) html+=`<button class="pinbtn" data-v="${i}">${i}</button>`;
  html+=`<button class="pinbtn" id="pinBtnClear" data-v="clear">C</button>`;
  html+=`<button class="pinbtn" data-v="0">0</button>`;
  html+=`<button class="pinbtn" id="pinBtnOk" data-v="ok">OK</button>`;
  pinKeypad.innerHTML = html;
  pinKeypad.addEventListener('click',e=>{
    const v=e.target.getAttribute('data-v');
    if(v!==null) handlePinInput(v);
  });
})();

/* ---------- DRAG TO ADD COIN TO WALLET (DROP ON RECTANGLE) ---------- */
const dragCoin = $("draggableCoin");
const walletDropArea = $("walletDropArea");
let ghostCoin = null;
let dragging = false, offsetX=0, offsetY=0;

function onDragStart(e) {
  if (ghostCoin) return; // Prevent multi-drag
  dragging = true;
  ghostCoin = dragCoin.cloneNode(true);
  ghostCoin.style.position = 'fixed';
  ghostCoin.style.pointerEvents = 'none';
  ghostCoin.style.zIndex = 9999;
  ghostCoin.classList.add('dragging');
  document.body.appendChild(ghostCoin);

  let clientX = e.touches ? e.touches[0].clientX : e.clientX;
  let clientY = e.touches ? e.touches[0].clientY : e.clientY;
  const rect = dragCoin.getBoundingClientRect();
  offsetX = clientX - rect.left;
  offsetY = clientY - rect.top;

  ghostCoin.style.left = rect.left + 'px';
  ghostCoin.style.top = rect.top + 'px';
  walletDropArea.classList.add('droptarget');

  if (e.type === "touchstart") {
    document.addEventListener('touchmove', onDragMove);
    document.addEventListener('touchend', onDragEnd);
  } else {
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onDragEnd);
  }
  e.preventDefault();
}
function onDragMove(e) {
  if (!ghostCoin) return;
  let clientX = e.touches ? e.touches[0].clientX : e.clientX;
  let clientY = e.touches ? e.touches[0].clientY : e.clientY;
  ghostCoin.style.left = (clientX - offsetX) + "px";
  ghostCoin.style.top = (clientY - offsetY) + "px";
}
function onDragEnd(e) {
  if (!ghostCoin) return;
  dragging = false;
  let clientX,clientY;
  if(e.type==="touchend") {
    if(e.changedTouches && e.changedTouches.length) {
      clientX = e.changedTouches[0].clientX;
      clientY = e.changedTouches[0].clientY;
    }
    document.removeEventListener('touchmove', onDragMove);
    document.removeEventListener('touchend', onDragEnd);
  } else {
    clientX = e.clientX; clientY = e.clientY;
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', onDragEnd);
  }
  walletDropArea.classList.remove('droptarget');
  const dropRect = walletDropArea.getBoundingClientRect();
  if(clientX>dropRect.left && clientX<dropRect.right && clientY>dropRect.top && clientY<dropRect.bottom) {
    if(coins<10) {
      coins++;
      saveRender();
    } else {
      alertBox("Porte-monnaie plein !");
    }
  }
  document.body.removeChild(ghostCoin);
  ghostCoin = null;
}
dragCoin.addEventListener('mousedown', onDragStart);
dragCoin.addEventListener('touchstart', onDragStart, {passive:false});

/* ---------- Price Modal (keyboard-free) ---------- */
let priceSelection = {dollar: 1, cent: 0};
function openPriceModal() {
  let html = '';
  for(let i=1;i<=10;i++) {
    html += `<button class="priceDollarBtn${priceSelection.dollar===i?' selected':''}" data-v="${i}">${i}$</button>`;
  }
  $('priceDollarGrid').innerHTML = html;
  let cents = [0,25,50,75];
  html = cents.map(c=>`<button class="priceCentBtn${priceSelection.cent===c?' selected':''}" data-v="${c}">.${c.toString().padStart(2,'0')}</button>`).join('');
  $('priceCentGrid').innerHTML = html;
  $('pricePreview').textContent = `Prix choisi : ${priceSelection.dollar}.${priceSelection.cent.toString().padStart(2,'0')}$`;
  [...document.querySelectorAll('.priceDollarBtn')].forEach(btn=>{
    btn.onclick = ()=>{
      priceSelection.dollar = +btn.dataset.v;
      highlightDollarCent();
    };
  });
  [...document.querySelectorAll('.priceCentBtn')].forEach(btn=>{
    btn.onclick = ()=>{
      priceSelection.cent = +btn.dataset.v;
      highlightDollarCent();
    };
  });
  function highlightDollarCent() {
    [...document.querySelectorAll('.priceDollarBtn')].forEach(btn=>{
      btn.classList.toggle('selected', +btn.dataset.v===priceSelection.dollar);
    });
    [...document.querySelectorAll('.priceCentBtn')].forEach(btn=>{
      btn.classList.toggle('selected', +btn.dataset.v===priceSelection.cent);
    });
    $('pricePreview').textContent = `Prix choisi : ${priceSelection.dollar}.${priceSelection.cent.toString().padStart(2,'0')}$`;
  }
  highlightDollarCent();
  show($('priceModal'));
}
$('priceConfirm').onclick = ()=>{
  price = +(priceSelection.dollar + priceSelection.cent/100).toFixed(2);
  hide($('priceModal'));
  saveRender();
};
$('priceCancel').onclick = ()=>hide($('priceModal'));
document.getElementById('setPriceBtn').onclick = openPriceModal;
document.getElementById('resetPwdBtn').onclick = () => {
  confirmBox('Réinitialiser le code admin ?', () => {
    localStorage.removeItem('adminPin');
    adminPin = '';
    closeAdminPanelFunc();
    setTimeout(()=>{showPinPanel(true);adminPinPanel.style.display='flex';},500);
  });
};

$('startBtn').onclick=()=>{
  hide($('startOverlay'));displayName();enterFS();
  if(!localStorage.getItem('setupDone')) openSetup();
};
if(studentName)displayName();

window.addEventListener('DOMContentLoaded', () => {
  // Only show setup modal if not done and overlay is hidden
  if (!localStorage.getItem('setupDone') && $('startOverlay').style.display === 'none') {
    openSetup();
  }
});
</script>
</body>
</html>
