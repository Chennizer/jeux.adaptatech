<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samurai Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #111;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .main-display {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-wrapper {
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        /* Image styling */
        #current-image {
            display: block;
            filter: grayscale(100%) contrast(1.2) brightness(0.95);
            animation: colorFadeIn 4s ease-in-out forwards;
            cursor: pointer;
            transition: filter 0.3s, opacity 0.8s ease-in-out;
            max-width: 90vw;
            max-height: 80vh;
            width: auto;
            height: auto;
            opacity: 1;
        }

        /* Video element - initially hidden */
        #current-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            z-index: 2;
            display: none;
        }

        .video-playing #current-video {
            opacity: 1;
            display: block;
        }

        .video-playing #current-image {
            opacity: 0;
        }

        @keyframes colorFadeIn {
            0% {
                filter: grayscale(100%) contrast(1.2) brightness(0.95);
            }
            20% {
                filter: grayscale(100%) contrast(1.2) brightness(0.95);
            }
            100% {
                filter: grayscale(0%) contrast(1) brightness(1);
            }
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 24px;
            background-color: rgba(40, 40, 40, 0.9);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            min-width: 140px;
        }

        button:hover {
            background-color: rgba(80, 80, 80, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .fullscreen-btn {
            background-color: rgba(0, 100, 200, 0.8);
        }

        .fullscreen-btn:hover {
            background-color: rgba(0, 120, 220, 0.9);
        }

        .music-controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }

        .music-selector {
            width: 100%;
            padding: 10px;
            background-color: rgba(30, 30, 30, 0.9);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .music-selector option {
            background-color: #222;
            color: white;
            padding: 10px;
        }

        .volume-control {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #aaa;
        }

        .volume-slider {
            flex-grow: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4dabf7;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4dabf7;
            cursor: pointer;
            border: none;
        }

        .music-player {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .music-btn {
            padding: 8px 16px;
            min-width: auto;
            background-color: rgba(60, 60, 60, 0.9);
            font-size: 14px;
        }

        .music-btn:hover {
            background-color: rgba(90, 90, 90, 0.9);
        }

        .current-song {
            font-size: 14px;
            color: #4dabf7;
            text-align: center;
            margin-top: 5px;
            min-height: 20px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .image-selector {
            margin-top: 20px;
            width: 100%;
            max-width: 900px;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .thumbnail:hover {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        .thumbnail.active {
            opacity: 1;
            border-color: #4dabf7;
            box-shadow: 0 0 15px rgba(77, 171, 247, 0.5);
            transform: scale(1.05);
        }

        .image-info {
            margin-top: 15px;
            text-align: center;
            color: #aaa;
            font-size: 1.1rem;
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 4px;
            min-height: 36px;
        }

        .video-status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            z-index: 10;
            display: none;
        }

        /* Fullscreen styles - FIXED VIDEO SCALING */
        :fullscreen {
            background-color: #000;
        }

        :fullscreen .container {
            width: 100vw;
            height: 100vh;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        /* Simple fullscreen wrapper */
        :fullscreen .image-wrapper {
            width: 100vw;
            height: 100vh;
            box-shadow: none;
            border-radius: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            overflow: visible;
        }

        /* Image in fullscreen - scales properly */
        :fullscreen #current-image {
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        /* FIXED: Video in fullscreen - scales EXACTLY like the image */
        :fullscreen #current-video {
            position: absolute;
            /* Use the same scaling as image */
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
            /* Perfect centering */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        /* When video is playing */
        :fullscreen .video-playing #current-video {
            display: block;
        }

        /* Hide all controls in fullscreen */
        :fullscreen .controls,
        :fullscreen .image-selector,
        :fullscreen .music-controls,
        :fullscreen .image-info {
            display: none;
        }

        :fullscreen .video-status {
            display: block;
        }

        /* Firefox */
        :-moz-full-screen {
            background-color: #000;
        }

        :-moz-full-screen .container {
            width: 100vw;
            height: 100vh;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        :-moz-full-screen .image-wrapper {
            width: 100vw;
            height: 100vh;
            box-shadow: none;
            border-radius: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            overflow: visible;
        }

        :-moz-full-screen #current-image {
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        :-moz-full-screen #current-video {
            position: absolute;
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        :-moz-full-screen .video-playing #current-video {
            display: block;
        }

        :-moz-full-screen .controls,
        :-moz-full-screen .image-selector,
        :-moz-full-screen .music-controls,
        :-moz-full-screen .image-info {
            display: none;
        }

        :-moz-full-screen .video-status {
            display: block;
        }

        /* Safari and Chrome */
        :-webkit-full-screen {
            background-color: #000;
        }

        :-webkit-full-screen .container {
            width: 100vw;
            height: 100vh;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        :-webkit-full-screen .image-wrapper {
            width: 100vw;
            height: 100vh;
            box-shadow: none;
            border-radius: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            overflow: visible;
        }

        :-webkit-full-screen #current-image {
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        :-webkit-full-screen #current-video {
            position: absolute;
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        :-webkit-full-screen .video-playing #current-video {
            display: block;
        }

        :-webkit-full-screen .controls,
        :-webkit-full-screen .image-selector,
        :-webkit-full-screen .music-controls,
        :-webkit-full-screen .image-info {
            display: none;
        }

        :-webkit-full-screen .video-status {
            display: block;
        }

        .rotation-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            z-index: 10;
            display: none;
        }

        @media (max-width: 768px) {
            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            
            .thumbnail {
                height: 70px;
            }
            
            button {
                padding: 10px 15px;
                min-width: 120px;
                font-size: 14px;
            }
            
            #current-image {
                max-width: 95vw;
                max-height: 70vh;
            }
            
            :fullscreen .video-status {
                font-size: 0.8rem;
                bottom: 10px;
                left: 10px;
                padding: 3px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="main-display">
            <div class="rotation-indicator" id="rotation-indicator"></div>
            <div class="video-status" id="video-status"></div>
            <div class="image-wrapper" id="image-wrapper">
                <img id="current-image" src="../../images/samuraikata/boulebleuchi.jpg" 
                     alt="Samurai Drawing">
                <video id="current-video" loop muted playsinline>
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
        
        <div class="image-info" id="image-info">boulebleuchi.jpg</div>
        
        <div class="controls">
            <button id="restart-btn">Restart Animation</button>
            <button id="fullscreen-btn" class="fullscreen-btn">Fullscreen</button>
        </div>
        
        <div class="music-controls">
            <select id="music-selector" class="music-selector">
                <option value="">Select Background Music</option>
                <option value="../../songs/samurai/samuraisong1.mp3">Samurai Song 1</option>
                <option value="../../songs/samurai/samuraisong2.mp3">Samurai Song 2</option>
                <option value="../../songs/samurai/samuraisong3.mp3">Samurai Song 3</option>
                <option value="../../songs/samurai/samuraisong4.mp3">Samurai Song 4</option>
            </select>
            
            <div class="volume-control">
                <span id="volume-icon">ðŸ”Š</span>
                <input type="range" id="volume-slider" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
                <span id="volume-percent">50%</span>
            </div>
            
            <div class="music-player">
                <button id="play-btn" class="music-btn">Play</button>
                <button id="pause-btn" class="music-btn">Pause</button>
                <button id="stop-btn" class="music-btn">Stop</button>
            </div>
            
            <div class="current-song" id="current-song"></div>
        </div>
        
        <div class="image-selector">
            <div class="image-grid" id="image-grid">
                <!-- Thumbnails will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <audio id="background-music" loop>
        <!-- Audio will be controlled by JavaScript -->
    </audio>

    <script>
        // List of all images
        const images = [
            'arriveemaitre.jpg',
            'boulebleuchi.jpg',
            'boulediffuse.jpg',
            'cerisier.jpg',
            'katanafleurs.jpg',
            'lanterneciel.jpg',
            'lanternesallu.jpg',
            'luneattaqueboulechi.jpg',
            'maitrechi.jpg',
            'page1.jpg',
            'pagetexte2.jpg',
            'paysagejapon.jpg',
            'texte1.jpg',
            'textefleurs.jpg'
        ];

        const basePath = '../../images/samuraikata/';
        const videoBasePath = '../../animations/samurai/';
        const currentImage = document.getElementById('current-image');
        const currentVideo = document.getElementById('current-video');
        const imageWrapper = document.getElementById('image-wrapper');
        const restartBtn = document.getElementById('restart-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const imageGrid = document.getElementById('image-grid');
        const imageInfo = document.getElementById('image-info');
        const rotationIndicator = document.getElementById('rotation-indicator');
        const videoStatus = document.getElementById('video-status');
        const container = document.getElementById('container');
        
        // Music elements
        const backgroundMusic = document.getElementById('background-music');
        const musicSelector = document.getElementById('music-selector');
        const volumeSlider = document.getElementById('volume-slider');
        const volumePercent = document.getElementById('volume-percent');
        const volumeIcon = document.getElementById('volume-icon');
        const playBtn = document.getElementById('play-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        const currentSong = document.getElementById('current-song');

        let rotationAngle = 0;
        let isFullscreen = false;
        let currentImageIndex = 1; // Start with boulebleuchi.jpg
        let currentSongName = '';
        let videoExists = false;
        let animationEnded = false;
        let videoTransitionTimeout = null;

        // Initialize thumbnails
        function initThumbnails() {
            images.forEach((image, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = basePath + image;
                thumbnail.alt = image;
                thumbnail.className = 'thumbnail';
                if (index === currentImageIndex) {
                    thumbnail.classList.add('active');
                }
                
                thumbnail.addEventListener('click', () => {
                    // Remove active class from all thumbnails
                    document.querySelectorAll('.thumbnail').forEach(thumb => {
                        thumb.classList.remove('active');
                    });
                    
                    // Add active class to clicked thumbnail
                    thumbnail.classList.add('active');
                    
                    // Load the selected image
                    loadImage(index);
                });
                
                imageGrid.appendChild(thumbnail);
            });
        }

        // Load a specific image
        function loadImage(index) {
            currentImageIndex = index;
            const imageName = images[index];
            
            // Reset states
            resetVideoState();
            
            // Reset rotation
            rotationAngle = 0;
            imageWrapper.style.transform = 'rotate(0deg)';
            rotationIndicator.style.display = 'none';
            
            // Update image source
            currentImage.src = basePath + imageName;
            imageInfo.textContent = imageName;
            
            // Check if corresponding video exists
            checkForVideo(imageName);
            
            // Restart animation
            restartAnimation();
        }

        // Check if video exists for the current image
        function checkForVideo(imageName) {
            const videoName = imageName.replace('.jpg', '.mp4').replace('.jpeg', '.mp4').replace('.png', '.mp4');
            const videoPath = videoBasePath + videoName;
            
            // Test if video exists by trying to load it
            const testVideo = document.createElement('video');
            testVideo.src = videoPath;
            
            videoExists = false;
            
            testVideo.addEventListener('loadeddata', () => {
                videoExists = true;
                console.log(`Video found: ${videoPath}`);
                videoStatus.textContent = 'Video available (fullscreen)';
                videoStatus.style.display = 'block';
                videoStatus.style.backgroundColor = 'rgba(0, 100, 0, 0.7)';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    if (!isFullscreen) {
                        videoStatus.style.display = 'none';
                    }
                }, 3000);
            });
            
            testVideo.addEventListener('error', () => {
                videoExists = false;
                console.log(`No video found for: ${imageName}`);
                if (videoStatus.style.display === 'block' && !isFullscreen) {
                    videoStatus.style.display = 'none';
                }
            });
            
            // Set a timeout in case the video takes too long to respond
            setTimeout(() => {
                if (!videoExists) {
                    console.log(`Video check timeout for: ${imageName}`);
                }
            }, 1000);
        }

        // Reset video state
        function resetVideoState() {
            // Stop any playing video
            currentVideo.pause();
            currentVideo.currentTime = 0;
            currentVideo.src = '';
            
            // Remove video playing class
            imageWrapper.classList.remove('video-playing');
            
            // Clear any pending timeout
            if (videoTransitionTimeout) {
                clearTimeout(videoTransitionTimeout);
                videoTransitionTimeout = null;
            }
            
            // Reset animation state
            animationEnded = false;
            
            // Update video status (hide if not in fullscreen)
            if (!isFullscreen) {
                videoStatus.style.display = 'none';
            }
        }

        // Setup video for fullscreen playback
        function setupFullscreenVideo() {
            if (!isFullscreen || !videoExists || animationEnded) return;
            
            const imageName = images[currentImageIndex];
            const videoName = imageName.replace('.jpg', '.mp4').replace('.jpeg', '.mp4').replace('.png', '.mp4');
            const videoPath = videoBasePath + videoName;
            
            // Load the video
            currentVideo.src = videoPath;
            currentVideo.load();
            
            // Set video status
            videoStatus.textContent = 'Video loaded - waiting for animation...';
            videoStatus.style.display = 'block';
            videoStatus.style.backgroundColor = 'rgba(0, 0, 100, 0.7)';
            
            // Listen for animation end
            currentImage.addEventListener('animationend', handleAnimationEnd, { once: true });
        }

        // Handle animation end
        function handleAnimationEnd() {
            animationEnded = true;
            
            if (!isFullscreen || !videoExists) return;
            
            // Start video playback after a brief delay for seamless transition
            videoTransitionTimeout = setTimeout(() => {
                currentVideo.play().then(() => {
                    // Add class to trigger fade transition
                    imageWrapper.classList.add('video-playing');
                    
                    // Update video status
                    videoStatus.textContent = 'Playing video... (V: mute/unmute)';
                    videoStatus.style.backgroundColor = 'rgba(0, 100, 0, 0.7)';
                    
                    // Listen for video end to loop
                    currentVideo.addEventListener('ended', () => {
                        currentVideo.currentTime = 0;
                        currentVideo.play();
                    });
                    
                }).catch(error => {
                    console.error('Video playback failed:', error);
                    videoStatus.textContent = 'Video playback failed';
                    videoStatus.style.backgroundColor = 'rgba(100, 0, 0, 0.7)';
                });
            }, 500); // Small delay for smoother transition
        }

        // Restart animation function
        function restartAnimation() {
            // Reset video state
            resetVideoState();
            
            // Restart the image animation
            currentImage.style.animation = 'none';
            void currentImage.offsetWidth; // Trigger reflow
            currentImage.style.animation = 'colorFadeIn 4s ease-in-out forwards';
            
            // If in fullscreen and video exists, set up video again
            if (isFullscreen && videoExists) {
                setupFullscreenVideo();
            }
        }

        // Fullscreen function
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Enter fullscreen on the container
                if (container.requestFullscreen) {
                    container.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable fullscreen: ${err.message}`);
                        alert("Fullscreen failed. Try clicking the page first, then the button.");
                    });
                } else if (container.mozRequestFullScreen) { // Firefox
                    container.mozRequestFullScreen();
                } else if (container.webkitRequestFullscreen) { // Chrome, Safari, Opera
                    container.webkitRequestFullscreen();
                } else if (container.msRequestFullscreen) { // IE/Edge
                    container.msRequestFullscreen();
                }
                isFullscreen = true;
                fullscreenBtn.textContent = 'Exit Fullscreen';
                
                // Check for video and set up if exists
                const imageName = images[currentImageIndex];
                checkForVideo(imageName);
                
                // Small delay to ensure fullscreen is active
                setTimeout(() => {
                    if (videoExists) {
                        setupFullscreenVideo();
                    } else {
                        videoStatus.textContent = 'No video available for this image';
                        videoStatus.style.display = 'block';
                        videoStatus.style.backgroundColor = 'rgba(100, 100, 0, 0.7)';
                    }
                }, 100);
                
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari, Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
                isFullscreen = false;
                fullscreenBtn.textContent = 'Fullscreen';
                
                // Reset video state when exiting fullscreen
                resetVideoState();
            }
        }

        // Rotate image
        function rotateImage() {
            rotationAngle = (rotationAngle + 90) % 360;
            imageWrapper.style.transform = `rotate(${rotationAngle}deg)`;
            
            // Show rotation indicator
            rotationIndicator.textContent = `Rotated: ${rotationAngle}Â°`;
            rotationIndicator.style.display = 'block';
            
            // Hide indicator after 2 seconds
            setTimeout(() => {
                rotationIndicator.style.display = 'none';
            }, 2000);
        }

        // Navigate through images with arrow keys
        function navigateImages(direction) {
            let newIndex = currentImageIndex + direction;
            
            // Wrap around
            if (newIndex < 0) newIndex = images.length - 1;
            if (newIndex >= images.length) newIndex = 0;
            
            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
                thumb.classList.toggle('active', index === newIndex);
            });
            
            loadImage(newIndex);
        }

        // Music control functions
        function loadSelectedMusic() {
            const selectedSong = musicSelector.value;
            
            if (selectedSong) {
                backgroundMusic.src = selectedSong;
                currentSongName = musicSelector.options[musicSelector.selectedIndex].text;
                currentSong.textContent = `Now Playing: ${currentSongName}`;
            } else {
                backgroundMusic.src = '';
                currentSong.textContent = '';
            }
        }

        function playMusic() {
            if (backgroundMusic.src) {
                backgroundMusic.play().catch(e => {
                    console.log("Autoplay prevented. User interaction required.");
                    currentSong.textContent = "Click Play to start music";
                });
                currentSong.textContent = `Now Playing: ${currentSongName}`;
            }
        }

        function pauseMusic() {
            backgroundMusic.pause();
            currentSong.textContent = `Paused: ${currentSongName}`;
        }

        function stopMusic() {
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
            currentSong.textContent = 'Music Stopped';
        }

        function updateVolume() {
            const volume = volumeSlider.value;
            backgroundMusic.volume = volume;
            volumePercent.textContent = `${Math.round(volume * 100)}%`;
            
            // Update volume icon based on level
            if (volume == 0) {
                volumeIcon.textContent = 'ðŸ”‡';
            } else if (volume < 0.3) {
                volumeIcon.textContent = 'ðŸ”ˆ';
            } else if (volume < 0.7) {
                volumeIcon.textContent = 'ðŸ”‰';
            } else {
                volumeIcon.textContent = 'ðŸ”Š';
            }
        }

        // Event Listeners
        currentImage.addEventListener('click', restartAnimation);
        currentImage.addEventListener('dblclick', rotateImage);
        
        restartBtn.addEventListener('click', restartAnimation);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        // Music event listeners
        musicSelector.addEventListener('change', loadSelectedMusic);
        playBtn.addEventListener('click', playMusic);
        pauseBtn.addEventListener('click', pauseMusic);
        stopBtn.addEventListener('click', stopMusic);
        volumeSlider.addEventListener('input', updateVolume);

        // Handle audio ended event
        backgroundMusic.addEventListener('ended', function() {
            currentSong.textContent = `${currentSongName} - Finished`;
        });

        // Handle audio errors
        backgroundMusic.addEventListener('error', function() {
            console.error('Error loading audio:', backgroundMusic.src);
            currentSong.textContent = 'Error loading music file. Check the file path.';
        });

        // Handle video errors
        currentVideo.addEventListener('error', function() {
            console.error('Error loading video:', currentVideo.src);
            videoStatus.textContent = 'Error loading video';
            videoStatus.style.backgroundColor = 'rgba(100, 0, 0, 0.7)';
            videoExists = false;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Space or Enter to restart animation
            if (e.code === 'Space' || e.code === 'Enter') {
                e.preventDefault();
                restartAnimation();
            }
            // F key for fullscreen
            if (e.code === 'KeyF') {
                e.preventDefault();
                toggleFullscreen();
            }
            // R key for rotate
            if (e.code === 'KeyR') {
                e.preventDefault();
                rotateImage();
            }
            // Arrow keys for navigation
            if (e.code === 'ArrowLeft') {
                e.preventDefault();
                navigateImages(-1);
            }
            if (e.code === 'ArrowRight') {
                e.preventDefault();
                navigateImages(1);
            }
            // Escape to exit fullscreen
            if (e.code === 'Escape' && isFullscreen) {
                toggleFullscreen();
            }
            // P key to play/pause music
            if (e.code === 'KeyP') {
                e.preventDefault();
                if (backgroundMusic.paused) {
                    playMusic();
                } else {
                    pauseMusic();
                }
            }
            // S key to stop music
            if (e.code === 'KeyS') {
                e.preventDefault();
                stopMusic();
            }
            // M key to toggle mute
            if (e.code === 'KeyM') {
                e.preventDefault();
                backgroundMusic.muted = !backgroundMusic.muted;
                volumeIcon.textContent = backgroundMusic.muted ? 'ðŸ”‡' : volumeIcon.textContent;
            }
            // V key to toggle video mute when playing
            if (e.code === 'KeyV' && isFullscreen && videoExists && animationEnded) {
                currentVideo.muted = !currentVideo.muted;
                videoStatus.textContent = currentVideo.muted ? 'Video (muted) - V: unmute' : 'Playing video... - V: mute';
            }
            // Plus/Minus for volume
            if (e.code === 'Equal' || e.code === 'Minus') {
                e.preventDefault();
                let currentVolume = parseFloat(backgroundMusic.volume);
                if (e.code === 'Equal') {
                    currentVolume = Math.min(1, currentVolume + 0.1);
                } else {
                    currentVolume = Math.max(0, currentVolume - 0.1);
                }
                volumeSlider.value = currentVolume;
                updateVolume();
            }
        });

        // Handle fullscreen change events
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);

        function handleFullscreenChange() {
            const wasFullscreen = isFullscreen;
            isFullscreen = !!document.fullscreenElement;
            fullscreenBtn.textContent = isFullscreen ? 'Exit Fullscreen' : 'Fullscreen';
            
            // If we just exited fullscreen, reset video
            if (wasFullscreen && !isFullscreen) {
                resetVideoState();
            }
            
            // If we just entered fullscreen, check for video
            if (!wasFullscreen && isFullscreen) {
                const imageName = images[currentImageIndex];
                checkForVideo(imageName);
                
                // Small delay to ensure fullscreen is active
                setTimeout(() => {
                    if (videoExists) {
                        setupFullscreenVideo();
                    } else {
                        videoStatus.textContent = 'No video available for this image';
                        videoStatus.style.display = 'block';
                        videoStatus.style.backgroundColor = 'rgba(100, 100, 0, 0.7)';
                    }
                }, 100);
            }
        }

        // Initialize the gallery
        initThumbnails();
        
        // Check for video on initial load
        checkForVideo(images[currentImageIndex]);
        
        // Initialize volume
        updateVolume();
        
        // Handle image load errors
        currentImage.addEventListener('error', function() {
            imageInfo.textContent = 'Error loading image: ' + images[currentImageIndex];
            console.error('Failed to load image:', basePath + images[currentImageIndex]);
        });

        // Show image info on hover
        currentImage.addEventListener('mouseenter', () => {
            imageInfo.style.color = '#fff';
            imageInfo.style.backgroundColor = 'rgba(0,0,0,0.5)';
        });

        currentImage.addEventListener('mouseleave', () => {
            imageInfo.style.color = '#aaa';
            imageInfo.style.backgroundColor = 'rgba(0,0,0,0.3)';
        });

        // Auto-play first song when page loads (with user interaction requirement)
        window.addEventListener('click', function initMusic() {
            // Load and play the first song automatically
            if (musicSelector.options.length > 1 && !currentSongName) {
                musicSelector.selectedIndex = 1; // Select first song
                loadSelectedMusic();
                setTimeout(playMusic, 100); // Small delay to ensure loading
            }
            // Remove this event listener after first click
            window.removeEventListener('click', initMusic);
        }, { once: true });
    </script>
</body>
</html>