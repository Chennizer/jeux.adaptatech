<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title class="translate" data-fr="Dessiner (Eyegaze)" data-en="Draw (Eyegaze)">Dessiner (Eyegaze)</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root{
      --ui-scale: 1;
      --sidebar-w: clamp(96px, calc(120px * var(--ui-scale)), 180px);
      --sidebar-pad-x: clamp(8px, calc(12px * var(--ui-scale)), 16px);
      --sidebar-pad-y: clamp(8px, calc(12px * var(--ui-scale)), 16px);
      --swatch-size: 84px;
      --swatch-gap: 12px;
      --swatch-border: clamp(3px, calc(5px * var(--ui-scale)), 6px);
      --swatch-outline: clamp(3px, calc(5px * var(--ui-scale)), 6px);
      --brush-btn: clamp(36px, calc(44px * var(--ui-scale)), 56px);
      --brush-dot-s: clamp(6px,  calc(8px * var(--ui-scale)),  10px);
      --brush-dot-m: clamp(12px, calc(16px * var(--ui-scale)), 20px);
      --brush-dot-l: clamp(22px, calc(28px * var(--ui-scale)), 34px);
      --brush-gap: clamp(8px, calc(12px * var(--ui-scale)), 16px);
      --save-btn: clamp(36px, calc(44px * var(--ui-scale)), 56px);
      --save-radius: clamp(8px, calc(10px * var(--ui-scale)), 12px);
      --swatch-min: 26px;
      --swatch-max: 96px;
      --palette-cols: 1;
      --dwell-red: rgba(255, 64, 64, 0.48);
    }

    body.light { background-color: #fff; color: #000; }
    body.dark  { background-color: #000; color: #fff; }

    #langToggle{
      position: fixed; top: 10px; right: 10px; z-index: 99999;
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 10px; border: 2px solid #009688;
      background: #fff; color: #009688; font-weight: 700; cursor: pointer; user-select: none;
    }
    body.dark #langToggle { background:#111; color:#14b8a6; border-color:#14b8a6; }

    .game-container { width: 100%; height: 100%; display: none; }

    #sidebar{
      position: fixed; left: 0; top: 0; bottom: 0; z-index: 20;
      width: var(--sidebar-w);
      display: flex; flex-direction: column;
      padding: var(--sidebar-pad-y) var(--sidebar-pad-x);
      gap: clamp(12px, calc(14px * var(--ui-scale)), 18px);
      background: #fff; border-right: 1px solid #e6e6e6;
      box-shadow: 0 0 18px rgba(0,0,0,.05);
      color: #000;
    }
    body.dark #sidebar{ background:#fff; border-right-color:#e6e6e6; color:#000; }

    #palette{
      flex: 1;
      display: grid;
      grid-template-columns: repeat(var(--palette-cols, 1), var(--swatch-size));
      grid-auto-rows: var(--swatch-size);
      justify-content: center;
      align-content: start;
      gap: var(--swatch-gap);
      overflow: hidden;
      padding-inline: 8px;
    }

    .swatch{
      width: var(--swatch-size); height: var(--swatch-size);
      border-radius: 50%;
      border: var(--swatch-border) solid #ffffff;
      box-shadow: 0 1px 6px rgba(0,0,0,.22) inset, 0 3px 10px rgba(0,0,0,.12);
      transition: transform .12s ease;
      position: relative;
      flex: 0 0 auto;
      overflow: hidden;
      cursor: pointer;
    }
    .swatch.active{ transform: scale(1.03); }
    .swatch.active::before{
      content:"";
      position:absolute;
      inset: calc(var(--swatch-outline) + 2px);
      border: var(--swatch-outline) solid #111;
      border-radius: 50%;
      pointer-events:none;
      z-index: 2;
    }

    .swatch .dwell,
    .brushBtn .dwell,
    .sidebar-action .dwell{
      position: absolute;
      left: 50%; top: 50%;
      width: 100%; height: 100%;
      transform: translate(-50%, -50%) scale(0.08);
      transform-origin: center center;
      pointer-events: none;
      border-radius: 50%;
      background-color: var(--dwell-red);
      will-change: transform;
      z-index: 1;
    }

    #brushSizes{
      display: flex; flex-direction: column; align-items: center;
      gap: var(--brush-gap); margin-top: 4px;
    }
    .brushBtn{
      width: var(--brush-btn); height: var(--brush-btn);
      border-radius: 50%;
      border: 2px solid #aaa; background: #f8f8f8;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,.1) inset;
      transition: transform .12s ease, background-color .12s ease;
      position: relative;
      overflow: hidden;
    }
    .brushBtn span{ display: block; border-radius: 50%; background: #333; }
    .brushBtn.small  span{ width: var(--brush-dot-s); height: var(--brush-dot-s); }
    .brushBtn.medium span{ width: var(--brush-dot-m); height: var(--brush-dot-m); }
    .brushBtn.large  span{ width: var(--brush-dot-l); height: var(--brush-dot-l); }
    .brushBtn.active{ border-color:#333; transform: scale(1.08); background:#ececec; }

    #sidebar .sidebar-actions{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: clamp(8px, calc(10px * var(--ui-scale)), 14px);
      margin-top: clamp(8px, calc(12px * var(--ui-scale)), 18px);
    }
    .sidebar-action{
      position: relative;
      border-radius: 12px;
      border: 2px solid #ddd;
      background: #fafafa;
      min-height: clamp(42px, calc(48px * var(--ui-scale)), 60px);
      display: flex; align-items: center; justify-content: center;
      font: clamp(12px, calc(16px * var(--ui-scale)), 18px)/1.1 system-ui, Arial, sans-serif;
      cursor: pointer;
      transition: background-color .12s ease, transform .12s ease;
    }
    .sidebar-action:hover{ background:#f2f2f2; transform: translateY(-1px); }
    .sidebar-action.active{ border-color:#14b8a6; color:#0f766e; background:#e0f2f1; }

    #canvasStack{
      position: fixed;
      inset: 0;
      cursor: crosshair;
      background: radial-gradient(circle at 50% 30%, rgba(255,255,255,0.05), rgba(0,0,0,0.6));
    }
    #canvasStack canvas{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
    }
    #outline{ pointer-events: none; }

    body.light #canvasStack{ background: radial-gradient(circle at 50% 30%, rgba(0,0,0,0.05), rgba(240,240,240,0.6)); }

    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }
    .modal-backdrop.open{ display: flex; }
    .mask-modal{
      max-width: 720px;
      width: min(95vw, 720px);
      max-height: 90vh;
      overflow: auto;
      background: #f8fafc;
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 24px 48px rgba(0,0,0,0.35);
      color: #0b1520;
    }
    .mask-modal h2{ margin-top: 0; }
    .mask-section{ margin-bottom: 24px; }
    .mask-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }
    .mask-option{
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 12px;
      background: #fff;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: transform .12s ease, border-color .12s ease;
    }
    .mask-option:hover{ transform: translateY(-2px); border-color:#14b8a6; }
    .mask-option.active{ border-color:#0f766e; box-shadow: 0 6px 16px rgba(20,184,166,0.3); }
    .mask-option img{ width: 96px; height: 96px; object-fit: contain; }

    .mask-modal footer{
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    #signatureRow { display:flex; flex-direction:column; align-items:flex-start; gap:8px; }
    #signatureText { display:none; max-width: 220px; }

    @media (max-width: 800px){
      :root{ --palette-cols: 2; --swatch-size: clamp(var(--swatch-min), calc(72px * var(--ui-scale)), var(--swatch-max)); }
    }
    @media (max-width: 540px){
      :root{ --palette-cols: 3; --swatch-size: clamp(var(--swatch-min), calc(60px * var(--ui-scale)), var(--swatch-max)); }
    }
    @media (max-width: 420px){
      :root{ --palette-cols: 4; --swatch-size: clamp(var(--swatch-min), calc(52px * var(--ui-scale)), var(--swatch-max)); }
    }
  </style>

  <script src="../../js/cvipngarray.js" defer></script>
</head>
<body class="dark">
<button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

<div id="game-options" class="modal">
  <div id="options-title-bar">
    <h2 id="options-main-title" class="translate" data-fr="Dessiner (Eyegaze)" data-en="Draw (Eyegaze)">Dessiner (Eyegaze)</h2>
  </div>

  <div id="control-panel-options">
    <div id="mode-divider"></div>

    <div id="options-inline-container">
      <div class="options-column">
        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="muteSFX">
            <span class="translate" data-fr="Désactiver les sons" data-en="Disable sounds">Désactiver les sons (SFX)</span>
          </label>
        </div>
        <div class="option-item">
          <label for="sfxVol" class="teal-label">
            <span class="translate" data-fr="Volume des sons:" data-en="Sound volume:">Volume des sons:</span>
            <span id="sfxVolVal">50</span>
          </label>
          <input type="range" id="sfxVol" class="styled-slider" min="0" max="100" value="50">
        </div>
      </div>

      <div class="options-column">
        <div class="option-item">
          <label for="themeSelect" class="teal-label label-block translate" data-fr="Mode" data-en="Theme">Mode</label>
          <select id="themeSelect" class="styled-select">
            <option value="light" class="translate" data-fr="Clair" data-en="Light">Clair</option>
            <option value="dark" selected class="translate" data-fr="Sombre" data-en="Dark">Sombre</option>
          </select>
        </div>
      </div>

      <div class="options-column">
        <div class="option-item">
          <label for="paletteSizeSelect" class="teal-label label-block translate" data-fr="Nombre de couleurs" data-en="Number of colors">Nombre de couleurs</label>
          <select id="paletteSizeSelect" class="styled-select">
            <option value="4" class="translate" data-fr="4 couleurs" data-en="4 colors">4 couleurs</option>
            <option value="7" selected class="translate" data-fr="7 couleurs" data-en="7 colors">7 couleurs</option>
            <option value="13" class="translate" data-fr="13 couleurs" data-en="13 colors">13 couleurs</option>
          </select>
        </div>
        <div class="option-item" id="signatureRow">
          <label class="teal-label" for="signatureEnable" style="user-select:none;">
            <input type="checkbox" id="signatureEnable">
            <span class="translate" data-fr="Signature" data-en="Signature">Signature</span>
          </label>
          <input type="text" id="signatureText" class="styled-input" placeholder="Votre nom / Your name" />
        </div>
      </div>
    </div>

    <div id="mode-divider"></div>
    <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start">Commencer</button>
  </div>
</div>

<div class="game-container" id="paintGame">
  <aside id="sidebar">
    <div id="palette"></div>

    <div id="brushSizes">
      <div class="brushBtn small" data-size="small" title="Petit / Small"><span></span></div>
      <div class="brushBtn medium active" data-size="medium" title="Moyen / Medium"><span></span></div>
      <div class="brushBtn large" data-size="large" title="Grand / Large"><span></span></div>
    </div>

    <div class="sidebar-actions">
      <button id="modeToggle" class="sidebar-action" type="button" data-mode="draw" title="Basculer dessin/gomme">✏️</button>
      <button id="clearBtn" class="sidebar-action" type="button" title="Effacer la toile">🧽</button>
      <button id="maskBtn" class="sidebar-action" type="button" title="Choisir un masque">🖼️</button>
      <button id="saveBtn" class="sidebar-action" type="button" title="Enregistrer PNG">💾</button>
    </div>
  </aside>

  <div id="canvasStack">
    <canvas id="ink" width="1400" height="900" aria-label="Calque de dessin"></canvas>
    <canvas id="outline" width="1400" height="900" aria-label="Calque de guide"></canvas>
  </div>
</div>

<div class="modal-backdrop" id="maskModal" aria-hidden="true">
  <div class="mask-modal" role="dialog" aria-modal="true" aria-labelledby="maskModalTitle">
    <h2 id="maskModalTitle" class="translate" data-fr="Choisir un masque" data-en="Choose a mask">Choisir un masque</h2>

    <section class="mask-section">
      <h3 class="translate" data-fr="Formes intégrées" data-en="Built-in shapes">Formes intégrées</h3>
      <div class="mask-grid" id="shapeGrid">
        <button class="mask-option" data-shape="blob" type="button">
          <span class="translate" data-fr="Blob" data-en="Blob">Blob</span>
        </button>
        <button class="mask-option" data-shape="star" type="button">
          <span class="translate" data-fr="Étoile" data-en="Star">Étoile</span>
        </button>
        <button class="mask-option" data-shape="heart" type="button">
          <span class="translate" data-fr="Cœur" data-en="Heart">Cœur</span>
        </button>
        <button class="mask-option" data-shape="rect" type="button">
          <span class="translate" data-fr="Rectangle" data-en="Rectangle">Rectangle</span>
        </button>
      </div>
    </section>

    <section class="mask-section">
      <h3 class="translate" data-fr="Bibliothèque PNG" data-en="PNG library">Bibliothèque PNG</h3>
      <p id="presetStatus" class="translate" data-fr="Chargement des vignettes…" data-en="Loading thumbnails…">Chargement des vignettes…</p>
      <div class="mask-grid" id="presetGrid"></div>
    </section>

    <section class="mask-section">
      <h3 class="translate" data-fr="Importer un fichier" data-en="Import a file">Importer un fichier</h3>
      <input id="outlineFile" type="file" accept="image/png, image/svg+xml" />
      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
        <label class="translate" data-fr="Ajustement:" data-en="Fit mode:">Ajustement:</label>
        <select id="fitMode" class="styled-select">
          <option value="contain" selected class="translate" data-fr="Contenir" data-en="Contain">Contenir</option>
          <option value="cover" class="translate" data-fr="Couvrir" data-en="Cover">Couvrir</option>
          <option value="stretch" class="translate" data-fr="Étirer" data-en="Stretch">Étirer</option>
        </select>
        <label class="translate" data-fr="Source du masque:" data-en="Mask source:">Source du masque:</label>
        <select id="maskSource" class="styled-select">
          <option value="alpha" selected class="translate" data-fr="Alpha (opaque = dedans)" data-en="Alpha (opaque = inside)">Alpha (opaque = dedans)</option>
          <option value="luma" class="translate" data-fr="Luminance (clair = dedans)" data-en="Luminance (light = inside)">Luminance (clair = dedans)</option>
          <option value="alpha-invert" class="translate" data-fr="Alpha inversé" data-en="Alpha inverted">Alpha inversé</option>
        </select>
      </div>
    </section>

    <footer>
      <button type="button" id="closeMask" class="button translate" data-fr="Fermer" data-en="Close">Fermer</button>
    </footer>
  </div>
</div>

<script>
const LS_LANG_KEY = 'siteLanguage';
const LS_PALETTE_KEY = 'draw_palette_size';
const langToggle  = document.getElementById('langToggle');
function getLang(){ try{const s=localStorage.getItem(LS_LANG_KEY); if(s==='en'||s==='fr') return s;}catch(e){} return (document.documentElement.lang==='en')?'en':'fr'; }
function setLang(lang){
  const safe=(lang==='en')?'en':'fr';
  document.documentElement.lang=safe;
  try{localStorage.setItem(LS_LANG_KEY,safe);}catch(e){}
  document.querySelectorAll('.translate').forEach(el=>{
    const fr=el.getAttribute('data-fr'); const en=el.getAttribute('data-en');
    if (safe==='fr' && fr!=null) el.textContent=fr;
    if (safe==='en' && en!=null) el.textContent=en;
  });
  if(typeof enablePresets === 'function'){ enablePresets(); }
}
(function initLang(){
  let initial='fr';
  try{
    const saved=localStorage.getItem(LS_LANG_KEY);
    initial=(saved==='en'||saved==='fr')?saved:(document.documentElement.lang==='en'?'en':'fr');
    localStorage.setItem(LS_LANG_KEY,initial);
  }catch(e){
    initial=(document.documentElement.lang==='en'?'en':'fr');
  }
  setLang(initial);
})();
langToggle.addEventListener('click', ()=> setLang(getLang()==='fr'?'en':'fr'));

const themeSelect   = document.getElementById('themeSelect');
const paletteSizeSelect = document.getElementById('paletteSizeSelect');
function applyTheme(theme){
  document.body.classList.remove('light','dark');
  document.body.classList.add(theme==='dark'?'dark':'light');
}

const signatureEnable = document.getElementById('signatureEnable');
const signatureTextInput = document.getElementById('signatureText');
signatureEnable.addEventListener('change', ()=>{
  signatureTextInput.style.display = signatureEnable.checked ? 'block' : 'none';
});

(function initPaletteSize(){
  try{
    const saved = localStorage.getItem(LS_PALETTE_KEY);
    if(saved==='4'||saved==='7'||saved==='13'){
      paletteSizeSelect.value = saved;
    }
  }catch(e){}
})();

const startButton = document.getElementById('startButton');
const gameOptions = document.getElementById('game-options');
const gameContainer = document.getElementById('paintGame');
startButton.addEventListener('click', ()=>{
  applyTheme(themeSelect.value);
  gameOptions.style.display='none';
  gameContainer.style.display='block';
  requestResize();
});

themeSelect.addEventListener('change', ()=> applyTheme(themeSelect.value));
paletteSizeSelect.addEventListener('change', ()=>{
  try{ localStorage.setItem(LS_PALETTE_KEY, paletteSizeSelect.value); }catch(e){}
  buildPalette(+paletteSizeSelect.value);
});

const PALETTES = {
  4: ['#ff7a59','#ffd166','#06d6a0','#118ab2'],
  7: ['#ff7a59','#ffd166','#06d6a0','#118ab2','#3a86ff','#8338ec','#ff006e'],
  13:['#ff7a59','#ffb703','#f9c74f','#90be6d','#06d6a0','#118ab2','#457b9d','#1d3557','#3a86ff','#8338ec','#ff006e','#ef476f','#ffd6a5']
};

const paletteEl = document.getElementById('palette');
let currentColor = '#ff7a59';
function buildPalette(count){
  const colors = PALETTES[count] || PALETTES[7];
  paletteEl.innerHTML = '';
  colors.forEach((color, idx)=>{
    const swatch = document.createElement('button');
    swatch.className = 'swatch' + (idx===0?' active':'');
    swatch.style.background = color;
    swatch.type='button';
    swatch.dataset.color = color;
    swatch.addEventListener('click', ()=>{
      currentColor = color;
      paletteEl.querySelectorAll('.swatch').forEach(btn=>btn.classList.toggle('active', btn===swatch));
      if(isErasing){ toggleMode(); }
    });
    paletteEl.appendChild(swatch);
  });
  currentColor = colors[0] || '#ff7a59';
}

buildPalette(+paletteSizeSelect.value);

const brushButtons = document.querySelectorAll('.brushBtn');
let brushSize = 24;
brushButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    brushButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const size = btn.dataset.size;
    brushSize = size==='small'?14:size==='large'?42:24;
  });
});

const modeToggle = document.getElementById('modeToggle');
let isErasing = false;
function toggleMode(){
  isErasing = !isErasing;
  modeToggle.dataset.mode = isErasing ? 'erase' : 'draw';
  modeToggle.textContent = isErasing ? '🩹' : '✏️';
  modeToggle.classList.toggle('active', isErasing);
}
modeToggle.addEventListener('click', toggleMode);

const clearBtn = document.getElementById('clearBtn');
const saveBtn = document.getElementById('saveBtn');
clearBtn.addEventListener('click', ()=>{ ic.clearRect(0,0,ink.width,ink.height); });
saveBtn.addEventListener('click', ()=>{
  const url = mergeForExport();
  const a = document.createElement('a');
  a.href = url; a.download = 'dessin.png';
  a.click();
});

const ink = document.getElementById('ink');
const out = document.getElementById('outline');
const ic = ink.getContext('2d');
const oc = out.getContext('2d');

let resizePending = false;
function fitCanvas(cnv){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = cnv.getBoundingClientRect();
  const w = Math.max(1, Math.round(rect.width * dpr));
  const h = Math.max(1, Math.round(rect.height * dpr));
  if (cnv.width !== w || cnv.height !== h){
    cnv.width = w; cnv.height = h;
    const ctx = cnv.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
}
function resizeAllImmediate(){
  fitCanvas(ink); fitCanvas(out);
  drawOutline();
  syncScratch();
  rebuildMaskCache();
}
function requestResize(){
  if(resizePending) return;
  resizePending = true;
  requestAnimationFrame(()=>{
    resizePending=false;
    resizeAllImmediate();
  });
}
const ro = new ResizeObserver(()=>{ requestResize(); });
ro.observe(out);

let currentShape = 'blob';
let userMask = null;
const maskCanvas = document.createElement('canvas');
const maskCtx = maskCanvas.getContext('2d');
let maskImageData = null;

const fitModeEl = document.getElementById('fitMode');
const maskSourceEl = document.getElementById('maskSource');
fitModeEl.addEventListener('change', ()=>{ rebuildMaskCache(); redrawMaskGuide(); });
maskSourceEl.addEventListener('change', ()=>{ rebuildMaskCache(); redrawMaskGuide(); });

function loadUserMaskFromURL(url, revoke=false){
  const img = new Image();
  img.onload = ()=>{
    if(revoke) URL.revokeObjectURL(url);
    userMask = img;
    shapeButtons?.forEach(btn=>btn.classList.remove('active'));
    rebuildMaskCache();
    drawOutline();
    closeMaskModal();
  };
  img.onerror = ()=>{ if(revoke) URL.revokeObjectURL(url); alert('Impossible de charger cette image.'); };
  img.src = url;
}
async function loadUserMaskFromFile(file){
  const url = URL.createObjectURL(file);
  await loadUserMaskFromURL(url, true);
}

const outlineFileEl = document.getElementById('outlineFile');
outlineFileEl.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  await loadUserMaskFromFile(file);
  redrawMaskGuide();
});

function computeFit(destW,destH, imgW,imgH, mode){
  if(mode==='stretch') return { x:0, y:0, w:destW, h:destH };
  const r = imgW/imgH, R = destW/destH;
  if(mode==='cover'){
    const w = R>r ? destW : destH*r;
    const h = R>r ? destW/r : destH;
    const x = (destW - w)/2; const y = (destH - h)/2;
    return {x,y,w,h};
  } else {
    const w = R>r ? destH*r : destW;
    const h = R>r ? destH : destW/r;
    const x = (destW - w)/2; const y = (destH - h)/2;
    return {x,y,w,h};
  }
}

function rebuildMaskCache(){
  if(!userMask){ maskImageData=null; return; }
  maskCanvas.width = out.width;
  maskCanvas.height = out.height;
  maskCtx.setTransform(oc.getTransform());
  maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
  const rect = out.getBoundingClientRect();
  const fit = computeFit(rect.width, rect.height, userMask.naturalWidth, userMask.naturalHeight, fitModeEl.value);
  maskCtx.drawImage(userMask, fit.x, fit.y, fit.w, fit.h);

  const img = maskCtx.getImageData(0,0,maskCanvas.width, maskCanvas.height);
  const data = img.data; const mode = maskSourceEl.value;
  for(let i=0;i<data.length; i+=4){
    const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
    let alpha = a;
    if(mode==='luma'){
      const y = 0.2126*r + 0.7152*g + 0.0722*b; alpha = y;
    } else if(mode==='alpha-invert'){
      alpha = 255 - a;
    }
    data[i]=255; data[i+1]=255; data[i+2]=255; data[i+3]=alpha;
  }
  maskCtx.putImageData(img,0,0);
  maskImageData = img;
}

function makePath(kind, w, h){
  const p = new Path2D();
  const pad = Math.min(w,h)*0.12;
  const cx=w/2, cy=h/2;
  if(kind==='rect'){
    const r = Math.min(w,h)*0.18;
    const x=pad, y=pad, rw=w-2*pad, rh=h-2*pad;
    roundRectPath(p,x,y,rw,rh,r);
  } else if(kind==='blob'){
    const rx=w*0.32, ry=h*0.28;
    blobPath(p, cx, cy, rx, ry);
  } else if(kind==='star'){
    starPath(p, cx, cy, Math.min(w,h)*0.36, 5);
  } else if(kind==='heart'){
    heartPath(p, cx, cy, Math.min(w,h)*0.36);
  }
  return p;
}
function roundRectPath(p,x,y,w,h,r){
  p.moveTo(x+r,y);
  p.arcTo(x+w,y,x+w,y+h,r);
  p.arcTo(x+w,y+h,x,y+h,r);
  p.arcTo(x,y+h,x,y,r);
  p.arcTo(x,y,x+w,y,r);
  p.closePath();
}
function blobPath(p, cx, cy, rx, ry){
  p.moveTo(cx, cy-ry);
  p.bezierCurveTo(cx+rx*0.6, cy-ry, cx+rx, cy-ry*0.2, cx+rx, cy);
  p.bezierCurveTo(cx+rx, cy+ry*0.6, cx+rx*0.4, cy+ry, cx, cy+ry);
  p.bezierCurveTo(cx-rx*0.6, cy+ry, cx-rx, cy+ry*0.2, cx-rx, cy);
  p.bezierCurveTo(cx-rx, cy-ry*0.6, cx-rx*0.4, cy-ry, cx, cy-ry);
  p.closePath();
}
function starPath(p, cx, cy, r, spikes){
  const step=Math.PI/spikes; let rot=Math.PI/2*3; let x=cx; let y=cy - r;
  p.moveTo(cx, cy - r);
  for(let i=0;i<spikes;i++){
    x = cx + Math.cos(rot)*r; y = cy + Math.sin(rot)*r; p.lineTo(x,y); rot += step;
    x = cx + Math.cos(rot)*r*0.5; y = cy + Math.sin(rot)*r*0.5; p.lineTo(x,y); rot += step;
  }
  p.closePath();
}
function heartPath(p, cx, cy, s){
  const top = cy - s*0.25;
  p.moveTo(cx, top);
  p.bezierCurveTo(cx + s*0.5, top - s*0.6, cx + s, cy - s*0.05, cx, cy + s*0.75);
  p.bezierCurveTo(cx - s, cy - s*0.05, cx - s*0.5, top - s*0.6, cx, top);
  p.closePath();
}

let shapePath = null;
function drawOutline(){
  const rect = out.getBoundingClientRect();
  shapePath = makePath(currentShape, rect.width, rect.height);
  oc.clearRect(0,0,out.width,out.height);
  if(userMask){ redrawMaskGuide(); }
  else {
    oc.save();
    oc.fillStyle = '#ffffff';
    oc.globalAlpha = 0.08;
    oc.fill(shapePath);
    oc.globalAlpha = 1;
    oc.lineWidth = 6;
    oc.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--edge') || '#0f172a';
    oc.stroke(shapePath);
    oc.restore();
  }
}

function redrawMaskGuide(){
  oc.clearRect(0,0,out.width,out.height);
  if(!userMask){
    oc.save();
    oc.fillStyle = '#ffffff';
    oc.globalAlpha = 0.08;
    oc.fill(shapePath);
    oc.globalAlpha = 1;
    oc.lineWidth = 6;
    oc.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--edge') || '#0f172a';
    oc.stroke(shapePath);
    oc.restore();
    return;
  }
  const rect = out.getBoundingClientRect();
  const fit = computeFit(rect.width, rect.height, userMask.naturalWidth, userMask.naturalHeight, fitModeEl.value);
  oc.save();
  oc.globalAlpha = 0.3;
  oc.drawImage(userMask, fit.x, fit.y, fit.w, fit.h);
  oc.restore();
}

const scratch = document.createElement('canvas');
const sc = scratch.getContext('2d');
function syncScratch(){
  scratch.width = ink.width;
  scratch.height = ink.height;
  sc.setTransform(ic.getTransform());
  sc.clearRect(0,0,scratch.width,scratch.height);
}

let drawing=false, prev=null;
const supportsPathClip = (function(){
  try{
    const c = document.createElement('canvas').getContext('2d');
    const p = new Path2D(); p.rect(0,0,1,1);
    c.save(); c.clip(p); c.restore();
    return true;
  }catch(e){ return false; }
})();

function getPos(e){
  const r = ink.getBoundingClientRect();
  if(e.touches && e.touches[0]){
    return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
  }
  return { x: (e.clientX||e.x) - r.left, y: (e.clientY||e.y) - r.top };
}
function begin(e){ drawing=true; prev=getPos(e); e.preventDefault(); }
function end(){ drawing=false; prev=null; }
function draw(e){
  if(!drawing) return;
  const cur = getPos(e);
  const size = brushSize;
  const color = currentColor;
  const erasing = isErasing;

  if(userMask){
    sc.save();
    sc.lineCap='round'; sc.lineJoin='round'; sc.lineWidth=size;
    sc.globalCompositeOperation='source-over';
    sc.strokeStyle = erasing ? '#000' : color;
    sc.beginPath(); sc.moveTo(prev.x, prev.y); sc.lineTo(cur.x, cur.y); sc.stroke();
    sc.globalCompositeOperation='destination-in';
    sc.drawImage(maskCanvas,0,0);
    sc.restore();
    ic.save();
    ic.globalCompositeOperation = erasing ? 'destination-out' : 'source-over';
    ic.drawImage(scratch,0,0);
    ic.restore();
    sc.clearRect(0,0,scratch.width,scratch.height);
  } else {
    if(!shapePath) return;
    if(supportsPathClip){
      ic.save();
      ic.clip(shapePath);
      ic.lineCap='round'; ic.lineJoin='round'; ic.lineWidth=size;
      ic.globalCompositeOperation = erasing ? 'destination-out' : 'source-over';
      ic.strokeStyle = erasing ? 'rgba(0,0,0,1)' : color;
      ic.beginPath(); ic.moveTo(prev.x, prev.y); ic.lineTo(cur.x, cur.y); ic.stroke();
      ic.restore();
    } else {
      if(!maskImageData){
        maskCanvas.width = out.width; maskCanvas.height = out.height;
        maskCtx.setTransform(oc.getTransform());
        maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
        maskCtx.fillStyle = '#fff';
        maskCtx.fill(shapePath);
        maskImageData = maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);
      }
      sc.save(); sc.lineCap='round'; sc.lineJoin='round'; sc.lineWidth=size;
      sc.globalCompositeOperation='source-over';
      sc.strokeStyle = erasing ? '#000' : color;
      sc.beginPath(); sc.moveTo(prev.x, prev.y); sc.lineTo(cur.x, cur.y); sc.stroke();
      sc.globalCompositeOperation='destination-in';
      sc.putImageData(maskImageData,0,0);
      sc.restore();
      ic.save(); ic.globalCompositeOperation = erasing ? 'destination-out' : 'source-over';
      ic.drawImage(scratch,0,0);
      ic.restore();
      sc.clearRect(0,0,scratch.width,scratch.height);
    }
  }

  prev = cur;
  e.preventDefault();
}

ink.addEventListener('pointerdown', begin);
window.addEventListener('pointerup', end);
window.addEventListener('pointercancel', end);
window.addEventListener('pointerout', (e)=>{ if(e.target===ink) end(); });
window.addEventListener('pointermove', draw, {passive:false});
ink.addEventListener('touchstart', begin, {passive:false});
window.addEventListener('touchend', end, {passive:false});
window.addEventListener('touchmove', draw, {passive:false});

function mergeForExport(){
  const merge = document.createElement('canvas');
  merge.width = ink.width;
  merge.height = ink.height;
  const mc = merge.getContext('2d');
  mc.setTransform(ic.getTransform());
  mc.drawImage(out,0,0);
  mc.drawImage(ink,0,0);
  if(signatureEnable.checked && signatureTextInput.value.trim()){
    mc.save();
    mc.font = '32px "Comic Sans MS", "Marker Felt", cursive';
    mc.fillStyle = '#111';
    mc.textAlign = 'right';
    mc.textBaseline = 'bottom';
    mc.fillText(signatureTextInput.value.trim(), merge.width - 24, merge.height - 24);
    mc.restore();
  }
  return merge.toDataURL('image/png');
}

const maskModal = document.getElementById('maskModal');
const maskBtn = document.getElementById('maskBtn');
const closeMask = document.getElementById('closeMask');
function openMaskModal(){ maskModal.classList.add('open'); maskModal.setAttribute('aria-hidden','false'); }
function closeMaskModal(){ maskModal.classList.remove('open'); maskModal.setAttribute('aria-hidden','true'); }
maskBtn.addEventListener('click', openMaskModal);
closeMask.addEventListener('click', closeMaskModal);
maskModal.addEventListener('click', (e)=>{ if(e.target===maskModal) closeMaskModal(); });

const shapeButtons = Array.from(document.querySelectorAll('#shapeGrid .mask-option'));
function selectShape(shape){
  userMask = null;
  maskImageData = null;
  currentShape = shape;
  shapeButtons.forEach(btn=>btn.classList.toggle('active', btn.dataset.shape===shape));
  drawOutline();
  closeMaskModal();
}
shapeButtons.forEach(btn=>{
  btn.addEventListener('click', ()=> selectShape(btn.dataset.shape));
});
selectShape('blob');

const presetGrid = document.getElementById('presetGrid');
const presetStatus = document.getElementById('presetStatus');
function enablePresets(){
  if(!window.PNG_ARRAY || !Array.isArray(window.PNG_ARRAY) || window.PNG_ARRAY.length===0){
    presetGrid.innerHTML = '';
    presetGrid.classList.add('empty');
    presetStatus.textContent = getLang()==='fr'
      ? 'Aucun PNG trouvé. Ajoutez ../../js/cvipngarray.js.'
      : 'No PNG list found. Include ../../js/cvipngarray.js.';
    return;
  }
  presetGrid.classList.remove('empty');
  presetStatus.textContent = getLang()==='fr'
    ? `Chargé ${window.PNG_ARRAY.length} PNG.`
    : `Loaded ${window.PNG_ARRAY.length} PNGs.`;
  presetGrid.innerHTML = '';
  window.PNG_ARRAY.forEach(item=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'mask-option';
    btn.dataset.src = item.file;
    btn.innerHTML = `<img src="${item.file}" alt="${item.name}"><span>${item.name}</span>`;
    btn.addEventListener('click', ()=>{
      loadUserMaskFromURL(item.file);
    });
    presetGrid.appendChild(btn);
  });
}
window.addEventListener('DOMContentLoaded', ()=> setTimeout(enablePresets, 0));

window.addEventListener('resize', requestResize);

requestResize();
</script>
</body>
</html>
