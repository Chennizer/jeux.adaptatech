<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title class="translate" data-fr="PDF ‚Äî Avancer en cliquant" data-en="PDF ‚Äî Click to Advance">PDF ‚Äî Avancer en cliquant</title>

  <!-- pdf.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js"></script>

  <style>
    :root{ --teal:#009688; --bg:#000; --fg:#fff; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden; }

    /* Canvas layer (below UI) */
    #stage{
      position:fixed; inset:0; display:grid; place-items:center; background:#000;
      cursor:pointer; z-index:1;   /* <- keep BELOW the UI */
    }
    canvas{ display:block; max-width:100vw; max-height:100vh; }

    /* UI layers (above canvas) */
    #topbar{
      position:fixed; top:10px; left:10px; right:10px; display:flex; gap:10px; align-items:center;
      justify-content:space-between; z-index:5;    /* <- above */
    }
    #pickerRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      background:var(--teal); color:#fff; border:none; border-radius:12px; padding:12px 16px;
      font-weight:800; cursor:pointer; font-size:16px; box-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    #fileInput{ padding:8px; border-radius:10px; border:1px solid #333; background:#111; color:#ddd; }
    #tips{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px;
      border:1px dashed #444; border-radius:10px; background:#0a0a0a; color:#ddd; font-size:14px; z-index:5; }

    #centerPrompt{
      position:fixed; inset:0; display:grid; place-items:center; z-index:6;  /* <- above everything */
      background: radial-gradient(transparent, rgba(0,0,0,.35) 60%);
    }
    #centerPrompt .card{
      text-align:center; background:#111; border:1px solid #333; border-radius:16px;
      padding:20px; max-width:min(700px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.4);
    }
    #chooseBtnBig{ font-size:18px; padding:14px 18px; }

    #hud{
      position:fixed; left:12px; bottom:12px; padding:6px 10px;
      background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.2);
      border-radius:10px; font-size:14px; user-select:none; z-index:5;
    }

    #langToggle{
      position:fixed; top:10px; right:10px; z-index:7;
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:10px; border:2px solid var(--teal); background:#111; color:#fff; cursor:pointer; user-select:none;
    }
  </style>
</head>
<body>
  <!-- Language toggle -->
  <div id="langToggle" title="Basculer la langue / Toggle language">FR / EN</div>

  <div id="topbar">
    <div id="pickerRow">
      <button id="chooseBtn" class="btn">
        <span class="translate" data-fr="Choisir un PDF" data-en="Choose PDF">Choisir un PDF</span>
      </button>
      <input id="fileInput" type="file" accept="application/pdf" />
      <button id="startBtn" class="btn" disabled>
        <span class="translate" data-fr="D√©marrer (plein √©cran)" data-en="Start (Fullscreen)">D√©marrer (plein √©cran)</span>
      </button>
    </div>
    <div id="tips">
      <span>üñ±Ô∏è</span>
      <span class="translate" data-fr="Cliquez n‚Äôimporte o√π pour avancer. Reboucle √† la fin."
            data-en="Click anywhere to advance. Loops at the end.">
        Cliquez n‚Äôimporte o√π pour avancer. Reboucle √† la fin.
      </span>
    </div>
  </div>

  <!-- Big central prompt (first-run helper) -->
  <div id="centerPrompt">
    <div class="card">
      <h2 class="translate" data-fr="Charger un PDF" data-en="Load a PDF">Charger un PDF</h2>
      <p class="translate" data-fr="Appuyez sur le bouton ci-dessous pour choisir un fichier PDF multi-pages."
         data-en="Press the button below to choose a multi-page PDF file.">
        Appuyez sur le bouton ci-dessous pour choisir un fichier PDF multi-pages.
      </p>
      <button id="chooseBtnBig" class="btn">
        <span class="translate" data-fr="Choisir un PDF‚Ä¶" data-en="Choose PDF‚Ä¶">Choisir un PDF‚Ä¶</span>
      </button>
      <p style="opacity:.8; margin-top:10px" class="translate"
         data-fr="Astuce : vous pouvez aussi d√©poser un PDF dans la fen√™tre."
         data-en="Tip: you can also drop a PDF into the window.">
         Astuce : vous pouvez aussi d√©poser un PDF dans la fen√™tre.
      </p>
    </div>
  </div>

  <!-- Canvas display (below UI) -->
  <div id="stage" aria-label="Zone d‚Äôaffichage PDF">
    <canvas id="pageCanvas" aria-hidden="true"></canvas>
  </div>

  <div id="hud"><span id="pageLabel">‚Äî</span></div>

  <script>
    // ===== Language toggle =====
    const langToggle = document.getElementById('langToggle');
    let currentLang = 'fr';
    function applyLang(){
      document.querySelectorAll('.translate').forEach(el=>{
        const txt = el.dataset[currentLang];
        if (txt) el.textContent = txt;
      });
    }
    langToggle.addEventListener('click', ()=>{
      currentLang = (currentLang === 'fr') ? 'en' : 'fr';
      applyLang();
    });
    applyLang();

    // ===== Elements =====
    const pdfjsLibGlobal = window['pdfjsLib'];
    const chooseBtn = document.getElementById('chooseBtn');
    const chooseBtnBig = document.getElementById('chooseBtnBig');
    const fileInput = document.getElementById('fileInput');
    const startBtn  = document.getElementById('startBtn');
    const stage     = document.getElementById('stage');
    const canvas    = document.getElementById('pageCanvas');
    const ctx       = canvas.getContext('2d');
    const hudLabel  = document.getElementById('pageLabel');
    const centerPrompt = document.getElementById('centerPrompt');

    // ===== State =====
    let pdfDoc = null, currentPageNum = 1, totalPages = 0, started = false, loading = false, pdfData = null;

    function setHUD(){ hudLabel.textContent = pdfDoc ? `${currentPageNum} / ${totalPages}` : '‚Äî'; }
    async function goFullscreen(){ if (!document.fullscreenElement){ try{ await document.documentElement.requestFullscreen(); }catch(_){ } } }
    function hideCenterPrompt(){ centerPrompt.style.display = 'none'; }

    // Clear "Choose PDF" handlers
    chooseBtn.addEventListener('click', ()=> fileInput.click());
    chooseBtnBig.addEventListener('click', ()=> fileInput.click());

    // Drag & drop
    ;['dragenter','dragover'].forEach(ev=>{
      window.addEventListener(ev, e=>{ e.preventDefault(); }, {passive:false});
    });
    window.addEventListener('drop', async e=>{
      e.preventDefault();
      const file = [...(e.dataTransfer?.files||[])].find(f=>f.type==='application/pdf' || f.name?.toLowerCase().endsWith('.pdf'));
      if (file){ await loadPDFFile(file); }
    });

    // File selection
    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      await loadPDFFile(file);
    });

    async function loadPDFFile(file){
      const arrBuf = await file.arrayBuffer();
      pdfData = arrBuf;
      startBtn.disabled = false;
      hideCenterPrompt();
    }

    // Start viewer
    startBtn.addEventListener('click', async ()=>{
      if (!pdfData) return;
      await goFullscreen();
      started = true;
      await openAndRender();
    });

    async function openAndRender(){
      try{
        const loadingTask = pdfjsLibGlobal.getDocument({ data: pdfData });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        currentPageNum = 1;
        await renderPage(currentPageNum);
        setHUD();
      }catch(err){
        console.error('PDF load error:', err);
        alert(currentLang === 'fr' ? "Erreur de chargement du PDF." : "Error loading PDF.");
      }
    }

    // Render page
    async function renderPage(pageNum){
      if (!pdfDoc || loading) return;
      loading = true;
      try{
        const page = await pdfDoc.getPage(pageNum);
        const viewportUnscaled = page.getViewport({ scale: 1 });
        const availW = window.innerWidth;
        const availH = window.innerHeight;
        const scale = Math.min(availW / viewportUnscaled.width, availH / viewportUnscaled.height);
        const viewport = page.getViewport({ scale: scale * (window.devicePixelRatio || 1) });

        canvas.width  = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        canvas.style.width  = Math.floor(viewport.width  / (window.devicePixelRatio || 1)) + 'px';
        canvas.style.height = Math.floor(viewport.height / (window.devicePixelRatio || 1)) + 'px';

        await page.render({ canvasContext: ctx, viewport }).promise;
      }catch(err){
        console.error('Render error:', err);
      }finally{
        loading = false;
      }
    }

    // Advance on click/tap anywhere
    stage.addEventListener('click', async ()=>{
      if (!started || !pdfDoc || loading) return;
      currentPageNum = (currentPageNum % totalPages) + 1;
      await renderPage(currentPageNum);
      setHUD();
    });

    // Keyboard controls
    window.addEventListener('keydown', async (e)=>{
      if (!started || !pdfDoc || loading) return;
      if (e.code === 'Space' || e.code === 'ArrowRight'){
        e.preventDefault();
        currentPageNum = (currentPageNum % totalPages) + 1;
        await renderPage(currentPageNum);
        setHUD();
      } else if (e.code === 'ArrowLeft'){
        e.preventDefault();
        currentPageNum = (currentPageNum - 2 + totalPages) % totalPages + 1;
        await renderPage(currentPageNum);
        setHUD();
      }
    });

    // Re-fit on resize
    window.addEventListener('resize', ()=>{
      if (!started || !pdfDoc) return;
      clearTimeout(window.__resizeT);
      window.__resizeT = setTimeout(()=>renderPage(currentPageNum), 100);
    });

    // Auto-hide cursor after inactivity
    let hideTimer = null;
    function scheduleCursorHide(){
      document.body.style.cursor = 'default';
      clearTimeout(hideTimer);
      hideTimer = setTimeout(()=>{ document.body.style.cursor = 'none'; }, 1500);
    }
    ['mousemove','mousedown','touchstart','keydown'].forEach(ev=>{
      window.addEventListener(ev, scheduleCursorHide, {passive:true});
    });
    scheduleCursorHide();
  </script>
  <script src="../../js/home-button.js"></script>
</body>
</html>
