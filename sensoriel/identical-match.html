<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="../images/binou.png" />
  <link rel="stylesheet" href="../css/ipadteachh.css" />
  <title>Trouver la même image</title>

  <script src="../js/themes.js"></script>
  <script src="js/games-config.js"></script>
  <script src="js/session-helpers.js"></script>
  <script src="js/reinforcer-overlay.js"></script>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    :root {
      --shell-max-width: 1120px;
      --shell-radius: 28px;
      --shell-padding: clamp(22px, 5vw, 44px);
      --shell-gap: clamp(24px, 4vw, 38px);
      --accent: #0ea5e9;
      --accent-soft: rgba(14, 165, 233, 0.14);
      --success: #22c55e;
      --error: #f87171;
      --surface: #ffffff;
      --text-primary: #0f172a;
      --text-muted: #475569;
    }

    body {
      min-height: 100vh;
      margin: 0;
      padding: clamp(14px, 4vw, 36px);
      font-family: 'Nunito', 'Arial', sans-serif;
      background: linear-gradient(155deg, #f1f5f9 0%, #cffafe 45%, #dbeafe 100%);
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .game-shell {
      width: min(100%, var(--shell-max-width));
      background: var(--surface);
      border-radius: var(--shell-radius);
      box-shadow: 0 24px 48px rgba(14, 165, 233, 0.18);
      padding: var(--shell-padding);
      display: flex;
      flex-direction: column;
      gap: var(--shell-gap);
      position: relative;
      overflow: hidden;
    }

    .game-header {
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: clamp(10px, 2vw, 18px);
      align-items: center;
    }

    .activity-title {
      font-size: clamp(1.9rem, 2vw + 1.1rem, 2.8rem);
      font-weight: 800;
      letter-spacing: 0.03em;
    }

    .game-instruction {
      font-size: clamp(1.1rem, 1.3vw + 0.8rem, 1.45rem);
      color: var(--text-muted);
      max-width: 680px;
      margin: 0;
    }

    .round-indicator {
      font-size: clamp(1rem, 1.1vw + 0.8rem, 1.3rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      color: rgba(15, 23, 42, 0.65);
      text-transform: uppercase;
    }

    .match-area {
      display: grid;
      grid-template-columns: minmax(220px, 1fr) minmax(0, 1.6fr);
      gap: clamp(22px, 5vw, 40px);
      align-items: center;
    }

    .target-card {
      border-radius: 32px;
      background: linear-gradient(160deg, rgba(14, 165, 233, 0.12), rgba(255, 255, 255, 0.95));
      border: 4px solid rgba(14, 165, 233, 0.18);
      padding: clamp(18px, 3vw, 28px);
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 3vw, 28px);
      align-items: center;
      justify-content: center;
      text-align: center;
      box-shadow: inset 0 0 0 1px rgba(14, 165, 233, 0.18);
    }

    .target-card img {
      width: clamp(180px, 28vw, 260px);
      max-height: clamp(220px, 30vw, 320px);
      object-fit: contain;
      filter: drop-shadow(0 18px 26px rgba(14, 165, 233, 0.28));
    }

    .target-label {
      font-size: clamp(1.2rem, 1.4vw + 0.8rem, 1.6rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      color: rgba(15, 23, 42, 0.72);
    }

    .choice-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: clamp(18px, 3vw, 28px);
    }

    .choice-card {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 26px;
      border: 3px solid transparent;
      padding: clamp(14px, 3vw, 22px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      box-shadow: 0 16px 30px rgba(14, 165, 233, 0.12);
      touch-action: manipulation;
    }

    .choice-card img {
      width: clamp(120px, 22vw, 190px);
      max-height: clamp(150px, 26vw, 220px);
      object-fit: contain;
      pointer-events: none;
    }

    .choice-card:focus {
      outline: none;
      border-color: rgba(14, 165, 233, 0.55);
      box-shadow: 0 0 0 6px rgba(14, 165, 233, 0.18);
    }

    .choice-card:hover {
      transform: translateY(-6px);
    }

    .choice-card.is-correct {
      border-color: rgba(34, 197, 94, 0.85);
      box-shadow: 0 20px 36px rgba(34, 197, 94, 0.18);
      background: linear-gradient(150deg, rgba(34, 197, 94, 0.12), rgba(236, 253, 245, 0.95));
    }

    .choice-card.is-incorrect {
      border-color: rgba(248, 113, 113, 0.85);
      box-shadow: 0 12px 20px rgba(248, 113, 113, 0.2);
      animation: shake 0.3s ease;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      50% { transform: translateX(8px); }
      75% { transform: translateX(-8px); }
      100% { transform: translateX(0); }
    }

    #activityNumberOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.78);
      color: #fff;
      z-index: 10000;
      font-size: clamp(4rem, 9vw, 8rem);
      font-weight: 800;
      letter-spacing: 0.12em;
    }

    @media (max-width: 820px) {
      .match-area {
        grid-template-columns: 1fr;
      }

      .target-card {
        order: -1;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .choice-card,
      .target-card,
      .choice-card img {
        transition: none;
      }

      .choice-card:hover {
        transform: none;
      }
    }
  </style>
</head>
<body>
  <div id="activityNumberOverlay">
    <div class="number-text"></div>
  </div>

  <div class="game-shell">
    <header class="game-header">
      <div class="activity-title">Trouve l'image identique</div>
      <p class="game-instruction">Regarde bien l'image modèle puis sélectionne la même image dans la grille.</p>
      <div class="round-indicator" id="round-indicator" aria-live="polite">1 / 1</div>
    </header>

    <section class="match-area">
      <article class="target-card">
        <img id="target-image" src="" alt="Image cible" />
        <div class="target-label" id="target-label">Image cible</div>
      </article>
      <section class="choice-grid" id="choice-grid" aria-live="polite"></section>
    </section>
  </div>

  <audio id="error-sound" src="" preload="auto"></audio>
  <audio id="word-reward-sound" src="" preload="auto"></audio>
  <audio id="final-reward-sound" src="" preload="auto"></audio>

  <script>
    (function () {
      'use strict';

      const DEFAULT_IMAGE = '../images/binou.png';

      function clamp(value, min, max) {
        const numeric = Number.parseInt(value, 10);
        if (Number.isNaN(numeric)) {
          return min;
        }
        return Math.min(Math.max(numeric, min), max);
      }

      function shuffle(array) {
        for (let index = array.length - 1; index > 0; index -= 1) {
          const j = Math.floor(Math.random() * (index + 1));
          [array[index], array[j]] = [array[j], array[index]];
        }
        return array;
      }

      function prettifyLabel(src) {
        if (!src || typeof src !== 'string') {
          return 'Illustration';
        }
        const fileName = src.split('/').pop() || '';
        const withoutExtension = fileName.replace(/\.[^.]+$/, '');
        const cleaned = withoutExtension.replace(/[-_]+/g, ' ').trim();
        if (!cleaned) {
          return 'Illustration';
        }
        return cleaned.split(' ').map(part => part ? part.charAt(0).toUpperCase() + part.slice(1) : '').join(' ');
      }

      function buildPool(themeData) {
        const candidates = [];
        if (themeData) {
          if (Array.isArray(themeData.transparentPNGs)) {
            candidates.push(...themeData.transparentPNGs.filter(Boolean));
          }
          if (Array.isArray(themeData.images)) {
            candidates.push(...themeData.images.filter(Boolean));
          }
        }
        if (candidates.length === 0) {
          candidates.push(DEFAULT_IMAGE);
        }
        const unique = Array.from(new Set(candidates));
        if (unique.length < 2) {
          const fallback = '../images/plasticbasket.png';
          if (!unique.includes(fallback)) {
            unique.push(fallback);
          } else {
            unique.push('../images/binou.png');
          }
        }
        return unique;
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (!window.sessionHelpers || typeof window.sessionHelpers.ensureCurrentGame !== 'function') {
          console.warn('Session helpers not available.');
          return;
        }

        const session = window.sessionHelpers.ensureCurrentGame('identical-match');
        if (!session) {
          return;
        }

        const { themeData } = session;
        const options = window.sessionHelpers.getCurrentGameOptions(session) || {};
        const choiceCount = clamp(options.choiceCount, 2, 6);
        const totalRounds = clamp(options.rounds, 1, 8);

        const roundIndicator = document.getElementById('round-indicator');
        const targetImage = document.getElementById('target-image');
        const targetLabel = document.getElementById('target-label');
        const choiceGrid = document.getElementById('choice-grid');

        const errorAudio = document.getElementById('error-sound');
        const successAudio = document.getElementById('word-reward-sound');
        const finalAudio = document.getElementById('final-reward-sound');

        if (errorAudio) {
          errorAudio.src = (themeData && themeData.errorSound) || '../sounds/error.mp3';
        }
        if (successAudio) {
          successAudio.src = (themeData && themeData.reinforcerSound) || '../sounds/success3.mp3';
        }
        if (finalAudio) {
          finalAudio.src = (themeData && themeData.finalRewardSound) || '../sounds/victory.mp3';
        }

        const reinforcerController = (window.sessionHelpers && typeof window.sessionHelpers.setupSharedReinforcer === 'function')
          ? window.sessionHelpers.setupSharedReinforcer(session)
          : null;

        function playAudio(audioEl) {
          if (!audioEl) {
            return;
          }
          audioEl.currentTime = 0;
          audioEl.play().catch(() => {});
        }

        function showFinalReinforcer() {
          playAudio(finalAudio);
          if (reinforcerController && typeof reinforcerController.show === 'function') {
            const reinforcerType = (session.selections && session.selections.reinforcerType) || 'shortvideo';
            reinforcerController.show({ reinforcerType });
          } else if (window.sessionHelpers && typeof window.sessionHelpers.advanceToNextGame === 'function') {
            window.sessionHelpers.advanceToNextGame();
          }
        }

        const pool = buildPool(themeData);
        let currentRound = 0;
        let currentTarget = null;
        let canInteract = true;

        function updateRoundIndicator() {
          if (roundIndicator) {
            roundIndicator.textContent = `${currentRound + 1} / ${totalRounds}`;
          }
        }

        function prepareRound() {
          canInteract = true;
          const availableChoices = pool.length >= choiceCount
            ? shuffle(pool.slice()).slice(0, choiceCount)
            : shuffle(pool.slice());

          if (availableChoices.length < choiceCount) {
            while (availableChoices.length < choiceCount) {
              const candidate = pool[availableChoices.length % pool.length];
              if (!availableChoices.includes(candidate)) {
                availableChoices.push(candidate);
              } else {
                availableChoices.push(DEFAULT_IMAGE);
              }
            }
          }

          const labelledChoices = availableChoices.map((src, index) => ({
            id: `${src}__${index}_${currentRound}`,
            src,
            label: prettifyLabel(src)
          }));

          currentTarget = labelledChoices[Math.floor(Math.random() * labelledChoices.length)];

          targetImage.src = currentTarget.src;
          targetImage.alt = `Image cible : ${currentTarget.label}`;
          targetLabel.textContent = currentTarget.label;

          choiceGrid.innerHTML = '';
          shuffle(labelledChoices).forEach(choice => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'choice-card';
            button.dataset.src = choice.src;
            button.setAttribute('aria-label', choice.label);

            const img = document.createElement('img');
            img.src = choice.src;
            img.alt = choice.label;
            button.appendChild(img);

            button.addEventListener('click', () => {
              if (!canInteract) {
                return;
              }
              canInteract = false;

              const isCorrect = button.dataset.src === currentTarget.src;
              if (isCorrect) {
                button.classList.add('is-correct');
                playAudio(successAudio);
                currentRound += 1;
                updateRoundIndicator();
                if (currentRound >= totalRounds) {
                  setTimeout(() => {
                    showFinalReinforcer();
                  }, 800);
                } else {
                  setTimeout(() => {
                    button.classList.remove('is-correct');
                    prepareRound();
                  }, 800);
                }
              } else {
                button.classList.add('is-incorrect');
                playAudio(errorAudio);
                setTimeout(() => {
                  button.classList.remove('is-incorrect');
                  canInteract = true;
                }, 600);
              }
            });

            choiceGrid.appendChild(button);
          });
        }

        function startGame() {
          currentRound = 0;
          updateRoundIndicator();
          prepareRound();
        }

        if (window.sessionHelpers && typeof window.sessionHelpers.showActivityOverlay === 'function') {
          window.sessionHelpers.showActivityOverlay(() => {
            if (typeof window.sessionHelpers.updateActivityMarker === 'function') {
              window.sessionHelpers.updateActivityMarker(session);
            }
            startGame();
          }, session);
        } else {
          startGame();
        }
      });
    })();
  </script>
</body>
</html>
