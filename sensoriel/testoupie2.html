<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="../../images/binou.png">
  <link rel="stylesheet" href="../../css/ipadteachh.css">
  <title>Jeu de Complétion de Mot</title>
  <style>
    /* Your original CSS styles */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    .game-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: calc(100% - 60px);
      height: calc(100% - 60px);
      max-width: 1200px;
      padding: 20px;
      background-color: #ffffff;
      position: relative;
      overflow: hidden;
      border-radius: 15px;
    }

    /* ... (keep all your original CSS styles exactly as provided) ... */

    /* Video Overlay Cover */
    #videoOverlayCover {
        display: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        pointer-events: none; /* Prevents the overlay from capturing clicks */
        z-index: 10;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="letters-container" id="letters-container"></div>
    <div class="target-word-container">
      <img src="../../images/binou.png" alt="Binou Image" class="target-image" id="target-image">
      <div class="target-word" id="target-word"></div>
    </div>
  </div>

  <!-- Reinforcer Overlay for Video -->
  <div id="reinforcerOverlay">
    <button id="reinforcerButton" aria-label="Voir la vidéo de renforcement"></button>
    <video
      id="reinforcerVideo"
      playsinline
      webkit-playsinline
      disablepictureinpicture
      controlslist="nodownload noremoteplayback"
      preload="auto"
    >
      <source src="../../videos/africa.mp4" type="video/mp4">
      Votre navigateur ne supporte pas la balise vidéo.
    </video>
    <div id="videoOverlayCover"></div>
  </div>

  <!-- Audio files -->
  <audio id="error-sound" src="../../sounds/error.mp3" preload="auto"></audio>
  <audio id="word-reward-sound" src="../../sounds/rooster.mp3" preload="auto"></audio>
  <audio id="final-reward-sound" src="../../sounds/victory.mp3" preload="auto"></audio>

  <script>
    // Game Variables
    const words = [
      { word: "Binou", image: "../../images/binou.png" },
      { word: "Toupie", image: "../../images/toupieetbinou.png" },
      { word: "Chaton", image: "../../images/chaton.png" },
      { word: "Pomme", image: "../../images/pomme.png" }
    ];
    
    let currentWordIndex = 0;
    const lettersContainer = document.getElementById('letters-container');
    let slots = [];

    // Speech Synthesis Setup
    const synth = window.speechSynthesis || window.webkitSpeechSynthesis;

    function speakText(text, callback) {
      if (!synth) {
        if (callback) callback();
        return;
      }

      const utterThis = new SpeechSynthesisUtterance(text);
      utterThis.lang = 'fr-FR';
      utterThis.rate = 0.9;

      const handleEnd = () => {
        if (callback) callback();
      };

      utterThis.onend = handleEnd;
      utterThis.onerror = handleEnd;

      try {
        synth.speak(utterThis);
      } catch (e) {
        console.error("Speech error:", e);
        handleEnd();
      }
    }

    // ... (keep all your game logic functions exactly as before until handleDrop) ...

    // Modified handleDrop function for Safari compatibility
    function handleDrop(draggedElement, slot) {
      const index = parseInt(slot.getAttribute('data-position'));
      const requiredLetter = words[currentWordIndex].word[index];
      const draggedLetter = draggedElement.dataset.letter;
      
      if (draggedLetter === requiredLetter) {
        const placedLetterDiv = slot.querySelector('.placed-letter');
        if (placedLetterDiv) placedLetterDiv.textContent = draggedLetter;
        slot.classList.add('filled');
        
        // Safari-optimized speech timing
        setTimeout(() => {
          speakText(draggedLetter, checkCompletion);
        }, 300);
        
        draggedElement.remove();
      } else {
        errorSound.currentTime = 0;
        errorSound.play();
        slot.classList.add('error');
        setTimeout(() => slot.classList.remove('error'), 500);
        appendToLettersContainer(draggedElement);
        positionLetterRandomly(draggedElement);
      }
    }

    // ... (keep remaining game logic functions exactly as before) ...

    // Video Controls
    reinforcerButton.addEventListener('click', () => {
      reinforcerButton.style.display = 'none';
      reinforcerOverlay.style.background = '#000';
      reinforcerVideo.style.display = 'block';
      videoOverlayCover.style.display = 'block';
      reinforcerVideo.play().catch(hideReinforcer);
    });

    reinforcerVideo.addEventListener('ended', hideReinforcer);

    function hideReinforcer() {
      reinforcerOverlay.style.display = 'none';
      reinforcerButton.style.display = 'flex';
      reinforcerVideo.style.display = 'none';
      reinforcerVideo.pause();
      reinforcerVideo.currentTime = 0;
      videoOverlayCover.style.display = 'none';
      reinforcerOverlay.style.background = 'rgba(0,0,0,0.8)';
    }

    // Initialize Game
    window.onload = () => {
      initializeTargetImage();
      initializeSlots();
      initializeLetters();
      insertModelLetters();
      attachSlotEventListeners();
    };
  </script>
</body>
</html>