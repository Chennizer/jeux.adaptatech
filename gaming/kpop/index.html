<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>K-pop Demon Hunter</title>
  <link rel="stylesheet" href="../../css/games.css" />
  <style>
    :root {
      color-scheme: dark;
      --pink: #ff58c4;
      --violet: #8a68ff;
      --gold: #ffd86a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 50% 0%, rgba(255, 133, 233, 0.18), transparent 55%),
                  radial-gradient(circle at 0% 100%, rgba(142, 112, 255, 0.16), transparent 50%),
                  #040006;
      overflow: hidden;
      color: #fff;
    }

    button {
      font: inherit;
    }

    #entryCurtain {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.4rem;
      padding: 2.5rem 1.5rem;
      text-align: center;
      background:
        radial-gradient(circle at 50% 20%, rgba(255, 88, 196, 0.16), transparent 60%),
        linear-gradient(135deg, rgba(6, 0, 18, 0.95), rgba(32, 5, 50, 0.95));
      z-index: 10;
      transition: transform 1.1s ease, opacity 0.9s ease;
    }

    #entryCurtain.opening {
      transform: translateY(-120%);
      opacity: 0;
      pointer-events: none;
    }

    .start-title {
      margin: 0;
      font-size: clamp(2rem, 5vw, 3.6rem);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .start-sub {
      margin: 0;
      max-width: 460px;
      color: rgba(255, 255, 255, 0.72);
      font-size: clamp(1rem, 3vw, 1.2rem);
      line-height: 1.6;
    }

    #startButton {
      padding: 0.95rem 2.4rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--pink), var(--violet));
      color: #120020;
      font-weight: 700;
      letter-spacing: 0.04em;
      cursor: pointer;
      box-shadow: 0 18px 40px rgba(255, 88, 196, 0.28);
      transition: transform 160ms ease, box-shadow 160ms ease;
    }

    #startButton:active {
      transform: translateY(2px);
      box-shadow: 0 10px 22px rgba(255, 88, 196, 0.32);
    }

    #entryCurtain::before,
    #entryCurtain::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(255, 216, 106, 0.35), transparent 65%);
      mix-blend-mode: screen;
      pointer-events: none;
      opacity: 0;
      animation: curtainPulse 3.6s ease-in-out infinite;
    }

    #entryCurtain::after {
      animation-delay: 1.6s;
    }

    @keyframes curtainPulse {
      0%, 100% { opacity: 0.05; }
      40% { opacity: 0.2; }
      70% { opacity: 0.08; }
    }

    main#gameStage {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .stage-backdrop {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 20%, rgba(255, 216, 106, 0.12), transparent 55%),
                  radial-gradient(circle at 20% 100%, rgba(255, 88, 196, 0.16), transparent 60%),
                  radial-gradient(circle at 80% 100%, rgba(138, 104, 255, 0.18), transparent 60%),
                  #030007;
      filter: contrast(1.05) brightness(0.9);
      transition: filter 0.6s ease;
      pointer-events: none;
    }

    .stage-backdrop::before {
      content: "";
      position: absolute;
      inset: -20% -40%;
      background: conic-gradient(from 90deg, rgba(255, 88, 196, 0.4), rgba(138, 104, 255, 0.0), rgba(255, 216, 106, 0.5), rgba(255, 88, 196, 0.0));
      filter: blur(70px);
      opacity: 0.55;
      animation: rotateGlow 12s linear infinite;
    }

    @keyframes rotateGlow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .light-rays {
      position: absolute;
      inset: 0;
      pointer-events: none;
      mix-blend-mode: screen;
      opacity: 0.4;
    }

    .light-rays::before,
    .light-rays::after {
      content: "";
      position: absolute;
      width: 160vw;
      height: 160vh;
      background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.14), transparent 60%);
      top: -30vh;
      left: -30vw;
      transform-origin: 50% 50%;
      animation: sweep 12s ease-in-out infinite;
    }

    .light-rays::after {
      background: radial-gradient(circle at 80% 25%, rgba(255, 216, 106, 0.18), transparent 65%);
      animation-delay: 6s;
    }

    @keyframes sweep {
      0%, 100% { transform: rotate(-6deg) scale(1); }
      50% { transform: rotate(6deg) scale(1.05); }
    }

    .silhouette-row {
      position: absolute;
      bottom: clamp(30px, 8vh, 80px);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: clamp(26px, 6vw, 90px);
      align-items: flex-end;
      z-index: 2;
      pointer-events: none;
    }

    .silhouette {
      width: clamp(120px, 20vw, 240px);
      aspect-ratio: 3 / 4.2;
      background-repeat: no-repeat;
      background-size: contain;
      background-position: center bottom;
      filter: brightness(0) saturate(100%);
      opacity: 0;
      transform: translateY(60px) scale(0.9);
    }

    .silhouette.intro {
      animation: silhouetteRise 1.3s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }

    @keyframes silhouetteRise {
      0% { opacity: 0; transform: translateY(90px) scale(0.85); }
      30% { opacity: 0.6; }
      60% { opacity: 1; transform: translateY(-12px) scale(1.03); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .silhouette.attack {
      animation: heroStrike 1.5s cubic-bezier(0.2, 0.85, 0.25, 1.1) forwards;
      filter: brightness(0) saturate(100%) drop-shadow(0 0 24px rgba(255, 216, 106, 0.45));
    }

    @keyframes heroStrike {
      0% { transform: translateY(0) scale(1); }
      35% { transform: translateY(-46px) scale(1.18); }
      55% { transform: translateY(-14px) scale(1.1); }
      100% { transform: translateY(0) scale(1); }
    }

    .silhouette.attack::after {
      content: "";
      position: absolute;
      inset: 8% 0 -4% 0;
      background: radial-gradient(circle at 50% 45%, rgba(255, 216, 106, 0.42), transparent 65%);
      filter: blur(18px);
      opacity: 0;
      animation: aura 1.5s ease-out forwards;
    }

    @keyframes aura {
      0% { opacity: 0; }
      25% { opacity: 1; }
      80% { opacity: 0.4; }
      100% { opacity: 0; }
    }

    #monsterLayer {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 3;
    }

    .monster {
      width: clamp(160px, 22vw, 240px);
      height: clamp(160px, 22vw, 240px);
      background-repeat: no-repeat;
      background-size: contain;
      background-position: center;
      opacity: 0;
      transform: scale(0.6);
      filter: drop-shadow(0 0 22px rgba(255, 88, 196, 0.5));
    }

    .monster.show {
      animation: monsterSpawn 0.9s cubic-bezier(0.25, 0.9, 0.45, 1.2) forwards;
    }

    @keyframes monsterSpawn {
      0% { opacity: 0; transform: scale(0.5) translateY(30px); }
      60% { opacity: 1; transform: scale(1.06) translateY(-10px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    .monster.vanish {
      animation: monsterVanish 0.6s ease-in forwards;
    }

    @keyframes monsterVanish {
      0% { opacity: 1; transform: scale(1) translateY(0); filter: drop-shadow(0 0 22px rgba(255, 216, 106, 0.75)); }
      60% { opacity: 0.3; transform: scale(0.65) translateY(-20px); }
      100% { opacity: 0; transform: scale(0.4) translateY(60px); }
    }

    .slash {
      position: absolute;
      width: clamp(220px, 30vw, 320px);
      height: clamp(120px, 16vw, 200px);
      pointer-events: none;
      background:
        radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.9), transparent 55%),
        radial-gradient(circle at 80% 60%, rgba(255, 216, 106, 0.85), transparent 60%),
        linear-gradient(120deg, rgba(255, 88, 196, 0.65), rgba(255, 255, 255, 0.35));
      border-radius: 40% 70% 50% 80%;
      opacity: 0;
      mix-blend-mode: screen;
      filter: blur(2px) drop-shadow(0 0 28px rgba(255, 216, 106, 0.45));
      animation: slashFlash 0.48s ease-out forwards;
    }

    @keyframes slashFlash {
      0% { opacity: 0; transform: scale(0.3) rotate(-24deg); }
      40% { opacity: 1; transform: scale(1.02) rotate(-18deg); }
      100% { opacity: 0; transform: scale(1.3) rotate(-10deg); }
    }

    #prompt {
      position: absolute;
      bottom: clamp(110px, 24vh, 220px);
      left: 50%;
      transform: translateX(-50%);
      padding: 0.75rem 1.6rem;
      border-radius: 999px;
      background: rgba(18, 0, 32, 0.62);
      color: #ffeefc;
      font-size: clamp(1rem, 2.6vw, 1.4rem);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      box-shadow: 0 10px 40px rgba(255, 88, 196, 0.28);
      z-index: 4;
      transition: opacity 0.3s ease;
    }

    #prompt.hidden {
      opacity: 0;
    }

    .stage-backdrop.bright {
      filter: contrast(1.15) brightness(1.2);
    }

    .sparkle-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      mix-blend-mode: screen;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .sparkle-layer.active {
      opacity: 1;
    }

    .sparkle-layer span {
      position: absolute;
      width: 6px;
      height: 6px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.9), transparent 70%);
      border-radius: 50%;
      opacity: 0;
      animation: sparkleTwinkle 1.5s ease-out infinite;
    }

    @keyframes sparkleTwinkle {
      0% { opacity: 0; transform: scale(0.5); }
      25% { opacity: 1; transform: scale(1.2); }
      60% { opacity: 0.5; transform: scale(0.8); }
      100% { opacity: 0; transform: scale(0.4); }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 1ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>
  <div id="entryCurtain">
    <h1 class="start-title">K-pop Demon Hunter</h1>
    <p class="start-sub">Press the button to start the show, then hit the SPACE bar whenever a demon appears. A hero silhouette will spring forward to protect the stage while the music plays.</p>
    <button id="startButton">Start the Show</button>
  </div>

  <main id="gameStage" aria-live="polite">
    <div class="stage-backdrop" id="stageBackdrop"></div>
    <div class="light-rays" aria-hidden="true"></div>
    <div class="sparkle-layer" id="sparkles" aria-hidden="true"></div>

    <div class="silhouette-row" aria-hidden="true">
      <div class="silhouette" data-hero="mira" style="background-image: url('../../images/kpop/mira.png');"></div>
      <div class="silhouette" data-hero="zoey" style="background-image: url('../../images/kpop/zoey.png');"></div>
      <div class="silhouette" data-hero="rumi" style="background-image: url('../../images/kpop/rumi.png');"></div>
    </div>

    <div id="monsterLayer" aria-hidden="true"></div>
    <div id="prompt">Press SPACE to banish the demon!</div>
  </main>

  <script>
    const HEROES = [
      { id: 'mira', sprite: "../../images/kpop/mira.png" },
      { id: 'zoey', sprite: "../../images/kpop/zoey.png" },
      { id: 'rumi', sprite: "../../images/kpop/rumi.png" }
    ];

    const MONSTERS = [
      "../../images/kpop/monster1.png",
      "../../images/kpop/monster2.png"
    ];

    const state = {
      started: false,
      attackInProgress: false,
      currentMonster: null,
      spawnTimer: null,
      music: null
    };

    const monsterLayer = document.getElementById('monsterLayer');
    const prompt = document.getElementById('prompt');
    const stageBackdrop = document.getElementById('stageBackdrop');
    const sparkles = document.getElementById('sparkles');

    function preloadAssets() {
      [...HEROES.map(h => h.sprite), ...MONSTERS, "../../songs/kpop/golden.mp3"].forEach(src => {
        const img = new Image();
        img.src = src;
      });
    }

    function createSparkles() {
      const count = 28;
      for (let i = 0; i < count; i++) {
        const star = document.createElement('span');
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = (Math.random() * 1.5).toFixed(2) + 's';
        star.style.animationDuration = (1.4 + Math.random()).toFixed(2) + 's';
        sparkles.appendChild(star);
      }
    }

    function startMusic() {
      if (state.music) {
        state.music.currentTime = 0;
        state.music.play().catch(() => {});
        return;
      }
      const audio = new Audio("../../songs/kpop/golden.mp3");
      audio.loop = true;
      audio.volume = 0.9;
      audio.play().catch(() => {});
      state.music = audio;
    }

    function introSilhouettes() {
      const silhouettes = Array.from(document.querySelectorAll('.silhouette'));
      silhouettes.forEach((el, index) => {
        setTimeout(() => {
          el.classList.add('intro');
        }, 300 * index);
      });
    }

    function spawnMonster(delay = 0) {
      clearTimeout(state.spawnTimer);
      state.spawnTimer = setTimeout(() => {
        if (state.attackInProgress || state.currentMonster) return;
        const monster = document.createElement('div');
        monster.className = 'monster';
        monster.style.backgroundImage = `url('${MONSTERS[Math.floor(Math.random() * MONSTERS.length)]}')`;
        monsterLayer.appendChild(monster);
        state.currentMonster = monster;
        requestAnimationFrame(() => monster.classList.add('show'));
        prompt.textContent = 'Press SPACE to banish the demon!';
        prompt.classList.remove('hidden');
      }, delay);
    }

    function removeMonster() {
      if (!state.currentMonster) return;
      const monster = state.currentMonster;
      monster.classList.add('vanish');
      monster.addEventListener('animationend', () => monster.remove(), { once: true });
      state.currentMonster = null;
    }

    function showSlashEffect() {
      if (!state.currentMonster) return;
      const rect = state.currentMonster.getBoundingClientRect();
      const stageRect = monsterLayer.getBoundingClientRect();
      const slash = document.createElement('div');
      slash.className = 'slash';
      slash.style.left = rect.left - stageRect.left + rect.width * 0.1 + 'px';
      slash.style.top = rect.top - stageRect.top - rect.height * 0.3 + 'px';
      monsterLayer.appendChild(slash);
      slash.addEventListener('animationend', () => slash.remove(), { once: true });
    }

    function triggerHeroAttack() {
      if (!state.currentMonster || state.attackInProgress) return;
      state.attackInProgress = true;
      prompt.classList.add('hidden');
      stageBackdrop.classList.add('bright');
      sparkles.classList.add('active');

      const hero = HEROES[Math.floor(Math.random() * HEROES.length)];
      const heroEl = document.querySelector(`.silhouette[data-hero="${hero.id}"]`);
      heroEl.classList.add('attack');

      showSlashEffect();
      removeMonster();

      setTimeout(() => {
        heroEl.classList.remove('attack');
        stageBackdrop.classList.remove('bright');
        sparkles.classList.remove('active');
        state.attackInProgress = false;
        spawnMonster(2200);
      }, 1500);
    }

    function startGame() {
      if (state.started) return;
      state.started = true;
      document.getElementById('entryCurtain').classList.add('opening');
      startMusic();
      introSilhouettes();
      spawnMonster(2600);
    }

    function handleKeydown(e) {
      if (e.code === 'Space') {
        e.preventDefault();
        triggerHeroAttack();
      }
    }

    document.getElementById('startButton').addEventListener('click', () => {
      startGame();
    });

    window.addEventListener('keydown', handleKeydown);

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        state.music?.pause();
      } else if (state.music && state.started) {
        state.music.play().catch(() => {});
      }
    });

    createSparkles();
    preloadAssets();
  </script>
</body>
</html>
