<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="../images/binou.png">
  <link rel="stylesheet" href="../css/ipadteachh.css">
  <link rel="stylesheet" href="css/sensorial-base.css">
  <title>Additions</title>
  <!-- Load shared themes file -->
  <script src="../js/themes.js"></script>
  <script src="js/games-config.js"></script>
  <script src="js/session-helpers.js"></script>
  <script src="js/reinforcer-overlay.js"></script>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .game-container {
      display: flex;
      justify-content: center;
      align-items: stretch;
      width: 100%;
      height: 100%;
      padding: clamp(12px, 3vw, 24px);
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(232,241,255,0.85));
      border-radius: 26px;
      box-shadow: inset 0 0 0 1px rgba(15,30,60,0.06);
      position: relative;
      overflow: hidden;
    }

    #game-content {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .game-scale-wrapper {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow: hidden;
    }

    .game-scale-inner {
      width: min(1120px, 100%);
      transform-origin: top center;
    }

    .addition-layout {
      width: 100%;
      display: flex;
      justify-content: space-around;
      align-items: stretch;
      flex-wrap: wrap;
      gap: clamp(12px, 3vw, 24px);
    }

    .equation-panel {
      flex: 1 1 60%;
      background: linear-gradient(135deg, rgba(28, 140, 214, 0.08), rgba(12, 94, 141, 0.08));
      border: 3px solid rgba(28, 140, 214, 0.2);
      border-radius: 24px;
      padding: clamp(18px, 3vw, 32px);
      margin: clamp(6px, 1.6vw, 12px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
      display: flex;
      flex-direction: column;
      gap: clamp(16px, 3vw, 24px);
    }

    .equation-prompt {
      font-size: clamp(1.2rem, 2.4vw, 1.8rem);
      text-align: center;
      color: #0b3a5b;
      font-weight: 600;
    }

    .equation-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: clamp(12px, 2.6vw, 24px);
    }

    .addend-group,
    .total-placeholder {
      min-height: 180px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 22px;
      box-shadow: 0 16px 28px rgba(15, 30, 60, 0.18);
      padding: clamp(14px, 2.6vw, 24px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: clamp(12px, 2vw, 18px);
    }

    .addend-group {
      flex: 1 1 clamp(160px, 26%, 260px);
    }

    .addend-label {
      font-size: clamp(1rem, 1.9vw, 1.4rem);
      font-weight: 600;
      color: #0b3a5b;
    }

    .objects-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: clamp(8px, 1.5vw, 14px);
    }

    .objects-wrapper img {
      width: clamp(60px, 12vw, 90px);
      height: clamp(60px, 12vw, 90px);
      object-fit: contain;
      border-radius: 16px;
      box-shadow: 0 10px 18px rgba(15, 30, 60, 0.18);
    }

    .operator {
      font-size: clamp(2.4rem, 4vw, 3.4rem);
      font-weight: 700;
      color: #1c8cd6;
    }

    .result-group {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(12px, 2vw, 18px);
      flex: 0 1 auto;
      min-width: clamp(160px, 28%, 220px);
    }

    .total-placeholder {
      font-size: clamp(1.6rem, 3vw, 2.4rem);
      color: #0b3a5b;
      font-weight: 600;
      flex: 0 0 auto;
      min-width: clamp(110px, 18vw, 160px);
    }

    .total-placeholder span {
      font-size: clamp(2rem, 4vw, 3rem);
    }

    .ten-frame {
      display: grid;
      grid-template-columns: repeat(5, clamp(24px, 4vw, 34px));
      gap: clamp(6px, 1vw, 10px);
    }

    .ten-frame-cell {
      width: clamp(24px, 4vw, 34px);
      height: clamp(24px, 4vw, 34px);
      border: 2px solid rgba(12, 94, 141, 0.25);
      border-radius: 6px;
      background: rgba(12, 94, 141, 0.12);
    }

    .ten-frame-cell.filled {
      background: linear-gradient(135deg, #1c8cd6, #0b5e8d);
      border-color: rgba(12, 94, 141, 0.45);
    }

    .buttons-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: clamp(12px, 2.4vw, 20px);
      margin: clamp(6px, 1.5vw, 16px);
    }

    .buttons-container button {
      font-size: clamp(1.2rem, 2.6vw, 1.8rem);
      padding: clamp(12px, 2.4vh, 18px) clamp(18px, 4vw, 28px);
      margin: 0;
      cursor: pointer;
      border: none;
      border-radius: 18px;
      background: linear-gradient(135deg, #1c8cd6, #0b5e8d);
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 18px 34px rgba(28, 140, 214, 0.28);
    }

    .buttons-container button:hover {
      transform: translateY(-3px);
      box-shadow: 0 24px 38px rgba(28, 140, 214, 0.34);
    }

    .buttons-container button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .buttons-container button.correct {
      background: linear-gradient(135deg, #30b27a, #1e7b52);
      box-shadow: 0 20px 34px rgba(48, 178, 122, 0.38);
    }

    .buttons-container button.incorrect {
      background: linear-gradient(135deg, #d63b3b, #8d0b0b);
      box-shadow: 0 20px 34px rgba(214, 59, 59, 0.32);
    }

    @keyframes pulse {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.35); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="sensorial-game">
  <!-- Activity overlay (shows the game index) -->
  <div id="activityNumberOverlay">
    <div class="number-text"></div>
  </div>

  <div class="sensorial-shell">
    <header class="sensorial-header">
      <div class="sensorial-header-main">
        <h1 class="sensorial-title">Additions</h1>
        <div class="sensorial-activity-marker" role="group" aria-label="Activité en cours">
          <img src="../images/plasticbasket.png" alt="" />
          <span class="sensorial-activity-number">–</span>
        </div>
      </div>
      <p class="sensorial-subtitle">Observe les deux groupes d’objets, additionne-les et choisis la bonne réponse.</p>
    </header>
    <main class="sensorial-content">
      <div class="game-container">
        <div id="game-content"></div>
      </div>
    </main>
  </div>

  <!-- Audio elements for error, reinforcer, and final reward sounds -->
  <audio id="error-sound" src="" preload="auto"></audio>
  <!-- The reinforcer sound is loaded from themes.js into the word-reward-sound element -->
  <audio id="word-reward-sound" src="" preload="auto"></audio>
  <audio id="final-reward-sound" src="" preload="auto"></audio>

  <script src="js/fullscreen.js"></script>
  <script>
    let themeData = {};
    let wrongAnswerRetry = false;
    let activityRepetitions = 1;
    let correctAttempts = 0;
    let reinforcerController = null;
    let scaleObserver = null;
    let scalingListenersAttached = false;
    let currentScaleInner = null;
    let scalingRaf = null;

    document.addEventListener('DOMContentLoaded', function() {
      const session = sessionHelpers.ensureCurrentGame('matchnumber');
      if (!session) { return; }

      sessionHelpers.updateActivityMarker(session);

      themeData = session.themeData || {};
      reinforcerController = sessionHelpers.setupSharedReinforcer(session);

      document.getElementById('error-sound').src = themeData.errorSound || "../sounds/error.mp3";
      document.getElementById('word-reward-sound').src = themeData.reinforcerSound || "../sounds/success3.mp3";
      document.getElementById('final-reward-sound').src = themeData.finalRewardSound || "../sounds/victory.mp3";

      const options = sessionHelpers.getCurrentGameOptions(session) || {};
      wrongAnswerRetry = options.wrongAnswerRetry === true || options.wrongAnswerRetry === 'true';
      activityRepetitions = Number(options.activityRepetitions);
      if (!Number.isFinite(activityRepetitions) || activityRepetitions < 1) {
        activityRepetitions = 1;
      }
      correctAttempts = 0;

      sessionHelpers.showActivityOverlay(() => {
        startGame(options);
      }, session);
    });

    function showFinalReinforcerVideo() {
      const finalRewardSound = document.getElementById('final-reward-sound');
      finalRewardSound.currentTime = 0;
      finalRewardSound.play().catch(error => {
        console.error('Error playing final reward sound:', error);
      });
      if (reinforcerController && typeof reinforcerController.show === 'function') {
        reinforcerController.show();
      } else {
        sessionHelpers.advanceToNextGame();
      }
    }

    function scheduleScaling() {
      if (scalingRaf !== null) {
        cancelAnimationFrame(scalingRaf);
      }
      scalingRaf = requestAnimationFrame(() => {
        scalingRaf = null;
        applyScaling();
      });
    }

    function applyScaling() {
      if (!currentScaleInner) {
        return;
      }
      const contentArea = document.querySelector('.sensorial-content');
      if (!contentArea) {
        return;
      }

      currentScaleInner.style.transform = 'scale(1)';
      currentScaleInner.style.marginTop = '0px';
      currentScaleInner.style.marginBottom = '0px';

      const availableHeight = contentArea.clientHeight;
      const contentHeight = currentScaleInner.offsetHeight;

      if (!availableHeight || !contentHeight) {
        return;
      }

      const scale = Math.min(1, availableHeight / contentHeight);
      currentScaleInner.style.transform = `scale(${scale})`;

      const scaledHeight = contentHeight * scale;
      const extraSpace = Math.max(0, (availableHeight - scaledHeight) / 2);
      currentScaleInner.style.marginTop = `${extraSpace}px`;
      currentScaleInner.style.marginBottom = `${extraSpace}px`;
    }

    function initializeScaling(scaleInner) {
      if (scaleObserver) {
        scaleObserver.disconnect();
      }

      currentScaleInner = scaleInner;

      if (typeof ResizeObserver === 'function') {
        scaleObserver = new ResizeObserver(() => {
          scheduleScaling();
        });
        scaleObserver.observe(scaleInner);
      } else {
        scaleObserver = null;
      }

      if (!scalingListenersAttached) {
        window.addEventListener('resize', scheduleScaling);
        window.addEventListener('orientationchange', scheduleScaling);
        scalingListenersAttached = true;
      }

      scheduleScaling();
    }

    // --- Game-Specific Logic: Additions ---
    window.startGame = function(options) {
      const gameContent = document.getElementById('game-content');
      gameContent.innerHTML = '';

      correctAttempts = 0;

      const scaleWrapper = document.createElement('div');
      scaleWrapper.classList.add('game-scale-wrapper');
      const scaleInner = document.createElement('div');
      scaleInner.classList.add('game-scale-inner', 'addition-layout');
      scaleWrapper.appendChild(scaleInner);
      gameContent.appendChild(scaleWrapper);

      initializeScaling(scaleInner);

      const container = scaleInner;

      const equationPanel = document.createElement('div');
      equationPanel.classList.add('equation-panel');
      container.appendChild(equationPanel);

      const promptText = document.createElement('p');
      promptText.classList.add('equation-prompt');
      promptText.setAttribute('role', 'status');
      promptText.setAttribute('aria-live', 'polite');
      equationPanel.appendChild(promptText);

      const additionRow = document.createElement('div');
      additionRow.classList.add('equation-wrapper');
      additionRow.setAttribute('aria-live', 'polite');
      equationPanel.appendChild(additionRow);

      const addendOneGroup = document.createElement('div');
      addendOneGroup.classList.add('addend-group');
      additionRow.appendChild(addendOneGroup);

      const plusOperator = document.createElement('div');
      plusOperator.classList.add('operator');
      plusOperator.setAttribute('aria-hidden', 'true');
      plusOperator.textContent = '+';
      additionRow.appendChild(plusOperator);

      const addendTwoGroup = document.createElement('div');
      addendTwoGroup.classList.add('addend-group');
      additionRow.appendChild(addendTwoGroup);

      const resultGroup = document.createElement('div');
      resultGroup.classList.add('result-group');
      additionRow.appendChild(resultGroup);

      const equalsOperator = document.createElement('div');
      equalsOperator.classList.add('operator');
      equalsOperator.setAttribute('aria-hidden', 'true');
      equalsOperator.textContent = '=';
      resultGroup.appendChild(equalsOperator);

      const totalPlaceholder = document.createElement('div');
      totalPlaceholder.classList.add('total-placeholder');
      totalPlaceholder.setAttribute('role', 'img');
      totalPlaceholder.setAttribute('aria-label', 'Résultat à trouver');
      totalPlaceholder.innerHTML = '<span>?</span>';
      resultGroup.appendChild(totalPlaceholder);

      const buttonContainer = document.createElement('div');
      buttonContainer.classList.add('buttons-container');
      container.appendChild(buttonContainer);

      let currentCorrectNumber;
      let maxAddend = 5;
      let showTenFrame = false;

      const parsedMaxAddend = Number(options.maxAddend);
      if (Number.isFinite(parsedMaxAddend)) {
        maxAddend = Math.min(Math.max(2, Math.round(parsedMaxAddend)), 10);
      }
      showTenFrame = options.showTenFrame === true || options.showTenFrame === 'true';

      const maxTotal = Math.min(10, maxAddend * 2);

      function createAddendVisual(wrapper, count, label) {
        wrapper.innerHTML = '';

        const title = document.createElement('div');
        title.classList.add('addend-label');
        title.textContent = label;
        wrapper.appendChild(title);

        const objectsWrapper = document.createElement('div');
        objectsWrapper.classList.add('objects-wrapper');
        objectsWrapper.setAttribute('role', 'img');
        objectsWrapper.setAttribute('aria-label', `${label}: ${count} objets`);

        const pngArray = themeData.transparentPNGs;
        const fallbackImages = ["../images/default.png"];
        const sourceArray = Array.isArray(pngArray) && pngArray.length > 0 ? pngArray : fallbackImages;
        const chosenImage = sourceArray[Math.floor(Math.random() * sourceArray.length)];

        for (let i = 0; i < count; i++) {
          const img = document.createElement('img');
          img.src = chosenImage;
          img.alt = '';
          img.setAttribute('aria-hidden', 'true');
          img.addEventListener('load', scheduleScaling);
          img.addEventListener('error', scheduleScaling);
          objectsWrapper.appendChild(img);
        }

        wrapper.appendChild(objectsWrapper);

        if (showTenFrame) {
          const tenFrame = document.createElement('div');
          tenFrame.classList.add('ten-frame');
          tenFrame.setAttribute('aria-hidden', 'true');

          for (let i = 0; i < 10; i++) {
            const cell = document.createElement('div');
            cell.classList.add('ten-frame-cell');
            if (i < count) {
              cell.classList.add('filled');
            }
            tenFrame.appendChild(cell);
          }

          wrapper.appendChild(tenFrame);
        }
        scheduleScaling();
      }

      function newActivity() {
        buttonContainer.innerHTML = '';

        let addendOne = Math.floor(Math.random() * maxAddend) + 1;
        let addendTwo = Math.floor(Math.random() * maxAddend) + 1;

        while (addendOne + addendTwo > maxTotal) {
          addendOne = Math.floor(Math.random() * maxAddend) + 1;
          addendTwo = Math.floor(Math.random() * maxAddend) + 1;
        }

        currentCorrectNumber = addendOne + addendTwo;

        promptText.textContent = `Combien font ${addendOne} + ${addendTwo} ?`;
        totalPlaceholder.innerHTML = '<span>?</span>';
        totalPlaceholder.setAttribute('aria-label', 'Résultat à trouver');

        createAddendVisual(addendOneGroup, addendOne, 'Groupe 1');
        createAddendVisual(addendTwoGroup, addendTwo, 'Groupe 2');

        const totalsPool = [];
        for (let value = 2; value <= maxTotal; value++) {
          totalsPool.push(value);
        }

        const distractorPool = totalsPool.filter(value => value !== currentCorrectNumber);
        for (let i = distractorPool.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [distractorPool[i], distractorPool[j]] = [distractorPool[j], distractorPool[i]];
        }

        const desiredChoices = Math.min(4, Math.max(3, Math.min(distractorPool.length + 1, 4)));
        const selectedChoices = [currentCorrectNumber];

        for (let i = 0; i < distractorPool.length && selectedChoices.length < desiredChoices; i++) {
          selectedChoices.push(distractorPool[i]);
        }

        for (let i = selectedChoices.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [selectedChoices[i], selectedChoices[j]] = [selectedChoices[j], selectedChoices[i]];
        }

        selectedChoices.forEach(value => {
          const btn = document.createElement('button');
          btn.textContent = value.toString();
          btn.setAttribute('aria-label', `Choisir ${value}`);
          btn.addEventListener('click', function() {
            if (value === currentCorrectNumber) {
              btn.classList.add('correct');
              Array.from(buttonContainer.children).forEach(child => child.disabled = true);

              const reinforcerSound = document.getElementById('word-reward-sound');
              reinforcerSound.currentTime = 0;
              reinforcerSound.play().catch(err => console.warn('Error playing reinforcer sound:', err));

              correctAttempts++;
              totalPlaceholder.innerHTML = `<span>${currentCorrectNumber}</span>`;
              totalPlaceholder.setAttribute('aria-label', `La réponse est ${currentCorrectNumber}`);
              if (correctAttempts >= activityRepetitions) {
                setTimeout(() => {
                  showFinalReinforcerVideo();
                }, 500);
              } else {
                setTimeout(newActivity, 500);
              }
            } else {
              btn.classList.add('incorrect');
              const errorSound = document.getElementById('error-sound');
              errorSound.currentTime = 0;
              errorSound.play().catch(err => console.warn('Error playing error sound:', err));

              if (wrongAnswerRetry) {
                setTimeout(newActivity, 500);
              } else {
                setTimeout(() => {
                  btn.classList.remove('incorrect');
                }, 500);
              }
            }
          });
          buttonContainer.appendChild(btn);
        });

        scheduleScaling();
      }

      newActivity();
    };
    // --- End of Game-Specific Logic ---
  </script>
</body>
</html>
