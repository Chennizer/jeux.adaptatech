<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lecteur vidéo (page secondaire)</title>
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      min-height: 100vh;
      font-family: Arial, sans-serif;
    }

    #viewer-shell {
      position: relative;
      width: 100%;
      height: 100vh;
      background: #000;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #ready-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      text-align: center;
      width: 100%;
      max-width: 720px;
      padding: 2rem;
      box-sizing: border-box;
      z-index: 2;
    }

    #ready-button {
      font-size: 2rem;
      padding: 1rem 2rem;
      background: #00bcd4;
      border: none;
      color: #000;
      border-radius: 12px;
      cursor: pointer;
    }

    #ready-button:focus-visible {
      outline: 3px solid #fff;
    }

    #status-text {
      font-size: 1.1rem;
      color: #b3e5fc;
    }

    #idle-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: #000;
      color: #b3e5fc;
      padding: 2rem;
      box-sizing: border-box;
      z-index: 1;
    }

    #viewer-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
      background: #000;
      z-index: 0;
    }
  </style>
</head>
<body>
  <div id="viewer-shell">
    <div id="ready-container">
      <h1>Page lecteur</h1>
      <p id="status-text">Cliquez sur « Ready? » puis passez en plein écran.</p>
      <button id="ready-button">Ready?</button>
    </div>
    <div id="idle-overlay" aria-live="polite">En attente d'une vidéo...</div>
    <video id="viewer-video" playsinline></video>
  </div>

  <script>
    const playbackChannel = new BroadcastChannel('eyegaze-video-bridge');
    const readyButton = document.getElementById('ready-button');
    const statusText = document.getElementById('status-text');
    const viewerVideo = document.getElementById('viewer-video');
    const readyContainer = document.getElementById('ready-container');
    const idleOverlay = document.getElementById('idle-overlay');

    let isReady = false;

    function sendMessage(data) {
      try { playbackChannel.postMessage(data); } catch (e) { console.error(e); }
    }

    function updateStatus(text) {
      statusText.textContent = text;
    }

    function showIdleScreen(message) {
      if (idleOverlay) {
        idleOverlay.textContent = message || "En attente d'une vidéo...";
        idleOverlay.style.display = 'flex';
      }
      viewerVideo.style.display = 'block';
      viewerVideo.removeAttribute('src');
      viewerVideo.load();
    }

    function hideIdleScreen() {
      if (idleOverlay) {
        idleOverlay.style.display = 'none';
      }
    }

    async function ensureFullscreen() {
      if (document.fullscreenElement) return;
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        try { await elem.requestFullscreen(); } catch (e) { console.warn(e); }
      }
    }

    readyButton.addEventListener('click', async () => {
      await ensureFullscreen();
      isReady = true;
      readyContainer.style.display = 'none';
      viewerVideo.style.display = 'block';
      sendMessage({ type: 'viewer-ready' });
      showIdleScreen("En attente d'une vidéo...");
      updateStatus('En attente d\'une vidéo...');
    });

    viewerVideo.addEventListener('ended', () => {
      sendMessage({ type: 'playback-ended', position: viewerVideo.currentTime });
      showIdleScreen('Lecture terminée. En attente d\'une vidéo...');
      updateStatus('Lecture terminée.');
      isReady = true;
    });

    playbackChannel.addEventListener('message', async (event) => {
      const data = event.data || {};
      if (data.type === 'host-handshake') {
        sendMessage({ type: 'viewer-awaiting' });
      }
      if (data.type === 'play-video' && data.url) {
        if (!isReady) {
          updateStatus('Cliquez sur Ready? pour lancer la vidéo.');
          return;
        }
        await ensureFullscreen();
        hideIdleScreen();
        viewerVideo.src = data.url;
        viewerVideo.currentTime = data.resume || 0;
        try {
          await viewerVideo.play();
          updateStatus('Lecture en cours...');
        } catch (e) {
          console.error(e);
          updateStatus('Impossible de lire la vidéo.');
          showIdleScreen('Impossible de lire la vidéo.');
          sendMessage({ type: 'playback-error', message: e?.message || 'playback failed' });
        }
      }
      if (data.type === 'stop-video') {
        if (!viewerVideo.paused) {
          viewerVideo.pause();
        }
        sendMessage({ type: 'playback-ended', position: viewerVideo.currentTime });
        viewerVideo.currentTime = 0;
        showIdleScreen('Lecture stoppée. En attente d\'une vidéo...');
        updateStatus('Lecture stoppée.');
        isReady = true;
      }
    });

    sendMessage({ type: 'viewer-opened' });
  </script>
</body>
</html>
