<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title class="translate" data-fr="PDF ‚Äî Avancer en cliquant" data-en="PDF ‚Äî Click to Advance">PDF ‚Äî Avancer en cliquant</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <!-- pdf.js (stable UMD v3) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    window.__PDFJS__ = window.pdfjsLib;
  </script>

  <!-- tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>

    :root{ --teal:#009688; --bg:#000; --fg:#fff; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden; }
    body{ display:block; justify-content:initial; align-items:initial; }

    #stage{ position:fixed; inset:0; display:grid; place-items:center; background:#000; cursor:pointer; z-index:1; }
    canvas{ display:block; max-width:100vw; max-height:100vh; }

    /* UI */
    #topbar{ position:fixed; top:10px; left:10px; right:10px; display:flex; gap:10px; align-items:center; justify-content:flex-end; z-index:5; }
    #pickerRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #fileInput{ display:none; }
    #tips{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px dashed #444; border-radius:10px; background:#0a0a0a; color:#ddd; font-size:14px; z-index:5; }

    #centerPrompt{ position:fixed; inset:0; display:grid; place-items:center; z-index:6; background: radial-gradient(transparent, rgba(0,0,0,.35) 60%); }
    #centerPrompt .card{ text-align:center; background:#111; border:1px solid #333; border-radius:16px; padding:20px; max-width:min(700px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.4); }

    #hud{ position:fixed; left:12px; bottom:12px; padding:6px 10px; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.2); border-radius:10px; font-size:14px; user-select:none; z-index:5; }

    #langToggle{ position:fixed; top:10px; right:10px; z-index:7; display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; border:2px solid var(--teal); background:#111; color:#fff; cursor:pointer; user-select:none; }

    #ocrHud{ position:fixed; right:12px; bottom:12px; z-index:6; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.2); border-radius:10px; padding:8px 10px; font-size:13px; min-width:220px; display:flex; flex-direction:column; gap:6px; }
    #ocrHud .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #ocrHud select, #ocrHud label{ font-size:13px; }
    #ocrProg{ height:6px; background:#111; border-radius:999px; overflow:hidden; }
    #ocrProg > div{ height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#34d399); }
    #ocrStatus{ opacity:.85; }
    #textOut{ display:none; width:min(520px, 90vw); max-height:30vh; overflow:auto; background:#0b0b0b; color:#ddd; border:1px solid #333; border-radius:10px; padding:8px; margin:0; position:fixed; right:12px; bottom:82px; z-index:6; white-space:pre-wrap; }

    /* Hide ALL UI when playing */
    .playing #topbar,
    .playing #langToggle,
    .playing #ocrHud,
    .playing #hud,
    .playing #centerPrompt,
    .playing #textOut { display:none !important; }

    .game-container{ display:none; }

    #game-options #control-panel-options{ transform:translateY(0); }

    .menu-placeholder{ width:100%; border:2px dashed #009688; border-radius:12px; padding:16px; color:#1f2937; background:#f1f5f9; font-weight:600; text-align:center; min-height:120px; display:flex; align-items:center; justify-content:center; }
    .menu-placeholder span{ display:block; }
    body.dark .menu-placeholder{ background:#0f172a; color:#e2e8f0; }

    #selectedFileName{ margin-top:8px; font-size:0.95rem; font-weight:600; color:#009688; text-align:center; word-break:break-word; }
    #selectedFileName.no-file{ color:#64748b; font-weight:500; }

    #startBtn.button:disabled{ background-color:#b0bec5; cursor:not-allowed; box-shadow:none; }

    .mode-option{ margin-top:10px; display:flex; align-items:center; gap:8px; }
    .mode-option input[type="radio"]{ margin:0; accent-color:#009688; }
    .mode-option span{ font-size:0.95rem; line-height:1.2; }
    .mode-note{ font-size:0.85rem; color:#374151; margin-top:6px; text-align:left; }
    body.dark .mode-note{ color:#d1d5db; }
    body.dark .teal-label{ color:#e2e8f0; }

  </style>
</head>
<body>

  <div id="langToggle" title="Basculer la langue / Toggle language">FR / EN</div>

  <div id="game-options" class="modal" role="dialog" aria-modal="true">
    <div id="control-panel-options">
      <div id="options-title-bar">
        <h2 class="translate" data-fr="Lecture PDF" data-en="PDF Reader">Lecture PDF</h2>
      </div>

      <div id="mode-divider"></div>

      <div id="options-inline-container">
        <!-- LEFT COLUMN -->
        <div class="options-column">
          <div class="option-item">
            <label for="languageSelect" class="teal-label label-block translate" data-fr="Langue" data-en="Language">Langue</label>
            <select id="languageSelect" class="styled-select">
              <option value="fr" class="translate" data-fr="Fran√ßais" data-en="French">Fran√ßais</option>
              <option value="en" class="translate" data-fr="Anglais" data-en="English">Anglais</option>
            </select>
          </div>
        </div>

        <!-- MIDDLE COLUMN -->
        <div class="options-column">
          <div class="option-item">
            <button id="chooseBtn" class="button translate" data-fr="Choisir un PDF" data-en="Choose a PDF">Choisir un PDF</button>
            <input id="fileInput" type="file" accept="application/pdf" />
            <div id="selectedFileName" class="translate no-file" data-fr="Aucun fichier s√©lectionn√©" data-en="No file selected">Aucun fichier s√©lectionn√©</div>
          </div>
          <div class="option-item">
            <div class="menu-placeholder">
              <span class="translate" data-fr="Menu d√©roulant √† venir" data-en="Scrolling menu coming soon">Menu d√©roulant √† venir</span>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="options-column">
          <div class="option-item">
            <span class="teal-label label-block translate" data-fr="Mode de jeu" data-en="Gameplay mode">Mode de jeu</span>
            <label class="teal-label mode-option">
              <input type="radio" name="advanceMode" value="direct" checked>
              <span class="translate" data-fr="Espace pour passer √† la page suivante" data-en="Space to advance to next page">Espace pour passer √† la page suivante</span>
            </label>
            <label class="teal-label mode-option">
              <input type="radio" name="advanceMode" value="tts-step">
              <span class="translate" data-fr="Appuyer pour lire, appuyer √† nouveau pour avancer" data-en="Press to read, press again to advance">Appuyer pour lire, appuyer √† nouveau pour avancer</span>
            </label>
            <div class="mode-note translate" data-fr="Le mode lecture utilise la synth√®se vocale disponible." data-en="Read mode uses the available text-to-speech.">Le mode lecture utilise la synth√®se vocale disponible.</div>
          </div>
        </div>
      </div>

      <div id="mode-divider"></div>
      <button id="startBtn" class="button translate" data-fr="Commencer" data-en="Start" disabled>Commencer</button>
    </div>
  </div>

  <div class="game-container">
    <div id="topbar">
      <div id="pickerRow">
        <div id="tips">
          <span>üñ±Ô∏è</span>
          <span class="translate" data-fr="Cliquez ou espace pour avancer. ‚Üê / ‚Üí reculent / avancent. Reboucle √† la fin." data-en="Click or Space to advance. ‚Üê / ‚Üí navigate. Loops at the end.">Cliquez ou espace pour avancer. ‚Üê / ‚Üí reculent / avancent. Reboucle √† la fin.</span>
        </div>
      </div>
    </div>

    <div id="centerPrompt">
      <div class="card">
        <h2 class="translate" data-fr="Charger un PDF" data-en="Load a PDF">Charger un PDF</h2>
        <p class="translate" data-fr="Appuyez sur le bouton Choisir un PDF pour s√©lectionner un fichier." data-en="Press the Choose a PDF button to select a file.">Appuyez sur le bouton Choisir un PDF pour s√©lectionner un fichier.</p>
        <p style="opacity:.8; margin-top:10px" class="translate" data-fr="Astuce : vous pouvez aussi d√©poser un PDF dans la fen√™tre." data-en="Tip: you can also drop a PDF into the window.">Astuce : vous pouvez aussi d√©poser un PDF dans la fen√™tre.</p>
      </div>
    </div>

    <div id="stage" aria-label="Zone d‚Äôaffichage PDF">
      <canvas id="pageCanvas" aria-hidden="true"></canvas>
    </div>

    <div id="hud"><span id="pageLabel">‚Äî</span></div>

    <pre id="textOut"></pre>
    <div id="ocrHud">
      <div class="row">
        <label for="ocrLang">OCR:</label>
        <select id="ocrLang">
          <option value="eng" selected>English (eng)</option>
          <option value="fra">Fran√ßais (fra)</option>
          <option value="eng+fra">English + Fran√ßais</option>
          <option value="spa">Espa√±ol (spa)</option>
          <option value="deu">Deutsch (deu)</option>
        </select>
        <label><input type="checkbox" id="autoRead" checked> <span class="translate" data-fr="Lecture auto" data-en="Auto-read">Lecture auto</span></label>
      </div>
      <div id="ocrProg" aria-hidden="true"><div id="ocrBar"></div></div>
      <div id="ocrStatus">‚Äî</div>
    </div>
  </div>


  <script>
    // ===== Fixed OCR zone (percent of page) =====
    const ZONE_W_PCT = 30;   // width of OCR zone as % of page width
    const ZONE_H_PCT = 40;   // height of OCR zone as % of page height
    const ZONE_CENTER_X_PCT = 75; // center of right half (50‚Äì100%)
    const ZONE_CENTER_Y_PCT = 50;

    // ===== Language toggle =====
    const langToggle = document.getElementById('langToggle');
    const languageSelect = document.getElementById('languageSelect');
    let currentLang = 'fr';

    function applyLang(){
      document.querySelectorAll('.translate').forEach(el=>{
        const t = el?.dataset?.[currentLang];
        if (typeof t === 'string') { el.textContent = t; }
      });
      document.documentElement.lang = currentLang;
      if (languageSelect) languageSelect.value = currentLang;
    }

    langToggle.addEventListener('click', ()=>{
      currentLang = (currentLang === 'fr') ? 'en' : 'fr';
      applyLang();
    });

    if (languageSelect){
      languageSelect.addEventListener('change', (e)=>{
        currentLang = (e.target.value === 'en') ? 'en' : 'fr';
        applyLang();
      });
    }

    applyLang();

    // ===== Elements =====
    const chooseBtn = document.getElementById('chooseBtn');
    const fileInput = document.getElementById('fileInput');
    const startBtn  = document.getElementById('startBtn');
    const stage     = document.getElementById('stage');
    const canvas    = document.getElementById('pageCanvas');
    const ctx       = canvas.getContext('2d', { willReadFrequently: true });
    const hudLabel  = document.getElementById('pageLabel');
    const centerPrompt = document.getElementById('centerPrompt');
    const selectedFileName = document.getElementById('selectedFileName');
    const gameOptions = document.getElementById('game-options');
    const gameContainer = document.querySelector('.game-container');

    // OCR controls
    const ocrLangSel = document.getElementById('ocrLang');
    const autoRead   = document.getElementById('autoRead');
    const ocrBar     = document.getElementById('ocrBar');
    const ocrStatus  = document.getElementById('ocrStatus');
    const textOut    = document.getElementById('textOut');
    const advanceModeRadios = document.querySelectorAll('input[name="advanceMode"]');

    // ===== State =====
    let pdfDoc = null, currentPageNum = 1, totalPages = 0, started = false, loading = false, pdfData = null;
    let speakingAllowed = false;
    let currentRenderToken = 0;
    let advanceMode = 'direct';
    let awaitingAdvanceConfirm = false;
    let savedAutoReadPreference = true;

    function setHUD(){ hudLabel.textContent = pdfDoc ? `${currentPageNum} / ${totalPages}` : '‚Äî'; }
    async function goFullscreen(){
      if (!document.fullscreenElement){
        try { await document.documentElement.requestFullscreen(); } catch(_){}
      }
    }
    function hideCenterPrompt(){ if (centerPrompt) centerPrompt.style.display = 'none'; }
    function setOcrProgress(p){ ocrBar.style.width = Math.max(0, Math.min(100, Math.round(p*100))) + '%'; }

    function enterPlayingUI(){ document.body.classList.add('playing'); }
    function exitPlayingUI(){ document.body.classList.remove('playing'); }

    function setAdvanceMode(mode){
      advanceMode = (mode === 'tts-step') ? 'tts-step' : 'direct';
      awaitingAdvanceConfirm = false;
      if (autoRead){
        if (advanceMode === 'tts-step'){
          savedAutoReadPreference = autoRead.checked;
          autoRead.checked = false;
          autoRead.disabled = true;
        } else {
          autoRead.disabled = false;
          autoRead.checked = savedAutoReadPreference;
        }
      }
      stopSpeak();
    }

    advanceModeRadios.forEach(radio=>{
      radio.addEventListener('change', ()=>{
        if (radio.checked){ setAdvanceMode(radio.value); }
      });
    });
    setAdvanceMode(document.querySelector('input[name="advanceMode"]:checked')?.value || 'direct');

    if (autoRead){
      autoRead.addEventListener('change', ()=>{
        if (advanceMode !== 'tts-step'){
          savedAutoReadPreference = autoRead.checked;
        }
      });
    }

    function readCurrentPage(){
      const text = textOut.textContent?.trim();
      if (text){
        stopSpeak();
        speak(text);
        return true;
      }
      return false;
    }

    async function goToNextPage(){
      if (!pdfDoc || loading) return;
      stopSpeak();
      currentPageNum = (currentPageNum % totalPages) + 1;
      await renderPage(currentPageNum);
      setHUD();
    }

    async function goToPreviousPage(){
      if (!pdfDoc || loading) return;
      stopSpeak();
      currentPageNum = (currentPageNum - 2 + totalPages) % totalPages + 1;
      await renderPage(currentPageNum);
      setHUD();
    }

    async function handleForwardAdvance(){
      if (!started || !pdfDoc || loading) return;
      if (advanceMode === 'tts-step'){
        if (!awaitingAdvanceConfirm){
          if (readCurrentPage()){
            awaitingAdvanceConfirm = true;
            return;
          }
        }
        awaitingAdvanceConfirm = false;
      }
      await goToNextPage();
    }

    // ===== Paragraph reflow for OCR text =====
    function reflowOcrText(raw) {
      if (!raw) return '';
      let s = raw;

      // Remove zero-width/soft hyphen & normalize newlines
      s = s.replace(/[\u200B-\u200D\u2060\uFEFF]/g, '');
      s = s.replace(/\u00AD/g, '');
      s = s.replace(/\r\n/g, '\n');

      // De-hyphenate line-end splits: "trans-\nform" -> "transform"
      s = s.replace(/([A-Za-z√Ä-√ñ√ò-√∂√∏-√ø])-\s*\n\s*([A-Za-z√Ä-√ñ√ò-√∂√∏-√ø])/g, '$1$2');

      // Preserve paragraph breaks temporarily
      s = s.replace(/\n{2,}/g, '¬∂¬∂');

      // Merge single line breaks into spaces unless previous char ends a sentence
      s = s.replace(/([^\n])\n(?!\n)/g, (m, prev) => {
        return /[.!?;:)"'¬ª\]]\s*$/.test(prev) ? prev + '\n' : prev + ' ';
      });

      // Restore paragraph breaks
      s = s.replace(/¬∂¬∂/g, '\n\n');

      // Whitespace tidy
      s = s.replace(/[ \t]+/g, ' ').replace(/ +\n/g, '\n').trim();

      return s;
    }

    // Speech helpers
    function speak(text){
      if(!speakingAllowed || !text || !('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const l = ocrLangSel.value;
      if(l.includes('fra')) u.lang = 'fr-CA';
      else if(l.includes('spa')) u.lang = 'es-ES';
      else if(l.includes('deu')) u.lang = 'de-DE';
      else u.lang = 'en-US';
      window.speechSynthesis.speak(u);
    }
    function stopSpeak(){ window.speechSynthesis?.cancel(); }

    // Choose file
    if (chooseBtn) chooseBtn.addEventListener('click', ()=> fileInput?.click());

    // Drag & drop
    ;['dragenter','dragover'].forEach(ev=>{
      window.addEventListener(ev, e=>{ e.preventDefault(); }, {passive:false});
    });
    window.addEventListener('drop', async e=>{
      e.preventDefault();
      const file = [...(e.dataTransfer?.files||[])].find(f=>f.type==='application/pdf' || f.name?.toLowerCase().endsWith('.pdf'));
      if (file){ await loadPDFFile(file); }
    });

    // File selection
    if (fileInput) fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      await loadPDFFile(file);
    });

    async function loadPDFFile(file){
      const arrBuf = await file.arrayBuffer();
      pdfData = new Uint8Array(arrBuf);
      startBtn.disabled = false;
      if (selectedFileName){
        selectedFileName.textContent = file.name;
        selectedFileName.dataset.fr = file.name;
        selectedFileName.dataset.en = file.name;
        selectedFileName.classList.remove('no-file');
      }
      hideCenterPrompt();
      awaitingAdvanceConfirm = false;
      if (fileInput) fileInput.value = '';
      if (started){
        await openAndRender();
        setHUD();
      }
    }

    // Start viewer
    startBtn.addEventListener('click', async ()=>{
      if (!pdfData) return;
      hideCenterPrompt();
      if (gameOptions) gameOptions.style.display = 'none';
      if (gameContainer) gameContainer.style.display = 'block';
      await goFullscreen();
      started = true;
      speakingAllowed = true;
      awaitingAdvanceConfirm = false;
      enterPlayingUI();          // hide all UI now
      await openAndRender();
    });

    // Allow ESC to bring UI back (and exit fullscreen)
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape'){
        exitPlayingUI();
      }
    });

    async function openAndRender(){
      try{
        const pdfjs = window.__PDFJS__ || window.pdfjsLib;
        if (!pdfjs) throw new Error('pdf.js library not available on window.');
        const loadingTask = pdfjs.getDocument({ data: pdfData });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        if (currentPageNum < 1 || currentPageNum > totalPages) currentPageNum = 1;
        await renderPage(currentPageNum);
        setHUD();
      }catch(err){
        console.error('PDF load error:', err);
        const msg = (currentLang==='fr' ? 'Erreur de chargement du PDF: ' : 'PDF load error: ')
                    + (err?.message || err?.toString() || '');
        alert(msg);
      }
    }

    // ===== Zone helpers =====
    function getZoneRectPixels(){
      const W = canvas.width, H = canvas.height;
      const w = Math.round((ZONE_W_PCT/100) * W);
      const h = Math.round((ZONE_H_PCT/100) * H);
      const cx = Math.round((ZONE_CENTER_X_PCT/100) * W);
      const cy = Math.round((ZONE_CENTER_Y_PCT/100) * H);
      const x = Math.max(0, Math.min(W-1, cx - Math.floor(w/2)));
      const y = Math.max(0, Math.min(H-1, cy - Math.floor(h/2)));
      return { x, y, w: Math.max(1, Math.min(W - x, w)), h: Math.max(1, Math.min(H - y, h)) };
    }
    function cropCanvas(srcCanvas, rect){
      const c = document.createElement('canvas');
      c.width = rect.w; c.height = rect.h;
      const cx = c.getContext('2d');
      cx.drawImage(srcCanvas, rect.x, rect.y, rect.w, rect.h, 0, 0, rect.w, rect.h);
      return c;
    }

    // Render page + OCR (fixed zone)
    async function renderPage(pageNum){
      if (!pdfDoc || loading) return;
      loading = true;
      const myToken = ++currentRenderToken;

      try{
        const page = await pdfDoc.getPage(pageNum);
        const viewportUnscaled = page.getViewport({ scale: 1 });
        const availW = window.innerWidth;
        const availH = window.innerHeight;
        const scale = Math.min(availW / viewportUnscaled.width, availH / viewportUnscaled.height);
        const viewport = page.getViewport({ scale: scale * (window.devicePixelRatio || 1) });

        canvas.width  = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        canvas.style.width  = Math.floor(viewport.width  / (window.devicePixelRatio || 1)) + 'px';
        canvas.style.height = Math.floor(viewport.height / (window.devicePixelRatio || 1)) + 'px';

        await page.render({ canvasContext: ctx, viewport }).promise;

        // OCR only the fixed zone
        const rect = getZoneRectPixels();
        const region = cropCanvas(canvas, rect);

        setOcrProgress(0);
        ocrStatus.textContent = (currentLang==='fr' ? 'OCR‚Ä¶' : 'OCR‚Ä¶');

        const lang = ocrLangSel.value || 'eng';
        const { data: { text } } = await Tesseract.recognize(
          region,
          lang,
          { logger: m => { if(m && typeof m.progress === 'number'){ setOcrProgress(m.progress); } } }
        );

        if(myToken !== currentRenderToken) return;

        // >>> Reflow paragraph lines here <<<
        const cleaned = reflowOcrText(text || '');
        textOut.textContent = cleaned;
        setOcrProgress(1);
        awaitingAdvanceConfirm = false;

        if (advanceMode === 'direct'){
          if (autoRead.checked && cleaned){ stopSpeak(); speak(cleaned); } else { stopSpeak(); }
        } else {
          stopSpeak();
        }
      }catch(err){
        console.error('Render/OCR error:', err);
      }finally{
        loading = false;
      }
    }

    // Advance on click/tap anywhere
    stage.addEventListener('click', ()=>{ handleForwardAdvance(); });

    // Keyboard controls
    window.addEventListener('keydown', async (e)=>{
      if (!started || !pdfDoc || loading) return;
      if (e.code === 'Space' && e.shiftKey){
        e.preventDefault();
        awaitingAdvanceConfirm = false;
        await goToPreviousPage();
      } else if (e.code === 'ArrowLeft'){
        e.preventDefault();
        awaitingAdvanceConfirm = false;
        await goToPreviousPage();
      } else if (e.code === 'Space' || e.code === 'ArrowRight'){
        e.preventDefault();
        await handleForwardAdvance();
      }
    });

    // Re-fit on resize
    window.addEventListener('resize', ()=>{
      if (!started || !pdfDoc) return;
      clearTimeout(window.__resizeT);
      window.__resizeT = setTimeout(()=>renderPage(currentPageNum), 100);
    });

    // Auto-hide cursor after inactivity
    let hideTimer = null;
    function scheduleCursorHide(){
      document.body.style.cursor = 'default';
      clearTimeout(hideTimer);
      hideTimer = setTimeout(()=>{ document.body.style.cursor = 'none'; }, 1500);
    }
    ['mousemove','mousedown','touchstart','keydown'].forEach(ev=>{
      window.addEventListener(ev, scheduleCursorHide, {passive:true});
    });
    scheduleCursorHide();

    // Re-OCR current page if OCR language changes (only when UI visible)
    ocrLangSel.addEventListener('change', ()=>{
      if(!started || !pdfDoc) return;
      renderPage(currentPageNum);
    });
  </script>
</body>
</html>
