<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title data-fr="Graffiti néon" data-en="Neon Graffiti" data-ja="ネオングラフィティ">Neon Graffiti</title>
  <link rel="stylesheet" href="../../css/otherswitch.css">

  <!-- p5 + sounds -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/addons/p5.sound.min.js"></script>
  <script src="../../js/stonermusic.js"></script>
  <script src="../../js/transitionSounds.js"></script>

  <!-- SAME translation system as other games -->
  <script src="../../js/translationmain.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #06070a;
    }
    canvas { display: block; }

    #langToggle {
      position: fixed;
      top: 14px;
      right: 44px;
      z-index: 11;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      border: 2px solid #04c8bb;
      background: #0b0f12;
      color: #04c8bb;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 0 0 0 rgba(4, 200, 187, 0);
      transition: box-shadow 0.2s ease, transform 0.05s ease, background 0.2s ease;
    }

    #langToggle:hover { box-shadow: 0 0 0 3px rgba(4, 200, 187, 0.2); }
    #langToggle:active { transform: translateY(1px); }
  </style>
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);} // eslint-disable-line
  gtag('js', new Date());
  gtag('config', 'G-B45TJG4GBJ');
</script>
<body>
  <button id="langToggle" title="Changer de langue / Change language">FR</button>

  <div id="promptOverlay">
    <button id="infoButton" title="More info" class="translate" data-fr="ⓘ" data-en="ⓘ" data-ja="ⓘ">ⓘ</button>
    <p class="translate" data-fr="Appuyez sur la switch ou la barre d'espace pour faire apparaître un nouveau tag lumineux." data-en="Press the switch or spacebar to spray a new neon tag." data-ja="スイッチやスペースキーを押して新しいネオンタグを描こう。">
      Appuyez sur la switch ou la barre d'espace pour déclencher un spray coloré.
    </p>
    <button id="startButton" class="translate" data-fr="Commencer" data-en="Start" data-ja="開始">Commencer</button>
  </div>

  <div id="infoModal">
    <p class="translate" data-fr="Compétence: appuyer<br>SENICT switch skills niveau 1<br>Switch Progression Roadmap niveaux 8 à 10." data-en="Skill: press<br>SENICT switch skills level 1<br>Switch Progression Roadmap levels 8 to 10." data-ja="スキル：押す<br>SENICTスイッチスキル レベル1<br>スイッチ習熟ロードマップ レベル8～10">
      Compétence: appuyer<br>SENICT switch skills niveau 1<br>Switch Progression Roadmap niveaux 8 à 10.
    </p>
    <button id="closeModal" class="translate" data-fr="Fermer" data-en="Close" data-ja="閉じる">Fermer</button>
  </div>

  <div id="settings-icon" title="Settings" class="translate" data-fr="⚙️" data-en="⚙️" data-ja="⚙️">⚙️</div>

  <div id="menu">
    <h3 data-fr="Musique et son" data-en="Music &amp; Sound" data-ja="音楽とサウンド">Musique et son</h3>
    <label class="inline">
      <span data-fr="Désactiver la musique" data-en="Disable music" data-ja="音をオフ">Désactiver la musique</span>
      <input type="checkbox" id="muteToggle">
    </label>
    <label>
      <span data-fr="Volume de la musique" data-en="Music volume" data-ja="音楽の音量">Volume de la musique</span>
      <span id="musicVolumeValue">50</span>
      <input type="range" id="musicVolumeSlider" min="1" max="100" value="50">
    </label>
    <h3 data-fr="Effets sonores" data-en="Sound effects" data-ja="効果音">Effets sonores</h3>
    <label class="inline">
      <span data-fr="Désactiver les sons" data-en="Disable sounds" data-ja="効果音をオフ">Désactiver les sons</span>
      <input type="checkbox" id="muteSFXToggle">
    </label>
    <label>
      <span data-fr="Volume des sons" data-en="Sound volume" data-ja="効果音の音量">Volume des sons</span>
      <span id="starSoundVolumeValue">50</span>
      <input type="range" id="starSoundVolumeSlider" min="1" max="100" value="50">
    </label>
    <h3 data-fr="Autres options" data-en="Other options" data-ja="その他のオプション">Options</h3>
    <label class="inline">
      <span data-fr="Activer clic/touch pour déclencher l'animation" data-en="touchscreen and mouse activation" data-ja="タッチとマウス操作を有効化">
        Activer clic/touch pour déclencher l'animation
      </span>
      <input type="checkbox" id="clickTransitionToggle" checked>
    </label>
  </div>

  <script src="../../js/translationonly.js"></script>

  <script>
    let musicFiles = [];
    let currentMusic = null;
    let transitionSoundFiles = [];
    let started = false;
    let isMuted = false;
    let isSFXMuted = false;
    let musicVolume = 0.5;
    let starSoundVolume = 0.5;
    let clickTransitionEnabled = true;

    const palettes = [
      {
        name: 'neon',
        background: [6, 9, 18],
        colors: [
          [255, 56, 156],
          [0, 245, 255],
          [120, 214, 255],
          [255, 255, 255]
        ],
        glow: [255, 153, 255]
      },
      {
        name: 'sunset',
        background: [12, 10, 16],
        colors: [
          [255, 176, 66],
          [255, 94, 129],
          [255, 222, 89],
          [255, 255, 255]
        ],
        glow: [255, 132, 74]
      },
      {
        name: 'coolwave',
        background: [8, 10, 20],
        colors: [
          [0, 255, 213],
          [0, 160, 255],
          [189, 255, 255],
          [255, 255, 255]
        ],
        glow: [111, 219, 255]
      },
      {
        name: 'monochrome',
        background: [10, 11, 14],
        colors: [
          [255, 255, 255],
          [195, 195, 195],
          [0, 255, 199],
          [255, 88, 214]
        ],
        glow: [255, 255, 255]
      },
      {
        name: 'acid',
        background: [10, 6, 20],
        colors: [
          [173, 255, 47],
          [255, 0, 110],
          [0, 255, 157],
          [255, 255, 255]
        ],
        glow: [193, 255, 103]
      }
    ];

    let currentBackground = [...palettes[0].background];
    const sprays = [];

    function preload() {
      if (window.stonerMusicArray && window.stonerMusicArray.length > 0) {
        for (let item of window.stonerMusicArray) {
          musicFiles.push(loadSound(item.src, ()=>{}, (err)=>{ console.error(item.src, err); }));
        }
      }
      if (window.transitionSoundsArray && window.transitionSoundsArray.length > 0) {
        for (let item of window.transitionSoundsArray) {
          transitionSoundFiles.push(loadSound(item.src, ()=>{}, (err)=>{ console.error(item.src, err); }));
        }
      }
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      colorMode(RGB, 255, 255, 255, 1);
      noStroke();
      background(currentBackground[0], currentBackground[1], currentBackground[2]);
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }

    function draw() {
      if (!started) return;

      blendMode(BLEND);
      noStroke();
      fill(currentBackground[0], currentBackground[1], currentBackground[2], 0.1);
      rect(0, 0, width, height);

      for (let i = sprays.length - 1; i >= 0; i--) {
        const burst = sprays[i];
        renderBurst(burst);
        if (burst.particles.length === 0 && burst.drips.length === 0 && burst.arcs.length === 0) {
          sprays.splice(i, 1);
        }
      }
    }

    function triggerSpray() {
      spawnBurst();
      if (transitionSoundFiles.length > 0 && !isSFXMuted) {
        const ts = random(transitionSoundFiles);
        if (ts && ts.isLoaded()) {
          ts.setVolume(starSoundVolume);
          ts.play();
        }
      }
    }

    function spawnBurst() {
      const palette = random(palettes);
      currentBackground = palette.background;
      const origin = createVector(random(width * 0.15, width * 0.85), random(height * 0.2, height * 0.85));
      const burst = {
        palette,
        origin,
        particles: [],
        drips: [],
        arcs: [],
        haloSize: random(120, 220),
      };

      const particleCount = floor(random(28, 46));
      for (let i = 0; i < particleCount; i++) {
        const angle = random(TWO_PI);
        const speed = random(1.2, 5.5);
        const vel = p5.Vector.fromAngle(angle).mult(speed);
        const life = random(500, 1400);
        const size = random(10, 42);
        const col = random(palette.colors);
        burst.particles.push({
          pos: origin.copy(),
          vel,
          size,
          age: 0,
          life,
          color: col,
          bloom: random(0.25, 0.7)
        });
      }

      const dripCount = floor(random(5, 9));
      for (let i = 0; i < dripCount; i++) {
        const offsetX = random(-40, 40);
        const length = random(30, 140);
        const widthStroke = random(6, 12);
        const color = random(palette.colors);
        const wobble = random(0.8, 2.2);
        const life = random(700, 1600);
        burst.drips.push({ offsetX, length, widthStroke, color, wobble, age: 0, life });
      }

      const arcCount = floor(random(1, 3));
      for (let i = 0; i < arcCount; i++) {
        const radius = random(60, 160);
        const thickness = random(6, 14);
        const startAngle = random(TWO_PI);
        const arcLength = random(PI / 2, PI * 1.3);
        const color = random(palette.colors);
        const life = random(600, 1200);
        burst.arcs.push({ radius, thickness, startAngle, arcLength, color, age: 0, life });
      }

      sprays.push(burst);
    }

    function renderBurst(burst) {
      const step = deltaTime;
      blendMode(ADD);
      noStroke();
      const glow = burst.palette.glow;
      fill(glow[0], glow[1], glow[2], 0.08);
      ellipse(burst.origin.x, burst.origin.y, burst.haloSize, burst.haloSize);

      blendMode(BLEND);
      for (let i = burst.particles.length - 1; i >= 0; i--) {
        const p = burst.particles[i];
        p.age += step;
        if (p.age >= p.life) {
          burst.particles.splice(i, 1);
          continue;
        }
        p.pos.add(p.vel);
        p.vel.mult(0.97);
        p.vel.y += 0.02;
        const t = p.age / p.life;
        const alpha = lerp(0.9, 0, t);
        const size = lerp(p.size, p.size * 0.4, t);
        fill(p.color[0], p.color[1], p.color[2], alpha);
        ellipse(p.pos.x, p.pos.y, size, size);

        blendMode(ADD);
        fill(p.color[0], p.color[1], p.color[2], alpha * p.bloom);
        ellipse(p.pos.x, p.pos.y, size * 1.8, size * 1.4);
        blendMode(BLEND);
      }

      strokeCap(ROUND);
      for (let i = burst.drips.length - 1; i >= 0; i--) {
        const d = burst.drips[i];
        d.age += step;
        if (d.age >= d.life) {
          burst.drips.splice(i, 1);
          continue;
        }
        const progress = d.age / d.life;
        const len = d.length * progress;
        const wobble = sin(progress * PI * 2) * d.wobble;
        stroke(d.color[0], d.color[1], d.color[2], lerp(0.9, 0, progress));
        strokeWeight(d.widthStroke);
        line(
          burst.origin.x + d.offsetX + wobble,
          burst.origin.y + 8,
          burst.origin.x + d.offsetX - wobble,
          burst.origin.y + 8 + len
        );
      }

      noFill();
      for (let i = burst.arcs.length - 1; i >= 0; i--) {
        const a = burst.arcs[i];
        a.age += step;
        if (a.age >= a.life) {
          burst.arcs.splice(i, 1);
          continue;
        }
        const progress = a.age / a.life;
        const sweep = a.arcLength * easeOutCubic(progress);
        stroke(a.color[0], a.color[1], a.color[2], lerp(1, 0, progress));
        strokeWeight(a.thickness * lerp(1, 0.6, progress));
        arc(
          burst.origin.x,
          burst.origin.y,
          a.radius * 2,
          a.radius * 2,
          a.startAngle,
          a.startAngle + sweep
        );
      }
    }

    function easeOutCubic(t) {
      return 1 - pow(1 - t, 3);
    }

    function keyPressed() {
      if (!started) return;
      if (key === ' ') {
        triggerSpray();
      }
    }

    function mousePressed(event) {
      const menu = document.getElementById("menu");
      const settingsIcon = document.getElementById("settings-icon");
      const langToggle = document.getElementById("langToggle");

      if (menu.contains(event.target) ||
          settingsIcon.contains(event.target) ||
          (langToggle && langToggle.contains(event.target))) {
        return;
      }
      if (!started) return;
      if (clickTransitionEnabled) {
        triggerSpray();
      }
    }

    function goFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => { console.error(err); });
      } else {
        document.exitFullscreen();
      }
    }

    const langToggleEl = document.getElementById("langToggle");

    document.getElementById("startButton").addEventListener("click", function() {
      started = true;
      document.getElementById("promptOverlay").style.display = "none";
      if (langToggleEl) {
        langToggleEl.style.display = "none";
      }

      goFullscreen();
      document.getElementById("settings-icon").style.display = "flex";
      if (window.stonerMusicArray && musicFiles.length > 0) {
        currentMusic = random(musicFiles);
        if (currentMusic && currentMusic.isLoaded()) {
          currentMusic.setVolume(musicVolume);
          currentMusic.loop();
        }
      }

      triggerSpray();
    });

    document.getElementById("infoButton").addEventListener("click", function() {
      document.getElementById("infoModal").style.display = "block";
    });

    document.getElementById("closeModal").addEventListener("click", function() {
      document.getElementById("infoModal").style.display = "none";
    });

    document.getElementById("settings-icon").addEventListener("click", function() {
      document.getElementById("menu").classList.toggle("show");
    });

    const muteToggle = document.getElementById('muteToggle');
    const musicVolumeSlider = document.getElementById('musicVolumeSlider');
    const musicVolumeValue = document.getElementById('musicVolumeValue');
    const muteSFXToggle = document.getElementById('muteSFXToggle');
    const starSoundVolumeSlider = document.getElementById('starSoundVolumeSlider');
    const starSoundVolumeValue = document.getElementById('starSoundVolumeValue');
    const clickTransitionToggle = document.getElementById('clickTransitionToggle');

    muteToggle.addEventListener('change', () => {
      isMuted = muteToggle.checked;
      if (currentMusic) currentMusic.setVolume(isMuted ? 0 : musicVolume);
    });

    musicVolumeSlider.addEventListener('input', () => {
      musicVolume = parseInt(musicVolumeSlider.value, 10) / 100;
      musicVolumeValue.textContent = musicVolumeSlider.value;
      if (currentMusic && !isMuted) currentMusic.setVolume(musicVolume);
    });

    muteSFXToggle.addEventListener('change', () => {
      isSFXMuted = muteSFXToggle.checked;
    });

    starSoundVolumeSlider.addEventListener('input', () => {
      starSoundVolume = parseInt(starSoundVolumeSlider.value, 10) / 100;
      starSoundVolumeValue.textContent = starSoundVolumeSlider.value;
    });

    clickTransitionToggle.addEventListener('change', () => {
      clickTransitionEnabled = clickTransitionToggle.checked;
    });

    document.addEventListener('click', function(event) {
      const menu = document.getElementById("menu");
      const settingsIcon = document.getElementById("settings-icon");

      if (menu.classList.contains("show") &&
          !menu.contains(event.target) &&
          !settingsIcon.contains(event.target)) {
        menu.classList.remove("show");
      }
    });

    document.getElementById('langToggle')?.addEventListener('pointerup', () => {
      if (typeof toggleLanguage === 'function') {
        toggleLanguage();
      }
    });
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof updateLanguage === 'function') {
        updateLanguage();
      }
    });
  </script>
</body>
</html>
