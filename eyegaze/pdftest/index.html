<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title class="translate" data-fr="PDF — Avancer en cliquant" data-en="PDF — Click to Advance">PDF — Avancer en cliquant</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <!-- pdf.js (stable UMD v3) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    window.__PDFJS__ = window.pdfjsLib;
  </script>

  <!-- tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root { --teal:#009688; }

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      height: 100vh;
      overflow: hidden;
      display: block;
    }

    #game-options {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: left;
      z-index: 30;
    }

    body.playing #game-options {
      display: none !important;
    }

    #stage {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: #000;
      cursor: pointer;
      z-index: 1;
    }

    canvas {
      display: block;
      max-width: 100vw;
      max-height: 100vh;
    }

    #hud {
      position: fixed;
      left: 12px;
      bottom: 12px;
      padding: 6px 10px;
      background: rgba(0,0,0,.5);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 10px;
      font-size: 14px;
      user-select: none;
      z-index: 5;
    }

    #ocrHud {
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 6;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      min-width: 240px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #ocrHud .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #ocrHud select,
    #ocrHud label {
      font-size: 13px;
    }

    #ocrProg {
      height: 6px;
      background: #111;
      border-radius: 999px;
      overflow: hidden;
    }

    #ocrProg > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#60a5fa,#34d399);
      transition: width .2s ease;
    }

    #textOut {
      display: none;
      width: min(520px, 90vw);
      max-height: 30vh;
      overflow: auto;
      background: #0b0b0b;
      color: #ddd;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 8px;
      margin: 0;
      position: fixed;
      right: 12px;
      bottom: 82px;
      z-index: 6;
      white-space: pre-wrap;
    }

    #langToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 31;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 2px solid var(--teal);
      background: #111;
      color: #fff;
      cursor: pointer;
      user-select: none;
      font-weight: 700;
    }

    .file-name {
      margin: 8px 0 0;
      font-size: 0.95rem;
      text-align: center;
      color: #1f2933;
    }

    .file-name.has-file {
      color: #0f5132;
      font-weight: 600;
    }

    .placeholder-card {
      width: 100%;
      padding: 16px;
      border: 2px dashed rgba(0,150,136,0.6);
      border-radius: 12px;
      text-align: center;
      color: #0c4a49;
      background: rgba(0,150,136,0.08);
      font-weight: 600;
    }

    .options-column {
      width: 100%;
    }

    .option-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .button[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    #fileInput {
      display: none;
    }

    .mode-hint {
      margin-top: 6px;
      font-size: 0.9rem;
      line-height: 1.3;
      color: #1f2933;
      text-align: left;
    }

    .options-column .teal-label.radios {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .radio-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #1f2933;
    }

    .radio-row input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: var(--teal);
    }

    #autoReadContainer.disabled {
      opacity: 0.5;
    }

    body.playing #ocrHud,
    body.playing #langToggle,
    body.playing #hud,
    body.playing #textOut {
      display: none !important;
    }
  </style>
</head>
<body>
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <div id="game-options" class="modal">
    <div id="options-title-bar">
      <h2 id="options-main-title" class="translate" data-fr="Lecteur PDF" data-en="PDF Reader">Lecteur PDF</h2>
    </div>

    <div id="control-panel-options">
      <div id="mode-divider"></div>
      <div id="options-inline-container">
        <!-- LEFT COLUMN -->
        <div class="options-column">
          <div class="option-item">
            <label for="languageSelect" class="teal-label label-block translate" data-fr="Langue de l’interface" data-en="Interface language">Langue de l’interface</label>
            <select id="languageSelect" class="styled-select">
              <option value="fr" class="translate" data-fr="Français" data-en="French">Français</option>
              <option value="en" class="translate" data-fr="Anglais" data-en="English">Anglais</option>
            </select>
          </div>

          <div class="option-item">
            <label for="ocrLang" class="teal-label label-block translate" data-fr="Langue OCR" data-en="OCR language">Langue OCR</label>
            <select id="ocrLang" class="styled-select">
              <option value="eng" class="translate" data-fr="Anglais (eng)" data-en="English (eng)">Anglais (eng)</option>
              <option value="fra" class="translate" data-fr="Français (fra)" data-en="French (fra)">Français (fra)</option>
              <option value="eng+fra" class="translate" data-fr="Anglais + Français" data-en="English + French">Anglais + Français</option>
              <option value="spa" class="translate" data-fr="Espagnol (spa)" data-en="Spanish (spa)">Espagnol (spa)</option>
              <option value="deu" class="translate" data-fr="Allemand (deu)" data-en="German (deu)">Allemand (deu)</option>
            </select>
          </div>

          <div class="option-item" id="autoReadContainer">
            <label class="teal-label">
              <input type="checkbox" id="autoRead" checked>
              <span class="translate" data-fr="Lecture auto après OCR" data-en="Auto-read after OCR">Lecture auto après OCR</span>
            </label>
          </div>
        </div>

        <!-- MIDDLE COLUMN -->
        <div class="options-column">
          <div class="option-item option-buttons">
            <button id="chooseBtn" class="button translate" data-fr="Choisir un PDF" data-en="Choose a PDF">Choisir un PDF</button>
            <input id="fileInput" type="file" accept="application/pdf" />
            <p id="fileName" class="file-name translate" data-fr="Aucun fichier sélectionné" data-en="No file selected">Aucun fichier sélectionné</p>
          </div>

          <div class="option-item">
            <div class="placeholder-card translate" data-fr="Menu déroulant à venir" data-en="Scrolling menu placeholder">Menu déroulant à venir</div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="options-column">
          <div class="option-item">
            <span class="teal-label radios translate" data-fr="Mode de navigation" data-en="Navigation mode">Mode de navigation</span>
            <label class="radio-row">
              <input type="radio" name="playbackMode" value="advance" checked>
              <span class="translate" data-fr="Espace = page suivante" data-en="Space = next page">Espace = page suivante</span>
            </label>
            <label class="radio-row">
              <input type="radio" name="playbackMode" value="confirm">
              <span class="translate" data-fr="Espace 1 : lire, espace 2 : page suivante" data-en="Space 1: read, Space 2: next page">Espace 1 : lire, espace 2 : page suivante</span>
            </label>
            <p id="modeHint" class="mode-hint" data-fr-advance="La page suivante se charge immédiatement et la lecture suit vos réglages OCR." data-en-advance="Next pages appear right away and follow your OCR reading settings." data-fr-confirm="Le premier appui lit le texte reconnu. Appuyez de nouveau pour passer à la page suivante." data-en-confirm="The first press reads the recognized text. Press again to move to the next page.">La page suivante se charge immédiatement et la lecture suit vos réglages OCR.</p>
          </div>
        </div>
      </div>
      <div id="mode-divider"></div>
      <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start" disabled>Commencer</button>
    </div>
  </div>

  <div id="stage" aria-label="Zone d’affichage PDF">
    <canvas id="pageCanvas" aria-hidden="true"></canvas>
  </div>

  <div id="hud"><span id="pageLabel">—</span></div>

  <pre id="textOut"></pre>
  <div id="ocrHud">
    <div class="row">
      <label for="ocrLang">OCR:</label>
      <span id="ocrStatus">—</span>
    </div>
    <div id="ocrProg" aria-hidden="true"><div id="ocrBar"></div></div>
  </div>

  <script src="../../js/eyegaze-menu.js"></script>
  <script src="../../js/translationonly.js"></script>

  <script>
    initEyegazeMenu?.();

    const optionsPanel = document.getElementById('game-options');
    const langToggle = document.getElementById('langToggle');
    const languageSelect = document.getElementById('languageSelect');
    const chooseBtn = document.getElementById('chooseBtn');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const startButton = document.getElementById('startButton');
    const stage = document.getElementById('stage');
    const canvas = document.getElementById('pageCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const hudLabel = document.getElementById('pageLabel');
    const ocrLangSel = document.getElementById('ocrLang');
    const autoRead = document.getElementById('autoRead');
    const autoReadContainer = document.getElementById('autoReadContainer');
    const ocrBar = document.getElementById('ocrBar');
    const ocrStatus = document.getElementById('ocrStatus');
    const textOut = document.getElementById('textOut');
    const modeHint = document.getElementById('modeHint');
    const playbackModeRadios = document.querySelectorAll('input[name="playbackMode"]');

    const LS_LANG_KEY = 'siteLanguage';
    let currentLang = 'fr';

    function applyLangToElements(lang) {
      document.querySelectorAll('.translate').forEach(el => {
        const text = el.getAttribute(`data-${lang}`);
        if (text != null) {
          el.innerHTML = text;
        }
      });
    }

    function getSavedLang() {
      try {
        const stored = localStorage.getItem(LS_LANG_KEY);
        if (stored === 'fr' || stored === 'en') {
          return stored;
        }
      } catch (e) {}
      return document.documentElement.lang === 'en' ? 'en' : 'fr';
    }

    function updateModeHint() {
      if (!modeHint) return;
      const key = playbackMode === 'confirm' ? `data-${currentLang}-confirm` : `data-${currentLang}-advance`;
      const text = modeHint.getAttribute(key);
      if (text != null) {
        modeHint.textContent = text;
      }
    }

    function setLang(lang) {
      const safe = lang === 'en' ? 'en' : 'fr';
      currentLang = safe;
      document.documentElement.lang = safe;
      applyLangToElements(safe);
      if (languageSelect) {
        languageSelect.value = safe;
      }
      try {
        localStorage.setItem(LS_LANG_KEY, safe);
      } catch (e) {}
      updateModeHint();
    }

    let playbackMode = document.querySelector('input[name="playbackMode"]:checked')?.value || 'advance';
    let confirmPending = false;

    function updatePlaybackMode() {
      const selected = document.querySelector('input[name="playbackMode"]:checked');
      playbackMode = selected ? selected.value : 'advance';
      confirmPending = false;
      if (playbackMode === 'confirm') {
        if (autoRead) {
          autoRead.checked = false;
          autoRead.disabled = true;
        }
        autoReadContainer?.classList.add('disabled');
      } else {
        if (autoRead) {
          autoRead.disabled = false;
        }
        autoReadContainer?.classList.remove('disabled');
      }
      updateModeHint();
    }

    const initialLang = getSavedLang();
    setLang(initialLang);
    updatePlaybackMode();

    langToggle?.addEventListener('click', () => {
      setLang(currentLang === 'fr' ? 'en' : 'fr');
    });

    languageSelect?.addEventListener('change', (e) => {
      setLang(e.target.value);
    });

    playbackModeRadios.forEach(radio => {
      radio.addEventListener('change', updatePlaybackMode);
    });

    let pdfDoc = null;
    let currentPageNum = 1;
    let totalPages = 0;
    let started = false;
    let loading = false;
    let pdfData = null;
    let speakingAllowed = false;
    let currentRenderToken = 0;

    function setHUD() {
      hudLabel.textContent = pdfDoc ? `${currentPageNum} / ${totalPages}` : '—';
    }

    function setOcrProgress(p) {
      ocrBar.style.width = Math.max(0, Math.min(100, Math.round(p * 100))) + '%';
    }

    function showOptions() {
      document.body.classList.remove('playing');
      optionsPanel?.setAttribute('aria-hidden', 'false');
    }

    function hideOptions() {
      document.body.classList.add('playing');
      optionsPanel?.setAttribute('aria-hidden', 'true');
    }

    if (window.eyegazeSettings) {
      window.eyegazeSettings.hideOverlay = hideOptions;
    }

    chooseBtn?.addEventListener('click', () => fileInput?.click());

    ;['dragenter', 'dragover'].forEach(ev => {
      window.addEventListener(ev, e => {
        e.preventDefault();
      }, { passive: false });
    });

    window.addEventListener('drop', async e => {
      e.preventDefault();
      const file = [...(e.dataTransfer?.files || [])].find(f => f.type === 'application/pdf' || f.name?.toLowerCase().endsWith('.pdf'));
      if (file) {
        await loadPDFFile(file);
      }
    });

    fileInput?.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      await loadPDFFile(file);
    });

    async function loadPDFFile(file) {
      const arrBuf = await file.arrayBuffer();
      pdfData = new Uint8Array(arrBuf);
      startButton.disabled = false;
      fileName.textContent = file.name;
      fileName.classList.add('has-file');
      fileName.classList.remove('translate');
    }

    async function goFullscreen() {
      if (!document.fullscreenElement) {
        try {
          await document.documentElement.requestFullscreen();
        } catch (err) {}
      }
    }

    function speak(text) {
      if (!speakingAllowed || !text || !('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      const lang = ocrLangSel.value;
      if (lang.includes('fra')) utterance.lang = 'fr-CA';
      else if (lang.includes('spa')) utterance.lang = 'es-ES';
      else if (lang.includes('deu')) utterance.lang = 'de-DE';
      else utterance.lang = 'en-US';
      window.speechSynthesis.speak(utterance);
    }

    function stopSpeak() {
      window.speechSynthesis?.cancel();
    }

    startButton?.addEventListener('click', async () => {
      if (!pdfData) return;
      await goFullscreen();
      started = true;
      speakingAllowed = true;
      hideOptions();
      await openAndRender();
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        showOptions();
        started = false;
        speakingAllowed = false;
        stopSpeak();
        if (document.fullscreenElement) {
          document.exitFullscreen?.();
        }
      }
    });

    async function openAndRender() {
      try {
        const pdfjs = window.__PDFJS__ || window.pdfjsLib;
        if (!pdfjs) throw new Error('pdf.js library not available on window.');
        const loadingTask = pdfjs.getDocument({ data: pdfData });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        currentPageNum = 1;
        await renderPage(currentPageNum);
        setHUD();
      } catch (err) {
        console.error('PDF load error:', err);
        const msg = (currentLang === 'fr' ? 'Erreur de chargement du PDF: ' : 'PDF load error: ') + (err?.message || err?.toString() || '');
        alert(msg);
      }
    }

    const ZONE_W_PCT = 30;
    const ZONE_H_PCT = 40;
    const ZONE_CENTER_X_PCT = 75;
    const ZONE_CENTER_Y_PCT = 50;

    function getZoneRectPixels() {
      const W = canvas.width, H = canvas.height;
      const w = Math.round((ZONE_W_PCT / 100) * W);
      const h = Math.round((ZONE_H_PCT / 100) * H);
      const cx = Math.round((ZONE_CENTER_X_PCT / 100) * W);
      const cy = Math.round((ZONE_CENTER_Y_PCT / 100) * H);
      const x = Math.max(0, Math.min(W - 1, cx - Math.floor(w / 2)));
      const y = Math.max(0, Math.min(H - 1, cy - Math.floor(h / 2)));
      return { x, y, w: Math.max(1, Math.min(W - x, w)), h: Math.max(1, Math.min(H - y, h)) };
    }

    function cropCanvas(srcCanvas, rect) {
      const c = document.createElement('canvas');
      c.width = rect.w;
      c.height = rect.h;
      const cx = c.getContext('2d');
      cx.drawImage(srcCanvas, rect.x, rect.y, rect.w, rect.h, 0, 0, rect.w, rect.h);
      return c;
    }

    async function renderPage(pageNum) {
      if (!pdfDoc || loading) return;
      loading = true;
      const myToken = ++currentRenderToken;

      try {
        const page = await pdfDoc.getPage(pageNum);
        const viewportUnscaled = page.getViewport({ scale: 1 });
        const availW = window.innerWidth;
        const availH = window.innerHeight;
        const scale = Math.min(availW / viewportUnscaled.width, availH / viewportUnscaled.height);
        const viewport = page.getViewport({ scale: scale * (window.devicePixelRatio || 1) });

        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        canvas.style.width = Math.floor(viewport.width / (window.devicePixelRatio || 1)) + 'px';
        canvas.style.height = Math.floor(viewport.height / (window.devicePixelRatio || 1)) + 'px';

        await page.render({ canvasContext: ctx, viewport }).promise;

        const rect = getZoneRectPixels();
        const region = cropCanvas(canvas, rect);

        setOcrProgress(0);
        ocrStatus.textContent = 'OCR…';

        const lang = ocrLangSel.value || 'eng';
        const { data: { text } } = await Tesseract.recognize(
          region,
          lang,
          { logger: m => { if (m && typeof m.progress === 'number') { setOcrProgress(m.progress); } } }
        );

        if (myToken !== currentRenderToken) return;

        const cleaned = reflowOcrText(text || '');
        textOut.textContent = cleaned;
        setOcrProgress(1);

        confirmPending = false;

        if (autoRead && !autoRead.disabled && autoRead.checked && cleaned) {
          stopSpeak();
          speak(cleaned);
        } else {
          stopSpeak();
        }
      } catch (err) {
        console.error('Render/OCR error:', err);
      } finally {
        loading = false;
      }
    }

    function reflowOcrText(raw) {
      if (!raw) return '';
      let s = raw;
      s = s.replace(/[\u200B-\u200D\u2060\uFEFF]/g, '');
      s = s.replace(/\u00AD/g, '');
      s = s.replace(/\r\n/g, '\n');
      s = s.replace(/([A-Za-zÀ-ÖØ-öø-ÿ])-\s*\n\s*([A-Za-zÀ-ÖØ-öø-ÿ])/g, '$1$2');
      s = s.replace(/\n{2,}/g, '¶¶');
      s = s.replace(/([^\n])\n(?!\n)/g, (m, prev) => {
        return /[.!?;:)"'»\]]\s*$/.test(prev) ? prev + '\n' : prev + ' ';
      });
      s = s.replace(/¶¶/g, '\n\n');
      s = s.replace(/[ \t]+/g, ' ').replace(/ +\n/g, '\n').trim();
      return s;
    }

    async function goToNextPage() {
      if (!started || !pdfDoc || loading) return;
      stopSpeak();
      currentPageNum = (currentPageNum % totalPages) + 1;
      await renderPage(currentPageNum);
      setHUD();
    }

    async function goToPreviousPage() {
      if (!started || !pdfDoc || loading) return;
      stopSpeak();
      currentPageNum = (currentPageNum - 2 + totalPages) % totalPages + 1;
      await renderPage(currentPageNum);
      setHUD();
    }

    async function handleForwardTrigger() {
      if (!started || !pdfDoc || loading) return;
      if (playbackMode === 'confirm') {
        const cleaned = textOut.textContent.trim();
        if (!confirmPending) {
          if (!cleaned) {
            await goToNextPage();
            return;
          }
          confirmPending = true;
          stopSpeak();
          speak(cleaned);
          return;
        }
        confirmPending = false;
      }
      await goToNextPage();
    }

    stage?.addEventListener('click', () => {
      handleForwardTrigger();
    });

    window.addEventListener('keydown', async (e) => {
      if (!started || !pdfDoc || loading) return;
      if (e.code === 'Space' || e.code === 'ArrowRight') {
        e.preventDefault();
        await handleForwardTrigger();
      } else if (e.code === 'ArrowLeft' || (e.code === 'Space' && e.shiftKey)) {
        e.preventDefault();
        confirmPending = false;
        await goToPreviousPage();
      }
    });

    window.addEventListener('resize', () => {
      if (!started || !pdfDoc) return;
      clearTimeout(window.__resizeT);
      window.__resizeT = setTimeout(() => renderPage(currentPageNum), 100);
    });

    let hideTimer = null;
    function scheduleCursorHide() {
      document.body.style.cursor = 'default';
      clearTimeout(hideTimer);
      hideTimer = setTimeout(() => { document.body.style.cursor = 'none'; }, 1500);
    }
    ['mousemove', 'mousedown', 'touchstart', 'keydown'].forEach(ev => {
      window.addEventListener(ev, scheduleCursorHide, { passive: true });
    });
    scheduleCursorHide();

    ocrLangSel?.addEventListener('change', () => {
      if (!started || !pdfDoc) return;
      renderPage(currentPageNum);
    });
  </script>
</body>
</html>
