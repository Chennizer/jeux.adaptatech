<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title class="translate"
          data-fr="Dessiner dans les contours (Eyegaze)"
          data-en="Draw inside the lines (Eyegaze)">
    Dessiner dans les contours (Eyegaze)
  </title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root{
      --ui-scale: 1;
      --sidebar-w: clamp(96px, calc(120px * var(--ui-scale)), 180px);
      --sidebar-pad-x: clamp(8px, calc(12px * var(--ui-scale)), 16px);
      --sidebar-pad-y: clamp(8px, calc(12px * var(--ui-scale)), 16px);
      --swatch-size: 84px;
      --swatch-gap: 12px;
      --swatch-border: clamp(3px, calc(5px * var(--ui-scale)), 6px);
      --swatch-outline: clamp(3px, calc(5px * var(--ui-scale)), 6px);
      --brush-btn: clamp(36px, calc(44px * var(--ui-scale)), 56px);
      --brush-dot-s: clamp(6px,  calc(8px * var(--ui-scale)),  10px);
      --brush-dot-m: clamp(12px, calc(16px * var(--ui-scale)), 20px);
      --brush-dot-l: clamp(22px, calc(28px * var(--ui-scale)), 34px);
      --brush-gap: clamp(8px, calc(12px * var(--ui-scale)), 16px);
      --save-btn: clamp(36px, calc(44px * var(--ui-scale)), 56px);
      --save-radius: clamp(8px, calc(10px * var(--ui-scale)), 12px);
      --cursor-outline: clamp(1px, calc(2px * var(--ui-scale)), 3px);
      --swatch-min: 26px;
      --swatch-max: 96px;
      --palette-cols: 1;
      --dwell-red: rgba(255, 64, 64, 0.48);
    }

    body.light { background-color: #fff; color: #000; }
    body.dark  { background-color: #000; color: #fff; }

    #langToggle{
      position: fixed; top: 10px; right: 10px; z-index: 99999;
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 10px; border: 2px solid #009688;
      background: #fff; color: #009688; font-weight: 700; cursor: pointer; user-select: none;
    }
    body.dark #langToggle { background:#111; color:#14b8a6; border-color:#14b8a6; }

    .game-container { width: 100%; height: 100%; display: none; }
    canvas#c,
    canvas#maskOverlay { position: fixed; inset: 0; cursor: none; }
    canvas#maskOverlay { pointer-events: none; }

    #sidebar{
      position: fixed; left: 0; top: 0; bottom: 0; z-index: 20;
      width: var(--sidebar-w);
      display: flex; flex-direction: column;
      padding: var(--sidebar-pad-y) var(--sidebar-pad-x);
      gap: clamp(12px, calc(14px * var(--ui-scale)), 18px);
      background: #fff; border-right: 1px solid #e6e6e6;
      box-shadow: 0 0 18px rgba(0,0,0,.05);
      color: #000;
    }
    body.dark #sidebar{ background:#fff; border-right-color:#e6e6e6; color:#000; }

    #palette{
      flex: 1;
      display: grid;
      grid-template-columns: repeat(var(--palette-cols, 1), var(--swatch-size));
      grid-auto-rows: var(--swatch-size);
      justify-content: center;
      align-content: start;
      gap: var(--swatch-gap);
      overflow: hidden;
      padding-inline: 8px;
    }

    .swatch{
      width: var(--swatch-size); height: var(--swatch-size);
      border-radius: 50%;
      border: var(--swatch-border) solid #ffffff;
      box-shadow: 0 1px 6px rgba(0,0,0,.22) inset, 0 3px 10px rgba(0,0,0,.12);
      transition: transform .12s ease;
      position: relative;
      overflow: hidden;
    }
    .swatch.active{ transform: scale(1.03); }
    .swatch.active::before{
      content:"";
      position:absolute;
      inset: calc(var(--swatch-outline) + 2px);
      border: var(--swatch-outline) solid #111;
      border-radius: 50%;
      pointer-events:none;
      z-index: 2;
    }
    body.dark .swatch.active::before{ border-color:#111; }

    .swatch .dwell,
    .brushBtn .dwell,
    #saveBtn .dwell{
      position: absolute;
      left: 50%; top: 50%;
      width: 100%; height: 100%;
      transform: translate(-50%, -50%) scale(0.08);
      transform-origin: center center;
      pointer-events: none;
      border-radius: 50%;
      background-color: var(--dwell-red);
      will-change: transform;
      z-index: 1;
    }
    @keyframes dwellGrow{
      from { transform: translate(-50%, -50%) scale(0.08); }
      to   { transform: translate(-50%, -50%) scale(1.02); }
    }

    .flash::after{
      content:""; position:absolute; left:50%; top:50%;
      width:100%; height:100%; transform:translate(-50%,-50%) scale(1);
      border-radius:50%;
      box-shadow: 0 0 0 0 rgba(17,17,17,0.35);
      animation: ringPulse 420ms ease-out;
      pointer-events:none;
    }
    @keyframes ringPulse{
      0%   { box-shadow: 0 0 0 0 rgba(17,17,17,0.35); transform:translate(-50%,-50%) scale(1.0); }
      60%  { box-shadow: 0 0 0 18px rgba(17,17,17,0.0); transform:translate(-50%,-50%) scale(1.08); }
      100% { box-shadow: 0 0 0 24px rgba(17,17,17,0.0); transform:translate(-50%,-50%) scale(1.0); }
    }

    #brushSizes{
      display: flex; flex-direction: column; align-items: center;
      gap: var(--brush-gap); margin-top: 4px;
    }
    .brushBtn{
      width: var(--brush-btn); height: var(--brush-btn);
      border-radius: 50%;
      border: 2px solid #aaa; background: #f8f8f8;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,.1) inset;
      transition: transform .12s ease, background-color .12s ease;
      position: relative;
      overflow: hidden;
    }
    .brushBtn span{ display: block; border-radius: 50%; background: #333; }
    .brushBtn.small  span{ width: var(--brush-dot-s); height: var(--brush-dot-s); }
    .brushBtn.medium span{ width: var(--brush-dot-m); height: var(--brush-dot-m); }
    .brushBtn.large  span{ width: var(--brush-dot-l); height: var(--brush-dot-l); }
    .brushBtn.active{ border-color:#333; transform: scale(1.08); background:#ececec; }
    body.dark #sidebar .brushBtn{ background:#f8f8f8; border-color:#aaa; }
    body.dark #sidebar .brushBtn span{ background:#333; }
    body.dark #sidebar .brushBtn.active{ background:#ececec; }

    #saveBtn{
      appearance: none; border: 1px solid #ddd; background: #fafafa;
      width: var(--save-btn); height: var(--save-btn);
      border-radius: var(--save-radius); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font: clamp(14px, calc(18px * var(--ui-scale)), 22px)/1 system-ui, Arial;
      margin-top: 2px;
      align-self: center;
      color:#000;
      overflow: hidden;
      position: relative;
    }
    #saveBtn:hover{ background:#f2f2f2; }
    body.dark #sidebar #saveBtn{ background:#fafafa; border-color:#ddd; color:#000; }
    body.dark #sidebar #saveBtn:hover{ background:#f2f2f2; }

    #cursorPreview{
      position: fixed; left: 0; top: 0; width: 20px; height: 20px; border-radius: 50%;
      pointer-events: none; z-index: 15; mix-blend-mode: multiply;
      transform: translate(-50%,-50%); opacity: .65;
      outline: var(--cursor-outline) solid rgba(0,0,0,.18);
    }
    .cursor-pop{ animation: cursorPop 260ms ease-out; }
    @keyframes cursorPop{
      0%   { transform: translate(-50%,-50%) scale(1.00); outline-width: var(--cursor-outline); }
      60%  { transform: translate(-50%,-50%) scale(1.14); outline-width: calc(var(--cursor-outline) * 2.2); }
      100% { transform: translate(-50%,-50%) scale(1.00); outline-width: var(--cursor-outline); }
    }

    #selectPulse{
      position: fixed; left: 0; top: 0; pointer-events: none; z-index: 14;
      width: 22px; height: 22px; border-radius: 50%;
      transform: translate(-50%, -50%) scale(1);
      opacity: 0; border: 4px solid transparent;
    }
    .pulse-show{ animation: pulseExpand 420ms ease-out; }
    @keyframes pulseExpand{
      0%   { opacity: .8; transform: translate(-50%,-50%) scale(1.0); }
      70%  { opacity: .25; transform: translate(-50%,-50%) scale(2.8); }
      100% { opacity: 0;  transform: translate(-50%,-50%) scale(3.2); }
    }

    #signatureRow { display:flex; flex-direction:column; align-items:flex-start; gap:8px; }
    #signatureText { display:none; max-width: 220px; }

    .mask-summary-box{
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 2px solid rgba(0, 150, 136, 0.25);
      background: #f5fffd;
    }
    .mask-summary-box img{
      width: 76px;
      height: 76px;
      object-fit: contain;
      border-radius: 10px;
      border: 2px solid rgba(0, 150, 136, 0.35);
      background: #ffffff;
      display: none;
    }
    .mask-summary-box img.show-thumb{ display:block; }
    .mask-summary-box p{ margin: 0; font-size: 0.95rem; color: #0f172a; }
    .mask-summary-box small{ display:block; margin-top:4px; color:#475569; font-size:0.82rem; }

    .option-item .button-secondary{
      width: 100%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 10px 14px;
      border-radius: 12px;
      border: 2px solid rgba(14,116,144,0.25);
      background: rgba(255,255,255,0.85);
      color: #036672;
      font-weight: 600;
      cursor: pointer;
      gap: 8px;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .option-item .button-secondary:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 20px rgba(13,148,136,0.18);
    }
    .option-item .button-secondary[disabled]{
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .mask-modal{
      position: fixed;
      inset: 0;
      background: rgba(7,17,27,0.68);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 120000;
      padding: 24px;
    }
    .mask-modal.show{ display:flex; }
    .mask-modal-card{
      width: min(900px, 96vw);
      max-height: min(620px, 92vh);
      background: #f8fafc;
      border-radius: 22px;
      box-shadow: 0 28px 60px rgba(15,23,42,0.32);
      display: flex;
      flex-direction: column;
      padding: 20px 24px 24px;
      gap: 18px;
      position: relative;
    }
    .mask-modal-header{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
    }
    .mask-modal-header h3{
      margin:0;
      font-size: 1.5rem;
      color:#0f172a;
    }
    .mask-modal-header button{
      appearance:none;
      border:none;
      background:transparent;
      font-size:1.4rem;
      cursor:pointer;
      color:#1e293b;
      padding:6px;
      border-radius:10px;
      transition: background .15s ease;
    }
    .mask-modal-header button:hover{ background: rgba(148,163,184,0.2); }

    .mask-modal-body{
      flex:1;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 18px;
      min-height: 260px;
    }
    .mask-modal-preview{
      display:flex;
      flex-direction:column;
      gap:12px;
      background:#ffffff;
      border-radius:18px;
      padding:16px;
      border:2px solid rgba(15,118,110,0.15);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
    }
    .mask-modal-preview img{
      width:100%;
      aspect-ratio: 4 / 3;
      object-fit: contain;
      border-radius:14px;
      border:1px solid rgba(15,23,42,0.08);
      background:#f1f5f9;
    }
    .mask-modal-preview p{
      margin:0;
      font-size:1rem;
      font-weight:600;
      color:#0f172a;
    }
    .mask-modal-preview span{
      font-size:0.9rem;
      color:#475569;
    }

    .mask-modal-list{
      background:#ffffff;
      border-radius:18px;
      border:2px solid rgba(14,116,144,0.12);
      padding:16px;
      overflow:auto;
      display:grid;
      gap:12px;
      grid-template-columns: repeat(auto-fill, minmax(160px,1fr));
    }
    .mask-item{
      border-radius:14px;
      border:2px solid transparent;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:#f8fafc;
      cursor:pointer;
      transition:border .15s ease, transform .15s ease, box-shadow .15s ease;
    }
    .mask-item img{
      width:100%;
      aspect-ratio:4/3;
      object-fit:contain;
      border-radius:12px;
      background:#eef2ff;
    }
    .mask-item strong{
      font-size:0.95rem;
      color:#0f172a;
    }
    .mask-item span{
      font-size:0.8rem;
      color:#64748b;
    }
    .mask-item:hover{ transform: translateY(-2px); box-shadow: 0 18px 32px rgba(148,163,184,0.32); }
    .mask-item.active{
      border-color:#0ea5e9;
      box-shadow: 0 18px 32px rgba(14,165,233,0.35);
    }

    .mask-modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:12px;
    }
    .mask-modal-footer button{
      min-width:120px;
      padding:10px 18px;
      border-radius:14px;
      font-size:1rem;
      font-weight:600;
      border:none;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .mask-modal-footer .cancel-btn{
      background:#e2e8f0;
      color:#0f172a;
    }
    .mask-modal-footer .confirm-btn{
      background:#0ea5e9;
      color:#ffffff;
      box-shadow: 0 10px 20px rgba(14,165,233,0.28);
    }
    .mask-modal-footer button:disabled{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .mask-modal-footer button:not(:disabled):hover{
      transform: translateY(-1px);
    }

    @media (max-width: 960px){
      .mask-modal-body{ grid-template-columns: 1fr; }
    }
  </style>
  <script src="../../js/cvipngarray.js" defer></script>
</head>
<body class="dark">
<button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

<div id="game-options" class="modal">
  <div id="options-title-bar">
    <h2 id="options-main-title" class="translate"
        data-fr="Dessiner dans les contours (Eyegaze)"
        data-en="Draw inside the lines (Eyegaze)">Dessiner dans les contours (Eyegaze)</h2>
  </div>

  <div id="control-panel-options">
    <div id="mode-divider"></div>

    <div id="options-inline-container">
      <div class="options-column">
        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="muteSFX">
            <span class="translate" data-fr="Désactiver les sons" data-en="Disable sounds">Désactiver les sons (SFX)</span>
          </label>
        </div>
        <div class="option-item">
          <label for="sfxVol" class="teal-label">
            <span class="translate" data-fr="Volume des sons:" data-en="Sound volume:">Volume des sons:</span>
            <span id="sfxVolVal">50</span>
          </label>
          <input type="range" id="sfxVol" class="styled-slider" min="0" max="100" value="50">
        </div>
      </div>

      <div class="options-column">
        <div class="option-item">
          <label for="themeSelect" class="teal-label label-block translate" data-fr="Mode" data-en="Theme">Mode</label>
          <select id="themeSelect" class="styled-select">
            <option value="light" class="translate" data-fr="Clair" data-en="Light">Clair</option>
            <option value="dark" class="translate" data-fr="Sombre" data-en="Dark">Sombre</option>
          </select>
        </div>
        <div class="option-item">
          <label for="shapeSelect" class="teal-label label-block translate" data-fr="Contour intégré" data-en="Built-in outline">Contour intégré</label>
          <select id="shapeSelect" class="styled-select">
            <option value="blob" class="translate" data-fr="Goutte organique" data-en="Organic blob">Goutte organique</option>
            <option value="star" class="translate" data-fr="Étoile" data-en="Star">Étoile</option>
            <option value="heart" class="translate" data-fr="Cœur" data-en="Heart">Cœur</option>
            <option value="rect" class="translate" data-fr="Rectangle arrondi" data-en="Rounded rectangle">Rectangle arrondi</option>
          </select>
        </div>
        <div class="option-item">
          <div class="mask-summary-box">
            <img id="maskThumb" alt="aperçu" />
            <div>
              <p id="selectedMaskLabel">Contour actuel : Goutte organique</p>
              <small id="presetStatus">Bibliothèque optionnelle non trouvée. Ajoutez <code>../../js/cvipngarray.js</code>.</small>
            </div>
          </div>
        </div>
        <div class="option-item">
          <button id="openLibrary" type="button" class="button-secondary translate" data-fr="Bibliothèque d'images" data-en="Image library">Bibliothèque d'images</button>
        </div>
      </div>

      <div class="options-column">
        <div class="option-item">
          <label for="paletteSizeSelect" class="teal-label label-block translate"
                 data-fr="Nombre de couleurs" data-en="Number of colors">Nombre de couleurs</label>
          <select id="paletteSizeSelect" class="styled-select">
            <option value="4" class="translate" data-fr="4 couleurs" data-en="4 colors">4 couleurs</option>
            <option value="7" selected class="translate" data-fr="7 couleurs" data-en="7 colors">7 couleurs</option>
            <option value="13" class="translate" data-fr="13 couleurs" data-en="13 colors">13 couleurs</option>
          </select>
        </div>
        <div class="option-item" id="signatureRow">
          <label class="teal-label" for="signatureEnable" style="user-select:none;">
            <input type="checkbox" id="signatureEnable">
            <span class="translate" data-fr="Signature" data-en="Signature">Signature</span>
          </label>
          <input type="text" id="signatureText" class="styled-input" placeholder="Votre nom / Your name" />
        </div>
        <div class="option-item">
          <label for="outlineFile" class="button-secondary translate" data-fr="Téléverser un PNG" data-en="Upload PNG">Téléverser un PNG</label>
          <input type="file" id="outlineFile" accept="image/png,image/svg+xml" hidden>
        </div>
        <div class="option-item">
          <button id="resetMask" type="button" class="button-secondary translate" data-fr="Contour par défaut" data-en="Default outline">Contour par défaut</button>
        </div>
      </div>
    </div>

    <div id="mode-divider"></div>
    <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start">Commencer</button>
  </div>
</div>

<div class="mask-modal" id="maskLibrary" aria-hidden="true">
  <div class="mask-modal-card">
    <div class="mask-modal-header">
      <h3 class="translate" data-fr="Choisir une image" data-en="Choose an image">Choisir une image</h3>
      <button type="button" id="closeLibrary" aria-label="Fermer">×</button>
    </div>
    <div class="mask-modal-body">
      <div class="mask-modal-preview">
        <img id="libraryPreview" alt="aperçu" />
        <p id="libraryTitle">&nbsp;</p>
        <span id="libraryCategory"></span>
      </div>
      <div class="mask-modal-list" id="libraryList"></div>
    </div>
    <div class="mask-modal-footer">
      <button type="button" class="cancel-btn translate" id="cancelLibrary" data-fr="Annuler" data-en="Cancel">Annuler</button>
      <button type="button" class="confirm-btn translate" id="confirmLibrary" data-fr="Valider" data-en="Confirm" disabled>Valider</button>
    </div>
  </div>
</div>

<div class="game-container" id="paintGame">
  <aside id="sidebar">
    <div id="palette"></div>
    <div id="brushSizes">
      <div class="brushBtn small" data-size="small" title="Petit / Small"><span></span></div>
      <div class="brushBtn medium active" data-size="medium" title="Moyen / Medium"><span></span></div>
      <div class="brushBtn large" data-size="large" title="Grand / Large"><span></span></div>
    </div>
    <button id="saveBtn" type="button" aria-label="Enregistrer PNG" title="Enregistrer PNG">💾</button>
  </aside>

  <canvas id="c" aria-label="drawing canvas"></canvas>
  <canvas id="maskOverlay" aria-hidden="true"></canvas>
  <div id="cursorPreview" aria-hidden="true"></div>
  <div id="selectPulse" aria-hidden="true"></div>
</div>

<script>
const LS_LANG_KEY = 'siteLanguage';
const LS_PALETTE_KEY = 'paint_palette_size';
const langToggle  = document.getElementById('langToggle');
function getLang(){
  try{const s=localStorage.getItem(LS_LANG_KEY); if(s==='en'||s==='fr') return s;}catch(e){}
  return (document.documentElement.lang==='en')?'en':'fr';
}
function setLang(lang){
  const safe=(lang==='en')?'en':'fr';
  document.documentElement.lang=safe;
  try{localStorage.setItem(LS_LANG_KEY,safe);}catch(e){}
  document.querySelectorAll('.translate').forEach(el=>{
    const fr=el.getAttribute('data-fr'); const en=el.getAttribute('data-en');
    if (safe==='fr' && fr!=null) el.textContent=fr;
    if (safe==='en' && en!=null) el.textContent=en;
  });
  updateMaskSummary();
  updatePresetStatus();
}
(function initLang(){
  let initial='fr';
  try{
    const saved=localStorage.getItem(LS_LANG_KEY);
    initial=(saved==='en'||saved==='fr')?saved:(document.documentElement.lang==='en'?'en':'fr');
    localStorage.setItem(LS_LANG_KEY,initial);
  }catch(e){
    initial=(document.documentElement.lang==='en'?'en':'fr');
  }
  setLang(initial);
})();
langToggle.addEventListener('click', ()=> setLang(getLang()==='fr'?'en':'fr'));

const themeSelect   = document.getElementById('themeSelect');
const paletteSizeSelect = document.getElementById('paletteSizeSelect');
function applyTheme(theme){
  document.body.classList.remove('light','dark');
  document.body.classList.add(theme==='dark'?'dark':'light');
  drawMaskOverlay();
}

const signatureEnable = document.getElementById('signatureEnable');
const signatureTextInput = document.getElementById('signatureText');
signatureEnable.addEventListener('change', ()=>{
  signatureTextInput.style.display = signatureEnable.checked ? 'block' : 'none';
});

(function initPaletteSize(){
  try{
    const saved = localStorage.getItem(LS_PALETTE_KEY);
    if(saved==='4'||saved==='7'||saved==='13'){
      paletteSizeSelect.value = saved;
    }
  }catch(e){}
})();
paletteSizeSelect.addEventListener('change', ()=>{
  try{ localStorage.setItem(LS_PALETTE_KEY, paletteSizeSelect.value); }catch(e){}
  if (document.getElementById('paintGame').style.display === 'block') {
    buildPalette(parseInt(paletteSizeSelect.value,10));
  }
});

function updateUiScale(){
  const vmin = Math.min(window.innerWidth, window.innerHeight);
  const scale = Math.min(1.6, Math.max(0.70, vmin / 900));
  document.documentElement.style.setProperty('--ui-scale', scale.toFixed(3));
}
updateUiScale();
addEventListener('resize', updateUiScale, {passive:true});

const startButton = document.getElementById('startButton');
const gameOptions = document.getElementById('game-options');
const gameArea    = document.getElementById('paintGame');

async function enterFullscreen(){
  const el=document.documentElement;
  try{
    if(el.requestFullscreen) await el.requestFullscreen();
    else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    else if(el.msRequestFullscreen) await el.msRequestFullscreen();
  }catch(e){}
}

const MUSIC_TRACKS = [
  "../../songs/artgallery1.mp3",
  "../../songs/artgallery2.mp3",
  "../../songs/artgallery3.mp3",
  "../../songs/artgallery4.mp3"
];
let musicIdx = Math.floor(Math.random() * MUSIC_TRACKS.length);
let musicAudio = null;
let MUSIC_ENABLED = true;

function playNextTrack(){
  if (!MUSIC_ENABLED) return;
  if (musicAudio){
    musicAudio.onended = null;
    try { musicAudio.pause(); } catch(e){}
  }
  musicAudio = new Audio(MUSIC_TRACKS[musicIdx]);
  musicAudio.volume = 0.5;
  musicAudio.loop = false;
  musicAudio.play().catch(()=>{});
  musicAudio.onended = ()=>{
    if (!MUSIC_ENABLED) return;
    musicIdx = (musicIdx + 1) % MUSIC_TRACKS.length;
    playNextTrack();
  };
}

const muteSFX = document.getElementById('muteSFX');
function updateAudioMute(){
  MUSIC_ENABLED = !muteSFX.checked;
  if (!MUSIC_ENABLED){
    if (musicAudio){
      try { musicAudio.pause(); } catch(e){}
    }
  } else {
    if (!musicAudio || musicAudio.paused){
      playNextTrack();
    }
  }
}
muteSFX.addEventListener('change', updateAudioMute);

let SIG_ENABLED = false;
let SIG_TEXT = "";
function drawSignatureIfEnabled(){
  if(!SIG_ENABLED || !SIG_TEXT) return;
  const margin = 14;
  const px = Math.max(18, Math.min(48, Math.round(innerWidth * 0.035)));
  const text = SIG_TEXT.trim();
  if(!text) return;

  ctx.save();
  ctx.font = `${px}px "Brush Script MT", "Segoe Script", "Comic Sans MS", cursive`;
  ctx.textBaseline = 'alphabetic';
  ctx.textAlign = 'right';
  ctx.fillStyle = 'rgba(0,0,0,0.92)';
  ctx.strokeStyle = 'rgba(255,255,255,0.55)';
  ctx.lineWidth = Math.max(1.5, px * 0.10);
  ctx.shadowColor = 'rgba(0,0,0,0.15)';
  ctx.shadowBlur = Math.max(2, px * 0.2);

  const x = innerWidth - margin;
  const y = innerHeight - margin;
  ctx.strokeText(text, x, y);
  ctx.fillText(text, x, y);
  ctx.restore();
}

startButton.addEventListener('click', async ()=>{
  applyTheme(themeSelect.value);
  SIG_ENABLED = !!signatureEnable.checked;
  SIG_TEXT = (signatureTextInput.value || '').trim();

  await enterFullscreen();
  gameOptions.style.display='none';
  langToggle.style.display='none';
  gameArea.style.display='block';

  updateAudioMute();
  playNextTrack();

  setTimeout(()=> {
    resize({preserve:false});
    buildPalette(parseInt(paletteSizeSelect.value,10) || 7);
    drawMaskOverlay();
    drawSignatureIfEnabled();
  }, 50);
});

const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
const overlayCanvas=document.getElementById('maskOverlay');
const overlayCtx=overlayCanvas.getContext('2d');
const maskCanvas=document.createElement('canvas');
const maskCtx=maskCanvas.getContext('2d');
const scratch=document.createElement('canvas');
const scratchCtx=scratch.getContext('2d');
let maskImageData=null;
let maskReady=false;
let stageRect={x:0,y:0,width:0,height:0};

function getCanvasBg(){
  return document.body.classList.contains('dark') ? '#000000' : '#ffffff';
}

function clearWithIdentity(ctx2d){
  const m = ctx2d.getTransform();
  ctx2d.setTransform(1,0,0,1,0,0);
  ctx2d.clearRect(0,0,ctx2d.canvas.width,ctx2d.canvas.height);
  ctx2d.setTransform(m);
}

function resize({preserve=true}={}){
  const dpr=Math.max(1,window.devicePixelRatio||1);

  let snapshot=null;
  if(preserve&&canvas.width&&canvas.height){
    snapshot=document.createElement('canvas');
    snapshot.width=canvas.width; snapshot.height=canvas.height;
    snapshot.getContext('2d').drawImage(canvas,0,0);
  }

  const cssW=innerWidth, cssH=innerHeight;
  canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
  canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.fillStyle = getCanvasBg();
  ctx.fillRect(0,0,cssW,cssH);

  overlayCanvas.style.width=cssW+'px'; overlayCanvas.style.height=cssH+'px';
  overlayCanvas.width=Math.round(cssW*dpr); overlayCanvas.height=Math.round(cssH*dpr);
  overlayCtx.setTransform(dpr,0,0,dpr,0,0);
  clearWithIdentity(overlayCtx);

  maskCanvas.width=canvas.width; maskCanvas.height=canvas.height;
  maskCtx.setTransform(dpr,0,0,dpr,0,0);
  clearWithIdentity(maskCtx);

  scratch.width=canvas.width; scratch.height=canvas.height;
  scratchCtx.setTransform(dpr,0,0,dpr,0,0);
  clearWithIdentity(scratchCtx);

  if(snapshot){
    const prev=ctx.imageSmoothingEnabled;
    ctx.imageSmoothingEnabled=true;
    ctx.drawImage(snapshot,0,0,snapshot.width,snapshot.height,0,0,cssW,cssH);
    ctx.imageSmoothingEnabled=prev;
  }

  if(gameArea.style.display==='block'){
    rebuildMask();
  }
}
addEventListener('resize',()=>{ resize({preserve:true}); layoutPalette(); drawMaskOverlay(); },{passive:true});
['fullscreenchange','webkitfullscreenchange','msfullscreenchange']
  .forEach(evt=>document.addEventListener(evt,()=>{ resize({preserve:true}); layoutPalette(); drawMaskOverlay(); }));
resize({preserve:false});

let last=null,smoothW=2,currentColor="#000000",sizeMode="medium";
const cursorEl=document.getElementById('cursorPreview');
const pulseEl = document.getElementById('selectPulse');
const sidebar = document.getElementById('sidebar');
const paletteEl = document.getElementById('palette');
const brushBox = document.getElementById('brushSizes');
const saveBtn  = document.getElementById('saveBtn');
const sidebarW=()=>sidebar.getBoundingClientRect().width;

const sfxVol  = document.getElementById('sfxVol');
const sfxVolVal = document.getElementById('sfxVolVal');
sfxVol.addEventListener('input', ()=> sfxVolVal.textContent = sfxVol.value);
function playClick(){
  if (muteSFX?.checked) return;
  try{
    const ctxA = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctxA.createOscillator(); const g = ctxA.createGain();
    o.type='triangle'; o.frequency.value=660;
    g.gain.value = (parseInt(sfxVol.value,10)||50)/800;
    o.connect(g); g.connect(ctxA.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctxA.close(); }, 90);
  }catch(e){}
}

function widthFromSpeed(speed){
  let minW, maxW;
  if (sizeMode === "small")      { minW = 1;  maxW = 10; }
  else if (sizeMode === "medium"){ minW = 10; maxW = 40; }
  else { minW = 20; maxW = 80; }
  const s = Math.min(speed / 1.8, 1);
  const ease = k => k*k*(3 - 2*k);
  const inv = 1 - ease(s);
  return minW + (maxW - minW) * inv;
}

function stroke(a,b,w,color){
  if(maskReady){
    scratchCtx.save();
    scratchCtx.lineCap='round';
    scratchCtx.lineJoin='round';
    scratchCtx.lineWidth=w;
    scratchCtx.strokeStyle=color;
    scratchCtx.globalCompositeOperation='source-over';
    scratchCtx.beginPath(); scratchCtx.moveTo(a.x,a.y); scratchCtx.lineTo(b.x,b.y); scratchCtx.stroke();
    scratchCtx.globalCompositeOperation='destination-in';
    scratchCtx.drawImage(maskCanvas,0,0);
    scratchCtx.restore();

    ctx.save();
    ctx.globalCompositeOperation='source-over';
    ctx.drawImage(scratch,0,0);
    ctx.restore();

    clearWithIdentity(scratchCtx);
  } else {
    ctx.strokeStyle=color; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=w;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  }
}

function updateCursor(x,y,w){
  if (x < stageRect.x || y < stageRect.y || y > stageRect.y + stageRect.height){ cursorEl.style.opacity = 0; return; }
  cursorEl.style.opacity = .65;
  cursorEl.style.left = x + 'px';
  cursorEl.style.top  = y + 'px';
  const baseMin = (sizeMode === 'small') ? 4 : (sizeMode === 'medium') ? 8 : 10;
  const d = Math.max(baseMin, w);
  cursorEl.style.width  = d + 'px';
  cursorEl.style.height = d + 'px';
  cursorEl.style.background = currentColor;
}

function handleMove(x,y){
  if(x<stageRect.x || y<stageRect.y || y>stageRect.y+stageRect.height){last=null;updateCursor(x,y,16);return;}
  const t=performance.now();
  if(!last){last={x,y,t};updateCursor(x,y,16);return;}
  const dx=x-last.x, dy=y-last.y, dt=Math.max(1,t-last.t);
  const speed=Math.hypot(dx,dy)/dt;
  const targetW=widthFromSpeed(speed);
  smoothW=smoothW*0.82+targetW*0.18;
  stroke(last,{x,y},smoothW,currentColor);
  updateCursor(x,y,smoothW);
  last={x,y,t};
}
canvas.addEventListener('mousemove',e=>handleMove(e.clientX,e.clientY),{passive:true});
canvas.addEventListener('mouseleave',()=>{last=null;cursorEl.style.opacity=0;},{passive:true});
canvas.addEventListener('mouseenter',e=>{last={x:e.clientX,y:e.clientY,t:performance.now()};updateCursor(e.clientX,e.clientY,16);},{passive:true});
canvas.addEventListener('touchmove',e=>{const t=e.touches[0]; if(t) handleMove(t.clientX,t.clientY);},{passive:true});
canvas.addEventListener('touchend',()=>{last=null;},{passive:true});

function flashEl(el){
  el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash');
  setTimeout(()=> el.classList.remove('flash'), 460);
}
function popCursor(){
  cursorEl.classList.remove('cursor-pop'); void cursorEl.offsetWidth; cursorEl.classList.add('cursor-pop');
  setTimeout(()=> cursorEl.classList.remove('cursor-pop'), 300);
}
function pulseAt(x,y,color){
  pulseEl.style.left = x + 'px';
  pulseEl.style.top  = y + 'px';
  pulseEl.style.borderColor = color || 'rgba(0,0,0,.35)';
  pulseEl.classList.remove('pulse-show'); void pulseEl.offsetWidth; pulseEl.classList.add('pulse-show');
  setTimeout(()=> pulseEl.classList.remove('pulse-show'), 460);
}

const PALETTE_13 = [
  "#000000",
  "#FF6B6B", "#F94144",
  "#FFD166", "#F9C74F",
  "#06D6A0", "#90BE6D", "#43AA8B",
  "#118AB2", "#3A86FF",
  "#9B59B6", "#8338EC",
  "#FF9F1C"
];

function pickColors(n){
  if(n>=13) return PALETTE_13.slice(0,13);
  if(n===7){
    return ["#000000","#FF6B6B","#FFD166","#06D6A0","#118AB2","#9B59B6","#FF9F1C"];
  }
  if(n===4){
    return ["#000000","#FF6B6B","#06D6A0","#3A86FF"];
  }
  return PALETTE_13.slice(0,n);
}

function setColor(el, eventLike){
  document.querySelectorAll('.swatch').forEach(s=>s.classList.toggle('active',s===el));
  currentColor = el?.dataset?.color || "#000000";
  cursorEl.style.background = currentColor;
  const dw = el.querySelector('.dwell'); if (dw) dw.remove();
  flashEl(el);
  popCursor();
  const x = (eventLike?.clientX) ?? (window.innerWidth/2);
  const y = (eventLike?.clientY) ?? (window.innerHeight/2);
  pulseAt(x,y,currentColor);
  playClick();
}

function clearPalette(){
  while(paletteEl.firstChild) paletteEl.removeChild(paletteEl.firstChild);
}

function buildPalette(n){
  clearPalette();
  let colors = pickColors(n);
  if (document.body.classList.contains('dark') && colors.length > 0){
    colors[0] = '#FFFFFF';
  }
  colors.forEach(col=>{
    const btn = document.createElement('button');
    btn.className = 'swatch';
    btn.style.background = col;
    btn.dataset.color = col;
    paletteEl.appendChild(btn);
  });
  wireSwatches();
  const swatches = document.querySelectorAll('.swatch');
  if (swatches.length){
    const rnd = Math.floor(Math.random() * swatches.length);
    setColor(swatches[rnd]);
  }
  layoutPalette();
}

const HOVER_DWELL_MS = 650;
const SAVE_DWELL_MS  = 2500;

function startDwellCircle(el, durationMs){
  let overlay = el.querySelector('.dwell');
  if(!overlay){
    overlay = document.createElement('div');
    overlay.className = 'dwell';
    el.appendChild(overlay);
  }
  overlay.style.animation = 'none';
  overlay.style.transform = 'translate(-50%, -50%) scale(0.08)';
  void overlay.offsetWidth;
  overlay.style.animation = `dwellGrow ${durationMs}ms linear forwards`;
  return overlay;
}
function resetDwellCircle(el){
  const overlay = el.querySelector('.dwell');
  if(overlay) overlay.remove();
}

function wireSwatches(){
  const swatches = document.querySelectorAll('.swatch');
  swatches.forEach(s=>{
    let timer = null;
    const clearTimer = ()=>{ if(timer){ clearTimeout(timer); timer=null; } };

    s.addEventListener('mouseenter', (e)=>{
      clearTimer();
      resetDwellCircle(s);
      startDwellCircle(s, HOVER_DWELL_MS);
      timer = setTimeout(()=>{ setColor(s, e); }, HOVER_DWELL_MS + 5);
    });

    s.addEventListener('mouseleave', ()=>{
      clearTimer();
      resetDwellCircle(s);
    });

    s.addEventListener('click', (e)=>{ clearTimer(); resetDwellCircle(s); setColor(s, e); });
    s.addEventListener('touchstart', (e)=>{ clearTimer(); resetDwellCircle(s); setColor(s, e.touches?.[0] || e); });
  });
}

function layoutPalette(){
  const n = paletteEl.children.length;
  if(!n) return;

  const styles = getComputedStyle(sidebar);
  const padY = parseFloat(styles.getPropertyValue('padding-top')||'12')
             + parseFloat(styles.getPropertyValue('padding-bottom')||'12');
  const padX = parseFloat(styles.getPropertyValue('padding-left')||'12')
             + parseFloat(styles.getPropertyValue('padding-right')||'12');

  const reserve = brushBox.offsetHeight + saveBtn.offsetHeight + 24;

  const availH = Math.max(0, sidebar.clientHeight - padY - reserve);
  const availW = Math.max(0, sidebar.clientWidth - padX);

  const rootCS = getComputedStyle(document.documentElement);
  const uiScale = parseFloat(rootCS.getPropertyValue('--ui-scale')) || 1;

  let gap = Math.max(6, Math.min(14, Math.round(12 * uiScale)));

  const computeSize = (cols, minSize, maxSize) => {
    const rows = Math.ceil(n / cols);
    const sFromH = Math.floor((availH - (rows - 1) * gap) / rows);
    const sFromW = Math.floor((availW - (cols - 1) * gap) / cols);
    let s = Math.min(sFromH, sFromW);
    if (!Number.isFinite(s)) s = minSize;
    s = Math.max(minSize, Math.min(maxSize, s));
    return { s, rows, cols };
  };

  const nIs13 = (n >= 13);
  const minSize = nIs13 ? 24 : 28;
  const maxSize = nIs13 ? 52 : 96;

  let layout = computeSize(1, minSize, maxSize);
  if (layout.s <= minSize + 1 && n > 6) {
    layout = computeSize(2, minSize, maxSize);
  }

  sidebar.style.setProperty('--palette-cols', layout.cols.toString());
  sidebar.style.setProperty('--swatch-size', layout.s + 'px');
  sidebar.style.setProperty('--swatch-gap',  gap + 'px');

  const border  = Math.max(2, Math.round(layout.s * 0.06));
  const outline = Math.max(2, Math.round(layout.s * 0.06));
  sidebar.style.setProperty('--swatch-border',  border + 'px');
  sidebar.style.setProperty('--swatch-outline', outline + 'px');
}

const brushBtns = document.querySelectorAll('.brushBtn');
function setBrushSize(btn, eventLike){
  brushBtns.forEach(b=>b.classList.toggle('active',b===btn));
  sizeMode=btn.dataset.size;
  flashEl(btn); popCursor();
  const x = (eventLike?.clientX) ?? (window.innerWidth/2);
  const y = (eventLike?.clientY) ?? (window.innerHeight/2);
  pulseAt(x,y,'rgba(0,0,0,.45)');
  playClick();
}
function setBrushSizeByName(name){
  const btn=Array.from(brushBtns).find(b=>b.dataset.size===name) || brushBtns[1];
  setBrushSize(btn);
}

brushBtns.forEach(b=>{
  let timer = null;
  const clearTimer = ()=>{ if(timer){ clearTimeout(timer); timer=null; } };

  b.addEventListener('mouseenter',(e)=>{
    clearTimer();
    resetDwellCircle(b);
    startDwellCircle(b, HOVER_DWELL_MS);
    timer = setTimeout(()=>{ setBrushSize(b, e); }, HOVER_DWELL_MS + 5);
  });

  b.addEventListener('mouseleave', ()=>{
    clearTimer();
    resetDwellCircle(b);
  });

  b.addEventListener('click',     (e)=>{ clearTimer(); resetDwellCircle(b); setBrushSize(b, e); });
  b.addEventListener('touchstart',(e)=>{ clearTimer(); resetDwellCircle(b); setBrushSize(b, e.touches?.[0] || e); });
});

function doSave(){
  drawSignatureIfEnabled();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const sideCssW = sidebarW();
  const sx = Math.max(0, Math.min(canvas.width, Math.round(sideCssW * dpr)));
  const sw = Math.max(0, canvas.width - sx);
  const sh = canvas.height;

  if (sw > 0 && sh > 0){
    const off = document.createElement('canvas');
    off.width  = sw;
    off.height = sh;
    const octx = off.getContext('2d');
    octx.drawImage(overlayCanvas, sx, 0, sw, sh, 0, 0, sw, sh);
    octx.drawImage(canvas, sx, 0, sw, sh, 0, 0, sw, sh);

    const link=document.createElement('a');
    link.href=off.toDataURL('image/png');
    link.download='eyegaze-draw.png';
    link.click();
  } else {
    const link=document.createElement('a');
    link.href=canvas.toDataURL('image/png');
    link.download='eyegaze-draw.png';
    link.click();
  }
}

document.getElementById('saveBtn').addEventListener('click', doSave);
(function wireSaveDwell(){
  let timer = null;
  const clearTimer = ()=>{ if(timer){ clearTimeout(timer); timer=null; } };

  saveBtn.addEventListener('mouseenter', ()=>{
    clearTimer();
    resetDwellCircle(saveBtn);
    startDwellCircle(saveBtn, SAVE_DWELL_MS);
    timer = setTimeout(()=>{ doSave(); resetDwellCircle(saveBtn); }, SAVE_DWELL_MS + 5);
  });

  saveBtn.addEventListener('mouseleave', ()=>{
    clearTimer();
    resetDwellCircle(saveBtn);
  });
})();

addEventListener('keydown',e=>{
  if(e.code!=='Space') return;
  const t=e.target;
  const isUI=t && (t.tagName==='INPUT'||t.tagName==='SELECT'||t.tagName==='TEXTAREA'||t.tagName==='BUTTON'||t.isContentEditable);
  if(isUI) return;
  ctx.fillStyle = getCanvasBg();
  ctx.fillRect(0,0,innerWidth,innerHeight);
  last=null; e.preventDefault();
  drawMaskOverlay();
  drawSignatureIfEnabled();
});

const shapeSelect = document.getElementById('shapeSelect');
const maskThumb = document.getElementById('maskThumb');
const selectedMaskLabel = document.getElementById('selectedMaskLabel');
const presetStatusEl = document.getElementById('presetStatus');
const openLibraryBtn = document.getElementById('openLibrary');
const outlineFileInput = document.getElementById('outlineFile');
const resetMaskBtn = document.getElementById('resetMask');
const libraryOverlay = document.getElementById('maskLibrary');
const closeLibraryBtn = document.getElementById('closeLibrary');
const cancelLibraryBtn = document.getElementById('cancelLibrary');
const confirmLibraryBtn = document.getElementById('confirmLibrary');
const libraryList = document.getElementById('libraryList');
const libraryPreview = document.getElementById('libraryPreview');
const libraryTitle = document.getElementById('libraryTitle');
const libraryCategory = document.getElementById('libraryCategory');

let maskMode = 'shape';
let currentShape = 'blob';
let userMask = null;
let userMaskName = '';
let presetItems = [];
let presetsLoaded = false;
let selectedPreset = null;

const shapeNames = {
  fr: {
    blob: 'Goutte organique',
    star: 'Étoile',
    heart: 'Cœur',
    rect: 'Rectangle arrondi'
  },
  en: {
    blob: 'Organic blob',
    star: 'Star',
    heart: 'Heart',
    rect: 'Rounded rectangle'
  }
};

function updateMaskSummary(){
  const lang = getLang();
  if(maskMode==='image' && userMask){
    maskThumb.src = userMask.src;
    maskThumb.classList.add('show-thumb');
    const base = lang==='fr' ? 'Contour actuel :' : 'Current outline:';
    const name = userMaskName || (lang==='fr' ? 'Image personnalisée' : 'Custom image');
    selectedMaskLabel.textContent = `${base} ${name}`;
  } else {
    maskThumb.classList.remove('show-thumb');
    const base = lang==='fr' ? 'Contour actuel :' : 'Current outline:';
    const display = shapeNames[lang]?.[currentShape] || currentShape;
    selectedMaskLabel.textContent = `${base} ${display}`;
  }
}

function updatePresetStatus(){
  const lang = getLang();
  if(presetsLoaded && presetItems.length){
    const msg = lang==='fr'
      ? `Bibliothèque chargée (${presetItems.length} images).`
      : `Library loaded (${presetItems.length} images).`;
    presetStatusEl.textContent = msg;
  } else {
    const msg = lang==='fr'
      ? `Bibliothèque optionnelle non trouvée. Ajoutez ../../js/cvipngarray.js.`
      : `Optional library not found. Provide ../../js/cvipngarray.js.`;
    presetStatusEl.textContent = msg;
  }
}

function computeFit(destW,destH, imgW,imgH){
  const r = imgW/imgH;
  const R = destW/destH;
  if(R>r){
    const w = destH*r;
    const h = destH;
    return {x:(destW-w)/2, y:0, w, h};
  } else {
    const w = destW;
    const h = destW/r;
    return {x:0, y:(destH-h)/2, w, h};
  }
}

function makeShapePath(kind){
  const stageW = Math.max(1, stageRect.width);
  const stageH = Math.max(1, stageRect.height);
  const offsetX = stageRect.x;
  const offsetY = stageRect.y;
  const p = new Path2D();
  const pad = Math.min(stageW,stageH)*0.12;
  const cx=offsetX + stageW/2;
  const cy=offsetY + stageH/2;
  if(kind==='rect'){
    const r = Math.min(stageW,stageH)*0.18;
    const x=offsetX+pad, y=offsetY+pad, rw=stageW-2*pad, rh=stageH-2*pad;
    p.moveTo(x+r,y);
    p.arcTo(x+rw,y,x+rw,y+rh,r);
    p.arcTo(x+rw,y+rh,x,y+rh,r);
    p.arcTo(x,y+rh,x,y,r);
    p.arcTo(x,y,x+rw,y,r);
    p.closePath();
  } else if(kind==='blob'){
    const rx=stageW*0.32, ry=stageH*0.28;
    p.moveTo(cx, cy-ry);
    p.bezierCurveTo(cx+rx*0.6, cy-ry, cx+rx, cy-ry*0.2, cx+rx, cy);
    p.bezierCurveTo(cx+rx, cy+ry*0.6, cx+rx*0.4, cy+ry, cx, cy+ry);
    p.bezierCurveTo(cx-rx*0.6, cy+ry, cx-rx, cy+ry*0.2, cx-rx, cy);
    p.bezierCurveTo(cx-rx, cy-ry*0.6, cx-rx*0.4, cy-ry, cx, cy-ry);
    p.closePath();
  } else if(kind==='star'){
    const spikes=5; const outer=Math.min(stageW,stageH)*0.36; const inner=outer*0.5;
    let rot=Math.PI/2*3; let x=cx; let y=cy-outer;
    p.moveTo(cx, cy-outer);
    for(let i=0;i<spikes;i++){
      x = cx + Math.cos(rot)*outer;
      y = cy + Math.sin(rot)*outer;
      p.lineTo(x,y); rot += Math.PI/spikes;
      x = cx + Math.cos(rot)*inner;
      y = cy + Math.sin(rot)*inner;
      p.lineTo(x,y); rot += Math.PI/spikes;
    }
    p.closePath();
  } else if(kind==='heart'){
    const s = Math.min(stageW,stageH)*0.36;
    const top = cy - s*0.25;
    p.moveTo(cx, top);
    p.bezierCurveTo(cx + s*0.5, top - s*0.6, cx + s, cy - s*0.05, cx, cy + s*0.75);
    p.bezierCurveTo(cx - s, cy - s*0.05, cx - s*0.5, top - s*0.6, cx, top);
    p.closePath();
  }
  return p;
}

function rebuildMask(){
  const side = sidebarW();
  stageRect = { x: side, y: 0, width: Math.max(1, innerWidth - side), height: innerHeight };
  maskReady=false;
  clearWithIdentity(maskCtx);
  clearWithIdentity(overlayCtx);
  if(stageRect.width <= 0 || stageRect.height <= 0){ return; }

  if(maskMode==='image' && userMask){
    const fit = computeFit(stageRect.width, stageRect.height, userMask.naturalWidth, userMask.naturalHeight);
    maskCtx.drawImage(userMask, stageRect.x + fit.x, stageRect.y + fit.y, fit.w, fit.h);
    const img = maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);
    const data = img.data;
    for(let i=0;i<data.length;i+=4){
      const a=data[i+3];
      data[i]=255; data[i+1]=255; data[i+2]=255; data[i+3]=a;
    }
    maskCtx.putImageData(img,0,0);
    maskImageData = img;

    overlayCtx.save();
    overlayCtx.globalAlpha = 0.25;
    overlayCtx.drawImage(userMask, stageRect.x + fit.x, stageRect.y + fit.y, fit.w, fit.h);
    overlayCtx.restore();
  } else {
    const path = makeShapePath(currentShape);
    maskCtx.save();
    maskCtx.fillStyle='#ffffff';
    maskCtx.fill(path);
    maskCtx.restore();
    maskImageData = maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);

    overlayCtx.save();
    overlayCtx.fillStyle = document.body.classList.contains('dark') ? 'rgba(255,255,255,0.08)' : 'rgba(15,23,42,0.08)';
    overlayCtx.fill(path);
    overlayCtx.lineWidth = 4;
    overlayCtx.strokeStyle = document.body.classList.contains('dark') ? 'rgba(255,255,255,0.45)' : 'rgba(15,23,42,0.45)';
    overlayCtx.stroke(path);
    overlayCtx.restore();
  }
  maskReady=true;
}

function drawMaskOverlay(){
  if(!maskReady) return;
  clearWithIdentity(overlayCtx);
  rebuildMask();
}

function loadUserMaskFromURL(url, name, revoke=false){
  const img = new Image();
  img.onload = ()=>{
    if(revoke) URL.revokeObjectURL(url);
    userMask = img;
    userMaskName = name || '';
    maskMode='image';
    updateMaskSummary();
    rebuildMask();
  };
  img.onerror = ()=>{
    if(revoke) URL.revokeObjectURL(url);
    alert('Impossible de charger cette image.');
  };
  img.src = url;
}

outlineFileInput.addEventListener('change', e=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  loadUserMaskFromURL(url, file.name, true);
});

shapeSelect.addEventListener('change', ()=>{
  currentShape = shapeSelect.value;
  maskMode='shape';
  userMask=null;
  userMaskName='';
  updateMaskSummary();
  rebuildMask();
});

resetMaskBtn.addEventListener('click', ()=>{
  shapeSelect.value='blob';
  currentShape='blob';
  maskMode='shape';
  userMask=null;
  userMaskName='';
  updateMaskSummary();
  rebuildMask();
});

function openLibrary(){
  if(!presetsLoaded){ return; }
  libraryOverlay.classList.add('show');
  libraryOverlay.setAttribute('aria-hidden','false');
}
function closeLibrary(){
  libraryOverlay.classList.remove('show');
  libraryOverlay.setAttribute('aria-hidden','true');
  selectedPreset=null;
  confirmLibraryBtn.disabled=true;
  libraryPreview.src='';
  libraryTitle.textContent='';
  libraryCategory.textContent='';
  Array.from(libraryList.children).forEach(el=>el.classList.remove('active'));
}

openLibraryBtn.addEventListener('click', openLibrary);
closeLibraryBtn.addEventListener('click', closeLibrary);
cancelLibraryBtn.addEventListener('click', closeLibrary);
libraryOverlay.addEventListener('click', e=>{ if(e.target===libraryOverlay) closeLibrary(); });

confirmLibraryBtn.addEventListener('click', ()=>{
  if(!selectedPreset) return;
  loadUserMaskFromURL(selectedPreset.file, selectedPreset.name);
  closeLibrary();
});

function buildLibrary(){
  libraryList.innerHTML='';
  presetItems.forEach(item=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='mask-item';
    btn.innerHTML=`<img src="${item.file}" alt="${item.name}"><strong>${item.name}</strong><span>${item.category}</span>`;
    btn.addEventListener('click', ()=>{
      selectedPreset=item;
      Array.from(libraryList.children).forEach(el=>el.classList.toggle('active', el===btn));
      libraryPreview.src=item.file;
      libraryTitle.textContent=item.name;
      libraryCategory.textContent=item.category;
      confirmLibraryBtn.disabled=false;
    });
    libraryList.appendChild(btn);
  });
}

function enablePresets(){
  if(!window.PNG_ARRAY || !Array.isArray(window.PNG_ARRAY) || window.PNG_ARRAY.length===0){
    presetsLoaded=false;
    openLibraryBtn.disabled=true;
    updatePresetStatus();
    return;
  }
  presetItems = window.PNG_ARRAY.map(item=>({
    name: item.name || item.file || 'Preset',
    category: item.category || 'Autre',
    file: item.file
  }));
  presetItems.sort((a,b)=>a.name.localeCompare(b.name));
  presetsLoaded=true;
  openLibraryBtn.disabled=false;
  buildLibrary();
  updatePresetStatus();
}

window.addEventListener('DOMContentLoaded', ()=>{ setTimeout(enablePresets, 0); });

updateMaskSummary();
updatePresetStatus();
</script>
</body>
</html>
