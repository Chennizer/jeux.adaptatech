<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Activité de choix multiple (YouTube)</title>
  <link rel="stylesheet" href="../../css/choix.css">
  <style>
    #tile-container.flashcard-mode .tile {
      width: 90vh !important;
      height: 90vh !important;
    }
    #tile-container.this-or-that-mode .tile {
      width: 60vh !important;
      height: 60vh !important;
    }
    #tile-container.grid-2x2 {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr);
      gap: 10vh;
      justify-items: center;
      align-items: center;
    }
    #tile-container.this-or-that-mode {
      gap: 30vh !important;
    }
    #tile-picker-grid .empty-state {
      width: 100%;
      text-align: center;
      font-size: 1.2rem;
      color: #fff;
      margin: 20px 0;
    }
  </style>
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-B45TJG4GBJ');
</script>
<body>
  <div id="game-options" class="modal" style="display: flex;">
    <div id="control-panel-options">
      <div id="options-title-bar">
        <h2 id="options-main-title" class="translate" data-fr="Activité de choix multiple (écran tactile)" data-en="Multiple Choice Activity (touchscreen)">Activité de choix multiple</h2>
      </div>
      <div id="mode-divider"></div>
      <div id="options-inline-container">
        <div id="advanced-options-section">
          <div class="advanced-options-container">
            <div class="option-item">
              <label for="enable-time-limit" class="teal-label">
                <input type="checkbox" id="enable-time-limit">
                <span class="translate" data-fr="Temps limite" data-en="Time Limit">Temps limite</span>
              </label>
            </div>
            <div id="time-limit-container" class="option-item" style="display: none;">
              <label for="time-limit-seconds" class="duration-label">
                <span class="translate" data-fr="Durée (sec):" data-en="Duration (sec):">Durée (sec):</span>
              </label>
              <input type="number" id="time-limit-seconds" min="1" value="30" class="styled-input-small">
            </div>
            <div id="resume-video-container" class="option-item" style="display: none;">
              <label for="enable-resume-video" class="teal-label">
                <input type="checkbox" id="enable-resume-video">
                <span class="translate" data-fr="Reprendre la vidéo" data-en="Resume Video">Reprendre la vidéo</span>
              </label>
            </div>
          </div>
        </div>
        <div id="game-options-controls">
          <div class="option-item" id="tile-slider-container">
            <label for="tile-count" class="control-label">
              <span class="translate" data-fr="Nombre de tuiles:" data-en="Number of Tiles:">Nombre de tuiles:</span>
              <span id="tile-count-value" class="slider-value no-translate">3</span>
            </label>
            <input type="range" id="tile-count" min="1" max="6" value="3" class="styled-slider">
          </div>
        </div>
        <div id="links-column">
          <a href="../../documentation/choix tactile/index.html" target="_blank" class="doc-link translate" data-fr="Instructions" data-en="Instructions">Instructions</a>
          <a href="../../documentation/pédagogie choix et scan/index.html" target="_blank" class="doc-link translate" data-fr="Pédagogie" data-en="Pedagogy">Pédagogie</a>
        </div>
      </div>
      <div id="mode-divider"></div>
      <button id="choose-tiles-button" class="button translate" data-fr="Choix des tuiles" data-en="Tile Selection">Choix des tuiles</button>
    </div>
  </div>

  <div id="tile-picker-modal" class="modal" style="display: none;">
    <div id="control-panel-options">
      <div id="control-panel-title-wrapper">
        <h2 id="control-panel-title" class="translate" data-fr="Choisir les tuiles" data-en="Choose the Tiles">Choisir les tuiles</h2>
      </div>
      <div id="control-panel-instructions">
        <span class="translate" data-fr="Choisir" data-en="Choose">Choisir</span>
        <span id="tile-count-display" class="no-translate"></span>
        <span class="translate" data-fr="tuiles." data-en="tiles.">tuiles.</span>
      </div>
      <div id="tile-picker-grid"></div>
      <div id="yt-import-controls">
        <div id="yt-input-row">
          <div class="actions-row">
            <input id="add-video-url-input" type="text" placeholder="URL" class="control-panel-input">
            <button id="add-video-url-button" class="button" data-fr="Ajouter URL" data-en="Add URL">Ajouter URL</button>
          </div>
          <div class="actions-row">
            <input id="yt-playlist-url-input" type="text" placeholder="URL de playlist (ex. https://www.youtube.com/playlist?list=...)" class="control-panel-input">
            <button id="yt-playlist-import-button" class="button" data-fr="Importer" data-en="Import">Importer</button>
          </div>
        </div>
        <div class="actions-row">
          <button id="clear-videos-button" class="button translate" data-fr="Tout effacer" data-en="Clear All">Tout effacer</button>
          <button id="start-game-button" class="button translate" data-fr="Commencer" data-en="Start" disabled>Commencer</button>
        </div>
      </div>
    </div>
  </div>

  <div id="tile-container" style="display: none;"></div>

  <div id="video-container" style="display: none;">
    <video id="video-player" autoplay>
      <source id="video-source" type="video/mp4" />
      <span class="translate" data-fr="Votre navigateur ne supporte pas la vidéo." data-en="Your browser does not support video.">
        Votre navigateur ne supporte pas la vidéo.
      </span>
    </video>
    <div id="youtube-player" style="display:none;width:100%;height:100%;pointer-events:none;"></div>
  </div>

  <script>

    let tilePickerGrid = null;
    let tileContainer = null;
    let videoContainer = null;
    let videoPlayer = null;
    let videoSource = null;
    let youtubeElement = null;
    let youtubePlayer = null;
    let youtubeReady = false;
    let pendingYouTubeStart = null;

    let gameOptionsModal = null;
    let tilePickerModal = null;
    let tileCountInput = null;
    let tileCountValue = null;
    let chooseTilesButton = null;
    let startGameButton = null;
    let tileCountDisplay = null;
    let enableTimeLimitCheckbox = null;
    let timeLimitContainer = null;
    let timeLimitInput = null;
    let enableResumeVideoCheckbox = null;
    let resumeVideoContainer = null;

    let selectedTileIndices = [];
    let desiredTileCount = 3;
    let videoPlaying = false;
    let videoTimeLimitTimeout = null;
    let inactivityTimer = null;
    let videoResumePositions = {};
    let currentVideoUrl = null;

    function isYouTubeUrl(url) {
      return /^(https?:\/\/)?(www\.|m\.)?((youtube\.com\/\S+)|(youtu\.be\/\S+))$/.test(url);
    }

    function extractYouTubeId(url) {
      try {
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) {
          return u.pathname.slice(1);
        }
        const id = u.searchParams.get('v');
        if (id) return id;
        const embed = url.match(/\/embed\/([a-zA-Z0-9_-]+)/);
        return embed ? embed[1] : null;
      } catch (e) {
        return null;
      }
    }

    function clearInactivityTimer() {
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
        inactivityTimer = null;
      }
    }

    function startInactivityTimer() {
      clearInactivityTimer();
      inactivityTimer = setTimeout(() => {}, 30000);
    }

    function resetInactivityTimer() {
      if (!videoPlaying) {
        startInactivityTimer();
      }
    }

    function rememberVideoPosition(videoUrl) {
      if (!enableResumeVideoCheckbox || !enableResumeVideoCheckbox.checked) {
        return;
      }
      if (isYouTubeUrl(videoUrl)) {
        if (youtubePlayer && typeof youtubePlayer.getCurrentTime === 'function') {
          videoResumePositions[videoUrl] = youtubePlayer.getCurrentTime();
        }
      } else {
        videoResumePositions[videoUrl] = videoPlayer.currentTime;
      }
    }

    function clearResumePosition(videoUrl) {
      delete videoResumePositions[videoUrl];
    }

    function getMediaChoices() {
      return window.mediaChoices || [];
    }

    window.populateTilePickerGrid = function populateTilePickerGrid() {
      if (!tilePickerGrid) return;
      tilePickerGrid.innerHTML = '';
      const choices = getMediaChoices();
      if (!choices.length) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'empty-state translate';
        emptyMessage.dataset.fr = 'Ajoutez des vidéos YouTube pour commencer.';
        emptyMessage.dataset.en = 'Add YouTube videos to get started.';
        emptyMessage.textContent = 'Ajoutez des vidéos YouTube pour commencer.';
        tilePickerGrid.appendChild(emptyMessage);
        updateStartButtonState();
        return;
      }
      choices.forEach((choice, idx) => {
        const tileOption = document.createElement('div');
        tileOption.classList.add('tile');
        tileOption.setAttribute('data-index', idx);
        tileOption.style.backgroundImage = `url(${choice.image})`;
        if (selectedTileIndices.includes(idx)) {
          tileOption.classList.add('selected');
        }
        const caption = document.createElement('div');
        caption.classList.add('caption');
        caption.textContent = choice.name;
        tileOption.appendChild(caption);
        tileOption.addEventListener('click', () => {
          resetInactivityTimer();
          if (selectedTileIndices.includes(idx)) {
            selectedTileIndices = selectedTileIndices.filter(i => i !== idx);
          } else if (selectedTileIndices.length < desiredTileCount) {
            selectedTileIndices.push(idx);
          }
          updateStartButtonState();
          populateTilePickerGrid();
        });
        tilePickerGrid.appendChild(tileOption);
      });
    };

    function updateStartButtonState() {
      if (!startGameButton) return;
      const choices = getMediaChoices();
      selectedTileIndices = selectedTileIndices.filter(idx => choices[idx]);
      startGameButton.disabled = selectedTileIndices.length !== desiredTileCount || !desiredTileCount;
    }

    function showLoadingScreen(total) {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading-screen';
      Object.assign(loadingDiv.style, {
        position: 'fixed', top: '0', left: '0',
        width: '100vw', height: '100vh',
        backgroundColor: 'rgba(0,0,0,0.8)',
        display: 'flex', flexDirection: 'column',
        justifyContent: 'center', alignItems: 'center',
        color: '#fff', fontSize: '24px', zIndex: '9999'
      });
      const indicator = document.createElement('div');
      indicator.id = 'loading-indicator';
      indicator.textContent = `Chargement... (0/${total})`;
      loadingDiv.appendChild(indicator);
      document.body.appendChild(loadingDiv);
      return { loadingDiv, indicator };
    }

    function hideLoadingScreen(loadingDiv) {
      if (loadingDiv && loadingDiv.parentNode) {
        loadingDiv.parentNode.removeChild(loadingDiv);
      }
    }

    function preloadVideos(videoUrls, indicator) {
      const nonYouTube = videoUrls.filter(url => !isYouTubeUrl(url));
      if (!nonYouTube.length) {
        indicator.textContent = `Chargement... (${videoUrls.length}/${videoUrls.length})`;
        return Promise.resolve();
      }
      let loadedCount = 0;
      return Promise.all(nonYouTube.map(url => new Promise(resolve => {
        const tempVid = document.createElement('video');
        tempVid.preload = 'auto';
        tempVid.src = url;
        const onComplete = () => {
          loadedCount++;
          indicator.textContent = `Chargement... (${loadedCount + (videoUrls.length - nonYouTube.length)}/${videoUrls.length})`;
          tempVid.removeEventListener('canplaythrough', onComplete);
          tempVid.removeEventListener('error', onComplete);
          resolve();
        };
        tempVid.addEventListener('canplaythrough', onComplete);
        tempVid.addEventListener('error', onComplete);
      }))).then(() => {
        indicator.textContent = `Chargement... (${videoUrls.length}/${videoUrls.length})`;
      });
    }

    function applyTileLayout(chosen) {
      tileContainer.classList.remove('flashcard-mode', 'this-or-that-mode', 'grid-2x2', 'two-tiles', 'tile-count-3', 'tile-count-5', 'tile-count-6');
      if (chosen.length === 1) {
        tileContainer.classList.add('flashcard-mode');
      } else if (chosen.length === 2) {
        tileContainer.classList.add('this-or-that-mode', 'two-tiles');
      } else if (chosen.length === 4) {
        tileContainer.classList.add('grid-2x2');
      } else {
        tileContainer.classList.add(`tile-count-${chosen.length}`);
      }
    }

    function renderChosenTiles() {
      tileContainer.innerHTML = '';
      const choices = getMediaChoices();
      const chosen = selectedTileIndices.map(i => choices[i]).filter(Boolean);
      applyTileLayout(chosen);
      chosen.forEach(choice => {
        const tile = document.createElement('div');
        tile.classList.add('tile');
        tile.style.backgroundImage = `url(${choice.image})`;
        const caption = document.createElement('div');
        caption.classList.add('caption');
        caption.textContent = choice.name;
        tile.appendChild(caption);
        tile.addEventListener('click', () => {
          if (choice && choice.video) {
            playVideo(choice.video);
          }
        });
        tileContainer.appendChild(tile);
      });
    }

    function handleVideoEnded() {
      if (currentVideoUrl) {
        clearResumePosition(currentVideoUrl);
      }
      videoPlaying = false;
      resetToTileScreen();
    }

    function stopYouTubePlayback() {
      if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') {
        try { youtubePlayer.stopVideo(); } catch (e) { console.error(e); }
      }
    }

    function pauseYouTubePlayback() {
      if (youtubePlayer && typeof youtubePlayer.pauseVideo === 'function') {
        try { youtubePlayer.pauseVideo(); } catch (e) { console.error(e); }
      }
    }

    function startYouTubePlayback(videoId, startSeconds) {
      if (!youtubePlayer || !youtubeReady) {
        pendingYouTubeStart = { videoId, startSeconds };
        return;
      }
      if (startSeconds && startSeconds > 0) {
        youtubePlayer.loadVideoById({ videoId, startSeconds });
      } else {
        youtubePlayer.loadVideoById(videoId);
      }
    }

    function playVideo(videoUrl) {
      resetInactivityTimer();
      videoPlaying = true;
      currentVideoUrl = videoUrl;
      tileContainer.style.display = 'none';
      tilePickerModal.style.display = 'none';
      gameOptionsModal.style.display = 'none';
      videoContainer.style.display = 'flex';
      const ytId = isYouTubeUrl(videoUrl) ? extractYouTubeId(videoUrl) : null;
      if (ytId) {
        videoPlayer.pause();
        videoPlayer.style.display = 'none';
        youtubeElement.style.display = 'block';
        const resumeTime = enableResumeVideoCheckbox && enableResumeVideoCheckbox.checked ? (videoResumePositions[videoUrl] || 0) : 0;
        startYouTubePlayback(ytId, resumeTime);
      } else {
        youtubeElement.style.display = 'none';
        videoPlayer.style.display = 'block';
        videoSource.src = videoUrl;
        videoPlayer.removeAttribute('controls');
        videoPlayer.load();
        videoPlayer.onloadedmetadata = () => {
          if (enableResumeVideoCheckbox && enableResumeVideoCheckbox.checked && videoResumePositions[videoUrl]) {
            videoPlayer.currentTime = videoResumePositions[videoUrl];
          }
          videoPlayer.play();
        };
      }
      if (document.fullscreenElement == null && document.webkitFullscreenElement == null) {
        const docEl = document.documentElement;
        if (docEl.requestFullscreen) {
          docEl.requestFullscreen().catch(() => {});
        } else if (docEl.webkitRequestFullscreen) {
          docEl.webkitRequestFullscreen();
        }
      }
      if (enableTimeLimitCheckbox && enableTimeLimitCheckbox.checked) {
        const limit = parseInt(timeLimitInput.value, 10) || 60;
        if (videoTimeLimitTimeout) clearTimeout(videoTimeLimitTimeout);
        videoTimeLimitTimeout = setTimeout(() => {
          if (videoPlaying) {
            rememberVideoPosition(videoUrl);
            if (ytId) {
              pauseYouTubePlayback();
            } else {
              videoPlayer.pause();
            }
            resetToTileScreen();
          }
        }, limit * 1000);
      }
    }

    function resetToTileScreen() {
      if (videoTimeLimitTimeout) {
        clearTimeout(videoTimeLimitTimeout);
        videoTimeLimitTimeout = null;
      }
      stopYouTubePlayback();
      videoPlayer.pause();
      videoPlayer.currentTime = 0;
      videoContainer.style.display = 'none';
      tileContainer.style.display = 'flex';
      videoPlaying = false;
      startInactivityTimer();
      if (document.fullscreenElement && document.exitFullscreen) {
        document.exitFullscreen().catch(() => {});
      } else if (document.webkitFullscreenElement && document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      tilePickerGrid = document.getElementById('tile-picker-grid');
      tileContainer = document.getElementById('tile-container');
      videoContainer = document.getElementById('video-container');
      videoPlayer = document.getElementById('video-player');
      videoSource = document.getElementById('video-source');
      youtubeElement = document.getElementById('youtube-player');

      gameOptionsModal = document.getElementById('game-options');
      tilePickerModal = document.getElementById('tile-picker-modal');
      tileCountInput = document.getElementById('tile-count');
      tileCountValue = document.getElementById('tile-count-value');
      chooseTilesButton = document.getElementById('choose-tiles-button');
      startGameButton = document.getElementById('start-game-button');
      tileCountDisplay = document.getElementById('tile-count-display');
      enableTimeLimitCheckbox = document.getElementById('enable-time-limit');
      timeLimitContainer = document.getElementById('time-limit-container');
      timeLimitInput = document.getElementById('time-limit-seconds');
      enableResumeVideoCheckbox = document.getElementById('enable-resume-video');
      resumeVideoContainer = document.getElementById('resume-video-container');

      tileCountInput.addEventListener('input', () => {
        tileCountValue.textContent = tileCountInput.value;
      });

      enableTimeLimitCheckbox.addEventListener('change', () => {
        if (enableTimeLimitCheckbox.checked) {
          timeLimitContainer.style.display = 'block';
          resumeVideoContainer.style.display = 'block';
        } else {
          timeLimitContainer.style.display = 'none';
          resumeVideoContainer.style.display = 'none';
          enableResumeVideoCheckbox.checked = false;
        }
      });

      chooseTilesButton.addEventListener('click', () => {
        desiredTileCount = parseInt(tileCountInput.value, 10) || 3;
        tileCountDisplay.textContent = desiredTileCount;
        selectedTileIndices = [];
        updateStartButtonState();
        gameOptionsModal.style.display = 'none';
        tilePickerModal.style.display = 'flex';
        populateTilePickerGrid();
        const docEl = document.documentElement;
        if (docEl.requestFullscreen) {
          docEl.requestFullscreen().catch(() => {});
        } else if (docEl.webkitRequestFullscreen) {
          docEl.webkitRequestFullscreen();
        }
      });

      startGameButton.addEventListener('click', () => {
        const choices = getMediaChoices();
        const urls = selectedTileIndices.map(i => choices[i]?.video).filter(Boolean);
        const { loadingDiv, indicator } = showLoadingScreen(urls.length);
        setTimeout(() => {
          preloadVideos(urls, indicator).then(() => {
            hideLoadingScreen(loadingDiv);
            tilePickerModal.style.display = 'none';
            renderChosenTiles();
            tileContainer.style.display = 'flex';
            startInactivityTimer();
          });
        }, 100);
      });

      videoPlayer.addEventListener('ended', handleVideoEnded);
      resetInactivityTimer();
    });

    window.onYouTubeIframeAPIReady = function() {
      youtubePlayer = new YT.Player('youtube-player', {
        height: '100%',
        width: '100%',
        playerVars: {
          autoplay: 1,
          controls: 0,
          modestbranding: 1,
          rel: 0,
          playsinline: 1
        },
        events: {
          onReady: (event) => {
            youtubeReady = true;
            if (pendingYouTubeStart) {
              const { videoId, startSeconds } = pendingYouTubeStart;
              pendingYouTubeStart = null;
              startYouTubePlayback(videoId, startSeconds);
            }
          },
          onStateChange: (event) => {
            if (event.data === YT.PlayerState.ENDED) {
              handleVideoEnded();
            }
          }
        }
      });
    };
  </script>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="../../js/config.js"></script>
  <script src="../../js/customYoutubeChoices.js"></script>
  <script src="../../js/translationonly.js"></script>
</body>
</html>
