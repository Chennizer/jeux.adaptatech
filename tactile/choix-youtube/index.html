<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activité de choix multiple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../../css/choix.css">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>

  <style>
    #tile-container.flashcard-mode .tile {
      width: 90vh !important;
      height: 90vh !important;
    }
    #tile-container.this-or-that-mode .tile {
      width: 60vh !important;
      height: 60vh !important;
    }
    #tile-container.grid-2x2 {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr);
      gap: 10vh;
      justify-items: center;
      align-items: center;
    }
    #tile-container.this-or-that-mode {
      gap: 30vh !important;
    }
  </style>
</head>
<body>
  <div id="game-options" class="modal">
    <div id="control-panel-options">
      <div id="options-title-bar">
        <h2 id="options-main-title" class="translate" data-fr="Activité de choix multiple (écran tactile)" data-en="Multiple Choice Activity (touchscreen)">
          Activité de choix multiple
        </h2>
      </div>
      <div id="mode-divider"></div>
      <div id="options-inline-container">
        <div id="advanced-options-section">
          <div class="advanced-options-container">
            <div class="option-item">
              <label for="enable-time-limit" class="teal-label">
                <input type="checkbox" id="enable-time-limit">
                <span class="translate" data-fr="Temps limite" data-en="Time Limit">Temps limite</span>
              </label>
            </div>
            <div id="time-limit-container" class="option-item" style="display: none;">
              <label for="time-limit-seconds" class="duration-label">
                <span class="translate" data-fr="Durée (sec):" data-en="Duration (sec):">Durée (sec):</span>
              </label>
              <input type="number" id="time-limit-seconds" min="1" value="30" class="styled-input-small">
            </div>
            <div id="resume-video-container" class="option-item" style="display: none;">
              <label for="enable-resume-video" class="teal-label">
                <input type="checkbox" id="enable-resume-video">
                <span class="translate" data-fr="Reprendre la vidéo" data-en="Resume Video">Reprendre la vidéo</span>
              </label>
            </div>
          </div>
        </div>
        <div id="game-options-controls">
          <div class="option-item" id="tile-slider-container">
            <label for="tile-count" class="control-label">
              <span class="translate" data-fr="Nombre de tuiles:" data-en="Number of Tiles:">Nombre de tuiles:</span>
              <span id="tile-count-value" class="slider-value no-translate">3</span>
            </label>
            <input type="range" id="tile-count" min="1" max="6" value="3" class="styled-slider">
          </div>
        </div>
        <div id="links-column">
          <a href="../../documentation/choix tactile/index.html" target="_blank" class="doc-link translate"
             data-fr="Instructions" data-en="Instructions">Instructions</a>
          <a href="../../documentation/pédagogie choix et scan/index.html" target="_blank" class="doc-link translate"
             data-fr="Pédagogie" data-en="Pedagogy">Pédagogie</a>
        </div>
      </div>
      <div id="mode-divider"></div>
      <button id="choose-tiles-button" class="button translate"
              data-fr="Choix des tuiles" data-en="Tile Selection">Choix des tuiles</button>
    </div>
  </div>

  <div id="tile-picker-modal" class="modal" style="display: none;">
    <div id="control-panel-options">
      <div id="control-panel-title-wrapper">
        <h2 id="control-panel-title" class="translate" data-fr="Choisir les tuiles" data-en="Choose the Tiles">
          Choisir les tuiles
        </h2>
      </div>
      <div id="control-panel-instructions">
        <span class="translate" data-fr="Choisir" data-en="Choose">Choisir</span>
        <span id="tile-count-display" class="no-translate"></span>
        <span class="translate" data-fr="tuiles." data-en="tiles.">tuiles.</span>
      </div>
      <div id="tile-picker-grid"></div>
      <div id="yt-import-controls">
        <div id="yt-input-row">
          <div class="actions-row">
            <input id="add-video-url-input" type="text" placeholder="URL" class="control-panel-input">
            <button id="add-video-url-button" class="button" data-fr="Ajouter URL" data-en="Add URL">Ajouter URL</button>
          </div>
          <div class="actions-row">
            <input id="yt-playlist-url-input" type="text" placeholder="URL de playlist (ex. https://www.youtube.com/playlist?list=...)" class="control-panel-input">
            <button id="yt-playlist-import-button" class="button" data-fr="Importer" data-en="Import">Importer</button>
          </div>
        </div>
        <div class="actions-row">
          <button id="clear-videos-button" class="button translate" data-fr="Tout effacer" data-en="Clear All">Tout effacer</button>
          <button id="start-game-button" class="button translate" data-fr="Commencer" data-en="Start" disabled>Commencer</button>
        </div>
      </div>
    </div>
  </div>

  <div id="tile-container" style="display: none;"></div>

  <div id="video-container" style="display: none;">
    <video id="video-player" autoplay>
      <source id="video-source" type="video/mp4" />
      <span class="translate" data-fr="Votre navigateur ne supporte pas la vidéo." data-en="Your browser does not support video.">
        Votre navigateur ne supporte pas la vidéo.
      </span>
    </video>
    <div id="youtube-player" style="display:none;width:100%;height:100%;pointer-events:none;"></div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="../../js/config.js"></script>
  <script src="../../js/customYoutubeChoices.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const gameOptionsModal = document.getElementById('game-options');
      const tilePickerModal  = document.getElementById('tile-picker-modal');
      const tileContainer    = document.getElementById('tile-container');
      const videoContainer   = document.getElementById('video-container');
      const videoPlayer      = document.getElementById('video-player');
      const videoSource      = document.getElementById('video-source');
      const youtubeDiv       = document.getElementById('youtube-player');

      const tileCountInput    = document.getElementById('tile-count');
      const tileCountValue    = document.getElementById('tile-count-value');
      const chooseTilesButton = document.getElementById('choose-tiles-button');
      const tilePickerGrid    = document.getElementById('tile-picker-grid');
      const tileCountDisplay  = document.getElementById('tile-count-display');
      const startGameButton   = document.getElementById('start-game-button');

      const enableTimeLimitCheckbox   = document.getElementById('enable-time-limit');
      const timeLimitContainer        = document.getElementById('time-limit-container');
      const timeLimitInput            = document.getElementById('time-limit-seconds');
      const resumeVideoContainer      = document.getElementById('resume-video-container');
      const enableResumeVideoCheckbox = document.getElementById('enable-resume-video');

      let desiredTileCount      = 3;
      let selectedTileIndices   = [];
      let videoPlaying          = false;
      let videoTimeLimitTimeout = null;
      let videoResumePositions  = {};
      let currentVideoUrl       = null;
      let youtubePlayer         = null;
      let youtubeStateHandler   = null;
      let loadingDiv            = null;

      document.addEventListener('keydown', event => {
        if (event.key === ' ' || event.code === 'Space' || event.key === 'Enter' || event.code === 'Enter') {
          event.preventDefault();
          event.stopImmediatePropagation();
        }
      }, true);

      function isYouTubeUrl(url) {
        return /^(https?:\/\/)?(www\.|m\.)?((youtube\.com\/)|(youtu\.be\/))/.test(url || '');
      }

      function getYouTubeId(url) {
        try {
          const parsed = new URL(url);
          if (parsed.hostname.includes('youtu.be')) {
            return parsed.pathname.slice(1);
          }
          const vid = parsed.searchParams.get('v');
          if (vid) return vid;
          const match = url.match(/\/embed\/([a-zA-Z0-9_-]+)/);
          return match ? match[1] : null;
        } catch {
          return null;
        }
      }

      let inactivityTimer = null;
      function clearInactivityTimer() {
        if (inactivityTimer) {
          clearTimeout(inactivityTimer);
          inactivityTimer = null;
        }
      }

      function startInactivityTimer() {
        clearInactivityTimer();
        inactivityTimer = setTimeout(() => {}, 30000);
      }

      function resetInactivityTimer() {
        if (!videoPlaying) {
          startInactivityTimer();
        }
      }

      startInactivityTimer();

      tileCountInput.addEventListener('input', () => {
        tileCountValue.textContent = tileCountInput.value;
      });

      enableTimeLimitCheckbox.addEventListener('change', () => {
        if (enableTimeLimitCheckbox.checked) {
          timeLimitContainer.style.display = 'block';
          resumeVideoContainer.style.display = 'block';
        } else {
          timeLimitContainer.style.display = 'none';
          resumeVideoContainer.style.display = 'none';
        }
      });

      chooseTilesButton.addEventListener('click', () => {
        desiredTileCount = parseInt(tileCountInput.value, 10) || 3;
        tileCountDisplay.textContent = desiredTileCount;
        selectedTileIndices = [];
        updateStartButtonState();
        gameOptionsModal.style.display = 'none';
        tilePickerModal.style.display = 'flex';
        populateTilePickerGrid();
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(err => console.warn(err));
        } else if (document.documentElement.webkitRequestFullscreen) {
          document.documentElement.webkitRequestFullscreen();
        }
      });

      function populateTilePickerGrid() {
        tilePickerGrid.innerHTML = '';
        if (!mediaChoices.length) {
          const emptyMessage = document.createElement('p');
          emptyMessage.textContent = 'Ajoutez des vidéos YouTube avec les boutons ci-dessous.';
          emptyMessage.classList.add('translate');
          emptyMessage.dataset.fr = "Ajoutez des vidéos YouTube avec les boutons ci-dessous.";
          emptyMessage.dataset.en = "Add YouTube videos with the buttons below.";
          tilePickerGrid.appendChild(emptyMessage);
          updateStartButtonState();
          return;
        }

        const availableContainer = document.createElement('div');
        availableContainer.style.display = 'flex';
        availableContainer.style.flexWrap = 'wrap';
        availableContainer.style.gap = '10px';

        const selectedContainer = document.createElement('div');
        selectedContainer.style.display = 'flex';
        selectedContainer.style.flexWrap = 'wrap';
        selectedContainer.style.gap = '10px';

        mediaChoices.forEach((choice, idx) => {
          const isSelected = selectedTileIndices.includes(idx);
          const tileOption = document.createElement('div');
          tileOption.classList.add('tile');
          tileOption.dataset.index = idx;
          tileOption.style.backgroundImage = `url(${choice.image})`;
          if (isSelected) {
            tileOption.classList.add('selected');
          }
          const caption = document.createElement('div');
          caption.classList.add('caption');
          caption.textContent = choice.name;
          tileOption.appendChild(caption);
          tileOption.addEventListener('click', () => {
            resetInactivityTimer();
            if (isSelected) {
              selectedTileIndices = selectedTileIndices.filter(i => i !== idx);
            } else if (selectedTileIndices.length < desiredTileCount) {
              selectedTileIndices.push(idx);
            }
            updateStartButtonState();
            populateTilePickerGrid();
          });
          if (isSelected) {
            selectedContainer.appendChild(tileOption);
          } else {
            availableContainer.appendChild(tileOption);
          }
        });

        tilePickerGrid.appendChild(availableContainer);
        if (selectedContainer.childNodes.length) {
          const separator = document.createElement('div');
          separator.style.width = '100%';
          separator.style.height = '2px';
          separator.style.backgroundColor = '#ccc';
          separator.style.margin = '10px 0';
          tilePickerGrid.appendChild(separator);
          tilePickerGrid.appendChild(selectedContainer);
        }
        updateStartButtonState();
      }

      window.populateTilePickerGrid = populateTilePickerGrid;

      function updateStartButtonState() {
        const hasEnough = selectedTileIndices.length === desiredTileCount && desiredTileCount > 0;
        startGameButton.disabled = !hasEnough;
      }

      startGameButton.addEventListener('click', () => {
        const chosenVideos = selectedTileIndices.map(i => mediaChoices[i].video);
        showLoadingScreen(chosenVideos.length)
          .then(() => preloadVideos(chosenVideos))
          .then(() => {
            hideLoadingScreen();
            tilePickerModal.style.display = 'none';
            renderChosenTiles();
            tileContainer.style.display = 'flex';
          });
      });

      function renderChosenTiles() {
        tileContainer.innerHTML = '';
        const chosen = selectedTileIndices.map(i => mediaChoices[i]);
        tileContainer.classList.remove('flashcard-mode', 'this-or-that-mode', 'grid-2x2', 'two-tiles', 'tile-count-3', 'tile-count-5', 'tile-count-6');
        if (chosen.length === 1) {
          tileContainer.classList.add('flashcard-mode');
        } else if (chosen.length === 2) {
          tileContainer.classList.add('this-or-that-mode', 'two-tiles');
        } else if (chosen.length === 4) {
          tileContainer.classList.add('grid-2x2');
        } else {
          tileContainer.classList.add(`tile-count-${chosen.length}`);
        }

        chosen.forEach(choice => {
          const tile = document.createElement('div');
          tile.classList.add('tile');
          tile.style.backgroundImage = `url(${choice.image})`;
          const caption = document.createElement('div');
          caption.classList.add('caption');
          caption.textContent = choice.name;
          tile.appendChild(caption);
          tile.addEventListener('click', () => {
            playVideo(choice.video);
          });
          tileContainer.appendChild(tile);
        });
      }

      function applyTimeLimit(videoUrl, pauseFn) {
        if (!enableTimeLimitCheckbox.checked) return;
        const limit = parseInt(timeLimitInput.value, 10) || 60;
        if (videoTimeLimitTimeout) clearTimeout(videoTimeLimitTimeout);
        videoTimeLimitTimeout = setTimeout(() => {
          if (videoPlaying) {
            if (enableResumeVideoCheckbox.checked) {
              videoResumePositions[videoUrl] = typeof pauseFn === 'function' ? pauseFn() : 0;
            } else {
              delete videoResumePositions[videoUrl];
            }
            resetToTileScreen();
          }
        }, limit * 1000);
      }

      function playVideo(videoUrl) {
        videoPlaying = true;
        currentVideoUrl = videoUrl;
        tileContainer.style.display = 'none';
        tilePickerModal.style.display = 'none';
        gameOptionsModal.style.display = 'none';
        videoContainer.style.display = 'flex';

        if (document.fullscreenElement !== videoContainer) {
          if (videoContainer.requestFullscreen) {
            videoContainer.requestFullscreen().catch(() => {});
          } else if (videoContainer.webkitRequestFullscreen) {
            videoContainer.webkitRequestFullscreen();
          }
        }

        if (isYouTubeUrl(videoUrl)) {
          if (youtubeDiv) youtubeDiv.style.display = 'block';
          videoPlayer.pause();
          videoPlayer.currentTime = 0;
          videoPlayer.style.display = 'none';
          const videoId = getYouTubeId(videoUrl);
          let pendingResume = enableResumeVideoCheckbox.checked ? (videoResumePositions[videoUrl] ?? null) : null;

          const onReady = (player) => {
            if (pendingResume != null) {
              player.loadVideoById({ videoId, startSeconds: pendingResume });
              pendingResume = null;
            } else {
              player.loadVideoById(videoId);
            }
            player.playVideo();
          };

          const onStateChange = (event) => {
            if (event.data === YT.PlayerState.PLAYING && pendingResume != null) {
              event.target.seekTo(pendingResume, true);
              pendingResume = null;
            }
            if (event.data === YT.PlayerState.ENDED) {
              delete videoResumePositions[videoUrl];
              videoPlaying = false;
              resetToTileScreen();
            }
          };

          if (!youtubePlayer) {
            youtubePlayer = new YT.Player('youtube-player', {
              host: 'https://www.youtube-nocookie.com',
              videoId,
              playerVars: { rel: 0, modestbranding: 1, controls: 0 },
              events: {
                onReady: (event) => onReady(event.target),
                onStateChange
              }
            });
          } else {
            if (youtubeStateHandler) {
              try { youtubePlayer.removeEventListener('onStateChange', youtubeStateHandler); } catch {}
            }
            youtubeStateHandler = onStateChange;
            try { youtubePlayer.addEventListener('onStateChange', youtubeStateHandler); } catch {}
            if (pendingResume != null) {
              youtubePlayer.loadVideoById({ videoId, startSeconds: pendingResume });
              pendingResume = null;
            } else {
              youtubePlayer.loadVideoById(videoId);
            }
            youtubePlayer.playVideo();
          }

          applyTimeLimit(videoUrl, () => {
            if (youtubePlayer && typeof youtubePlayer.getCurrentTime === 'function') {
              const t = youtubePlayer.getCurrentTime();
              try { youtubePlayer.pauseVideo(); } catch {}
              return t;
            }
            return 0;
          });
        } else {
          if (youtubeDiv) youtubeDiv.style.display = 'none';
          videoPlayer.style.display = 'block';
          videoSource.src = videoUrl;
          videoPlayer.removeAttribute('controls');
          videoPlayer.load();
          videoPlayer.onloadedmetadata = () => {
            if (enableResumeVideoCheckbox.checked && videoResumePositions[videoUrl]) {
              videoPlayer.currentTime = videoResumePositions[videoUrl];
            }
            videoPlayer.play();
          };
          applyTimeLimit(videoUrl, () => {
            videoPlayer.pause();
            return videoPlayer.currentTime;
          });
        }
      }

      videoPlayer.addEventListener('ended', () => {
        if (currentVideoUrl && !isYouTubeUrl(currentVideoUrl)) {
          delete videoResumePositions[currentVideoUrl];
        }
        videoPlaying = false;
        resetToTileScreen();
      });

      function resetToTileScreen() {
        if (videoTimeLimitTimeout) {
          clearTimeout(videoTimeLimitTimeout);
          videoTimeLimitTimeout = null;
        }
        if (isYouTubeUrl(currentVideoUrl)) {
          if (enableResumeVideoCheckbox.checked && youtubePlayer && typeof youtubePlayer.getCurrentTime === 'function') {
            videoResumePositions[currentVideoUrl] = youtubePlayer.getCurrentTime();
          }
          try { youtubePlayer.stopVideo(); } catch {}
          if (youtubeDiv) youtubeDiv.style.display = 'none';
        } else {
          videoPlayer.pause();
          if (enableResumeVideoCheckbox.checked) {
            videoResumePositions[currentVideoUrl] = videoPlayer.currentTime;
          }
          videoPlayer.currentTime = 0;
        }
        videoPlaying = false;
        currentVideoUrl = null;
        videoContainer.style.display = 'none';
        tileContainer.style.display = 'flex';
        if (document.fullscreenElement) {
          document.exitFullscreen().catch(() => {});
        } else if (document.webkitFullscreenElement) {
          document.webkitExitFullscreen();
        }
      }

      function showLoadingScreen(totalCount) {
        return new Promise(resolve => {
          loadingDiv = document.createElement('div');
          loadingDiv.id = 'loading-screen';
          Object.assign(loadingDiv.style, {
            position: 'fixed', top: '0', left: '0',
            width: '100vw', height: '100vh',
            backgroundColor: 'rgba(0,0,0,0.8)',
            display: 'flex', flexDirection: 'column',
            justifyContent: 'center', alignItems: 'center',
            color: '#fff', fontSize: '24px', zIndex: '9999'
          });
          const indicator = document.createElement('div');
          indicator.id = 'loading-indicator';
          indicator.textContent = `Chargement... (0 / ${totalCount})`;
          loadingDiv.appendChild(indicator);
          document.body.appendChild(loadingDiv);
          setTimeout(resolve, 100);
        });
      }

      function hideLoadingScreen() {
        if (loadingDiv) {
          document.body.removeChild(loadingDiv);
          loadingDiv = null;
        }
      }

      function preloadVideos(videoUrls) {
        return new Promise(resolve => {
          if (!videoUrls.length) {
            resolve();
            return;
          }
          let loadedCount = 0;
          const totalCount = videoUrls.length;
          const indicator = document.getElementById('loading-indicator');
          const markLoaded = () => {
            loadedCount++;
            if (indicator) {
              indicator.textContent = `Chargement... (${loadedCount}/${totalCount})`;
            }
            if (loadedCount >= totalCount) {
              resolve();
            }
          };

          videoUrls.forEach(url => {
            if (isYouTubeUrl(url)) {
              markLoaded();
              return;
            }
            const tempVid = document.createElement('video');
            tempVid.preload = 'auto';
            tempVid.src = url;
            tempVid.addEventListener('canplaythrough', markLoaded, { once: true });
            tempVid.addEventListener('error', () => {
              console.error('Error preloading video:', url);
              markLoaded();
            }, { once: true });
          });
        });
      }

      if (typeof mediaChoices !== 'undefined' && mediaChoices.length) {
        populateTilePickerGrid();
      }
    });
  </script>

  <script src="../../js/translationonly.js"></script>
</body>
</html>
