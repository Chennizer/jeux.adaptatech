<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planet Protector</title>
  <link rel="stylesheet" href="../../css/games.css">
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    #gameArea {
      position:relative; width:100vw; height:100vh; display:none;
    }
    .asteroid {
      position:absolute;
      top:-60px;
      width:60px; height:60px;
      background:#666;
      border-radius:50%;
      animation: fall linear 6s forwards;
    }
    .asteroid.destroyed {
      background:red;
      animation:none;
      transform:scale(0);
      transition:transform 0.3s ease;
    }
    @keyframes fall {
      from { top:-60px; }
      to { top:100vh; }
    }
    #scoreboard, #livesboard {
      position:fixed; top:10px; color:#fff; font-size:20px; display:none;
      z-index:1000;
    }
    #scoreboard { left:10px; }
    #livesboard { right:10px; }
  </style>
</head>
<body>
  <div id="menu-placeholder"></div>
  <div id="scoreboard">Score: <span id="score">0</span></div>
  <div id="livesboard">Vies: <span id="lives">3</span></div>
  <div id="gameArea"></div>

  <script src="../../js/eyegaze-menu.js"></script>
  <script src="../../js/eyegazeMenuLoader.js"></script>
  <script>
    loadEyegazeMenu({ title: "Planet Protector" }).then(() => {
      initEyegazeMenu();
      document.getElementById('startButton').addEventListener('click', startGame);
    });

    let spawnInterval;
    let lives = 3;
    let score = 0;
    const dwellTimers = new Map();

    function startGame() {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      }
      const gameArea = document.getElementById('gameArea');
      gameArea.style.display = 'block';
      document.getElementById('scoreboard').style.display = 'block';
      document.getElementById('livesboard').style.display = 'block';
      eyegazeSettings.hideOverlay();
      spawnInterval = setInterval(spawnAsteroid, 1500);
    }

    function spawnAsteroid() {
      const gameArea = document.getElementById('gameArea');
      const a = document.createElement('div');
      a.className = 'asteroid';
      a.style.left = Math.random() * (window.innerWidth - 60) + 'px';
      gameArea.appendChild(a);
      a.addEventListener('mouseover', () => startDwell(a));
      a.addEventListener('mouseout', () => cancelDwell(a));
      a.addEventListener('animationend', () => { a.remove(); loseLife(); });
    }

    function startDwell(el) {
      if (dwellTimers.has(el)) return;
      const timer = setTimeout(() => destroyAsteroid(el), eyegazeSettings.dwellTime);
      dwellTimers.set(el, timer);
    }

    function cancelDwell(el) {
      const t = dwellTimers.get(el);
      if (t) { clearTimeout(t); dwellTimers.delete(el); }
    }

    function destroyAsteroid(el) {
      cancelDwell(el);
      el.classList.add('destroyed');
      setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 300);
      score++;
      document.getElementById('score').textContent = score;
    }

    function loseLife() {
      lives--;
      document.getElementById('lives').textContent = lives;
      if (lives <= 0) endGame();
    }

    function endGame() {
      clearInterval(spawnInterval);
      alert('Game over! Score: ' + score);
      location.reload();
    }
  </script>
</body>
</html>
