<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title class="translate" data-fr="Peinture (Eyegaze)" data-en="Paint (Eyegaze)">Peinture (Eyegaze)</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root{
      --ui-scale: 1;

      /* Sidebar sizing */
      --sidebar-w: clamp(96px, calc(120px * var(--ui-scale)), 180px);
      --sidebar-pad-x: clamp(8px, calc(12px * var(--ui-scale)), 16px);
      --sidebar-pad-y: clamp(8px, calc(12px * var(--ui-scale)), 16px);

      /* Swatches (JS adjusts to fit) */
      --swatch-size: 84px;
      --swatch-gap: 12px;
      --swatch-border: clamp(3px, calc(5px * var(--ui-scale)), 6px);
      --swatch-outline: clamp(3px, calc(5px * var(--ui-scale)), 6px);

      /* Brushes + Save */
      --brush-btn: clamp(36px, calc(44px * var(--ui-scale)), 56px);
      --brush-dot-s: clamp(6px,  calc(8px * var(--ui-scale)),  10px);
      --brush-dot-m: clamp(12px, calc(16px * var(--ui-scale)), 20px);
      --brush-dot-l: clamp(22px, calc(28px * var(--ui-scale)), 34px);
      --brush-gap: clamp(8px, calc(12px * var(--ui-scale)), 16px);

      --save-btn: clamp(36px, calc(44px * var(--ui-scale)), 56px);
      --save-radius: clamp(8px, calc(10px * var(--ui-scale)), 12px);

      /* Cursor preview */
      --cursor-outline: clamp(1px, calc(2px * var(--ui-scale)), 3px);

      /* Palette constraints */
      --swatch-min: 18px;
      --swatch-max: 96px;
      --palette-cols: 1;

      /* Dwell tint */
      --dwell-red: rgba(255, 64, 64, 0.48);
    }

    body.light { background-color: #fff; color: #000; }
    body.dark  { background-color: #000; color: #fff; }

    #langToggle{
      position: fixed; top: 10px; right: 10px; z-index: 99999;
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 10px; border: 2px solid #009688;
      background: #fff; color: #009688; font-weight: 700; cursor: pointer; user-select: none;
    }
    body.dark #langToggle { background:#111; color:#14b8a6; border-color:#14b8a6; }

    .game-container { width: 100%; height: 100%; display: none; }

    canvas#c { position: fixed; inset: 0; cursor: none; } /* custom preview cursor */

    #sidebar{
      position: fixed; left: 0; top: 0; bottom: 0; z-index: 20;
      width: var(--sidebar-w);
      display: flex; flex-direction: column;
      padding: var(--sidebar-pad-y) var(--sidebar-pad-x);
      gap: clamp(12px, calc(14px * var(--ui-scale)), 18px);
      background: #fff; border-right: 1px solid #e6e6e6;
      box-shadow: 0 0 18px rgba(0,0,0,.05);
      box-sizing: border-box;
    }
    body.dark #sidebar{ background:#0b0b0b; border-right-color:#1e1e1e; }

    #palette{
      flex: 1;
      display: grid;
      grid-template-columns: repeat(var(--palette-cols, 1), var(--swatch-size));
      grid-auto-rows: var(--swatch-size);
      justify-content: center;
      align-content: start;
      gap: var(--swatch-gap);
      overflow: hidden;       /* no scrollbars */
      box-sizing: border-box;
    }

    .swatch{
      width: var(--swatch-size); height: var(--swatch-size);
      border-radius: 50%;
      border: var(--swatch-border) solid #ffffff;
      box-shadow: 0 1px 6px rgba(0,0,0,.22) inset, 0 3px 10px rgba(0,0,0,.12);
      transition: transform .12s ease;
      position: relative;
      flex: 0 0 auto;
      overflow: hidden; /* keep dwell clipped to the circle */
      box-sizing: border-box;
    }

    /* Internal selection ring that never clips */
    .swatch.active{ transform: scale(1.03); }
    .swatch.active::before{
      content:"";
      position:absolute;
      inset: calc(var(--swatch-outline) + 2px);
      border: var(--swatch-outline) solid #111;
      border-radius: 50%;
      pointer-events:none;
      z-index: 2; /* above dwell */
      box-sizing: border-box;
    }
    body.dark .swatch.active::before{ border-color:#e5e5e5; }
    body.dark .swatch{ border-color:#171717; }

    /* Dwell overlay (below ring) */
    .swatch .dwell{
      position: absolute;
      left: 50%; top: 50%;
      width: 100%; height: 100%;
      transform: translate(-50%, -50%) scale(0.08); /* tiny dot */
      transform-origin: center center;
      pointer-events: none;
      border-radius: 50%;
      background-color: var(--dwell-red);
      will-change: transform;
      z-index: 1;
    }

    @keyframes dwellGrow{
      from { transform: translate(-50%, -50%) scale(0.08); }
      to   { transform: translate(-50%, -50%) scale(1.02); } /* slight overshoot to ensure full cover */
    }

    .flash::after{
      content:""; position:absolute; left:50%; top:50%;
      width:100%; height:100%; transform:translate(-50%,-50%) scale(1);
      border-radius:50%;
      box-shadow: 0 0 0 0 rgba(17,17,17,0.35);
      animation: ringPulse 420ms ease-out;
      pointer-events:none;
    }
    @keyframes ringPulse{
      0%   { box-shadow: 0 0 0 0 rgba(17,17,17,0.35); transform:translate(-50%,-50%) scale(1.0); }
      60%  { box-shadow: 0 0 0 18px rgba(17,17,17,0.0); transform:translate(-50%,-50%) scale(1.08); }
      100% { box-shadow: 0 0 0 24px rgba(17,17,17,0.0); transform:translate(-50%,-50%) scale(1.0); }
    }

    #brushSizes{
      display: flex; flex-direction: column; align-items: center;
      gap: var(--brush-gap); margin-top: 4px;
    }
    .brushBtn{
      width: var(--brush-btn); height: var(--brush-btn);
      border-radius: 50%;
      border: 2px solid #aaa; background: #f8f8f8;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,.1) inset;
      transition: transform .12s ease, background-color .12s ease;
      position: relative;
    }
    .brushBtn span{ display: block; border-radius: 50%; background: #333; }
    .brushBtn.small  span{ width: var(--brush-dot-s); height: var(--brush-dot-s); }
    .brushBtn.medium span{ width: var(--brush-dot-m); height: var(--brush-dot-m); }
    .brushBtn.large  span{ width: var(--brush-dot-l); height: var(--brush-dot-l); }
    .brushBtn.active{ border-color:#333; transform: scale(1.08); background:#ececec; }
    body.dark .brushBtn{ background:#161616; border-color:#333; }
    body.dark .brushBtn span{ background:#ddd; }
    body.dark .brushBtn.active{ background:#1e1e1e; }

    #saveBtn{
      appearance: none; border: 1px solid #ddd; background: #fafafa;
      width: var(--save-btn); height: var(--save-btn);
      border-radius: var(--save-radius); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font: clamp(14px, calc(18px * var(--ui-scale)), 22px)/1 system-ui, Arial;
      margin-top: 2px;
    }
    #saveBtn:hover{ background:#f2f2f2; }
    body.dark #saveBtn{ background:#121212; border-color:#2a2a2a; color:#eaeaea; }
    body.dark #saveBtn:hover{ background:#171717; }

    #cursorPreview{
      position: fixed; left: 0; top: 0; width: 20px; height: 20px; border-radius: 50%;
      pointer-events: none; z-index: 15; mix-blend-mode: multiply;
      transform: translate(-50%,-50%); opacity: .65;
      outline: var(--cursor-outline) solid rgba(0,0,0,.18);
    }
    .cursor-pop{ animation: cursorPop 260ms ease-out; }
    @keyframes cursorPop{
      0%   { transform: translate(-50%,-50%) scale(1.00); outline-width: var(--cursor-outline); }
      60%  { transform: translate(-50%,-50%) scale(1.14); outline-width: calc(var(--cursor-outline) * 2.2); }
      100% { transform: translate(-50%,-50%) scale(1.00); outline-width: var(--cursor-outline); }
    }

    #selectPulse{
      position: fixed; left: 0; top: 0; pointer-events: none; z-index: 14;
      width: 22px; height: 22px; border-radius: 50%;
      transform: translate(-50%,-50%) scale(1);
      opacity: 0; border: 4px solid transparent;
    }
    .pulse-show{ animation: pulseExpand 420ms ease-out; }
    @keyframes pulseExpand{
      0%   { opacity: .8; transform: translate(-50%,-50%) scale(1.0); }
      70%  { opacity: .25; transform: translate(-50%,-50%) scale(2.8); }
      100% { opacity: 0;  transform: translate(-50%,-50%) scale(3.2); }
    }
  </style>
</head>
<!-- DEFAULT THEME = LIGHT -->
<body class="light">
<button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

<!-- ===== Start Menu ===== -->
<div id="game-options" class="modal">
  <div id="options-title-bar">
    <h2 id="options-main-title" class="translate"
        data-fr="Peinture (Eyegaze)" data-en="Paint (Eyegaze)">Peinture (Eyegaze)</h2>
  </div>

  <div id="control-panel-options">
    <div id="mode-divider"></div>

    <div id="options-inline-container">
      <!-- Column 1 -->
      <div class="options-column">
        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="muteSFX">
            <span class="translate" data-fr="DÃ©sactiver les sons (SFX)" data-en="Disable sounds (SFX)">DÃ©sactiver les sons (SFX)</span>
          </label>
        </div>
        <div class="option-item">
          <label for="sfxVol" class="teal-label">
            <span class="translate" data-fr="Volume des sons:" data-en="Sound volume:">Volume des sons:</span>
            <span id="sfxVolVal">50</span>
          </label>
          <input type="range" id="sfxVol" class="styled-slider" min="0" max="100" value="50">
        </div>
      </div>

      <!-- Column 2 -->
      <div class="options-column">
        <div class="option-item">
          <label for="themeSelect" class="teal-label label-block translate" data-fr="Mode" data-en="Theme">Mode</label>
          <select id="themeSelect" class="styled-select">
            <option value="light" selected class="translate" data-fr="Clair" data-en="Light">Clair</option>
            <option value="dark"  class="translate" data-fr="Sombre" data-en="Dark">Sombre</option>
          </select>
        </div>
      </div>

      <!-- Column 3 (palette size) -->
      <div class="options-column">
        <div class="option-item">
          <label for="paletteSizeSelect" class="teal-label label-block translate"
                 data-fr="Nombre de couleurs" data-en="Number of colors">Nombre de couleurs</label>
          <select id="paletteSizeSelect" class="styled-select">
            <option value="4"  class="translate" data-fr="4 couleurs"  data-en="4 colors">4 couleurs</option>
            <option value="7"  selected class="translate" data-fr="7 couleurs"  data-en="7 colors">7 couleurs</option>
            <option value="13" class="translate" data-fr="13 couleurs" data-en="13 colors">13 couleurs</option>
          </select>
        </div>
      </div>
    </div>

    <div id="mode-divider"></div>
    <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start">Commencer</button>
  </div>
</div>

<!-- ===== Painting App (shown after Start) ===== -->
<div class="game-container" id="paintGame">
  <aside id="sidebar">
    <div id="palette"><!-- swatches injected dynamically --></div>

    <div id="brushSizes">
      <div class="brushBtn small"  data-size="small"  title="Petit / Small"><span></span></div>
      <div class="brushBtn medium active" data-size="medium" title="Moyen / Medium"><span></span></div>
      <div class="brushBtn large"  data-size="large"  title="Grand / Large"><span></span></div>
    </div>

    <button id="saveBtn" type="button" aria-label="Enregistrer PNG" title="Enregistrer PNG">ðŸ’¾</button>
  </aside>

  <canvas id="c" aria-label="drawing canvas"></canvas>
  <div id="cursorPreview" aria-hidden="true"></div>
  <div id="selectPulse" aria-hidden="true"></div>
</div>

<script>
/* === Language toggle === */
const LS_LANG_KEY = 'siteLanguage';
const LS_PALETTE_KEY = 'paint_palette_size';
const langToggle  = document.getElementById('langToggle');
function getLang(){ try{const s=localStorage.getItem(LS_LANG_KEY); if(s==='en'||s==='fr') return s;}catch(e){} return (document.documentElement.lang==='en')?'en':'fr'; }
function setLang(lang){
  const safe=(lang==='en')?'en':'fr';
  document.documentElement.lang=safe;
  try{localStorage.setItem(LS_LANG_KEY,safe);}catch(e){}
  document.querySelectorAll('.translate').forEach(el=>{
    const fr=el.getAttribute('data-fr'); const en=el.getAttribute('data-en');
    if (safe==='fr' && fr!=null) el.textContent=fr;
    if (safe==='en' && en!=null) el.textContent=en;
  });
}
(function initLang(){
  let initial='fr';
  try{
    const saved=localStorage.getItem(LS_LANG_KEY);
    initial=(saved==='en'||saved==='fr')?saved:(document.documentElement.lang==='en'?'en':'fr');
    localStorage.setItem(LS_LANG_KEY,initial);
  }catch(e){
    initial=(document.documentElement.lang==='en'?'en':'fr');
  }
  setLang(initial);
})();
langToggle.addEventListener('click', ()=> setLang(getLang()==='fr'?'en':'fr'));

/* === Theme & palette === */
const themeSelect   = document.getElementById('themeSelect');
const paletteSizeSelect = document.getElementById('paletteSizeSelect');
function isDark(){ return document.body.classList.contains('dark'); }
function applyTheme(theme){
  document.body.classList.remove('light','dark');
  document.body.classList.add(theme==='dark'?'dark':'light');
}

/* Persist / init palette size */
(function initPaletteSize(){
  try{
    const saved = localStorage.getItem(LS_PALETTE_KEY);
    if(saved==='4'||saved==='7'||saved==='13'){
      paletteSizeSelect.value = saved;
    }
  }catch(e){}
})();
paletteSizeSelect.addEventListener('change', ()=>{
  try{ localStorage.setItem(LS_PALETTE_KEY, paletteSizeSelect.value); }catch(e){}
  if (document.getElementById('paintGame').style.display === 'block') {
    buildPalette(parseInt(paletteSizeSelect.value,10));
  }
});

/* === UI scale (responsive) === */
function updateUiScale(){
  const vmin = Math.min(window.innerWidth, window.innerHeight);
  const scale = Math.min(1.6, Math.max(0.70, vmin / 900));
  document.documentElement.style.setProperty('--ui-scale', scale.toFixed(3));
}
updateUiScale();
addEventListener('resize', updateUiScale, {passive:true});

/* Start */
const startButton = document.getElementById('startButton');
const gameOptions = document.getElementById('game-options');
const gameArea    = document.getElementById('paintGame');

async function enterFullscreen(){
  const el=document.documentElement;
  try{
    if(el.requestFullscreen) await el.requestFullscreen();
    else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    else if(el.msRequestFullscreen) await el.msRequestFullscreen();
  }catch(e){}
}

/* === Background music (auto-starts on begin) === */
const MUSIC_TRACKS = [
  "../../songs/artgallery1.mp3",
  "../../songs/artgallery2.mp3"
];
let musicIdx = 0;
let musicAudio = null;
function playNextTrack(){
  if (musicAudio){
    musicAudio.onended = null;
    try { musicAudio.pause(); } catch(e){}
  }
  musicAudio = new Audio(MUSIC_TRACKS[musicIdx]);
  musicAudio.volume = 0.5;
  musicAudio.loop = false;
  musicAudio.play().catch(()=>{ /* ignore autoplay issues */ });
  musicAudio.onended = ()=>{
    musicIdx = (musicIdx + 1) % MUSIC_TRACKS.length;
    playNextTrack();
  };
}

startButton.addEventListener('click', async ()=>{
  applyTheme(themeSelect.value);                  // apply chosen theme
  await enterFullscreen();
  gameOptions.style.display='none';
  langToggle.style.display='none';
  gameArea.style.display='block';
  playNextTrack(); // user gesture allows playback
  setTimeout(()=> {
    resize({preserve:false});                    // create fresh canvas bg for theme
    buildPalette(parseInt(paletteSizeSelect.value,10) || 7);
  }, 50);
});

/* === Painting logic === */
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});

/* Helper: theme-based canvas background */
function canvasBgColor(){ return isDark() ? '#000000' : '#ffffff'; }

/* PRESERVING, HiDPI-safe resize */
function resize({preserve=true}={}){
  const dpr=Math.max(1,window.devicePixelRatio||1);

  let snapshot=null;
  if(preserve&&canvas.width&&canvas.height){
    snapshot=document.createElement('canvas');
    snapshot.width=canvas.width; snapshot.height=canvas.height;
    snapshot.getContext('2d').drawImage(canvas,0,0);
  }

  const cssW=innerWidth, cssH=innerHeight;
  canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
  canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  ctx.fillStyle=canvasBgColor(); ctx.fillRect(0,0,cssW,cssH);

  if(snapshot){
    const prev=ctx.imageSmoothingEnabled;
    ctx.imageSmoothingEnabled=true;
    ctx.drawImage(snapshot,0,0,snapshot.width,snapshot.height,0,0,cssW,cssH);
    ctx.imageSmoothingEnabled=prev;
  }
}
addEventListener('resize',()=>{ resize({preserve:true}); layoutPalette(); },{passive:true});
['fullscreenchange','webkitfullscreenchange','msfullscreenchange']
  .forEach(evt=>document.addEventListener(evt,()=>{ resize({preserve:true}); layoutPalette(); }));
resize({preserve:false});

/* State */
let last=null,smoothW=2,currentColor="#000000",sizeMode="medium";
const cursorEl=document.getElementById('cursorPreview');
const pulseEl = document.getElementById('selectPulse');
const sidebar = document.getElementById('sidebar');
const paletteEl = document.getElementById('palette');
const brushBox = document.getElementById('brushSizes');
const saveBtn  = document.getElementById('saveBtn');
const sidebarW=()=>sidebar.getBoundingClientRect().width;

/* Simple SFX volume */
const muteSFX = document.getElementById('muteSFX');
const sfxVol  = document.getElementById('sfxVol');
const sfxVolVal = document.getElementById('sfxVolVal');
sfxVol.addEventListener('input', ()=> sfxVolVal.textContent = sfxVol.value);
function playClick(){
  if (muteSFX?.checked) return;
  try{
    const ctxA = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctxA.createOscillator(); const g = ctxA.createGain();
    o.type='triangle'; o.frequency.value=660;
    g.gain.value = (parseInt(sfxVol.value,10)||50)/800;
    o.connect(g); g.connect(ctxA.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctxA.close(); }, 90);
  }catch(e){}
}

/* Inverse speed â†’ width (slow = thicker) with size modes */
function widthFromSpeed(speed){
  let minW,maxW;
  if(sizeMode==="small"){minW=2;maxW=20;}
  else if(sizeMode==="medium"){minW=6;maxW=36;}
  else{minW=12;maxW=52;}
  const s=Math.min(speed/1.8,1);
  const ease=k=>k*k*(3-2*k); const inv=1-ease(s);
  return minW+(maxW-minW)*inv;
}
function stroke(a,b,w,color){
  ctx.strokeStyle=color; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=w;
  ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
}
function updateCursor(x,y,w){
  if(x<sidebarW()){cursorEl.style.opacity=0;return;}
  cursorEl.style.opacity=.65;
  cursorEl.style.left=x+'px'; cursorEl.style.top=y+'px';
  const d=Math.max(12,w); cursorEl.style.width=d+'px'; cursorEl.style.height=d+'px';
  cursorEl.style.background=currentColor;
}

/* Pointer drawing */
function handleMove(x,y){
  if(x<sidebarW()){last=null;updateCursor(x,y,16);return;}
  const t=performance.now();
  if(!last){last={x,y,t};updateCursor(x,y,16);return;}
  const dx=x-last.x, dy=y-last.y, dt=Math.max(1,t-last.t);
  const speed=Math.hypot(dx,dy)/dt;
  const targetW=widthFromSpeed(speed);
  smoothW=smoothW*0.82+targetW*0.18;
  stroke(last,{x,y},smoothW,currentColor);
  updateCursor(x,y,smoothW);
  last={x,y,t};
}
canvas.addEventListener('mousemove',e=>handleMove(e.clientX,e.clientY),{passive:true});
canvas.addEventListener('mouseleave',()=>{last=null;cursorEl.style.opacity=0;},{passive:true});
canvas.addEventListener('mouseenter',e=>{last={x:e.clientX,y:e.clientY,t:performance.now()};updateCursor(e.clientX,e.clientY,16);},{passive:true});
canvas.addEventListener('touchmove',e=>{const t=e.touches[0]; if(t) handleMove(t.clientX,t.clientY);},{passive:true});
canvas.addEventListener('touchend',()=>{last=null;},{passive:true});

/* Visual feedback helpers */
function flashEl(el){
  el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash');
  setTimeout(()=> el.classList.remove('flash'), 460);
}
function popCursor(){
  cursorEl.classList.remove('cursor-pop'); void cursorEl.offsetWidth; cursorEl.classList.add('cursor-pop');
  setTimeout(()=> cursorEl.classList.remove('cursor-pop'), 300);
}
function pulseAt(x,y,color){
  pulseEl.style.left = x + 'px';
  pulseEl.style.top  = y + 'px';
  pulseEl.style.borderColor = color || 'rgba(0,0,0,.35)';
  pulseEl.classList.remove('pulse-show'); void pulseEl.offsetWidth; pulseEl.classList.add('pulse-show');
  setTimeout(()=> pulseEl.classList.remove('pulse-show'), 460);
}

/* ===== Dynamic palette building ===== */
const PALETTE_13 = [
  "#FF6B6B", "#F94144",
  "#FFD166", "#F9C74F",
  "#06D6A0", "#90BE6D", "#43AA8B",
  "#118AB2", "#3A86FF",
  "#9B59B6", "#8338EC",
  "#FF9F1C"
];

/* First swatch depends on theme: black on light, white on dark */
function frontColor(){ return isDark() ? "#FFFFFF" : "#000000"; }

function pickColors(n){
  const tail = (n>=13) ? PALETTE_13.slice(0,12) : // we'll add front color first
               (n===7 ? ["#FF6B6B","#FFD166","#06D6A0","#118AB2","#9B59B6","#FF9F1C"]
                      : ["#FF6B6B","#06D6A0","#3A86FF"]);
  const head = [frontColor()];
  const list = head.concat(tail).slice(0,n);
  return list;
}

/* === Color selection === */
function setColor(el, eventLike){
  document.querySelectorAll('.swatch').forEach(s=>s.classList.toggle('active',s===el));
  currentColor = el?.dataset?.color || frontColor();
  cursorEl.style.background = currentColor;
  const dw = el.querySelector('.dwell'); if (dw) dw.remove();
  flashEl(el);
  popCursor();
  const x = (eventLike?.clientX) ?? (window.innerWidth/2);
  const y = (eventLike?.clientY) ?? (window.innerHeight/2);
  pulseAt(x,y,currentColor);
  playClick();
}

function clearPalette(){
  while(paletteEl.firstChild) paletteEl.removeChild(paletteEl.firstChild);
}

function buildPalette(n){
  clearPalette();
  const colors = pickColors(n);
  colors.forEach(col=>{
    const btn = document.createElement('button');
    btn.className = 'swatch';
    btn.style.background = col;
    btn.dataset.color = col;
    paletteEl.appendChild(btn);
  });
  wireSwatches();
  const first = document.querySelector('.swatch');
  if(first) setColor(first);
  layoutPalette();
}

/* ===== Dwell indicator (keyframed grow 0.08 â†’ 1.02) ===== */
const HOVER_DWELL_MS = 650;   // progressive & readable
const HOVER_MOVE_PX  = 12;    // movement guard

function startDwellCircle(sw, durationMs){
  let overlay = sw.querySelector('.dwell');
  if(!overlay){
    overlay = document.createElement('div');
    overlay.className = 'dwell';
    sw.appendChild(overlay);
  }
  overlay.style.animation = 'none';
  overlay.style.transform = 'translate(-50%, -50%) scale(0.08)';
  void overlay.offsetWidth; // restart anim
  overlay.style.animation = `dwellGrow ${durationMs}ms linear forwards`;
  return overlay;
}
function resetDwellCircle(sw){
  const overlay = sw.querySelector('.dwell');
  if(overlay) overlay.remove();
}

/* ===== Swatch interactions with dwell + indicator ===== */
function wireSwatches(){
  const swatches = document.querySelectorAll('.swatch');

  swatches.forEach(s=>{
    let timer = null;
    let enterX = 0, enterY = 0;

    const clearTimer = ()=>{ if(timer){ clearTimeout(timer); timer=null; } };

    s.addEventListener('mouseenter', (e)=>{
      enterX = e.clientX; enterY = e.clientY;
      clearTimer();
      resetDwellCircle(s);
      startDwellCircle(s, HOVER_DWELL_MS);
      timer = setTimeout(()=>{ setColor(s, e); }, HOVER_DWELL_MS + 5);
    });

    s.addEventListener('mousemove', (e)=>{
      if(!timer) return;
      const dx = e.clientX - enterX;
      const dy = e.clientY - enterY;
      if (Math.hypot(dx, dy) > HOVER_MOVE_PX){
        enterX = e.clientX; enterY = e.clientY;
        clearTimer();
        resetDwellCircle(s);
        startDwellCircle(s, HOVER_DWELL_MS);
        timer = setTimeout(()=> setColor(s, e), HOVER_DWELL_MS + 5);
      }
    });

    s.addEventListener('mouseleave', ()=>{
      clearTimer();
      resetDwellCircle(s);
    });

    // Click/tap selects immediately; also clear indicator
    s.addEventListener('click', (e)=>{ clearTimer(); resetDwellCircle(s); setColor(s, e); });
    s.addEventListener('touchstart', (e)=>{ clearTimer(); resetDwellCircle(s); setColor(s, e.touches?.[0] || e); });
  });
}

/* ===== Responsive palette layout (no scrolling) ===== */
function layoutPalette(){
  const n = paletteEl.children.length;
  if(!n) return;

  const styles = getComputedStyle(sidebar);
  const padY = parseFloat(styles.getPropertyValue('padding-top')||'12')
             + parseFloat(styles.getPropertyValue('padding-bottom')||'12');
  const padX = parseFloat(styles.getPropertyValue('padding-left')||'12')
             + parseFloat(styles.getPropertyValue('padding-right')||'12');

  const reserve = brushBox.offsetHeight + saveBtn.offsetHeight + 24;

  const availH = Math.max(0, sidebar.clientHeight - padY - reserve);
  const availW = Math.max(0, sidebar.clientWidth  - padX);

  const rootCS = getComputedStyle(document.documentElement);
  const uiScale = parseFloat(rootCS.getPropertyValue('--ui-scale')) || 1;

  const minSize = 18;
  const maxSize = 96;

  const gapCandidates = [
    Math.max(6, Math.min(14, Math.round(12 * uiScale))),
    10, 8, 6, 4
  ];

  let best = null;

  for (const gap of gapCandidates){
    for (let cols = 1; cols <= Math.min(4, n); cols++){
      const rows = Math.ceil(n / cols);
      const sFromH = Math.floor((availH - Math.max(0, rows - 1) * gap) / rows);
      const sFromW = Math.floor((availW - Math.max(0, cols - 1) * gap) / cols);
      let s = Math.min(sFromH, sFromW);
      if (!Number.isFinite(s)) continue;
      s = Math.max(minSize, Math.min(maxSize, s));
      const totalH = rows * s + (rows - 1) * gap;
      const totalW = cols * s + (cols - 1) * gap;
      if (totalH <= availH + 0.5 && totalW <= availW + 0.5){
        if (!best || s > best.size) best = { cols, size: s, gap };
      }
    }
    if (best) break;
  }

  if (!best){
    const gap = 4;
    let bestS = minSize, bestCols = Math.min(4, n);
    for (let cols = 1; cols <= Math.min(4, n); cols++){
      const rows = Math.ceil(n / cols);
      const sFromH = Math.floor((availH - Math.max(0, rows - 1) * gap) / rows);
      const sFromW = Math.floor((availW - Math.max(0, cols - 1) * gap) / cols);
      let s = Math.min(sFromH, sFromW);
      if (!Number.isFinite(s)) continue;
      s = Math.max(12, Math.min(minSize, s));
      const totalH = rows * s + (rows - 1) * gap;
      const totalW = cols * s + (cols - 1) * gap;
      if (totalH <= availH + 0.5 && totalW <= availW + 0.5 && s > bestS){
        bestS = s; bestCols = cols;
      }
    }
    best = { cols: bestCols, size: bestS, gap };
  }

  sidebar.style.setProperty('--palette-cols', String(best.cols));
  sidebar.style.setProperty('--swatch-size', best.size + 'px');
  sidebar.style.setProperty('--swatch-gap',  best.gap + 'px');

  const border  = Math.max(2, Math.round(best.size * 0.06));
  const outline = Math.max(2, Math.round(best.size * 0.06));
  sidebar.style.setProperty('--swatch-border',  border + 'px');
  sidebar.style.setProperty('--swatch-outline', outline + 'px');
}

/* Brush sizes */
const brushBtns=document.querySelectorAll('.brushBtn');
function setBrushSize(btn, eventLike){
  brushBtns.forEach(b=>b.classList.toggle('active',b===btn));
  sizeMode=btn.dataset.size;
  flashEl(btn); popCursor();
  const x = (eventLike?.clientX) ?? (window.innerWidth/2);
  const y = (eventLike?.clientY) ?? (window.innerHeight/2);
  pulseAt(x,y,'rgba(0,0,0,.45)');
  playClick();
}
function setBrushSizeByName(name){
  const btn=Array.from(brushBtns).find(b=>b.dataset.size===name) || brushBtns[1];
  setBrushSize(btn);
}
brushBtns.forEach(b=>{
  b.addEventListener('mouseenter',(e)=>setBrushSize(b, e));
  b.addEventListener('click',     (e)=>setBrushSize(b, e));
});

/* Save PNG */
document.getElementById('saveBtn').addEventListener('click',()=>{
  const link=document.createElement('a');
  link.href=canvas.toDataURL('image/png');
  link.download='eyegaze-art.png';
  link.click();
});

/* Clear via Space (theme-aware) */
addEventListener('keydown',e=>{
  if(e.code!=='Space') return;
  const t=e.target;
  const isUI=t && (t.tagName==='INPUT'||t.tagName==='SELECT'||t.tagName==='TEXTAREA'||t.tagName==='BUTTON'||t.isContentEditable);
  if(isUI) return;
  ctx.fillStyle=canvasBgColor(); ctx.fillRect(0,0,innerWidth,innerHeight);
  last=null; e.preventDefault();
});
</script>
</body>
</html>
