<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title
    class="translate"
    data-fr="Voyage dans l'espace"
    data-en="Spatial voyage"
    data-ja="宇宙の旅">
    FTL Travel avec modes FTL doubles (ESPACE = Lent, ENTRÉE = Rapide)
  </title>

  <!-- Styles / libs -->
  <link rel="stylesheet" href="../../css/otherswitch.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>

  <style>
    /* Language pill – unified style */
    #langToggle {
      position: fixed;
      top: 14px;
      right: 44px;
      z-index: 11;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      border: 2px solid #04c8bb;
      background: #0b0f12;
      color: #04c8bb;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 0 0 0 rgba(4, 200, 187, 0);
      transition: box-shadow 0.2s ease, transform 0.05s ease, background 0.2s ease;
      user-select: none;
    }
    #langToggle:hover { box-shadow: 0 0 0 3px rgba(4, 200, 187, 0.2); }
    #langToggle:active { transform: translateY(1px); }

    /* Info toggle top-left (hidden after Start) */
    #infoButton{
      position: fixed; top:10px; left:10px; z-index:99999;
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:10px; border:2px solid #009688;
      background:#fff; color:#009688; font-weight:700; cursor:pointer;
      user-select:none;
    }
    body.dark #infoButton { background:#111; color:#00b3a4; border-color:#00b3a4; }

    /* Start overlay layout helpers */
    #startOptions{
      display:flex; gap:12px; align-items:center; justify-content:center; margin:14px 0;
      flex-wrap: wrap;
    }

    /* ===== Segmented two-button switch ===== */
    #segSwitch{
      display:inline-flex; align-items:center;
      border:2px solid #009688; border-radius:999px; overflow:hidden;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    #segSwitch .seg-btn{
      padding:8px 14px; border:0; background:#fff; color:#009688;
      font-weight:700; cursor:pointer; user-select:none;
    }
    #segSwitch .seg-btn[aria-selected="true"]{
      background:#009688; color:#fff;
    }
    /* Better contrast against overlay bg */
    #promptOverlay #segSwitch{ border-color:#fff; }
    #promptOverlay #segSwitch .seg-btn{ background:rgba(255,255,255,0.1); color:#fff; }
    #promptOverlay #segSwitch .seg-btn[aria-selected="true"]{ background:#fff; color:#009688; }

    /* Dark mode */
    body.dark #segSwitch{ border-color:#00b3a4; }
    body.dark #segSwitch .seg-btn{ background:#111; color:#00b3a4; }
    body.dark #segSwitch .seg-btn[aria-selected="true"]{ background:#00b3a4; color:#111; }

    /* ===== Cockpit overlay (NO SVG) ===== */
    #cockpitOverlay{
      position: fixed;
      inset: 0;
      z-index: 6;            /* above canvas, below prompt overlay */
      pointer-events: none;
      user-select: none;
      display: none;
    }
    body.started #cockpitOverlay{ display:block; }

    /* Full-screen frames */
    .cockpit-frame{
      position: absolute;
      inset: 0;
      box-sizing: border-box;
      background: transparent;
    }
    .cockpit-frame.outer{
      border: 26px solid rgba(105, 112, 125, 0.95);
      box-shadow:
        inset 0 0 0 6px rgba(10, 12, 15, 0.45),
        inset 0 0 0 1px rgba(255,255,255,0.10);
    }
    .cockpit-frame.inset{
      inset: 22px;
      border: 12px solid rgba(105, 112, 125, 0.75);
      box-shadow:
        inset 0 0 0 4px rgba(10, 12, 15, 0.35),
        inset 0 0 0 1px rgba(255,255,255,0.08);
    }

    /* Lines (thick struts + thin diagonals + window edges) */
    .cockpit-line{
      position:absolute;
      height: 10px; /* overwritten by JS */
      width: 100px; /* overwritten by JS */
      left: 0; top: 0;
      transform-origin: 0 50%;
      border-radius: 999px;
      background: rgba(105, 112, 125, 0.95);
      box-shadow:
        0 0 0 4px rgba(10, 12, 15, 0.35),
        0 0 0 1px rgba(255,255,255,0.06) inset;
      opacity: 1;
    }

    /* Thin “highlight” lines */
    .cockpit-line.thin{
      background: rgba(210, 220, 235, 0.22);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.12);
      border-radius: 999px;
    }

    /* Central window edges */
    .window-edge{
      background: rgba(105, 112, 125, 0.95);
      box-shadow:
        0 0 0 4px rgba(10, 12, 15, 0.45),
        0 0 0 1px rgba(255,255,255,0.08) inset;
      border-radius: 999px;
    }
    .window-edge.hi{
      background: rgba(255,255,255,0.16);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.12);
      border-radius: 999px;
    }
  </style>

  <!-- GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>

<body>
  <!-- Language toggle -->
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN / JA</button>

  <!-- Info toggle (hidden after Start) -->
  <button id="infoButton" title="Plus d'infos" class="translate" data-fr="ⓘ" data-en="ⓘ" data-ja="ⓘ">ⓘ</button>

  <!-- Prompt Overlay -->
  <div id="promptOverlay">
    <p class="translate translate-html"
       data-fr="Tenir la switch pour faire avancer un vaisseau spatial à travers l'espace interstellaire.<br>Première switch pour le mode croisière (lent) – Espace<br>Deuxième switch pour le mode aventure (rapide) – Enter<br>Mode à une switch alterne entre les modes lent, rapide et arrêt en appuyant"
       data-en="Hold the switch to move a spaceship through interstellar space.<br>First switch for cruise mode (slow) – Space<br>Second switch for adventure mode (fast) – Enter<br>One-switch mode cycles between slow, fast, and stop by pressing"
       data-ja="スイッチを押して宇宙船を星間空間で進めましょう。<br>1つ目のスイッチは巡航モード（低速）– スペースキー<br>2つ目のスイッチはアドベンチャーモード（高速）– Enterキー<br>1スイッチモードでは、押すたびに低速→高速→停止を切り替えます">
      Tenir la switch pour faire avancer un vaisseau spatial à travers l'espace interstellaire.<br>
      Première switch pour le mode croisière (lent) – Espace<br>
      Deuxième switch pour le mode aventure (rapide) – Enter
    </p>

    <!-- Mode chooser -->
    <div id="startOptions">
      <div id="segSwitch" role="tablist" aria-label="Control mode">
        <button type="button" role="tab" id="segTwo" aria-selected="true" class="seg-btn">
          <span class="translate" data-fr="2 switchs (maintenir)" data-en="2 switches (hold)" data-ja="2スイッチ（押し続け）">
            2 boutons (ESPACE + ENTRÉE)
          </span>
        </button>
        <button type="button" role="tab" id="segOne" aria-selected="false" class="seg-btn">
          <span class="translate" data-fr="1 switch (appuyer)" data-en="1 switch (press)" data-ja="1スイッチ（押すごとに切替）">
            1 bouton (ESPACE&nbsp;: lent → rapide → arrêt)
          </span>
        </button>
      </div>
    </div>

    <button id="startButton" class="translate" data-fr="Commencer" data-en="Start" data-ja="開始">Commencer</button>
  </div>

  <!-- Info Modal -->
  <div id="infoModal" style="display:none;">
    <p class="translate translate-html"
       data-fr="Compétence: appuyer et maintenir et différencier l'action de deux switchs<br>SENICT switch skills niveau 2 et 6<br>Switch Progression Roadmap niveau 11 à 13 et 20"
       data-en="Skill: press and hold and differentiate the action of two switches<br>SENICT switch skills level 2 and 6<br>Switch Progression Roadmap levels 11 to 13 and 20"
       data-ja="スキル：押して保持し、2つのスイッチの役割を区別する<br>SENICT スイッチスキル レベル2および6<br>Switch Progression Roadmap レベル11〜13と20">
      Compétence: appuyer et maintenir et différencier l'action de deux switchs<br>
      SENICT switch skills niveau 2 et 6<br>
      Switch Progression Roadmap niveau 11 à 13 et 20
    </p>
    <button id="closeModal" class="translate" data-fr="Fermer" data-en="Close" data-ja="閉じる">Fermer</button>
  </div>

  <!-- Cockpit overlay (NO SVG) -->
  <div id="cockpitOverlay" aria-hidden="true">
    <div class="cockpit-frame outer"></div>
    <div class="cockpit-frame inset"></div>

    <!-- Central trapezoid window: 4 thick edges + 4 thin highlights -->
    <div class="cockpit-line window-edge" id="w1"></div>
    <div class="cockpit-line window-edge" id="w2"></div>
    <div class="cockpit-line window-edge" id="w3"></div>
    <div class="cockpit-line window-edge" id="w4"></div>

    <div class="cockpit-line window-edge hi" id="wh1"></div>
    <div class="cockpit-line window-edge hi" id="wh2"></div>
    <div class="cockpit-line window-edge hi" id="wh3"></div>
    <div class="cockpit-line window-edge hi" id="wh4"></div>

    <!-- Thick corner struts -->
    <div class="cockpit-line" id="d1"></div>
    <div class="cockpit-line" id="d2"></div>
    <div class="cockpit-line" id="d3"></div>
    <div class="cockpit-line" id="d4"></div>

    <!-- Thin diagonals (inner trapezoid corners -> screen corners), on top -->
    <div class="cockpit-line thin" id="td1"></div>
    <div class="cockpit-line thin" id="td2"></div>
    <div class="cockpit-line thin" id="td3"></div>
    <div class="cockpit-line thin" id="td4"></div>
  </div>

  <script>
    /* ===== Translation system ===== */
    const LS_LANG_KEY = 'siteLanguage';
    const SUPPORTED_LANGS = ['en', 'ja', 'fr'];
    const langToggle = document.getElementById('langToggle');

    function documentLangFallback() {
      const htmlLang = (document.documentElement.lang || '').toLowerCase();
      return SUPPORTED_LANGS.includes(htmlLang) ? htmlLang : 'en';
    }
    function getText(el, lang) {
      for (const code of [lang, ...SUPPORTED_LANGS.filter(c => c !== lang)]) {
        const val = el.getAttribute(`data-${code}`);
        if (val != null) return val;
      }
      return null;
    }
    function applyTranslations(lang) {
      const safeLang = SUPPORTED_LANGS.includes(lang) ? lang : 'en';
      document.querySelectorAll('.translate').forEach(el => {
        const value = getText(el, safeLang);
        if (value == null) return;
        if (['P', 'BUTTON', 'DIV', 'H1', 'H2', 'H3'].includes(el.tagName)) el.innerHTML = value;
        else el.textContent = value;
      });
      document.documentElement.lang = safeLang;

      const titleEl = document.querySelector('title');
      if (titleEl) {
        const nextTitle = getText(titleEl, safeLang);
        if (nextTitle) { titleEl.textContent = nextTitle; document.title = nextTitle; }
      }

      if (langToggle) {
        const idx = SUPPORTED_LANGS.indexOf(safeLang);
        const nextIdx = (idx + 1) % SUPPORTED_LANGS.length;
        langToggle.textContent = SUPPORTED_LANGS[nextIdx].toUpperCase();
      }
    }
    function setLang(lang) {
      const safeLang = SUPPORTED_LANGS.includes(lang) ? lang : 'en';
      try { localStorage.setItem(LS_LANG_KEY, safeLang); } catch (e) {}
      applyTranslations(safeLang);
    }
    function getInitialLang() {
      let initial = documentLangFallback();
      try {
        const stored = localStorage.getItem(LS_LANG_KEY);
        if (SUPPORTED_LANGS.includes(stored)) initial = stored;
      } catch (e) {}
      return initial;
    }
    langToggle?.addEventListener('click', () => {
      const currentRaw =
        (typeof localStorage !== 'undefined' && localStorage.getItem(LS_LANG_KEY)) ||
        document.documentElement.lang ||
        'en';
      const current = currentRaw.toLowerCase();
      const idx = SUPPORTED_LANGS.indexOf(current);
      const nextLang = SUPPORTED_LANGS[(idx + 1) % SUPPORTED_LANGS.length];
      setLang(nextLang);
    });
    setLang(getInitialLang());

    /* ===== Cockpit geometry (NO SVG) ===== */
    function setLine(el, x1, y1, x2, y2, thicknessPx) {
      const dx = x2 - x1, dy = y2 - y1;
      const len = Math.sqrt(dx*dx + dy*dy);
      const ang = Math.atan2(dy, dx) * 180 / Math.PI;

      el.style.left = x1 + 'px';
      el.style.top = y1 + 'px';
      el.style.width = len + 'px';
      el.style.height = thicknessPx + 'px';
      el.style.transform = `translateY(${-thicknessPx/2}px) rotate(${ang}deg)`;
    }

    function updateCockpit() {
      const w = window.innerWidth;
      const h = window.innerHeight;

      // Trapezoid proportions (window)
      const topY = 0.26 * h;
      const botY = 0.74 * h;
      const topInset = 0.34 * w;
      const botInset = 0.25 * w;

      const P1 = { x: topInset,     y: topY }; // top-left
      const P2 = { x: w - topInset, y: topY }; // top-right
      const P3 = { x: w - botInset, y: botY }; // bottom-right
      const P4 = { x: botInset,     y: botY }; // bottom-left

      // Thickness hierarchy
      const thickStrut = Math.max(18, Math.min(28, Math.round(0.022 * Math.min(w, h))));
      const thinDiag   = Math.max(2,  Math.min(3,  Math.round(0.003 * Math.min(w, h))));
      const winThick   = Math.max(14, Math.min(22, Math.round(0.018 * Math.min(w, h))));
      const winHi      = Math.max(2,  Math.min(4,  Math.round(0.004 * Math.min(w, h))));

      // ---- Central window edges (visible, always) ----
      setLine(document.getElementById('w1'), P1.x, P1.y, P2.x, P2.y, winThick);
      setLine(document.getElementById('w2'), P2.x, P2.y, P3.x, P3.y, winThick);
      setLine(document.getElementById('w3'), P3.x, P3.y, P4.x, P4.y, winThick);
      setLine(document.getElementById('w4'), P4.x, P4.y, P1.x, P1.y, winThick);

      // Slightly inset highlight lines (toward center)
      const cx = (P1.x + P2.x + P3.x + P4.x) / 4;
      const cy = (P1.y + P2.y + P3.y + P4.y) / 4;
      const inset = (p) => ({ x: p.x + (cx - p.x) * 0.06, y: p.y + (cy - p.y) * 0.06 });
      const Q1 = inset(P1), Q2 = inset(P2), Q3 = inset(P3), Q4 = inset(P4);

      setLine(document.getElementById('wh1'), Q1.x, Q1.y, Q2.x, Q2.y, winHi);
      setLine(document.getElementById('wh2'), Q2.x, Q2.y, Q3.x, Q3.y, winHi);
      setLine(document.getElementById('wh3'), Q3.x, Q3.y, Q4.x, Q4.y, winHi);
      setLine(document.getElementById('wh4'), Q4.x, Q4.y, Q1.x, Q1.y, winHi);

      // ---- Thick corner struts (screen corners -> window corners) ----
      setLine(document.getElementById('d1'), 0, 0, P1.x, P1.y, thickStrut);
      setLine(document.getElementById('d2'), w, 0, P2.x, P2.y, thickStrut);
      setLine(document.getElementById('d3'), 0, h, P4.x, P4.y, thickStrut);
      setLine(document.getElementById('d4'), w, h, P3.x, P3.y, thickStrut);

      // ---- Thin diagonals (window corners -> screen corners), drawn last ----
      setLine(document.getElementById('td1'), P1.x, P1.y, 0, 0, thinDiag);
      setLine(document.getElementById('td2'), P2.x, P2.y, w, 0, thinDiag);
      setLine(document.getElementById('td3'), P4.x, P4.y, 0, h, thinDiag);
      setLine(document.getElementById('td4'), P3.x, P3.y, w, h, thinDiag);
    }

    window.addEventListener('resize', updateCockpit);

    // ===== Game state =====
    let started=false;
    let ftlMode=null;                 // "slow" | "fast" | null
    let oneButtonMode=false;          // set from start menu
    let canvas;

    // Glow effect
    let glowActive=false, glowStartTime=0, glowDuration=1000;

    // Sounds/playlists
    let currentSong=null, currentSongType=null;
    let launchSound, launchSoundSlow, engineHumSound, passBySound;
    let launchPlayed=false, launchPlayedSlow=false;
    let slowSongs=[], fastSongs=[];
    const slowSongPaths=[
      "../../songs/space/spacequest1.mp3",
      "../../songs/space/spacequest2.mp3",
      "../../songs/space/spacequest3.mp3"
    ];
    const fastSongPaths=[
      "../../songs/space/spacequestfast1.mp3",
      "../../songs/space/spacequestfast2.mp3",
      "../../songs/space/spacequestfast3.mp3",
      "../../songs/space/spacequestfast4.mp3",
      "../../songs/space/spacequestfast5.mp3",
      "../../songs/space/spacequestfast6.mp3"
    ];

    // Stars/objects
    let swStars=[]; const numSWStars=200;
    const normalStarSpeed=0.2, ftlStarSpeed=10, globalSpeedFactor=0.8;
    let shootingStars=[]; const shootingStarInterval=5000; let lastShootingStarTime=0;
    let galacticObjects=[]; const objectInterval=5000; let lastObjectSpawnTime=0;
    let currentAngle=0, targetAngle=0;

    function preload(){
      slowSongPaths.forEach(p=>slowSongs.push(loadSound(p)));
      fastSongPaths.forEach(p=>fastSongs.push(loadSound(p)));
      launchSound     = loadSound("../../sounds/spacequestlaunch2.mp3");
      launchSoundSlow = loadSound("../../sounds/spacequestlaunch.mp3");
      engineHumSound  = loadSound("../../sounds/spacequesthum.mp3");
      passBySound     = loadSound("../../sounds/spacequestwoosh.mp3");
    }
    function setup(){
      canvas=createCanvas(windowWidth,windowHeight); canvas.position(0,0);
      for(let i=0;i<numSWStars;i++) swStars.push(new Star());
    }
    function draw(){
      background(0,20);
      currentAngle = lerp(currentAngle, targetAngle, 0.1);
      push(); translate(width/2,height/2); rotate(radians(currentAngle)); translate(-width/2,-height/2);

      push(); translate(width/2,height/2); for(const s of swStars){ s.update(); s.display(); } pop();
      if(!started){ pop(); return; }

      if(ftlMode!==null && ftlMode!==currentSongType){ if(currentSong) currentSong.pause(); currentSong=null; currentSongType=ftlMode; }

      if(ftlMode!==null && millis()-lastShootingStarTime>shootingStarInterval){
        shootingStars.push(new ShootingStar()); lastShootingStarTime=millis();
      }
      push(); translate(width/2,height/2);
      for(let i=shootingStars.length-1;i>=0;i--){ shootingStars[i].update(); shootingStars[i].display(); if(shootingStars[i].isOffScreen()){ shootingStars.splice(i,1);} }
      pop();

      let currentInterval = (ftlMode==="slow") ? objectInterval*2 : objectInterval;
      if(ftlMode!==null && millis()-lastObjectSpawnTime>currentInterval){
        const types=["fire","ice","sun","asteroid","gaseous","toxic","wormhole","crystal"];
        const pick=random(types);
        galacticObjects.push(
          pick==="fire"?new FirePlanet():
          pick==="ice"?new IcePlanet():
          pick==="sun"?new Sun():
          pick==="asteroid"?new Asteroid():
          pick==="gaseous"?new GaseousGiant():
          pick==="toxic"?new ToxicPlanet():
          pick==="wormhole"?new Wormhole():
          new CrystalPlanet()
        );
        lastObjectSpawnTime=millis();
      }

      push(); translate(width/2,height/2);
      for(let i=galacticObjects.length-1;i>=0;i--){
        galacticObjects[i].update(); galacticObjects[i].display();
        if(ftlMode==="fast" && galacticObjects[i].z<200 && !galacticObjects[i].passSoundPlayed){ passBySound.play(); galacticObjects[i].passSoundPlayed=true; }
        if(galacticObjects[i].isGone()) galacticObjects.splice(i,1);
      }
      pop();

      if(ftlMode!==null){
        if(currentSong && !currentSong.isPlaying()) currentSong.play();
        else if(!currentSong){ currentSong=pickRandomSongFrom(ftlMode==="fast"?fastSongs:slowSongs); currentSong.loop(); currentSongType=ftlMode; }
      }
      pop();

      if(glowActive){
        const e=millis()-glowStartTime;
        if(e<glowDuration){ const a=map(e,0,glowDuration,100,0); push(); noStroke(); fill(255,a); rect(0,0,width,height); pop(); }
        else glowActive=false;
      }
    }
    function ftlActiveForUpdate(){ return (ftlMode==="fast"||ftlMode==="slow")?ftlStarSpeed:normalStarSpeed; }

    // Keys
    function keyPressed(){
      if(!started) return;
      if(oneButtonMode && keyCode===32){
        if(ftlMode===null){ ftlMode="slow"; if(!launchPlayedSlow){ launchSoundSlow.play(); launchPlayedSlow=true; } }
        else if(ftlMode==="slow"){ ftlMode="fast"; if(!launchPlayed){ launchSound.play(); launchPlayed=true; } if(!engineHumSound.isPlaying()) engineHumSound.loop(); }
        else { ftlMode=null; launchPlayed=false; launchPlayedSlow=false; if(engineHumSound.isPlaying()) engineHumSound.stop(); if(currentSong&&currentSong.isPlaying()) currentSong.pause(); currentSong=null; currentSongType=null; }
        glowActive=true; glowStartTime=millis();
      } else if(!oneButtonMode){
        if(keyCode===32){ if(ftlMode!=="fast"){ ftlMode="slow"; if(!launchPlayedSlow){ launchSoundSlow.play(); launchPlayedSlow=true; } glowActive=true; glowStartTime=millis(); } }
        if(keyCode===ENTER){ if(ftlMode!=="slow"){ ftlMode="fast"; if(!launchPlayed){ launchSound.play(); launchPlayed=true; } if(!engineHumSound.isPlaying()) engineHumSound.loop(); glowActive=true; glowStartTime=millis(); } }
        if(keyCode===LEFT_ARROW) targetAngle-=90; else if(keyCode===RIGHT_ARROW) targetAngle+=90;

        if((currentSong===null)||(currentSongType!==ftlMode)){
          currentSong=pickRandomSongFrom(ftlMode==="fast"?fastSongs:slowSongs); currentSong.loop(); currentSongType=ftlMode;
        } else if(currentSong && !currentSong.isPlaying()) currentSong.play();
      }
    }
    function keyReleased(){
      if(!started) return;
      if(!oneButtonMode){
        if(keyCode===32 && ftlMode==="slow"){ ftlMode=null; launchPlayedSlow=false; }
        if(keyCode===ENTER && ftlMode==="fast"){ ftlMode=null; launchPlayed=false; if(engineHumSound.isPlaying()) engineHumSound.stop(); }
        if(ftlMode===null && currentSong!==null) currentSong.pause();
      }
    }
    function pickRandomSongFrom(arr){ return arr[floor(random(arr.length))]; }

    /* ===== Segmented control logic (pre-start only) ===== */
    let segChoice = 'two';
    const segTwo = document.getElementById('segTwo');
    const segOne = document.getElementById('segOne');
    function selectSeg(which){
      segChoice = which;
      if(which==='two'){
        segTwo.setAttribute('aria-selected','true');
        segOne.setAttribute('aria-selected','false');
      }else{
        segTwo.setAttribute('aria-selected','false');
        segOne.setAttribute('aria-selected','true');
      }
    }
    segTwo.addEventListener('click', ()=> selectSeg('two'));
    segOne.addEventListener('click', ()=> selectSeg('one'));

    // UI bindings
    document.getElementById("startButton").addEventListener("click", function() {
      started = true;
      document.body.classList.add('started');

      oneButtonMode = (segChoice === 'one');

      document.getElementById("promptOverlay").style.display = "none";
      const pill = document.getElementById('langToggle'); if (pill) pill.style.display = 'none';
      const info = document.getElementById('infoButton'); if (info) info.style.display = 'none';

      updateCockpit();
      goFullscreen();
    });
    document.getElementById("infoButton").addEventListener("click", function() {
      document.getElementById("infoModal").style.display = "block";
    });
    document.getElementById("closeModal").addEventListener("click", function() {
      document.getElementById("infoModal").style.display = "none";
    });

    function windowResized(){ resizeCanvas(windowWidth,windowHeight); updateCockpit(); }
    function goFullscreen(){ if(!document.fullscreenElement){ document.documentElement.requestFullscreen().catch(()=>{}); } }

    // ===== Entities (unchanged) =====
    class Star{
      constructor(){this.reset();}
      reset(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width);}
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*m; if(this.z<1) this.reset();}
      display(){fill(255); noStroke(); const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2); const r=map(this.z,0,width,4,0); ellipse(sx,sy,r,r);}
    }
    class ShootingStar{
      constructor(){
        if(random()<0.5){ this.x=-50; this.y=random(height); this.vel=createVector(random(5,10),random(-2,2)); }
        else { this.x=random(width); this.y=-50; this.vel=createVector(random(-2,2),random(5,10)); }
        this.trailLength=random(50,150); this.alpha=255;
      }
      update(){ const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.x+=this.vel.x*m; this.y+=this.vel.y*m; this.alpha-=5; }
      display(){ stroke(255,this.alpha); strokeWeight(2); line(this.x,this.y, this.x-this.vel.x*(this.trailLength/20), this.y-this.vel.y*(this.trailLength/20)); noStroke(); fill(255, this.alpha); ellipse(this.x,this.y,4);}
      isOffScreen(){ return this.x>width+50||this.x<-50||this.y>height+50||this.y<-50||this.alpha<=0; }
    }

    class FirePlanet{
      constructor(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width*1.5,width*2.5);this.baseSize=random(70,130);this.pgSize=this.baseSize*2;this.texture=createGraphics(this.pgSize,this.pgSize);this.drawTexture();this.passSoundPlayed=false;}
      drawTexture(){let pg=this.texture;pg.clear();pg.push();pg.translate(pg.width/2,pg.height/2);let R=this.baseSize*0.5;for(let r=R;r>0;r--){let t=r/R; pg.noStroke(); pg.fill(lerpColor(color(255,140,0),color(255,110,0),1-t)); pg.ellipse(0,0,r*2,r*2);} pg.pop();}
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*globalSpeedFactor*m;}
      display(){const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2); const r=map(this.z,0,width*2.5,this.baseSize*2,0); push(); translate(sx,sy); imageMode(CENTER); image(this.texture,0,0,r,r); pop();}
      isGone(){return this.z<1;}
    }
    class IcePlanet{
      constructor(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width*1.5,width*2.5);this.baseSize=random(70,130);this.pgSize=this.baseSize*2;this.texture=createGraphics(this.pgSize,this.pgSize);this.drawTexture();this.passSoundPlayed=false;}
      drawTexture(){let pg=this.texture;pg.clear();pg.push();pg.translate(pg.width/2,pg.height/2);let R=this.baseSize*0.5;for(let r=R;r>0;r--){let t=r/R; pg.noStroke(); pg.fill(lerpColor(color(180,220,255),color(255,255,255),1-t)); pg.ellipse(0,0,r*2,r*2);} pg.pop();}
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*globalSpeedFactor*m;}
      display(){const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2); const r=map(this.z,0,width*2.5,this.baseSize*2,0); push(); translate(sx,sy); imageMode(CENTER); image(this.texture,0,0,r,r); pop();}
      isGone(){return this.z<1;}
    }
    class Sun{
      constructor(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width*1.5,width*2.5);this.baseSize=random(150,250);this.pgSize=this.baseSize*2;this.texture=createGraphics(this.pgSize,this.pgSize);this.drawTexture();this.passSoundPlayed=false;}
      drawTexture(){let pg=this.texture;pg.clear();pg.push();pg.translate(pg.width/2,pg.height/2);let R=this.baseSize*0.5;for(let r=R;r>0;r--){let t=r/R; pg.noStroke(); pg.fill(lerpColor(color(255,255,255),color(255,255,0),1-t)); pg.ellipse(0,0,r*2,r*2);} for(let r=R*1.2;r<R*1.8;r+=2){let t=(r-R*1.2)/(R*0.6); pg.noStroke(); pg.fill(lerpColor(color(255,200,0,80),color(255,150,0,0),t)); pg.ellipse(0,0,r*2,r*2);} pg.pop();}
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*globalSpeedFactor*m;}
      display(){const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2); const r=map(this.z,0,width*2.5,this.baseSize*2,0); push(); translate(sx,sy); imageMode(CENTER); image(this.texture,0,0,r,r); pop();}
      isGone(){return this.z<1;}
    }
    class Asteroid{
      constructor(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width*1.5,width*2.5);this.baseSize=random(20,40);this.vertexCount=floor(random(6,10));this.variation=random(0.3,0.8);this.vertexOffsets=Array.from({length:this.vertexCount},()=>random(-this.variation,this.variation));this.passSoundPlayed=false;}
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*globalSpeedFactor*m;}
      display(){
        const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2);
        const r=map(this.z,0,width*2.5,this.baseSize*2,0);
        push(); translate(sx,sy); noStroke(); fill(100,100,100);
        beginShape();
        for(let i=0;i<this.vertexCount;i++){
          const a=map(i,0,this.vertexCount,0,TWO_PI);
          const off=this.vertexOffsets[i];
          const rad=r*(1+off);
          vertex(rad * Math.cos(a), rad * Math.sin(a));
        }
        endShape(CLOSE);
        pop();
      }
      isGone(){return this.z<1;}
    }
    class GaseousGiant{
      constructor(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width*1.5,width*2.5);this.baseSize=random(120,200);this.pgSize=this.baseSize*2;this.texture=createGraphics(this.pgSize,this.pgSize);this.drawTexture();this.passSoundPlayed=false;}
      drawTexture(){
        let pg=this.texture;pg.clear();pg.push();pg.translate(pg.width/2,pg.height/2);
        let R=this.baseSize*0.5;
        for(let r=R;r>0;r--){let t=r/R; pg.noStroke(); pg.fill(lerpColor(color(100,150,255),color(20,50,150),1-t)); pg.ellipse(0,0,r*2,r*2);}
        let n=6; for(let i=0;i<n;i++){ let y=map(i,0,n-1,-R,R); let ww=2*sqrt(sq(R)-sq(y)); let hh=R*0.1; pg.noStroke(); pg.fill(i%2? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.3)'); pg.ellipse(0,y,ww,hh);}
        pg.pop();
      }
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*globalSpeedFactor*m;}
      display(){const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2); const r=map(this.z,0,width*2.5,this.baseSize*2,0); push(); translate(sx,sy); imageMode(CENTER); image(this.texture,0,0,r,r); pop();}
      isGone(){return this.z<1;}
    }
    class ToxicPlanet{
      constructor(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width*1.5,width*2.5);this.baseSize=random(70,130);this.pgSize=this.baseSize*2;this.texture=createGraphics(this.pgSize,this.pgSize);this.drawTexture();this.passSoundPlayed=false;}
      drawTexture(){
        let pg=this.texture;pg.clear();pg.push();pg.translate(pg.width/2,pg.height/2);
        let R=this.baseSize*0.5;
        for(let r=R;r>0;r--){let t=r/R; pg.noStroke(); pg.fill(lerpColor(color(100,255,100),color(20,100,20),1-t)); pg.ellipse(0,0,r*2,r*2);}
        for(let i=0;i<5;i++){ pg.fill(50,200,50,150); pg.ellipse(random(-R*0.3,R*0.3),random(-R*0.3,R*0.3),random(R*0.05,R*0.1)); }
        pg.pop();
      }
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*globalSpeedFactor*m;}
      display(){const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2); const r=map(this.z,0,width*2.5,this.baseSize*2,0); push(); translate(sx,sy); imageMode(CENTER); image(this.texture,0,0,r,r); pop();}
      isGone(){return this.z<1;}
    }
    class Wormhole{
      constructor(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width*1.5,width*2.5);this.baseSize=random(120,180);this.angle=0;this.pgSize=this.baseSize*2;this.texture=createGraphics(this.pgSize,this.pgSize);this.drawTexture();this.passSoundPlayed=false;}
      drawTexture(){let pg=this.texture;pg.clear();pg.push();pg.translate(pg.width/2,pg.height/2);for(let i=0;i<20;i++){let t=i/20; pg.stroke(lerpColor(color(50,50,200),color(200,50,200),t)); pg.noFill(); let rad=this.baseSize*0.5*(1+t); pg.ellipse(0,0,rad*2,rad*2);} pg.pop();}
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*globalSpeedFactor*m; this.angle += 0.01*m;}
      display(){const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2); const r=map(this.z,0,width*2.5, this.baseSize*2,0); push(); translate(sx,sy); rotate(this.angle); imageMode(CENTER); image(this.texture,0,0,r,r); pop();}
      isGone(){return this.z<1;}
    }
    class CrystalPlanet{
      constructor(){this.x=random(-width/2,width/2);this.y=random(-height/2,height/2);this.z=random(width*1.5,width*2.5);this.baseSize=random(80,140);this.pgSize=this.baseSize*2;this.texture=createGraphics(this.pgSize, this.pgSize);this.drawTexture();this.passSoundPlayed=false;}
      drawTexture(){
        let pg=this.texture;pg.clear();pg.push();pg.translate(pg.width/2,pg.height/2);
        let slices=floor(random(6,10));let step=TWO_PI/slices;let R=this.baseSize*0.5;
        let cols=[color(170,220,255),color(200,150,255),color(255,220,250)];
        for(let i=0;i<slices;i++){
          let a0=i*step,a1=a0+step;
          pg.beginShape(); pg.noStroke(); pg.fill(random(cols)); pg.vertex(0,0);
          for(let a=a0;a<=a1;a+=step/3){
            let rr=R+random(-R*0.1,R*0.1);
            pg.vertex(rr * Math.cos(a), rr * Math.sin(a));
          }
          pg.endShape(CLOSE);
        }
        pg.pop();
      }
      update(){const m=(ftlMode==="fast")?1.5:(ftlMode==="slow")?0.5:1; this.z -= ftlActiveForUpdate()*globalSpeedFactor*m;}
      display(){const sx=(this.x/this.z)*(width/2), sy=(this.y/this.z)*(height/2); const size=map(this.z,0,width*2.5,this.baseSize*2,0); push(); translate(sx,sy); imageMode(CENTER); image(this.texture,0,0,size,size); pop();}
      isGone(){return this.z<1;}
    }
  </script>
</body>
</html>
