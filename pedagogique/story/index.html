<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title class="translate" data-fr="PDF ‚Äî Avancer en cliquant" data-en="PDF ‚Äî Click to Advance">PDF ‚Äî Avancer en cliquant</title>

  <!-- pdf.js (stable UMD v3) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    window.__PDFJS__ = window.pdfjsLib;
  </script>

  <!-- tesseract.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{ --teal:#009688; --bg:#000; --fg:#fff; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden; }

    #stage{ position:fixed; inset:0; display:grid; place-items:center; background:#000; cursor:pointer; z-index:1; }
    canvas{ display:block; max-width:100vw; max-height:100vh; }

    #overlay{ position:fixed; inset:0; pointer-events:none; z-index:2; }

    #topbar{ position:fixed; top:10px; left:10px; right:10px; display:flex; gap:10px; align-items:center; justify-content:space-between; z-index:5; }
    #pickerRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{ background:var(--teal); color:#fff; border:none; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:16px; box-shadow:0 2px 10px rgba(0,0,0,.25); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    #fileInput{ padding:8px; border-radius:10px; border:1px solid #333; background:#111; color:#ddd; }
    #tips{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px dashed #444; border-radius:10px; background:#0a0a0a; color:#ddd; font-size:14px; z-index:5; }

    #centerPrompt{ position:fixed; inset:0; display:grid; place-items:center; z-index:6; background: radial-gradient(transparent, rgba(0,0,0,.35) 60%); }
    #centerPrompt .card{ text-align:center; background:#111; border:1px solid #333; border-radius:16px; padding:20px; max-width:min(700px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.4); }
    #chooseBtnBig{ font-size:18px; padding:14px 18px; }

    #hud{ position:fixed; left:12px; bottom:12px; padding:6px 10px; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.2); border-radius:10px; font-size:14px; user-select:none; z-index:5; }

    #langToggle{ position:fixed; top:10px; right:10px; z-index:7; display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; border:2px solid var(--teal); background:#111; color:#fff; cursor:pointer; user-select:none; }

    #ocrHud{ position:fixed; right:12px; bottom:12px; z-index:6; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.2); border-radius:10px; padding:8px 10px; font-size:13px; min-width:320px; display:flex; flex-direction:column; gap:6px; }
    #ocrHud .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #ocrHud select, #ocrHud label{ font-size:13px; }
    #ocrProg{ height:6px; background:#111; border-radius:999px; overflow:hidden; }
    #ocrProg > div{ height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#34d399); transition:width .12s linear; }
    #ocrStatus{ opacity:.85; }
    #textOut{ display:none; width:min(520px, 90vw); max-height:30vh; overflow:auto; background:#0b0b0b; color:#ddd; border:1px solid #333; border-radius:10px; padding:8px; margin:0; position:fixed; right:12px; bottom:102px; z-index:6; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div id="langToggle" title="Basculer la langue / Toggle language">FR / EN</div>

  <div id="topbar">
    <div id="pickerRow">
      <button id="chooseBtn" class="btn"><span class="translate" data-fr="Choisir un PDF" data-en="Choose PDF">Choisir un PDF</span></button>
      <input id="fileInput" type="file" accept="application/pdf" />
      <button id="startBtn" class="btn" disabled><span class="translate" data-fr="D√©marrer (plein √©cran)" data-en="Start (Fullscreen)">D√©marrer (plein √©cran)</span></button>
    </div>
    <div id="tips">
      <span>üñ±Ô∏è</span>
      <span class="translate" data-fr="Cliquez ou espace pour avancer. ‚Üê / ‚Üí reculent / avancent. Reboucle √† la fin."
            data-en="Click or Space to advance. ‚Üê / ‚Üí navigate. Loops at the end.">
        Cliquez ou espace pour avancer. ‚Üê / ‚Üí reculent / avancent. Reboucle √† la fin.
      </span>
    </div>
  </div>

  <div id="centerPrompt">
    <div class="card">
      <h2 class="translate" data-fr="Charger un PDF" data-en="Load a PDF">Charger un PDF</h2>
      <p class="translate" data-fr="Appuyez sur le bouton ci-dessous pour choisir un fichier PDF multi-pages."
         data-en="Press the button below to choose a multi-page PDF file.">
        Appuyez sur le bouton ci-dessous pour choisir un fichier PDF multi-pages.
      </p>
      <button id="chooseBtnBig" class="btn"><span class="translate" data-fr="Choisir un PDF‚Ä¶" data-en="Choose PDF‚Ä¶">Choisir un PDF‚Ä¶</span></button>
      <p style="opacity:.8; margin-top:10px" class="translate" data-fr="Astuce : vous pouvez aussi d√©poser un PDF dans la fen√™tre." data-en="Tip: you can also drop a PDF into the window.">
         Astuce : vous pouvez aussi d√©poser un PDF dans la fen√™tre.
      </p>
    </div>
  </div>

  <div id="stage" aria-label="Zone d‚Äôaffichage PDF">
    <canvas id="pageCanvas" aria-hidden="true"></canvas>
  </div>
  <canvas id="overlay"></canvas>

  <div id="hud"><span id="pageLabel">‚Äî</span></div>

  <pre id="textOut"></pre>
  <div id="ocrHud">
    <div class="row">
      <label for="ocrLang">OCR:</label>
      <select id="ocrLang">
        <option value="eng" selected>English (eng)</option>
        <option value="fra">Fran√ßais (fra)</option>
        <option value="eng+fra">English + Fran√ßais</option>
        <option value="spa">Espa√±ol (spa)</option>
        <option value="deu">Deutsch (deu)</option>
      </select>
      <label><input type="checkbox" id="autoRead" checked> <span class="translate" data-fr="Lecture auto" data-en="Auto-read">Lecture auto</span></label>
    </div>
    <div class="row">
      <label for="charFilter">Filtre caract√®res:</label>
      <select id="charFilter" title="Limiter les caract√®res pour la lecture et l‚ÄôOCR">
        <option value="none" selected>‚Äî Aucun ‚Äî</option>
        <option value="latin">Lettres latines (A‚ÄìZ a‚Äìz)</option>
        <option value="latin+digits">Lettres + chiffres (A‚ÄìZ a‚Äìz 0‚Äì9)</option>
      </select>
      <label><input type="checkbox" id="showBoxes"> <span class="translate" data-fr="Montrer les bo√Ætes OCR" data-en="Show OCR boxes">Montrer les bo√Ætes OCR</span></label>
    </div>
    <div id="ocrProg" aria-hidden="true"><div id="ocrBar"></div></div>
    <div id="ocrStatus">‚Äî</div>
  </div>

  <script>
    // ===== Language toggle =====
    const langToggle = document.getElementById('langToggle');
    let currentLang = 'fr';
    function applyLang(){ document.querySelectorAll('.translate').forEach(el=>{ const t = el.dataset[currentLang]; if(t) el.textContent = t; }); }
    langToggle.addEventListener('click', ()=>{ currentLang = (currentLang === 'fr') ? 'en' : 'fr'; applyLang(); });
    applyLang();

    // ===== Elements =====
    const chooseBtn = document.getElementById('chooseBtn');
    const chooseBtnBig = document.getElementById('chooseBtnBig');
    const fileInput = document.getElementById('fileInput');
    const startBtn  = document.getElementById('startBtn');
    const stage     = document.getElementById('stage');
    const canvas    = document.getElementById('pageCanvas');
    const overlay   = document.getElementById('overlay');
    const ctx       = canvas.getContext('2d', { willReadFrequently: true });
    const octx      = overlay.getContext('2d');
    const hudLabel  = document.getElementById('pageLabel');
    const centerPrompt = document.getElementById('centerPrompt');

    const ocrLangSel = document.getElementById('ocrLang');
    const autoRead   = document.getElementById('autoRead');
    const ocrBar     = document.getElementById('ocrBar');
    const ocrStatus  = document.getElementById('ocrStatus');
    const textOut    = document.getElementById('textOut');
    const showBoxes  = document.getElementById('showBoxes');
    const charFilter = document.getElementById('charFilter');

    // ===== State =====
    let pdfDoc = null, currentPageNum = 1, totalPages = 0, started = false, loading = false, pdfData = null;
    let speakingAllowed = false;
    let currentRenderToken = 0;

    function setHUD(){ hudLabel.textContent = pdfDoc ? `${currentPageNum} / ${totalPages}` : '‚Äî'; }
    async function goFullscreen(){ if (!document.fullscreenElement){ try{ await document.documentElement.requestFullscreen(); }catch(_){ } } }
    function hideCenterPrompt(){ centerPrompt.style.display = 'none'; }
    function setOcrProgress(p){ ocrBar.style.width = Math.max(0, Math.min(100, Math.round(p*100))) + '%'; }

    // ===== Character filter helpers =====
    function normalizeAsciiLetters(s){
      // strip accents: NFD + remove diacritics
      return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }
    function applyCharFilter(s){
      const mode = charFilter.value;
      let t = normalizeAsciiLetters(s);
      if (mode === 'latin'){
        t = t.replace(/[^A-Za-z \t\r\n]/g, '');        // letters + whitespace only
        t = t.replace(/[ \t]+/g, ' ');
      } else if (mode === 'latin+digits'){
        t = t.replace(/[^A-Za-z0-9 .,;:?!'"\-()\[\]\r\n]/g, ''); // keep basic punctuation
        t = t.replace(/[ \t]+/g, ' ');
      }
      return t.trim();
    }
    function currentWhitelist(){
      switch(charFilter.value){
        case 'latin': return 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz '; // letters + space
        case 'latin+digits': return 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 .,;:?!\'"()-[]';
        default:
          // broad but still sane default to reduce noise
          return 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 .,;:?!\'"()-‚Äì‚Äî%[]/';
      }
    }

    // ===== Sanitize general weird chars before filter =====
    function cleanForTTS(s) {
      return (s || '')
        .replace(/[\u200B-\u200D\u2060\uFEFF]/g, '') // zero-width
        .replace(/\u00AD/g, '')                       // soft hyphen
        .replace(/[^\S\r\n]+/g, ' ')                  // collapse spaces
        .trim();
    }

    // Speech
    function speak(text){
      let t = cleanForTTS(text);
      t = applyCharFilter(t);
      if(!speakingAllowed || !t || !('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(t);
      const l = ocrLangSel.value;
      if(l.includes('fra')) u.lang = 'fr-CA';
      else if(l.includes('spa')) u.lang = 'es-ES';
      else if(l.includes('deu')) u.lang = 'de-DE';
      else u.lang = 'en-US';
      window.speechSynthesis.speak(u);
    }
    function stopSpeak(){ window.speechSynthesis?.cancel(); }

    // UI handlers
    chooseBtn.addEventListener('click', ()=> fileInput.click());
    chooseBtnBig.addEventListener('click', ()=> fileInput.click());

    ;['dragenter','dragover'].forEach(ev=>{ window.addEventListener(ev, e=>{ e.preventDefault(); }, {passive:false}); });
    window.addEventListener('drop', async e=>{
      e.preventDefault();
      const file = [...(e.dataTransfer?.files||[])].find(f=>f.type==='application/pdf' || f.name?.toLowerCase().endsWith('.pdf'));
      if (file){ await loadPDFFile(file); }
    });

    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      await loadPDFFile(file);
    });

    async function loadPDFFile(file){
      const arrBuf = await file.arrayBuffer();
      pdfData = new Uint8Array(arrBuf);
      startBtn.disabled = false;
      hideCenterPrompt();
    }

    startBtn.addEventListener('click', async ()=>{
      if (!pdfData) return;
      await goFullscreen();
      started = true;
      speakingAllowed = true;
      await openAndRender();
    });

    async function openAndRender(){
      try{
        const pdfjs = window.__PDFJS__ || window.pdfjsLib;
        if (!pdfjs) throw new Error('pdf.js library not available on window.');
        const loadingTask = pdfjs.getDocument({ data: pdfData });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        currentPageNum = 1;
        await renderPage(currentPageNum);
        setHUD();
      }catch(err){
        console.error('PDF load error:', err);
        const msg = (currentLang==='fr' ? 'Erreur de chargement du PDF: ' : 'PDF load error: ')
                    + (err?.message || err?.toString() || '');
        alert(msg);
      }
    }

    async function extractPdfText(page) {
      const tc = await page.getTextContent();
      const text = tc.items.map(i => (i.str || '')).join(' ');
      return cleanForTTS(text);
    }

    function clearOverlay(){ octx.clearRect(0,0,overlay.width,overlay.height); }
    function drawWordBoxes(words){
      clearOverlay();
      if (!showBoxes.checked || !words) return;
      octx.lineWidth = 2;
      octx.strokeStyle = 'rgba(102,255,153,.85)';
      for (const w of words){
        const b = w.bbox; if (!b) continue;
        octx.strokeRect(b.x0, b.y0, b.x1-b.x0, b.y1-b.y0);
      }
    }

    async function renderPage(pageNum){
      if (!pdfDoc || loading) return;
      loading = true;
      const myToken = ++currentRenderToken;

      try{
        const page = await pdfDoc.getPage(pageNum);
        const viewportUnscaled = page.getViewport({ scale: 1 });
        const availW = window.innerWidth;
        const availH = window.innerHeight;
        const scale = Math.min(availW / viewportUnscaled.width, availH / viewportUnscaled.height);
        const dpr = window.devicePixelRatio || 1;
        const viewport = page.getViewport({ scale: scale * dpr });

        canvas.width  = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        canvas.style.width  = Math.floor(viewport.width / dpr) + 'px';
        canvas.style.height = Math.floor(viewport.height / dpr) + 'px';

        overlay.width  = canvas.width;
        overlay.height = canvas.height;
        overlay.style.width  = canvas.style.width;
        overlay.style.height = canvas.style.height;
        clearOverlay();

        await page.render({ canvasContext: ctx, viewport }).promise;

        // 1) PDF text layer first
        setOcrProgress(0.05);
        ocrStatus.textContent = (currentLang==='fr' ? 'Extraction du texte PDF‚Ä¶' : 'Extracting PDF text‚Ä¶');
        let text = await extractPdfText(page);

        if (myToken !== currentRenderToken) return;

        text = applyCharFilter(text);
        if (text && text.length >= 3){
          textOut.textContent = text;
          ocrStatus.textContent = (currentLang==='fr' ? `Texte PDF (${text.length} caract√®res)` : `PDF text (${text.length} chars)`);
          setOcrProgress(1);
          clearOverlay();
          if (autoRead.checked){ stopSpeak(); speak(text); }
        } else {
          // 2) Fall back to OCR with whitelist based on selection
          setOcrProgress(0.1);
          ocrStatus.textContent = (currentLang==='fr' ? 'OCR en cours‚Ä¶' : 'Running OCR‚Ä¶');

          const lang = ocrLangSel.value || 'eng';
          const whitelist = currentWhitelist();

          const { data } = await Tesseract.recognize(
            canvas,
            lang,
            {
              tessedit_char_whitelist: whitelist,
              tessedit_pageseg_mode: '6',
              preserve_interword_spaces: '1',
              logger: m => { if(m && typeof m.progress === 'number'){ setOcrProgress(Math.max(0.12, m.progress)); } }
            }
          );

          if (myToken !== currentRenderToken) return;

          let cleaned = cleanForTTS((data.text || '').trim());
          cleaned = applyCharFilter(cleaned);

          textOut.textContent = cleaned;
          ocrStatus.textContent = cleaned
            ? (currentLang==='fr' ? `Texte OCR (${cleaned.length} caract√®res)` : `OCR text (${cleaned.length} chars)`)
            : (currentLang==='fr' ? `Aucun texte lisible` : `No readable text`);
          setOcrProgress(1);

          try { drawWordBoxes(data.words); } catch(_) {}

          if (autoRead.checked && cleaned){ stopSpeak(); speak(cleaned); } else { stopSpeak(); }
        }
      }catch(err){
        console.error('Render/Extract/OCR error:', err);
        ocrStatus.textContent = currentLang==='fr' ? 'Erreur d‚Äôextraction/OCR' : 'Extract/OCR error';
      }finally{
        loading = false;
      }
    }

    stage.addEventListener('click', async ()=>{
      if (!started || !pdfDoc || loading) return;
      stopSpeak();
      currentPageNum = (currentPageNum % totalPages) + 1;
      await renderPage(currentPageNum);
      setHUD();
    });

    window.addEventListener('keydown', async (e)=>{
      if (!started || !pdfDoc || loading) return;
      if (e.code === 'Space' || e.code === 'ArrowRight'){
        e.preventDefault();
        stopSpeak();
        currentPageNum = (currentPageNum % totalPages) + 1;
        await renderPage(currentPageNum);
        setHUD();
      } else if (e.code === 'ArrowLeft' || (e.code==='Space' && e.shiftKey)){
        e.preventDefault();
        stopSpeak();
        currentPageNum = (currentPageNum - 2 + totalPages) % totalPages + 1;
        await renderPage(currentPageNum);
        setHUD();
      }
    });

    window.addEventListener('resize', ()=>{
      if (!started || !pdfDoc) return;
      clearTimeout(window.__resizeT);
      window.__resizeT = setTimeout(()=>renderPage(currentPageNum), 100);
    });

    ocrLangSel.addEventListener('change', ()=>{ if(started && pdfDoc) renderPage(currentPageNum); });
    charFilter.addEventListener('change', ()=>{ if(started && pdfDoc) renderPage(currentPageNum); });

    (function init(){ document.getElementById('pageLabel').textContent = '‚Äî'; })();
  </script>
</body>
</html>
