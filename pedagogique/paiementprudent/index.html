<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Porte-monnaie élève</title>

  <style>
/* ---------- THEMING ---------- */
:root{
  --bg-angle:180deg;
  --bg-start:#ffffff;
  --bg-end:#d9ecff;
  --sidePad:clamp(16px,5vw,80px);

  /* facteur d’échelle auto (ajusté par JS pour éviter tout scroll) */
  --uiScale: 1;

  /* Taille responsive (CSS) + variables “snappées” (JS) pour éviter le flou */
  --coinSize: calc(var(--uiScale) * clamp(64px, 8.8vmin, 150px));
  --coinSizeSnap: var(--coinSize);  /* remplacée par JS par un entier px */
  --tileSize: calc(var(--coinSizeSnap) * 0.78); /* tuiles chiffres plus petites que les pièces */
  --coinFont: clamp(14px, calc(var(--tileSize) * 0.42), 30px);

  --gold:#d4af37;--gold-dark:#b78a2c;--gold-light:#f6e27a;
  --green:#2e7d32;--red:#ff0000;

  --f-base:clamp(16px, 1.2rem + 0.5vmin, 20px);
  --lh-base:1.3;

  --btnScale:1.12;
}
body.hc{--green:#007700;--red:#b90000;}
body.readable{--f-base:clamp(18px, 1.3rem + 0.8vmin, 24px);--lh-base:1.5;}

/* ----- Mode avancé : jusqu'à 100$ (pièces plus petites) ----- */
body.advanced-wallet{
  --coinSize: calc(var(--uiScale) * clamp(32px, 4.4vmin, 75px));
}
body.advanced-wallet .counter{font-size: calc(var(--coinFont) * 0.8);}

html,body{
  height:100%;margin:0;
  font-family:Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  background:linear-gradient(var(--bg-angle),var(--bg-start)0%,var(--bg-end)100%);
  overflow:hidden;
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  padding-bottom: env(safe-area-inset-bottom);
}
body{font-size:var(--f-base);line-height:var(--lh-base);}

/* ---------- ADMIN FLOAT BTN ---------- */
#adminBtn{
  position:fixed;left:calc(12px + env(safe-area-inset-left));bottom:clamp(14px,3vh,36px);z-index:2600;
  width:clamp(54px,7vmin,70px);height:clamp(54px,7vmin,70px);border-radius:50%;
  background:linear-gradient(140deg,#2f3e68,#1f2b4d);color:#fff;border:2px solid #dfe6ff;
  box-shadow:0 4px 14px rgba(0,0,0,.16);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:box-shadow .18s,transform .12s,background .18s;
}
#adminBtn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.22);background:linear-gradient(140deg,#324678,#21335a);}
#adminBtn svg{width:64%;height:64%;fill:none;stroke:#fff;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
#adminBtn:active{box-shadow:0 1px 2px #0002;transform:translateY(0);}

/* ---------- FULLSCREEN BTN ---------- */
#fsBtn{
  position:fixed;left:calc(16px + env(safe-area-inset-left));top:calc(16px + env(safe-area-inset-top));z-index:2600;
  width:clamp(40px,5.5vmin,52px);height:clamp(40px,5.5vmin,52px);border-radius:10px;
  background:#4a2c49;color:#fff;border:none;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  box-shadow:0 2px 10px rgba(0,0,0,.12);
  font-size:clamp(16px,2.2vmin,22px);
}
#fsBtn:active{box-shadow:0 1px 2px #0002;}

/* ---------- DRAGGABLE SOURCE COIN ---------- */
.dragSource, .dragSource.dragging{
  width: clamp(56px, 7.5vmin, 120px);
  height: clamp(56px, 7.5vmin, 120px);
  border-radius:50%;
  font-size:0;display:flex;align-items:center;justify-content:center;
  user-select:none;cursor:grab;transition:.13s;
  position:relative;z-index:20;
  background:url('../../images/dollar.png') center/100% 100% no-repeat;
  border:none;
  box-shadow:0 3px 12px rgba(0,0,0,.14);
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

/* ---------- PIN PANELS ---------- */
.pin-panel{
  display:none;position:fixed;left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:min(90vw, 380px);background:#fff;
  box-shadow:2px 8px 20px rgba(0,0,0,.18);
  border-radius:16px;flex-direction:column;
  align-items:center;justify-content:center;
  padding:30px 22px 20px;z-index:5100;
}
.pin-panel.open{display:flex;}
.pin-panel button.close{
  position:absolute;top:18px;right:18px;
  background:transparent;border:none;font-size:2.1rem;
  opacity:.44;cursor:pointer;color:#333;
}
.pin-dots{display:flex;justify-content:center;gap:12px;margin-bottom:14px;font-size:2.2rem;}
.pin-dots .dot{
  width:24px;height:24px;border-radius:50%;background:#eee;
  display:inline-block;box-shadow:0 2px 7px #0002;transition:.1s;
}
.pin-dots .filled{background:#333;}
.pin-dots .wrong{background:var(--red);}
.pin-msg{min-height:28px;color:var(--red);font-size:1.07rem;text-align:center;margin:0 0 4px;}
.pin-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px;}
.pinbtn{
  background:#fafaf8;border:1px solid #e7e2e9;border-radius:8px;
  font-size:1.3rem;padding:18px 0;text-align:center;
  cursor:pointer;user-select:none;transition:.13s;
}
.pinbtn:active{background:#e2e2f1;}
#pinBtnClear,#studentPinBtnClear{color:#888;font-size:1.1rem;}
#pinBtnOk,#studentPinBtnOk{background:#244774;color:#fff;border:none;font-weight:600;}
#studentPinPanel{z-index:10050;}

/* ---------- ADMIN PANEL ---------- */
#adminPanelModal{
  position:fixed;left:0;right:0;bottom:0;width:100vw;height:30vh;min-height:120px;max-height:420px;
  background:rgba(255,255,255,.8);backdrop-filter:blur(8px);
  box-shadow:0 -8px 24px rgba(0,0,0,.15),0 -2px 6px rgba(0,0,0,.1);
  border-top-left-radius:1rem;border-top-right-radius:1rem;
  transform:translateY(110%);transition:transform .35s cubic-bezier(.42,1.41,.36,1.08);
  display:flex;justify-content:space-between;align-items:center;pointer-events:none;z-index:9999;
  padding:0 2rem;
}
#adminPanelModal.open{transform:translateY(0);pointer-events:auto;}
#closeAdminPanel{
  position:absolute;right:16px;top:14px;background:transparent;border:none;
  font-size:2rem;font-weight:400;opacity:.45;color:#333;cursor:pointer;
}
.admin-panel-content{
  width:clamp(320px,95vw,1600px);
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
}
.admin-main{display:flex;gap:clamp(.6rem,1.2vw,1rem);justify-content:center;flex-wrap:wrap;}
#dragCoinArea{display:flex;align-items:center;gap:clamp(.6rem,1.2vw,1rem);justify-self:start;}
#resetAllBtn{justify-self:end;}

/* --- square admin buttons --- */
.admin-option-btn{
  width:clamp(102px,11vmin,138px);
  aspect-ratio:1/1;border-radius:18px;
  background:linear-gradient(180deg,#ffffff,#f4f6ff);
  border:2px solid #d9def2;box-shadow:0 4px 10px #0002;
  font-size:clamp(1rem,1.05rem + .2vmin,1.25rem);font-weight:700;color:#1f2b4d;text-align:center;
  display:flex;align-items:center;justify-content:center;padding:0 10px;
  cursor:pointer;transition:background .15s,transform .1s,box-shadow .15s,color .12s,border-color .15s;
}
.admin-option-btn:hover{background:#eef1ff;transform:translateY(-4px);box-shadow:0 6px 14px #0003;}
.admin-option-btn:active{transform:translateY(0);box-shadow:0 1px 4px #0002;}
.admin-option-btn.toggle.active{background:var(--green);color:#fff;border-color:var(--green);box-shadow:0 5px 14px rgba(46,125,50,.28);} 
#resetAllBtn{background:#e74c3c;color:#fff;border-color:#e74c3c;}
#resetAllBtn:hover{background:#d94836;}

/* ---------- WALLET ---------- */
#walletDropArea{
  border:3px solid #111;border-radius:24px;background:rgba(0,0,0,.02);
  padding:clamp(16px, 2.5vw, 32px) clamp(16px, 3vw, 30px) clamp(16px, 3vw, 24px);
  margin-bottom:clamp(16px,2vh,24px);
  transition:box-shadow .18s,border-color .15s;
  display:flex;flex-direction:column;align-items:center;position:relative;
  width:min(
    calc(100vw - env(safe-area-inset-left) - env(safe-area-inset-right) - 2*var(--sidePad)),
    1200px
  );
  margin-top: clamp(24px, 6vh, 56px);
  gap:clamp(.6rem, 1.6vmin, 1rem);
  max-height:72vh;
  overflow:hidden;
}
#advancedLegend{display:none;}
#advancedLegend .legend-right{text-align:right;}
body.advanced-wallet #advancedLegend{display:none;}
#advancedLegend .legend-left,#advancedLegend .legend-right{display:none;}
#advancedLegend{margin-top:0;}

body.advanced-wallet #walletDropArea{
  margin-top:clamp(12px, 4vh, 28px);
  padding:clamp(10px, 1.6vw, 18px) clamp(12px, 2.6vw, 20px) clamp(10px, 1.6vw, 14px);
  max-height:60vh;
}
body.advanced-wallet .rows{
  gap:clamp(0.5rem, 1vmin, 0.9rem);
  transform:translateY(0);
}
#walletDropArea.droptarget{box-shadow:0 0 0 8px #25cb28aa;border-color:#25cb28;}

.main-content{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:clamp(8px,1.6vmin,20px);}
.rows{display:flex;flex-direction:column;align-items:center;gap:clamp(1rem,2.6vmin,2rem);transform:translateY(2vh);}

/* Wallet grids – BASE (1–10) */
.wallet{display:grid;width:100%;}
#coinsRow{grid-template-columns:repeat(10, var(--coinSizeSnap));justify-content:space-between;align-items:center;}
#countRow{grid-template-columns:repeat(10, var(--tileSize));justify-content:space-between;align-items:center;}
.wallet>*{box-sizing:border-box;margin:0;justify-self:center;align-self:center;}

/* Wallet – ADVANCED (0–99 en groupes de 10) */
body.advanced-wallet .wallet{display:block;width:100%;}
body.advanced-wallet #coinsRow,
body.advanced-wallet #countRow{
  display:grid;
  grid-template-columns:repeat(2, minmax(0,1fr));
  column-gap:clamp(8px,1.4vw,12px);
  row-gap:clamp(2px,0.7vw,6px);
  width:100%;
}
body.advanced-wallet #coinsRow{margin-bottom:2px;}
body.advanced-wallet #countRow{display:none;}
body.advanced-wallet .advanced-column{
  display:flex;
  flex-direction:column;
  gap:clamp(3px,0.7vmin,7px);
}
body.advanced-wallet .coin-line{
  display:grid;
  grid-template-columns:repeat(10, minmax(0,1fr));
  gap:0.5px;
  justify-items:center;
}
body.advanced-wallet .coin-wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:1px;
  min-width:0;
}
body.advanced-wallet .coin-index{
  font-size:calc(var(--coinFont) * 0.55);
  font-weight:700;
  color:#333;
  line-height:1.1;
}
body.advanced-wallet .counter-line{
  display:flex;
  justify-content:center;
  padding:4px 0;
}
body.advanced-wallet .counter{width:min(90%, 180px);text-align:center;}
body.advanced-wallet .counter,
body.advanced-wallet .counter.good,
body.advanced-wallet .counter.bad{
  background:#f6f7f8;
  color:#333;
  border-color:#e0e0e0;
  opacity:1;
}

/* Coins */
.coin{
  width:var(--coinSizeSnap);height:var(--coinSizeSnap);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:0;user-select:none;
  cursor:pointer;transition:transform .15s,box-shadow .15s;
  background:url('../../images/dollar.png') center/100% 100% no-repeat;
  color:#fff9e2;box-shadow:0 3px 12px rgba(0,0,0,.07);position:relative;
  border:none;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  -webkit-font-smoothing: antialiased;
  will-change: transform;
}
.coin.selected{transform:translateY(-8px) scale(1.1);box-shadow:0 0 0 6px rgba(212,175,55,.18);}
.coin:active{transform:translateY(-4px) scale(1.05);}
.coin.placeholder{background:none;border:none;pointer-events:none;box-shadow:none;color:transparent;}
.coin.flyaway{animation:flyaway 2s cubic-bezier(.44,1.43,.64,.98);opacity:0;}
@keyframes flyaway{
  0%{transform:translateY(0) scale(1);opacity:1}
  20%{transform:translateY(-12px) scale(1.12)}
  80%{transform:translateY(-60px) scale(1.15);opacity:.6}
  100%{transform:translateY(-110px) scale(.85);opacity:0}
}

/* Counters */
.counter{
  width:var(--tileSize);height:var(--tileSize);border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  font-size:var(--coinFont);font-weight:800;
  user-select:none;margin:0;
  transition:background .12s,color .12s,border .12s, transform .15s, box-shadow .15s;
  border:3px solid #eee;background:#f6f7f8;color:#444;
}
.counter.good{background:var(--green);color:#fff;border-color:var(--green);}
.counter.bad{background:var(--red);color:#fff;border-color:var(--red);opacity:.88;}

/* ---------- MISC ---------- */
#userName{
  position:fixed;top:calc(env(safe-area-inset-top) + 0.8vh);
  left:50%;transform:translateX(-50%);
  font-size: clamp(1.6rem, 1.5rem + 2.5vw, 4.4rem);
  font-weight:700;text-transform:uppercase;color:#333;z-index:2600;pointer-events:none;
  padding:0 clamp(12px,3vw,36px);text-align:center;max-width:min(90vw,1024px);word-break:break-word;
  letter-spacing:.02em;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:clamp(8px,1.6vmin,14px);
}
#userBalance{
  font-size: clamp(1rem, 0.9rem + 0.9vmin, 1.6rem);
  font-weight:700;
  color:#4a4a4a;
  margin-left:clamp(12px, 1.8vmin, 18px);
}
#startOverlay{position:fixed;inset:0;background:#000;color:#fff;z-index:3000;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
#startOverlay h1{font-size:clamp(1.6rem,2.4vw,2.4rem);margin-bottom:1.2rem;}
#startBtn{padding:clamp(.9rem,1.2vmin,1.1rem) clamp(1.8rem,2.4vmin,2.4rem);font-size:clamp(1.1rem,1rem+0.5vmin,1.3rem);border:none;border-radius:12px;background:#008080;color:#fff;cursor:pointer;}
#startBtn:hover{background:#009d9d;}

.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

#priceZone{
  margin-top: clamp(0.4rem, 2.2vh, 1.2rem);
  display:flex;flex-direction:column;align-items:center;
  gap: clamp(0.6rem, 1.2vmin, 1rem);
  padding:0 clamp(16px,5vw,80px);
  width:min(100%,820px);
}
#actionButtons{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:clamp(0.8rem, 2.4vw, 1rem);
  width:100%;
}
#priceTag{
  font-size: clamp(2.2rem, 1.8rem + 2.6vw, 4.4rem);
  font-weight:800;cursor:pointer;text-align:center;
  transition:transform .15s;
}
#priceTag .price-amount{display:inline-flex;gap:.4rem;align-items:flex-end;}
#priceTag .price-dollar,#priceTag .price-cent{transition:color .2s;}
#priceTag .completed{color:var(--green);}
#priceStatus{min-height:2.4rem;font-size:clamp(1.1rem,1rem+0.3vw,1.4rem);text-align:center;max-width:min(480px,100%);width:100%;}
#priceStatus span{display:block;}
.status-message{padding:.75rem 1rem;border-radius:10px;border:2px solid transparent;}
.status-success{background:#e6f4ea;border-color:#7cc68a;color:#1d6d2c;}
.status-error{background:#fde4e4;border-color:#f29696;color:#a32121;}
.status-info{background:#eef2ff;border-color:#93a5ff;color:#1d2f6d;}

/* Boutons d'action */
#priceButtons{display:flex;justify-content:center;flex-wrap:wrap;width:100%;gap:clamp(0.8rem, 2.4vw, 1rem);}
#priceButtons button{
  min-height: calc(var(--tileSize) * 0.95);
  min-width: clamp(140px, 28vw, 220px);
  width: clamp(140px, 32vw, 240px);
  padding: 0.4rem 1rem;
  font-size: clamp(1.2rem, 1rem + 1vmin, 1.8rem);
  line-height: 1.1;
  border:none;border-radius:14px;color:#fff;cursor:pointer;
}
#verifyBtn{background:#2e7d32;}
#verifyBtn:disabled{background:#9fbca1;cursor:not-allowed;}
#payBtn{background:#c65629;}
#payBtn:disabled,#payBtn.dim{background:#d79a85;cursor:not-allowed;}

#studentSetPriceBtn{
  margin:0;
  min-height: calc(var(--tileSize) * 0.95);
  min-width: clamp(140px, 28vw, 220px);
  width: clamp(140px, 32vw, 240px);
  font-size: clamp(1.1rem, 1rem + 1vmin, 1.6rem);
  line-height: 1.1;
  padding: 0.4rem 1rem;
  border-radius:12px;border:2px solid #244774;background:#fff;color:#244774;
  cursor:pointer;transition:transform .1s,background .1s,color .1s;
  text-align:center;
}
#studentSetPriceBtn:active{transform:scale(.97);}
#studentSetPriceBtn.active{background:#244774;color:#fff;}

body.advanced-wallet #priceZone{
  gap: clamp(0.4rem, 1vmin, 0.7rem);
}
body.advanced-wallet #priceTag{
  font-size: clamp(1.7rem, 1.3rem + 1.6vw, 3.1rem);
}
body.advanced-wallet #priceStatus{
  min-height:1.8rem;
  font-size:clamp(0.95rem, 0.85rem + 0.5vw, 1.2rem);
}
body.advanced-wallet #actionButtons{
  flex-direction:row;
  justify-content:center;
  flex-wrap:wrap;
  gap:clamp(0.4rem, 1.2vw, 0.8rem);
}
body.advanced-wallet #priceButtons{
  flex-wrap:nowrap;
  width:auto;
  gap:clamp(0.4rem, 1.2vw, 0.8rem);
}
body.advanced-wallet #priceButtons button,
body.advanced-wallet #studentSetPriceBtn{
  min-width: clamp(110px, 18vw, 160px);
  width: clamp(110px, 18vw, 170px);
  font-size: clamp(1rem, 0.85rem + 0.8vmin, 1.3rem);
}

/* Modales génériques */
.modalBox{
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:clamp(320px,90vw,480px);background:#fff;border:2px solid teal;padding:20px;border-radius:10px;z-index:4000;text-align:center;
}
.modalBox p{margin:0 0 15px;font-size:1.3rem;}
.modalBox input{width:100%;padding:10px;margin:10px 0;font-size:1.2rem;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;}
.modalBtnRow{display:flex;gap:10px;justify-content:center;margin-top:10px;}
.modalBtnRow button{flex:1;padding:10px;font-size:1rem;border:none;border-radius:6px;cursor:pointer;}
.btnPrimary{background:teal;color:#fff;}
.btnSecondary{background:#ccc;}

/* Confirm dialog vertical buttons */
#confirmModal .modalBtnRow{
  flex-direction:column;
  width:100%;
  gap:10px;
}

/* ---------- PRICE MODAL (ADMIN) ---------- */
#priceModal{
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:clamp(320px,90vw,560px);background:#fff;border:2px solid teal;border-radius:14px;
  padding:24px 22px;z-index:10100;text-align:center;box-sizing:border-box;
  flex-direction:column;align-items:center;gap:16px;
}
#priceModal h2{margin:0;font-size:clamp(1.2rem,1rem+0.8vmin,1.6rem);font-weight:700;}
.price-select-row{display:flex;justify-content:center;gap:24px;flex-wrap:wrap;width:100%;}
@media(max-width:560px){.price-select-row{flex-direction:column;align-items:center;}}
.price-col{display:flex;flex-direction:column;align-items:center;}
.price-col-label{font-size:1.05rem;font-weight:700;margin-bottom:6px;text-align:center;}

#priceDollarGrid,#priceCentGrid{display:grid;gap:10px;}
#priceDollarGrid{grid-template-columns:repeat(2,1fr);}
#priceCentGrid{grid-template-columns:1fr;}

#priceDollarGrid button,#priceCentGrid button{
  min-width:clamp(64px, 9vmin, 100px);
  padding:clamp(12px,1.2vmin,16px) 0;
  font-size:clamp(1.05rem,1rem+0.6vmin,1.35rem);
  border-radius:10px;border:1.7px solid #e2e2e2;background:#f7f6fb;cursor:pointer;
  transition:transform .12s,background .11s;
}
#priceDollarGrid button:hover,#priceCentGrid button:hover,
#priceDollarGrid button:active,#priceCentGrid button:active{
  transform:scale(var(--btnScale));
}
#priceDollarGrid button.selected,#priceCentGrid button.selected{
  background:var(--green);color:#fff;border-color:var(--green);
}
#pricePreview{font-size:1.1rem;}

/* ====== Pulse visuel (prix) ====== */
#priceTag.price-speaking{ animation: pricePulse 900ms ease; }
@keyframes pricePulse{
  0%{ transform:scale(1); text-shadow:0 0 0 rgba(36,71,116,0); }
  30%{ transform:scale(1.04); text-shadow:0 0 16px rgba(36,71,116,.28); }
  70%{ transform:scale(1.02); text-shadow:0 0 10px rgba(36,71,116,.18); }
  100%{ transform:scale(1); text-shadow:0 0 0 rgba(36,71,116,0); }
}

/* ====== Pulse visuel (tuiles chiffres) ====== */
.counter.tap-pulse{ animation: tilePulse 700ms ease; }
@keyframes tilePulse{
  0%{ transform:scale(1); box-shadow:0 0 0 rgba(0,0,0,0); }
  35%{ transform:scale(1.06); box-shadow:0 10px 18px rgba(0,0,0,.12); }
  100%{ transform:scale(1); box-shadow:0 0 0 rgba(0,0,0,0); }
}

@keyframes shakeX16{
  0%,100%{transform:translateX(0)}
  15%,45%,75%{transform:translateX(-16px)}
  30%,60%,90%{transform:translateX(16px)}
}
@keyframes denyCoin{
  0%{transform:translateX(0)}
  25%{transform:translateX(-8px)}
  50%{transform:translateX(8px)}
  75%{transform:translateX(-8px)}
  100%{transform:translateX(0)}
}

/* ---- Adjust setupModal layout ---- */
#setupModal {flex-direction: column;align-items: center;}
#setupModal p {margin-bottom: 12px;}
#setupModal input {margin-bottom: 12px;width: 100%;}
#setupModal .modalBtnRow {flex-direction: column;width: 100%;gap: 10px;}

/* ---------- STUDENT PRICE CALCULATOR MODAL ---------- */
#studentPriceModal{
  width:clamp(360px, 90vw, 520px);
  flex-direction:column;
  align-items:center;
  z-index:11200;
}
#studentCalcTitle{
  margin:0 0 12px;
  font-size:1.3rem;
  font-weight:600;
  text-align:center;
}
#studentCalcDisplay{
  width:100%;
  text-align:center;
  margin-top:12px;
  background:#f9fbff;
  border:1px solid #e5e7f3;
  border-radius:12px;
  padding:10px 12px 12px;
  box-shadow:0 2px 6px #0001 inset;
}
#studentCalcExpression{
  font-size:1rem;
  font-weight:600;
  margin-bottom:6px;
  color:#3c3c3c;
  min-height:1.2em;
}
#studentCalcSubtotal{
  font-size:2rem;
  margin-top:0;
  color:#0a2b6b;
  font-weight:700;
  line-height:1.15;
}
#studentCalcTaxesNote{
  font-size:0.95rem;
  color:#4c4c4c;
  margin-top:4px;
}
#studentCalcKeypad{
  width:100%;
  max-width:320px;
  margin:4px auto 4px;
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:10px;
}
.studentCalcBtn{
  padding:12px 0;
  font-size:1.1rem;
  border-radius:10px;
  border:1px solid #e0e0e0;
  background:#f7f7fb;
  cursor:pointer;
  font-weight:600;
}
.studentCalcBtn:active{
  background:#e0e4ff;
}
.studentCalcBtn.wide{grid-column:span 2;}
.studentCalcBtn.small{
  font-size:1rem;
  padding:10px 0;
}
.studentCalcBtn.tax-btn{
  font-size:0.95rem;
  padding:8px 0;
}
.studentCalcBtn.tax-btn.tax-on{
  background:#e3f7e5;
  border-color:#8bd49a;
  color:#0a6b2b;
}
.studentCalcBtn.tax-btn.tax-off{
  background:#ffe8e8;
  border-color:#efb2b2;
  color:#a40000;
}
.studentCalcBtn.op-btn{
  background:#eef2ff;
  border-color:#d3d9ff;
}
.studentCalcBtn.op-btn:active{
  background:#d8dfff;
}

/* couleurs et placement pour EFFACER / OK */
.studentCalcBtn.clear-btn{
  background:#ffe3e3;
  border-color:#f5a4a4;
  color:#a40000;
}
.studentCalcBtn.clear-btn:active{background:#f8caca;}
.studentCalcBtn.ok-btn{
  background:#e3f7e5;
  border-color:#8bd49a;
  color:#0a6b2b;
}
.studentCalcBtn.ok-btn:active{background:#c2ebc7;}
  </style>
</head>
<body>

  <div id="userName">
    <span id="userNameText"></span>
    <span id="userBalance"></span>
  </div>

  <div id="startOverlay">
    <h1>Paiement prudent</h1>
    <button id="startBtn">COMMENCER</button>
  </div>

  <button id="fsBtn" title="Plein écran">⛶</button>

  <button id="adminBtn" title="Admin">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" />
      <path d="M19.4 13.5c.07-.47.1-.95.1-1.45 0-.5-.03-.98-.1-1.45l2-.98-2-3.46-2.26 1.07a7.5 7.5 0 0 0-2.5-1.45L14.3 2h-4.6l-.34 2.78a7.5 7.5 0 0 0-2.5 1.45L4.6 6.16l-2 3.46 2 .98c-.06.47-.1.95-.1 1.45 0 .5.04.98.1 1.45l-2 .98 2 3.46 2.26-1.07c.74.61 1.6 1.1 2.5 1.45l.34 2.78h4.6l.34-2.78c.9-.35 1.76-.84 2.5-1.45l2.26 1.07 2-3.46-2-.98Z" />
    </svg>
  </button>

  <!-- ---------- PIN PANELS ---------- -->
  <div id="adminPinPanel" class="pin-panel">
    <button class="close" id="adminPinClose">×</button>
    <div style="width:200px;max-width:96vw;">
      <div id="adminPinTitle" style="font-weight:600;margin-bottom:16px;text-align:center;">Entrer le code admin</div>
      <div id="pinMsg" class="pin-msg"></div>
      <div id="pinDots" class="pin-dots">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
      <div id="pinKeypad" class="pin-keypad"></div>
    </div>
  </div>

  <div id="studentPinPanel" class="pin-panel">
    <button class="close" id="studentPinClose">×</button>
    <div style="width:200px;max-width:96vw;">
      <div style="font-weight:600;margin-bottom:16px;text-align:center;">Entrer le NIP élève</div>
      <div id="studentPinMsg" class="pin-msg"></div>
      <div id="studentPinDots" class="pin-dots">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
      <div id="studentPinKeypad" class="pin-keypad"></div>
    </div>
  </div>

  <!-- ---------- ADMIN PANEL ---------- -->
  <div id="adminPanelModal">
    <button id="closeAdminPanel" title="Fermer">×</button>
    <div class="admin-panel-content">
      <div id="dragCoinArea">
        <div class="dragSource" data-value="1" tabindex="0" aria-label="Ajouter une pièce de 1$"></div>
      </div>
      <div class="admin-main">
        <button id="setPriceBtn"         class="admin-option-btn">Combien<br>ça coûte?</button>
        <button id="studentPinToggleBtn" class="admin-option-btn toggle">NIP<br>élève</button>
        <button id="payDirectToggleBtn"  class="admin-option-btn toggle">Paiement<br>direct</button>
        <button id="advancedModeToggleBtn" class="admin-option-btn toggle">Version<br>avancée</button>
      </div>
      <button id="resetAllBtn" class="admin-option-btn">Tout<br>réinitial.</button>
    </div>
  </div>

  <!-- ---------- MAIN ---------- -->
  <div class="main-content">
    <div class="rows">
      <div id="walletDropArea">
        <div class="wallet" id="coinsRow"></div>
        <div class="wallet" id="countRow"></div>
        <div id="advancedLegend" aria-hidden="true"></div>
      </div>
      <div id="priceZone">
        <div id="priceTag" tabindex="0" role="button" aria-label="Prix actuel"></div>
        <div id="priceStatus" aria-live="polite" role="status"></div>
        <div id="actionButtons">
          <div id="priceButtons">
            <button id="verifyBtn">VÉRIFIER</button>
            <button id="payBtn">PAYER</button>
          </div>
          <button id="studentSetPriceBtn">Combien ça coûte?</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ---------- GENERIC MODALS ---------- -->
  <div id="setupModal"   class="modalBox">
    <p>Paramétrage initial</p>
    <input id="setupName" placeholder="Prénom de l'élève (optionnel)">
    <div class="modalBtnRow"><button id="setupOk" class="btnPrimary">OK</button></div>
  </div>
  <div id="alertModal"   class="modalBox"><p id="alertMsg"></p><div class="modalBtnRow"><button id="alertOk" class="btnPrimary">OK</button></div></div>
  <div id="confirmModal" class="modalBox"><p id="confirmMsg"></p><div class="modalBtnRow"><button id="confirmYes" class="btnPrimary">Oui</button><button id="confirmNo" class="btnSecondary">Non</button></div></div>

  <!-- ---------- STUDENT PRICE CALCULATOR MODAL ---------- -->
  <div id="studentPriceModal" class="modalBox">
    <p id="studentCalcTitle">Combien ça coûte?</p>
    <div id="studentCalcKeypad"></div>
    <div id="studentCalcDisplay">
      <div id="studentCalcExpression">0,00</div>
      <div id="studentCalcSubtotal">0,00 $</div>
      <div id="studentCalcTaxesNote">Taxes incluses</div>
    </div>
  </div>

  <!-- ---------- PRICE MODAL (ADMIN) ---------- -->
  <div id="priceModal">
    <h2>Choisissez le prix</h2>
    <div class="price-select-row">
      <div class="price-col">
        <div class="price-col-label">Dollars</div>
        <div id="priceDollarGrid"></div>
      </div>
      <div class="price-col">
        <div class="price-col-label">Cents</div>
        <div id="priceCentGrid"></div>
      </div>
    </div>
    <div id="pricePreview"></div>
    <div class="modalBtnRow">
      <button id="priceConfirm" class="btnPrimary">OK</button>
      <button id="priceCancel" class="btnSecondary">Annuler</button>
    </div>
  </div>

  <!-- ---------- SCRIPT ---------- -->
  <script>
const $ = id => document.getElementById(id);

// STATE
const stored       = parseFloat(localStorage.getItem('itemPrice'));
let price          = isNaN(stored) ? 1 : +stored.toFixed(2);
let coins          = +localStorage.getItem('studentCoins') || 0;
let adminPin       = (localStorage.getItem('adminPin')||'').trim();
let studentPin     = (localStorage.getItem('studentPin')||'').trim();
let studentPinActive   = localStorage.getItem('studentPinActive')==='1';
let payDirect          = localStorage.getItem('payDirect')==='1';
let studentName        = (localStorage.getItem('studentName')||'').trim();
let advancedMode       = localStorage.getItem('advancedMode')==='1';

const selected = new Set();
const BACKUP_PIN = '8204';
const priceTagEl = $('priceTag');
const priceStatusEl = $('priceStatus');
const verifyBtn = $('verifyBtn');
const studentSetPriceBtn = $('studentSetPriceBtn');
const userNameTextEl = $('userNameText');
const userBalanceEl = $('userBalance');
let statusTimer=null;
let currentStatusSource=null;

// TAX RATE
const TAX_RATE = 0.14975;

const supportsSpeech = 'speechSynthesis' in window && typeof SpeechSynthesisUtterance === 'function';
function speak(text){
  if(!supportsSpeech || !text) return;
  try{
    window.speechSynthesis.cancel();
    const utter=new SpeechSynthesisUtterance(text);
    utter.lang='fr-CA';
    utter.rate=0.95;
    window.speechSynthesis.speak(utter);
  }catch{}
}

/* ---- VISUELS ----- */
function pulsePrice(){
  priceTagEl.classList.remove('price-speaking');
  void priceTagEl.offsetWidth;
  priceTagEl.classList.add('price-speaking');
  setTimeout(()=>priceTagEl.classList.remove('price-speaking'), 950);
}
function pulseCounter(el){
  el.classList.remove('tap-pulse');
  void el.offsetWidth;
  el.classList.add('tap-pulse');
  setTimeout(()=>el.classList.remove('tap-pulse'), 720);
}

function clearStatus(source=null){
  if(source && currentStatusSource!==source) return;
  priceStatusEl.className='';
  priceStatusEl.textContent='';
  if(statusTimer){ clearTimeout(statusTimer); statusTimer=null; }
  currentStatusSource=null;
  if(source!=='selection' && typeof updateSelectionStatus==='function') updateSelectionStatus();
}

function showStatus(message,type='info',options={}){
  const {speakText=false,timeout=6000,source='general'}=options;
  currentStatusSource=source;
  priceStatusEl.className=`status-message status-${type}`;
  priceStatusEl.textContent='';
  const span=document.createElement('span');
  span.textContent=message;
  priceStatusEl.appendChild(span);
  if(speakText) speak(message);
  if(statusTimer){ clearTimeout(statusTimer); statusTimer=null; }
  if(timeout){
    statusTimer=setTimeout(()=>{ clearStatus(source); },timeout);
  }
}

function describePrice(){
  const [dStr,cStr]=price.toFixed(2).split('.');
  const dollars=parseInt(dStr,10);
  const cents=parseInt(cStr,10);
  const parts=[];
  if(dollars>0) parts.push(`${dollars} ${dollars>1?'dollars':'dollar'}`);
  if(cents>0) parts.push(`${cents} ${cents>1?'cents':'cent'}`);
  if(parts.length===0) parts.push('0 dollar');
  return parts.join(' et ');
}

function formatDollarCount(count){
  return `${count} ${count>1?'dollars':'dollar'}`;
}

function updateUserHeader(){
  if(userNameTextEl){
    userNameTextEl.textContent = studentName ? studentName.toUpperCase() : '';
  }
  if(userBalanceEl){
    userBalanceEl.textContent = `j'ai ${formatDollarCount(coins)}`;
  }
}

function speakPrice(){
  pulsePrice();
  speak(`Le prix est de ${describePrice()}.`);
}

priceTagEl.addEventListener('click',speakPrice);
priceTagEl.addEventListener('keydown',e=>{
  if(e.key==='Enter'||e.key===' '){ e.preventDefault(); speakPrice(); }
});

// AUDIO FEEDBACK
const sndNotEnough      = new Audio('../../sounds/paiement/error2.mp3');
const sndNoCoinSelected = new Audio('../../sounds/paiement/error3.mp3');
const sndAdd1           = new Audio('../../sounds/paiement/onecoin.mp3');
const sndPaySuccess     = new Audio('../../sounds/paiement/cashing machine.mp3');
const sndPinPress       = new Audio('../../sounds/paiement/beep.mp3');
sndPinPress.volume = 0.3;
function playSound(a){
  try{
    a.pause();
    a.currentTime = 0;
    a.play();
  }catch{}
}

function addCoins(val){
  let maxCoins = advancedMode ? 100 : 10;
  if(!advancedMode && coins + val > maxCoins){
    setAdvancedMode(true);
    maxCoins = 100;
  }
  if(coins + val <= maxCoins){
    coins += val;
    saveRender();
    if(val===1){
      playSound(sndAdd1);
    }
    return true;
  }
  alertBox('Porte-monnaie plein !');
  return false;
}

// HELPERS
function show(el){ el.style.display='flex'; }
function hide(el){ el.style.display='none'; }
function alertBox(m,cb){ $('alertMsg').textContent=m; show($('alertModal')); $('alertOk').onclick=()=>{ hide($('alertModal')); cb&&cb(); }; }
function confirmBox(m,yes){ $('confirmMsg').textContent=m; show($('confirmModal')); $('confirmYes').onclick=()=>{ hide($('confirmModal')); yes(); }; $('confirmNo').onclick=()=>hide($('confirmModal')); }

const isiIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
function enterFS(){ if(isiIOS||document.fullscreenElement)return; document.documentElement.requestFullscreen?.().catch(()=>{}); }
function exitFS(){ if(document.fullscreenElement) document.exitFullscreen?.(); }
function toggleFS(){ document.fullscreenElement ? exitFS() : enterFS(); }
function displayName(){
  updateUserHeader();
}

// INITIAL SETUP
function openSetup(){ show($('setupModal')); $('setupName').focus(); }
$('setupOk').onclick = () => {
  const n = $('setupName').value.trim();
  if(n){ studentName = n; localStorage.setItem('studentName', studentName); displayName(); }
  localStorage.setItem('setupDone','1');
  hide($('setupModal'));
  if(!adminPin) showPinPanel(true);
  else enterFS();
};

/* ---------- COINS + COUNTERS GRID BUILDERS ---------- */

// Base : 1–10 avec un compteur par pièce (1,2,3,...,10)
function buildWalletSimple(){
  const coinsRow = $('coinsRow');
  const countRow = $('countRow');
  coinsRow.innerHTML = '';
  countRow.innerHTML = '';
  countRow.style.display = 'grid';

  for(let i=0;i<10;i++){
    const coin=document.createElement('div');
    coin.className='circle coin placeholder';
    coin.dataset.idx=i;
    coin.setAttribute('aria-label','Pièce de 1 dollar');
    coin.addEventListener('pointerdown',toggleSelect);
    coinsRow.appendChild(coin);

    const counter=document.createElement('div');
    counter.className='counter bad';
    counter.dataset.threshold = (i+1).toString();  // 1,2,...,10
    counter.textContent=i+1;
    counter.addEventListener('pointerdown',()=>pulseCounter(counter));
    countRow.appendChild(counter);
  }
}

// Avancé : jusqu’à 100 pièces, en groupes de 10, compteurs par dizaines (10,20,...,100)
function buildWalletAdvanced(){
  const coinsRow = $('coinsRow');
  const countRow = $('countRow');
  coinsRow.innerHTML = '';
  countRow.innerHTML = '';
  countRow.style.display = 'none';

  const COLUMNS = 2;
  const LINES_PER_COLUMN = 5;
  const PER_LINE = 10;

  for(let col=0; col<COLUMNS; col++){
    const column = document.createElement('div');
    column.className = 'advanced-column';

    for(let line=0; line<LINES_PER_COLUMN; line++){
      const coinLine = document.createElement('div');
      coinLine.className = 'coin-line';

      const startIdx = col*LINES_PER_COLUMN*PER_LINE + line*PER_LINE;

      for(let j=0;j<PER_LINE;j++){
        const idx = startIdx + j;
        const wrap = document.createElement('div');
        wrap.className = 'coin-wrap';

        const coin = document.createElement('div');
        coin.className = 'circle coin placeholder';
        coin.dataset.idx = idx;
        coin.setAttribute('aria-label','Pièce de 1 dollar');
        coin.addEventListener('pointerdown',toggleSelect);

        const label = document.createElement('div');
        label.className = 'coin-index';
        label.textContent = idx + 1;

        wrap.appendChild(coin);
        wrap.appendChild(label);
        coinLine.appendChild(wrap);
      }

      column.appendChild(coinLine);
    }

    coinsRow.appendChild(column);
  }
}

/* ---------- COIN INTERACTION ---------- */
function deny(el){ el.style.animation='denyCoin .4s'; setTimeout(()=>el.style.animation='',400); }
function toggleSelect(e){
  if(payDirect) return;
  const idx=+e.currentTarget.dataset.idx;
  if(idx>=coins){ deny(e.currentTarget); return; }
  if(selected.has(idx)){
    selected.delete(idx);
  } else {
    selected.add(idx);
  }
  render();
}

// RENDER
const payNeeded=()=>Math.ceil(price);
const getCommitted=()=> payDirect ? coins : selected.size;

function updateSelectionStatus(){
  if(currentStatusSource && currentStatusSource!=='selection') return;
  if(payDirect){
    if(currentStatusSource==='selection') clearStatus('selection');
    return;
  }
  const need=payNeeded();
  if(selected.size>need){
    showStatus("Attention, tu n'as pas besoin d'autant de dollars pour payer.",'info',{source:'selection',timeout:null});
  } else if(currentStatusSource==='selection'){
    clearStatus('selection');
  }
}

function render(){
  updateUserHeader();

  // Coins
  document.querySelectorAll('.coin').forEach(el=>{
    const idx = +el.dataset.idx;
    if(idx < coins){
      el.className='circle coin'+(selected.has(idx)?' selected':'');
      el.innerHTML='<span class="sr-only">Pièce de 1 dollar</span>';
    } else {
      el.className='circle coin placeholder';
      el.textContent='';
      el.innerHTML='';
    }
  });

  // Counters: basés sur data-threshold
  document.querySelectorAll('.counter').forEach(el=>{
    const threshold = parseInt(el.dataset.threshold || '0',10);
    el.className = 'counter ' + (coins >= threshold ? 'good' : 'bad');
  });

  const [dStr,cStr]=price.toFixed(2).split('.');
  const cents=parseInt(cStr,10);
  const dollars=parseInt(dStr,10);
  const committed=getCommitted();
  const dollarNeed=Math.max(dollars,0);
  const dollarClass=(dollarNeed===0||committed>=dollarNeed)?'price-dollar completed':'price-dollar';
  const centClass=(cents>0 && committed>=dollarNeed+1)?'price-cent completed':'price-cent';
  priceTagEl.innerHTML=`Prix : <span class="price-amount"><span class="${dollarClass}">${dStr}</span><span class="price-separator">.</span><span class="${centClass}">${cStr}</span> $</span>`;
  priceTagEl.setAttribute('aria-label',`Prix actuel : ${describePrice()}`);
  $('payBtn').classList.toggle('dim', !payDirect && selected.size < payNeeded());
  updateSelectionStatus();
}
function save(){
  localStorage.setItem('studentCoins', coins);
  localStorage.setItem('itemPrice', price.toFixed(2));
}
function maybeDowngradeAdvancedMode(){
  if(advancedMode && coins <= 10){
    setAdvancedMode(false);
    return true;
  }
  return false;
}
function saveRender(){
  save();
  selected.clear();
  if(maybeDowngradeAdvancedMode()) return;
  render();
}

// PAYMENT
$('payBtn').onclick = ()=>{
  const need = payNeeded();
  if(payDirect){
    if(coins<need){
      playSound(sndNotEnough);
      const diff=need-coins;
      const msg=diff===1?"Il te manque 1 dollar.":`Il te manque ${diff} dollars.`;
      showStatus(msg,'error',{source:'pay'});
      shake(true);
      return;
    }
    const proceed=()=>payDirectFlow();
    studentPinActive ? showStudentPinPanel(false,proceed) : proceed();
  } else {
    if(selected.size===0){
      playSound(sndNoCoinSelected);
      showStatus('Sélectionne au moins une pièce.','info',{source:'pay'});
      shake(true);
      return;
    }
    if(selected.size<need){
      playSound(sndNotEnough);
      const diff=need-selected.size;
      const msg=diff===1?"Il te manque 1 dollar.":`Il te manque ${diff} dollars.`;
      showStatus(msg,'error',{source:'pay'});
      shake(true);
      return;
    }
    const proceed=()=>paySelectedFlow();
    studentPinActive ? showStudentPinPanel(false,proceed) : proceed();
  }
};

verifyBtn.addEventListener('click',()=>{
  const need=payNeeded();
  if(payDirect){
    if(coins>=need){
      const remaining = coins - need;
      showStatus(`Il te resterait ${formatAmountFr(remaining)}.`,'success',{source:'verify',speakText:true});
    } else {
      const diff=need-coins;
      const msg=diff===1?"Il te manque 1 dollar.":`Il te manque ${diff} dollars.`;
      showStatus(msg,'error',{source:'verify',speakText:true});
    }
    return;
  }
  if(selected.size===0){
    showStatus('Sélectionne au moins une pièce.','info',{source:'verify',speakText:true});
    return;
  }
  if(selected.size>=need){
    const remaining = coins - need;
    showStatus(`Il te resterait ${formatAmountFr(remaining)}.`,'success',{source:'verify',speakText:true});
  } else {
    const diff=need-selected.size;
    const msg=diff===1?"Il te manque 1 dollar.":`Il te manque ${diff} dollars.`;
    showStatus(msg,'error',{source:'verify',speakText:true});
  }
});
function shake(clear=false){
  $('payBtn').style.animation='shakeX16 .6s';
  setTimeout(()=>{
    $('payBtn').style.animation='';
    if(clear){ selected.clear(); render(); }
  },600);
}

const payDirectFlow = ()=>{
  const count = payNeeded();
  const idx = Array.from({length: count}, (_,i)=> coins - 1 - i);
  animateCoins(idx, ()=>{
    coins -= count; saveRender(); playSound(sndPaySuccess); showStatus('Paiement réussi !','success',{source:'pay'});
  });
};

const paySelectedFlow = ()=>{ animateCoins([...selected],()=>{
  coins -= payNeeded(); selected.clear(); saveRender(); playSound(sndPaySuccess); showStatus('Paiement réussi !','success',{source:'pay'});
}); };

// ADMIN PIN
const adminBtnEl = $('adminBtn');
const fsBtnEl    = $('fsBtn');
const adminPanelModalEl = $('adminPanelModal');
const adminPinPanelEl = $('adminPinPanel');
const adminPinCloseEl = $('adminPinClose');
const pinDotsEl = $('pinDots');
const pinMsgEl = $('pinMsg');
const pinKeypadEl = $('pinKeypad');
let pinEntry='', setPinSetMode=false;

function showPinPanel(setMode=false){
  pinEntry=''; pinMsgEl.textContent='';
  renderPinDots();
  $('adminPinTitle').textContent = setMode ? 'Créer le code admin' : 'Entrer le code admin';
  adminPinPanelEl.classList.add('open');
  setPinSetMode = setMode;
}
function hidePinPanel(){
  adminPinPanelEl.classList.remove('open');
  pinEntry=''; setPinSetMode=false;
}
function renderPinDots(err=false){
  pinDotsEl.querySelectorAll('.dot').forEach((d,i)=>{
    d.className='dot';
    if(err&&i<pinEntry.length) d.classList.add('wrong');
    else if(i<pinEntry.length) d.classList.add('filled');
  });
}
function unlockAdminPanel(){
  hidePinPanel();
  adminPanelModalEl.classList.add('open');
}
adminBtnEl.onclick = ()=>{
  adminPanelModalEl.classList.contains('open')
    ? adminPanelModalEl.classList.remove('open')
    : showPinPanel(adminPin==='');
};
fsBtnEl.addEventListener('pointerdown',e=>e.stopPropagation());
fsBtnEl.onclick = toggleFS;
$('closeAdminPanel').onclick = ()=>adminPanelModalEl.classList.remove('open');
adminPinCloseEl.onclick = hidePinPanel;

function finishPinCreation(){
  if(pinEntry.length<4){
    pinMsgEl.textContent='4 chiffres minimum';
    renderPinDots(true);
    setTimeout(renderPinDots,800);
    return;
  }
  adminPin = pinEntry;
  localStorage.setItem('adminPin', adminPin);
  pinMsgEl.textContent='Code enregistré !';
  setTimeout(()=>{
    hidePinPanel();
    adminPanelModalEl.classList.add('open');
  },600);
}
function handlePinInput(v){
  if(v==='clear'){
    pinEntry=''; renderPinDots(); pinMsgEl.textContent=''; return;
  }
  if(v==='ok'){
    if(setPinSetMode){ finishPinCreation(); return; }
    if(pinEntry===adminPin||pinEntry===BACKUP_PIN) unlockAdminPanel();
    else {
      pinMsgEl.textContent='Code incorrect';
      renderPinDots(true);
      setTimeout(()=>{
        pinEntry=''; renderPinDots(); pinMsgEl.textContent='';
      },900);
    }
    return;
  }
  if(pinEntry.length<8){
    pinEntry+=v; renderPinDots();
    if(!setPinSetMode&&pinEntry.length===4){
      if(pinEntry===adminPin||pinEntry===BACKUP_PIN){
        setTimeout(unlockAdminPanel,180);
      } else {
        pinMsgEl.textContent='Code incorrect';
        renderPinDots(true);
        setTimeout(()=>{
          pinEntry=''; renderPinDots(); pinMsgEl.textContent='';
        },900);
      }
    }
  }
}
(()=>{
  let h='';
  for(let i=1;i<=9;i++) h+=`<button class="pinbtn" data-v="${i}">${i}</button>`;
  h+=`<button class="pinbtn" id="pinBtnClear" data-v="clear">C</button>
      <button class="pinbtn" data-v="0">0</button>
      <button class="pinbtn" id="pinBtnOk" data-v="ok">OK</button>`;
  pinKeypadEl.innerHTML=h;
  pinKeypadEl.addEventListener('click',e=>{
    const v=e.target.getAttribute('data-v');
    if(v!==null){
      playSound(sndPinPress);
      handlePinInput(v);
    }
  });
})();

// ADMIN OPTIONS
const studentPinToggleBtn = $('studentPinToggleBtn');
const payDirectToggleBtn  = $('payDirectToggleBtn');
const advancedModeToggleBtn = $('advancedModeToggleBtn');

function updateToggles(){
  studentPinToggleBtn.classList.toggle('active',studentPinActive);
  payDirectToggleBtn.classList.toggle('active',payDirect);
  if(advancedModeToggleBtn){
    advancedModeToggleBtn.classList.toggle('active',advancedMode);
  }
}
function setAdvancedMode(enabled){
  if(advancedMode===enabled) return;
  advancedMode = enabled;
  localStorage.setItem('advancedMode', advancedMode ? '1' : '0');
  updateToggles();
  applyAdvancedMode();
}
function applyAdvancedMode(){
  document.body.classList.toggle('advanced-wallet', advancedMode);
  selected.clear();
  if(advancedMode) buildWalletAdvanced();
  else buildWalletSimple();
  render();
  requestAnimationFrame(autoScaleToViewport);
}
updateToggles();
applyAdvancedMode();

studentPinToggleBtn.onclick = ()=>{
  studentPinActive = !studentPinActive;
  localStorage.setItem('studentPinActive', studentPinActive ? '1' : '0');

  if (studentPinActive){
    awaitingStudentPin=true;
    showStudentPinPanel(true);
  } else {
    awaitingStudentPin=false;
  }

  if (studentPinActive) showStudentPinPanel(true);

  updateToggles();
};

payDirectToggleBtn.onclick = ()=>{
  payDirect = !payDirect;
  localStorage.setItem('payDirect', payDirect?'1':'0');
  if(payDirect) selected.clear();
  updateToggles(); render();
};

advancedModeToggleBtn.onclick = ()=>{
  setAdvancedMode(!advancedMode);
};

$('resetAllBtn').onclick = ()=>confirmBox('Tout effacer et réinitialiser ?',()=>{
  localStorage.clear();
  location.reload();
});

// STUDENT PIN
const studentPinPanelEl = $('studentPinPanel');
const studentPinCloseEl = $('studentPinClose');
const studentPinDotsEl  = $('studentPinDots');
const studentPinMsgEl   = $('studentPinMsg');
const studentPinKeypadEl= $('studentPinKeypad');
let studentPinEntry='', studentPinSetMode=false, studentPinSuccessCallback=null;
let awaitingStudentPin=false;
studentPinPanelEl.addEventListener('pointerdown', e => e.stopPropagation());

function showStudentPinPanel(setMode=false,cb=null){
  studentPinEntry=''; studentPinMsgEl.textContent='';
  renderStuDots();
  studentPinPanelEl.classList.add('open');
  studentPinSetMode = setMode;
  studentPinSuccessCallback = cb;
}
function hideStudentPinPanel(){
  studentPinPanelEl.classList.remove('open');
  studentPinEntry=''; studentPinSetMode=false; studentPinSuccessCallback=null;
  if(awaitingStudentPin && !studentPin){
    studentPinActive=false;
    localStorage.setItem('studentPinActive','0');
    updateToggles();
    alertBox('NIP élève non défini');
  }
  awaitingStudentPin=false;
}
function renderStuDots(err=false){
  studentPinDotsEl.querySelectorAll('.dot').forEach((d,i)=>{
    d.className='dot';
    if(err&&i<studentPinEntry.length) d.classList.add('wrong');
    else if(i<studentPinEntry.length) d.classList.add('filled');
  });
}
studentPinCloseEl.onclick = hideStudentPinPanel;
function finishStuPinCreation(){
  if(studentPinEntry.length<1){
    studentPinMsgEl.textContent='1 chiffre minimum';
    renderStuDots(true);
    setTimeout(renderStuDots,800);
    return;
  }
  studentPin = studentPinEntry;
  localStorage.setItem('studentPin', studentPin);
  studentPinMsgEl.textContent='NIP élève enregistré !';
  awaitingStudentPin=false;
  setTimeout(hideStudentPinPanel,900);
}
function handleStuInput(v){
  if(v==='clear'){
    studentPinEntry=''; renderStuDots(); studentPinMsgEl.textContent=''; return;
  }
  if(v==='ok'){
    if(studentPinSetMode){ finishStuPinCreation(); return; }
    if(studentPinEntry===studentPin){
      const cb=studentPinSuccessCallback;
      setTimeout(()=>{
        hideStudentPinPanel();
        if(cb) setTimeout(cb,150);
      },250);
    } else {
      studentPinMsgEl.textContent='Code incorrect';
      renderStuDots(true);
      setTimeout(()=>{
        studentPinEntry='';
        renderStuDots();
        studentPinMsgEl.textContent='';
      },900);
    }
    return;
  }
  if(studentPinEntry.length<5){
    studentPinEntry+=v; renderStuDots();
  }
}
(()=>{
  let h='';
  for(let i=1;i<=9;i++) h+=`<button class="pinbtn" data-v="${i}">${i}</button>`;
  h+=`<button class="pinbtn" id="studentPinBtnClear" data-v="clear">C</button>
      <button class="pinbtn" data-v="0">0</button>
      <button class="pinbtn" id="studentPinBtnOk" data-v="ok">OK</button>`;
  studentPinKeypadEl.innerHTML=h;
  studentPinKeypadEl.addEventListener('click',e=>{
    const v=e.target.getAttribute('data-v');
    if(v!==null){
      playSound(sndPinPress);
      handleStuInput(v);
    }
  });
})();

/* ---------- STUDENT CALCULATOR LOGIC ---------- */
let studentCalcEntry = '';
let studentCalcNumbers = [];
let studentCalcTokens = [];
let includeTaxes = true;

function formatAmountFr(v){
  return v.toFixed(2).replace('.', ',') + ' $';
}
const formatCalcNumber = v => v.toFixed(2).replace('.', ',');
function entryToValue(){
  const cents = parseInt(studentCalcEntry || '0', 10);
  return cents / 100;
}
function startNewCalcIfFinished(){
  if(studentCalcTokens[studentCalcTokens.length-1]==='='){
    studentCalcTokens=[];
    studentCalcNumbers=[];
  }
}
function buildExpressionString(){
  const tokens=[...studentCalcTokens];
  if(studentCalcEntry && tokens[tokens.length-1] !== '='){
    tokens.push(formatCalcNumber(entryToValue()));
  }
  if(!tokens.length){
    return formatCalcNumber(entryToValue());
  }
  return tokens.join(' ');
}
function computeTotals(){
  const base = +(studentCalcNumbers.reduce((s,n)=>s+n,0) + entryToValue()).toFixed(2);
  const taxed = +(base * (1 + TAX_RATE)).toFixed(2);
  const display = includeTaxes ? taxed : base;
  return {base,taxed,display};
}
function updateTaxesButton(){
  const btn=document.querySelector('[data-type="tax-toggle"]');
  if(btn){
    btn.textContent = 'Taxe';
    btn.classList.toggle('tax-on', includeTaxes);
    btn.classList.toggle('tax-off', !includeTaxes);
  }
}
function updateStudentCalcDisplay(){
  $('studentCalcExpression').textContent = buildExpressionString();
  const finished = studentCalcTokens[studentCalcTokens.length-1] === '=';
  if(finished){
    const {base,taxed,display} = computeTotals();
    $('studentCalcSubtotal').textContent  = formatAmountFr(display);
    $('studentCalcTaxesNote').textContent = includeTaxes
      ? `Taxes incluses (+${formatAmountFr(taxed-base)})`
      : 'Montant sans taxes';
  } else {
    $('studentCalcSubtotal').textContent = '0,00 $';
    $('studentCalcTaxesNote').textContent = includeTaxes ? 'Taxes incluses' : 'Sans taxes';
  }
}
function handleStudentDigit(d){
  startNewCalcIfFinished();
  if(studentCalcEntry.length >= 6) return;
  studentCalcEntry += d;
  updateStudentCalcDisplay();
}
function commitEntry(op=null){
  if(!studentCalcEntry && !studentCalcNumbers.length) return;
  if(studentCalcEntry){
    const val = entryToValue();
    studentCalcNumbers.push(val);
    studentCalcTokens.push(formatCalcNumber(val));
    studentCalcEntry = '';
  }
  if(op){
    if(studentCalcTokens[studentCalcTokens.length-1]==='+') studentCalcTokens.pop();
    if(studentCalcTokens[studentCalcTokens.length-1]==='=') studentCalcTokens.pop();
    studentCalcTokens.push(op);
  }
}
function handleStudentPlus(){
  commitEntry('+');
  updateStudentCalcDisplay();
}
function handleStudentEquals(){
  commitEntry();
  if(!studentCalcTokens.length && !studentCalcEntry) return;
  if(studentCalcTokens[studentCalcTokens.length-1]==='+') studentCalcTokens.pop();
  if(studentCalcTokens[studentCalcTokens.length-1]!=='=') studentCalcTokens.push('=');
  updateStudentCalcDisplay();
}
function toggleStudentTaxes(){
  includeTaxes = !includeTaxes;
  updateTaxesButton();
  updateStudentCalcDisplay();
}
function handleStudentClear(){
  studentCalcEntry = '';
  studentCalcNumbers = [];
  studentCalcTokens = [];
  includeTaxes = true;
  updateTaxesButton();
  updateStudentCalcDisplay();
}
function handleStudentOK(){
  const {display} = computeTotals();
  if(display <= 0) return;
  price = display;
  hide($('studentPriceModal'));
  saveRender();
}
function openStudentPriceModal(){
  studentCalcEntry = '';
  studentCalcNumbers = [];
  studentCalcTokens = [];
  includeTaxes = true;
  updateTaxesButton();
  updateStudentCalcDisplay();
  show($('studentPriceModal'));
}

// build student keypad
(function initStudentKeypad(){
  const keypad = $('studentCalcKeypad');
  if(!keypad) return;
  const buttons = [
    {label:'7', type:'digit', value:'7'},
    {label:'8', type:'digit', value:'8'},
    {label:'9', type:'digit', value:'9'},
    {label:'+', type:'plus', op:true},
    {label:'4', type:'digit', value:'4'},
    {label:'5', type:'digit', value:'5'},
    {label:'6', type:'digit', value:'6'},
    {label:'=', type:'equal', op:true},
    {label:'1', type:'digit', value:'1'},
    {label:'2', type:'digit', value:'2'},
    {label:'3', type:'digit', value:'3'},
    {label:'Taxe', type:'tax-toggle', tax:true, id:'studentTaxToggleBtn'},
    {label:'0', type:'digit', value:'0', wide:true},
    {label:'C', type:'clear', clear:true, op:true},
    {label:'OK', type:'ok', ok:true}
  ];
  let h='';
  buttons.forEach(btn=>{
    const cls = 'studentCalcBtn'
      + (btn.wide ? ' wide' : '')
      + (btn.small ? ' small' : '')
      + (btn.tax ? ' tax-btn' : '')
      + (btn.clear ? ' clear-btn' : '')
      + (btn.ok ? ' ok-btn' : '')
      + (btn.op ? ' op-btn' : '');
    const idAttr = btn.id ? ` id="${btn.id}"` : '';
    h += `<button class="${cls}" data-type="${btn.type}"${btn.value?` data-val="${btn.value}"`:''}${idAttr}>${btn.label}</button>`;
  });
  keypad.innerHTML = h;
  keypad.addEventListener('click', e=>{
    const t = e.target.closest('.studentCalcBtn');
    if(!t) return;
    const type = t.getAttribute('data-type');
    const val  = t.getAttribute('data-val') || '';
    switch(type){
      case 'digit': handleStudentDigit(val); break;
      case 'plus':  handleStudentPlus(); break;
      case 'equal': handleStudentEquals(); break;
      case 'tax-toggle': toggleStudentTaxes(); break;
      case 'clear': handleStudentClear(); break;
      case 'ok':    handleStudentOK(); break;
    }
  });
  updateTaxesButton();
})();

// wire student button
studentSetPriceBtn.addEventListener('click',()=>{
  const open = ()=>openStudentPriceModal();
  if(studentPinActive) showStudentPinPanel(false,open);
  else open();
});

// START/SETUP
$('startBtn').onclick = ()=>{
  hide($('startOverlay'));
  displayName();
  enterFS();
  if(!localStorage.getItem('setupDone')) openSetup();
};
if(studentName) displayName();
window.addEventListener('DOMContentLoaded',()=>{
  if(!localStorage.getItem('setupDone')&&$('startOverlay').style.display==='none') openSetup();
});

// COIN ANIMATION
function animateCoins(idxArr,cb){
  const allCoins = document.querySelectorAll('.coin');
  idxArr.forEach(i=>{
    const el = Array.from(allCoins).find(c => +c.dataset.idx === i);
    if(el){
      el.classList.add('flyaway');
      setTimeout(()=>el.classList.remove('flyaway'),2000);
    }
  });
  setTimeout(cb,2000);
}

// DRAG & DROP
const dragSources = document.querySelectorAll('.dragSource');
const walletDropAreaEl = $('walletDropArea');
let ghostCoin=null, offsetX=0, offsetY=0;
let dragMoved=false;
let dragStartPos=null;

function onDragStart(e){
  const src = e.currentTarget;
  if(ghostCoin) return;
  ghostCoin = src.cloneNode(true);
  ghostCoin.classList.add('dragging');
  ghostCoin.style.position='fixed';
  ghostCoin.style.pointerEvents='none';
  ghostCoin.style.zIndex='9999';
  ghostCoin.dataset.value = src.dataset.value;
  document.body.appendChild(ghostCoin);
  const evt = e.touches ? e.touches[0] : e;
  const rect = src.getBoundingClientRect();
  offsetX = evt.clientX - rect.left;
  offsetY = evt.clientY - rect.top;
  dragStartPos = {x: evt.clientX, y: evt.clientY};
  dragMoved = false;
  ghostCoin.style.left = rect.left+'px';
  ghostCoin.style.top  = rect.top+'px';
  walletDropAreaEl.classList.add('droptarget');
  if(e.type==='touchstart'){
    document.addEventListener('touchmove',onDragMove);
    document.addEventListener('touchend' ,onDragEnd);
  } else {
    document.addEventListener('mousemove',onDragMove);
    document.addEventListener('mouseup',onDragEnd);
  }
  e.preventDefault();
}
function onDragMove(e){
  if(!ghostCoin) return;
  const evt = e.touches ? e.touches[0] : e;
  ghostCoin.style.left = evt.clientX - offsetX + 'px';
  ghostCoin.style.top  = evt.clientY - offsetY + 'px';
  if(dragStartPos){
    const dx = evt.clientX - dragStartPos.x;
    const dy = evt.clientY - dragStartPos.y;
    if(Math.hypot(dx, dy) > 6){
      dragMoved = true;
    }
  }
}
function onDragEnd(e){
  if(!ghostCoin) return;
  const evt = e.type==='touchend' ? e.changedTouches[0] : e;
  walletDropAreaEl.classList.remove('droptarget');
  const rect = walletDropAreaEl.getBoundingClientRect();
  const val = parseInt(ghostCoin.dataset.value,10);
  const dropped = (
    evt.clientX>rect.left &&
    evt.clientX<rect.right &&
    evt.clientY>rect.top &&
    evt.clientY<rect.bottom
  );
  if(dropped){
    addCoins(val);
  } else if(!dragMoved){
    addCoins(val);
  }
  document.body.removeChild(ghostCoin);
  ghostCoin = null;
  dragStartPos = null;
  if(e.type==='touchend'){
    document.removeEventListener('touchmove',onDragMove);
    document.removeEventListener('touchend',onDragEnd);
  } else {
    document.removeEventListener('mousemove',onDragMove);
    document.removeEventListener('mouseup',onDragEnd);
  }
}
dragSources.forEach(el=>{
  el.addEventListener('mousedown',onDragStart);
  el.addEventListener('touchstart',onDragStart,{passive:false});
});

// PRICE MODAL (ADMIN)
let priceSelection={dollar:1,cent:0};
const setPriceBtn=$('setPriceBtn');
let priceModalTriggerBtn=null;
function openPriceModal(triggerBtn){
  priceModalTriggerBtn = triggerBtn || null;
  priceSelection.dollar=Math.floor(price);
  priceSelection.cent=Math.round(price*100)%100;
  let h='';
  for(let i=1;i<=10;i++){
    h+=`<button class="priceDollarBtn${priceSelection.dollar===i?' selected':''}" data-v="${i}">${i}$</button>`;
  }
  $('priceDollarGrid').innerHTML=h;
  const cents=[0,25,50,75];
  h=cents.map(c=>`<button class="priceCentBtn${priceSelection.cent===c?' selected':''}" data-v="${c}">.${c.toString().padStart(2,'0')}</button>`).join('');
  $('priceCentGrid').innerHTML=h;
  const upd=()=>{$('pricePreview').textContent=`Prix choisi : ${priceSelection.dollar}.${priceSelection.cent.toString().padStart(2,'0')}$`;};
  document.querySelectorAll('.priceDollarBtn').forEach(b=>b.onclick=()=>{
    document.querySelectorAll('.priceDollarBtn').forEach(btn=>btn.classList.remove('selected'));
    b.classList.add('selected');
    priceSelection.dollar=+b.dataset.v; upd();
  });
  document.querySelectorAll('.priceCentBtn').forEach(b=>b.onclick=()=>{
    document.querySelectorAll('.priceCentBtn').forEach(btn=>btn.classList.remove('selected'));
    b.classList.add('selected');
    priceSelection.cent=+b.dataset.v; upd();
  });
  upd();
  if(priceModalTriggerBtn) priceModalTriggerBtn.classList.add('active');
  show($('priceModal'));
}
$('priceConfirm').onclick = ()=>{
  price = +(priceSelection.dollar + priceSelection.cent/100).toFixed(2);
  hide($('priceModal'));
  if(priceModalTriggerBtn){ priceModalTriggerBtn.classList.remove('active'); priceModalTriggerBtn=null; }
  saveRender();
};
$('priceCancel').onclick = ()=>{
  hide($('priceModal'));
  if(priceModalTriggerBtn){ priceModalTriggerBtn.classList.remove('active'); priceModalTriggerBtn=null; }
};
setPriceBtn.onclick = ()=>openStudentPriceModal();

// CLICK-OUTSIDE HANDLER
const priceModalEl=$('priceModal');
document.addEventListener('pointerdown',e=>{
  const priceVis=getComputedStyle(priceModalEl).display!=='none';
  const insidePrice=priceModalEl.contains(e.target);
  const insideAdmin=adminPanelModalEl.contains(e.target);
  const insideStuPin=studentPinPanelEl.contains(e.target);
  const studentPriceModalEl = $('studentPriceModal');
  const studentPriceVis = getComputedStyle(studentPriceModalEl).display!=='none';
  const insideStudentPrice = studentPriceModalEl.contains(e.target);
  if(adminPanelModalEl.classList.contains('open')&&!insideAdmin&&!insideStuPin&&e.target!==adminBtnEl&&!insidePrice&&!insideStudentPrice){
    adminPanelModalEl.classList.remove('open');
  }
  if(priceVis&&!insidePrice){
    hide(priceModalEl);
    if(priceModalTriggerBtn){ priceModalTriggerBtn.classList.remove('active'); priceModalTriggerBtn=null; }
  }
  if(studentPriceVis && !insideStudentPrice){
    hide(studentPriceModalEl);
  }
});

/* ====== Autoscale + pixel snapping ====== */
function pageFits() {
  const doc = document.documentElement;
  return doc.scrollHeight <= window.innerHeight && doc.scrollWidth <= window.innerWidth;
}
function applyScale(s) {
  document.documentElement.style.setProperty('--uiScale', s.toFixed(2));
}
function snapSizes(){
  const probe = document.createElement('div');
  probe.style.position = 'absolute';
  probe.style.width = 'var(--coinSize)';
  probe.style.height = '0';
  probe.style.pointerEvents = 'none';
  probe.style.visibility = 'hidden';
  document.body.appendChild(probe);
  const raw = probe.getBoundingClientRect().width || 96;
  document.body.removeChild(probe);
  const coinSnapped = Math.round(raw);
  const tileSnapped = Math.round(coinSnapped * 0.78);
  document.documentElement.style.setProperty('--coinSizeSnap', coinSnapped + 'px');
  document.documentElement.style.setProperty('--tileSize', tileSnapped + 'px');
}
function autoScaleToViewport() {
  let s = 1.00;
  applyScale(s);
  let guard = 0;
  const MIN = 0.55;
  const STEP = 0.05;
  requestAnimationFrame(() => {
    while (!pageFits() && s > MIN && guard < 20) {
      s -= STEP;
      applyScale(s);
      guard++;
    }
    requestAnimationFrame(snapSizes);
  });
}
window.addEventListener('load', autoScaleToViewport);
window.addEventListener('resize', autoScaleToViewport);
  </script>
</body>
</html>
