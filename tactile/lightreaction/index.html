<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Touch the Light</title>
  <link rel="stylesheet" href="../../css/choiceeyegaze.css">
  <style>
    :root {
      --bg: #000;
      --ui: rgba(255,255,255,0.85);
      --ui2: rgba(255,255,255,0.6);
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      overflow: hidden;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: block;
    }

    #stage {
      position: fixed;
      inset: 0;
      background: var(--bg);
      cursor: default;
    }

    #game-options.modal {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #control-panel-options {
      padding: 14px 20px 20px;
      z-index: 12;
    }

    #options-inline-container {
      margin-top: 12px;
    }

    #mode-divider {
      margin: 10px 0;
    }

    .option-item {
      text-align: left;
    }

    #options-inline-container > .options-column:nth-child(2) .option-item {
      text-align: center;
    }

    #options-inline-container > .options-column:nth-child(3) {
      align-items: flex-start;
    }

    #options-inline-container > .options-column:nth-child(3) .option-item {
      text-align: left;
    }

    .helper-text {
      margin: 0;
      color: #333;
      font-size: 14px;
      font-weight: 600;
    }

    .value-text {
      font-weight: 700;
      color: #00796B;
    }

    .styled-slider {
      width: min(260px, 90%);
    }

    /* ---------------------------
       ALIVE / BREATHING SHINY SPOT
       --------------------------- */
    .spot {
      position: absolute;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: auto;
      outline: none;
      border: none;

      background:
        radial-gradient(circle at 30% 30%,
          rgba(255,255,255,0.95) 0%,
          rgba(255,255,255,0.30) 18%,
          rgba(255,255,255,0.0) 36%),
        radial-gradient(circle at 50% 50%,
          var(--spotColor) 0%,
          var(--spotColor) 66%,
          rgba(0,0,0,0.0) 78%);

      box-shadow:
        0 0 18px var(--spotGlow),
        0 0 55px var(--spotGlow),
        0 0 120px rgba(255,255,255,0.06);

      animation:
        breathe 2.8s ease-in-out infinite,
        drift 3.6s ease-in-out infinite;
      will-change: transform, filter;
    }

    .spot.hold-armed {
      box-shadow:
        0 0 22px var(--spotGlow),
        0 0 66px var(--spotGlow),
        0 0 130px rgba(255,255,255,0.18);
      filter: brightness(1.2);
    }

    .spot::after {
      content: "";
      position: absolute;
      inset: -22%;
      border-radius: 50%;
      background: radial-gradient(circle,
        rgba(255,255,255,0.00) 30%,
        var(--spotGlow) 55%,
        rgba(0,0,0,0.00) 74%);
      opacity: 0.65;
      filter: blur(10px);
      transform: scale(0.92);
      animation: aura 2.8s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes breathe {
      0%, 100% { filter: brightness(1.05) saturate(1.18); }
      50%      { filter: brightness(1.28) saturate(1.45); }
    }
    @keyframes aura {
      0%, 100% { opacity: 0.55; transform: scale(0.90); filter: blur(11px); }
      50%      { opacity: 0.90; transform: scale(1.06); filter: blur(14px); }
    }
    @keyframes drift {
      0%, 100% { transform: translate(-50%, -50%) scale(1.00); }
      33%      { transform: translate(calc(-50% + 2px), calc(-50% - 1px)) scale(1.01); }
      66%      { transform: translate(calc(-50% - 2px), calc(-50% + 1px)) scale(0.99); }
    }

    #vignette {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at center,
        rgba(0,0,0,0) 45%,
        rgba(0,0,0,0.38) 100%
      );
      z-index: 1;
    }

    #screenFlash {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      background: var(--flashColor);
      z-index: 8;
    }

    #screenFlash.flash2s {
      animation: flash2s 2s ease-out forwards;
    }

    @keyframes flash2s {
      0%   { opacity: 0; }
      10%  { opacity: 0.55; }
      60%  { opacity: 0.40; }
      100% { opacity: 0; }
    }

    .ripple {
      position: fixed;
      left: 0;
      top: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0.02);
      pointer-events: none;
      z-index: 9;

      background: radial-gradient(circle,
        rgba(0,0,0,0) 55%,
        rgba(255,255,255,0.65) 58%,
        var(--rippleColor) 62%,
        rgba(0,0,0,0) 70%
      );

      mix-blend-mode: screen;
      opacity: 0.9;
      animation: rippleOut 4s ease-out forwards;
      filter: blur(0.15px);
    }

    @keyframes rippleOut {
      0%   { opacity: 0.0; transform: translate(-50%, -50%) scale(0.05); }
      8%   { opacity: 0.85; }
      55%  { opacity: 0.55; }
      100% { opacity: 0.0; transform: translate(-50%, -50%) scale(var(--rippleScale)); }
    }
  </style>
</head>
<body>
  <div id="stage" aria-label="Touch the light game"></div>

  <div id="screenFlash"></div>
  <div id="vignette"></div>

  <div id="game-options" class="modal">
    <div id="options-title-bar">
      <h2 id="options-main-title">Touch the Light</h2>
    </div>

    <div id="control-panel-options">
      <div id="mode-divider"></div>

      <div id="options-inline-container">
        <div class="options-column">
          <div class="option-item">
            <label class="teal-label" for="holdToActivate">
              <input type="checkbox" id="holdToActivate">
              Hold to activate
            </label>
          </div>
          <div class="option-item">
            <label for="holdDuration" class="teal-label label-block">Hold duration: <span id="holdDurationVal">1000</span> ms</label>
            <input type="range" id="holdDuration" class="styled-slider" min="500" max="2000" step="50" value="1000">
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label for="colorMode" class="teal-label label-block">Spot color palette</label>
            <select id="colorMode" class="styled-select">
              <option value="default" selected>Current mix (default)</option>
              <option value="magenta">Magenta</option>
              <option value="teal">Teal</option>
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="pink">Pink</option>
              <option value="red">Red</option>
              <option value="yellow">Yellow</option>
            </select>
          </div>
          <div class="option-item">
            <label for="respawnDelay" class="teal-label label-block">Next light delay: <span id="respawnDelayVal">3</span> s</label>
            <input type="range" id="respawnDelay" class="styled-slider" min="1" max="10" step="1" value="3">
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label class="teal-label" for="sfxEnabled">
              <input type="checkbox" id="sfxEnabled" checked>
              Sound effects
            </label>
          </div>
          <div class="option-item">
            <label for="sfxVolume" class="teal-label label-block">Sound volume: <span id="sfxVolumeVal">70</span>%</label>
            <input type="range" id="sfxVolume" class="styled-slider" min="0" max="100" value="70">
          </div>
          <div class="option-item">
            <label class="teal-label" for="musicEnabled">
              <input type="checkbox" id="musicEnabled">
              Music
            </label>
          </div>
          <div class="option-item">
            <label for="musicVolume" class="teal-label label-block">Music volume: <span id="musicVolumeVal">45</span>%</label>
            <input type="range" id="musicVolume" class="styled-slider" min="0" max="100" value="45">
          </div>
        </div>
      </div>

      <div id="mode-divider"></div>
      <p class="helper-text">Touch/click the glowing circle. Fullscreen starts after pressing Start.</p>
      <button id="startButton" class="button">Start</button>
    </div>
  </div>

  <script>
    const stage = document.getElementById('stage');
    const optionsOverlay = document.getElementById('game-options');
    const startButton = document.getElementById('startButton');
    const screenFlash = document.getElementById('screenFlash');

    const holdToActivate = document.getElementById('holdToActivate');
    const holdDuration = document.getElementById('holdDuration');
    const holdDurationVal = document.getElementById('holdDurationVal');
    const colorMode = document.getElementById('colorMode');
    const sfxEnabled = document.getElementById('sfxEnabled');
    const sfxVolume = document.getElementById('sfxVolume');
    const sfxVolumeVal = document.getElementById('sfxVolumeVal');
    const respawnDelay = document.getElementById('respawnDelay');
    const respawnDelayVal = document.getElementById('respawnDelayVal');
    const musicEnabled = document.getElementById('musicEnabled');
    const musicVolume = document.getElementById('musicVolume');
    const musicVolumeVal = document.getElementById('musicVolumeVal');

    const SETTINGS = {
      minSize: 140,
      maxSize: 270,
      edgePadding: 32
    };

    const SPARKLE_COLORS = [
      { color: 'rgba(255, 0, 200, 1)',  glow: 'rgba(255, 0, 200, 0.55)' },
      { color: 'rgba(255, 60, 180, 1)', glow: 'rgba(255, 60, 180, 0.55)' },
      { color: 'rgba(0, 255, 220, 1)',  glow: 'rgba(0, 255, 220, 0.55)' },
      { color: 'rgba(0, 210, 255, 1)',  glow: 'rgba(0, 210, 255, 0.55)' },
      { color: 'rgba(170, 0, 255, 1)',  glow: 'rgba(170, 0, 255, 0.55)' },
      { color: 'rgba(160, 255, 0, 1)',  glow: 'rgba(160, 255, 0, 0.55)' },
      { color: 'rgba(255, 220, 0, 1)',  glow: 'rgba(255, 220, 0, 0.55)' },
      { color: 'rgba(255, 140, 0, 1)',  glow: 'rgba(255, 140, 0, 0.55)' },
      { color: 'rgba(0, 120, 255, 1)',  glow: 'rgba(0, 120, 255, 0.55)' },
      { color: 'rgba(255, 40, 60, 1)',  glow: 'rgba(255, 40, 60, 0.55)' }
    ];

    const MONO_PALETTES = {
      magenta: [{ color: 'rgba(255, 0, 200, 1)', glow: 'rgba(255, 0, 200, 0.55)' }],
      teal: [{ color: 'rgba(0, 255, 220, 1)', glow: 'rgba(0, 255, 220, 0.55)' }],
      blue: [{ color: 'rgba(0, 120, 255, 1)', glow: 'rgba(0, 120, 255, 0.55)' }],
      green: [{ color: 'rgba(160, 255, 0, 1)', glow: 'rgba(160, 255, 0, 0.55)' }],
      pink: [{ color: 'rgba(255, 60, 180, 1)', glow: 'rgba(255, 60, 180, 0.55)' }],
      red: [{ color: 'rgba(255, 40, 60, 1)', glow: 'rgba(255, 40, 60, 0.55)' }],
      yellow: [{ color: 'rgba(255, 220, 0, 1)', glow: 'rgba(255, 220, 0, 0.55)' }]
    };

    const POP_SOUNDS = [
      '../../sounds/space/twinklingstar1.mp3',
      '../../sounds/space/twinklingstar2.mp3',
      '../../sounds/space/twinklingstar3.mp3',
      '../../sounds/space/twinklingstar4.mp3'
    ];

    const MUSIC_PLAYLIST = [
      '../../songs/space/spacegood1.mp3',
      '../../songs/space/spacegood2.mp3',
      '../../songs/space/spacegood3.mp3'
    ];

    const popAudio = new Audio();
    popAudio.preload = 'auto';
    const musicAudio = new Audio();
    musicAudio.preload = 'auto';

    const gameState = {
      holdEnabled: false,
      holdDurationMs: 1000,
      colorMode: 'default',
      sfxEnabled: true,
      sfxVolume: 70,
      respawnDelayMs: 3000,
      musicEnabled: false,
      musicVolume: 45
    };

    let spotEl = null;
    let isPlaying = false;
    let holdTimeoutId = null;
    let holdingPointerId = null;

    function rand(min, max) {
      return Math.random() * (max - min) + min;
    }

    function pickRandomSound() {
      return POP_SOUNDS[Math.floor(Math.random() * POP_SOUNDS.length)];
    }

    function pickRandomMusicTrack() {
      return MUSIC_PLAYLIST[Math.floor(Math.random() * MUSIC_PLAYLIST.length)];
    }

    function getPalette() {
      if (gameState.colorMode === 'default') return SPARKLE_COLORS;
      return MONO_PALETTES[gameState.colorMode] || SPARKLE_COLORS;
    }

    function pickColor() {
      const palette = getPalette();
      return palette[Math.floor(Math.random() * palette.length)];
    }

    async function playPopSound() {
      if (!gameState.sfxEnabled) return;

      try {
        const src = pickRandomSound();
        if (!popAudio.src.includes(src)) popAudio.src = src;
        popAudio.volume = gameState.sfxVolume / 100;
        popAudio.currentTime = 0;
        await popAudio.play();
      } catch (err) {
        // Ignore autoplay/file errors.
      }
    }

    async function playRandomMusicTrack() {
      if (!gameState.musicEnabled) return;

      try {
        const src = pickRandomMusicTrack();
        musicAudio.src = src;
        musicAudio.volume = gameState.musicVolume / 100;
        musicAudio.currentTime = 0;
        await musicAudio.play();
      } catch (err) {
        // Ignore autoplay/file errors.
      }
    }

    function syncMusicPlayback() {
      musicAudio.volume = gameState.musicVolume / 100;

      if (!gameState.musicEnabled) {
        musicAudio.pause();
        musicAudio.currentTime = 0;
        return;
      }

      if (isPlaying && (musicAudio.paused || !musicAudio.src)) {
        playRandomMusicTrack();
      }
    }

    function getStageRect() {
      return stage.getBoundingClientRect();
    }

    function clearHoldState() {
      if (holdTimeoutId) {
        clearTimeout(holdTimeoutId);
        holdTimeoutId = null;
      }
      holdingPointerId = null;
      if (spotEl) spotEl.classList.remove('hold-armed');
    }

    function removeSpot() {
      clearHoldState();
      if (spotEl && spotEl.parentNode) {
        spotEl.removeEventListener('pointerdown', onSpotPointerDown);
        spotEl.removeEventListener('pointerup', onSpotPointerEnd);
        spotEl.removeEventListener('pointercancel', onSpotPointerEnd);
        spotEl.removeEventListener('pointerleave', onSpotPointerEnd);
        spotEl.parentNode.removeChild(spotEl);
      }
      spotEl = null;
    }

    function spawnSpot() {
      removeSpot();

      const rect = getStageRect();
      const size = rand(SETTINGS.minSize, SETTINGS.maxSize);

      const pad = SETTINGS.edgePadding + size * 0.35;
      const x = rand(pad, rect.width - pad);
      const y = rand(pad, rect.height - pad);
      const c = pickColor();

      const el = document.createElement('div');
      el.className = 'spot';
      el.style.width = `${size}px`;
      el.style.height = `${size}px`;
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;
      el.style.setProperty('--spotColor', c.color);
      el.style.setProperty('--spotGlow', c.glow);

      const breatheDur = rand(2.4, 3.4).toFixed(2);
      const driftDur = rand(3.0, 4.2).toFixed(2);
      const delay = (-rand(0, 1.6)).toFixed(2);
      el.style.animationDuration = `${breatheDur}s, ${driftDur}s`;
      el.style.animationDelay = `${delay}s, ${delay}s`;

      el.dataset.flashColor = c.color;
      el.dataset.rippleColor = c.glow;

      el.addEventListener('pointerdown', onSpotPointerDown, { passive: false });
      el.addEventListener('pointerup', onSpotPointerEnd, { passive: false });
      el.addEventListener('pointercancel', onSpotPointerEnd, { passive: false });
      el.addEventListener('pointerleave', onSpotPointerEnd, { passive: false });
      stage.appendChild(el);
      spotEl = el;
    }

    function triggerScreenFlash(color) {
      screenFlash.style.setProperty('--flashColor', color);
      screenFlash.classList.remove('flash2s');
      void screenFlash.offsetWidth;
      screenFlash.classList.add('flash2s');
    }

    function triggerRipple(x, y, color) {
      const rect = getStageRect();
      const corners = [
        { x: 0, y: 0 },
        { x: rect.width, y: 0 },
        { x: 0, y: rect.height },
        { x: rect.width, y: rect.height }
      ];

      let maxDist = 0;
      for (const corner of corners) {
        const dx = corner.x - x;
        const dy = corner.y - y;
        const d = Math.sqrt(dx * dx + dy * dy);
        if (d > maxDist) maxDist = d;
      }

      const rippleScale = Math.max(20, (maxDist / 5)).toFixed(2);

      const ripple = document.createElement('div');
      ripple.className = 'ripple';
      ripple.style.left = `${x}px`;
      ripple.style.top = `${y}px`;
      ripple.style.setProperty('--rippleColor', color);
      ripple.style.setProperty('--rippleScale', rippleScale);

      stage.appendChild(ripple);
      ripple.addEventListener('animationend', () => ripple.remove(), { once: true });
    }

    function triggerSpotHit() {
      if (!spotEl) return;

      const x = parseFloat(spotEl.style.left);
      const y = parseFloat(spotEl.style.top);
      const flashColor = spotEl.dataset.flashColor || 'rgba(255,255,255,0.25)';
      const rippleColor = spotEl.dataset.rippleColor || 'rgba(255,255,255,0.55)';

      playPopSound();
      triggerScreenFlash(flashColor);
      triggerRipple(x, y, rippleColor);

      removeSpot();
      setTimeout(spawnSpot, gameState.respawnDelayMs);
    }

    function onSpotPointerDown(event) {
      event.preventDefault();
      if (!spotEl) return;

      if (!gameState.holdEnabled) {
        triggerSpotHit();
        return;
      }

      if (holdingPointerId !== null) return;
      holdingPointerId = event.pointerId;
      spotEl.classList.add('hold-armed');

      holdTimeoutId = setTimeout(() => {
        holdTimeoutId = null;
        triggerSpotHit();
      }, gameState.holdDurationMs);
    }

    function onSpotPointerEnd(event) {
      if (!gameState.holdEnabled) return;
      if (holdingPointerId === null) return;
      if (event.pointerId !== holdingPointerId) return;
      clearHoldState();
    }

    async function requestFullscreen() {
      const el = document.documentElement;
      try {
        if (document.fullscreenElement) return;
        if (el.requestFullscreen) await el.requestFullscreen();
        else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) await el.msRequestFullscreen();
      } catch (_) {}
    }

    function startGame() {
      optionsOverlay.style.display = 'none';
      isPlaying = true;

      popAudio.src = POP_SOUNDS[0];
      popAudio.volume = gameState.sfxVolume / 100;
      popAudio.load();
      syncMusicPlayback();

      spawnSpot();
    }

    function bindMenu() {
      holdDurationVal.textContent = holdDuration.value;
      sfxVolumeVal.textContent = sfxVolume.value;
      respawnDelayVal.textContent = respawnDelay.value;
      musicVolumeVal.textContent = musicVolume.value;

      musicAudio.addEventListener('ended', () => {
        if (!gameState.musicEnabled || !isPlaying) return;
        playRandomMusicTrack();
      });

      holdToActivate.addEventListener('change', () => {
        gameState.holdEnabled = holdToActivate.checked;
      });

      holdDuration.addEventListener('input', () => {
        gameState.holdDurationMs = parseInt(holdDuration.value, 10);
        holdDurationVal.textContent = gameState.holdDurationMs;
      });

      colorMode.addEventListener('change', () => {
        gameState.colorMode = colorMode.value;
        if (isPlaying) spawnSpot();
      });

      respawnDelay.addEventListener('input', () => {
        const seconds = parseInt(respawnDelay.value, 10);
        gameState.respawnDelayMs = seconds * 1000;
        respawnDelayVal.textContent = seconds;
      });

      sfxEnabled.addEventListener('change', () => {
        gameState.sfxEnabled = sfxEnabled.checked;
      });

      sfxVolume.addEventListener('input', () => {
        gameState.sfxVolume = parseInt(sfxVolume.value, 10);
        sfxVolumeVal.textContent = gameState.sfxVolume;
        popAudio.volume = gameState.sfxVolume / 100;
      });

      musicEnabled.addEventListener('change', () => {
        gameState.musicEnabled = musicEnabled.checked;
        syncMusicPlayback();
      });

      musicVolume.addEventListener('input', () => {
        gameState.musicVolume = parseInt(musicVolume.value, 10);
        musicVolumeVal.textContent = gameState.musicVolume;
        musicAudio.volume = gameState.musicVolume / 100;
      });

      gameState.holdEnabled = holdToActivate.checked;
      gameState.holdDurationMs = parseInt(holdDuration.value, 10);
      gameState.colorMode = colorMode.value;
      gameState.sfxEnabled = sfxEnabled.checked;
      gameState.sfxVolume = parseInt(sfxVolume.value, 10);
      gameState.respawnDelayMs = parseInt(respawnDelay.value, 10) * 1000;
      gameState.musicEnabled = musicEnabled.checked;
      gameState.musicVolume = parseInt(musicVolume.value, 10);
      musicAudio.volume = gameState.musicVolume / 100;
    }

    startButton.addEventListener('click', async () => {
      await requestFullscreen();
      startGame();
    });

    window.addEventListener('resize', () => {
      if (!isPlaying) return;
      spawnSpot();
    });

    bindMenu();
  </script>
</body>
</html>
