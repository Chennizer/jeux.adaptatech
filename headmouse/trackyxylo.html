<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Xylophone g√©ant (commande t√™te)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- TrackyMouse -->
  <script src="../../lib/tracky-mouse.js"></script>
  <link rel="stylesheet" href="../../css/otherswitch.css" />

  <style>
    :root {
      --c1: #FF595E;
      --c2: #FF924C;
      --c3: #FFCA3A;
      --c4: #8AC926;
      --c5: #1982C4;
      --c6: #6A4C93;
      --c7: #B5179E;
      --c8: #2EC4B6;
      --gap: 3rem;
      --side-pad: 3rem;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html,
    body {
      height: 100%;
      font-family: sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #000;
      color: #fff;
      touch-action: none;
    }
    body.light {
      background: #fff;
      color: #000;
    }

    /* pointeur t√™te */
    .head-pointer {
      position: fixed;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #ff0000cc;
      box-shadow: 0 0 10px 4px #ff0000;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10000;
    }

    /* XYLOPHONE */
    #xylophone {
      display: flex;
      gap: var(--gap);
      padding: 0 var(--side-pad);
      width: 100%;
      justify-content: center;
      align-items: center;
    }
    .bar {
      position: relative;
      width: calc((100% - 7 * var(--gap)) / 8);
      min-width: 70px;
      flex: 0 0 auto;
      border-radius: 1rem;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      transition: transform 0.05s;
      transform-origin: center bottom;
      outline: none;
    }
    .bar.flash {
      animation: flash 0.2s ease-out;
    }
    @keyframes flash {
      0% {
        filter: brightness(3) drop-shadow(0 0 10px #fff8);
        transform: scale(1);
      }
      50% {
        filter: brightness(2) drop-shadow(0 0 8px #fff7);
        transform: scale(1.08);
      }
      100% {
        filter: brightness(1);
        transform: scale(1);
      }
    }
    .bar::before,
    .bar::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 25%;
      aspect-ratio: 1;
      background: #333;
      border-radius: 50%;
      box-shadow: 0 0 2px #0008;
    }
    .bar::before {
      top: 8%;
    }
    .bar::after {
      bottom: 8%;
    }
    #b1 {
      background: var(--c1);
      height: 40vh;
    }
    #b2 {
      background: var(--c2);
      height: 45vh;
    }
    #b3 {
      background: var(--c3);
      height: 50vh;
    }
    #b4 {
      background: var(--c4);
      height: 55vh;
    }
    #b5 {
      background: var(--c5);
      height: 60vh;
    }
    #b6 {
      background: var(--c6);
      height: 65vh;
    }
    #b7 {
      background: var(--c7);
      height: 70vh;
    }
    #b8 {
      background: var(--c8);
      height: 75vh;
    }

    /* OVERLAY D√âMARRAGE */
    #promptOverlay {
      position: fixed;
      inset: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2rem;
      z-index: 9000;
    }
    #promptOverlay p {
      font-size: 1.6rem;
      color: #fff;
      text-align: center;
    }
    #promptOverlay button {
      font: 700 1.4rem/1 sans-serif;
      padding: 0.7rem 2.2rem;
      border-radius: 12px;
      background: #444;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    #promptOverlay button:hover {
      background: #666;
    }

    /* PANNEAUX */
    .side-panel {
      position: fixed;
      top: 60px;
      right: -300px;
      width: 270px;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px #0004;
      transition: right 0.3s, opacity 0.3s;
      opacity: 0;
      overflow: hidden;
      z-index: 2000;
    }
    .side-panel.show {
      right: 10px;
      opacity: 1;
    }
    .side-panel h2 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 0.5rem;
      color: #fff;
    }
    .side-panel label {
      display: flex;
      flex-direction: column;
      margin: 10px 0;
      font-size: 13px;
      color: #fff;
    }
    .side-panel label.inline {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      background: #008080;
      padding: 5px 8px;
      border-radius: 4px;
      color: #fff;
    }
    .side-panel input[type="range"],
    .side-panel input[type="color"],
    .side-panel button {
      width: 100%;
      margin-top: 5px;
    }
    .side-panel input[type="checkbox"] {
      margin-left: 0.5rem;
    }

    /* ic√¥nes */
    .menu-icon {
      position: fixed;
      top: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1100;
      color: #fff;
    }
    #settings-icon {
      right: 10px;
    } /* ‚öôÔ∏è */
    #camera-icon {
      right: 60px;
    } /* üì∑ */

    /* TrackyMouse sizing + promo hidden + espace r√©duit */
    #trackyRoot .tracky-mouse-canvas-container {
      width: 100% !important;
      max-width: 100% !important;
      margin-top: 4px !important;
    }
    #trackyRoot .tracky-mouse-canvas-container video,
    #trackyRoot .tracky-mouse-canvas-container canvas {
      width: 100% !important;
      height: auto !important;
    }
    #trackyRoot .tracky-mouse-controls {
      width: 100% !important;
      margin-bottom: 4px !important;
    }
    /* cacher promo ‚Äúdesktop app‚Äù */
    #trackyRoot p,
    #trackyRoot a[href*="trackymouse"] {
      display: none !important;
    }

    /* cachers d√©finitifs */
    #startEnabled,
    #start-enabled,
    #mirrorEnabled,
    #mirror-enabled {
      display: none !important;
    }
  </style>
</head>
<body class="light">
  <!-- OVERLAY START -->
  <div id="promptOverlay">
    <p>Jeu cause-effet : Xylophone (commande t√™te)</p>
    <button id="startButton">Commencer</button>
  </div>

  <!-- pointeur -->
  <div class="head-pointer" id="headDot"></div>

  <!-- XYLOPHONE -->
  <div id="xylophone" role="group" aria-label="Xylophone">
    <div id="b1" class="bar" aria-label="Do"></div>
    <div id="b2" class="bar" aria-label="R√©"></div>
    <div id="b3" class="bar" aria-label="Mi"></div>
    <div id="b4" class="bar" aria-label="Fa"></div>
    <div id="b5" class="bar" aria-label="Sol"></div>
    <div id="b6" class="bar" aria-label="La"></div>
    <div id="b7" class="bar" aria-label="Si"></div>
    <div id="b8" class="bar" aria-label="Do"></div>
  </div>

  <!-- ic√¥nes -->
  <div id="settings-icon" class="menu-icon" title="Options du jeu">‚öôÔ∏è</div>
  <div id="camera-icon" class="menu-icon" title="Cam√©ra / pointeur">üì∑</div>

  <!-- PANNEAU JEU -->
  <div id="menu" class="side-panel">
    <h2>Options jeu</h2>
    <label
      ><span>Volume</span><span id="volVal">100</span>
      <input type="range" id="volumeSlider" min="0" max="100" value="100"
    /></label>
    <label
      ><span>Dur√©e de la note (s)</span
      ><span id="timeVal">1.0s</span>
      <input
        type="range"
        id="timeSlider"
        min="0.1"
        max="5"
        step="0.1"
        value="1"
    /></label>
    <label class="inline"
      ><span>Flash lumineux</span
      ><input type="checkbox" id="flashToggle" checked
    /></label>
    <label class="inline"
      ><span>Fond clair</span
      ><input type="checkbox" id="bgToggle" checked
    /></label>
  </div>

  <!-- PANNEAU CAM√âRA / TRACKYMOUSE -->
  <div id="camMenu" class="side-panel">
    <h2>Cam√©ra & pointeur</h2>

    <label
      ><span>Couleur du pointeur</span>
      <input type="color" id="pointerColor" value="#ff0000"
    /></label>

    <!-- curseur taille pointeur -->
    <label
      ><span>Taille du pointeur (px)</span
      ><span id="pointerSizeVal">36</span>
      <input type="range" id="pointerSize" min="16" max="80" value="36"
    /></label>

    <!-- curseur dwell time -->
    <label
      ><span>Dwell time (ms)</span
      ><span id="dwellVal">1000</span>
      <input type="range" id="dwellTime" min="200" max="3000" step="100" value="1000"
    /></label>

    <div id="trackyRoot"></div>
  </div>

  <!-- LOGIQUE JAVASCRIPT -->
  <script>
    let pointerX = innerWidth / 2,
        pointerY = innerHeight / 2;
    // dwell click variables
    let dwellTime = 1000,
        dwellIndex = null,
        dwellStart = null,
        dwellDone = false;

    const dot = document.getElementById("headDot");

    /* ===== audio & jeu ===== */
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const freqs = [
      261.63,
      293.66,
      329.63,
      349.23,
      392,
      440,
      493.88,
      523.25
    ];
    const master = ctx.createGain();
    master.gain.value = 1;
    master.connect(ctx.destination);

    function createReverb(d = 1.6, decay = 2.5) {
      const len = ctx.sampleRate * d,
        buf = ctx.createBuffer(2, len, ctx.sampleRate);
      for (let ch = 0; ch < 2; ch++) {
        const data = buf.getChannelData(ch);
        for (let i = 0; i < len; i++) {
          data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
        }
      }
      const con = ctx.createConvolver();
      con.buffer = buf;
      return con;
    }
    const wet = ctx.createGain();
    wet.gain.value = 0.35;
    wet.connect(createReverb()).connect(master);

    let timeScale = 1;
    function playNote(i) {
      const f0 = freqs[i];
      const partials = [
        { r: 1, g: 1, d: 1 },
        { r: 3.99, g: 0.55, d: 0.9 },
        { r: 9, g: 0.3, d: 0.75 },
        { r: 14.37, g: 0.22, d: 0.6 },
        { r: 19.2, g: 0.12, d: 0.45 }
      ];
      const dry = ctx.createGain();
      dry.gain.value = 0.9;
      dry.connect(master);
      dry.connect(wet);
      partials.forEach(p => {
        const osc = ctx.createOscillator(),
          g = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = f0 * p.r;
        const dur = p.d * timeScale;
        g.gain.setValueAtTime(0, ctx.currentTime);
        g.gain.linearRampToValueAtTime(p.g, ctx.currentTime + 0.008);
        g.gain.exponentialRampToValueAtTime(
          0.0001,
          ctx.currentTime + dur
        );
        osc.connect(g).connect(dry);
        osc.start();
        osc.stop(ctx.currentTime + dur);
      });
    }

    let flashOn = true,
      activeIndex = null;
    const bars = [...document.querySelectorAll(".bar")];

    function testHit() {
      let hit = null;
      for (let i = 0; i < bars.length; i++) {
        const r = bars[i].getBoundingClientRect();
        if (
          pointerX >= r.left &&
          pointerX <= r.right &&
          pointerY >= r.top &&
          pointerY <= r.bottom
        ) {
          hit = i;
          break;
        }
      }

      // manual hit
      if (hit !== null && hit !== activeIndex) {
        activeIndex = hit;
        if (flashOn) {
          bars[hit].classList.add("flash");
          setTimeout(() => bars[hit].classList.remove("flash"), 200);
        }
        playNote(hit);
      }
      if (hit === null) activeIndex = null;

      // dwell click detection
      if (hit !== null) {
        if (hit !== dwellIndex) {
          dwellIndex = hit;
          dwellStart = Date.now();
          dwellDone = false;
        } else if (!dwellDone && Date.now() - dwellStart >= dwellTime) {
          dwellDone = true;
          if (flashOn) {
            bars[hit].classList.add("flash");
            setTimeout(() => bars[hit].classList.remove("flash"), 200);
          }
          playNote(hit);
        }
      } else {
        dwellIndex = null;
        dwellStart = null;
        dwellDone = false;
      }

      requestAnimationFrame(testHit);
    }

    window.addEventListener("load", () => {
      const overlay = document.getElementById("promptOverlay");
      const startBtn = document.getElementById("startButton");
      const gearIcon = document.getElementById("settings-icon");
      const camIcon = document.getElementById("camera-icon");
      const menu = document.getElementById("menu");
      const camMenu = document.getElementById("camMenu");

      const volSlider = document.getElementById("volumeSlider");
      const volVal = document.getElementById("volVal");
      const flashToggle = document.getElementById("flashToggle");
      const timeSlider = document.getElementById("timeSlider");
      const timeVal = document.getElementById("timeVal");
      const bgToggle = document.getElementById("bgToggle");

      const colorInput = document.getElementById("pointerColor");

      /* nouveaux √©l√©ments */
      const sizeInput = document.getElementById("pointerSize");
      const sizeVal = document.getElementById("pointerSizeVal");

      const dwellSlider = document.getElementById("dwellTime");
      const dwellDisplay = document.getElementById("dwellVal");
      // initial dwell display
      dwellDisplay.textContent = dwellSlider.value;
      dwellSlider.oninput = e => {
        dwellTime = parseInt(e.target.value, 10);
        dwellDisplay.textContent = e.target.value;
      };

      const trackyRoot = document.getElementById("trackyRoot");

      /* sliders/toggles */
      volSlider.oninput = e => {
        master.gain.value = e.target.value / 100;
        volVal.textContent = e.target.value;
      };
      flashToggle.onchange = e => (flashOn = e.target.checked);
      timeSlider.oninput = e => {
        timeScale = parseFloat(e.target.value);
        timeVal.textContent = `${e.target.value}s`;
      };
      bgToggle.onchange = e =>
        document.body.classList.toggle("light", e.target.checked);
      if (bgToggle.checked) document.body.classList.add("light");

      /* couleur & taille pointeur */
      const setColor = c => {
        dot.style.background = c;
        dot.style.boxShadow = `0 0 10px 4px ${c}`;
      };
      const setSize = px => {
        dot.style.width = px + "px";
        dot.style.height = px + "px";
        sizeVal.textContent = px;
      };
      setColor(colorInput.value);
      setSize(sizeInput.value);
      colorInput.oninput = e => setColor(e.target.value);
      sizeInput.oninput = e => setSize(e.target.value);

      startBtn.addEventListener("pointerup", async e => {
        e.preventDefault();
        overlay.remove();
        gearIcon.style.display = camIcon.style.display = "flex";
        document.documentElement.requestFullscreen?.();
        if (ctx.state === "suspended") ctx.resume();

        TrackyMouse.dependenciesRoot = "";
        await TrackyMouse.loadDependencies();
        TrackyMouse.init(trackyRoot);
        TrackyMouse.useCamera();
        TrackyMouse.onPointerMove = (x, y) => {
          pointerX = x;
          pointerY = y;
          dot.style.left = x + "px";
          dot.style.top = y + "px";
        };

        /* auto-start TrackyMouse */
        (function autoStart() {
          const b = trackyRoot.querySelector(
            ".tracky-mouse-start-stop-button"
          );
          b ? b.click() : requestAnimationFrame(autoStart);
        })();

        /* scrub unwanted controls */
        (function scrub() {
          trackyRoot.querySelectorAll("label").forEach(lbl => {
            const t = lbl.textContent.toLowerCase();
            if (t.includes("start") || t.includes("mirror")) lbl.remove();
          });
          trackyRoot
            .querySelectorAll('input[type="checkbox"]')
            .forEach(inp => {
              const id = (inp.id || "").toLowerCase();
              if (id.includes("start") || id.includes("mirror")) {
                inp.closest("label")?.remove();
                inp.remove();
              }
            });
          trackyRoot.querySelectorAll("p,a").forEach(el => {
            if (el.textContent.includes("TrackyMouse desktop app"))
              el.remove();
          });
          requestAnimationFrame(scrub);
        })();

        /* toggle head-pointer start/stop on space */
        window.addEventListener("keydown", e => {
          if (e.code === "Space") {
            const btn = trackyRoot.querySelector(
              ".tracky-mouse-start-stop-button"
            );
            if (btn) btn.click();
            e.preventDefault();
          }
        });

        /* curseur syst√®me */
        let last = Date.now(),
          IDLE = 3000;
        window.addEventListener("mousemove", () => {
          document.body.style.cursor = "auto";
          last = Date.now();
        });
        (function hide() {
          if (Date.now() - last > IDLE)
            document.body.style.cursor = "none";
          requestAnimationFrame(hide);
        })();
        document.body.style.cursor = "none";

        requestAnimationFrame(testHit);
      });

      gearIcon.onclick = () => {
        camMenu.classList.remove("show");
        menu.classList.toggle("show");
      };
      camIcon.onclick = () => {
        menu.classList.remove("show");
        camMenu.classList.toggle("show");
      };
    });
  </script>
</body>
</html>
