<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title class="translate" data-fr="Kaleidoscope givré" data-en="Frost Kaleidoscope">Kaleidoscope givré</title>
  <link rel="stylesheet" href="../../css/otherswitch.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#05090f; color:#fff; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; }
    canvas { display:block; position:fixed; inset:0; z-index:0; }

    #langToggle {
      position:fixed; top:14px; right:14px; z-index:10002;
      padding:0.45rem 0.9rem; border-radius:999px; border:2px solid #00d5d5;
      background:rgba(5,12,20,0.85); color:#00d5d5; font-weight:700; letter-spacing:0.04em;
      cursor:pointer; user-select:none; transition:background 0.2s ease, transform 0.05s ease, box-shadow 0.2s ease;
    }
    #langToggle:hover { background:rgba(0,213,213,0.15); box-shadow:0 0 0 4px rgba(0,213,213,0.15); }
    #langToggle:active { transform:translateY(1px); }

    #promptOverlay {
      position:fixed; inset:0; z-index:10001; display:flex; flex-direction:column;
      align-items:center; justify-content:center; text-align:center; padding:2rem;
      background:radial-gradient(circle at top, rgba(23,54,94,0.95), rgba(5,12,20,0.98));
      gap:1.2rem;
    }
    #promptOverlay h1 { font-size:clamp(1.8rem, 4vw, 2.8rem); margin:0; font-weight:700; letter-spacing:0.04em; }
    #promptOverlay p { font-size:clamp(1rem, 2.2vw, 1.25rem); margin:0; max-width:42rem; line-height:1.6; opacity:0.9; }
    #startButton {
      padding:0.85rem 2.6rem; border:none; border-radius:14px; cursor:pointer; font-size:1.2rem;
      background:linear-gradient(135deg, #00d5d5, #7ff0ff); color:#042b3d; font-weight:700; letter-spacing:0.05em;
      transition:transform 0.15s ease, box-shadow 0.15s ease, filter 0.2s ease;
    }
    #startButton:hover { filter:brightness(1.08); box-shadow:0 0 25px rgba(127,240,255,0.35); }
    #startButton:active { transform:translateY(1px); }

    #hint {
      position:fixed; bottom:26px; left:50%; transform:translateX(-50%);
      background:rgba(5,12,20,0.7); padding:0.75rem 1.6rem; border-radius:999px;
      border:1px solid rgba(120,220,255,0.35); color:rgba(220,245,255,0.85); font-size:0.95rem;
      letter-spacing:0.02em; z-index:10000; opacity:0; pointer-events:none; transition:opacity 0.6s ease;
    }
    #hint.visible { opacity:1; }
  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>
<body>
  <button id="langToggle" title="Changer de langue / Change language">FR / EN</button>
  <div id="promptOverlay">
    <h1 class="translate" data-fr="Kaleidoscope givré" data-en="Frost Kaleidoscope">Kaleidoscope givré</h1>
    <p class="translate" data-fr="Appuyez sur le bouton espace ou votre switch pour créer une nouvelle mandala lumineuse."
       data-en="Press the space bar or your switch to paint a new luminous mandala.">
      Appuyez sur le bouton espace ou votre switch pour créer une nouvelle mandala lumineuse.
    </p>
    <p class="translate" data-fr="Conseil : plusieurs pressions rapprochées créent une fusion de motifs."
       data-en="Tip: several quick presses blend the patterns together.">
      Conseil : plusieurs pressions rapprochées créent une fusion de motifs.
    </p>
    <button id="startButton" class="translate" data-fr="Commencer" data-en="Start">Commencer</button>
  </div>
  <div id="hint" class="translate" data-fr="Espace = nouvelle lumière" data-en="Space = new light">Espace = nouvelle lumière</div>

  <script>
    /* ===== Translation handling ===== */
    const LS_LANG_KEY = 'siteLanguage';
    let currentLang = 'fr';
    function initLanguage(){
      try {
        const stored = localStorage.getItem(LS_LANG_KEY);
        if (stored === 'fr' || stored === 'en') {
          currentLang = stored;
        } else {
          currentLang = document.documentElement.lang === 'en' ? 'en' : 'fr';
        }
      } catch (err) {
        currentLang = document.documentElement.lang === 'en' ? 'en' : 'fr';
      }
      applyTranslations();
    }
    function applyTranslations(){
      document.documentElement.lang = currentLang;
      document.querySelectorAll('.translate').forEach(el => {
        const fr = el.getAttribute('data-fr');
        const en = el.getAttribute('data-en');
        if (currentLang === 'fr' && fr) {
          el.innerHTML = fr;
        } else if (currentLang === 'en' && en) {
          el.innerHTML = en;
        }
      });
      document.title = currentLang === 'fr' ? 'Kaleidoscope givré' : 'Frost Kaleidoscope';
      try { localStorage.setItem(LS_LANG_KEY, currentLang); } catch (err) {}
    }
    document.getElementById('langToggle').addEventListener('click', () => {
      currentLang = currentLang === 'fr' ? 'en' : 'fr';
      applyTranslations();
    });
    initLanguage();

    /* ====== p5 sketch ====== */
    let kaleidoLayer;
    let drifters = [];
    let auroraBands = [];
    let started = false;
    let hintTimeout = null;
    const DRIFTER_COUNT = 140;
    function handleGlobalKey(evt){
      if (!started) return;
      if (evt.code === 'Space') {
        evt.preventDefault();
        triggerBurst();
        showHint();
      }
    }
    window.addEventListener('keydown', handleGlobalKey, { passive: false });

    class Drifter {
      constructor(){ this.reset(true); }
      reset(initial=false){
        this.x = random(width);
        this.y = initial ? random(height) : height + random(height * 0.1);
        this.speed = random(0.25, 0.9);
        this.size = random(1.5, 4.5);
        this.phase = random(TWO_PI);
        this.hue = random(180, 215);
        this.alpha = random(35, 90);
      }
      update(){
        this.phase += 0.01;
        this.y -= this.speed;
        this.x += sin(this.phase) * 0.35;
        if (this.y < -20) this.reset();
      }
      draw(){
        push();
        noStroke();
        fill(this.hue, 60, 100, this.alpha);
        ellipse(this.x, this.y, this.size, this.size * 1.8);
        pop();
      }
    }

    class AuroraBand {
      constructor(){
        this.t = 0;
        this.duration = random(2800, 4600);
        this.offsetY = random(-height * 0.15, height * 0.3);
        this.h1 = random(170, 210);
        this.h2 = (this.h1 + random(35, 90)) % 360;
        this.alpha = random(22, 45);
      }
      update(dt){
        this.t += dt;
      }
      finished(){
        return this.t > this.duration;
      }
      draw(){
        const progress = constrain(this.t / this.duration, 0, 1);
        const waveHeight = lerp(40, 140, easeInOutCubic(progress));
        const fade = 1 - progress;
        push();
        noFill();
        strokeWeight(2);
        for (let x = -width; x < width; x += 12) {
          const noiseSeed = x * 0.003 + progress * 2.5;
          const yOffset = noise(noiseSeed, progress * 3.0) * waveHeight - waveHeight / 2;
          const blendHue = lerpColor(color(this.h1, 70, 90, this.alpha), color(this.h2, 80, 100, this.alpha), (sin(x * 0.002 + progress * PI) + 1) / 2);
          const finalAlpha = this.alpha * fade;
          stroke(hue(blendHue), saturation(blendHue), brightness(blendHue), finalAlpha);
          line(x, this.offsetY + yOffset, x + 12, this.offsetY + yOffset + random(-6, 6));
        }
        pop();
      }
    }

    function easeInOutCubic(x){
      return x < 0.5 ? 4 * x * x * x : 1 - Math.pow(-2 * x + 2, 3) / 2;
    }

    function setup(){
      const canvas = createCanvas(windowWidth, windowHeight);
      canvas.position(0,0);
      canvas.style('z-index', '0');
      canvas.elt.setAttribute('tabindex', '0');
      canvas.elt.addEventListener('keydown', preventScrollKeys);
      kaleidoLayer = createGraphics(windowWidth, windowHeight);
      kaleidoLayer.colorMode(HSB, 360, 100, 100, 100);
      colorMode(HSB, 360, 100, 100, 100);
      noCursor();
      drifters = Array.from({length: DRIFTER_COUNT}, () => new Drifter());
      frameRate(60);
    }

    function preventScrollKeys(evt){
      if (evt.code === 'Space' || evt.code === 'ArrowUp' || evt.code === 'ArrowDown') {
        evt.preventDefault();
      }
    }

    function draw(){
      const dt = deltaTime;
      background(214, 48, 6);
      push();
      translate(width/2, height/2);
      rotate(frameCount * 0.0012);
      imageMode(CENTER);
      image(kaleidoLayer, 0, 0, width, height);
      pop();

      fill(210, 40, 30, 20);
      noStroke();
      rect(0, 0, width, height);

      for (let i = drifters.length - 1; i >= 0; i--) {
        drifters[i].update();
        drifters[i].draw();
      }

      for (let i = auroraBands.length - 1; i >= 0; i--) {
        auroraBands[i].update(dt);
        auroraBands[i].draw();
        if (auroraBands[i].finished()) {
          auroraBands.splice(i, 1);
        }
      }

      if (started && (frameCount % 420 === 0)) {
        auroraBands.push(new AuroraBand());
      }

      if (started) {
        kaleidoLayer.push();
        kaleidoLayer.noStroke();
        kaleidoLayer.fill(0, 0, 0, 6);
        kaleidoLayer.rect(0, 0, kaleidoLayer.width, kaleidoLayer.height);
        kaleidoLayer.pop();
      }
    }

    function windowResized(){
      resizeCanvas(windowWidth, windowHeight);
      const newLayer = createGraphics(windowWidth, windowHeight);
      newLayer.colorMode(HSB, 360, 100, 100, 100);
      newLayer.image(kaleidoLayer, 0, 0, windowWidth, windowHeight);
      kaleidoLayer = newLayer;
      drifters.forEach(d => d.reset(true));
    }

    function keyPressed(){
      if (!started) return;
      if (key === ' ') {
        triggerBurst();
        showHint();
      }
    }

    function showHint(){
      const hint = document.getElementById('hint');
      hint.classList.add('visible');
      clearTimeout(hintTimeout);
      hintTimeout = setTimeout(() => hint.classList.remove('visible'), 2000);
    }

    function triggerBurst(){
      kaleidoLayer.push();
      kaleidoLayer.translate(kaleidoLayer.width/2, kaleidoLayer.height/2);
      kaleidoLayer.rotate(random(TWO_PI));
      const arms = floor(random(8, 14));
      const layers = floor(random(3, 6));
      const baseHue = random(180, 260);
      const accentHue = (baseHue + random(40, 110)) % 360;
      const glowHue = (baseHue + 300) % 360;

      for (let i = 0; i < arms; i++) {
        kaleidoLayer.push();
        kaleidoLayer.rotate((TWO_PI / arms) * i);
        kaleidoLayer.scale(random(0.75, 1.3));
        for (let l = 0; l < layers; l++) {
          const radius = lerp(width * 0.04, width * 0.32, l / max(1, layers - 1)) * random(0.8, 1.25);
          const points = floor(random(4, 7));
          kaleidoLayer.beginShape();
          kaleidoLayer.fill((l % 2 === 0) ? baseHue : accentHue, random(40, 90), random(70, 100), random(40, 90));
          kaleidoLayer.stroke(glowHue, 30, 100, random(20, 45));
          kaleidoLayer.strokeWeight(random(1.2, 2.6));
          kaleidoLayer.vertex(0, 0);
          for (let p = 0; p <= points; p++) {
            const angle = map(p, 0, points, 0.1, PI - 0.1) + random(-0.12, 0.12);
            const r = radius * (0.45 + random() * 0.7);
            const x = cos(angle) * r;
            const y = sin(angle) * r;
            kaleidoLayer.vertex(x, y);
          }
          kaleidoLayer.endShape(CLOSE);
        }
        kaleidoLayer.pop();
      }

      const sparkleCount = 160;
      for (let s = 0; s < sparkleCount; s++) {
        const angle = random(TWO_PI);
        const dist = random(width * 0.03, width * 0.48);
        const x = cos(angle) * dist;
        const y = sin(angle) * dist;
        const size = random(3, 12);
        kaleidoLayer.noStroke();
        const sparkleHue = (baseHue + random(-30, 30) + 360) % 360;
        kaleidoLayer.fill(sparkleHue, random(30, 90), 100, random(40, 90));
        kaleidoLayer.ellipse(x, y, size, size);
      }

      kaleidoLayer.pop();
      auroraBands.push(new AuroraBand());
    }

    document.getElementById('startButton').addEventListener('click', () => {
      started = true;
      document.getElementById('promptOverlay').style.display = 'none';
      const canvas = document.querySelector('canvas');
      canvas.focus();
      if (document.fullscreenEnabled) {
        document.documentElement.requestFullscreen?.().catch(() => {});
      }
      triggerBurst();
      showHint();
    });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) return;
      if (started) {
        const canvas = document.querySelector('canvas');
        canvas?.focus();
      }
    });
  </script>
</body>
</html>
