<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Routine matinale — Reveal BYOL (stable viewport sizing)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/theme/white.css" id="theme">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/monokai.css">
  <style>
    :root{
      --ink:#1a1a1a; --muted:#52606d; --green:#294936; --mint:#ADF1D2; --card-br:#e6eaef; --shadow:0 4px 18px rgba(0,0,0,.10);
      --shell-gap:  clamp(10px, 2vmin, 22px);
      --grid-gap:   clamp(10px, 2vmin, 22px);
      --content-inset: clamp(10px, 3vmin, 36px);

      --safe-top:    max(env(safe-area-inset-top), 18px);
      --safe-bottom: max(env(safe-area-inset-bottom), 18px);
      --ui-reserve:  clamp(48px, 7vh, 84px);

      --side-w:    clamp(120px, 14vw, 220px);
      --side-pad:  clamp(8px, 2vmin, 18px);
      --title-h:   clamp(52px, 9vh, 120px);

      --rows: 2; --cols: 2;
      --tile-min: 160px; --tile-max: 520px;

      --bottom-ui: var(--ui-reserve);

      --photo-card-size: clamp(96px, 15vh, 220px);
      --bin-gap: clamp(12px, 2.4vmin, 24px);
      --bin-pad: clamp(12px, 2.8vmin, 26px);
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{ overflow:hidden; }
    .reveal, .reveal .slides { height:100vh; width:100vw; }
    .reveal .slides > section { height:100vh; width:100vw; padding:0; }
    .reveal .slides{ color:var(--ink); text-align:left; }

    .reveal h1, .reveal h2{
      text-align:center; margin:0; color:var(--green); text-transform:uppercase; font-weight:800; letter-spacing:.5px;
      line-height:1.1;
    }
    .reveal h1{ font-size:clamp(2.6rem,6vw,5rem) }
    .reveal h2{ font-size:clamp(2.0rem,4.6vw,3.6rem) }
    .note-tip{ font-size:.95rem; color:var(--muted); }
    a{ color:#D36135; }

    .slide-shell{
      display:grid; height:100vh; width:100vw; overflow:hidden;
      grid-template-columns: calc(100vw - var(--side-w) - var(--shell-gap)) var(--side-w);
      gap: var(--shell-gap);
      padding: var(--safe-top) var(--shell-gap) calc(var(--safe-bottom) + var(--ui-reserve)) var(--shell-gap);
    }
    .shell-main{
      display:flex;
      flex-direction:column;
      gap: var(--main-gap, var(--shell-gap));
      min-width:0;
      min-height:0;
    }
    .title-row{ height:var(--title-h); display:flex; align-items:center; justify-content:center; }
    .grid-wrap{ flex:1 1 auto; min-height:0; min-width:0; }
    .inset{ padding: 0 var(--content-inset) var(--content-inset); }

    .shell-side{
      display:grid;
      grid-template-rows: auto auto;
      align-content:start;
      gap: clamp(8px, 1.6vmin, 14px);
      padding: var(--side-pad);
      min-height:0;
      justify-items:stretch;
      align-items:start;
    }
    .side-card, .side-btn{
      background: transparent; border: none; box-shadow:none; padding:0;
      display:flex; align-items:center; justify-content:center; min-height:0;
    }
    .side-btn{ cursor:pointer; }
    .side-card img, .side-btn img{
      width: 100%; height: auto; max-height: min(28vh, 40svh); object-fit: contain; display: block; border-radius:14px;
      transform-origin:center center;
    }
    .side-btn:focus-visible{ outline:3px solid var(--mint); outline-offset:4px; border-radius:14px; }

    /* ========= Smart grid with scale knob ========= */
    .sized-grid{
      width:100%; height:100%;
      display:grid; gap: var(--grid-gap);

      --tile-scale: 1;
      --avail-w: calc(100vw - var(--side-w) - 3 * var(--shell-gap) - 2 * var(--content-inset));
      --avail-h: calc(100vh - var(--safe-top) - var(--title-h) - var(--shell-gap) - var(--bottom-ui));

      --tile-w: calc(((var(--avail-w) - (var(--cols) - 1) * var(--grid-gap)) / var(--cols)) * var(--tile-scale));
      --tile-h: calc(((var(--avail-h) - (var(--rows) - 1) * var(--grid-gap)) / var(--rows)) * var(--tile-scale));

      --tile-size: clamp(var(--tile-min), min(var(--tile-w), var(--tile-h)), var(--tile-max));

      grid-template-columns: repeat(var(--cols), var(--tile-size));
      grid-template-rows:    repeat(var(--rows), var(--tile-size));
      place-content:center;
      min-width:0; min-height:0;
    }

    .tile{
      width:100%; height:100%; border:2px solid var(--card-br); border-radius:18px; background:#fff; box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center; overflow:hidden; aspect-ratio:1/1;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease; cursor:pointer;
      position: relative; /* for highlight badge */
    }
    .tile:hover{ transform:translateY(-1px); border-color:#ADF1D2; box-shadow:0 4px 14px rgba(0,0,0,.12); }
    .tile img{ width:92%; height:92%; object-fit:contain; display:block; }

    /* === Step-Select highlight === */
    .tile.step-highlight{
      border-color:#294936;
      box-shadow: 0 0 0 6px var(--mint) inset, 0 10px 26px rgba(0,0,0,.20);
      transform: translateY(-2px) scale(1.04);
    }
    .tile.step-highlight::after{
      content:'SELECTION';
      position:absolute; left:10px; top:10px;
      background:#294936; color:#fff; font-weight:800; letter-spacing:.3px;
      padding:.15em .45em; border-radius:8px; font-size:clamp(.7rem,1.6vw,.95rem);
      pointer-events:none;
    }

    .badge{ display:inline-block; padding:1rem 1.6rem; border-radius:16px; border:1px solid #294936; color:#fff; background:#294936; font-weight:700; }

    .vid-slide{ padding:0 !important; background:#000; }
    .vid-wrap{ position:relative; width:100%; height:100%; background:#000; }
    .vid{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; }
    #playerPortal video{ position:fixed; inset:0; width:100vw; height:100vh; object-fit:contain; background:#000; }
    .vid-overlay{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.55); color:#fff; padding:.6rem 1rem; border-radius:10px; font-size:1rem; display:none; z-index:2; cursor:pointer; }

    body.immersive .reveal .controls, body.immersive .reveal .progress, body.immersive .reveal .slide-number { display:none !important; }
    :focus-visible{ outline:3px solid var(--mint); outline-offset:2px; border-radius:10px; }

    @media (max-width: 900px){
      .slide-shell{ grid-template-columns: 1fr; }
      .shell-side{ grid-template-rows: auto auto; grid-auto-rows: 1fr; }
    }

    /* ===== Drag & transfer ===== */
    .transfer-wrap{
      display:grid;
      grid-template-columns: repeat(2, max-content);
      justify-content:center;
      gap: var(--grid-gap);
      align-items:start;
      justify-items:center;
      padding-bottom: calc(var(--content-inset) * 0.5);
      column-gap: clamp(24px, 4vmin, 60px);
      row-gap: clamp(16px, 3vmin, 40px);
      padding-inline: clamp(12px, 3vmin, 36px);
      min-height:0;
    }
    .bin{
      border: 3px solid color-mix(in srgb, var(--bin-accent, #294936) 18%, var(--card-br));
      border-radius: 16px;
      background:#fff;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .transfer-wrap > .bin{
      width:auto;
      padding: var(--bin-pad);
      display:flex;
      align-items:center;
      justify-content:center;
      min-width: calc(3 * var(--photo-card-size) + 2 * var(--bin-gap));
      min-height: calc(2 * var(--photo-card-size) + var(--bin-gap));
    }
    .bin.drag-over{
      border: 3px solid color-mix(in srgb, var(--bin-accent, #294936) 65%, var(--card-br));
      box-shadow:
        0 0 0 4px color-mix(in srgb, var(--bin-accent, #294936) 20%, transparent) inset,
        0 6px 22px rgba(0,0,0,.10);
    }
    #drag-transfer .bin-grid{
      display: grid;
      grid-template-columns: repeat(3, var(--photo-card-size));
      grid-template-rows: repeat(2, var(--photo-card-size));
      gap: var(--bin-gap);
      justify-items: center;
      align-items: center;
      justify-content: center;
      align-content: start;
      width: calc(3 * var(--photo-card-size) + 2 * var(--bin-gap));
      min-height: calc(2 * var(--photo-card-size) + var(--bin-gap));
    }

    .draggable{ background: transparent; border: none; padding: 0; display:flex; align-items:center; justify-content:center; cursor: grab; border-radius: 14px; }
    .draggable:active{ cursor: grabbing; }
    .draggable img{ width: 100%; height: auto; aspect-ratio: 1/1; object-fit: contain; display: block; border-radius: 14px; }
    .transfer-controls{ margin-bottom: clamp(8px, 1.6vmin, 16px); display:flex; gap:.6rem; align-items:center; justify-content:flex-end; }
    .btn{ border:1px solid var(--card-br); background:#f9fafb; padding:.5em .8em; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:hover{ background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.08); }

    /* BIG date slide */
    .date-giant{
      display:flex;
      gap: .8em;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      color: var(--green);
      text-align: center;
    }
    .date-shell{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap: 1.5rem;
}
  /* --- Présences: bande de photos (≈15vh) --- */
.photo-strip{
  display:flex;
  flex-wrap:nowrap;
  align-items:center;
  justify-content:center;
  gap: clamp(12px, 2.4vmin, 24px);
  padding-block: clamp(12px, 2vh, 28px);
  padding-inline: clamp(16px, 3.4vw, 36px);
  margin: clamp(4px, 1vmin, 10px) 0 clamp(16px, 2.4vmin, 22px);
  min-height: calc(var(--photo-card-size) + clamp(12px, 2vh, 28px));
  overflow: visible;
  border-radius: 16px;
}

/* each photo is a draggable button */
.photo-card{
  background: #fff;
  border: 2px solid var(--card-br);
  border-radius: 14px;
  box-shadow: var(--shadow);
  width: var(--photo-card-size);
  height: var(--photo-card-size);
  display: grid;
  place-items: center;
  padding: 0;
  cursor: grab;
  flex: 0 0 auto;
  justify-self: center;
  align-self: center;
  aspect-ratio: 1 / 1;
}
.photo-card:active{ cursor: grabbing; }

.photo-card img{
  width: 100%;
  height: 100%;
  display: block;
  object-fit: cover;
  border-radius: 12px;
}

.transfer-legend{
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: clamp(12px, 2vmin, 24px);
  margin: clamp(4px, 1vmin, 10px) 0 clamp(16px, 2.4vmin, 22px);
  font-weight: 600;
  color: var(--green);
  font-size: clamp(.95rem, 2vmin, 1.2rem);
  text-align: center;
  align-items: center;
}
.transfer-label{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap: clamp(6px, 1.6vmin, 16px);
}
.transfer-icon{
  height: clamp(120px, 20vh, 220px);
  width: auto;
  flex: 0 0 auto;
}
.transfer-text{ display:inline-block; }


/* --- Ajuste la zone des bacs pour tenir sous la bande --- */
#drag-transfer .grid-wrap{
  display:flex; flex-direction:column; min-height:0;
}
#drag-transfer .transfer-wrap{
  flex: 1 1 auto;             /* occupe l’espace restant */
  min-height: 0;              /* autorise le scale sans scroll */
}

.weekday-img-wrap{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  min-height: clamp(120px, 30vh, 240px); /* keeps space even before reveal */
}

.weekday-img{
  max-width: clamp(160px, 25vmin, 300px);
  height: auto;
  opacity: 0;
  transform: translateY(12px);
  transition: opacity .3s ease, transform .3s ease;
}

.weekday-img.show{
  opacity: 1;
  transform: none;
}

    .date-giant .weekday{ font-weight: 900; font-size: clamp(2rem, 6vw, 5rem); text-transform: capitalize; }
    .date-giant .day    { font-weight: 900; font-size: clamp(2.4rem, 8vw, 6rem); }
    .date-giant .month  { font-weight: 800; font-size: clamp(2rem, 6vw, 5rem); text-transform: lowercase; }
    

    /* Weekday block (weekday text + image, stacked) */
    .weekday-block{
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      min-width: min(60vw, 900px);
    }

    /* Weekday image (bigger, centered under text) */
    .weekday-img{
      width: clamp(140px, 20vmin, 260px);
      height: auto;
      display:block;
      margin: clamp(8px, 1.8vmin, 16px) auto 0;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .22s ease, transform .22s ease;
      border-radius: 12px;
    }
    .weekday-img.show{
      opacity: 1;
      transform: none;
    }

    .step-group{ display:inline-flex; gap:.35em; align-items:baseline; }
    .reveal-step{ opacity:0; transform: translateY(6px); transition: opacity .22s ease, transform .22s ease; }
    .reveal-step.show{ opacity:1; transform:none; }
    .dot{ font-weight:900; font-size: clamp(2rem, 5vw, 4rem); opacity:.6; }

    /* ===== CH (controller) hover/click feedback ===== */
    @keyframes tap-scale { 0%{transform:scale(1)} 50%{transform:scale(1.06)} 100%{transform:scale(1)} }
    @media (prefers-reduced-motion: reduce){ .side-btn.activate-pulse img { animation: none !important; } }
    .side-btn.activate-pulse img { animation: tap-scale 220ms ease-out; will-change: transform; }

    /* fill tiles for grids */
    #videoGrid .tile img,
    #owlGrid .tile img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .side-btn img{
      transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
      will-change: transform;
    }
    .side-btn:hover img{ transform: translateY(-1px) scale(1.03); filter: drop-shadow(0 6px 14px rgba(0,0,0,.12)); }
    .side-btn:active img{ transform: translateY(0) scale(0.97); filter: drop-shadow(0 2px 6px rgba(0,0,0,.10)); }
    .side-btn:focus-visible img{ transform: translateY(-1px) scale(1.03); }

    /* ===== Fullscreen blackout overlay during remote waits ===== */
    #waitOverlay{
      position:fixed;
      inset:0;
      background:#000;
      color:#fff;
      z-index: 20000;
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 2rem;
    }
    #waitOverlay.show{ display:flex; }
    #waitOverlay .msg{ font-size: clamp(1.2rem, 3.5vw, 2rem); font-weight: 800; letter-spacing:.5px; }
    #waitOverlay .sub{ margin-top:.75rem; font-size: clamp(.9rem, 2.3vw, 1.1rem); opacity:.8; }

    /* ===== Fullscreen fallback for iframes ===== */
    .iframe-immersive{
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      border: 0 !important;
      background: #000 !important;
      z-index: 15000 !important;
    }
  </style>
</head>
<body>

  <div id="playerPortal" aria-hidden="true" style="position:fixed; inset:0; width:100vw; height:100vh; background:#000; z-index:10000; display:none;"></div>

<!-- Blackout overlay -->
<div id="waitOverlay" aria-hidden="true" role="status">
  <div>
    <div class="msg">en attente d'une réponse</div>
    <div class="sub">Appuyez sur Q pour revenir au menu, R pour aller au début</div>
  </div>
</div>

<div class="reveal">
  <div class="slides">
    <!-- Intro -->
    <section data-background-color="#DFF3E4">
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h1>Routine matinale des hiboux</h1></div>
          <div class="grid-wrap" style="display:flex; align-items:center; justify-content:center; flex-direction:column;">
            <p class="note-tip">← → ↑ ↓ • <kbd>Esc</kbd> plan • <kbd>S</kbd> notes • Espace = interaction</p>
            <p class="badge" id="startDeckBtn" style="cursor:pointer; font-size:clamp(1rem,2.4vw,1.6rem);">Plein écran & commencer ➡️</p>
          </div>
        </div>
        <aside class="shell-side">
          <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
        </aside>
      </div>
    </section>

    <!-- BIG DATE (progressive) -->
    <section id="date-slide">
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h2>Date du jour</h2></div>
          <div class="grid-wrap inset" style="display:flex; align-items:center; justify-content:center; flex-direction:column; gap:1rem;">
            <div class="date-shell">
            <div id="dateBig" class="date-giant" aria-live="polite">
              <span id="d-weekday" class="weekday reveal-step"></span>
              <span class="step-group reveal-step"><span class="dot">•</span><span id="d-day" class="day"></span></span>
              <span class="step-group reveal-step"><span class="dot">•</span><span id="d-month" class="month"></span></span>
            </div>

            <!-- New separate container for image -->
            <div class="weekday-img-wrap">
              <img id="weekdayImg" class="weekday-img" src="" alt="">
            </div>
          </div>


          </div>
        </div>
        <aside class="shell-side">
          <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
        </aside>
      </div>
    </section>
    <section>
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h2>Saison</h2></div>
          <div class="grid-wrap inset">
            <ul style="font-size:clamp(1.1rem,2.2vw,1.6rem); line-height:1.6;">

              <li class="fragment">Quatre choix de vidéos</li>
            </ul>
          </div>
        </div>
        <aside class="shell-side">
          <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
        </aside>
      </div>
    </section>
    <!-- Plan -->
    <section>
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"><h2>Plan du jour</h2></div>
          <div class="grid-wrap inset">
            <ul style="font-size:clamp(1.1rem,2.2vw,1.6rem); line-height:1.6;">
              <li class="fragment">Accueil &amp; météo</li>
              <li class="fragment">Choix d’activités</li>
              <li class="fragment">Pause sensorielle</li>
              <li class="fragment">Ateliers</li>
            </ul>
          </div>
        </div>
        <aside class="shell-side">
          <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
        </aside>
      </div>
    </section>

    <!-- Weather group: menu + 4 slides -->
    <section>
      <!-- MENU -->
      <section id="weather-menu" style="--title-h:9vh; --main-gap:40px;">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>Météo</h2></div>
            <div class="grid-wrap inset">
              <div id="weatherGrid" class="sized-grid" style="--rows:2; --cols:2; --tile-scale:0.8; --grid-gap:60px;">
                <button class="tile" data-goto="1" aria-label="Soleil"><img src="../../images/sun.png"   alt="Soleil"/></button>
                <button class="tile" data-goto="2" aria-label="Nuages"><img src="../../images/cloud.png" alt="Nuages"/></button>
                <button class="tile" data-goto="3" aria-label="Pluie"><img src="../../images/rain.png"   alt="Pluie"/></button>
                <button class="tile" data-goto="4" aria-label="Neige"><img src="../../images/snow.png"   alt="Neige"/></button>
              </div>
            </div>
          </div>
          <aside class="shell-side">
            <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
            <button id="remoteBtnWeather" class="side-btn" title="Demander (contrôleur)"><img src="../../images/ch.png" alt="Contrôleur"/></button>
            <!-- Step-Select toggle -->
            <button id="stepBtnWeather" class="side-btn" title="Sélection pas à pas (Entrée=suivant, Espace=valider)"><img src="../../images/owltwoswitch.png" alt="Mode pas à pas"/></button>
          </aside>
        </div>
      </section>

      <!-- Soleil -->
      <section id="weather-sun" class="vid-slide">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="grid-wrap inset">
              <div class="vid-wrap">
<iframe class="lazy-iframe"
        title="Jeu soleil"
        data-src="../../gaming/sunauto/index.html"
        src=""
        tabindex="-1"
        allow="autoplay; fullscreen; clipboard-read; clipboard-write; gamepad; accelerometer; gyroscope"
        style="position:absolute;inset:0;width:100%;height:100%;border:0;background:#000"
        allowfullscreen referrerpolicy="no-referrer"></iframe>
              </div>
            </div>
          </div>
          <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
        </div>
      </section>

      <!-- Nuages -->
      <section id="weather-cloud" class="vid-slide">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>☁️ Ciel nuageux</h2></div>
            <div class="grid-wrap inset">
              <div class="vid-wrap">
                <iframe title="Jeu nuages" src="../../gaming/cloud/index.html"
                        tabindex="-1"
                        allow="autoplay; fullscreen; clipboard-read; clipboard-write; gamepad; accelerometer; gyroscope"
                        style="position:absolute;inset:0;width:100%;height:100%;border:0;background:#000"
                        allowfullscreen referrerpolicy="no-referrer"></iframe>
              </div>
            </div>
          </div>
          <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
        </div>
      </section>

      <!-- Pluie -->
      <section id="weather-rain" class="vid-slide">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>🌧️ Il pleut</h2></div>
            <div class="grid-wrap inset">
              <div class="vid-wrap">
                <iframe title="Jeu pluie" src="../../gaming/stormauto/index.html"
                        tabindex="-1"
                        allow="autoplay; fullscreen; clipboard-read; clipboard-write; gamepad; accelerometer; gyroscope"
                        style="position:absolute;inset:0;width:100%;height:100%;border:0;background:#000"
                        allowfullscreen referrerpolicy="no-referrer"></iframe>
              </div>
            </div>
          </div>
          <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
        </div>
      </section>

      <!-- Neige -->
      <section id="weather-snow" class="vid-slide">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>❄️ Il neige</h2></div>
            <div class="grid-wrap inset">
              <div class="vid-wrap">
                <div class="note-tip" style="position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.45);color:#fff;padding:.35em .6em;border-radius:8px;">Astuce: ⛶ pour plein écran</div>
                <iframe title="Jeu neige" src="../../gaming/snowauto/index.html"
                        tabindex="-1"
                        allow="autoplay; fullscreen; clipboard-read; clipboard-write; gamepad; accelerometer; gyroscope"
                        style="position:absolute;inset:0;width:100%;height:100%;border:0;background:#000"
                        allowfullscreen referrerpolicy="no-referrer"></iframe>
              </div>
            </div>
          </div>
          <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
        </div>
      </section>
    </section>

    <!-- Owl mini video group (2 choices) -->
    <section id="owl-group">
      <section id="owl-root" style="--title-h:9vh; --main-gap:40px;">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>Hibou sérieux au travail ou ...</h2></div>
            <div class="grid-wrap inset">
              <div id="owlGrid" class="sized-grid" style="--rows:1; --cols:2; --tile-scale:0.9; --grid-gap:60px;">
                <button class="tile" data-owl="ov1" aria-label="Hibou rigolo (Derpy)">
                  <img src="../../images/derpyowl.png" alt="Derpy Owl">
                </button>
                <button class="tile" data-owl="ov2" aria-label="Hibou sérieux">
                  <img src="../../images/seriousowl.png" alt="Serious Owl">
                </button>
              </div>
            </div>
          </div>
          <aside class="shell-side">
            <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
            <button id="remoteBtnOwl" class="side-btn" title="Demander (contrôleur)">
              <img src="../../images/ch.png" alt="Contrôleur"/>
            </button>
            <!-- Step-Select toggle -->
            <button id="stepBtnOwl" class="side-btn" title="Sélection pas à pas (Entrée=suivant, Espace=valider)">
              <img src="../../images/owltwoswitch.png" alt="Mode pas à pas"/>
            </button>
          </aside>
        </div>
      </section>

      <section id="owl-video1" class="vid-slide">
        <div class="vid-wrap">
          <div id="overlay-ov1" class="vid-overlay">Cliquez pour lancer la vidéo — appuyez sur <b>Q</b> pour quitter</div>
          <video id="ov1" class="vid" preload="auto" playsinline></video>
        </div>
      </section>
      <section id="owl-video2" class="vid-slide">
        <div class="vid-wrap">
          <div id="overlay-ov2" class="vid-overlay">Cliquez pour lancer la vidéo — appuyez sur <b>Q</b> pour quitter</div>
          <video id="ov2" class="vid" preload="auto" playsinline></video>
        </div>
      </section>
    </section>

    <!-- Branching videos (4 choices) -->
    <section id="branch-group">
      <section id="branch-root" style="--title-h:9vh; --main-gap:40px;">
        <div class="slide-shell">
          <div class="shell-main">
            <div class="title-row"><h2>Chanson du bonjour</h2></div>
            <div class="grid-wrap inset">
              <div id="videoGrid" class="sized-grid" style="--rows:2; --cols:2; --tile-scale:0.8; --grid-gap:60px;">
                <!-- Buttons generated in JS -->
              </div>
              <div id="remoteStatus" class="note-tip" aria-live="polite" style="margin-top:1rem;"></div>
            </div>
          </div>
          <aside class="shell-side">
            <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
            <button id="remoteBtnVideos" class="side-btn" title="Demander (contrôleur)">
              <img src="../../images/ch.png" alt="Contrôleur"/>
            </button>
            <!-- Step-Select toggle -->
            <button id="stepBtnVideos" class="side-btn" title="Sélection pas à pas (Entrée=suivant, Espace=valider)">
              <img src="../../images/owltwoswitch.png" alt="Mode pas à pas"/>
            </button>
          </aside>
        </div>
      </section>

      <section id="video1" class="vid-slide">
        <div class="vid-wrap">
          <div id="overlay1" class="vid-overlay">Cliquez pour lancer la vidéo — appuyez sur <b>Q</b> pour quitter</div>
          <video id="vid1" class="vid" preload="auto" playsinline></video>
        </div>
      </section>
      <section id="video2" class="vid-slide">
        <div class="vid-wrap">
          <div id="overlay2" class="vid-overlay">Cliquez pour lancer la vidéo — appuyez sur <b>Q</b> pour quitter</div>
          <video id="vid2" class="vid" preload="auto" playsinline></video>
        </div>
      </section>
      <section id="video3" class="vid-slide">
        <div class="vid-wrap">
          <div id="overlay3" class="vid-overlay">Cliquez pour lancer la vidéo — appuyez sur <b>Q</b> pour quitter</div>
          <video id="vid3" class="vid" preload="auto" playsinline></video>
        </div>
      </section>
      <section id="video4" class="vid-slide">
        <div class="vid-wrap">
          <div id="overlay4" class="vid-overlay">Cliquez pour lancer la vidéo — appuyez sur <b>Q</b> pour quitter</div>
          <video id="vid4" class="vid" preload="auto" playsinline></video>
        </div>
      </section>
    </section>

    <!-- Drag & transfer -->
    <section id="drag-transfer">
  <div class="slide-shell">
    <div class="shell-main">
      <div class="title-row"><h2>Présences (en construction)</h2></div>

      <div class="grid-wrap inset">
        <!-- Bande de photos (≈10vh) -->
        <div id="photoStrip" class="photo-strip bin" aria-label="Photos des élèves (aperçu)"></div>

        <div class="transfer-legend">
          <span class="transfer-label">
            <img class="transfer-icon" src="../../images/pictos/teddybear.png" alt="Picto maison" loading="lazy" />
            <span class="transfer-text">À la maison</span>
          </span>
          <span class="transfer-label">
            <img class="transfer-icon" src="../../images/pictos/schoolyard.png" alt="Picto école" loading="lazy" />
            <span class="transfer-text">À l’école</span>
          </span>
        </div>

        <div class="transfer-wrap">
          <div id="bin-left"  class="bin" aria-label="Colonne gauche (source)"></div>
          <div id="bin-right" class="bin" aria-label="Colonne droite (cible)"></div>
        </div>
      </div>
    </div>
    <aside class="shell-side">
      <div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div>
    </aside>
  </div>
</section>

    <!-- End -->
    <section data-background-color="#ADF1D2">
      <div class="slide-shell">
        <div class="shell-main">
          <div class="title-row"></div>
          <div class="grid-wrap inset" style="display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1rem;">
            <h2>Bonne journée :)</h2>
          </div>
        </div>
        <aside class="shell-side"><div class="side-card"><img src="../../images/owlval.png" alt="Hibou"></div></aside>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/markdown/marked.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/notes/notes.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/highlight.js"></script>
<script>
  const qs = new URL(location.href).searchParams;
  const room = qs.get('room') || 'test';
  const WS_URL = `wss://ws-relay.gui98789.workers.dev/ws/${encodeURIComponent(room)}`;
  const deckTitle = 'Routine matinale';
  // 6 photos affichées en bande au-dessus des bacs
  const PRESENCE_PHOTOS = [
    { name: 'Olivier', src: '../../images/accueilval/olivier.png' },
    { name: 'Neythem', src: '../../images/accueilval/neythem.png' },
    { name: 'Hassan', src: '../../images/accueilval/hassan.png' },
    { name: 'Carlos', src: '../../images/accueilval/carlos.png' },
    { name: 'Jayden', src: '../../images/accueilval/jayden.png' },
    { name: 'Charles', src: '../../images/accueilval/charles.png' }
  ];
  // Option de secours si vous n’avez pas encore les fichiers
  const FALLBACK_PHOTO = (label)=> `https://placehold.co/240x240?text=${encodeURIComponent(label)}`;


  // Directory for day-of-week images
  const DAY_IMG_DIR = '../../images/accueilval/';

  // ==== VIDEOS (main 4-choice grid)
  const CHOICES = (typeof mediaChoices !== 'undefined' && Array.isArray(mediaChoices) && mediaChoices.length >= 4)
    ? mediaChoices.slice(0, 4)
    : [
        { name: "TFO - bonjour", image: "../../images/tfo-saisons.jpg", video: "https://bucket.adaptatech.org/tfo-bonjour.mp4" },
        { name: "Enfantastiques - Dire bonjour c'est joli",image: "../../images/enfantastiques.jpg",video: "https://bucket.adaptatech.org/lesenfantastiques-direbonjourcestjoli.mp4"},
        { name: "Jérémy et Jazzy - Bonjour", image: "../../images/jeremyetjazzy.webp", video: "https://bucket.adaptatech.org/jeremyetjazzy-bonjour.mp4" },
        { name: "Alain le Lait - Bonjour", image: "../../images/alainlelait-bonjour.jpg", video: "https://bucket.adaptatech.org/alainlelait-bonjour.mp4" },
      ];
  const KNOWN_VIDEOS = { v1: CHOICES[0].video, v2: CHOICES[1].video, v3: CHOICES[2].video, v4: CHOICES[3].video };
  const OWL_VIDEOS = { ov1: "https://bucket.adaptatech.org/derpyowl.mp4", ov2: "https://bucket.adaptatech.org/seriousowl.mp4" };

  Reveal.initialize({
    disableLayout: true,
    hash: true, slideNumber: true, controls: true, progress: true,
    center: false, history: true, transition: 'slide',
    keyboard: { 32: null }, // keep Space free for our custom handler
    plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
  });

  /* ===== Weather helpers (ENTER/EXIT + hard-stop audio) ===== */
  const WEATHER_SLIDE_IDS = ['weather-sun','weather-cloud','weather-rain','weather-snow'];
  let fsTarget = null;
  let revealKeyboardWas = true;

  function isWeatherSlideEl(el){ return !!el && WEATHER_SLIDE_IDS.includes(el.id); }
  function findWeatherIframe(slide){ return slide?.querySelector('iframe'); }
  function getAllWeatherIframes(){
    return WEATHER_SLIDE_IDS
      .map(id => document.getElementById(id))
      .map(sl => sl && findWeatherIframe(sl))
      .filter(Boolean);
  }
  function ensureIframeSrc(iframe){
    if (!iframe) return;
    const orig = iframe.dataset.origSrc;
    if (orig && (!iframe.src || iframe.src === 'about:blank')) {
      iframe.src = orig;
      return;
    }
    if (iframe.classList.contains('lazy-iframe')) {
      const ds = iframe.getAttribute('data-src');
      if (ds && !iframe.src) iframe.src = ds;
    }
  }
  function focusIframe(iframe){
    try { iframe.focus({preventScroll:true}); } catch {}
    try { iframe.contentWindow?.focus(); } catch {}
  }
  function fallbackImmersive(iframe){
    if (!iframe) return;
    iframe.classList.add('iframe-immersive');
    document.body.classList.add('immersive');
    fsTarget = iframe;
    focusIframe(iframe);
  }
  async function enterIframeFullscreen(iframe){
    if (!iframe) return;
    ensureIframeSrc(iframe);
    await new Promise(r => requestAnimationFrame(r));
    try {
      if (iframe.requestFullscreen) {
        await iframe.requestFullscreen();
        document.body.classList.add('immersive');
        fsTarget = iframe;
        focusIframe(iframe);
      } else {
        fallbackImmersive(iframe);
      }
    } catch {
      fallbackImmersive(iframe);
    }
  }
  async function exitIframeFullscreenIfNeeded(){
    try {
      if (document.fullscreenElement && document.fullscreenElement === fsTarget) {
        await document.exitFullscreen();
      }
    } catch {}
    if (fsTarget) fsTarget.classList.remove('iframe-immersive');
    fsTarget = null;
    document.body.classList.remove('immersive');
  }
  function handKeysToIframe(){
    const conf = Reveal.getConfig?.() || {};
    revealKeyboardWas = conf.keyboard !== false;
    Reveal.configure({ keyboard:false });
  }
  function returnKeysToReveal(){
    Reveal.configure({ keyboard: revealKeyboardWas });
  }
  function politelyPauseIframe(iframe){
    try { iframe.contentWindow?.postMessage?.({ type:'deckPause' }, '*'); } catch {}
    try {
      const doc = iframe.contentDocument;
      if (doc){
        doc.querySelectorAll('video, audio').forEach(m=>{ try{ m.pause(); m.currentTime=0; }catch{} });
      }
    } catch {}
  }
  function hardKillIframe(iframe){
    if (!iframe.dataset.origSrc){
      const ds = iframe.getAttribute('data-src');
      iframe.dataset.origSrc = ds ? ds : iframe.getAttribute('src') || '';
    }
    try { iframe.src = 'about:blank'; } catch {}
  }
  function stopIframeGame(iframe){
    if (!iframe) return;
    politelyPauseIframe(iframe);
    hardKillIframe(iframe);
  }
  function stopAllWeatherIframes(){
    getAllWeatherIframes().forEach(stopIframeGame);
  }

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement && fsTarget) {
      fsTarget.classList.remove('iframe-immersive');
      fsTarget = null;
      document.body.classList.remove('immersive');
      const cur = Reveal.getCurrentSlide?.();
      if (!isWeatherSlideEl(cur)) returnKeysToReveal();
    }
  });

  function primeWeatherOriginalSrcs(){
    getAllWeatherIframes().forEach(ifr=>{
      if(!ifr.dataset.origSrc){
        const ds = ifr.getAttribute('data-src');
        ifr.dataset.origSrc = ds ? ds : (ifr.getAttribute('src') || '');
      }
    });
  }

  Reveal.on('ready', () => {
    primeWeatherOriginalSrcs();
    const cur = Reveal.getCurrentSlide?.();
    if (isWeatherSlideEl(cur)) {
      const iframe = findWeatherIframe(cur);
      handKeysToIframe();
      enterIframeFullscreen(iframe);
      if (iframe){
        iframe.addEventListener('load', () => bindIframeKeyRelay(iframe), { once: true });
        afterWeatherIframeReady(iframe);
      }
    }
  });
  Reveal.on('slidechanged', (e) => {
    if (isWeatherSlideEl(e.previousSlide)) {
      const prevIframe = findWeatherIframe(e.previousSlide);
      stopIframeGame(prevIframe);
      exitIframeFullscreenIfNeeded();
      returnKeysToReveal();
    }
    if (isWeatherSlideEl(e.currentSlide)) {
      const iframe = findWeatherIframe(e.currentSlide);
      handKeysToIframe();
      ensureIframeSrc(iframe);
      enterIframeFullscreen(iframe);
      if (iframe){
        iframe.addEventListener('load', () => bindIframeKeyRelay(iframe), { once: true });
        afterWeatherIframeReady(iframe);
      }
    }
  });

  /* ===== Key relay so Reveal shortcuts work while an iframe has focus ===== */
  function handleDeckHotkey(key){
    const k = String(key || '').toLowerCase();
    if (k === 'q'){
      try { exitIframeFullscreenIfNeeded(); } catch {}
      stopAllWeatherIframes();
      const idx = Reveal.getIndices?.();
      if (idx && Number.isInteger(idx.h)) Reveal.slide(idx.h, 0);
      return;
    }
    if (k === 'r'){
      try { exitIframeFullscreenIfNeeded(); } catch {}
      stopAllWeatherIframes();
      Reveal.slide(0, 0);
      return;
    }
  }

  window.addEventListener('message', (e) => {
    const data = e.data;
    if (data && data.type === 'deckHotkey' && data.key) {
      handleDeckHotkey(data.key);
    }
  }, false);

  function bindIframeKeyRelay(iframe){
    if (!iframe) return;
    try {
      const w = iframe.contentWindow;
      if (!w) return;
      if (w.__deckRelayBound__) return;
      w.__deckRelayBound__ = true;

      w.addEventListener('keydown', (e) => {
        const key = e.key || e.code || '';
        if (key === 'q' || key === 'Q' || key === 'r' || key === 'R'){
          try { e.preventDefault(); e.stopImmediatePropagation(); } catch {}
          try { handleDeckHotkey(key); } catch {}
        }
      }, true);
    } catch {
      // cross-origin fallback is postMessage
    }
  }
  function afterWeatherIframeReady(iframe){ bindIframeKeyRelay(iframe); }

  window.addEventListener('keydown', (e) => {
    if (e.key === 'q' || e.key === 'Q') {
      exitIframeFullscreenIfNeeded();
    }
  }, true);

  /* ===== Build the 2x2 main video grid ===== */
  (function buildVideoGrid(){
    const grid = document.getElementById('videoGrid');
    if (!grid) return;
    grid.innerHTML = '';
    CHOICES.forEach((c, i) => {
      const key = `v${i+1}`;
      const btn = document.createElement('button');
      btn.className = 'tile';
      btn.setAttribute('data-vkey', key);
      btn.setAttribute('aria-label', c.name);
      btn.innerHTML = `<img src="${c.image}" alt="${c.name}">`;
      btn.addEventListener('click', () => playBranchVideo(key, c.video, { forcePortal:false }));
      grid.appendChild(btn);
    });
  })();

  // Start button
  document.getElementById("startDeckBtn").addEventListener("click", async ()=>{
    try { if (!document.fullscreenElement) await document.documentElement.requestFullscreen(); } catch {}
    Reveal.next();
  });

  // Weather buttons (navigate to subslides 1..4)
  document.querySelectorAll('#weatherGrid .tile[data-goto]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const v = parseInt(btn.dataset.goto,10) || 0;
      const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
      const sun = document.getElementById('weather-sun');
      const h = sun ? sections.findIndex(s => s.contains(sun)) : 0;
      if (h >= 0) Reveal.slide(h, v);
    });
  });

  // ====== Video playback logic (shared helpers)
  const portal = document.getElementById('playerPortal');
  let inputsLocked=false, currentVidRef=null, stickRAF=null, stickTarget=null;
  const blockKeys=new Set([' ','Spacebar','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','PageUp','PageDown','Home','End','Escape','Tab']);

  function onKeyCapture(e){
    if (!inputsLocked) return;
    if (e.key === 'q' || e.key === 'Q'){ e.preventDefault(); e.stopImmediatePropagation(); stopCurrentVideoAndReturn(); return; }
    if (blockKeys.has(e.key)) { e.preventDefault(); e.stopImmediatePropagation(); }
  }
  function onWheelCapture(e){ if(inputsLocked){ e.preventDefault(); e.stopImmediatePropagation(); } }
  function onTouchMoveCapture(e){ if (inputsLocked){ e.preventDefault(); e.stopImmediatePropagation(); } }
  function onPointerDownCapture(e){
    if (!inputsLocked) return;
    if (e.target.closest('video') || e.target.closest('.vid-overlay')) return;
    e.preventDefault(); e.stopImmediatePropagation();
  }
  function lockDeckInputs(){
    inputsLocked=true;
    Reveal.configure({ keyboard:false, touch:false, controls:false, overview:false });
    window.addEventListener('keydown', onKeyCapture, true);
    window.addEventListener('keyup', onKeyCapture, true);
    window.addEventListener('wheel', onWheelCapture, {capture:true, passive:false});
    window.addEventListener('touchmove', onTouchMoveCapture, {capture:true, passive:false});
    window.addEventListener('pointerdown', onPointerDownCapture, true);
  }
  function unlockDeckInputs(){
    inputsLocked=false;
    Reveal.configure({ keyboard:true, touch:true, controls:true, overview:true });
    window.removeEventListener('keydown', onKeyCapture, true);
    window.removeEventListener('keyup', onKeyCapture, true);
    window.removeEventListener('wheel', onWheelCapture, true);
    window.removeEventListener('touchmove', onTouchMoveCapture, true);
    window.removeEventListener('pointerdown', onPointerDownCapture, true);
    stopStickToSlide();
  }
  async function exitFullscreenIfOwned(el){ try{ if(document.fullscreenElement===el) await document.exitFullscreen(); }catch{} }
  function startStickToSlide(h, v){
    stickTarget = {h, v};
    const tick = ()=>{
      if (!inputsLocked || !stickTarget) return;
      const cur = Reveal.getIndices();
      if (cur.h !== stickTarget.h || cur.v !== stickTarget.v) Reveal.slide(stickTarget.h, stickTarget.v);
      stickRAF = requestAnimationFrame(tick);
    };
    stopStickToSlide(); stickRAF = requestAnimationFrame(tick);
  }
  function stopStickToSlide(){ if (stickRAF) cancelAnimationFrame(stickRAF); stickRAF = null; stickTarget = null; }
  function usePortal(videoEl){
    if (!portal.contains(videoEl)) portal.appendChild(videoEl);
    portal.style.display = 'block'; portal.setAttribute('aria-hidden','false');
  }
  function restoreFromPortal(videoEl, placeholder){
    if (placeholder && !placeholder.contains(videoEl)) placeholder.appendChild(videoEl);
    while (portal.firstChild) portal.removeChild(portal.firstChild);
    portal.style.display = 'none';
    portal.setAttribute('aria-hidden','true');
  }
  function groupHIndex(groupId){
    const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
    const anyChild = document.querySelector(`#${groupId} > section:last-of-type`);
    return anyChild ? sections.findIndex(s => s.contains(anyChild)) : -1;
  }

  // ===== Main (4-choice) video group refs
  const remoteStatus = document.getElementById('remoteStatus');
  const videoElems = {
    v1: document.getElementById('vid1'),
    v2: document.getElementById('vid2'),
    v3: document.getElementById('vid3'),
    v4: document.getElementById('vid4'),
  };
  const overlays  = {
    v1: document.getElementById('overlay1'),
    v2: document.getElementById('overlay2'),
    v3: document.getElementById('overlay3'),
    v4: document.getElementById('overlay4'),
  };
  const placeholders = Object.fromEntries(Object.entries(videoElems).map(([k,v])=>[k, v?.parentElement || null]));

  // ===== Owl (2-choice) video group refs
  const owlVideoElems = { ov1: document.getElementById('ov1'), ov2: document.getElementById('ov2') };
  const owlOverlays   = { ov1: document.getElementById('overlay-ov1'), ov2: document.getElementById('overlay-ov2') };
  const owlPlaceholders = Object.fromEntries(Object.entries(owlVideoElems).map(([k,v])=>[k, v?.parentElement || null]));

  // Generic video player for any group
  async function playVideoInGroup(groupId, key, url, maps){
    const { elems, overs, holders, indexMap } = maps;
    if (currentVidRef) { stopCurrentVideoAndReturn(); }
    const h = groupHIndex(groupId); if (h < 0) return;
    const vid = elems[key]; if (!vid) return;
    Object.keys(elems).forEach(k => { if (k!==key && elems[k]) { try { elems[k].pause(); } catch {} } });

    vid.setAttribute('playsinline',''); vid.setAttribute('webkit-playsinline',''); vid.playsInline = true;

    vid.src = url; vid.currentTime = 0;
    lockDeckInputs();

    const vIndex = indexMap[key] ?? 1;
    Reveal.slide(h, vIndex); startStickToSlide(h, vIndex);
    await new Promise(r => requestAnimationFrame(r)); try { vid.load(); } catch {}
    try { if (vid.currentTime < 0.01) vid.currentTime = 0.01; } catch {}

    currentVidRef = { groupId, key, video: vid, holder: holders[key] };
    const overlay = overs[key];
    if (overlay) overlay.style.display = 'none';

    usePortal(vid);
    try { await vid.play(); } catch (err) { console.warn('Unable to start video playback in portal', err); }
  }
  function playBranchVideo(key, url){
    const indexMap = { v1:1, v2:2, v3:3, v4:4 };
    return playVideoInGroup('branch-group', key, url || KNOWN_VIDEOS[key], {
      elems: videoElems, overs: overlays, holders: placeholders, indexMap
    });
  }
  function playOwlVideo(key, url){
    const indexMap = { ov1:1, ov2:2 };
    return playVideoInGroup('owl-group', key, url || OWL_VIDEOS[key], {
      elems: owlVideoElems, overs: owlOverlays, holders: owlPlaceholders, indexMap
    });
  }

  // Stop & return
  function stopCurrentVideoAndReturn(){
    stopStickToSlide();
    if(currentVidRef){
      const { video, holder, groupId } = currentVidRef;
      (async()=>{ try { await exitFullscreenIfOwned(video); } catch {} })();
      try { video.pause(); } catch {}
      try { video.removeAttribute('src'); } catch {}
      try { video.src = ''; video.load(); video.currentTime = 0; } catch {}
      restoreFromPortal(video, holder);

      const h = groupHIndex(groupId);
      if (h >= 0) Reveal.slide(h, 0);
    }
    currentVidRef = null;
    unlockDeckInputs();
    if(remoteStatus) remoteStatus.textContent = '';
  }

  // Bind owl grid
  (function bindOwlGrid(){
    const grid = document.getElementById('owlGrid');
    if (!grid) return;
    grid.addEventListener('click', (e)=>{
      const btn = e.target.closest && e.target.closest('button.tile[data-owl]');
      if (!btn) return;
      const key = btn.getAttribute('data-owl');
      const url = OWL_VIDEOS[key];
      if (url) playOwlVideo(key, url);
    });
  })();

  // Wire ended/pause handlers for all videos
  [...Object.values(videoElems), ...Object.values(owlVideoElems)].forEach(v=>{
    if (!v) return;
    v.addEventListener('ended', () => stopCurrentVideoAndReturn());
    v.addEventListener('pause', () => { if (inputsLocked && !v.ended) v.play().catch(()=>{}); });
  });

  // ===== Blackout overlay helpers
  const waitOverlay = document.getElementById('waitOverlay');
  function showWait(msg){
    if (!waitOverlay) return;
    const m = waitOverlay.querySelector('.msg');
    if (m) m.textContent = msg || "en attente d'une réponse";
    waitOverlay.classList.add('show');
    waitOverlay.setAttribute('aria-hidden','false');
  }
  function hideWait(){
    if (!waitOverlay) return;
    waitOverlay.classList.remove('show');
    waitOverlay.setAttribute('aria-hidden','true');
  }

  // ===== WebSocket remote
  const remoteBtnWeather = document.getElementById('remoteBtnWeather');
  const remoteBtnVideos  = document.getElementById('remoteBtnVideos');
  const remoteBtnOwl     = document.getElementById('remoteBtnOwl');
  let WS=null, hbInterval=null, watchdogInterval=null, lastActivity=0, backoffMs=1000, reconnectTimer=null, connecting=false;
  let lastPending=null;
  function setRemoteStatus(txt){ const remoteStatus = document.getElementById('remoteStatus'); if(remoteStatus) remoteStatus.textContent = txt || ''; }
  function clearWsTimers(){ if(hbInterval){clearInterval(hbInterval); hbInterval=null;} if(watchdogInterval){clearInterval(watchdogInterval); watchdogInterval=null;} if(reconnectTimer){clearTimeout(reconnectTimer); reconnectTimer=null;} }
  function scheduleReconnect(){ if(connecting) return; if(reconnectTimer) return; reconnectTimer=setTimeout(()=>{reconnectTimer=null;connectWS();}, backoffMs); backoffMs=Math.min(backoffMs*2,15000); }
  function wsSend(obj){ const payload=JSON.stringify(obj); if(WS && WS.readyState===1) WS.send(payload); else if(WS) WS.addEventListener('open', ()=> WS.send(payload), {once:true}); }
  function connectWS(){
    if (connecting) return; connecting=true;
    try { WS = new WebSocket(WS_URL); } catch { connecting=false; scheduleReconnect(); return; }
    WS.onopen = ()=>{ connecting=false; lastActivity=Date.now(); clearWsTimers(); setRemoteStatus('Connecté au canal '+room);
      wsSend({ type:'hello', role:'slides', deckTitle });
      hbInterval=setInterval(()=>{ try{ WS.readyState===1 && WS.send(JSON.stringify({type:'ping'})); lastActivity=Date.now(); }catch{} }, 20000);
      if (lastPending) setTimeout(()=> wsSend(lastPending.msg), 200);
      backoffMs=1000;
    };
    WS.onmessage = (e)=>{
      lastActivity=Date.now(); let msg; try{ msg=JSON.parse(e.data);}catch{return;}
      if (msg.type==='ping'){ try{ WS.send(JSON.stringify({type:'pong'})); }catch{} return; }

      if (msg.type==='play_video' && msg.url){
        hideWait();
        setRemoteStatus('Commande reçue : lecture…');
        let key = Object.entries(KNOWN_VIDEOS).find(([k,u]) => u === msg.url)?.[0];
        let group = 'branch-group';
        if (!key){
          key = Object.entries(OWL_VIDEOS).find(([k,u]) => u === msg.url)?.[0];
          group = 'owl-group';
        }
        if (key){
          if (group === 'branch-group') playBranchVideo(key, msg.url);
          else playOwlVideo(key, msg.url);
        }
        return;
      }
      if (msg.type==='stop_video'){
        hideWait();
        stopCurrentVideoAndReturn(); return;
      }
      if (msg.type==='weather_choice'){
        hideWait();
        const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
        const sun = document.getElementById('weather-sun'); const h = sun ? sections.findIndex(s => s.contains(sun)) : 0;
        const map = { sun:1, cloud:2, rain:3, snow:4 }; const v = map[String(msg.key||'').toLowerCase()] ?? 0;
        Reveal.slide(h, v); if (lastPending?.kind==='weather') lastPending=null; return;
      }
    };
    WS.onerror = ()=> setRemoteStatus('Erreur WebSocket');
    WS.onclose  = ()=>{ clearWsTimers(); setRemoteStatus('WebSocket fermé'); connecting=false; scheduleReconnect(); };
    watchdogInterval=setInterval(()=>{ if(Date.now()-lastActivity>60000){ try{ WS.close(); }catch{} } }, 5000);
  }
  connectWS();
  window.addEventListener('online', ()=>{ if(!WS || WS.readyState !== 1) connectWS(); });
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden && (!WS || WS.readyState !== 1)) connectWS(); });

  function weatherHIndex(){
    const sections = Array.from(document.querySelectorAll('.reveal .slides > section'));
    const sun = document.getElementById('weather-sun');
    return sun ? sections.findIndex(s => s.contains(sun)) : 0;
  }
  function sendWeatherRequest(){
    const h = weatherHIndex();
    const msg = { type:'request_weather', from:'slides', deckTitle,
      options:[
        { title:'Soleil', key:'sun',   thumb:'../../images/sun.png',   goto:{h, v:1} },
        { title:'Nuages', key:'cloud', thumb:'../../images/cloud.png', goto:{h, v:2} },
        { title:'Pluie',  key:'rain',  thumb:'../../images/rain.png',  goto:{h, v:3} },
        { title:'Neige',  key:'snow',  thumb:'../../images/snow.png',  goto:{h, v:4} }
      ],
      note:"en attente d'une réponse" };
    lastPending = { kind:'weather', msg };
    wsSend(msg);
    setRemoteStatus('Demande envoyée…');
    showWait("en attente d'une réponse");
    if (h >= 0) Reveal.slide(h, 0);
  }
  function sendVideoRequest(){
    const options = CHOICES.map((c) => ({ title: c.name, url: c.video, thumb: c.image }));
    const msg = { type: 'request_video', from: 'slides', deckTitle, options, note: "en attente d'une réponse" };
    lastPending = { kind:'video', msg };
    wsSend(msg);
    setRemoteStatus('Demande envoyée. En attente du choix distant…');
    showWait("en attente d'une réponse");
  }
  function sendOwlRequest(){
    const options = [
      { title: 'Hibou rigolo', url: OWL_VIDEOS.ov1, thumb: '../../images/derpyowl.png' },
      { title: 'Hibou sérieux', url: OWL_VIDEOS.ov2, thumb: '../../images/seriousowl.png' }
    ];
    const msg = { type: 'request_video', from: 'slides', deckTitle, options, note: "en attente d'une réponse" };
    lastPending = { kind:'owl', msg };
    wsSend(msg);
    showWait("en attente d'une réponse");
  }
  document.getElementById('remoteBtnWeather')?.addEventListener('click', sendWeatherRequest);
  document.getElementById('remoteBtnVideos') ?.addEventListener('click', sendVideoRequest);
  document.getElementById('remoteBtnOwl')    ?.addEventListener('click', sendOwlRequest);

  // CH image press pulse
  function activateBtn(el){
    if(!el) return;
    el.classList.remove('activate-pulse');
    el.offsetWidth;
    el.classList.add('activate-pulse');
    setTimeout(()=> el && el.classList && el.classList.remove('activate-pulse'), 260);
  }
  document.addEventListener('click', (e)=>{
    const btn = e.target && e.target.closest && e.target.closest('.side-btn');
    if (btn) activateBtn(btn);
  }, true);

  // 'C' hotkey (videos OR weather; owl page too)
  (function enableKidsPictureHotkey(){
    const isTyping = (el) => el && (el.closest && el.closest('input, textarea, select, [contenteditable="true"]'));
    const currentSlide = () => { try{ return Reveal.getCurrentSlide?.(); } catch { return null; } };
    const onVideoChoiceSlide = () => {
      const cur = currentSlide(); if (!cur) return false;
      if (cur.id === 'branch-root') return true;
      return !!cur.closest?.('#branch-group') && (Reveal.getIndices?.().v ?? 0) === 0;
    };
    const onWeatherMenuSlide = () => { const cur = currentSlide(); return !!cur && cur.id === 'weather-menu'; };

    function clickVisibleSideBtnIn(slideEl){
      if (!slideEl) return false;
      const btn = slideEl.querySelector?.('.side-btn');
      if (btn){ try{ btn.focus({preventScroll:true}); }catch{} activateBtn(btn); btn.click(); return true; }
      return false;
    }

    function triggerAction(){
      const cur = currentSlide();

      if (onVideoChoiceSlide()){
        if (clickVisibleSideBtnIn(cur)) return;
        if (typeof remoteBtnVideos !== 'undefined' && remoteBtnVideos){ try{ remoteBtnVideos.focus({preventScroll:true}); }catch{} activateBtn(remoteBtnVideos); remoteBtnVideos.click(); return; }
        try { sendVideoRequest(); } catch {}
        return;
      }

      if (onWeatherMenuSlide()){
        if (clickVisibleSideBtnIn(cur)) return;
        if (typeof remoteBtnWeather !== 'undefined' && remoteBtnWeather){ try{ remoteBtnWeather.focus({preventScroll:true}); }catch{} activateBtn(remoteBtnWeather); remoteBtnWeather.click(); return; }
        try { sendWeatherRequest(); } catch {}
        return;
      }

      if (cur && clickVisibleSideBtnIn(cur)) return;
      if (typeof remoteBtnVideos !== 'undefined' && remoteBtnVideos){ try{ remoteBtnVideos.focus({preventScroll:true}); }catch{} activateBtn(remoteBtnVideos); remoteBtnVideos.click(); return; }
      if (typeof remoteBtnWeather !== 'undefined' && remoteBtnWeather){ try{ remoteBtnWeather.focus({preventScroll:true}); }catch{} activateBtn(remoteBtnWeather); remoteBtnWeather.click(); return; }
    }

    const handler = (e) => {
      if (typeof inputsLocked !== 'undefined' && inputsLocked) return;
      if (isTyping(e.target)) return;
      if (Reveal.isOverview && Reveal.isOverview()) return;
      if (e.key === 'c' || e.key === 'C'){ e.preventDefault(); e.stopImmediatePropagation(); triggerAction(); }
    };

    window.addEventListener('keydown', handler, true);
    document.addEventListener('keydown', handler, true);
  })();

  // Hotkeys Q (return to group root) & R (first slide)
  (function enableHotkeys(){
    const isTyping = (el) => el && (el.closest && el.closest('input, textarea, select, [contenteditable="true"]'));
    window.addEventListener('keydown', (e) => {
      if (isTyping(e.target)) return;
      if (Reveal.isOverview && Reveal.isOverview()) return;

      if (e.key === 'q' || e.key === 'Q') {
        e.preventDefault(); e.stopImmediatePropagation();
        hideWait();
        stopAllWeatherIframes();
        if (inputsLocked && currentVidRef){ stopCurrentVideoAndReturn(); return; }
        const idx = Reveal.getIndices && Reveal.getIndices();
        if (idx && Number.isInteger(idx.h)) { Reveal.slide(idx.h, 0); }
      } else if (e.key === 'r' || e.key === 'R') {
        e.preventDefault(); e.stopImmediatePropagation();
        hideWait();
        stopAllWeatherIframes();
        Reveal.slide(0, 0);
      }
    }, true);
  })();

  /* =========================
     Step-Select Mode (fixed)
     ========================= */
  class StepSelector {
    constructor(slideId, gridEl){
      this.slideId = slideId;
      this.grid = gridEl;
      this.tiles = [];
      this.index = 0;
      this.active = false;
      this.prevRevealKeyboard = true;
      this._onKey = this._onKey.bind(this);
    }
    refresh(){
      if (!this.grid) return;
      this.tiles = Array.from(this.grid.querySelectorAll('.tile'));
    }
    activate(){
      if (this.active) return;
      this.refresh();
      if (!this.tiles.length) return;
      this.active = true;
      // Disable Reveal's keyboard while stepping to avoid slide moves
      try {
        const conf = Reveal.getConfig?.() || {};
        this.prevRevealKeyboard = conf.keyboard !== false;
        Reveal.configure({ keyboard:false });
      } catch {}
      this.index = 0;
      this._apply();
      // Capture BOTH keydown and keyup to cancel default button activation & scrolling
      window.addEventListener('keydown', this._onKey, true);
      window.addEventListener('keyup', this._onKey, true);
    }
    deactivate(){
      if (!this.active) return;
      this.active = false;
      this._clear();
      window.removeEventListener('keydown', this._onKey, true);
      window.removeEventListener('keyup', this._onKey, true);
      // Restore Reveal keyboard
      try { Reveal.configure({ keyboard:this.prevRevealKeyboard }); } catch {}
    }
    toggle(){
      if (this.active) this.deactivate();
      else this.activate();
    }
    next(){
      if (!this.tiles.length) return;
      this.index = (this.index + 1) % this.tiles.length;
      this._apply();
    }
    activateCurrent(){
      const t = this.tiles[this.index];
      if (!t) return;
      try { t.click(); } catch {}
    }
    _apply(){
      this._clear(false);
      const t = this.tiles[this.index];
      if (!t) return;
      t.classList.add('step-highlight');
      t.setAttribute('aria-selected','true');
      // No focusing, no scrollIntoView — purely visual
    }
    _clear(){
      this.tiles.forEach(el => {
        el.classList.remove('step-highlight');
        el.removeAttribute('aria-selected');
      });
    }
    _onKey(e){
      if (!this.active) return;
      const key = (e.key || '').toLowerCase();
      if (key === 'enter'){
        e.preventDefault(); e.stopImmediatePropagation();
        if (e.type === 'keydown') this.next();
        return;
      }
      if (key === ' ' || key === 'spacebar'){
        e.preventDefault(); e.stopImmediatePropagation();
        if (e.type === 'keydown') this.activateCurrent();
        return;
      }
      if (key === 'escape' || key === 'esc' || key === 'q'){
        e.preventDefault(); e.stopImmediatePropagation();
        if (e.type === 'keydown') this.deactivate();
        return;
      }
    }
  }

  const stepSelectors = {
    weather: new StepSelector('weather-menu', document.getElementById('weatherGrid')),
    videos:  new StepSelector('branch-root',  document.getElementById('videoGrid')),
    owl:     new StepSelector('owl-root',     document.getElementById('owlGrid')),
  };
  let currentStepSel = null;

  function toggleStepMode(sel){
    if (!sel) return;
    if (currentStepSel && currentStepSel !== sel) currentStepSel.deactivate();
    sel.toggle();
    currentStepSel = sel.active ? sel : null;
  }

  document.getElementById('stepBtnWeather')?.addEventListener('click', ()=> toggleStepMode(stepSelectors.weather));
  document.getElementById('stepBtnVideos') ?.addEventListener('click', ()=> toggleStepMode(stepSelectors.videos));
  document.getElementById('stepBtnOwl')    ?.addEventListener('click', ()=> toggleStepMode(stepSelectors.owl));

  // Leave Step Mode automatically when leaving its slide
  Reveal.on('slidechanged', (e)=>{
    if (!currentStepSel) return;
    const cur = e.currentSlide;
    if (!cur) { currentStepSel.deactivate(); currentStepSel = null; return; }
    if (cur.id !== currentStepSel.slideId){
      currentStepSel.deactivate();
      currentStepSel = null;
    }
  });

  // Refresh selectors when entering dynamic grids
  Reveal.on('slidechanged', (e)=>{
    if (e.currentSlide?.id === 'branch-root') stepSelectors.videos.refresh();
    if (e.currentSlide?.id === 'weather-menu') stepSelectors.weather.refresh();
    if (e.currentSlide?.id === 'owl-root') stepSelectors.owl.refresh();
  });

  // ===== Keep drag bins at natural size (no transforms) =====
  function scheduleScale(){
    document.querySelectorAll('#drag-transfer .bin-grid').forEach(grid => {
      grid?.style.removeProperty('transform');
    });
  }
  window.addEventListener('resize', scheduleScale);
  Reveal.on('slidechanged', (e)=>{ if (e.currentSlide?.id === 'drag-transfer') scheduleScale(); });
  Reveal.on('ready', ()=>{ if (Reveal.getCurrentSlide()?.id === 'drag-transfer') scheduleScale(); });
  // --- Build photo strip (6 vignettes ≈10vh)
// --- Build photo strip as a draggable bin (same behavior as the 2 boxes)
// --- Build photo strip as simple flex row (no inner grid, no scaling)
(function buildPhotoStrip(){
  const strip = document.getElementById('photoStrip');
  if (!strip) return;
  strip.innerHTML = '';

  const entries = (Array.isArray(PRESENCE_PHOTOS) && PRESENCE_PHOTOS.length)
    ? PRESENCE_PHOTOS.slice(0, 6)
    : Array.from({length:6}, (_,i)=>({
        name: `Élève ${i+1}`,
        src: FALLBACK_PHOTO(`Élève ${i+1}`)
      }));

  entries.forEach((entry, i)=>{
    const label = (entry && typeof entry === 'object' && 'name' in entry)
      ? entry.name
      : `Élève ${i+1}`;
    const primarySrc = (entry && typeof entry === 'object' && 'src' in entry)
      ? entry.src
      : (typeof entry === 'string' ? entry : null);

    const btn = document.createElement('button');
    btn.className = 'photo-card draggable';
    btn.setAttribute('draggable','true');
    btn.dataset.type = 'photo';
    btn.dataset.name = `student-${i}`;
    if (label) btn.dataset.label = label;

    const img = new Image();
    img.loading = 'lazy';
    img.alt = label;
    const fallbackSrc = FALLBACK_PHOTO(label || `Élève ${i+1}`);
    img.src = primarySrc || fallbackSrc;
    img.onerror = ()=>{
      if (img.src !== fallbackSrc) {
        img.onerror = null;
        img.src = fallbackSrc;
      }
    };
    btn.appendChild(img);

    // DnD behavior
    btn.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData('text/plain', btn.dataset.name);
      e.dataTransfer.effectAllowed = 'move';
      btn.classList.add('dragging');
    });
    btn.addEventListener('dragend', ()=>{
      btn.classList.remove('dragging');
      scheduleScale(); // ensure bin layout stays consistent
    });

    strip.appendChild(btn);
  });

  // Make the strip itself accept drops (no inner grid)
  strip.addEventListener('dragover', (e)=>{ e.preventDefault(); strip.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
  strip.addEventListener('dragleave', ()=> strip.classList.remove('drag-over'));
  strip.addEventListener('drop', (e)=>{
    e.preventDefault(); strip.classList.remove('drag-over');
    const dragging = document.querySelector('.draggable.dragging');
    if (dragging) {
      strip.appendChild(dragging);
      dragging.classList.remove('dragging');
      scheduleScale();
    }
  });
})();




// Drag & transfer setup (top photo strip is its own flex bin)
let transferInitialized = false;
function setupTransfer(){
  if (transferInitialized) return;
  transferInitialized = true;

  const left   = document.getElementById('bin-left');
  const right  = document.getElementById('bin-right');
  const strip  = document.getElementById('photoStrip');
  const resetBtn = document.getElementById('resetTransfer');

  // Ensure each *large* bin has an inner .bin-grid (strip does NOT use it)
  function ensureInner(bin){
    if (!bin) return null;
    let inner = bin.querySelector('.bin-grid');
    if (!inner){
      inner = document.createElement('div');
      inner.className = 'bin-grid';
      const kids = Array.from(bin.children);
      kids.forEach(k => inner.appendChild(k));
      bin.appendChild(inner);
    }
    return inner;
  }
  const innerLeft   = ensureInner(left);
  const innerRight  = ensureInner(right);

  // Les bacs commencent vides : seules les photos peuvent être déplacées depuis la bande.
  innerLeft.innerHTML = '';
  innerRight.innerHTML = '';

  // Generic DnD binding for the two large bins
  function bindDnD(bin, inner){
    if (!bin || !inner) return;
    bin.addEventListener('dragover', (e)=>{ e.preventDefault(); bin.classList.add('drag-over'); e.dataTransfer.dropEffect = 'move'; });
    bin.addEventListener('dragleave', ()=> bin.classList.remove('drag-over'));
    bin.addEventListener('drop', (e)=>{
      e.preventDefault(); bin.classList.remove('drag-over');
      const dragging = document.querySelector('.draggable.dragging');
      if (dragging) { inner.appendChild(dragging); dragging.classList.remove('dragging'); scheduleScale(); }
    });
  }
  bindDnD(left,  innerLeft);
  bindDnD(right, innerRight);

  // Reset: ramène toutes les photos dans la bande et vide les bacs
  resetBtn?.addEventListener('click', ()=>{
    // photos
    [...document.querySelectorAll('#bin-left  .draggable[data-type="photo"]'),
     ...document.querySelectorAll('#bin-right .draggable[data-type="photo"]')].forEach(el => strip.appendChild(el));

    innerLeft.innerHTML = '';
    innerRight.innerHTML = '';
    scheduleScale();
  });

  scheduleScale(); // clear any leftover transforms
  window.addEventListener('load', scheduleScale);
}



  Reveal.on('slidechanged', (e)=>{
    if (e.currentSlide && e.currentSlide.id === 'drag-transfer') setupTransfer();
  });
  Reveal.on('ready', ()=>{
    const cur = Reveal.getCurrentSlide();
    if (cur && cur.id === 'drag-transfer') setupTransfer();
    if (window.hljs) hljs.highlightAll();
  });

  // BIG DATE progressive reveal (+ weekday image stacked)
  (function setupBigDate(){
    const elWeekday = document.getElementById('d-weekday');
    const elDay     = document.getElementById('d-day');
    const elMonth   = document.getElementById('d-month');
    const imgWeek   = document.getElementById('weekdayImg');
    const steps     = Array.from(document.querySelectorAll('#dateBig .reveal-step'));
    const hintEl    = document.getElementById('dateHint');
    let dateProgress = 0;

    const cap = (s)=> s ? s.charAt(0).toUpperCase() + s.slice(1) : s;

    function render(){
      const now     = new Date();
      const weekday = new Intl.DateTimeFormat('fr-CA', { weekday:'long' }).format(now); // e.g., 'lundi'
      const day     = new Intl.DateTimeFormat('fr-CA', { day:'2-digit' }).format(now);
      const month   = new Intl.DateTimeFormat('fr-CA', { month:'long' }).format(now);

      if (elWeekday) elWeekday.textContent = cap(weekday);
      if (elDay)     elDay.textContent     = day;
      if (elMonth)   elMonth.textContent   = month.toLowerCase();

      // Set weekday image src/alt
      if (imgWeek){
        const file = `${weekday.toLowerCase()}.png`; // lundi.png, mardi.png, ...
        imgWeek.src = DAY_IMG_DIR + file;
        imgWeek.alt = `Illustration: ${cap(weekday)}`;
      }
    }

    function updateHint(){
      if (!hintEl) return;
      if (dateProgress >= steps.length){
        hintEl.textContent = 'Appuyez sur Espace pour passer à la suite';
        hintEl.style.opacity = '0.75';
      } else {
        hintEl.textContent = 'Appuyez sur Espace pour révéler la date';
        hintEl.style.opacity = '1';
      }
    }

    function resetDateReveal(){
      dateProgress = 0;
      steps.forEach(s => s.classList.remove('show'));
      if (imgWeek) imgWeek.classList.remove('show'); // hide image again
      updateHint();
    }

    function isOnDateSlide(){
      const cur = Reveal.getCurrentSlide?.();
      return !!cur && cur.id === 'date-slide';
    }

    function revealNext(){
      if (dateProgress < steps.length){
        // If first step (weekday text), also show the image
        if (dateProgress === 0 && imgWeek){
          imgWeek.classList.add('show');
        }
        steps[dateProgress].classList.add('show');
        dateProgress++;
        updateHint();
      } else {
        Reveal.next();
      }
    }

    Reveal.on('ready', ()=>{ render(); if (isOnDateSlide()) resetDateReveal(); });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ render(); if (isOnDateSlide()) resetDateReveal(); } });

    Reveal.on('slidechanged', (e)=>{
      if (e.currentSlide && e.currentSlide.id === 'date-slide'){
        render();
        resetDateReveal();
      }
    });

    const isTyping = (el) => el && (el.closest && el.closest('input, textarea, select, [contenteditable="true"]'));
    window.addEventListener('keydown', (e)=>{
      if (typeof inputsLocked !== 'undefined' && inputsLocked) return;
      if (!isOnDateSlide()) return;
      if (isTyping(e.target)) return;

      if (e.key === ' ' || e.key === 'Spacebar' || e.key === 'Enter'){
        e.preventDefault();
        e.stopImmediatePropagation();
        revealNext();
      }
    }, true);
  })();
</script>
</body>
</html>
