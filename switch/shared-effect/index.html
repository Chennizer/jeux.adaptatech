<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-fr="Effets partagés" data-en="Shared Effects" data-ja="共有エフェクト">Effets partagés Ably</title>
  <link rel="stylesheet" href="../../css/global.css">
  <link rel="stylesheet" href="../../css/layout.css">
  <link rel="stylesheet" href="../../css/components.css">
  <link rel="stylesheet" href="../../css/games.css">
  <style>
    :root {
      --edge-bg: #0c1027;
      --panel: rgba(255, 255, 255, 0.85);
      --text: #0f172a;
      --muted: #4b5563;
      --success: #0f9d58;
      --danger: #e54335;
    }

    body {
      background: radial-gradient(circle at 20% 20%, #1c2751 0%, #0c1027 35%, #05060d 70%);
      color: var(--text);
      min-height: 100vh;
    }

    .page-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 64px;
    }

    .quick-start {
      background: var(--panel);
      border-radius: 14px;
      padding: 16px 18px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 18px;
    }

    .quick-start h2 {
      margin-top: 0;
      margin-bottom: 8px;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 600;
      color: var(--muted);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--danger);
      box-shadow: 0 0 0 0 rgba(229, 67, 53, 0.45);
      transition: background 160ms ease, box-shadow 160ms ease;
    }

    .status-chip.connected {
      color: var(--success);
    }

    .status-chip.connected .status-dot {
      background: var(--success);
      box-shadow: 0 0 0 6px rgba(15, 157, 88, 0.22);
    }

    .card {
      background: var(--panel);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.25);
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 14px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control-group label {
      font-weight: 700;
      color: var(--muted);
    }

    .control-group input,
    .control-group select,
    .control-group button {
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.1);
      padding: 10px 12px;
      font-size: 15px;
      background: white;
      color: var(--text);
    }

    .control-group button {
      cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #22d3ee);
      color: white;
      font-weight: 700;
      border: none;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.35);
    }

    .control-group button:hover {
      transform: translateY(-1px);
    }

    .panel-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .effect-stage {
      position: relative;
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
      border-radius: 20px;
      min-height: 320px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .effect-stage::before {
      content: "";
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.08), transparent 50%),
                  radial-gradient(circle at 80% 30%, rgba(255,255,255,0.06), transparent 45%);
      z-index: 0;
    }

    .effect-layer {
      position: absolute;
      inset: -12%;
      pointer-events: none;
      border-radius: 50%;
      opacity: 0.85;
      filter: blur(8px);
      animation: lumen 1100ms ease-out forwards;
      z-index: 2;
    }

    .effect-stage .ripples {
      position: absolute;
      inset: 0;
      pointer-events: none;
      mix-blend-mode: screen;
      z-index: 3;
    }

    .ripple-dot {
      position: absolute;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: white;
      opacity: 0.3;
      animation: ripple 900ms ease-out forwards;
    }

    @keyframes lumen {
      0% {
        background: radial-gradient(circle at 50% 50%, var(--pulse-color) 0%, rgba(0,0,0,0) 35%);
        transform: scale(1.3);
        opacity: 0.95;
      }
      40% {
        background: radial-gradient(circle at 50% 50%, var(--pulse-color) 0%, rgba(0,0,0,0) 55%);
        transform: scale(0.7);
        opacity: 1;
      }
      100% {
        background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.9) 0%, rgba(0,0,0,0) 65%);
        transform: scale(0.15);
        opacity: 0;
      }
    }

    @keyframes ripple {
      from {
        transform: translate(-50%, -50%) scale(0.6);
        opacity: 0.35;
      }
      to {
        transform: translate(-50%, -50%) scale(2.8);
        opacity: 0;
      }
    }

    .muted {
      color: var(--muted);
    }

    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(0,0,0,0.06);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    .pill.active {
      background: linear-gradient(135deg, #fb923c, #facc15);
      color: #1f2937;
      box-shadow: 0 8px 14px rgba(251, 146, 60, 0.35);
    }

    .pill:hover { transform: translateY(-1px); }

    .footer-note {
      margin-top: 12px;
      font-size: 14px;
      color: var(--muted);
    }
  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} // eslint-disable-line
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
  <div class="page-shell">
    <header class="hero-minimalist">
      <p class="muted">Synchronisez vos effets lumineux entre plusieurs onglets.</p>
      <h1 data-fr="Effets partagés avec Ably" data-en="Shared Effects with Ably" data-ja="Ablyで共有するエフェクト">Effets partagés avec Ably</h1>
      <div class="panel-row">
        <div class="status-chip" id="connectionStatus">
          <span class="status-dot" aria-hidden="true"></span>
          <span id="statusLabel">Déconnecté</span>
        </div>
        <div class="muted" id="clientLabel"></div>
      </div>
    </header>

    <section class="quick-start">
      <h2>Guide de démarrage rapide</h2>
      <ol>
        <li>Placez votre clé Ably dans le bloc <strong>config</strong> au début du script (champ <code>ABLY_API_KEY</code>).</li>
        <li>Chargez cette page dans deux onglets ou navigateurs.</li>
        <li>Choisissez une couleur/effet, appuyez sur la barre d'espace pour diffuser, et observez l'animation synchronisée.</li>
      </ol>
    </section>

    <section class="card">
      <div class="controls">
        <div class="control-group">
          <label for="colorInput">Couleur de l'effet</label>
          <input type="color" id="colorInput" value="#ff6b6b" aria-label="Sélection de couleur">
        </div>
        <div class="control-group">
          <label for="effectSelect">Type d'effet</label>
          <select id="effectSelect">
            <option value="flare">Flare</option>
            <option value="pulse">Pulse</option>
            <option value="wave">Wave</option>
          </select>
        </div>
        <div class="control-group">
          <label>&nbsp;</label>
          <button id="triggerBtn" type="button">Déclencher localement</button>
        </div>
      </div>
      <div class="panel-row">
        <div class="pill-list" aria-label="Couleurs rapides">
          <span class="pill" data-color="#ff6b6b" style="background:#ff6b6b;color:#111;">Corail</span>
          <span class="pill" data-color="#22d3ee" style="background:#22d3ee;color:#0f172a;">Cyan</span>
          <span class="pill" data-color="#a855f7" style="background:#a855f7;color:#111;">Violet</span>
          <span class="pill" data-color="#facc15" style="background:#facc15;color:#0f172a;">Or</span>
          <span class="pill" data-color="#10b981" style="background:#10b981;color:#0f172a;">Émeraude</span>
        </div>
      </div>
      <p class="footer-note">Astuce : la couleur et l'effet sont mémorisés (localStorage si disponible). La barre d'espace publie sur le canal <code>shared-effects</code> avec anti-rebond.</p>
    </section>

    <section class="card">
      <h2>Scène</h2>
      <div class="effect-stage" id="stage" aria-live="polite"></div>
    </section>
  </div>

  <script>
    // --------- Configuration ---------
    const config = {
      ABLY_API_KEY: '' // Ajoutez votre clé API Ably ici
    };

    // --------- State ---------
    const clientId = `client-${Math.random().toString(36).slice(2, 8)}`;
    const state = {
      color: localStorage.getItem('sharedEffectColor') || '#ff6b6b',
      effect: localStorage.getItem('sharedEffectType') || 'flare'
    };
    let channel;
    let lastPublish = 0;

    // --------- DOM ---------
    const statusChip = document.getElementById('connectionStatus');
    const statusLabel = document.getElementById('statusLabel');
    const clientLabel = document.getElementById('clientLabel');
    const colorInput = document.getElementById('colorInput');
    const effectSelect = document.getElementById('effectSelect');
    const stage = document.getElementById('stage');
    const triggerBtn = document.getElementById('triggerBtn');

    clientLabel.textContent = `clientId: ${clientId}`;
    colorInput.value = state.color;
    effectSelect.value = state.effect;

    function updateStatus(connected, text) {
      statusChip.classList.toggle('connected', connected);
      statusLabel.textContent = text;
    }

    function savePrefs() {
      try {
        localStorage.setItem('sharedEffectColor', state.color);
        localStorage.setItem('sharedEffectType', state.effect);
      } catch (err) {
        // ignore storage errors
      }
    }

    function chooseColor(color) {
      state.color = color;
      colorInput.value = color;
      savePrefs();
    }

    function chooseEffect(effect) {
      state.effect = effect;
      effectSelect.value = effect;
      savePrefs();
    }

    // --------- Animation ---------
    function spawnRipples(color) {
      const ripples = document.createElement('div');
      ripples.className = 'ripples';
      const positions = [
        [25, 30], [50, 20], [75, 35], [35, 60], [60, 70]
      ];
      positions.forEach(([x, y]) => {
        const dot = document.createElement('div');
        dot.className = 'ripple-dot';
        dot.style.left = `${x}%`;
        dot.style.top = `${y}%`;
        dot.style.background = color;
        ripples.appendChild(dot);
      });
      stage.appendChild(ripples);
      setTimeout(() => ripples.remove(), 900);
    }

    function triggerEffect(color, effect) {
      const layer = document.createElement('div');
      layer.className = 'effect-layer';
      layer.style.setProperty('--pulse-color', color);
      if (effect === 'wave') {
        layer.style.filter = 'blur(12px) saturate(1.2)';
        layer.style.animationDuration = '1400ms';
      } else if (effect === 'pulse') {
        layer.style.animationDuration = '900ms';
      }
      stage.appendChild(layer);
      spawnRipples(color);
      setTimeout(() => layer.remove(), 1600);
    }

    // --------- Ably ---------
    function initAbly() {
      if (!config.ABLY_API_KEY) {
        updateStatus(false, 'Clé Ably manquante');
        return;
      }
      const realtime = new Ably.Realtime({ key: config.ABLY_API_KEY, clientId });
      channel = realtime.channels.get('shared-effects');

      realtime.connection.on('connected', () => updateStatus(true, 'Connecté'));
      realtime.connection.on('disconnected', () => updateStatus(false, 'Déconnecté'));
      realtime.connection.on('failed', () => updateStatus(false, 'Erreur de connexion'));

      channel.subscribe('message', (msg) => {
        const data = msg.data || {};
        if (!data.color || !data.effect) return;
        triggerEffect(data.color, data.effect);
      });
    }

    // --------- Publish ---------
    function publishSpace() {
      const now = Date.now();
      if (now - lastPublish < 350) return;
      lastPublish = now;
      const payload = {
        type: 'space',
        color: state.color,
        effect: state.effect,
        clientId
      };
      if (channel) {
        channel.publish('message', payload);
      }
      triggerEffect(state.color, state.effect);
    }

    // --------- Events ---------
    document.addEventListener('keydown', (event) => {
      if (event.code === 'Space') {
        event.preventDefault();
        publishSpace();
      }
    });

    triggerBtn.addEventListener('click', publishSpace);

    colorInput.addEventListener('input', (e) => chooseColor(e.target.value));
    effectSelect.addEventListener('change', (e) => chooseEffect(e.target.value));

    document.querySelectorAll('.pill').forEach(pill => {
      pill.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        chooseColor(pill.dataset.color);
      });
      if (pill.dataset.color === state.color) {
        pill.classList.add('active');
      }
    });

    updateStatus(false, 'Initialisation...');
    initAbly();
  </script>
</body>
</html>
