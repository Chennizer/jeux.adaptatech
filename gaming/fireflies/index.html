<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title class="translate" data-fr="Lucioles : jeu switch" data-en="Fireflies : switch game">Lucioles : jeu switch</title>

  <link rel="stylesheet" href="../../css/otherswitch.css">

  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: radial-gradient(circle at 20% 20%, rgba(30,45,70,0.9), #04050a 70%);
      color: #fff;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
    }

    canvas {
      display: block;
      position: fixed;
      inset: 0;
    }

    #promptOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 18px;
      background: rgba(6, 10, 20, 0.88);
      text-align: center;
      padding: 24px;
      z-index: 10000;
    }

    #promptOverlay p {
      max-width: 520px;
      font-size: clamp(20px, 3vw, 28px);
      line-height: 1.35;
      color: #f4fbff;
      text-shadow: 0 4px 18px rgba(0, 0, 0, 0.45);
    }

    #startButton {
      padding: 14px 34px;
      font-size: clamp(20px, 2.8vw, 26px);
      border: none;
      border-radius: 999px;
      cursor: pointer;
      background: linear-gradient(135deg, #00c9a7, #0077ff);
      color: #fff;
      box-shadow: 0 16px 38px rgba(0, 80, 160, 0.45);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    #startButton:active,
    #startButton:focus {
      transform: translateY(1px);
      box-shadow: 0 10px 26px rgba(0, 60, 130, 0.5);
      outline: none;
    }

    #infoButton {
      position: absolute;
      top: 18px;
      right: 18px;
      background: none;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-radius: 999px;
      width: 52px;
      height: 52px;
      color: #fff;
      font-size: 26px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, color 0.2s ease;
    }

    #infoButton:focus-visible {
      outline: 3px solid #00d1c1;
    }

    #infoButton:hover {
      background: rgba(255, 255, 255, 0.18);
      color: #e9ffff;
    }

    #infoModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(4, 8, 16, 0.92);
      border: 2px solid rgba(0, 200, 200, 0.45);
      box-shadow: 0 18px 42px rgba(0, 0, 0, 0.55);
      padding: 22px 26px;
      border-radius: 14px;
      color: #dff9ff;
      width: min(420px, 86vw);
      z-index: 11000;
      text-align: center;
    }

    #infoModal button {
      margin-top: 14px;
      padding: 10px 22px;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      background: #00b9d6;
      color: #02111f;
      font-weight: 600;
    }

    #settings-icon {
      position: fixed;
      top: 18px;
      right: 18px;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: rgba(4, 12, 24, 0.78);
      color: #e8feff;
      font-size: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(0, 170, 255, 0.35);
      backdrop-filter: blur(6px);
    }

    #menu {
      position: fixed;
      top: 76px;
      right: 16px;
      width: clamp(240px, 30vw, 320px);
      background: rgba(6, 12, 24, 0.9);
      border-radius: 16px;
      padding: 18px 20px;
      color: #eaffff;
      box-shadow: 0 20px 46px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(0, 180, 255, 0.35);
      backdrop-filter: blur(10px);
      display: none;
      z-index: 9999;
    }

    #menu.show {
      display: block;
    }

    #menu h2 {
      margin: 0 0 14px;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      color: #8df5ff;
    }

    #menu h3 {
      margin: 16px 0 8px;
      font-size: 0.95rem;
      color: #79eaff;
    }

    #menu label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }

    #menu input[type="range"] {
      width: 100%;
    }

    #menu span.value {
      display: inline-block;
      min-width: 2ch;
      text-align: right;
      font-variant-numeric: tabular-nums;
      margin-left: 6px;
      color: #bdf9ff;
    }

    #menu .inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    #menu .inline span {
      flex: 1;
    }

    #menu .inline input[type="checkbox"] {
      transform: scale(1.2);
    }
  </style>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>
<body>
  <canvas id="fireflyCanvas" aria-hidden="true"></canvas>

  <div id="promptOverlay">
    <button id="infoButton" class="translate" data-fr="ⓘ" data-en="ⓘ">ⓘ</button>
    <p class="translate" data-fr="Appuie sur la barre d’espace pour faire danser les lucioles. Chaque pression déclenche une pluie d’étincelles lumineuses." data-en="Press the space bar to make the fireflies dance. Each press launches a shower of glowing sparks.">
      Appuie sur la barre d’espace pour faire danser les lucioles. Chaque pression déclenche une pluie d’étincelles lumineuses.
    </p>
    <button id="startButton" class="translate" data-fr="Commencer" data-en="Start">Commencer</button>
  </div>

  <div id="infoModal">
    <p class="translate" data-fr="Compétence&nbsp;: appui simple<br>SENICT niveau&nbsp;1 · Roadmap&nbsp;8-10" data-en="Skill: single press<br>SENICT level&nbsp;1 · Roadmap&nbsp;8-10">
      Compétence : appui simple<br>SENICT niveau 1 · Roadmap 8-10
    </p>
    <button id="closeModal" class="translate" data-fr="Fermer" data-en="Close">Fermer</button>
  </div>

  <div id="settings-icon" class="translate" data-fr="⚙️" data-en="⚙️" title="Settings">⚙️</div>

  <div id="menu">
    <h2 class="translate" data-fr="Options" data-en="Options">Options</h2>

    <h3 class="translate" data-fr="Musique &amp; son" data-en="Music &amp; sound">Musique &amp; son</h3>
    <label class="inline">
      <span class="translate" data-fr="Désactiver la musique" data-en="Disable music">Désactiver la musique</span>
      <input type="checkbox" id="muteMusic">
    </label>
    <label>
      <span class="translate" data-fr="Volume musique" data-en="Music volume">Volume musique</span>
      <span class="value" id="musicVolVal">50</span>
      <input type="range" id="musicVol" min="0" max="100" value="50">
    </label>

    <label class="inline">
      <span class="translate" data-fr="Désactiver les effets" data-en="Disable SFX">Désactiver les effets</span>
      <input type="checkbox" id="muteSFX">
    </label>
    <label>
      <span class="translate" data-fr="Volume effets" data-en="SFX volume">Volume effets</span>
      <span class="value" id="sfxVolVal">60</span>
      <input type="range" id="sfxVol" min="0" max="100" value="60">
    </label>

    <h3 class="translate" data-fr="Lucioles" data-en="Fireflies">Lucioles</h3>
    <label>
      <span class="translate" data-fr="Intensité" data-en="Intensity">Intensité</span>
      <span class="value" id="intensityVal">50</span>
      <input type="range" id="intensitySlider" min="0" max="100" value="50">
    </label>
    <label>
      <span class="translate" data-fr="Taille" data-en="Size">Taille</span>
      <span class="value" id="sizeVal">105</span>
      <input type="range" id="sizeSlider" min="10" max="200" value="105">
    </label>
    <label>
      <span class="translate" data-fr="Traînée" data-en="Trail">Traînée</span>
      <span class="value" id="trailVal">50</span>
      <input type="range" id="trailSlider" min="0" max="100" value="50">
    </label>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const canvas = document.getElementById('fireflyCanvas');
      const ctx = canvas.getContext('2d', { alpha: false });
      let W = 0, H = 0;

      const state = {
        running: false,
        intensity: 50,
        size: 105,
        trail: 50,
        musicMuted: false,
        sfxMuted: false,
        musicVol: 0.5,
        sfxVol: 0.6
      };

      const mouse = { x: 0, y: 0, vx: 0, vy: 0 };
      const target = { x: 0, y: 0 };
      let holdTargetTimer = 0;
      let sparkleQueued = false;
      let sparkleCooldown = 0;

      const music = new Audio('../../songs/space/spacebest1.mp3');
      music.loop = true;
      music.preload = 'auto';
      music.volume = state.musicVol;

      let audioCtx = null;
      function ensureAudioCtx(){
        if (!audioCtx){
          const AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return null;
          audioCtx = new AC();
        }
        return audioCtx;
      }

      function playBurstPing(){
        if (state.sfxMuted) return;
        const ac = ensureAudioCtx();
        if (!ac) return;
        if (ac.state === 'suspended' && ac.resume) ac.resume();
        const now = ac.currentTime;
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(660, now);
        osc.frequency.exponentialRampToValueAtTime(820, now + 0.22);
        const vol = Math.max(0.0001, state.sfxVol * 0.4);
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(vol, now + 0.04);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.28);
        osc.connect(gain).connect(ac.destination);
        osc.start(now);
        osc.stop(now + 0.32);
      }

      const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
      const lerp = (a, b, t) => a + (b - a) * t;

      function mapTrail(){
        const t = state.trail / 100;
        const shaped = Math.pow(1 - t, 2.2);
        return clamp(0.01 + shaped * 0.98, 0.01, 0.99);
      }

      function mapIntensity(){
        const t = state.intensity / 100;
        return clamp(Math.pow(t, 1.6), 0, 1);
      }

      function sizeNorm(){
        return clamp((state.size - 10) / 190, 0, 1);
      }

      function clearToBg(hard = false){
        ctx.globalCompositeOperation = 'source-over';
        if (hard){
          ctx.globalAlpha = 1;
        } else {
          ctx.globalAlpha = mapTrail();
        }
        ctx.fillStyle = '#04050a';
        ctx.fillRect(0, 0, W, H);
        ctx.globalAlpha = 1;
      }

      const FIREFLIES = { list: [], t: 0 };
      const FIREFLY_NEIGHBORS = { a: [], b: [] };
      const FIREFLY_SPRITE_SIZE = 256;
      const FIREFLY_SPRITES = new Map();

      function getFireflySprite(hue){
        const quant = ((Math.round(hue / 12) * 12) % 360 + 360) % 360;
        const key = `${quant}`;
        let sprite = FIREFLY_SPRITES.get(key);
        if (!sprite){
          const canvas = document.createElement('canvas');
          canvas.width = canvas.height = FIREFLY_SPRITE_SIZE;
          const gctx = canvas.getContext('2d');
          const cx = FIREFLY_SPRITE_SIZE / 2;

          const bloom = gctx.createRadialGradient(cx, cx, cx * 0.10, cx, cx, cx * 0.95);
          bloom.addColorStop(0.0, `hsla(${quant}, 100%, 70%, 1)`);
          bloom.addColorStop(0.55, `hsla(${(quant + 16) % 360}, 95%, 55%, 0.65)`);
          bloom.addColorStop(1.0, `hsla(${(quant + 56) % 360}, 85%, 45%, 0)`);
          gctx.fillStyle = bloom;
          gctx.fillRect(0, 0, FIREFLY_SPRITE_SIZE, FIREFLY_SPRITE_SIZE);

          const highlight = gctx.createRadialGradient(cx * 0.68, cx * 0.68, cx * 0.06, cx * 0.68, cx * 0.68, cx * 0.28);
          highlight.addColorStop(0.0, `hsla(${(quant + 36) % 360}, 100%, 90%, 0.75)`);
          highlight.addColorStop(1.0, `hsla(${(quant + 36) % 360}, 100%, 90%, 0)`);
          gctx.fillStyle = highlight;
          gctx.fillRect(0, 0, FIREFLY_SPRITE_SIZE, FIREFLY_SPRITE_SIZE);

          sprite = { canvas, radius: FIREFLY_SPRITE_SIZE / 2 };
          FIREFLY_SPRITES.set(key, sprite);
        }
        return sprite;
      }

      function firefliesInit(){
        FIREFLIES.list.length = 0;
        const sN = sizeNorm();
        const n = Math.floor(70 + 240 * sN);
        const spread = Math.hypot(W, H) * 0.6;
        const neighborA = FIREFLY_NEIGHBORS.a;
        const neighborB = FIREFLY_NEIGHBORS.b;
        neighborA.length = n;
        neighborB.length = n;

        for (let i = 0; i < n; i++){
          const z = 0.58 + Math.random() * 0.82;
          const invZ = 1 / z;
          const ang = Math.random() * Math.PI * 2;
          const rad = Math.sqrt(Math.random()) * spread;
          const cx = W * 0.5 + Math.cos(ang) * rad;
          const cy = H * 0.5 + Math.sin(ang) * rad;

          FIREFLIES.list.push({
            x: cx, y: cy, px: cx, py: cy,
            vx: (Math.random() - 0.5) * 0.25,
            vy: (Math.random() - 0.5) * 0.25,
            z,
            invZ,
            hue: 170 + Math.random() * 80,
            glow: 0.2 + Math.random() * 0.4,
            phase: Math.random() * Math.PI * 2,
          });
        }

        const shortOffset = Math.min(n - 1, 13);
        const longOffset = Math.min(n - 1, Math.max(shortOffset + 1, Math.round(n * 0.24)));
        for (let i = 0; i < n; i++){
          neighborA[i] = (i + shortOffset) % n;
          neighborB[i] = (i + longOffset) % n;
        }
      }

      function drawGlowSprite(sprite, x, y, radius, alpha, composite = 'screen'){
        if (!sprite || alpha <= 0.001) return;
        ctx.save();
        ctx.globalCompositeOperation = composite;
        ctx.globalAlpha = alpha;
        const scale = radius / sprite.radius;
        ctx.translate(x, y);
        ctx.scale(scale, scale);
        ctx.drawImage(sprite.canvas, -sprite.radius, -sprite.radius);
        ctx.restore();
      }

      function flyWrap(f){
        const pad = 80;
        let wrapped = false;
        if (f.x < -pad){ f.x = W + pad; wrapped = true; }
        if (f.x > W + pad){ f.x = -pad; wrapped = true; }
        if (f.y < -pad){ f.y = H + pad; wrapped = true; }
        if (f.y > H + pad){ f.y = -pad; wrapped = true; }
        if (wrapped){ f.px = f.x; f.py = f.y; }
        return wrapped;
      }

      function applySparkle(){
        const intensity = mapIntensity();
        const skip = Math.max(1, Math.floor(3 + 6 * (1 - intensity)));
        for (let k = 0; k < FIREFLIES.list.length; k += skip){
          const f = FIREFLIES.list[k];
          f.glow = Math.max(f.glow, 1.0);
          f.hue = (f.hue + 10) % 360;
        }
      }

      function renderFireflies(dt){
        const intensity = mapIntensity();
        const sN = sizeNorm();
        FIREFLIES.t += dt;

        if (holdTargetTimer > 0){
          holdTargetTimer = Math.max(0, holdTargetTimer - dt);
        } else {
          target.x += (W * 0.5 - target.x) * Math.min(dt * 0.6, 1);
          target.y += (H * 0.5 - target.y) * Math.min(dt * 0.6, 1);
        }

        target.x = clamp(target.x, -80, W + 80);
        target.y = clamp(target.y, -80, H + 80);

        const prevX = mouse.x;
        const prevY = mouse.y;
        const ease = Math.min(1, dt * 3.2);
        mouse.x += (target.x - mouse.x) * ease;
        mouse.y += (target.y - mouse.y) * ease;
        mouse.vx = (mouse.x - prevX) / Math.max(dt, 0.0001);
        mouse.vy = (mouse.y - prevY) / Math.max(dt, 0.0001);

        clearToBg(false);

        const baseWander = 0.10 + 0.12 * intensity;
        const attractK = 6 + 32 * intensity;
        const repelK = 12 + 22 * intensity;
        const maxSpeed = 10 + 24 * intensity;
        const damp = Math.pow(0.975, dt * 60);
        const velScale = dt * 38;

        const pullR = 220 + 380 * sN;
        const pullR2 = pullR * pullR;
        const nearRange = 180 + 260 * sN;
        const nearRange2 = nearRange * nearRange;
        const repelR = 140 + 260 * sN;
        const repelR2 = repelR * repelR;
        const hopXLimit = W * 0.45;
        const hopYLimit = H * 0.45;

        const neighborsA = FIREFLY_NEIGHBORS.a;
        const neighborsB = FIREFLY_NEIGHBORS.b;

        const N = FIREFLIES.list.length;
        for (let i = 0; i < N; i++){
          const f = FIREFLIES.list[i];
          f.px = f.x; f.py = f.y;

          const dx = mouse.x - f.x;
          const dy = mouse.y - f.y;
          const dist2 = dx * dx + dy * dy;
          let near = 0;
          let dist = 0;
          if (dist2 < nearRange2){
            dist = Math.sqrt(dist2);
            near = clamp(1 - (dist / nearRange), 0, 1);
          } else if (dist2 < pullR2){
            dist = Math.sqrt(dist2);
          }

          const invZ = f.invZ;
          const wanderLocal = baseWander * (1 + 0.9 * (1 - near));

          f.vx += (Math.random() - 0.5) * wanderLocal * invZ;
          f.vy += (Math.random() - 0.5) * wanderLocal * invZ;

          if (dist2 < pullR2 && dist > 0){
            const t = 1 - dist / pullR;
            const pull = attractK * (0.25 + 0.75 * t) * dt * invZ / 320;
            f.vx += dx * pull;
            f.vy += dy * pull;
          }

          const idxA = neighborsA[i];
          const idxB = neighborsB[i];
          const gA = FIREFLIES.list[idxA];
          if (gA && gA !== f){
            const rx = f.x - gA.x;
            const ry = f.y - gA.y;
            const rd2 = rx * rx + ry * ry + 0.0001;
            if (rd2 < repelR2){
              const inv = 1 / Math.sqrt(rd2);
              const repelScale = (repelK * (1 - rd2 / repelR2)) * dt * invZ / 120;
              f.vx += rx * inv * repelScale;
              f.vy += ry * inv * repelScale;
            }
          }
          const gB = FIREFLIES.list[idxB];
          if (gB && gB !== f){
            const rx = f.x - gB.x;
            const ry = f.y - gB.y;
            const rd2 = rx * rx + ry * ry + 0.0001;
            if (rd2 < repelR2){
              const inv = 1 / Math.sqrt(rd2);
              const repelScale = (repelK * (1 - rd2 / repelR2)) * dt * invZ / 120;
              f.vx += rx * inv * repelScale;
              f.vy += ry * inv * repelScale;
            }
          }

          const cdx = (W * 0.5 - f.x), cdy = (H * 0.5 - f.y);
          f.vx += cdx * 0.000015;
          f.vy += cdy * 0.000015;

          const maxLocal = maxSpeed * invZ;
          const maxLocalSq = maxLocal * maxLocal;
          const magSq = f.vx * f.vx + f.vy * f.vy;
          if (magSq > maxLocalSq && magSq > 0){
            const scale = maxLocal / Math.sqrt(magSq);
            f.vx *= scale;
            f.vy *= scale;
          }
          f.vx *= damp; f.vy *= damp;
          f.x += f.vx * velScale;
          f.y += f.vy * velScale;

          const wrapped = flyWrap(f);
          if (!wrapped){
            const hopX = Math.abs(f.x - f.px);
            const hopY = Math.abs(f.y - f.py);
            if (hopX > hopXLimit || hopY > hopYLimit){ f.px = f.x; f.py = f.y; }
          }

          f.phase += dt * (0.6 + 1.4 * intensity);
          const twinkle = 0.5 + 0.5 * Math.sin(f.phase + f.x * 0.01 + f.y * 0.01);
          const baseGlow = 0.20 + 0.26 * twinkle;
          f.glow = clamp(baseGlow + near * (0.50 + 0.42 * intensity), 0.10, 1.5);
        }

        const trailAlpha = 0.05 + 0.11 * intensity;
        const baseTrailW = 1.0 + 1.3 * intensity;
        const sizeBoost = 1.72;
        const bloomScale = 4.8 + 5.8 * intensity;
        const coreAlpha = clamp(0.22 + 0.28 * intensity, 0, 0.6);
        const bloomBase = clamp(0.05 + 0.10 * intensity, 0, 0.32);

        ctx.lineCap = 'round';
        ctx.globalCompositeOperation = 'screen';
        for (let i = 0; i < N; i++){
          const f = FIREFLIES.list[i];
          ctx.strokeStyle = `hsla(${(f.hue + 30) | 0}, 90%, 72%, ${trailAlpha})`;
          ctx.lineWidth = Math.max(1, baseTrailW * f.invZ);
          ctx.beginPath(); ctx.moveTo(f.px, f.py); ctx.lineTo(f.x, f.y); ctx.stroke();

          const coreR = sizeBoost * (2.4 + 4.1 * f.glow) * f.invZ;
          const bloomR = coreR * bloomScale;
          const aCore = coreAlpha;
          const aBloom = bloomBase * clamp(f.glow / 3.2, 0.35, 0.95);
          const sprite = getFireflySprite(f.hue);
          drawGlowSprite(sprite, f.x, f.y, bloomR, aBloom, 'screen');
          ctx.globalCompositeOperation = 'lighter';
          ctx.globalAlpha = 1;
          ctx.fillStyle = `hsla(${f.hue | 0}, 100%, 68%, ${aCore})`;
          ctx.beginPath();
          ctx.arc(f.x, f.y, coreR, 0, Math.PI * 2);
          ctx.fill();
          ctx.globalCompositeOperation = 'screen';
        }
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 1;

        if (sparkleQueued){
          sparkleQueued = false;
          applySparkle();
        }

        if (sparkleCooldown > 0){
          sparkleCooldown = Math.max(0, sparkleCooldown - dt);
        }
      }

      function resize(){
        const dpr = window.devicePixelRatio || 1;
        W = Math.floor(window.innerWidth * dpr);
        H = Math.floor(window.innerHeight * dpr);
        canvas.width = W;
        canvas.height = H;
        canvas.style.width = '100vw';
        canvas.style.height = '100vh';
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        W = window.innerWidth;
        H = window.innerHeight;
        mouse.x = W * 0.5;
        mouse.y = H * 0.5;
        target.x = mouse.x;
        target.y = mouse.y;
        firefliesInit();
        clearToBg(true);
      }

      resize();
      window.addEventListener('resize', () => {
        resize();
        if (!state.running) clearToBg(true);
      });

      function triggerBurst(userRequested = false){
        if (userRequested && sparkleCooldown > 0) return;
        const radius = Math.min(W, H) * 0.35;
        const ang = Math.random() * Math.PI * 2;
        target.x = clamp(W * 0.5 + Math.cos(ang) * radius, 40, W - 40);
        target.y = clamp(H * 0.5 + Math.sin(ang) * radius, 40, H - 40);
        holdTargetTimer = 0.9;
        sparkleQueued = true;
        if (userRequested){
          sparkleCooldown = 0.32;
          playBurstPing();
        }
      }

      let lastTime = null;
      function loop(t){
        if (state.running){
          if (lastTime === null) lastTime = t;
          const dt = Math.min((t - lastTime) / 1000, 0.05);
          lastTime = t;
          renderFireflies(dt);
        } else {
          lastTime = t;
        }
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);

      const overlay = document.getElementById('promptOverlay');
      const startButton = document.getElementById('startButton');
      const infoButton = document.getElementById('infoButton');
      const infoModal = document.getElementById('infoModal');
      const closeModal = document.getElementById('closeModal');
      const settingsIcon = document.getElementById('settings-icon');
      const menu = document.getElementById('menu');

      startButton.addEventListener('pointerup', () => {
        overlay.style.display = 'none';
        settingsIcon.style.visibility = 'visible';
        state.running = true;
        ensureAudioCtx();
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        if (!state.musicMuted){
          music.volume = state.musicVol;
          music.play().catch(() => {});
        }
        triggerBurst(false);
      });

      settingsIcon.addEventListener('pointerup', (ev) => {
        ev.stopPropagation();
        menu.classList.toggle('show');
      });

      document.addEventListener('pointerup', (ev) => {
        if (!menu.contains(ev.target) && ev.target !== settingsIcon){
          menu.classList.remove('show');
        }
      });

      infoButton.addEventListener('pointerup', (ev) => {
        ev.stopPropagation();
        infoModal.style.display = 'block';
      });
      closeModal.addEventListener('pointerup', () => {
        infoModal.style.display = 'none';
      });

      document.addEventListener('keydown', (ev) => {
        if (ev.code === 'Space'){
          ev.preventDefault();
          if (state.running){
            triggerBurst(true);
          }
        }
      });

      const muteMusic = document.getElementById('muteMusic');
      const musicVol = document.getElementById('musicVol');
      const musicVolVal = document.getElementById('musicVolVal');
      const muteSFX = document.getElementById('muteSFX');
      const sfxVol = document.getElementById('sfxVol');
      const sfxVolVal = document.getElementById('sfxVolVal');
      const intensitySlider = document.getElementById('intensitySlider');
      const intensityVal = document.getElementById('intensityVal');
      const sizeSlider = document.getElementById('sizeSlider');
      const sizeVal = document.getElementById('sizeVal');
      const trailSlider = document.getElementById('trailSlider');
      const trailVal = document.getElementById('trailVal');

      muteMusic.addEventListener('change', (ev) => {
        state.musicMuted = ev.target.checked;
        if (state.musicMuted){
          music.pause();
        } else if (state.running){
          music.volume = state.musicVol;
          music.play().catch(() => {});
        }
      });

      musicVol.addEventListener('input', (ev) => {
        const val = Number(ev.target.value);
        state.musicVol = clamp(val / 100, 0, 1);
        musicVolVal.textContent = val;
        if (!state.musicMuted){
          music.volume = state.musicVol;
        }
      });

      muteSFX.addEventListener('change', (ev) => {
        state.sfxMuted = ev.target.checked;
      });

      sfxVol.addEventListener('input', (ev) => {
        const val = Number(ev.target.value);
        state.sfxVol = clamp(val / 100, 0, 1);
        sfxVolVal.textContent = val;
      });

      intensitySlider.addEventListener('input', (ev) => {
        const val = Number(ev.target.value);
        state.intensity = clamp(val, 0, 100);
        intensityVal.textContent = val;
      });

      sizeSlider.addEventListener('input', (ev) => {
        const val = Number(ev.target.value);
        state.size = clamp(val, 10, 200);
        sizeVal.textContent = val;
        firefliesInit();
      });

      trailSlider.addEventListener('input', (ev) => {
        const val = Number(ev.target.value);
        state.trail = clamp(val, 0, 100);
        trailVal.textContent = val;
      });
    });
  </script>

  <script src="../../js/translationonly.js"></script>
</body>
</html>
