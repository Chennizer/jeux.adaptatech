<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>L’école donne des ailes — ailes détaillées (p5.js)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- p5.js -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/p5.min.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#0b0e17; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #title{
      position:fixed; top:48px; left:0; right:0; text-align:center; z-index:2;
      color:rgba(255,255,255,.85); letter-spacing:.3px;
    }
    #title::before, #title::after{
      content:""; display:inline-block; vertical-align:middle; width:min(18vw,200px); height:1px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.18)); margin:0 14px;
    }
    #title::after{ transform:scaleX(-1); }
    #hint{
      position:fixed; left:12px; bottom:12px; z-index:2;
      background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.18);
      padding:8px 12px; border-radius:12px; font-size:14px; white-space:pre-line; backdrop-filter:blur(6px);
    }
    #vignette{
      position:fixed; inset:0; pointer-events:none; z-index:1;
      background:
        radial-gradient(1200px 60% at 50% 78%, rgba(255,255,255,.07) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(100% 100% at 50% 50%, rgba(0,0,0,0) 55%, rgba(0,0,0,.35) 100%);
    }
  </style>
</head>
<body>
  <div id="vignette" aria-hidden="true"></div>
  <div id="title">L’école donne des ailes</div>
  <div id="hint">Espace = ouvrir les ailes · R = réinitialiser · F = plein écran</div>

<script>
/* ==========================================================
   Ailes seules, détaillées (texture de plumes)
   - Silhouette retirée, aucune articulation visible
   - ESPACE ouvre par paliers jusqu’aux bords
   - Plumes: rachis + barbules + liserés, palette iridescente
   ========================================================== */

let cx, cy;
let ouvertureCible = 0;      // 0..1
let ouverture = 0;           // interpolation
const reducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

// Géométrie & densité
const margeBords   = 20;
const epauleOffset = 68;     // ancrage invisible des ailes depuis le centre
const N_PRIM = 18;           // primaires (grandes)
const N_SECO = 14;           // secondaires (moyennes)
const N_COVR = 12;           // couvertures (petites, près du corps)

function setup(){
  createCanvas(windowWidth, windowHeight);
  frameRate(60);
  colorMode(HSB, 360, 100, 100, 255);
  cx = width/2; cy = height/2 + 20;

  // Bloque le scroll quand on appuie sur Espace
  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') e.preventDefault();
  }, {passive:false});
}

function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
  cx = width/2; cy = height/2 + 20;
}

function draw(){
  drawFond();

  // Animation douce de l’ouverture
  ouverture = lerp(ouverture, ouvertureCible, reducedMotion ? 0.08 : 0.13);

  // Ailes
  drawWing(+1); // droite
  drawWing(-1); // gauche
}

/* ----------------------- Entrées ----------------------- */
function keyPressed(){
  if (key === ' ' || keyCode === 32){
    ouvertureCible = min(1, ouvertureCible + 0.12);
  }
  if (key === 'r' || key === 'R'){
    ouvertureCible = 0; ouverture = 0;
  }
  if (key === 'f' || key === 'F'){
    const el = document.documentElement;
    const isFs = document.fullscreenElement != null;
    if (!isFs) el.requestFullscreen?.(); else document.exitFullscreen?.();
  }
}

/* -------------------- Arrière-plan -------------------- */
function drawFond(){
  // Dégradé vertical nuit bleutée (RGB pour éviter dérives HSB)
  colorMode(RGB, 255);
  noStroke();
  for (let i=0;i<height;i+=3){
    const k = i/height;
    const r = lerp(21, 5, k);
    const g = lerp(26, 8, k);
    const b = lerp(54,18, k);
    fill(r,g,b);
    rect(0,i,width,3);
  }
  // Ligne décorative
  stroke(255,255,255, 20);
  line(0, height*0.22, width, height*0.22);
  colorMode(HSB, 360, 100, 100, 255);
}

/* ------------------------- Ailes ------------------------- */
function drawWing(side){
  push();
  translate(cx + side*epauleOffset, cy - 6);
  scale(side, 1); // miroir pour la gauche

  // Angle base (replié → ouvert)
  const angleBase = radians( mapClamp(ouverture, 0,1, 74, 4) );
  // Écart angulaire entre plumes
  const ecart = mapClamp(ouverture, 0,1, 10, 44);

  // Longueur maximale pour toucher le bord en ouverture totale
  const LMAX = max(30, (width/2 - margeBords - epauleOffset));

  // Halo doux derrière
  push();
  blendMode(ADD);
  noStroke();
  const haloA = 18 + 60*ouverture;
  for (let i=0;i<3;i++){
    fill(210, 40, 90, haloA/(i+1)); // bleu froid en HSB
    const rr = map(ouverture, 0,1, 120, 220) + i*40;
    ellipse(0, 0, rr*1.6, rr*1.0);
  }
  pop();

  // ORDRE: primaires → secondaires → couvertures (pour donner de la profondeur)

  // 1) Primaires (grandes)
  for (let i=0; i<N_PRIM; i++){
    const t = i/(N_PRIM-1 || 1);
    const lenFinal = lerp(LMAX*0.52, LMAX, pow(t, 0.92));
    const len = lerp(lenFinal*0.58, lenFinal, ouverture);
    const ep  = lerp(24, 14, t);
    const ang = -angleBase - radians(t*ecart);
    const col = paletteIridescent(t, 0.95);   // HSB
    featherDetailed(len, ep, ang, col, /*withRachis*/ true, /*barbules*/ true);
  }

  // 2) Secondaires (moyennes)
  for (let i=0; i<N_SECO; i++){
    const t = i/(N_SECO-1 || 1);
    const lenFinal = lerp(LMAX*0.36, LMAX*0.7, pow(t, 0.9));
    const len = lerp(lenFinal*0.6, lenFinal, ouverture);
    const ep  = lerp(26, 15, t);
    const ang = -angleBase + radians(8) - radians(t*(ecart*0.72));
    const col = paletteIridescent(t*0.85, 0.92);
    featherDetailed(len, ep, ang, col, true, true);
  }

  // 3) Couvertures (petites près du corps)
  for (let i=0; i<N_COVR; i++){
    const t = i/(N_COVR-1 || 1);
    const len = lerp(36, 94, t) * lerp(0.55, 1.0, ouverture);
    const ep  = lerp(22, 12, t);
    const ang = -angleBase - radians(t*(ecart*0.45));
    const c1  = color(220, 18, 100, 235); // blanc froid
    featherDetailed(len, ep, ang, c1, false, false);
  }

  pop();
}

/* ---------- Plume détaillée (forme + texture) ---------- */
function featherDetailed(len, ep, ang, col, withRachis=true, withBarbules=true){
  push();
  rotate(ang);

  // Ombre douce sous la plume
  noStroke();
  fill(0,0,0, 30);
  beginShape();
  for (let j=0; j<=1.0; j+=0.12){
    const w = ep * (1 - pow(j, 0.55));
    const up = -w - scallop(j, ep)*0.18;   // bord supérieur dentelé très léger
    vertex(len*j + 2, up + 2);
  }
  for (let j=1.0; j>=0; j-=0.12){
    const w = ep * (1 - pow(j, 0.55));
    const dn =  w + scallop(j, ep)*0.18;
    vertex(len*j + 2, dn + 2);
  }
  endShape(CLOSE);

  // Remplissage principal (corps de la plume)
  fill(col);
  beginShape();
  for (let j=0; j<=1.0; j+=0.08){
    const w = ep * (1 - pow(j, 0.55));
    const up = -w - scallop(j, ep)*0.12;
    vertex(len*j, up);
  }
  for (let j=1.0; j>=0; j-=0.08){
    const w = ep * (1 - pow(j, 0.55));
    const dn =  w + scallop(j, ep)*0.12;
    vertex(len*j, dn);
  }
  endShape(CLOSE);

  // Liseré léger sur le bord supérieur
  stroke(0, 0, 100, 90); strokeWeight(1);
  noFill();
  beginShape();
  for (let j=0; j<=1.0; j+=0.08){
    const w = ep * (1 - pow(j, 0.55));
    const up = -w - scallop(j, ep)*0.12;
    vertex(len*j, up);
  }
  endShape();

  if (withRachis){
    // Rachis (axe central) légèrement plus clair
    stroke(0, 0, 100, 70); strokeWeight(1.2);
    line(0, 0, len*0.96, 0);
  }

  if (withBarbules){
    // Petites barbules: fines lignes obliques alternées, de chaque côté
    stroke(0, 0, 100, 35); strokeWeight(0.8);
    const step = 0.09;
    for (let j=0.1; j<=0.95; j+=step){
      const w = ep * (1 - pow(j, 0.55));
      const L = constrain(w*0.9, 4, 18);
      // haut
      line(len*j, 0, len*j + L*0.92, -L*0.35);
      // bas
      line(len*j, 0, len*j + L*0.92,  L*0.35);
    }
  }

  pop();
}

/* --------------- Palette iridescente HSB --------------- */
// Ambre → magenta → azur. alphaMix ∈ (0..1) multiplie l’alpha
function paletteIridescent(t, alphaMix=1){
  const A = color(35,  90, 100, 240*alphaMix); // ambre
  const B = color(325, 80, 100, 240*alphaMix); // magenta
  const C = color(205, 60, 100, 240*alphaMix); // azur
  return (t < 0.5) ? lerpColor(A, B, t/0.5) : lerpColor(B, C, (t-0.5)/0.5);
}

/* --------------------------- Utils --------------------------- */
function scallop(j, ep){
  // Petite ondulation du bord (aspect plume) — fixe (pas d’animation)
  // j: 0..1 le long de la plume. épaisseur modère l’amplitude.
  return sin(j*PI*3.0) * (ep*0.08) * (1 - j); // s’atténue vers la pointe
}

function mapClamp(v, a, b, c, d){
  const t = constrain((v-a)/(b-a), 0, 1);
  return c + (d-c)*t;
}
</script>
</body>
</html>
