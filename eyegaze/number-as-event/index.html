<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title class="translate" data-fr="Nombre évènementiel" data-en="Number as Event" data-ja="イベントとしての数">Nombre évènementiel</title>
  <link rel="stylesheet" href="../../css/games.css">
  <link rel="stylesheet" href="../../css/choiceeyegaze.css">
  <style>
    :root {
      --bg-1: #0a1a1d;
      --bg-2: #0f2f38;
      --glow-1: #6ce8e0;
      --glow-2: #ffc36d;
      --glow-3: #9b7bff;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.08), transparent 35%),
                  radial-gradient(circle at 80% 30%, rgba(255,255,255,0.05), transparent 40%),
                  linear-gradient(145deg, var(--bg-1), var(--bg-2));
      color: #e8f7f5;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
    }

    #langToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10001;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 2px solid #009688;
      background: #ffffff;
      color: #009688;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
    }

    #game-options.modal {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #scene {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #event-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    #prompt-panel {
      position: relative;
      z-index: 1;
      text-align: center;
      max-width: 600px;
      padding: 16px 22px;
      border-radius: 18px;
      background: rgba(10, 26, 29, 0.55);
      border: 1px solid rgba(108, 232, 224, 0.35);
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    #prompt-panel h1 {
      margin: 0 0 6px;
      font-size: 1.8rem;
      letter-spacing: 0.02em;
    }

    #prompt-panel p {
      margin: 4px 0;
      opacity: 0.82;
      line-height: 1.5;
    }

    #last-number {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(108,232,224,0.4);
      font-weight: 800;
      font-size: 1.1rem;
      letter-spacing: 0.04em;
      color: #ffffff;
    }

    #last-number.flash {
      animation: pulseBadge 700ms ease;
    }

    @keyframes pulseBadge {
      0% { transform: scale(0.92); box-shadow: 0 0 0 0 rgba(108,232,224,0.35); }
      60% { transform: scale(1.04); box-shadow: 0 0 0 12px rgba(108,232,224,0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108,232,224,0); }
    }

    .event {
      position: absolute;
      border-radius: 999px;
      pointer-events: none;
      filter: blur(0px);
      will-change: transform, opacity;
    }

    .event.pulse {
      background: radial-gradient(circle, rgba(108,232,224,0.8), rgba(108,232,224,0));
      animation: pulse 1200ms ease-out forwards;
    }

    .event.sparkle {
      background: radial-gradient(circle, rgba(255,195,109,0.9), rgba(255,195,109,0));
      box-shadow: 0 0 12px rgba(255,195,109,0.7), 0 0 24px rgba(255,195,109,0.4);
      animation: sparkle 1000ms ease-out forwards;
    }

    .event.drop {
      background: linear-gradient(180deg, rgba(155,123,255,0.9), rgba(155,123,255,0));
      border-radius: 12px;
      animation: drop 900ms ease-in forwards;
    }

    @keyframes pulse {
      0% { transform: scale(0.4); opacity: 0.85; filter: blur(1px); }
      70% { transform: scale(1.15); opacity: 0.8; }
      100% { transform: scale(1.5); opacity: 0; filter: blur(3px); }
    }

    @keyframes sparkle {
      0% { transform: scale(0.6) rotate(0deg); opacity: 1; }
      60% { transform: scale(1.1) rotate(120deg); opacity: 0.85; }
      100% { transform: scale(0.2) rotate(200deg); opacity: 0; }
    }

    @keyframes drop {
      0% { transform: translateY(-30px) scaleY(0.6); opacity: 1; }
      70% { transform: translateY(40vh) scaleY(1.05); opacity: 0.9; }
      100% { transform: translateY(60vh) scaleY(1.2); opacity: 0; }
    }

    #startButton { margin-top: 8px; }

    #options-inline-container {
      align-items: flex-start;
    }

    #options-inline-container .option-item {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <div id="game-options" class="modal">
    <div id="control-panel-options">
      <div id="options-title-bar">
        <h2 id="options-main-title" class="translate" data-fr="Nombre évènementiel" data-en="Number as Event" data-ja="イベントとしての数">Nombre évènementiel</h2>
      </div>
      <div id="mode-divider"></div>
      <div id="options-inline-container">
        <div class="options-column">
          <div class="option-item">
            <label class="teal-label">
              <input type="checkbox" id="muteSFX">
              <span class="translate" data-fr="Couper la voix" data-en="Mute voice" data-ja="音声をミュート">Couper la voix</span>
            </label>
          </div>
          <div class="option-item">
            <label for="maxNumber" class="teal-label">
              <span class="translate" data-fr="Nombre maximum d'évènements: " data-en="Maximum events: " data-ja="イベントの最大数：">Nombre maximum d'évènements: </span>
              <span id="maxNumberLabel">5</span>
            </label>
            <input type="range" id="maxNumber" class="styled-slider" min="1" max="9" value="5">
          </div>
        </div>
        <div class="options-column">
          <div class="option-item">
            <label class="teal-label" for="cooldown">
              <span class="translate" data-fr="Pause entre déclenchements: " data-en="Pause between triggers: " data-ja="トリガー間の休止：">Pause entre déclenchements: </span>
              <span id="cooldownLabel">1.2</span> s
            </label>
            <input type="range" id="cooldown" class="styled-slider" min="400" max="3000" step="100" value="1200">
          </div>
          <div class="option-item">
            <label class="teal-label">
              <input type="checkbox" id="vibrateToggle" checked>
              <span class="translate" data-fr="Vibration (si disponible)" data-en="Vibration (if available)" data-ja="バイブレーション（可能な場合）">Vibration (si disponible)</span>
            </label>
          </div>
        </div>
      </div>
      <div id="mode-divider"></div>
      <button id="startButton" class="button translate" data-fr="Commencer • Plein écran" data-en="Start • Fullscreen" data-ja="開始・全画面">Commencer • Plein écran</button>
    </div>
  </div>

  <div id="scene">
    <div id="event-layer"></div>
    <div id="prompt-panel">
      <h1 class="translate" data-fr="Chaque regard déclenche un nombre" data-en="Every gaze becomes a number" data-ja="視線が数字のイベントになる">Chaque regard déclenche un nombre</h1>
      <p class="translate" data-fr="Fixez l'écran: une voix annonce un nombre et autant d'évènements lumineux surgissent." data-en="Look anywhere: a voice speaks a number and that many light events appear." data-ja="どこかを見つめると、声が数字を読み上げ、同じ数の光のイベントが現れます。">Fixez l'écran: une voix annonce un nombre et autant d'évènements lumineux surgissent.</p>
      <p class="translate" data-fr="Pas de chiffres, juste des expériences sensorielles pour sentir la quantité." data-en="No digits—just sensory bursts to feel quantity." data-ja="数字は表示されず、量感を味わう感覚的な体験のみです。">Pas de chiffres, juste des expériences sensorielles pour sentir la quantité.</p>
      <div id="last-number" class="translate" data-fr="En attente" data-en="Waiting" data-ja="待機中">En attente</div>
    </div>
  </div>

  <script src="../../js/translationmain.js"></script>
  <script>
    const numberWords = {
      en: ['one','two','three','four','five','six','seven','eight','nine'],
      fr: ['un','deux','trois','quatre','cinq','six','sept','huit','neuf'],
      ja: ['いち','に','さん','よん','ご','ろく','なな','はち','きゅう']
    };

    const scene = document.getElementById('scene');
    const eventLayer = document.getElementById('event-layer');
    const startButton = document.getElementById('startButton');
    const optionsModal = document.getElementById('game-options');
    const maxNumberSlider = document.getElementById('maxNumber');
    const maxNumberLabel = document.getElementById('maxNumberLabel');
    const cooldownSlider = document.getElementById('cooldown');
    const cooldownLabel = document.getElementById('cooldownLabel');
    const muteToggle = document.getElementById('muteSFX');
    const vibrateToggle = document.getElementById('vibrateToggle');
    const lastNumber = document.getElementById('last-number');
    const langBtn = document.getElementById('langToggle');

    let isPlaying = false;
    let lastTrigger = 0;

    function setMaxLabel() {
      maxNumberLabel.textContent = maxNumberSlider.value;
    }

    function setCooldownLabel() {
      cooldownLabel.textContent = (cooldownSlider.value / 1000).toFixed(1);
    }

    function requestFull() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) return elem.requestFullscreen();
      if (elem.webkitRequestFullscreen) return elem.webkitRequestFullscreen();
      return Promise.resolve();
    }

    function speakNumber(num) {
      if (muteToggle.checked) return;
      const lang = getStoredLanguage();
      const words = numberWords[lang] || numberWords.en;
      const utter = new SpeechSynthesisUtterance(words[num - 1] || String(num));
      utter.lang = lang === 'ja' ? 'ja-JP' : lang === 'fr' ? 'fr-FR' : 'en-US';
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }

    function vibrateCount(count) {
      if (!vibrateToggle.checked || !('vibrate' in navigator)) return;
      const pattern = Array.from({ length: count }, () => [70, 80]).flat();
      navigator.vibrate(pattern);
    }

    function spawnEvent(type) {
      const el = document.createElement('div');
      el.className = `event ${type}`;
      const size = Math.random() * 120 + 40;
      el.style.width = `${size}px`;
      el.style.height = `${type === 'drop' ? size * 1.6 : size}px`;
      el.style.left = `${Math.random() * 100}%`;
      el.style.top = `${Math.random() * 100}%`;
      el.style.transformOrigin = 'center';
      eventLayer.appendChild(el);
      el.addEventListener('animationend', () => el.remove());
    }

    function triggerBurst() {
      if (!isPlaying) return;
      const now = performance.now();
      if (now - lastTrigger < Number(cooldownSlider.value)) return;
      lastTrigger = now;

      const max = Number(maxNumberSlider.value) || 1;
      const count = Math.max(1, Math.floor(Math.random() * max) + 1);
      const lang = getStoredLanguage();
      const wordList = numberWords[lang] || numberWords.en;
      const spokenWord = wordList[count - 1] || String(count);

      lastNumber.textContent = spokenWord;
      lastNumber.classList.remove('flash');
      void lastNumber.offsetWidth;
      lastNumber.classList.add('flash');

      speakNumber(count);
      vibrateCount(count);

      const types = ['pulse','sparkle','drop'];
      for (let i = 0; i < count; i++) {
        const type = types[Math.floor(Math.random() * types.length)];
        setTimeout(() => spawnEvent(type), i * 80);
      }
    }

    function startExperience() {
      requestFull().catch(() => {});
      optionsModal.style.display = 'none';
      scene.style.display = 'flex';
      isPlaying = true;
      lastTrigger = 0;
    }

    function bindInteractions() {
      scene.addEventListener('pointermove', triggerBurst);
      scene.addEventListener('pointerdown', triggerBurst);
      scene.addEventListener('touchstart', triggerBurst, { passive: true });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setMaxLabel();
      setCooldownLabel();
      bindInteractions();

      startButton.addEventListener('click', startExperience);
      maxNumberSlider.addEventListener('input', setMaxLabel);
      cooldownSlider.addEventListener('input', setCooldownLabel);

      if (langBtn) langBtn.addEventListener('click', toggleLanguage);
    });
  </script>
</body>
</html>
