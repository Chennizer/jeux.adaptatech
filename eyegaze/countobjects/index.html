<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title class="translate" data-fr="Compte les objets" data-en="Count the objects">Compte les objets</title>

  <link rel="stylesheet" href="../../css/games.css">
  <link rel="stylesheet" href="../../css/choiceeyegaze.css">

  <style>
    body.light { background-color: #fff; color: #000; }
    body.dark  { background-color: #000; color: #fff; }

    #langToggle {
      position: fixed;
      top: 10px; right: 10px;
      z-index: 99999;
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 10px; border: 2px solid #009688;
      background: #fff; color: #009688; font-weight: 700; cursor: pointer;
      user-select: none;
    }
    body.dark #langToggle { background:#111; color:#14b8a6; border-color:#14b8a6; }

    .game-container {
      width: 100%;
      max-width: 100vw;
      height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 10px;
      box-sizing: border-box;
    }

    .top-strip {
      width: 100%;
      max-width: none;
      margin: 8px 0 0;
      padding: clamp(12px, 2vw, 18px);
      border-radius: 16px;
      display: none;
      box-sizing: border-box;
      border: 2px solid;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      transition: opacity 400ms ease;
    }
    .top-strip.hidden { display: none !important; }
    .top-strip.fade-out { opacity: 0; }
    body.light .top-strip { background:#00bfa5; border-color:rgba(0,150,136,0.55); }
    body.dark  .top-strip { background:#082422; border-color:rgba(20,184,166,0.55); box-shadow:0 8px 24px rgba(0,0,0,0.35); }

    .number-strip {
      width: 100%;
      display: grid;
      gap: clamp(10px, 2vw, 24px);
    }

    .number-tile {
      position: relative;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.92);
      color: #0f172a;
      font-size: clamp(1.8rem, 5vw, 3.4rem);
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      height: clamp(72px, 14vw, 120px);
      user-select: none;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      transition: transform 180ms ease, box-shadow 180ms ease, background-color 200ms ease;
    }
    body.dark .number-tile {
      background: rgba(34,34,34,0.92);
      color: #f8fafc;
      border-color: rgba(255,255,255,0.12);
      box-shadow: 0 6px 16px rgba(0,0,0,0.55);
    }
    .number-tile.correct {
      background: #c62828;
      color: #fff;
      border-color: rgba(0,0,0,0.18);
      transform: scale(1.05);
    }
    .number-tile.count-hint {
      background: #ffd54f;
      color: #0f172a;
      transform: scale(1.12);
      box-shadow: 0 14px 32px rgba(0,0,0,0.22);
      animation: countGlow 1200ms ease-in-out infinite alternate;
    }
    body.dark .number-tile.count-hint {
      background: #facc15;
      color: #0f172a;
      box-shadow: 0 18px 34px rgba(250,204,21,0.28);
    }
    @keyframes countGlow {
      from { transform: scale(1.08); }
      to   { transform: scale(1.18); }
    }

    .objects-area {
      flex: 1;
      width: 100%;
      max-width: 1100px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(16px, 4vw, 40px);
      box-sizing: border-box;
    }

    .objects-grid {
      --obj-size: min(18vmin, 180px);
      width: 100%;
      display: grid;
      gap: clamp(12px, 3vw, 40px);
      justify-content: center;
      justify-items: center;
      align-items: center;
    }
    .objects-grid img {
      width: var(--obj-size);
      height: var(--obj-size);
      object-fit: contain;
      background: transparent;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.18));
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
    }
    .objects-grid.count-1 { --obj-size: min(40vmin, 320px); grid-template-columns: repeat(1, minmax(var(--obj-size), 1fr)); }
    .objects-grid.count-2 { --obj-size: min(34vmin, 280px); grid-template-columns: repeat(2, minmax(var(--obj-size), 1fr)); }
    .objects-grid.count-3 { --obj-size: min(30vmin, 240px); grid-template-columns: repeat(3, minmax(var(--obj-size), 1fr)); }
    .objects-grid.count-4 { --obj-size: min(26vmin, 220px); grid-template-columns: repeat(4, minmax(var(--obj-size), 1fr)); }
    .objects-grid.count-5 { --obj-size: min(24vmin, 200px); grid-template-columns: repeat(5, minmax(var(--obj-size), 1fr)); }
    .objects-grid.count-6 { --obj-size: min(22vmin, 180px); grid-template-columns: repeat(3, minmax(var(--obj-size), 1fr)); }
    .objects-grid.count-7 { --obj-size: min(20vmin, 170px); grid-template-columns: repeat(4, minmax(var(--obj-size), 1fr)); }
    .objects-grid.count-8 { --obj-size: min(18vmin, 160px); grid-template-columns: repeat(4, minmax(var(--obj-size), 1fr)); }
    .objects-grid.count-9 { --obj-size: min(16vmin, 150px); grid-template-columns: repeat(3, minmax(var(--obj-size), 1fr)); }

    .object-wrapper {
      position: relative;
      width: var(--obj-size);
      height: var(--obj-size);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 20px;
      overflow: hidden;
      transition: transform 220ms ease, box-shadow 220ms ease;
    }
    .object-wrapper.countable {
      cursor: pointer;
    }
    .object-wrapper.counted {
      transform: scale(1.06);
      box-shadow: 0 14px 36px rgba(0,0,0,0.18);
    }
    body.dark .object-wrapper.counted {
      box-shadow: 0 18px 38px rgba(0,0,0,0.45);
    }
    .object-wrapper.counted::after {
      content: attr(data-order);
      position: absolute;
      top: 6px;
      right: 6px;
      min-width: 32px;
      min-height: 32px;
      padding: 4px 6px;
      border-radius: 999px;
      background: #c62828;
      color: #fff;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.24);
    }
    body.dark .object-wrapper.counted::after {
      background: #ef4444;
    }
    .object-wrapper.countable.counted::after {
      display: none;
    }

    .dwell-fill {
      position: absolute;
      background-color: rgba(255,0,0,0.5);
      top: 50%; left: 50%;
      width: 0; height: 0;
      transform: translate(-50%, -50%);
      pointer-events: none;
      border-radius: 12px;
    }

    .hide-native-cursor, .hide-native-cursor * { cursor: none !important; }

    #gazePointer {
      position: fixed;
      left: 0; top: 0;
      width: var(--gp-size, 36px);
      height: var(--gp-size, 36px);
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10000;
      opacity: 0;
      will-change: transform, opacity;
    }
    #gazePointer::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: #ff0000;
    }
    #gazePointer.gp-dwell::before {
      animation: gpPulse 700ms ease-in-out infinite alternate;
    }
    @keyframes gpPulse {
      from { transform: scale(1); }
      to   { transform: scale(1.06); }
    }
    @media (prefers-reduced-motion: reduce) {
      #gazePointer.gp-dwell::before { animation: none; }
    }

    .gp-compact { display:flex; flex-direction:column; gap:6px; }
    .gp-summary { cursor:pointer; font-weight:600; padding:6px 0; opacity:.85; }
    .gp-advanced { display:flex; flex-direction:column; gap:8px; padding:4px 0 2px; }
    .gp-row { display:grid; grid-template-columns: 1fr minmax(140px, 1.4fr); align-items:center; gap:10px; }
    .gp-label { white-space:nowrap; }
    .gp-range { width:100%; }
    details#gpDetails { border-left:3px solid rgba(0,150,136,.25); padding-left:10px; }
    details#gpDetails[open] .gp-summary { opacity:1; }

    @media (max-width: 640px) {
      .objects-grid.count-6,
      .objects-grid.count-7,
      .objects-grid.count-8,
      .objects-grid.count-9 {
        grid-template-columns: repeat(3, minmax(var(--obj-size), 1fr));
      }
    }
  </style>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>
<body>

<button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

<div id="game-options" class="modal">
  <div id="options-title-bar">
    <h2 id="options-main-title" class="translate" data-fr="Compte les objets" data-en="Count the objects">Compte les objets</h2>
  </div>

  <div id="control-panel-options">
    <div id="mode-divider"></div>

    <div id="options-inline-container">
      <div class="options-column">
        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="muteSFX">
            <span class="translate" data-fr="Désactiver les sons" data-en="Disable sounds">Désactiver les sons</span>
          </label>
        </div>

        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="ttsEnabled">
            <span class="translate" data-fr="Lecture vocale" data-en="Voice reading (TTS)">Lecture vocale</span>
          </label>
        </div>

        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="darkModeToggle">
            <span class="translate" data-fr="Mode sombre" data-en="Dark mode">Mode sombre</span>
          </label>
        </div>
        <div class="option-item">
          <label for="sfxVol" class="teal-label">
            <span class="translate" data-fr="Volume des sons:" data-en="Sound volume:">Volume des sons:</span>
            <span id="sfxVolVal">50</span>
          </label>
          <input type="range" id="sfxVol" class="styled-slider" min="0" max="100" value="50">
        </div>
      </div>

      <div class="options-column">
        <div class="option-item">
          <label for="categorySelect" class="teal-label label-block translate" data-fr="Catégorie" data-en="Category">Catégorie</label>
          <select id="categorySelect" class="styled-select"></select>
        </div>

        <div class="option-item">
          <label for="maxNumberSlider" class="teal-label">
            <span class="translate" data-fr="Nombre maximal:" data-en="Max number:">Nombre maximal:</span>
            <span id="maxNumberVal">5</span>
          </label>
          <input type="range" id="maxNumberSlider" class="styled-slider" min="1" max="9" step="1" value="5">
        </div>

        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="countingMode">
            <span class="translate" data-fr="Mode comptage" data-en="Counting mode">Mode comptage</span>
          </label>
        </div>
      </div>

        <div class="options-column">
          <div class="option-item">
            <label for="dwellTimeSlider" class="teal-label">
              <span class="translate" data-fr="Temps de fixation:" data-en="Dwell time:">Temps de fixation:</span>
              <span id="dwellTimeVal">1500</span> ms
            </label>
            <input type="range" id="dwellTimeSlider" class="styled-slider" min="500" max="5000" step="100" value="1500">
          </div>

          <div class="option-item gp-compact">
            <label class="teal-label">
              <input type="checkbox" id="showGazePointer" checked>
              <span class="translate" data-fr="Afficher le pointeur (cache la souris)" data-en="Show gaze pointer (hide mouse)">Afficher le pointeur (cache la souris)</span>
            </label>

            <details id="gpDetails">
              <summary class="gp-summary">
                <span class="translate" data-fr="Options avancées du pointeur" data-en="Pointer advanced options">Options avancées du pointeur</span>
              </summary>

              <div class="gp-advanced">
                <div class="gp-row">
                  <label for="gazeSize" class="teal-label gp-label">
                    <span class="translate" data-fr="Taille" data-en="Size">Taille</span>:
                    <span id="gazeSizeVal">36</span> px
                  </label>
                  <input type="range" id="gazeSize" class="styled-slider gp-range" min="16" max="100" step="2" value="36">
                </div>

                <div class="gp-row">
                  <label for="gazeOpacity" class="teal-label gp-label">
                    <span class="translate" data-fr="Opacité" data-en="Opacity">Opacité</span>:
                    <span id="gazeOpacityVal">100</span>%
                  </label>
                  <input type="range" id="gazeOpacity" class="styled-slider gp-range" min="20" max="100" step="5" value="100">
                </div>
              </div>
            </details>
          </div>
        </div>
    </div>

    <div id="mode-divider"></div>
    <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start">Commencer</button>
  </div>
</div>

<div class="game-container">
  <div id="topStrip" class="top-strip">
    <div id="numberStrip" class="number-strip"></div>
  </div>

  <div class="objects-area">
    <div id="objectsGrid" class="objects-grid"></div>
  </div>
</div>

<div id="gazePointer" aria-hidden="true"></div>

<audio id="correctSound" src="../../sounds/victory.mp3"></audio>
<audio id="wrongSound" src="../../sounds/error.mp3"></audio>

<script src="../../js/eyegaze-menu.js"></script>
<script src="../../js/translationmain.js"></script>

<script>
let pictosData = null;
let currentCategoryKey = null;
let currentItem = null;
let currentCount = 1;
let isReady = false;
let activeHoverElement = null;
let hoverTimeout = null;
let currentOverlay = null;
let hoverCompleteHandler = null;

let countingProgress = 0;
let countingComplete = false;
let countingHintTile = null;
let countingSummaryTimeout = null;

const COUNTING_DWELL_MS = 300;

const LS_LANG_KEY = 'siteLanguage';
const LS_KEYS = { ttsEnabled: 'countobjects:ttsEnabled' };

const NUMBER_WORDS_FR = [null, 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
const NUMBER_WORDS_EN = [null, 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
const EN_INVARIANT_PLURALS = new Set(['fish', 'sheep', 'deer', 'moose', 'series', 'species']);
const FR_INVARIANT_PLURALS = new Set(['nez']);

const langToggle = document.getElementById('langToggle');
const startButton = document.getElementById('startButton');
const gameContainer = document.querySelector('.game-container');
const optionsModal = document.getElementById('game-options');
const topStrip = document.getElementById('topStrip');
const numberStrip = document.getElementById('numberStrip');
const objectsGrid = document.getElementById('objectsGrid');
const categorySelect = document.getElementById('categorySelect');
const maxNumberSlider = document.getElementById('maxNumberSlider');
const maxNumberVal = document.getElementById('maxNumberVal');
const countingMode = document.getElementById('countingMode');
const darkModeToggle = document.getElementById('darkModeToggle');
const dwellSlider = document.getElementById('dwellTimeSlider');
const dwellTimeVal = document.getElementById('dwellTimeVal');
const ttsEnabled = document.getElementById('ttsEnabled');
const muteSFX = document.getElementById('muteSFX');
const sfxVol = document.getElementById('sfxVol');
const sfxVolVal = document.getElementById('sfxVolVal');
const showGazePointer = document.getElementById('showGazePointer');
const gazePointer = document.getElementById('gazePointer');
const gazeSize = document.getElementById('gazeSize');
const gazeOpacity = document.getElementById('gazeOpacity');
const gazeSizeVal = document.getElementById('gazeSizeVal');
const gazeOpacityVal = document.getElementById('gazeOpacityVal');
const gpDetails = document.getElementById('gpDetails');
const correctAudio = document.getElementById('correctSound');
const wrongAudio = document.getElementById('wrongSound');

initEyegazeMenu();

applyTheme(darkModeToggle?.checked ? 'dark' : 'light');

maxNumberVal.textContent = maxNumberSlider.value;
dwellTimeVal.textContent = dwellSlider.value;
sfxVolVal.textContent = sfxVol.value;

function getLang(){
  try {
    const saved = localStorage.getItem(LS_LANG_KEY);
    if (saved === 'en' || saved === 'fr') return saved;
  } catch(e){}
  return (document.documentElement.lang === 'en') ? 'en' : 'fr';
}

function setLang(lang){
  const safe = (lang === 'en') ? 'en' : 'fr';
  document.documentElement.lang = safe;
  try { localStorage.setItem(LS_LANG_KEY, safe); } catch(e){}
  document.querySelectorAll('.translate').forEach(el => {
    const fr = el.getAttribute('data-fr');
    const en = el.getAttribute('data-en');
    if (safe === 'fr' && fr != null) el.textContent = fr;
    if (safe === 'en' && en != null) el.textContent = en;
  });
  if (pictosData) populateCategoriesSelect(categorySelect.value);
}

(function normalizeLangOnLoad(){
  let initial = 'fr';
  try {
    const saved = localStorage.getItem(LS_LANG_KEY);
    if (saved === 'en' || saved === 'fr') {
      initial = saved;
    } else {
      initial = (document.documentElement.lang === 'en') ? 'en' : 'fr';
      localStorage.setItem(LS_LANG_KEY, initial);
    }
  } catch(e) {
    initial = (document.documentElement.lang === 'en') ? 'en' : 'fr';
  }
  setLang(initial);
})();

langToggle.addEventListener('click', () => {
  setLang(getLang() === 'fr' ? 'en' : 'fr');
  choosePreferredVoice();
});

function populateCategoriesSelect(preserveKey){
  if (!pictosData || !pictosData.categories) return;
  const lang = getLang();
  const keys = Object.keys(pictosData.categories);
  categorySelect.innerHTML = '';
  keys.forEach(key => {
    const opt = document.createElement('option');
    opt.value = key;
    const label = pictosData.categories[key].label || {};
    const text = (lang === 'en') ? (label.en?.word || label.en || key) : (label.fr?.word || label.fr || key);
    opt.textContent = text;
    if (preserveKey && preserveKey === key) opt.selected = true;
    categorySelect.appendChild(opt);
  });
  if (!preserveKey || !pictosData.categories[preserveKey]) {
    categorySelect.selectedIndex = 0;
  }
  currentCategoryKey = categorySelect.value || null;
}

fetch('../../images/pictos/newindex.json')
  .then(resp => resp.json())
  .then(data => {
    pictosData = data;
    populateCategoriesSelect();
  })
  .catch(() => {
    alert(getLang()==='fr' ? 'Impossible de charger les pictogrammes.' : 'Unable to load pictograms.');
  });

categorySelect.addEventListener('change', () => {
  currentCategoryKey = categorySelect.value;
  if (isGameActive()) nextRound();
});

if (darkModeToggle) {
  darkModeToggle.addEventListener('change', () => {
    applyTheme(darkModeToggle.checked ? 'dark' : 'light');
  });
}

maxNumberSlider.addEventListener('input', () => {
  maxNumberVal.textContent = maxNumberSlider.value;
  if (isGameActive()) nextRound();
});

if (countingMode) {
  countingMode.addEventListener('change', () => {
    resetCountingState();
    stopHover();
    if (isGameActive()) {
      buildNumberStrip();
      renderObjects(currentItem, currentCount);
    }
  });
}

if (dwellSlider) {
  dwellSlider.addEventListener('input', () => {
    dwellTimeVal.textContent = dwellSlider.value;
    syncEyegazeSettingsFromUI();
  });
}

if (sfxVol) {
  sfxVol.addEventListener('input', () => {
    sfxVolVal.textContent = sfxVol.value;
    syncEyegazeSettingsFromUI();
  });
}

if (muteSFX) {
  muteSFX.addEventListener('change', syncEyegazeSettingsFromUI);
}

if (ttsEnabled) {
  try {
    const stored = localStorage.getItem(LS_KEYS.ttsEnabled);
    if (stored !== null) ttsEnabled.checked = (stored === 'true');
  } catch(e){}
  ttsEnabled.addEventListener('change', () => {
    try { localStorage.setItem(LS_KEYS.ttsEnabled, String(ttsEnabled.checked)); } catch(e){}
    syncEyegazeSettingsFromUI();
  });
}

function applyTheme(theme) {
  const chosenTheme = (theme === 'dark') ? 'dark' : 'light';
  document.body.classList.remove('light','dark');
  document.body.classList.add(chosenTheme);
  if (darkModeToggle) {
    darkModeToggle.checked = (chosenTheme === 'dark');
  }
}

function isGameActive() {
  return gameContainer && gameContainer.style.display === 'flex';
}

function pointerSizeFromControls() {
  return parseInt(gazeSize?.value, 10) || 36;
}

function pointerOpacityFromControls() {
  const raw = parseInt(gazeOpacity?.value, 10);
  return Math.max(0, Math.min(1, (isNaN(raw) ? 100 : raw) / 100));
}

function setPointerPos(x, y) {
  if (!gazePointer) return;
  gazePointer.style.left = `${x}px`;
  gazePointer.style.top = `${y}px`;
}

function setPointerDwell(active) {
  if (!gazePointer) return;
  gazePointer.classList.toggle('gp-dwell', !!active);
}

let lastPointer = { x: null, y: null };

function applyPointerToggle() {
  if (!gazePointer) return;
  const size = pointerSizeFromControls();
  const opct = pointerOpacityFromControls();
  if (gazeSizeVal) gazeSizeVal.textContent = size;
  if (gazeOpacityVal) gazeOpacityVal.textContent = Math.round(opct * 100);
  gazePointer.style.setProperty('--gp-size', `${size}px`);
  const enable = !!showGazePointer?.checked && isGameActive();
  document.documentElement.classList.toggle('hide-native-cursor', enable);
  gazePointer.style.opacity = enable ? opct : 0;
  if (!enable) {
    setPointerDwell(false);
    if (gpDetails) gpDetails.open = false;
  } else if (lastPointer.x !== null && lastPointer.y !== null) {
    setPointerPos(lastPointer.x, lastPointer.y);
  }
}

(function initPointerControls(){
  if (!gazePointer) return;

  try {
    const settings = window.eyegazeSettings;
    if (settings) {
      if (typeof settings.showGazePointer === 'boolean') showGazePointer.checked = settings.showGazePointer;
      if (typeof settings.gazePointerSize === 'number') {
        const min = parseInt(gazeSize.min || '16', 10);
        const max = parseInt(gazeSize.max || '100', 10);
        const stored = Math.round(settings.gazePointerSize);
        gazeSize.value = Math.max(min, Math.min(max, stored));
      }
      if (typeof settings.gazePointerAlpha === 'number') {
        const min = parseInt(gazeOpacity.min || '20', 10);
        const max = parseInt(gazeOpacity.max || '100', 10);
        const stored = Math.round(Math.max(0, Math.min(1, settings.gazePointerAlpha)) * 100);
        gazeOpacity.value = Math.max(min, Math.min(max, stored));
      }
    }
  } catch(e) {}

  applyPointerToggle();
  syncEyegazeSettingsFromUI();

  showGazePointer?.addEventListener('change', () => {
    applyPointerToggle();
    syncEyegazeSettingsFromUI();
  });

  [gazeSize, gazeOpacity].forEach(ctrl => {
    ctrl?.addEventListener('input', () => {
      applyPointerToggle();
      syncEyegazeSettingsFromUI();
    });
  });
})();

if (gazePointer) {
  const rawHandler = (event) => {
    lastPointer.x = event.clientX;
    lastPointer.y = event.clientY;
    setPointerPos(event.clientX, event.clientY);
  };

  if ('onpointerrawupdate' in window) {
    window.addEventListener('pointerrawupdate', rawHandler, { passive: true });
  }
  window.addEventListener('pointermove', rawHandler, { passive: true });

  window.addEventListener('pointerleave', () => {
    gazePointer._savedOpacity = gazePointer.style.opacity;
    gazePointer.style.opacity = 0;
  });

  window.addEventListener('pointerenter', () => {
    applyPointerToggle();
    if (lastPointer.x !== null && lastPointer.y !== null) {
      setPointerPos(lastPointer.x, lastPointer.y);
    }
  });
}

function syncEyegazeSettingsFromUI() {
  try {
    if (window.eyegazeSettings) {
      eyegazeSettings.sfxMuted  = !!muteSFX.checked;
      eyegazeSettings.sfxVolume = parseInt(sfxVol.value, 10) || 50;
      eyegazeSettings.dwellTime = parseInt(dwellSlider.value, 10) || 1500;
      eyegazeSettings.ttsEnabled = !!ttsEnabled.checked;
      eyegazeSettings.showGazePointer = !!showGazePointer?.checked;
      eyegazeSettings.gazePointerSize = pointerSizeFromControls();
      eyegazeSettings.gazePointerAlpha = pointerOpacityFromControls();
    }
  } catch(e) {}
}

function joinFr(article, word){
  const a = (article || '').trim();
  const w = (word || '').trim();
  if (!a) return w;
  if (!w) return a;
  const endsWithApo = /[’'ʼ]$/.test(a);
  return endsWithApo ? (a + w) : (a + ' ' + w);
}
function joinEn(article, word){
  const a = (article || '').trim();
  const w = (word || '').trim();
  return [a, w].filter(Boolean).join(' ');
}
function labelFor(item, lang){
  const lab = (lang === 'en') ? item.label?.en : item.label?.fr;
  if (!lab) return '';
  return (lang === 'en') ? joinEn(lab.article, lab.word) : joinFr(lab.article, lab.word);
}

let preferredVoice = null;
function choosePreferredVoice() {
  const ss = window.speechSynthesis;
  if (!ss || !ss.getVoices) return;
  const voices = ss.getVoices() || [];
  if (!voices.length) return;
  const lang = getLang();
  const by = fn => voices.find(fn);
  if (lang === 'fr') {
    preferredVoice =
      by(v => /sylvie/i.test(v.name || '') && /^fr[-_]?CA/i.test(v.lang || '')) ||
      by(v => /^fr[-_]?CA/i.test(v.lang || '')) ||
      by(v => /^fr[-_]?FR/i.test(v.lang || '')) ||
      by(v => (v.lang || '').toLowerCase().startsWith('fr')) ||
      voices[0];
  } else {
    preferredVoice =
      by(v => /^en[-_]?CA/i.test(v.lang || '')) ||
      by(v => /^en[-_]?US/i.test(v.lang || '')) ||
      by(v => /^en[-_]?GB/i.test(v.lang || '')) ||
      by(v => (v.lang || '').toLowerCase().startsWith('en')) ||
      voices[0];
  }
}
if ('speechSynthesis' in window) {
  speechSynthesis.addEventListener('voiceschanged', choosePreferredVoice);
  choosePreferredVoice();
}

function isTtsEnabled() {
  if (!('speechSynthesis' in window)) return false;
  return !!(ttsEnabled?.checked) || !!(window.eyegazeSettings?.ttsEnabled);
}

function makeUtterance(text) {
  const muted = !!(window.eyegazeSettings?.sfxMuted) || !!muteSFX.checked;
  const sfxSetting = window.eyegazeSettings?.sfxVolume;
  const uiVol = parseInt(sfxVol.value, 10);
  const volPercent = (typeof sfxSetting === 'number') ? sfxSetting : (isNaN(uiVol) ? 50 : uiVol);
  const volume = muted ? 0 : Math.max(0, Math.min(1, volPercent / 100));

  const u = new SpeechSynthesisUtterance(text);
  if (preferredVoice) {
    u.voice = preferredVoice;
    u.lang = preferredVoice.lang || (getLang()==='fr' ? 'fr-CA' : 'en-US');
  } else {
    u.lang = (getLang()==='fr' ? 'fr-CA' : 'en-US');
  }
  u.rate = 1.0;
  u.volume = volume;
  return u;
}

function speakText(text, onEnd) {
  if (!isTtsEnabled()) {
    if (typeof onEnd === 'function') onEnd();
    return;
  }

  try { speechSynthesis.cancel(); } catch(e) {}

  const utter = makeUtterance(text);
  if (typeof onEnd === 'function') {
    const finalize = () => {
      utter.removeEventListener('end', finalize);
      utter.removeEventListener('error', finalize);
      onEnd();
    };
    utter.addEventListener('end', finalize);
    utter.addEventListener('error', finalize);
  }
  speechSynthesis.speak(utter);
}

function speakPrompt(item) {
  if (!item) return;
  const lang = getLang();
  const noun = labelFor(item, lang);
  const text = (lang === 'fr')
    ? (noun ? `Compte ${noun}` : 'Compte les images')
    : (noun ? `Count ${noun}` : 'Count the pictures');
  speakText(text);
}

function stopHover() {
  clearTimeout(hoverTimeout);
  hoverTimeout = null;
  if (currentOverlay && currentOverlay.parentElement) currentOverlay.parentElement.removeChild(currentOverlay);
  currentOverlay = null;
  activeHoverElement = null;
  hoverCompleteHandler = null;
  setPointerDwell(false);
}

function startHover(target, onComplete, options = {}) {
  if (!isReady) return;
  if (activeHoverElement === target && currentOverlay) return;

  const dwellSetting = (window.eyegazeSettings?.dwellTime) || parseInt(dwellSlider.value, 10) || 1500;
  const dwell = Math.max(100, Math.min(5000, typeof options.dwellOverride === 'number' ? options.dwellOverride : dwellSetting));

  stopHover();
  activeHoverElement = target;
  hoverCompleteHandler = (typeof onComplete === 'function') ? onComplete : null;

  if (!options.skipOverlay) {
    currentOverlay = document.createElement('div');
    currentOverlay.className = 'dwell-fill';
    target.appendChild(currentOverlay);

    requestAnimationFrame(() => {
      currentOverlay.style.transition = `width ${dwell}ms linear, height ${dwell}ms linear`;
      currentOverlay.style.width = '0';
      currentOverlay.style.height = '0';
      requestAnimationFrame(() => {
        currentOverlay.style.width = '100%';
        currentOverlay.style.height = '100%';
      });
    });
  } else {
    currentOverlay = null;
  }

  setPointerDwell(true);

  hoverTimeout = setTimeout(() => {
    const handler = hoverCompleteHandler || handleSelection;
    handler(target);
    if (handler !== handleSelection) {
      stopHover();
    }
  }, dwell);
}

function pluralizeEnglishWord(word, count) {
  if (count <= 1) return word;
  const lower = (word || '').toLowerCase();
  if (EN_INVARIANT_PLURALS.has(lower)) return word;
  if (/(s|x|z|ch|sh)$/.test(lower)) return word + 'es';
  if (lower.endsWith('fe')) return word.slice(0, -2) + 'ves';
  if (lower.endsWith('f')) return word.slice(0, -1) + 'ves';
  if (/[bcdfghjklmnpqrstvwxyz]y$/.test(lower)) return word.slice(0, -1) + 'ies';
  return word + 's';
}

function pluralizeFrenchWord(word, count) {
  if (count <= 1) return word;
  const lower = (word || '').toLowerCase();
  if (FR_INVARIANT_PLURALS.has(lower)) return word;
  if (lower.endsWith('al')) return word.slice(0, -2) + 'aux';
  if (/(eau|au|eu)$/.test(lower)) return word + 'x';
  if (/[sxz]$/.test(lower)) return word;
  return word + 's';
}

function pluralizeLabelWord(item, lang, count) {
  if (!item) return '';
  const base = item.label?.[lang]?.word;
  if (!base) return '';
  if (count <= 1) return base;

  const parts = base.split(/\s+/).filter(Boolean);
  if (!parts.length) return base;

  const pluralize = (lang === 'fr') ? pluralizeFrenchWord : pluralizeEnglishWord;
  const lastIndex = parts.length - 1;
  parts[lastIndex] = pluralize(parts[lastIndex], count);

  if (lang === 'fr' && parts.length > 1) {
    for (let i = 0; i < lastIndex; i++) {
      parts[i] = pluralize(parts[i], count);
    }
  }

  return parts.join(' ');
}

function countingSummaryText() {
  const lang = getLang();
  const numberWord = (lang === 'fr') ? (NUMBER_WORDS_FR[currentCount] || String(currentCount)) : (NUMBER_WORDS_EN[currentCount] || String(currentCount));
  const labelWord = currentItem ? pluralizeLabelWord(currentItem, lang, currentCount) : '';

  if (lang === 'fr') {
    return labelWord ? `Il y a ${numberWord} ${labelWord}.` : `Il y en a ${numberWord}.`;
  }
  return labelWord ? `There are ${numberWord} ${labelWord}.` : `There are ${numberWord}.`;
}

function speakCountingNumber(value, onEnd) {
  speakText(String(value), onEnd);
}

function speakCountingSummary() {
  highlightCorrectNumber();
  const summary = countingSummaryText();
  if (summary) {
    speakText(summary);
  }
}

function clearCountHint() {
  if (countingHintTile) {
    countingHintTile.classList.remove('count-hint');
    countingHintTile = null;
  }
  if (numberStrip) {
    numberStrip.querySelectorAll('.number-tile.count-hint').forEach(tile => tile.classList.remove('count-hint'));
  }
}

function highlightCorrectNumber() {
  clearCountHint();
  if (!numberStrip) return;
  const tile = numberStrip.querySelector(`.number-tile[data-value="${currentCount}"]`);
  if (tile) {
    tile.classList.add('count-hint');
    countingHintTile = tile;
  }
}

function resetCountingState() {
  countingProgress = 0;
  countingComplete = false;
  if (countingSummaryTimeout) {
    clearTimeout(countingSummaryTimeout);
    countingSummaryTimeout = null;
  }
  clearCountHint();
  if (objectsGrid) {
    objectsGrid.querySelectorAll('.object-wrapper').forEach(wrapper => {
      wrapper.classList.remove('counted');
      wrapper.removeAttribute('data-counted');
      wrapper.removeAttribute('data-order');
    });
  }
}

function handleCountingStep(element) {
  if (!countingMode?.checked || !element) return;
  if (countingComplete) {
    highlightCorrectNumber();
    const summary = countingSummaryText();
    if (summary) speakText(summary);
    return;
  }

  const already = element.getAttribute('data-counted') === 'true';
  if (already) {
    const order = parseInt(element.getAttribute('data-order'), 10);
    if (!isNaN(order) && order > 0) speakCountingNumber(order);
    return;
  }

  countingProgress += 1;
  element.setAttribute('data-counted', 'true');
  element.setAttribute('data-order', String(countingProgress));
  element.classList.add('counted');

  speakCountingNumber(countingProgress, () => {
    if (countingProgress === currentCount && !countingComplete) {
      countingComplete = true;
      if (countingSummaryTimeout) {
        clearTimeout(countingSummaryTimeout);
      }
      countingSummaryTimeout = setTimeout(() => {
        countingSummaryTimeout = null;
        speakCountingSummary();
      }, 2000);
    }
  });
}

function handleSelection(tile) {
  if (!isReady) return;
  stopHover();
  const chosen = parseInt(tile.getAttribute('data-value'), 10);
  if (chosen !== currentCount) {
    playSound(wrongAudio);
    wrongFeedback(tile);
    return;
  }

  isReady = false;
  playSound(correctAudio);
  clearCountHint();
  tile.classList.add('correct');
  setPointerDwell(false);

  setTimeout(() => {
    tile.classList.remove('correct');
    nextRound();
  }, 1200);
}

function wrongFeedback(el) {
  const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (reduce) {
    el.style.boxShadow = 'inset 0 0 0 3px rgba(198,40,40,.45)';
    setTimeout(() => { el.style.boxShadow = ''; }, 300);
    return;
  }
  const seq = [0,-10,10,-6,6,-3,3,0];
  let i = 0;
  const start = el.style.transform;
  const tick = () => {
    el.style.transform = `translateX(${seq[i]}px)`;
    if (++i < seq.length) setTimeout(tick, 45);
    else el.style.transform = start;
  };
  tick();
}

function buildNumberStrip() {
  const count = Math.max(1, Math.min(9, parseInt(maxNumberSlider.value, 10) || 1));
  numberStrip.innerHTML = '';
  numberStrip.style.gridTemplateColumns = `repeat(${count}, minmax(0, 1fr))`;

  for (let i = 1; i <= count; i++) {
    const tile = document.createElement('div');
    tile.className = 'number-tile';
    tile.textContent = i;
    tile.setAttribute('data-value', String(i));

    tile.addEventListener('pointerenter', () => startHover(tile, handleSelection));
    tile.addEventListener('pointerleave', () => {
      if (activeHoverElement === tile) stopHover();
    });
    tile.addEventListener('pointerdown', () => handleSelection(tile));
    tile.addEventListener('click', () => handleSelection(tile));

    numberStrip.appendChild(tile);
  }

  topStrip.style.display = 'block';
}

function renderObjects(item, count) {
  if (!item) return;
  const base = pictosData?.base || '';
  objectsGrid.innerHTML = '';
  objectsGrid.className = 'objects-grid';
  objectsGrid.classList.add(`count-${Math.max(1, Math.min(9, count))}`);

  const countingActive = !!countingMode?.checked;

  for (let i = 0; i < count; i++) {
    const wrapper = document.createElement('div');
    wrapper.className = 'object-wrapper';
    if (countingActive) wrapper.classList.add('countable');

    const img = document.createElement('img');
    img.src = base + item.file;
    img.alt = labelFor(item, getLang());
    wrapper.appendChild(img);

    if (countingActive) {
      wrapper.addEventListener('pointerenter', () => startHover(wrapper, handleCountingStep, { dwellOverride: COUNTING_DWELL_MS, skipOverlay: true }));
      wrapper.addEventListener('pointerleave', () => {
        if (activeHoverElement === wrapper) stopHover();
      });
    }

    objectsGrid.appendChild(wrapper);
  }
}

function playSound(audioEl) {
  const muted = !!(window.eyegazeSettings?.sfxMuted) || !!muteSFX.checked;
  const sfxSetting = window.eyegazeSettings?.sfxVolume;
  const uiVol = parseInt(sfxVol.value, 10);
  const volPercent = (typeof sfxSetting === 'number') ? sfxSetting : (isNaN(uiVol) ? 50 : uiVol);

  audioEl.volume = muted ? 0 : Math.max(0, Math.min(1, volPercent / 100));
  try { audioEl.currentTime = 0; audioEl.play(); } catch(e) {}
}

function pickRandom(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

function nextRound() {
  stopHover();
  resetCountingState();
  if (!pictosData || !categorySelect.value) return;
  const category = pictosData.categories[categorySelect.value];
  if (!category || !category.items || !category.items.length) return;

  currentCategoryKey = categorySelect.value;
  currentItem = pickRandom(category.items);
  const maxCount = Math.max(1, Math.min(9, parseInt(maxNumberSlider.value, 10) || 1));
  currentCount = Math.floor(Math.random() * maxCount) + 1;

  buildNumberStrip();
  renderObjects(currentItem, currentCount);

  isReady = true;
  speakPrompt(currentItem);
  applyPointerToggle();
}

function startGame() {
  if (!pictosData) {
    alert(getLang()==='fr' ? 'Les pictogrammes ne sont pas encore chargés.' : 'Pictograms are not loaded yet.');
    return;
  }

  try {
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    }
  } catch(e) {}

  langToggle.style.display = 'none';
  applyTheme(darkModeToggle?.checked ? 'dark' : 'light');
  syncEyegazeSettingsFromUI();

  gameContainer.style.display = 'flex';
  nextRound();

  try { if (window.eyegazeSettings?.hideOverlay) eyegazeSettings.hideOverlay(); } catch(e) {}
  choosePreferredVoice();
  applyPointerToggle();
}

startButton.addEventListener('click', startGame);

window.addEventListener('beforeunload', () => {
  try { speechSynthesis.cancel(); } catch(e) {}
});
</script>
</body>
</html>
