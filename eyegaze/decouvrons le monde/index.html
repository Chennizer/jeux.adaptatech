<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Explorons le monde</title>

  <!-- Keep only common CSS for the MENU -->
  <link rel="stylesheet" href="../../css/eyegaze-menu.css">
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <!-- Everything game-related is styled here -->
  <style>
    /* ===== GAME SCOPE (resists global CSS) ===== */
    #game-root { position: relative; z-index: 1; }
    #game-stage {
      position: relative;
      width: 100vw;           /* concrete width so image has a basis */
      max-width: 100%;
      margin: 0 auto;
      overflow: hidden;
      background: #111;
      z-index: 5;             /* sits under the modal (z:1000) but above page bg */
    }
    #worldMap {
      display: block;
      width: 100vw;           /* fill viewport width */
      max-width: 100%;
      height: auto;
      object-fit: contain;
      user-select: none;
      -webkit-user-drag: none;
    }
    #hover-circle{
      position:absolute; pointer-events:none; display:none;
      border:3px solid rgba(0,200,255,.95); border-radius:50%;
      width:20px; height:20px; transform:translate(-50%,-50%);
      box-shadow:0 0 12px rgba(0,200,255,.7), inset 0 0 8px rgba(0,200,255,.5);
      z-index:6;
    }

    /* Overlays used during play */
    #video-overlay{ position:fixed; inset:0; background:#000; display:none; place-items:center; z-index:101; }
    #video-overlay video{ max-width:92vw; max-height:92vh; background:#000; outline:none; }

    /* Minimal progress bar for preloading (non-blocking) */
    #preload-bar-wrap{ display:none; height:8px; background:#eee; border-radius:999px; overflow:hidden; width:100%; max-width:480px; margin:8px auto 0; }
    #preload-bar{ height:100%; width:0%; background:#0a7; transition:width .25s ease; }

    /* Dev status strip (remove later if desired) */
    #statusStrip{
      position:fixed; left:10px; bottom:10px; z-index:2000; background:#222; color:#ddd;
      padding:8px 12px; border-radius:10px; font-size:13px; box-shadow:0 6px 22px rgba(0,0,0,.5);
      display:flex; gap:8px; align-items:center;
    }
    #statusDot{ width:10px; height:10px; border-radius:50%; background:#666; }
    #statusStrip.good #statusDot{ background:#19c37d; }
    #statusStrip.bad  #statusDot{ background:#f15151; }
    #statusMsg code{ color:#9bd; }

    /* Ensure the menu modal looks correct (leave details to your common CSS) */
    #game-options.modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1000; }
    #control-panel-options{ max-width:740px; width:90%; }
  </style>
</head>
<body>

  <!-- ===== MENU (uses common CSS) ===== -->
  <div id="game-options" class="modal" style="display:flex;">
    <div id="control-panel-options">
      <div id="options-title-bar">
        <h2 id="options-main-title">Explorons le monde</h2>
      </div>

      <div id="preload-bar-wrap" aria-hidden="true">
        <div id="preload-bar"></div>
      </div>

      <div id="mode-divider" style="width:100%;height:2px;background:#009688;margin:20px 0;"></div>

      <div id="options-inline-container" style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;width:100%;margin-top:20px;">
        <div class="options-column">
          <div class="option-item">
            <label class="teal-label" style="display:inline-flex;align-items:center;gap:.5em;color:#333;">
              <input type="checkbox" id="muteSFX">
              <span>Désactiver les sons</span>
            </label>
          </div>
          <div class="option-item">
            <label for="sfxVol" class="teal-label" style="display:flex;justify-content:space-between;width:60%;color:#333;">
              <span>Volume des sons :</span>
              <span id="sfxVolVal">50</span>
            </label>
            <input type="range" id="sfxVol" class="styled-slider" min="0" max="100" value="50" />
          </div>
        </div>

        <div class="options-column"></div>

        <div class="options-column">
          <div class="option-item">
            <label for="dwellTimeSlider" class="teal-label" style="display:flex;justify-content:space-between;width:60%;color:#333;">
              <span>Temps de fixation :</span>
              <span><span id="dwellTimeVal">1500</span> ms</span>
            </label>
            <input type="range" id="dwellTimeSlider" class="styled-slider" min="500" max="5000" step="100" value="1500" />
          </div>
        </div>
      </div>

      <div id="mode-divider" style="width:100%;height:2px;background:#009688;margin:20px 0;"></div>

      <button id="startButton" class="button">Commencer</button>
    </div>
  </div>

  <!-- ===== GAME ROOT ===== -->
  <div id="game-root">
    <div id="game-stage">
      <img id="worldMap" src="../../images/worldmap.jpg" alt="World Map" />
      <div id="hover-circle"></div>
      <!-- We still include <map>/<area> to keep your data, but we will parse it ourselves -->
      <map name="image-map">
        <area alt="north-america" title="Amérique du Nord" href="#" coords="442,530,369,480,260,419,191,256,42,214,167,71,476,34,857,24" shape="poly">
        <area alt="south-america" title="Amérique du Sud" href="#" coords="437,545,450,686,528,940,583,986,650,806,712,647,644,560,522,487" shape="poly">
        <area alt="africa"         title="Afrique"          href="#" coords="835,346,778,509,907,589,993,854,1161,774,1181,636,1154,582,1198,491,1064,362,949,322" shape="poly">
        <area alt="europe"         title="Europe"           href="#" coords="1273,63,983,25,818,241,834,339,912,316,1041,343,1103,297,1163,314,1236,221" shape="poly">
        <area alt="asia"           title="Asie"             href="#" coords="1899,137,1476,49,1271,83,1242,226,1175,316,1081,314,1085,375,1203,491,1326,535,1436,599,1521,657,1604,599" shape="poly">
        <area alt="oceania"        title="Océanie"          href="#" coords="1743,608,1617,586,1522,718,1476,752,1482,857,1561,844,1607,928,1712,976,1783,905" shape="poly">
      </map>
    </div>
  </div>

  <!-- Video overlay -->
  <div id="video-overlay" style="display:none;">
    <video id="end-video" playsinline controls>
      <source id="video-source" src="" type="video/mp4">
      Votre navigateur ne prend pas en charge la balise vidéo.
    </video>
  </div>

  <!-- Tiny status for dev -->
  <div id="statusStrip"><div id="statusDot"></div><div id="statusMsg">Initialisation…</div></div>

  <!-- Keep only your eyegaze menu JS; avoid other commons to reduce surprises -->
  <script src="../../js/eyegaze-menu.js"></script>

  <script>
  /* ===================== UTIL ===================== */
  const statusStrip = document.getElementById('statusStrip');
  const statusMsg   = document.getElementById('statusMsg');
  function setStatus(ok, text){
    statusStrip.classList.toggle('good', !!ok);
    statusStrip.classList.toggle('bad',  !ok);
    statusMsg.innerHTML = text;
  }

  // Simple PIP (ray casting) for polygon; handles rect/circle too
  function pointInPolygon(x, y, poly){
    let inside = false;
    for (let i = 0, j = poly.length - 2; i < poly.length; i += 2) {
      const xi = poly[i], yi = poly[i+1];
      const xj = poly[j], yj = poly[j+1];
      const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-9) + xi);
      if (intersect) inside = !inside;
      j = i;
    }
    return inside;
  }
  function pointInRect(x,y, [x1,y1,x2,y2]){
    const minx = Math.min(x1,x2), maxx = Math.max(x1,x2);
    const miny = Math.min(y1,y2), maxy = Math.max(y1,y2);
    return x >= minx && x <= maxx && y >= miny && y <= maxy;
  }
  function pointInCircle(x,y,[cx,cy,r]){
    const dx = x - cx, dy = y - cy;
    return dx*dx + dy*dy <= r*r;
  }

  // Videos per zone
  const ZONE_VIDEOS = {
    'north-america': 'https://bucket.adaptatech.org/north-america.mp4',
    'south-america': 'https://bucket.adaptatech.org/south-america.mp4',
    'africa':        'https://bucket.adaptatech.org/africa.mp4',
    'europe':        'https://bucket.adaptatech.org/europe.mp4',
    'asia':          'https://bucket.adaptatech.org/asia.mp4',
    'oceania':       'https://bucket.adaptatech.org/oceania.mp4'
  };

  // Non-blocking preload with a slim bar
  (function preloadVideos(){
    const wrap = document.getElementById('preload-bar-wrap');
    const bar  = document.getElementById('preload-bar');
    wrap.style.display = 'block';
    const keys = Object.keys(ZONE_VIDEOS);
    let done = 0;
    const mark = () => {
      done++;
      bar.style.width = Math.round(done / keys.length * 100) + '%';
      if (done >= keys.length) setTimeout(() => wrap.style.display = 'none', 400);
    };
    keys.forEach(k=>{
      const v = document.createElement('video');
      v.preload = 'auto'; v.muted = true; v.playsInline = true;
      v.src = ZONE_VIDEOS[k]; v.style.display='none';
      document.body.appendChild(v);
      v.addEventListener('canplaythrough', mark, { once:true });
      v.addEventListener('loadeddata', mark, { once:true });
      v.addEventListener('error', mark, { once:true });
    });
  })();

  /* ===================== MAIN ===================== */
  (function main(){
    const startBtn      = document.getElementById('startButton');
    const worldMap      = document.getElementById('worldMap');
    const stage         = document.getElementById('game-stage');
    const hoverCircle   = document.getElementById('hover-circle');
    const videoOverlay  = document.getElementById('video-overlay');
    const endVideo      = document.getElementById('end-video');
    const videoSource   = document.getElementById('video-source');

    // Show Start immediately
    startBtn.style.display = 'inline-block';

    worldMap.addEventListener('load', () => {
      setStatus(true, `Carte chargée: <code>${worldMap.currentSrc}</code> (${worldMap.naturalWidth}×${worldMap.naturalHeight})`);
    });
    worldMap.addEventListener('error', () => {
      setStatus(false, `ERREUR image: <code>${worldMap.currentSrc || worldMap.src}</code>`);
    });

    // Parse areas into geometry (once)
    const areaDefs = Array.from(document.querySelectorAll('map[name="image-map"] area')).map(a => {
      return {
        zone: (a.getAttribute('alt') || '').toLowerCase(),
        shape: (a.getAttribute('shape') || 'poly').toLowerCase(),
        coords: (a.getAttribute('coords') || '').split(',').map(n=>parseFloat(n))
      };
    });

    function zoneAtClientPoint(clientX, clientY){
      const rect = worldMap.getBoundingClientRect();
      if (rect.width <= 0 || rect.height <= 0) return null;

      // Convert pointer to image NATURAL coordinate space
      const sx = worldMap.naturalWidth  / rect.width;
      const sy = worldMap.naturalHeight / rect.height;
      const x = (clientX - rect.left) * sx;
      const y = (clientY - rect.top)  * sy;

      for (const a of areaDefs) {
        if (!a.zone) continue;
        if (a.shape === 'poly' && a.coords.length >= 6) {
          if (pointInPolygon(x, y, a.coords)) return a.zone;
        } else if (a.shape === 'rect' && a.coords.length === 4) {
          if (pointInRect(x, y, a.coords)) return a.zone;
        } else if (a.shape === 'circle' && a.coords.length === 3) {
          if (pointInCircle(x, y, a.coords)) return a.zone;
        }
      }
      return null;
    }

    // Dwell logic
    let dwellTimer = null;
    let currentZone = null;

    function beginDwell(zone, clientX, clientY) {
      const dwell = Number(window.eyegazeSettings?.dwellTime ?? 1500);

      // position visual
      const rect = stage.getBoundingClientRect();
      hoverCircle.style.left = (clientX - rect.left) + 'px';
      hoverCircle.style.top  = (clientY - rect.top)  + 'px';
      hoverCircle.style.display = 'block';
      hoverCircle.style.width = '20px';
      hoverCircle.style.height = '20px';
      hoverCircle.style.transition = 'none';

      requestAnimationFrame(() => {
        hoverCircle.style.transition = `width ${dwell}ms ease, height ${dwell}ms ease`;
        hoverCircle.style.width = '110px';
        hoverCircle.style.height = '110px';
      });

      clearTimeout(dwellTimer);
      dwellTimer = setTimeout(() => {
        hoverCircle.style.display = 'none';
        triggerZone(zone);
      }, dwell);
    }

    function cancelDwell(){
      clearTimeout(dwellTimer);
      dwellTimer = null;
      hoverCircle.style.display = 'none';
      currentZone = null;
    }

    function handleMove(ev){
      const clientX = ev.clientX ?? (ev.touches && ev.touches[0]?.clientX);
      const clientY = ev.clientY ?? (ev.touches && ev.touches[0]?.clientY);
      if (clientX == null || clientY == null) return;

      const z = zoneAtClientPoint(clientX, clientY);
      if (!z) { cancelDwell(); return; }

      if (z !== currentZone) {
        currentZone = z;
        beginDwell(z, clientX, clientY);
      } else {
        // keep the circle centered while dwelling
        const rect = stage.getBoundingClientRect();
        hoverCircle.style.left = (clientX - rect.left) + 'px';
        hoverCircle.style.top  = (clientY - rect.top)  + 'px';
      }
    }

    // Attach to the image/stage
    stage.addEventListener('pointermove', handleMove, { passive:true });
    stage.addEventListener('mousemove', handleMove, { passive:true });
    stage.addEventListener('touchmove', handleMove, { passive:true });
    stage.addEventListener('pointerleave', cancelDwell);
    stage.addEventListener('mouseleave',  cancelDwell);
    stage.addEventListener('touchend',    cancelDwell);

    // Prevent accidental navigation if areas are clicked
    document.querySelectorAll('area').forEach(a => a.addEventListener('click', e => e.preventDefault()));

    // Start button hides the menu overlay
    startBtn.addEventListener('click', () => {
      if (window.eyegazeSettings && typeof eyegazeSettings.hideOverlay === 'function') {
        eyegazeSettings.hideOverlay();
      } else {
        const modal = document.getElementById('game-options');
        if (modal) modal.style.display = 'none';
      }
      setStatus(true, 'Jeu prêt.');
    });

    // Play video for a zone
    function triggerZone(zone) {
      const src = ZONE_VIDEOS[zone];
      if (!src) return;

      document.getElementById('video-source').src = src;
      videoOverlay.style.display = 'grid';
      endVideo.load();
      endVideo.play().catch(() => {
        endVideo.muted = true;
        endVideo.play().catch(()=>{ /* user can tap */ });
      });

      endVideo.onended = () => {
        videoOverlay.style.display = 'none';
      };
    }

    // Initialize dwell slider from eyegazeSettings (your common JS already does this too)
    document.getElementById('dwellTimeSlider')?.addEventListener('input', (e)=>{
      const v = parseInt(e.target.value, 10);
      document.getElementById('dwellTimeVal').textContent = v;
    });
  })();
  </script>
</body>
</html>
