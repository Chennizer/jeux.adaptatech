<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title class="translate" data-fr="Prairie aux lucioles" data-en="Firefly Meadow" data-ja="ホタルの草原">Prairie aux lucioles</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root {
      color-scheme: dark;
    }

    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #040713;
      font-family: "Poppins", "Segoe UI", system-ui, -apple-system, sans-serif;
    }

    body.playing #game-options,
    body.playing #startHint {
      display: none !important;
    }

    #langToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1200;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 2px solid #0fd9c5;
      background: rgba(0, 10, 20, 0.75);
      color: #9cfaf0;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
    }

    #sky {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 30% 20%, rgba(78, 139, 255, 0.12), rgba(4, 7, 19, 0.3) 34%),
                  radial-gradient(circle at 70% 10%, rgba(87, 255, 210, 0.14), rgba(4, 7, 19, 0.4) 36%),
                  linear-gradient(180deg, #040713 0%, #070d1f 45%, #050915 100%);
    }

    #field {
      position: absolute;
      inset: 0;
      pointer-events: auto;
    }

    #starfield {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      filter: drop-shadow(0 0 18px rgba(82, 210, 255, 0.18));
    }

    .star {
      position: absolute;
      width: var(--size);
      height: var(--size);
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.95) 0%, rgba(180, 255, 239, 0.7) 55%, transparent 72%);
      opacity: 0.35;
      animation: twinkle var(--dur) ease-in-out infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.18; transform: scale(0.9); }
      50% { opacity: 0.8; transform: scale(1.15); }
    }

    /* === Game options modal (matches other eyegaze menus) === */
    #game-options.modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1400;
    }

    #options-title-bar {
      background: #009688;
      padding: 18px 26px 14px;
      border-radius: 14px 14px 8px 8px;
      text-align: center;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
    }

    #options-main-title {
      margin: 0;
      color: #ffffff;
      font-size: 1.65rem;
      font-weight: 800;
      letter-spacing: 0.02em;
    }

    #options-subtitle {
      margin: 6px 0 0;
      color: #e5fffa;
      opacity: 0.9;
      font-size: 0.95rem;
    }

    #control-panel-options {
      background: rgba(7, 12, 26, 0.9);
      border: 3px solid rgba(0, 150, 136, 0.6);
      border-radius: 16px;
      padding: 18px;
      margin-top: -6px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(4px);
    }

    #options-inline-container {
      align-items: flex-start;
      gap: 18px;
    }

    #control-panel-options .option-item {
      margin-bottom: 14px;
      color: #e9fbf8;
    }

    #control-panel-options .teal-label {
      color: #bdf7ee;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    #control-panel-options .styled-slider,
    #control-panel-options .styled-select,
    #control-panel-options .styled-input {
      background: rgba(255, 255, 255, 0.1);
      color: #f0fffd;
    }

    #control-panel-options .button {
      min-width: 180px;
    }

    .badge-value {
      display: inline-block;
      min-width: 44px;
      text-align: center;
      padding: 4px 8px;
      margin-left: 6px;
      border-radius: 10px;
      background: rgba(0, 223, 201, 0.15);
      color: #bffcf6;
      font-variant-numeric: tabular-nums;
    }

    #startHint {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      background: rgba(0, 10, 20, 0.6);
      color: #dffbf6;
      padding: 10px 16px;
      border: 1px solid rgba(0, 223, 201, 0.3);
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      font-weight: 600;
      z-index: 600;
      letter-spacing: 0.02em;
    }

    /* === Firefly targets === */
    .firefly {
      position: absolute;
      left: 0;
      top: 0;
      width: var(--size);
      height: var(--size);
      transform: translate3d(var(--x), var(--y), 0);
      pointer-events: auto;
      border-radius: 50%;
      --size: 84px;
      --hue: 165;
      --arc: 0deg;
      --flicker: 0.65;
      filter: drop-shadow(0 0 24px hsla(var(--hue), 85%, 65%, 0.75));
      transition: filter 0.35s ease;
      will-change: transform, filter;
    }

    .firefly::before,
    .firefly::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
    }

    /* outer halo */
    .firefly::before {
      background: radial-gradient(circle at 36% 32%, hsla(var(--hue), 95%, 96%, 0.9) 0%, hsla(var(--hue), 90%, 70%, 0.82) 14%, hsla(var(--hue), 90%, 50%, 0.2) 40%, transparent 68%),
                  radial-gradient(circle at 72% 65%, hsla(var(--hue), 90%, 70%, 0.8) 0%, hsla(var(--hue), 95%, 60%, 0.25) 30%, transparent 52%);
      box-shadow: 0 0 28px hsla(var(--hue), 85%, 65%, 0.85), 0 0 64px hsla(var(--hue), 85%, 60%, 0.32);
      opacity: 0.9;
      mix-blend-mode: screen;
    }

    /* progress ring */
    .firefly::after {
      inset: -14%;
      background: conic-gradient(hsla(var(--hue), 95%, 76%, 0.95) var(--arc), transparent var(--arc) 360deg);
      mask: radial-gradient(circle at center, transparent 60%, black 62%);
      opacity: 0.86;
      filter: drop-shadow(0 0 8px hsla(var(--hue), 95%, 75%, 0.45));
    }

    .firefly .core {
      position: absolute;
      inset: 22%;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #ffffff 0%, hsla(var(--hue), 100%, 86%, 0.95) 35%, hsla(var(--hue), 100%, 70%, 0.75) 65%, hsla(var(--hue), 92%, 55%, 0.35) 100%);
      box-shadow: inset 0 0 14px hsla(var(--hue), 100%, 88%, 0.9);
      animation: heartbeat 2.1s ease-in-out infinite;
      opacity: 0.98;
    }

    .firefly .wing {
      position: absolute;
      inset: 12%;
      border-radius: 50%;
      background: radial-gradient(ellipse at 50% 20%, hsla(var(--hue), 95%, 82%, 0.9) 0%, hsla(var(--hue), 95%, 62%, 0.5) 45%, transparent 70%);
      filter: blur(2px);
      opacity: var(--flicker);
      animation: flutter 2.3s ease-in-out infinite;
      mix-blend-mode: screen;
    }

    .firefly:focus-visible {
      outline: 2px solid #ffffff;
      outline-offset: 6px;
    }

    .firefly.dwell {
      filter: drop-shadow(0 0 32px hsla(var(--hue), 96%, 70%, 0.95));
      transform: translate3d(var(--x), var(--y), 0) scale(1.05);
    }

    .firefly.bursting {
      animation: lift 0.9s ease;
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    @keyframes flutter {
      0% { opacity: 0.52; filter: blur(2px); }
      50% { opacity: 0.86; filter: blur(1.3px); }
      100% { opacity: 0.52; filter: blur(2px); }
    }

    @keyframes lift {
      0% { transform: translate3d(var(--x), var(--y), 0) scale(1); opacity: 1; }
      60% { transform: translate3d(calc(var(--x)), calc(var(--y) - 6px), 0) scale(1.08); opacity: 0.94; }
      100% { transform: translate3d(var(--x), var(--y), 0) scale(1); opacity: 1; }
    }

    /* mini fireflies for reward burst */
    .mini-firefly {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      pointer-events: none;
      background: radial-gradient(circle, #fff 0%, hsla(var(--hue), 100%, 70%, 0.9) 55%, transparent 70%);
      box-shadow: 0 0 10px hsla(var(--hue), 100%, 70%, 0.9), 0 0 20px rgba(0, 0, 0, 0.25);
      transform-origin: center;
      animation: miniSpiral var(--dur, 2.8s) ease-out forwards, sparkle 1.6s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 10px hsla(var(--hue), 96%, 72%, 0.8));
      opacity: 0.95;
    }

    @keyframes miniSpiral {
      0% { transform: translate(-50%, -50%) scale(0.6); opacity: 0.95; }
      60% { transform: translate(calc(-50% + var(--dx) * 0.7), calc(-50% + var(--dy) * 0.7)) scale(1.05); }
      100% { transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(0.75); opacity: 0; }
    }

    @keyframes sparkle {
      from { filter: drop-shadow(0 0 10px hsla(var(--hue), 98%, 80%, 0.75)); opacity: 0.55; }
      to   { filter: drop-shadow(0 0 16px hsla(var(--hue), 98%, 88%, 0.95)); opacity: 0.95; }
    }

  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>
<body>
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <div id="game-options" class="modal" role="dialog" aria-modal="true">
    <div>
      <div id="options-title-bar">
        <h2 id="options-main-title" class="translate" data-fr="Prairie aux lucioles" data-en="Firefly Meadow" data-ja="ホタルの草原">Prairie aux lucioles</h2>
        <p id="options-subtitle" class="translate" data-fr="Fixez une luciole jusqu'à ce que son halo se ferme puis regardez-la éclater en un nuage lumineux." data-en="Gaze at a firefly until its halo completes and watch it bloom into a sparkling swarm." data-ja="ホタルの輪が満ちるまで見つめて、きらめく群れに変わる様子を楽しんでください。">Fixez une luciole jusqu'à ce que son halo se ferme puis regardez-la éclater en un nuage lumineux.</p>
      </div>
      <div id="control-panel-options">
        <div id="mode-divider"></div>
        <div id="options-inline-container">
          <div class="options-column">
            <div class="option-item">
              <label for="dwellTime" class="teal-label translate" data-fr="Temps de fixation" data-en="Dwell time" data-ja="注視時間">Temps de fixation</label>
              <div>
                <input id="dwellTime" type="range" class="styled-slider" min="500" max="4000" step="100" value="1500" />
                <span id="dwellVal" class="badge-value">1500 ms</span>
              </div>
            </div>
            <div class="option-item">
              <label for="density" class="teal-label translate" data-fr="Nombre de cibles" data-en="Number of targets" data-ja="ターゲットの数">Nombre de cibles</label>
              <div>
                <input id="density" type="range" class="styled-slider" min="4" max="14" value="7" />
                <span id="densityVal" class="badge-value">7</span>
              </div>
            </div>
          </div>
          <div class="options-column">
            <div class="option-item">
              <label class="teal-label translate" data-fr="Berceuse" data-en="Lullaby mode" data-ja="ララバイモード">Berceuse</label>
              <button id="calmToggle" class="button">Activer la berceuse</button>
              <small class="translate" data-fr="Fait éclater doucement des lucioles au hasard." data-en="Gently bursts random fireflies over time." data-ja="時間とともにランダムなホタルを柔らかく弾けさせます。"></small>
            </div>
            <div class="option-item">
              <label class="teal-label translate" data-fr="Fond scintillant" data-en="Gentle stars" data-ja="やさしい星空">Fond scintillant</label>
              <small class="translate" data-fr="De petites étoiles scintillent doucement à l'arrière-plan." data-en="Soft star glints shimmer in the background." data-ja="背景でやさしく星がきらめきます。"></small>
            </div>
          </div>
          <div class="options-column">
            <div class="option-item" style="margin-top: 10px;">
              <button id="startButton" class="button primary translate" data-fr="Commencer (plein écran)" data-en="Start (fullscreen)" data-ja="開始（フルスクリーン）">Commencer (plein écran)</button>
            </div>
            <div class="option-item">
              <p class="teal-label" style="margin: 4px 0 0; font-size: 0.9rem; opacity: 0.9;">
                <span class="translate" data-fr="Astuce" data-en="Tip" data-ja="ヒント">Astuce</span> —
                <span class="translate" data-fr="La touche Entrée lance aussi l'expérience." data-en="Press Enter to launch as well." data-ja="Enterキーでも開始できます。"></span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="sky">
    <div id="starfield" aria-hidden="true"></div>
    <div id="field" role="application" aria-label="Prairie aux lucioles"></div>
  </div>

  <div id="startHint" class="translate" data-fr="Appuyez sur Commencer ou Entrée pour passer en plein écran" data-en="Press Start or Enter to enter fullscreen" data-ja="開始またはEnterを押してフルスクリーンにします">Appuyez sur Commencer ou Entrée pour passer en plein écran</div>

  <script src="../../js/translationmain.js"></script>
  <script>
    const field = document.getElementById('field');
    const starfield = document.getElementById('starfield');
    const dwellInput = document.getElementById('dwellTime');
    const dwellVal = document.getElementById('dwellVal');
    const densityInput = document.getElementById('density');
    const densityVal = document.getElementById('densityVal');
    const startButton = document.getElementById('startButton');
    const calmToggle = document.getElementById('calmToggle');
    const startHint = document.getElementById('startHint');

    let dwellTime = Number(dwellInput.value);
    let fireflies = [];
    let miniPool = [];
    let calmInterval = null;
    let playing = false;
    let lastTime = 0;
    const frameInterval = 1000 / 30; // gentler refresh for lower CPU/GPU load
    let viewportW = window.innerWidth;
    let viewportH = window.innerHeight;

    const hues = [150, 162, 174, 188, 200];

    function resize() {
      viewportW = window.innerWidth;
      viewportH = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    /* === Background stars (static setup) === */
    (function buildStars() {
      const count = 70;
      for (let i = 0; i < count; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const size = 1.5 + Math.random() * 2.5;
        star.style.setProperty('--size', `${size}px`);
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.animationDelay = `${Math.random() * 6}s`;
        star.style.setProperty('--dur', `${5 + Math.random() * 8}s`);
        starfield.appendChild(star);
      }
    })();

    /* === Firefly creation & layout === */
    function createFirefly() {
      const size = 64 + Math.random() * 42;
      const hue = hues[Math.floor(Math.random() * hues.length)] + Math.random() * 12 - 6;
      const x = Math.random() * viewportW;
      const y = Math.random() * viewportH;
      const vx = (Math.random() - 0.5) * 0.55;
      const vy = (Math.random() - 0.5) * 0.55;

      const el = document.createElement('div');
      el.className = 'firefly';
      el.style.setProperty('--size', `${size}px`);
      el.style.setProperty('--hue', hue.toFixed(1));
      el.style.setProperty('--x', `${x}px`);
      el.style.setProperty('--y', `${y}px`);
      el.setAttribute('tabindex', '0');
      el.innerHTML = '<div class="wing"></div><div class="core"></div>';

      const fly = { el, x, y, vx, vy, hue, size, phase: Math.random() * Math.PI * 2, dwellFrame: null };

      el.addEventListener('pointerenter', () => startDwell(fly));
      el.addEventListener('pointerleave', () => cancelDwell(fly));
      el.addEventListener('focus', () => startDwell(fly));
      el.addEventListener('blur', () => cancelDwell(fly));

      field.appendChild(el);
      fireflies.push(fly);
      positionFirefly(fly);
    }

    function populate(count) {
      fireflies.forEach(f => f.el.remove());
      fireflies = [];
      for (let i = 0; i < count; i++) createFirefly();
    }

    function positionFirefly(fly) {
      fly.el.style.setProperty('--x', `${fly.x}px`);
      fly.el.style.setProperty('--y', `${fly.y}px`);
    }

    /* === Dwell interactions === */
    function startDwell(fly) {
      cancelDwell(fly);
      fly.el.classList.add('dwell');
      const start = performance.now();

      const step = (now) => {
        const progress = Math.min((now - start) / dwellTime, 1);
        fly.el.style.setProperty('--arc', `${progress * 360}deg`);
        if (progress >= 1) {
          triggerFirefly(fly);
          return;
        }
        fly.dwellFrame = requestAnimationFrame(step);
      };
      fly.dwellFrame = requestAnimationFrame(step);
    }

    function cancelDwell(fly) {
      fly.el.classList.remove('dwell');
      fly.el.style.setProperty('--arc', '0deg');
      if (fly.dwellFrame) cancelAnimationFrame(fly.dwellFrame);
      fly.dwellFrame = null;
    }

    function triggerFirefly(fly) {
      cancelDwell(fly);
      fly.el.classList.add('bursting');
      setTimeout(() => fly.el.classList.remove('bursting'), 1000);
      spawnMiniSwarm(fly);
      relocate(fly);
    }

    function relocate(fly) {
      fly.x = Math.random() * viewportW;
      fly.y = Math.random() * viewportH;
      fly.vx = (Math.random() - 0.5) * 0.6;
      fly.vy = (Math.random() - 0.5) * 0.6;
      positionFirefly(fly);
      fly.el.style.setProperty('--arc', '0deg');
    }

    /* === Mini swarm === */
    function spawnMiniSwarm(fly) {
      const rect = fly.el.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const count = 6 + Math.floor(Math.random() * 4);

      for (let i = 0; i < count; i++) {
        const mini = document.createElement('div');
        const angle = Math.random() * Math.PI * 2;
        const radius = 60 + Math.random() * 140;
        mini.className = 'mini-firefly';
        mini.style.left = `${centerX}px`;
        mini.style.top = `${centerY}px`;
        mini.style.setProperty('--dx', `${Math.cos(angle) * radius}px`);
        mini.style.setProperty('--dy', `${Math.sin(angle) * radius}px`);
        mini.style.setProperty('--dur', `${2 + Math.random() * 1.2}s`);
        mini.style.setProperty('--hue', fly.hue.toFixed(1));
        mini.style.animationDelay = `${Math.random() * 0.2}s`;

        field.appendChild(mini);
        miniPool.push(mini);
        setTimeout(() => {
          mini.remove();
          miniPool = miniPool.filter(m => m !== mini);
        }, 4200);
      }
    }

    /* === Motion loop === */
    function tick(now) {
      if (!lastTime) lastTime = now;
      const elapsed = now - lastTime;
      if (elapsed < frameInterval) {
        requestAnimationFrame(tick);
        return;
      }
      const dt = Math.min(60, elapsed);
      lastTime = now;

      fireflies.forEach(f => {
        f.phase += 0.008 * dt;
        const drift = 0.08 + Math.random() * 0.02;
        f.vx += (Math.random() - 0.5) * drift;
        f.vy += (Math.random() - 0.5) * drift;

        const pulse = Math.sin(f.phase) * 0.45;
        f.el.style.setProperty('--flicker', (0.6 + pulse * 0.18).toFixed(3));

        f.x += f.vx * dt * 0.06;
        f.y += f.vy * dt * 0.06;

        const margin = 50;
        if (f.x < -margin) f.x = viewportW + margin;
        if (f.x > viewportW + margin) f.x = -margin;
        if (f.y < -margin) f.y = viewportH + margin;
        if (f.y > viewportH + margin) f.y = -margin;

        positionFirefly(f);
      });

      requestAnimationFrame(tick);
    }

    /* === Controls === */
    dwellInput.addEventListener('input', (e) => {
      dwellTime = Number(e.target.value);
      dwellVal.textContent = `${dwellTime} ms`;
    });

    densityInput.addEventListener('input', (e) => {
      const val = Number(e.target.value);
      densityVal.textContent = val;
      populate(val);
    });

    function toggleCalmMode() {
      if (calmInterval) {
        clearInterval(calmInterval);
        calmInterval = null;
        calmToggle.textContent = 'Activer la berceuse';
        return;
      }
      calmToggle.textContent = 'Berceuse activée';
      calmInterval = setInterval(() => {
        if (!fireflies.length) return;
        const pick = fireflies[Math.floor(Math.random() * fireflies.length)];
        triggerFirefly(pick);
      }, 2200);
    }
    calmToggle.addEventListener('click', toggleCalmMode);

    function requestFullscreen() {
      const el = document.documentElement;
      const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
      if (fn) fn.call(el);
    }

    function startGame() {
      requestFullscreen();
      document.body.classList.add('playing');
      playing = true;
      startHint.style.display = 'none';
    }

    startButton.addEventListener('click', startGame);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !playing) startGame();
    });

    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        playing = false;
        document.body.classList.remove('playing');
      }
    });

    // Init
    populate(Number(densityInput.value));
    requestAnimationFrame(tick);

  </script>
</body>
</html>
