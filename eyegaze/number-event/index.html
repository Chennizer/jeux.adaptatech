<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title class="translate" data-fr="Nombre-événement" data-en="Number as Event" data-ja="数のイベント">Nombre-événement</title>
  <link rel="stylesheet" href="../../css/games.css">
  <link rel="stylesheet" href="../../css/choiceeyegaze.css">
  <style>
    :root {
      --surface: #0b1021;
      --glow: #22d3ee;
      --accent: #fcd34d;
      --soft: #a5b4fc;
    }
    html, body {
      width: 100%; height: 100%; margin: 0; padding: 0;
      background: radial-gradient(circle at 30% 30%, #0b1120, #060815 60%);
      color: #e5e7eb;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
    }
    body { display: flex; align-items: stretch; justify-content: center; }
    #scene {
      position: relative;
      flex: 1;
      max-width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: radial-gradient(circle at 70% 20%, rgba(34,211,238,0.15), rgba(15,23,42,0.8) 40%),
                  radial-gradient(circle at 20% 70%, rgba(252,211,77,0.12), rgba(6,8,21,0.8) 45%),
                  #060815;
    }
    #startScreen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(4,7,17,0.96));
      z-index: 20;
      transition: opacity 400ms ease, visibility 400ms ease;
    }
    #startScreen.hidden { opacity: 0; visibility: hidden; }
    .start-card {
      width: min(520px, 90vw);
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 28px;
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 50px rgba(0,0,0,0.35);
    }
    .start-card h1 { margin: 0 0 12px; font-size: clamp(26px, 3vw, 32px); letter-spacing: -0.02em; }
    .start-card p { margin: 6px 0 18px; color: #cbd5e1; line-height: 1.5; }
    #startButton {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 18px;
      font-size: 17px;
      border-radius: 12px;
      border: 2px solid #22d3ee;
      background: linear-gradient(135deg, #22d3ee, #0ea5e9);
      color: #0b1120;
      font-weight: 700;
      box-shadow: 0 10px 30px rgba(34,211,238,0.35);
      cursor: pointer;
    }
    #startButton:active { transform: translateY(1px); }
    #langToggle {
      position: fixed;
      top: 12px; right: 12px;
      z-index: 30;
      padding: 6px 12px;
      border-radius: 10px;
      border: 2px solid #22d3ee;
      background: rgba(6,8,21,0.85);
      color: #22d3ee;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    #hud {
      position: absolute;
      bottom: 18px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.32);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 12px 16px;
      border-radius: 12px;
      color: #cbd5e1;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(6px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      pointer-events: none;
    }
    #hud .dot {
      width: 12px; height: 12px;
      border-radius: 50%;
      background: radial-gradient(circle, #fcd34d 0%, #f97316 60%, #c2410c 100%);
      box-shadow: 0 0 18px rgba(252,211,77,0.9);
    }
    .event {
      position: absolute;
      pointer-events: none;
      border-radius: 999px;
      mix-blend-mode: screen;
      filter: blur(0.3px);
    }
    .pulse {
      width: 26px; height: 26px;
      background: radial-gradient(circle, #fcd34d 0%, rgba(252,211,77,0.15) 70%);
      animation: pulse 900ms ease-out forwards;
    }
    .spark {
      width: 14px; height: 14px;
      background: radial-gradient(circle, #7dd3fc 0%, rgba(125,211,252,0.05) 80%);
      box-shadow: 0 0 24px rgba(125,211,252,0.8);
      animation: spark 1200ms ease-out forwards;
    }
    .drop {
      width: 14px; height: 24px;
      background: radial-gradient(circle at 30% 20%, #22d3ee 0%, #0ea5e9 70%, rgba(34,211,238,0) 80%);
      animation: drop 1300ms ease-in forwards;
    }
    .halo {
      width: 60px; height: 60px;
      background: radial-gradient(circle, rgba(164, 255, 255, 0.65) 0%, rgba(14,165,233,0.1) 70%);
      animation: halo 1400ms ease-out forwards;
      filter: blur(1px);
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(0.6); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(3.2); opacity: 0; }
    }
    @keyframes spark {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
      100% { transform: translate(-50%, -50%) translate(var(--dx), var(--dy)) scale(1.8); opacity: 0; }
    }
    @keyframes drop {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.95; }
      100% { transform: translate(-50%, 260%) scale(0.4); opacity: 0; }
    }
    @keyframes halo {
      0% { transform: translate(-50%, -50%) scale(0.4); opacity: 0.9; }
      100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
    }
  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>
<body>
  <button id="langToggle" aria-label="Toggle language">FR</button>
  <div id="startScreen">
    <div class="start-card">
      <h1 class="translate" data-fr="Nombre-événement" data-en="Number as Event" data-ja="数のイベント">Nombre-événement</h1>
      <p class="translate" data-fr="Fixez simplement l'écran. Chaque regard déclenche un nombre entendu et des éclats lumineux correspondants."
         data-en="Simply look at the screen. Each gaze triggers a spoken number and matching bursts of light."
         data-ja="画面を見るだけ。視線が届くたびに数字が読み上げられ、その数だけ光のイベントが起こります。">Fixez simplement l'écran. Chaque regard déclenche un nombre entendu et des éclats lumineux correspondants.</p>
      <p class="translate" data-fr="Appuyez sur Démarrer pour passer en plein écran et activer les sons et vibrations."
         data-en="Press Start to go fullscreen and enable sounds and vibrations."
         data-ja="開始を押すと全画面になり、音声とバイブレーションが有効になります。">Appuyez sur Démarrer pour passer en plein écran et activer les sons et vibrations.</p>
      <button id="startButton" class="translate" data-fr="Démarrer • Plein écran" data-en="Start • Fullscreen" data-ja="開始・全画面">Démarrer • Plein écran</button>
    </div>
  </div>

  <main id="scene" aria-live="polite" tabindex="-1">
    <div id="hud">
      <span class="dot" aria-hidden="true"></span>
      <span class="translate" data-fr="Regardez n'importe où pour lancer des événements" data-en="Look anywhere to trigger events" data-ja="どこかを見つめるとイベントが起こります">Regardez n'importe où pour lancer des événements</span>
    </div>
  </main>

  <script>
    const languages = ['fr','en','ja'];
    let currentLang = localStorage.getItem('numberEventLang') || 'fr';

    function applyTranslations(lang) {
      const target = languages.includes(lang) ? lang : 'fr';
      document.documentElement.lang = target;
      document.querySelectorAll('.translate').forEach(el => {
        const text = el.dataset[target];
        if (!text) return;
        if (el.placeholder !== undefined && el.tagName === 'INPUT') {
          el.placeholder = text;
        } else {
          el.textContent = text;
        }
      });
      const toggle = document.getElementById('langToggle');
      if (toggle) toggle.textContent = target.toUpperCase();
    }

    function initLanguageToggle() {
      const toggle = document.getElementById('langToggle');
      toggle.addEventListener('click', () => {
        const idx = languages.indexOf(currentLang);
        currentLang = languages[(idx + 1) % languages.length];
        localStorage.setItem('numberEventLang', currentLang);
        applyTranslations(currentLang);
      });
      applyTranslations(currentLang);
    }

    const scene = document.getElementById('scene');
    const startScreen = document.getElementById('startScreen');
    const startButton = document.getElementById('startButton');
    let lastTrigger = 0;
    const triggerGap = 1200; // milliseconds between gaze events

    const numberWords = {
      fr: ['un','deux','trois','quatre','cinq','six','sept','huit','neuf','dix'],
      en: ['one','two','three','four','five','six','seven','eight','nine','ten'],
      ja: ['いち','に','さん','よん','ご','ろく','なな','はち','きゅう','じゅう']
    };
    const voiceLangs = { fr: 'fr-FR', en: 'en-US', ja: 'ja-JP' };

    function speakNumber(n) {
      const words = numberWords[currentLang] || numberWords.fr;
      const term = words[n - 1] || String(n);
      if ('speechSynthesis' in window) {
        const utter = new SpeechSynthesisUtterance(term);
        utter.lang = voiceLangs[currentLang] || 'fr-FR';
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      }
    }

    function vibratePattern(times) {
      if (!('vibrate' in navigator)) return;
      const pattern = [];
      for (let i = 0; i < times; i++) {
        pattern.push(60, 90);
      }
      navigator.vibrate(pattern);
    }

    function randomBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    function createEventElement(type, x, y) {
      const el = document.createElement('div');
      el.className = `event ${type}`;
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;
      if (type === 'spark') {
        el.style.setProperty('--dx', `${randomBetween(-80, 80)}px`);
        el.style.setProperty('--dy', `${randomBetween(-120, -40)}px`);
      }
      scene.appendChild(el);
      const lifespan = type === 'drop' ? 1400 : 1200;
      setTimeout(() => el.remove(), lifespan);
    }

    function triggerGazeEvent(x, y) {
      const now = performance.now();
      if (now - lastTrigger < triggerGap) return;
      lastTrigger = now;

      const count = Math.floor(Math.random() * 5) + 1; // 1 to 5
      speakNumber(count);
      vibratePattern(count);

      const types = ['pulse','spark','drop','halo'];
      for (let i = 0; i < count; i++) {
        const type = types[Math.floor(Math.random() * types.length)];
        const jitterX = x + randomBetween(-60, 60);
        const jitterY = y + randomBetween(-40, 80);
        setTimeout(() => createEventElement(type, jitterX, jitterY), i * 120);
      }
    }

    function handlePointer(e) {
      const rect = scene.getBoundingClientRect();
      const x = e.clientX ?? (rect.left + rect.width / 2);
      const y = e.clientY ?? (rect.top + rect.height / 2);
      triggerGazeEvent(x, y);
    }

    async function enterFullscreen() {
      const docEl = document.documentElement;
      if (document.fullscreenElement || !docEl.requestFullscreen) return;
      try {
        await docEl.requestFullscreen();
      } catch (err) {
        console.warn('Fullscreen request was blocked', err);
      }
    }

    function startGame() {
      startScreen.classList.add('hidden');
      enterFullscreen();
      window.addEventListener('pointermove', handlePointer);
      window.addEventListener('pointerdown', handlePointer);
      scene.focus({ preventScroll: true });
    }

    function init() {
      initLanguageToggle();
      startButton.addEventListener('click', startGame);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !document.fullscreenElement) {
          enterFullscreen();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
