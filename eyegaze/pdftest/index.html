<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title class="translate" data-fr="Lecture PDF par regard" data-en="Eye-Gaze PDF Reader">Lecture PDF par regard</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <!-- pdf.js (stable UMD v3) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    window.__PDFJS__ = window.pdfjsLib;
  </script>

  <!-- tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root { --teal:#009688; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: #000;
      color: #fff;
      display: block;
      overflow: hidden;
    }

    #langToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 99999;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 2px solid #009688;
      background: #111;
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      user-select: none;
    }
    body.dark #langToggle { background:#111; color:#14b8a6; border-color:#14b8a6; }

    #game-options #control-panel-options {
      max-width: 820px;
    }

    #options-title-bar {
      top: 6vh;
      width: 520px;
    }

    #options-inline-container {
      align-items: stretch;
    }

    .menu-note {
      margin: 8px 0 0;
      font-size: 0.95rem;
      color: #333;
      background: rgba(0,150,136,0.1);
      border: 1px dashed rgba(0,150,136,0.4);
      border-radius: 10px;
      padding: 10px 12px;
      text-align: center;
    }

    .scroll-placeholder {
      width: 100%;
      min-height: 120px;
      max-height: 180px;
      overflow-y: auto;
      border: 2px dashed rgba(0,150,136,0.4);
      border-radius: 12px;
      padding: 16px;
      background: rgba(0,150,136,0.08);
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: 600;
    }

    #startButton {
      min-width: 200px;
    }
    #startButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      filter: none;
    }

    .disabled-option {
      opacity: 0.5;
    }

    #stage {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: #000;
      cursor: pointer;
      z-index: 1;
    }

    canvas {
      display: block;
      max-width: 100vw;
      max-height: 100vh;
    }

    #hud {
      position: fixed;
      left: 12px;
      bottom: 12px;
      padding: 6px 10px;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      font-size: 14px;
      user-select: none;
      z-index: 5;
    }

    #ocrHud {
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 6;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #ocrHud .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    #ocrHud select, #ocrHud label {
      font-size: 13px;
    }
    #ocrProg {
      height: 6px;
      background: #111;
      border-radius: 999px;
      overflow: hidden;
    }
    #ocrProg > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#60a5fa,#34d399);
      transition: width 0.15s ease;
    }
    #ocrStatus {
      opacity: .85;
    }

    #textOut {
      display: none;
      width: min(520px, 90vw);
      max-height: 30vh;
      overflow: auto;
      background: #0b0b0b;
      color: #ddd;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 8px;
      margin: 0;
      position: fixed;
      right: 12px;
      bottom: 82px;
      z-index: 6;
      white-space: pre-wrap;
    }

    .playing #langToggle,
    .playing #game-options {
      display: none !important;
    }

    .playing #ocrHud,
    .playing #hud,
    .playing #textOut {
      display: none !important;
    }

    @media (max-width: 900px) {
      #options-inline-container {
        grid-template-columns: 1fr;
      }
      #options-inline-container > div {
        align-items: center;
        border-right: none !important;
      }
      #options-title-bar {
        width: min(90vw, 520px);
      }
      .scroll-placeholder {
        min-height: 90px;
      }
    }
  </style>
</head>
<body>
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <div id="game-options" class="modal" aria-modal="true" role="dialog">
    <div id="options-title-bar">
      <h2 id="options-main-title" class="translate" data-fr="Lecture PDF par regard" data-en="Eye-Gaze PDF Reader">Lecture PDF par regard</h2>
    </div>

    <div id="control-panel-options">
      <div id="mode-divider"></div>

      <div id="options-inline-container">
        <div class="options-column">
          <div class="option-item">
            <label for="interfaceLang" class="teal-label label-block translate" data-fr="Langue de l'interface" data-en="Interface language">Langue de l'interface</label>
            <select id="interfaceLang" class="styled-select compact-field">
              <option value="fr" class="translate" data-fr="Français" data-en="French">Français</option>
              <option value="en" class="translate" data-fr="Anglais" data-en="English">Anglais</option>
            </select>
          </div>
          <div class="option-item">
            <p class="menu-note translate" data-fr="Choisissez votre langue préférée. Vous pouvez aussi changer avec le bouton FR / EN." data-en="Pick your preferred language here. You can also toggle with the FR / EN button.">Choisissez votre langue préférée. Vous pouvez aussi changer avec le bouton FR / EN.</p>
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <button id="chooseBtn" class="button translate" data-fr="Choisir un PDF" data-en="Choose a PDF">Choisir un PDF</button>
            <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
            <p id="fileStatus" class="menu-note translate" data-fr="Aucun fichier sélectionné." data-en="No file selected.">Aucun fichier sélectionné.</p>
          </div>
          <div class="option-item">
            <label class="teal-label label-block translate" data-fr="Bibliothèque de PDF" data-en="PDF library">Bibliothèque de PDF</label>
            <div id="libraryPlaceholder" class="scroll-placeholder translate" data-fr="(Menu déroulant à venir…)" data-en="(Scrolling menu coming soon…)">(Menu déroulant à venir…)</div>
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label for="modeSelect" class="teal-label label-block translate" data-fr="Mode de lecture" data-en="Reading mode">Mode de lecture</label>
            <select id="modeSelect" class="styled-select compact-field">
              <option value="direct" class="translate" data-fr="Appuyer pour passer à la page suivante" data-en="Press to go to the next page">Appuyer pour passer à la page suivante</option>
              <option value="tts-step" class="translate" data-fr="Appuyer pour écouter puis appuyer encore pour avancer" data-en="Press to listen, then press again to advance">Appuyer pour écouter puis appuyer encore pour avancer</option>
            </select>
          </div>
          <div class="option-item">
            <p id="modeHint" class="menu-note translate" data-fr="En mode &quot;Écouter puis avancer&quot;, la première pression déclenche la lecture vocale de la page. La suivante passe à la page suivante." data-en="In &quot;Listen then advance&quot; mode, the first press speaks the page. The next press goes to the following page.">En mode "Écouter puis avancer", la première pression déclenche la lecture vocale de la page. La suivante passe à la page suivante.</p>
          </div>
        </div>
      </div>

      <div id="mode-divider"></div>
      <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start" disabled>Commencer</button>
    </div>
  </div>

  <div id="stage" aria-label="Zone d’affichage PDF">
    <canvas id="pageCanvas" aria-hidden="true"></canvas>
  </div>

  <div id="hud"><span id="pageLabel">—</span></div>

  <pre id="textOut"></pre>
  <div id="ocrHud">
    <div class="row">
      <label for="ocrLang">OCR:</label>
      <select id="ocrLang">
        <option value="eng" selected>English (eng)</option>
        <option value="fra">Français (fra)</option>
        <option value="eng+fra">English + Français</option>
        <option value="spa">Español (spa)</option>
        <option value="deu">Deutsch (deu)</option>
      </select>
      <label class="teal-label" style="font-size:13px; font-weight:600; gap:6px;">
        <input type="checkbox" id="autoRead" checked>
        <span class="translate" data-fr="Lecture auto" data-en="Auto-read">Lecture auto</span>
      </label>
    </div>
    <div id="ocrProg" aria-hidden="true"><div id="ocrBar"></div></div>
    <div id="ocrStatus">—</div>
  </div>

  <script src="../../js/eyegaze-menu.js"></script>
  <script src="../../js/translationonly.js"></script>
  <script>
    const ZONE_W_PCT = 30;
    const ZONE_H_PCT = 40;
    const ZONE_CENTER_X_PCT = 75;
    const ZONE_CENTER_Y_PCT = 50;

    const LS_LANG_KEY = 'siteLanguage';

    const langToggle = document.getElementById('langToggle');
    const langSelect = document.getElementById('interfaceLang');
    const gameOptions = document.getElementById('game-options');
    const chooseBtn = document.getElementById('chooseBtn');
    const fileInput = document.getElementById('fileInput');
    const fileStatus = document.getElementById('fileStatus');
    const startButton = document.getElementById('startButton');
    const modeSelect = document.getElementById('modeSelect');

    const stage = document.getElementById('stage');
    const canvas = document.getElementById('pageCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const hudLabel = document.getElementById('pageLabel');
    const ocrLangSel = document.getElementById('ocrLang');
    const autoRead = document.getElementById('autoRead');
    const ocrBar = document.getElementById('ocrBar');
    const ocrStatus = document.getElementById('ocrStatus');
    const textOut = document.getElementById('textOut');

    let pdfDoc = null;
    let currentPageNum = 1;
    let totalPages = 0;
    let started = false;
    let loading = false;
    let pdfData = null;
    let speakingAllowed = false;
    let currentRenderToken = 0;
    let playMode = 'direct';
    let selectedFileName = '';
    let textForSpeech = '';
    let hasSpokenForPage = true;

    function getLang() {
      try {
        const saved = localStorage.getItem(LS_LANG_KEY);
        if (saved === 'en' || saved === 'fr') return saved;
      } catch (e) {}
      return document.documentElement.lang === 'en' ? 'en' : 'fr';
    }

    function applyTranslations(lang) {
      document.querySelectorAll('.translate').forEach(el => {
        const txt = el.dataset[lang];
        if (txt != null) el.textContent = txt;
      });
    }

    function refreshFileStatus() {
      if (!fileStatus) return;
      const lang = getLang();
      if (selectedFileName) {
        fileStatus.textContent = lang === 'fr'
          ? `Fichier sélectionné : ${selectedFileName}`
          : `Selected file: ${selectedFileName}`;
      } else {
        fileStatus.textContent = lang === 'fr'
          ? "Aucun fichier sélectionné."
          : "No file selected.";
      }
    }

    function setLang(lang) {
      const safe = lang === 'en' ? 'en' : 'fr';
      document.documentElement.lang = safe;
      try { localStorage.setItem(LS_LANG_KEY, safe); } catch (e) {}
      applyTranslations(safe);
      if (langSelect) langSelect.value = safe;
      refreshFileStatus();
    }

    (function initLang() {
      let initial = 'fr';
      try {
        const saved = localStorage.getItem(LS_LANG_KEY);
        if (saved === 'en' || saved === 'fr') {
          initial = saved;
        } else {
          initial = document.documentElement.lang === 'en' ? 'en' : 'fr';
          localStorage.setItem(LS_LANG_KEY, initial);
        }
      } catch (e) {
        initial = document.documentElement.lang === 'en' ? 'en' : 'fr';
      }
      setLang(initial);
    })();

    langToggle.addEventListener('click', () => {
      setLang(getLang() === 'fr' ? 'en' : 'fr');
    });

    langSelect.addEventListener('change', (e) => {
      setLang(e.target.value);
    });

    function setHUD() {
      hudLabel.textContent = pdfDoc ? `${currentPageNum} / ${totalPages}` : '—';
    }

    async function goFullscreen() {
      if (!document.fullscreenElement) {
        try { await document.documentElement.requestFullscreen(); } catch (_) {}
      }
    }

    function enterPlayingUI() {
      document.body.classList.add('playing');
      if (gameOptions) {
        gameOptions.style.display = 'none';
        gameOptions.setAttribute('aria-hidden', 'true');
      }
    }

    function exitPlayingUI() {
      document.body.classList.remove('playing');
      if (gameOptions) {
        gameOptions.style.display = 'flex';
        gameOptions.setAttribute('aria-hidden', 'false');
      }
      speakingAllowed = false;
      started = false;
      stopSpeak();
    }

    function setOcrProgress(p) {
      ocrBar.style.width = Math.max(0, Math.min(100, Math.round(p * 100))) + '%';
    }

    function speak(text) {
      if (!speakingAllowed || !text || !('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      const lang = ocrLangSel.value;
      if (lang.includes('fra')) utter.lang = 'fr-CA';
      else if (lang.includes('spa')) utter.lang = 'es-ES';
      else if (lang.includes('deu')) utter.lang = 'de-DE';
      else utter.lang = 'en-US';
      window.speechSynthesis.speak(utter);
    }

    function stopSpeak() {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    }

    function applyPlayMode(mode) {
      playMode = mode === 'tts-step' ? 'tts-step' : 'direct';
      if (autoRead) {
        if (playMode === 'tts-step') {
          autoRead.checked = false;
          autoRead.disabled = true;
          autoRead.closest('label')?.classList.add('disabled-option');
        } else {
          autoRead.disabled = false;
          autoRead.closest('label')?.classList.remove('disabled-option');
        }
      }
    }

    applyPlayMode(modeSelect.value);

    modeSelect.addEventListener('change', (e) => {
      applyPlayMode(e.target.value);
    });

    chooseBtn.addEventListener('click', () => fileInput.click());

    ;['dragenter','dragover'].forEach(ev => {
      window.addEventListener(ev, e => { e.preventDefault(); }, { passive: false });
    });

    window.addEventListener('drop', async e => {
      e.preventDefault();
      const file = [...(e.dataTransfer?.files || [])].find(f => f.type === 'application/pdf' || f.name?.toLowerCase().endsWith('.pdf'));
      if (file) {
        await loadPDFFile(file);
      }
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      await loadPDFFile(file);
      fileInput.value = '';
    });

    async function loadPDFFile(file) {
      try {
        const arrBuf = await file.arrayBuffer();
        pdfData = new Uint8Array(arrBuf);
        selectedFileName = file.name || '';
        refreshFileStatus();
        startButton.disabled = false;
      } catch (err) {
        console.error('File load error', err);
        const lang = getLang();
        alert(lang === 'fr' ? 'Impossible de charger ce fichier.' : 'Unable to load this file.');
      }
    }

    startButton.addEventListener('click', async () => {
      if (!pdfData) return;
      await goFullscreen();
      started = true;
      speakingAllowed = true;
      enterPlayingUI();
      await openAndRender();
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        exitPlayingUI();
        if (document.fullscreenElement) {
          try { document.exitFullscreen(); } catch (_) {}
        }
      }
    });

    async function openAndRender() {
      try {
        const pdfjs = window.__PDFJS__ || window.pdfjsLib;
        if (!pdfjs) throw new Error('pdf.js library not available on window.');
        const loadingTask = pdfjs.getDocument({ data: pdfData });
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        currentPageNum = 1;
        await renderPage(currentPageNum);
        setHUD();
      } catch (err) {
        console.error('PDF load error:', err);
        const lang = getLang();
        alert((lang === 'fr' ? 'Erreur de chargement du PDF: ' : 'PDF load error: ') + (err?.message || err?.toString() || ''));
      }
    }

    function getZoneRectPixels() {
      const W = canvas.width, H = canvas.height;
      const w = Math.round((ZONE_W_PCT / 100) * W);
      const h = Math.round((ZONE_H_PCT / 100) * H);
      const cx = Math.round((ZONE_CENTER_X_PCT / 100) * W);
      const cy = Math.round((ZONE_CENTER_Y_PCT / 100) * H);
      const x = Math.max(0, Math.min(W - 1, cx - Math.floor(w / 2)));
      const y = Math.max(0, Math.min(H - 1, cy - Math.floor(h / 2)));
      return { x, y, w: Math.max(1, Math.min(W - x, w)), h: Math.max(1, Math.min(H - y, h)) };
    }

    function cropCanvas(srcCanvas, rect) {
      const c = document.createElement('canvas');
      c.width = rect.w;
      c.height = rect.h;
      const cx = c.getContext('2d');
      cx.drawImage(srcCanvas, rect.x, rect.y, rect.w, rect.h, 0, 0, rect.w, rect.h);
      return c;
    }

    function reflowOcrText(raw) {
      if (!raw) return '';
      let s = raw;
      s = s.replace(/[\u200B-\u200D\u2060\uFEFF]/g, '');
      s = s.replace(/\u00AD/g, '');
      s = s.replace(/\r\n/g, '\n');
      s = s.replace(/([A-Za-zÀ-ÖØ-öø-ÿ])-\s*\n\s*([A-Za-zÀ-ÖØ-öø-ÿ])/g, '$1$2');
      s = s.replace(/\n{2,}/g, '¶¶');
      s = s.replace(/([^\n])\n(?!\n)/g, (m, prev) => {
        return /[.!?;:)"'»\]]\s*$/.test(prev) ? prev + '\n' : prev + ' ';
      });
      s = s.replace(/¶¶/g, '\n\n');
      s = s.replace(/[ \t]+/g, ' ').replace(/ +\n/g, '\n').trim();
      return s;
    }

    async function renderPage(pageNum) {
      if (!pdfDoc || loading) return;
      loading = true;
      const myToken = ++currentRenderToken;

      try {
        const page = await pdfDoc.getPage(pageNum);
        const viewportUnscaled = page.getViewport({ scale: 1 });
        const availW = window.innerWidth;
        const availH = window.innerHeight;
        const scale = Math.min(availW / viewportUnscaled.width, availH / viewportUnscaled.height);
        const viewport = page.getViewport({ scale: scale * (window.devicePixelRatio || 1) });

        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        canvas.style.width = Math.floor(viewport.width / (window.devicePixelRatio || 1)) + 'px';
        canvas.style.height = Math.floor(viewport.height / (window.devicePixelRatio || 1)) + 'px';

        await page.render({ canvasContext: ctx, viewport }).promise;

        const rect = getZoneRectPixels();
        const region = cropCanvas(canvas, rect);

        setOcrProgress(0);
        ocrStatus.textContent = 'OCR…';

        const lang = ocrLangSel.value || 'eng';
        const { data: { text } } = await Tesseract.recognize(
          region,
          lang,
          { logger: m => { if (m && typeof m.progress === 'number') { setOcrProgress(m.progress); } } }
        );

        if (myToken !== currentRenderToken) return;

        const cleaned = reflowOcrText(text || '');
        textOut.textContent = cleaned;
        textForSpeech = cleaned;
        setOcrProgress(1);

        if (playMode === 'tts-step') {
          hasSpokenForPage = !(cleaned && cleaned.trim().length);
          stopSpeak();
        } else {
          hasSpokenForPage = true;
          if (autoRead.checked && cleaned) {
            stopSpeak();
            speak(cleaned);
          } else {
            stopSpeak();
          }
        }

        ocrStatus.textContent = cleaned ? (cleaned.slice(0, 80) + (cleaned.length > 80 ? '…' : '')) : '—';
      } catch (err) {
        console.error('Render/OCR error:', err);
        ocrStatus.textContent = '⚠️';
      } finally {
        loading = false;
      }
    }

    async function goToRelativePage(delta) {
      if (!started || !pdfDoc || loading) return;
      currentPageNum = ((currentPageNum - 1 + delta + totalPages) % totalPages) + 1;
      await renderPage(currentPageNum);
      setHUD();
    }

    async function handlePrimaryAdvance() {
      if (!started || !pdfDoc || loading) return;
      if (playMode === 'tts-step' && !hasSpokenForPage) {
        if (textForSpeech && textForSpeech.trim().length) {
          stopSpeak();
          speak(textForSpeech);
          hasSpokenForPage = true;
          return;
        }
        hasSpokenForPage = true;
      }
      stopSpeak();
      await goToRelativePage(1);
    }

    stage.addEventListener('click', async () => {
      await handlePrimaryAdvance();
    });

    window.addEventListener('keydown', async (e) => {
      if (!started || !pdfDoc || loading) return;
      if (e.code === 'Space' || e.code === 'Enter' || e.code === 'ArrowRight') {
        e.preventDefault();
        await handlePrimaryAdvance();
      } else if (e.code === 'ArrowLeft' || (e.code === 'Space' && e.shiftKey)) {
        e.preventDefault();
        stopSpeak();
        await goToRelativePage(-1);
      }
    }, { passive: false });

    window.addEventListener('resize', () => {
      if (!started || !pdfDoc) return;
      clearTimeout(window.__resizeT);
      window.__resizeT = setTimeout(() => renderPage(currentPageNum), 100);
    });

    let hideTimer = null;
    function scheduleCursorHide() {
      document.body.style.cursor = 'default';
      clearTimeout(hideTimer);
      hideTimer = setTimeout(() => { document.body.style.cursor = 'none'; }, 1500);
    }
    ['mousemove', 'mousedown', 'touchstart', 'keydown'].forEach(ev => {
      window.addEventListener(ev, scheduleCursorHide, { passive: true });
    });
    scheduleCursorHide();

    ocrLangSel.addEventListener('change', () => {
      if (!started || !pdfDoc) return;
      renderPage(currentPageNum);
    });
  </script>
</body>
</html>
