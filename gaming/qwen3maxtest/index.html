<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title class="translate"
          data-fr="Explosion Sensorielle"
          data-en="Sensory Explosion">Explosion Sensorielle</title>

  <link rel="stylesheet" href="../../css/games.css">
  <link rel="stylesheet" href="../../css/choiceeyegaze.css">

  <style>
    body.light { background-color: #fff; color: #000; }
    body.dark  { background-color: #000; color: #fff; }

    #langToggle {
      position: fixed;
      top: 10px; right: 10px;
      z-index: 99999;
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 10px; border: 2px solid #009688;
      background: #fff; color: #009688; font-weight: 700; cursor: pointer;
      user-select: none;
    }
    body.dark #langToggle { background:#111; color:#14b8a6; border-color:#14b8a6; }

    .game-container {
      width: 100%;
      max-width: 100vw;
      height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 10px;
      box-sizing: border-box;
    }
    
    #chargingIndicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 200px;
      height: 200px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: transform 0.1s ease, opacity 0.1s ease;
    }
    
    #chargingIndicator.charging {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    
    #chargingFill {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(transparent 0deg, rgba(255, 255, 255, 0.8) 360deg);
      clip-path: inset(0 0 0 0);
      transform: rotate(-90deg);
    }
  </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-B45TJG4GBJ');
</script>
</head>
<body>

<button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

<div id="game-options" class="modal">
  <div id="options-title-bar">
    <h2 id="options-main-title" class="translate"
        data-fr="Explosion Sensorielle"
        data-en="Sensory Explosion">Explosion Sensorielle</h2>
  </div>

  <div id="control-panel-options">
    <div id="mode-divider"></div>

    <div id="options-inline-container">
      <div class="options-column">
        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="muteSFX">
            <span class="translate" data-fr="Désactiver les sons" data-en="Disable sounds">Désactiver les sons</span>
          </label>
        </div>

        <div class="option-item">
          <label for="sfxVol" class="teal-label">
            <span class="translate" data-fr="Volume des sons:" data-en="Sound volume:">Volume des sons:</span>
            <span id="sfxVolVal">50</span>
          </label>
          <input type="range" id="sfxVol" class="styled-slider" min="0" max="100" value="50">
        </div>
      </div>

      <div class="options-column">
        <div class="option-item">
          <label for="colorPalette" class="teal-label label-block translate"
                 data-fr="Palette de couleurs" data-en="Color Palette">Palette de couleurs</label>
          <select id="colorPalette" class="styled-select">
            <option value="calm" selected class="translate" data-fr="Calmes" data-en="Calm">Calmes</option>
            <option value="vibrant" class="translate" data-fr="Vives" data-en="Vibrant">Vives</option>
            <option value="rainbow" class="translate" data-fr="Arc-en-ciel" data-en="Rainbow">Arc-en-ciel</option>
            <option value="neon" class="translate" data-fr="Néon" data-en="Neon">Néon</option>
          </select>
        </div>
      </div>

      <div class="options-column">
        <div class="option-item">
          <label for="particleCount" class="teal-label">
            <span class="translate" data-fr="Taille de l'explosion:" data-en="Explosion size:">Taille de l'explosion:</span>
            <span id="particleCountVal">25</span>
          </label>
          <input type="range" id="particleCount" class="styled-slider" min="5" max="50" value="25">
        </div>
        
        <div class="option-item">
          <label for="dwellTimeSlider" class="teal-label">
            <span class="translate" data-fr="Temps de fixation:" data-en="Dwell time:">Temps de fixation:</span>
            <span id="dwellTimeVal">1500</span> ms
          </label>
          <input type="range" id="dwellTimeSlider" class="styled-slider" min="500" max="5000" step="100" value="1500">
        </div>
      </div>
    </div>

    <div id="mode-divider"></div>
    <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start">Commencer</button>
  </div>
</div>

<!-- Charging indicator element -->
<div id="chargingIndicator">
  <div id="chargingFill"></div>
</div>

<!-- p5.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>

<script src="../../js/eyegaze-menu.js"></script>
<script src="../../js/translationmain.js"></script>

<script>
/* =========================
   Language — storage as source of truth
   ========================= */
const LS_LANG_KEY = 'siteLanguage'; // shared site-wide language key
const langToggle  = document.getElementById('langToggle');

function getLang(){
  try {
    const saved = localStorage.getItem(LS_LANG_KEY);
    if (saved === 'en' || saved === 'fr') return saved;
  } catch(e){}
  return (document.documentElement.lang === 'en') ? 'en' : 'fr';
}

function setLang(lang){
  const safe = (lang === 'en') ? 'en' : 'fr';
  document.documentElement.lang = safe;
  try { localStorage.setItem(LS_LANG_KEY, safe); } catch(e){}
  document.querySelectorAll('.translate').forEach(el=>{
    const fr = el.getAttribute('data-fr');
    const en = el.getAttribute('data-en');
    if (safe === 'fr' && fr != null) el.textContent = fr;
    if (safe === 'en' && en != null) el.textContent = en;
  });
}

/* Normalize DOM & storage once on load */
(function normalizeLangOnLoad(){
  let initial = 'fr';
  try {
    const saved = localStorage.getItem(LS_LANG_KEY);
    if (saved === 'en' || saved === 'fr') {
      initial = saved;
    } else {
      initial = (document.documentElement.lang === 'en') ? 'en' : 'fr';
      localStorage.setItem(LS_LANG_KEY, initial);
    }
  } catch(e){
    initial = (document.documentElement.lang === 'en') ? 'en' : 'fr';
  }
  setLang(initial);
})();

langToggle.addEventListener('click', ()=>{
  setLang(getLang()==='fr' ? 'en' : 'fr');
  choosePreferredVoice();
});

/* =========================
   Controls & UI bindings
   ========================= */
const muteSFX      = document.getElementById('muteSFX');
const sfxVol       = document.getElementById('sfxVol');
const sfxVolVal    = document.getElementById('sfxVolVal');
const dwellSlider  = document.getElementById('dwellTimeSlider');
const dwellTimeVal = document.getElementById('dwellTimeVal');
const startButton  = document.getElementById('startButton');
const colorPalette = document.getElementById('colorPalette');
const particleCount = document.getElementById('particleCount');
const particleCountVal = document.getElementById('particleCountVal');

/* Safe binder */
const bind = (el, type, handler, opts) => { if (el) el.addEventListener(type, handler, opts || false); };

bind(sfxVol, 'input', () => sfxVolVal.textContent = sfxVol.value);
bind(particleCount, 'input', () => {
  particleCountVal.textContent = particleCount.value;
});

/* Sync eyegaze settings if present */
function syncEyegazeSettingsFromUI() {
  try {
    if (window.eyegazeSettings) {
      eyegazeSettings.sfxMuted  = !!muteSFX.checked;
      eyegazeSettings.sfxVolume = parseInt(sfxVol.value, 10) || 50;
      eyegazeSettings.dwellTime = parseInt(dwellSlider.value, 10) || 1500;
    }
  } catch(e) {}
}

/* =========================
   Game state
   ========================= */
let isGameActive = false;
let p5Sketch = null;
let currentColorPalette = 'calm';
let currentParticleCount = 25;
let isCharging = false;
let chargeStartTime = 0;
let chargeTimeout = null;
const CHARGE_DURATION = 1000; // 1 second to fully charge

/* =========================
   Charging functionality
   ========================= */
const chargingIndicator = document.getElementById('chargingIndicator');
const chargingFill = document.getElementById('chargingFill');

function startCharging() {
  if (!isGameActive || isCharging) return;
  
  isCharging = true;
  chargeStartTime = Date.now();
  chargingIndicator.classList.add('charging');
  
  // Update charging fill continuously
  updateChargingFill();
  
  // Auto-release after full charge
  chargeTimeout = setTimeout(() => {
    releaseCharge();
  }, CHARGE_DURATION);
}

function updateChargingFill() {
  if (!isCharging) return;
  
  const elapsed = Date.now() - chargeStartTime;
  const progress = Math.min(elapsed / CHARGE_DURATION, 1);
  const degrees = progress * 360;
  
  // Update the conic gradient
  chargingFill.style.background = `conic-gradient(transparent 0deg, rgba(255, 255, 255, 0.8) ${degrees}deg, transparent ${degrees}deg)`;
  
  if (isCharging) {
    requestAnimationFrame(updateChargingFill);
  }
}

function releaseCharge() {
  if (!isCharging) return;
  
  isCharging = false;
  clearTimeout(chargeTimeout);
  
  // Hide charging indicator
  chargingIndicator.classList.remove('charging');
  
  // Trigger explosion at center
  if (typeof triggerEffect === 'function') {
    triggerEffect(window.innerWidth/2, window.innerHeight/2);
  }
}

function cancelCharge() {
  if (!isCharging) return;
  
  isCharging = false;
  clearTimeout(chargeTimeout);
  chargingIndicator.classList.remove('charging');
}

/* =========================
   Startup
   ========================= */
function startGame() {
  // Request fullscreen
  const root = document.documentElement;
  (root.requestFullscreen||root.webkitRequestFullscreen||root.msRequestFullscreen||function(){}).call(root);

  // Hide the language toggle button
  langToggle.style.display = 'none';

  // Hide the entire menu
  document.getElementById('game-options').style.display = 'none';

  // Sync options
  syncEyegazeSettingsFromUI();
  
  // Get current settings
  currentColorPalette = colorPalette.value;
  currentParticleCount = parseInt(particleCount.value) || 25;

  // Initialize p5.js sketch
  initP5Sketch();
  
  isGameActive = true;
}
startButton.addEventListener('click', startGame);

/* =========================
   TTS helpers (language-aware)
   ========================= */
let preferredVoice = null;

function choosePreferredVoice() {
  const ss = window.speechSynthesis;
  if (!ss || !ss.getVoices) return;
  const voices = ss.getVoices() || [];
  if (!voices.length) return;

  const lang = getLang();
  const by = (fn) => voices.find(fn);
  if (lang === 'fr') {
    preferredVoice =
      by(v => /sylvie/i.test(v.name || '') && /^fr[-_]?CA/i.test(v.lang || '')) ||
      by(v => /^fr[-_]?CA/i.test(v.lang || '')) ||
      by(v => /^fr[-_]?FR/i.test(v.lang || '')) ||
      by(v => (v.lang || '').toLowerCase().startsWith('fr')) ||
      voices[0];
  } else {
    preferredVoice =
      by(v => /^en[-_]?CA/i.test(v.lang || '')) ||
      by(v => /^en[-_]?US/i.test(v.lang || '')) ||
      by(v => /^en[-_]?GB/i.test(v.lang || '')) ||
      by(v => (v.lang || '').toLowerCase().startsWith('en')) ||
      voices[0];
  }
}

if ('speechSynthesis' in window) {
  speechSynthesis.addEventListener('voiceschanged', choosePreferredVoice);
  choosePreferredVoice();
}
</script>

<script>
// Global variables for p5.js sketch
let particles = [];
let mode = 'calm'; // 'calm', 'vibrant', 'rainbow', or 'neon'
const MAX_PARTICLES = 300;

// Enhanced Particle class with better visuals
class Particle {
  constructor(x, y, p5Instance) {
    this.p = p5Instance;
    this.x = x;
    this.y = y;
    this.size = this.p.random(10, 60);
    this.speedX = this.p.random(-8, 8);
    this.speedY = this.p.random(-8, -2); // Mostly upward
    this.color = this.getColor();
    this.life = 255;
    this.gravity = 0.1;
    this.rotation = this.p.random(this.p.TWO_PI); // Fixed: using p.TWO_PI
    this.rotationSpeed = this.p.random(-0.05, 0.05);
    this.scale = 1;
    this.scaleDirection = 1;
    this.scaleAmount = this.p.random(0.01, 0.05);
  }

  getColor() {
    if (mode === 'calm') {
      // Soft blues, purples, teals
      const hues = [180, 220, 260, 300];
      const h = this.p.random(hues);
      return this.p.color(h, 70, 90, this.life);
    } else if (mode === 'vibrant') {
      // Vibrant colors
      return this.p.color(this.p.random(360), 90, 95, this.life);
    } else if (mode === 'rainbow') {
      // Rainbow
      return this.p.color(this.p.random(360), 100, 100, this.life);
    } else if (mode === 'neon') {
      // Neon colors
      const neonHues = [60, 120, 180, 240, 300, 360];
      const h = this.p.random(neonHues);
      return this.p.color(h, 100, 100, this.life);
    }
  }

  update() {
    this.x += this.speedX;
    this.y += this.speedY;
    this.speedY += this.gravity;
    this.life -= 2;
    this.color.setAlpha(this.life);
    
    // Add rotation
    this.rotation += this.rotationSpeed;
    
    // Add pulsing effect
    this.scale += this.scaleDirection * this.scaleAmount;
    if (this.scale > 1.5 || this.scale < 0.5) {
      this.scaleDirection *= -1;
    }
  }

  draw() {
    this.p.push();
    this.p.translate(this.x, this.y);
    this.p.rotate(this.rotation);
    this.p.scale(this.scale);
    this.p.noStroke();
    this.p.fill(this.color);
    this.p.ellipse(0, 0, this.size);
    this.p.pop();
  }

  isDead() {
    return this.life <= 0;
  }
}

// Initialize p5.js sketch
function initP5Sketch() {
  // Remove any existing canvas
  const existingCanvas = document.querySelector('canvas');
  if (existingCanvas) existingCanvas.remove();
  
  // Create p5 instance
  p5Sketch = new p5((p) => {
    // p5 setup
    p.setup = () => {
      p.createCanvas(p.windowWidth, p.windowHeight);
      p.colorMode(p.HSB, 360, 100, 100, 255);
      
      // Set initial mode based on settings
      mode = currentColorPalette;
    };

    // p5 draw loop
    p.draw = () => {
      // Gentle fade effect (like smoke)
      p.background(0, 0, 0, 15);
      
      // Update and draw particles
      for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].draw();
        
        if (particles[i].isDead()) {
          particles.splice(i, 1);
        }
      }
    };

    // Window resize
    p.windowResized = () => {
      p.resizeCanvas(p.windowWidth, p.windowHeight);
    };

    // Trigger effect (called by switch press)
    window.triggerEffect = (x = p.width/2, y = p.height/2) => {
      // Limit total particles to prevent lag
      if (particles.length > MAX_PARTICLES) return;
      
      // Create burst of particles
      const count = currentParticleCount;
      for (let i = 0; i < count; i++) {
        particles.push(new Particle(x, y, p));
      }
    };
  });
  
  // Set up keyboard events for charging
  let isSpacePressed = false;
  
  document.addEventListener('keydown', (e) => {
    if (!isGameActive) return;
    
    if (e.code === 'Space' && !isSpacePressed) {
      e.preventDefault();
      isSpacePressed = true;
      startCharging();
    }
  });
  
  document.addEventListener('keyup', (e) => {
    if (!isGameActive) return;
    
    if (e.code === 'Space' && isSpacePressed) {
      e.preventDefault();
      isSpacePressed = false;
      if (isCharging) {
        releaseCharge();
      }
    }
  });
  
  // Mouse/touch events (immediate explosion, no charging)
  document.addEventListener('click', (e) => {
    if (isGameActive) {
      // Cancel any ongoing charge
      cancelCharge();
      triggerEffect(e.clientX, e.clientY);
    }
  });
  
  // Update settings when changed
  colorPalette.addEventListener('change', () => {
    currentColorPalette = colorPalette.value;
    mode = currentColorPalette;
  });
  
  particleCount.addEventListener('input', () => {
    currentParticleCount = parseInt(particleCount.value) || 25;
  });
}
</script>

    <script src="../../js/home-button.js" defer></script>
</body>
</html>