<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title data-fr="Parade des lettres" data-en="Animal Parade">Parade des lettres</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root {
      --accent: #f97316;
      --accent-dark: #c2410c;
      --parade-shadow: rgba(249,115,22,0.35);
    }

    body {
      margin: 0;
      font-family: "Poppins", "Segoe UI", sans-serif;
      background: url("../../images/firefly.png") center/cover fixed #0b1020;
      color: #fef3c7;
      min-height: 100vh;
    }

    body.light { background-color:#fdf6e3; color:#1f2937; }
    body.dark  { background-color:#0b1020; color:#fef3c7; }

    #langToggle {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 9999;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 700;
      letter-spacing: .05em;
      background: rgba(15,23,42,.8);
      color: #fef3c7;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,.35);
    }
    body.light #langToggle {
      background: rgba(255,255,255,.9);
      color: #c2410c;
      box-shadow: 0 10px 30px rgba(249,115,22,.35);
    }

    .hide-native-cursor, .hide-native-cursor * { cursor: none !important; }

    #gazePointer {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--gp-size, 42px);
      height: var(--gp-size, 42px);
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10000;
      opacity: 0;
    }
    #gazePointer::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(249,115,22,.85);
      border: 3px solid rgba(255,255,255,.75);
      box-shadow: 0 0 12px rgba(249,115,22,.75);
    }
    #gazePointer.gp-dwell::before {
      animation: gpPulse 700ms ease-in-out infinite alternate;
    }
    @keyframes gpPulse {
      from { transform: scale(1); opacity: .75; }
      to   { transform: scale(1.12); opacity: 1; }
    }
    @media (prefers-reduced-motion: reduce) {
      #gazePointer.gp-dwell::before { animation: none; }
    }

    .options-panel {
      position: relative;
      width: min(520px, 92vw);
      margin: 40px auto;
      background: rgba(15,23,42,.85);
      border-radius: 18px;
      padding: 22px 24px;
      box-shadow: 0 25px 60px rgba(8,15,35,.55);
      border: 2px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      color: inherit;
    }
    body.light .options-panel {
      background: rgba(255,255,255,.9);
      border-color: rgba(249,115,22,.35);
      box-shadow: 0 18px 48px rgba(249,115,22,.28);
    }

    .options-panel h1 {
      margin: 0 0 12px;
      font-size: clamp(1.6rem, 2.8vw, 2.2rem);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin: 20px 0;
    }
    .options-grid label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: .95rem;
    }

    .options-grid input[type="text"],
    .options-grid input[type="number"],
    .options-grid select,
    .options-grid input[type="range"] {
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,.25);
      padding: 8px 10px;
      background: rgba(0,0,0,.25);
      color: inherit;
    }
    body.light .options-grid input,
    body.light .options-grid select {
      background: rgba(255,255,255,.92);
      border-color: rgba(249,115,22,.5);
      color: #1f2937;
    }

    .options-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
      align-items: center;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #fff7ed;
      box-shadow: 0 12px 30px rgba(249,115,22,.35);
    }

    .game-container {
      display: none;
      width: min(1080px, 96vw);
      margin: 0 auto 40px;
      padding: 18px 24px 40px;
      border-radius: 26px;
      backdrop-filter: blur(6px);
      background: rgba(15,23,42,.72);
      border: 2px solid rgba(255,255,255,.06);
      box-shadow: 0 26px 70px rgba(8,15,35,.65);
    }
    body.light .game-container {
      background: rgba(255,255,255,.92);
      border-color: rgba(249,115,22,.28);
      box-shadow: 0 28px 72px rgba(249,115,22,.22);
    }

    .top-strip {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 18px;
      padding: 12px 18px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,.12);
      background: rgba(15,23,42,.6);
      box-shadow: 0 14px 40px rgba(8,15,35,.45);
      margin-bottom: 22px;
    }
    body.light .top-strip {
      background: rgba(255,255,255,.95);
      border-color: rgba(249,115,22,.4);
      box-shadow: 0 16px 40px rgba(249,115,22,.25);
    }

    .prompt-visual {
      position: relative;
      width: clamp(90px, 15vw, 140px);
      aspect-ratio: 1;
      border-radius: 20px;
      overflow: hidden;
      background: rgba(15,23,42,.55);
      border: 2px solid rgba(255,255,255,.18);
      display: grid;
      place-items: center;
    }
    .prompt-visual img {
      width: 86%;
      height: 86%;
      object-fit: contain;
      transition: transform 320ms ease, filter 320ms ease;
    }
    .prompt-visual.launch img { transform: scale(1.08); filter: drop-shadow(0 14px 18px rgba(249,115,22,.45)); }

    .prompt-text h2 {
      margin: 0;
      font-size: clamp(1.4rem, 2.6vw, 2.1rem);
      font-weight: 700;
      letter-spacing: .04em;
    }
    .prompt-text span {
      display: block;
      margin-top: 4px;
      font-size: clamp(.95rem, 1.8vw, 1.1rem);
      opacity: .85;
    }

    .progress-chip {
      min-width: 120px;
      justify-self: end;
      background: rgba(249,115,22,.15);
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 600;
      border: 2px solid rgba(249,115,22,.45);
      text-align: center;
      color: inherit;
    }
    body.light .progress-chip {
      background: rgba(249,115,22,.12);
      border-color: rgba(249,115,22,.55);
      color: #7c2d12;
    }

    .grid-outer {
      display: flex;
      justify-content: center;
    }

    .letter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(80px, 1fr));
      gap: clamp(12px, 3vw, 22px);
      width: 100%;
    }

    .letter-cell {
      position: relative;
      border-radius: 20px;
      padding: clamp(12px, 3vw, 20px);
      display: grid;
      place-items: center;
      font-size: clamp(2rem, 6vw, 3.6rem);
      font-weight: 800;
      background: rgba(15,23,42,.65);
      border: 2px solid rgba(255,255,255,.18);
      color: #fde68a;
      text-shadow: 0 6px 18px rgba(0,0,0,.35);
      overflow: hidden;
      cursor: pointer;
      transition: transform 240ms ease, box-shadow 240ms ease, background 240ms ease;
    }
    body.light .letter-cell {
      background: rgba(255,255,255,.88);
      color: #c2410c;
      border-color: rgba(249,115,22,.35);
      text-shadow: none;
    }

    .letter-cell figure {
      margin: 0;
      display: grid;
      place-items: center;
      position: absolute;
      inset: 0;
      opacity: .22;
      pointer-events: none;
    }
    .letter-cell figure img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.2) brightness(1.05);
    }
    .letter-cell .badge {
      position: relative;
      z-index: 2;
    }

    .letter-cell.correct {
      background: linear-gradient(135deg, rgba(249,115,22,.9), rgba(251,191,36,.85));
      color: #1f2937;
      box-shadow: 0 18px 40px rgba(249,115,22,.45);
    }

    .letter-cell.wrong {
      box-shadow: 0 0 0 3px rgba(220,38,38,.65);
    }

    .dwell-fill {
      position: absolute;
      inset: 6px;
      border-radius: 16px;
      background: rgba(249,115,22,.35);
      transform-origin: center;
      width: 0;
      height: 0;
    }

    .hidden { display: none !important; }

    @media (max-width: 640px) {
      .top-strip { grid-template-columns: 1fr; text-align: center; }
      .progress-chip { justify-self: center; }
    }
  </style>
</head>
<body class="dark">
  <button id="langToggle" class="translate" data-fr="EN" data-en="FR">EN</button>

  <section id="gameOptions" class="options-panel">
    <h1 data-fr="Festival Animal des Lettres" data-en="Animal Parade Festival">Festival Animal des Lettres</h1>
    <p data-fr="Invitez vos élèves à faire défiler les lettres en compagnie d'animaux lumineux."
       data-en="Invite students to parade letters alongside glowing forest friends.">
      Invitez vos élèves à faire défiler les lettres en compagnie d'animaux lumineux.
    </p>

    <div class="options-grid">
      <label>
        <span data-fr="Nombre de lettres dans la grille" data-en="Letters per grid">Nombre de lettres dans la grille</span>
        <select id="gridSize" class="compact-field">
          <option value="6">6</option>
          <option value="8">8</option>
          <option value="9" selected>9</option>
          <option value="12">12</option>
        </select>
      </label>
      <label>
        <span data-fr="Temps de fixation (ms)" data-en="Dwell time (ms)">Temps de fixation (ms)</span>
        <input type="range" id="dwellTimeSlider" min="700" max="2200" step="100" value="1500" />
        <small><span id="dwellTimeVal">1500</span> ms</small>
      </label>
      <label>
        <span data-fr="Volume des effets" data-en="Effects volume">Volume des effets</span>
        <input type="range" id="sfxVol" min="0" max="100" value="60" />
        <small><span id="sfxVolVal">60</span>%</small>
      </label>
      <label>
        <span data-fr="Activer la voix" data-en="Enable voice">Activer la voix</span>
        <input type="checkbox" id="ttsEnabled" checked />
      </label>
      <label>
        <span data-fr="Couper les sons" data-en="Mute sounds">Couper les sons</span>
        <input type="checkbox" id="muteSFX" />
      </label>
      <label>
        <span data-fr="Afficher le pointeur" data-en="Show gaze pointer">Afficher le pointeur</span>
        <input type="checkbox" id="showGazePointer" checked />
      </label>
    </div>

    <div class="options-actions">
      <button class="btn-primary" id="startBtn" data-fr="Commencer" data-en="Start">Commencer</button>
    </div>
  </section>

  <section class="game-container" id="gameContainer">
    <div class="top-strip">
      <div class="prompt-visual" id="promptVisual">
        <img id="animalImage" src="" alt="Animal" />
      </div>
      <div class="prompt-text">
        <h2 id="promptLine">Trouve la lettre</h2>
        <span id="promptHint">Un ami scintillant rejoint la parade.</span>
      </div>
      <div class="progress-chip" id="progressChip">0 / 10</div>
    </div>

    <div class="grid-outer">
      <div class="letter-grid" id="letterGrid"></div>
    </div>
  </section>

  <div id="gazePointer"></div>

  <script src="../../js/eyegaze-menu.js"></script>
  <script>
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const spriteFamilies = [
      { animalFr: "Ourson", animalEn: "Bear", prefix: "bear", variants: 5 },
      { animalFr: "Renard", animalEn: "Fox", prefix: "fox", variants: 5 },
      { animalFr: "Hibou", animalEn: "Owl", prefix: "owl", variants: 5 },
      { animalFr: "Raton laveur", animalEn: "Raccoon", prefix: "racoon", variants: 5 }
    ];
    const descriptorsFr = [
      "qui danse", "qui chante", "magique", "scintillant", "musicien", "acrobatique"
    ];
    const descriptorsEn = [
      "dancing", "singing", "magical", "sparkling", "musical", "acrobatic"
    ];
    const appearSounds = [
      "../../sounds/cartoon/cartoonappear1.mp3",
      "../../sounds/cartoon/cartoonappear2.mp3",
      "../../sounds/cartoon/cartoonappear3.mp3",
      "../../sounds/cartoon/cartoonappear4.mp3",
      "../../sounds/cartoon/cartoonappear5.mp3"
    ];

    const letterAnimals = {};
    letters.forEach((letter, index) => {
      const family = spriteFamilies[index % spriteFamilies.length];
      const variant = (index % family.variants) + 1;
      const descIndex = index % descriptorsFr.length;
      const sound = appearSounds[index % appearSounds.length];
      letterAnimals[letter] = {
        img: `../../images/sprites/${family.prefix}${variant}.png`,
        sfx: sound,
        animalFr: family.animalFr,
        animalEn: family.animalEn,
        descriptorFr: descriptorsFr[descIndex],
        descriptorEn: descriptorsEn[descIndex]
      };
    });

    const promptLine = document.getElementById('promptLine');
    const promptHint = document.getElementById('promptHint');
    const animalImage = document.getElementById('animalImage');
    const promptVisual = document.getElementById('promptVisual');
    const progressChip = document.getElementById('progressChip');
    const letterGrid = document.getElementById('letterGrid');
    const startBtn = document.getElementById('startBtn');
    const gameOptions = document.getElementById('gameOptions');
    const gameContainer = document.getElementById('gameContainer');
    const gridSizeSelect = document.getElementById('gridSize');
    const dwellSlider = document.getElementById('dwellTimeSlider');
    const dwellVal = document.getElementById('dwellTimeVal');
    const sfxSlider = document.getElementById('sfxVol');
    const sfxVal = document.getElementById('sfxVolVal');
    const muteSFX = document.getElementById('muteSFX');
    const ttsEnabled = document.getElementById('ttsEnabled');
    const showGazePointer = document.getElementById('showGazePointer');
    const langToggle = document.getElementById('langToggle');
    const gazePointer = document.getElementById('gazePointer');

    let lang = localStorage.getItem('siteLanguage') || 'fr';
    let letterQueue = [];
    let currentIndex = -1;
    let currentLetter = null;
    let rounds = 0;
    let hoverTimeout = null;
    let activeCell = null;
    let currentOverlay = null;
    let isReady = false;
    let bgMusic = null;
    const audioCache = new Map();

    function shuffle(array) {
      const clone = [...array];
      for (let i = clone.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [clone[i], clone[j]] = [clone[j], clone[i]];
      }
      return clone;
    }

    function getDwellTime() {
      return (window.eyegazeSettings?.dwellTime) || parseInt(dwellSlider.value, 10) || 1500;
    }

    function updateLangTexts() {
      const isFr = lang === 'fr';
      document.querySelectorAll('[data-fr]').forEach(el => {
        const fr = el.getAttribute('data-fr');
        const en = el.getAttribute('data-en');
        if (!fr || !en) return;
        el.textContent = isFr ? fr : en;
      });
      langToggle.textContent = isFr ? 'EN' : 'FR';
      document.body.classList.toggle('light', !isFr);
      document.body.classList.toggle('dark', isFr);
      refreshPrompt();
    }

    function playBgMusic() {
      if (bgMusic || muteSFX.checked) return;
      bgMusic = new Audio('../../songs/spring/spring2.mp3');
      bgMusic.loop = true;
      bgMusic.volume = (parseInt(sfxSlider.value, 10) || 60) / 100;
      bgMusic.play().catch(() => {});
    }

    function stopBgMusic() {
      if (bgMusic) {
        bgMusic.pause();
        bgMusic = null;
      }
    }

    function playSfx(src) {
      if (muteSFX.checked) return;
      const vol = (window.eyegazeSettings?.sfxVolume ?? parseInt(sfxSlider.value, 10) ?? 60) / 100;
      let audio = audioCache.get(src);
      if (!audio) {
        audio = new Audio(src);
        audioCache.set(src, audio);
      }
      audio.currentTime = 0;
      audio.volume = vol;
      audio.play().catch(() => {});
    }

    function speak(text) {
      if (!ttsEnabled.checked) return;
      if (!('speechSynthesis' in window)) return;
      try {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang === 'fr' ? 'fr-FR' : 'en-US';
        utterance.rate = 1.0;
        window.speechSynthesis.speak(utterance);
      } catch (e) {}
    }

    function refreshPrompt() {
      if (!currentLetter) return;
      const data = letterAnimals[currentLetter];
      const isFr = lang === 'fr';
      const line = isFr ? `Trouve la lettre ${currentLetter}` : `Find the letter ${currentLetter}`;
      const hint = isFr ? `${data.animalFr} ${data.descriptorFr}` : `${data.animalEn} ${data.descriptorEn}`;
      promptLine.textContent = line;
      promptHint.textContent = hint;
      animalImage.src = data.img;
      animalImage.alt = isFr ? data.animalFr : data.animalEn;
    }

    function updateProgress() {
      const target = letterQueue.length || letters.length;
      progressChip.textContent = `${rounds} / ${target}`;
    }

    function buildLetterQueue() {
      letterQueue = shuffle(letters);
      currentIndex = -1;
      rounds = 0;
      updateProgress();
    }

    function buildGrid(values) {
      letterGrid.innerHTML = '';
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      values.forEach(letter => {
        const cell = document.createElement('div');
        cell.className = 'letter-cell';
        cell.dataset.letter = letter;

        const fig = document.createElement('figure');
        const img = document.createElement('img');
        img.src = letterAnimals[letter].img;
        img.alt = '';
        fig.appendChild(img);
        cell.appendChild(fig);

        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = letter;
        cell.appendChild(badge);

        cell.addEventListener('mouseenter', () => startHover(cell));
        cell.addEventListener('mouseleave', stopHover);
        cell.addEventListener('click', () => handleSelection(cell));
        cell.addEventListener('touchstart', () => startHover(cell));
        cell.addEventListener('touchend', stopHover);

        if (!reduceMotion) {
          cell.style.transform = 'scale(0.92)';
          requestAnimationFrame(() => {
            cell.style.transition = 'transform 280ms ease';
            cell.style.transform = 'scale(1)';
          });
        }

        letterGrid.appendChild(cell);
      });
    }

    function nextRound() {
      if (letterQueue.length === 0) buildLetterQueue();
      currentIndex++;
      if (currentIndex >= letterQueue.length) {
        buildLetterQueue();
        currentIndex = 0;
      }
      currentLetter = letterQueue[currentIndex];
      const lettersNeeded = parseInt(gridSizeSelect.value, 10) || 9;
      const filler = shuffle(letters.filter(l => l !== currentLetter)).slice(0, Math.max(lettersNeeded - 1, 0));
      const pool = shuffle([currentLetter, ...filler]);
      buildGrid(pool);
      refreshPrompt();
      speak(lang === 'fr' ? `Trouve la lettre ${currentLetter}` : `Find the letter ${currentLetter}`);
      isReady = true;
    }

    function startHover(cell) {
      if (!isReady) return;
      if (activeCell === cell) return;
      stopHover();
      activeCell = cell;
      const overlay = document.createElement('div');
      overlay.className = 'dwell-fill';
      cell.appendChild(overlay);
      currentOverlay = overlay;

      const dwellTime = getDwellTime();
      requestAnimationFrame(() => {
        overlay.style.transition = `width ${dwellTime}ms linear, height ${dwellTime}ms linear`;
        overlay.style.width = '100%';
        overlay.style.height = '100%';
      });
      if (gazePointer) gazePointer.classList.add('gp-dwell');

      hoverTimeout = setTimeout(() => {
        handleSelection(cell);
      }, dwellTime);
    }

    function stopHover() {
      clearTimeout(hoverTimeout);
      hoverTimeout = null;
      if (currentOverlay && currentOverlay.parentElement) {
        currentOverlay.parentElement.removeChild(currentOverlay);
      }
      currentOverlay = null;
      activeCell = null;
      if (gazePointer) gazePointer.classList.remove('gp-dwell');
    }

    function wrongFeedback(cell) {
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (reduce || !cell.animate) {
        cell.classList.add('wrong');
        setTimeout(() => cell.classList.remove('wrong'), 300);
        return;
      }
      cell.animate([
        { transform: 'translateX(0)' },
        { transform: 'translateX(-10px)' },
        { transform: 'translateX(8px)' },
        { transform: 'translateX(-6px)' },
        { transform: 'translateX(0)' }
      ], { duration: 340, easing: 'ease-out' });
      const prevShadow = cell.style.boxShadow;
      cell.style.boxShadow = '0 0 0 3px rgba(220,38,38,.6)';
      setTimeout(() => { cell.style.boxShadow = prevShadow || ''; }, 360);
    }

    function celebrate(cell) {
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      cell.classList.add('correct');
      if (!reduce) {
        cell.animate([
          { transform: 'scale(1)' },
          { transform: 'scale(1.08)' },
          { transform: 'scale(1)' }
        ], { duration: 420, easing: 'ease-out' });
        promptVisual.classList.add('launch');
        setTimeout(() => promptVisual.classList.remove('launch'), 420);
      }
      const label = lang === 'fr'
        ? `${letterAnimals[currentLetter].animalFr} ${letterAnimals[currentLetter].descriptorFr}!`
        : `${letterAnimals[currentLetter].animalEn} ${letterAnimals[currentLetter].descriptorEn}!`;
      speak(`${lang === 'fr' ? 'Bravo' : 'Great job'}, ${label}`);
      playSfx(letterAnimals[currentLetter].sfx);
    }

    function handleSelection(cell) {
      if (!isReady || !cell) return;
      stopHover();
      const letter = cell.dataset.letter;
      if (letter !== currentLetter) {
        wrongFeedback(cell);
        playSfx('../../sounds/cartoon/cartoonappear2.mp3');
        return;
      }
      isReady = false;
      celebrate(cell);
      rounds = Math.min(rounds + 1, letters.length);
      updateProgress();
      setTimeout(() => {
        nextRound();
      }, 900);
    }

    function updatePointerVisibility() {
      const visible = showGazePointer.checked;
      if (visible) {
        document.body.classList.add('hide-native-cursor');
        gazePointer.style.opacity = '1';
      } else {
        document.body.classList.remove('hide-native-cursor');
        gazePointer.style.opacity = '0';
      }
    }

    document.addEventListener('pointermove', e => {
      if (!showGazePointer.checked) return;
      gazePointer.style.left = `${e.clientX}px`;
      gazePointer.style.top = `${e.clientY}px`;
    });

    langToggle.addEventListener('click', () => {
      lang = lang === 'fr' ? 'en' : 'fr';
      localStorage.setItem('siteLanguage', lang);
      updateLangTexts();
    });

    startBtn.addEventListener('click', () => {
      playBgMusic();
      buildLetterQueue();
      nextRound();
      gameOptions.classList.add('hidden');
      gameContainer.style.display = 'block';
      updateProgress();
      if (window.eyegazeSettings?.hideOverlay) {
        try { window.eyegazeSettings.hideOverlay(); } catch (e) {}
      }
    });

    dwellSlider.addEventListener('input', e => {
      dwellVal.textContent = e.target.value;
      if (window.eyegazeSettings) {
        window.eyegazeSettings.dwellTime = parseInt(e.target.value, 10);
      }
    });

    sfxSlider.addEventListener('input', e => {
      const val = e.target.value;
      sfxVal.textContent = val;
      if (bgMusic) bgMusic.volume = (parseInt(val, 10) || 60) / 100;
      if (window.eyegazeSettings) window.eyegazeSettings.sfxVolume = parseInt(val, 10);
    });

    muteSFX.addEventListener('change', () => {
      if (muteSFX.checked) stopBgMusic();
      else playBgMusic();
      if (window.eyegazeSettings) window.eyegazeSettings.sfxMuted = muteSFX.checked;
    });

    showGazePointer.addEventListener('change', updatePointerVisibility);

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopBgMusic();
      else if (!muteSFX.checked && gameContainer.style.display === 'block') playBgMusic();
    });

    window.addEventListener('beforeunload', stopBgMusic);

    function init() {
      updateLangTexts();
      updatePointerVisibility();
      dwellVal.textContent = dwellSlider.value;
      sfxVal.textContent = sfxSlider.value;
      if (window.initEyegazeMenu) {
        initEyegazeMenu();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
