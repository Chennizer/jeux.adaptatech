<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chasse aux lettres</title>

  <!-- Shared styles -->
  <link rel="stylesheet" href="../../css/games.css">
  <link rel="stylesheet" href="../../css/choiceeyegaze.css">

  <style>
    /* Page theming applied after Start */
    body.light { background-color: #fff; color: #000; }
    body.dark  { background-color: #000; color: #fff; }
    body.light .letter-cell { background-color: #eee; color: #000; }
    body.dark  .letter-cell { background-color: #222; color: #fff; }

    /* Game container layout */
    .game-container {
      width: 100%;
      max-width: 100vw;
      height: 100%;
      display: none;             /* shown after Start */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    .letter-grid {
      display: none;             /* shown after Start */
      grid-template-columns: repeat(2, 1fr);
      gap: 40px;
      width: 100%;
      height: 100%;
      align-items: center;
      justify-items: center;
    }

    .letter-cell {
      position: relative;        /* needed for dwell-fill positioning */
      width: 200px;
      height: 200px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 6rem;
      cursor: none;              /* hide pointer for eyegaze */
      border: 2px solid rgba(0,0,0,0.15);
      overflow: hidden;          /* clip dwell-fill inside the tile */
    }

    .letter-cell.correct {
      background-color: #2e7d32;
      color: #fff !important;
    }

    /* Prompt styling (two lines: instruction + letter) */
    #prompt {
      text-align: center;
      margin: 5vh 0;
      display: none; /* shown after Start */
    }
    #prompt .prompt-text {
      font-size: 2rem;
      font-weight: 500;
      color: #444;
    }
    #prompt .target-letter {
      display: block;
      font-size: 6rem;
      font-weight: bold;
      color: #009688;
      margin-top: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.15);
    }

    /* Dwell overlay */
    .dwell-fill {
      position: absolute;
      background-color: rgba(255, 0, 0, 0.5);
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      transform: translate(-50%, -50%);
      pointer-events: none;
      border-radius: 8px;
    }

    /* Freeze helper */
    .eyegaze-frozen #eyegaze-overlay *,
    .eyegaze-frozen .dwell-fill {
      animation-play-state: paused !important;
      transition: none !important;
    }

    /* Styled input */
    .styled-input {
      width: 100%;
      max-width: 160px;
      padding: 10px 14px;
      font-size: 18px;
      font-weight: bold;
      color: #000;
      border: 2px solid #009688;
      border-radius: 8px;
      background-color: #fff;
      text-align: center;
      box-shadow: none;
      transition: border-color .2s, box-shadow .2s;
    }
    .styled-input:focus {
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(0,150,136,0.15);
      outline: none;
    }
  </style>
</head>
<body>

<!-- Options modal -->
<div id="game-options" class="modal">
  <div id="options-title-bar">
    <h2 id="options-main-title">Chasse aux lettres</h2>
  </div>

  <div id="control-panel-options">
    <div id="mode-divider"></div>

    <div id="options-inline-container">
      <!-- Column 1: Audio -->
      <div class="options-column">
        <div class="option-item">
          <label class="teal-label">
            <input type="checkbox" id="muteSFX">
            <span>Désactiver les sons</span>
          </label>
        </div>
        <div class="option-item">
          <label for="sfxVol" class="teal-label">
            <span>Volume des sons: </span>
            <span id="sfxVolVal">50</span>
          </label>
          <input type="range" id="sfxVol" class="styled-slider" min="0" max="100" value="50">
        </div>
      </div>

      <!-- Column 2: Letters -->
      <div class="options-column">
        <div class="option-item">
          <label for="letterSet" class="teal-label label-block">Lettres à afficher</label>
          <input id="letterSet" type="text" value="ABCD" maxlength="26" class="styled-input">
        </div>
      </div>

      <!-- Column 3: Theme & dwell -->
      <div class="options-column">
        <div class="option-item">
          <label for="themeSelect" class="teal-label label-block">Mode</label>
          <select id="themeSelect" class="styled-select">
            <option value="light" selected>Clair</option>
            <option value="dark">Sombre</option>
          </select>
        </div>
        <div class="option-item">
          <label for="dwellTimeSlider" class="teal-label">
            <span>Temps de fixation: </span>
            <span id="dwellTimeVal">1500</span> ms
          </label>
          <input type="range" id="dwellTimeSlider" class="styled-slider" min="500" max="5000" step="100" value="1500">
        </div>
      </div>
    </div>

    <div id="mode-divider"></div>
    <button id="startButton" class="button">Commencer</button>
  </div>
</div>

<!-- Game area -->
<div class="game-container">
  <h2 id="prompt">
    <span class="prompt-text">Trouve la lettre</span><br>
    <span class="target-letter"></span>
  </h2>
  <div class="letter-grid"></div>
</div>

<!-- Audio -->
<audio id="correctSound" src="../../sounds/victory.mp3"></audio>
<audio id="wrongSound"   src="../../sounds/error.mp3"></audio>

<!-- Eyegaze helpers -->
<script src="../../js/eyegaze-menu.js"></script>

<script>
const muteSFX      = document.getElementById('muteSFX');
const sfxVol       = document.getElementById('sfxVol');
const sfxVolVal    = document.getElementById('sfxVolVal');
const dwellSlider  = document.getElementById('dwellTimeSlider');
const dwellTimeVal = document.getElementById('dwellTimeVal');
const themeSelect  = document.getElementById('themeSelect');
const startButton  = document.getElementById('startButton');

sfxVol.addEventListener('input', () => sfxVolVal.textContent = sfxVol.value);
dwellSlider.addEventListener('input', () => dwellTimeVal.textContent = dwellSlider.value);

function syncEyegazeSettingsFromUI() {
  try {
    if (window.eyegazeSettings) {
      eyegazeSettings.sfxMuted = !!muteSFX.checked;
      eyegazeSettings.sfxVolume = parseInt(sfxVol.value, 10) || 50;
      eyegazeSettings.dwellTime = parseInt(dwellSlider.value, 10) || 1500;
    }
  } catch(e) {}
}

let letters = [];
let targetLetter;
let hoverTimeout;
let selectedTheme = 'light';

const correctAudio = document.getElementById('correctSound');
const wrongAudio   = document.getElementById('wrongSound');

function applyTheme(theme) {
  document.body.classList.remove('light','dark');
  document.body.classList.add(theme);
}

function startGame() {
  if (document.documentElement.requestFullscreen) {
    document.documentElement.requestFullscreen();
  }
  syncEyegazeSettingsFromUI();
  selectedTheme = themeSelect.value;
  applyTheme(selectedTheme);

  const inputVal = document.getElementById('letterSet').value.toUpperCase().replace(/[^A-Z]/g,'');
  letters = inputVal.split('');
  if (letters.length === 0) letters = ['A','B','C','D'];

  document.querySelector('.game-container').style.display = 'flex';
  document.querySelector('.letter-grid').style.display = 'grid';
  document.getElementById('prompt').style.display = 'block';

  buildGrid();
  nextRound();

  try { if (window.eyegazeSettings?.hideOverlay) eyegazeSettings.hideOverlay(); } catch(e) {}
}

startButton.addEventListener('click', startGame);

function buildGrid() {
  const grid = document.querySelector('.letter-grid');
  grid.innerHTML = '';
  const cols = Math.ceil(Math.sqrt(letters.length));
  grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

  letters.forEach(letter => {
    const cell = document.createElement('div');
    cell.className = 'letter-cell';
    cell.textContent = letter;

    cell.addEventListener('mouseover', () => startHover(cell));
    cell.addEventListener('mouseout', stopHover);

    grid.appendChild(cell);
  });
}

function nextRound() {
  targetLetter = letters[Math.floor(Math.random() * letters.length)];
  document.querySelector("#prompt .target-letter").textContent = targetLetter;
}

let currentOverlay;
function startHover(tile) {
  const hoverTime = (window.eyegazeSettings?.dwellTime) || parseInt(dwellSlider.value, 10) || 1500;
  stopHover();
  currentOverlay = document.createElement('div');
  currentOverlay.className = 'dwell-fill';
  tile.appendChild(currentOverlay);

  requestAnimationFrame(() => {
    currentOverlay.style.transition = `width ${hoverTime}ms linear, height ${hoverTime}ms linear`;
    currentOverlay.style.width = '0';
    currentOverlay.style.height = '0';
    requestAnimationFrame(() => {
      currentOverlay.style.width = '100%';
      currentOverlay.style.height = '100%';
    });
  });

  hoverTimeout = setTimeout(() => {
    handleSelection(tile);
    stopHover();
  }, hoverTime);
}

function stopHover() {
  clearTimeout(hoverTimeout);
  if (currentOverlay) {
    if (currentOverlay.parentElement) {
      currentOverlay.parentElement.removeChild(currentOverlay);
    }
    currentOverlay = null;
  }
}

function handleSelection(el) {
  const letter = el.textContent;
  if (letter === targetLetter) {
    el.classList.add('correct');
    playSound(correctAudio);
    setTimeout(() => {
      el.classList.remove('correct');
      nextRound();
    }, 1000);
  } else {
    playSound(wrongAudio);
  }
}

function playSound(audioEl) {
  const muted = !!(window.eyegazeSettings?.sfxMuted) || !!muteSFX.checked;
  const sfxSetting = window.eyegazeSettings?.sfxVolume;
  const uiVol = parseInt(sfxVol.value, 10);
  const volPercent = (typeof sfxSetting === 'number')
    ? sfxSetting
    : (isNaN(uiVol) ? 50 : uiVol);

  audioEl.volume = muted ? 0 : Math.max(0, Math.min(1, volPercent / 100));
  try { audioEl.currentTime = 0; audioEl.play(); } catch(e) {}
}
</script>
</body>
</html>
