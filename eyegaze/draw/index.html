<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title class="translate"
          data-fr="Dessiner dans les contours (Eyegaze)"
          data-en="Draw inside the lines (Eyegaze)">
    Dessiner dans les contours (Eyegaze)
  </title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root{
      --toolbar-bg: rgba(255,255,255,0.88);
      --toolbar-border: rgba(0,0,0,0.12);
      --toolbar-shadow: 0 10px 30px rgba(15,23,42,0.18);
      --toolbar-radius: 18px;
      --toolbar-gap: 10px;
      --toolbar-pad: 10px 16px;
      --stage-max: min(1200px, 92vw);
    }

    body{
      margin:0;
      padding:0;
      background:#ffffff;
      color:#0f172a;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      min-height:100vh;
      display:block;
    }

    body.menu-open{
      overflow:hidden;
    }

    #langToggle{
      position:fixed;
      top:12px;
      right:12px;
      z-index:1200;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:12px;
      border:2px solid #009688;
      background:#ffffff;
      color:#009688;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    body.menu-open #langToggle{
      background:#111;
      color:#14b8a6;
      border-color:#14b8a6;
    }

    #game-options{
      background:rgba(7,17,27,0.62);
    }
    #game-options #control-panel-options{
      max-width:900px;
    }
    #game-options h2{
      font-size:clamp(1.6rem, 2vw, 2rem);
      margin-top:0;
      margin-bottom:0.35rem;
    }
    #game-options .options-subtitle{
      margin:0 0 1rem;
      font-size:clamp(1rem, 1.4vw, 1.1rem);
      color:#0f172ab8;
    }
    #options-inline-container{
      width:100%;
    }
    #options-inline-container .mask-summary{
      display:flex;
      align-items:center;
      gap:14px;
      padding:12px 14px;
      border-radius:14px;
      border:2px solid rgba(0,150,136,0.25);
      background:#f5fffd;
      box-shadow:0 4px 14px rgba(0,0,0,0.06);
    }
    #options-inline-container .mask-summary img{
      width:92px;
      height:92px;
      object-fit:contain;
      border-radius:12px;
      border:2px solid rgba(0,150,136,0.35);
      background:#ffffff;
      display:none;
    }
    #options-inline-container .mask-summary img.show-thumb{
      display:block;
    }
    #selectedMaskLabel{
      margin:0;
      font-weight:600;
      font-size:1rem;
      color:#0f172a;
    }
    #presetStatus{
      margin:4px 0 0;
      font-size:0.9rem;
      color:#475569;
    }

    .upload-actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      width:100%;
    }
    .upload-actions button{
      width:100%;
    }

    .game-container{
      position:relative;
      width:100vw;
      height:100vh;
      display:none;
      align-items:center;
      justify-content:center;
      background:#ffffff;
      overflow:hidden;
    }
    .game-container.active{
      display:flex;
    }

    #drawStage{
      position:relative;
      width:var(--stage-max);
      max-width:92vw;
      aspect-ratio: 16 / 10;
      background:#ffffff;
      border-radius:24px;
      box-shadow:0 18px 40px rgba(15,23,42,0.12);
      overflow:hidden;
    }
    #drawStage canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
    }

    .floating-toolbar{
      position:absolute;
      top:24px;
      right:24px;
      display:flex;
      align-items:center;
      gap:var(--toolbar-gap);
      padding:var(--toolbar-pad);
      background:var(--toolbar-bg);
      border:1px solid var(--toolbar-border);
      border-radius:var(--toolbar-radius);
      box-shadow:var(--toolbar-shadow);
      backdrop-filter:blur(12px);
      z-index:40;
    }
    .floating-toolbar .toolbar-btn{
      appearance:none;
      border:none;
      border-radius:999px;
      padding:10px 16px;
      font-size:0.95rem;
      font-weight:600;
      color:#0f172a;
      background:#d1f5ef;
      border:2px solid #0f172a10;
      cursor:pointer;
      transition:transform 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
    }
    .floating-toolbar .toolbar-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 20px rgba(15,23,42,0.15);
    }
    .floating-toolbar .toolbar-btn.mode-active{
      background:#fef3c7;
      border-color:#f59e0b80;
      color:#b45309;
    }

    .floating-toolbar .toolbar-btn.primary{
      background:#10b981;
      color:#ffffff;
      border-color:#059669;
    }
    .floating-toolbar .toolbar-btn.primary:hover{
      box-shadow:0 10px 24px rgba(16,185,129,0.35);
    }

    /* Library modal inspired by CVI generator */
    .library-modal{
      position:fixed;
      inset:0;
      background:rgba(7,17,27,0.65);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:60px 20px 40px;
      z-index:1500;
    }
    .library-modal.active{
      display:flex;
    }
    .library-dialog{
      width:min(960px, 92vw);
      max-height:calc(100vh - 120px);
      background:#ffffff;
      color:#0f172a;
      border:3px solid #009688;
      border-radius:20px;
      box-shadow:0 28px 60px rgba(15,23,42,0.25);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .library-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 26px 12px;
      border-bottom:2px solid rgba(0,150,136,0.25);
    }
    .library-header h3{
      margin:0;
      font-size:1.5rem;
      color:#009688;
    }
    .library-close{
      appearance:none;
      border:none;
      background:transparent;
      font-size:1.8rem;
      cursor:pointer;
      color:#0f172a;
    }
    .library-body{
      padding:18px 26px 0;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .library-status{
      margin:0;
      font-size:1rem;
      color:#475569;
    }
    .library-controls{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:center;
    }
    .library-controls label{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:600;
    }
    .library-controls select{
      appearance:none;
      padding:10px 40px 10px 14px;
      border:2px solid #009688;
      border-radius:12px;
      font-weight:600;
      font-size:1rem;
      background:
        #ffffff
        url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMiIgaGVpZ2h0PSI4IiB2aWV3Qm94PSIwIDAgMTIgOCI+PHBhdGggZD0iTTAgMGw2IDggNi04eiIgZmlsbD0iIzAwOTY4OCIvPjwvc3ZnPg==")
        no-repeat right 12px center;
      background-size:16px;
      color:#0f172a;
      cursor:pointer;
    }
    .library-carousel{
      display:flex;
      align-items:center;
      gap:18px;
    }
    .carousel-arrow{
      appearance:none;
      border:none;
      width:48px;
      height:48px;
      border-radius:50%;
      background:#009688;
      color:#ffffff;
      font-size:1.6rem;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,150,136,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .carousel-track{
      flex:1;
      display:flex;
      gap:14px;
      overflow-x:auto;
      padding:6px 4px;
      scroll-snap-type:x mandatory;
    }
    .carousel-track::-webkit-scrollbar{
      height:10px;
    }
    .carousel-track::-webkit-scrollbar-thumb{
      background:#0f172a33;
      border-radius:999px;
    }
    .carousel-card{
      flex:0 0 132px;
      scroll-snap-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      border-radius:16px;
      border:2px solid transparent;
      background:#f8fafc;
      cursor:pointer;
      transition:transform 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
    }
    .carousel-card img{
      width:100%;
      height:110px;
      object-fit:contain;
      background:#ffffff;
      border-radius:12px;
      box-shadow:0 6px 16px rgba(15,23,42,0.15);
      pointer-events:none;
    }
    .carousel-card span{
      font-size:0.9rem;
      font-weight:600;
      color:#0f172a;
      text-transform:capitalize;
    }
    .carousel-card.selected{
      border-color:#009688;
      box-shadow:0 16px 32px rgba(0,150,136,0.28);
      transform:translateY(-4px);
    }
    .carousel-card:focus-visible{
      outline:3px solid #38bdf8;
      outline-offset:4px;
    }
    .library-preview{
      display:flex;
      align-items:center;
      gap:18px;
      padding:16px;
      border-radius:16px;
      border:2px dashed rgba(0,150,136,0.35);
      background:#f8fffd;
    }
    .library-preview img{
      width:160px;
      height:160px;
      object-fit:contain;
      background:#ffffff;
      border-radius:12px;
      box-shadow:0 12px 28px rgba(15,23,42,0.16);
    }
    .library-preview p{
      margin:0;
      font-size:1rem;
      font-weight:600;
      color:#0f172a;
    }
    .library-footer{
      padding:18px 26px 24px;
      display:flex;
      justify-content:flex-end;
      gap:12px;
      border-top:2px solid rgba(0,150,136,0.25);
      background:#f8fffd;
    }
    .library-footer .button{
      min-width:150px;
    }

    @media (max-width:720px){
      .floating-toolbar{
        flex-wrap:wrap;
        gap:8px;
        right:12px;
        left:12px;
        justify-content:center;
      }
      .floating-toolbar .toolbar-btn{
        flex:1 1 auto;
        text-align:center;
      }
      #drawStage{
        width:100%;
        border-radius:16px;
      }
    }
  </style>

  <script src="../../js/cviPngArray.js" defer></script>
</head>
<body class="menu-open">
<button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

<div id="game-options" class="modal" style="display:flex;">
  <div id="control-panel-options">
    <h2 id="options-main-title" class="translate"
        data-fr="Dessiner dans les contours"
        data-en="Draw inside the lines">
      Dessiner dans les contours
    </h2>
    <p class="options-subtitle translate"
       data-fr="Choisissez vos réglages puis appuyez sur Commencer."
       data-en="Choose your settings and press Start.">
      Choisissez vos réglages puis appuyez sur Commencer.
    </p>

    <div id="mode-divider"></div>

    <div id="options-inline-container">
      <div class="options-column">
        <div class="option-item">
          <label for="brushSize" class="teal-label">
            <span class="translate" data-fr="Taille du pinceau" data-en="Brush size">Taille du pinceau</span>
            <span id="brushSizeVal">18</span> px
          </label>
          <input id="brushSize" class="styled-slider" type="range" min="3" max="64" value="18" />
        </div>
        <div class="option-item">
          <label for="brushColor" class="teal-label">
            <span class="translate" data-fr="Couleur du pinceau" data-en="Brush color">Couleur du pinceau</span>
          </label>
          <input id="brushColor" type="color" value="#ff7a59" />
        </div>
      </div>

      <div class="options-column">
        <div class="option-item">
          <label for="shapeSelect" class="teal-label label-block">
            <span class="translate" data-fr="Contour intégré" data-en="Built-in outline">Contour intégré</span>
          </label>
          <select id="shapeSelect" class="styled-select">
            <option value="blob" class="translate" data-fr="Forme libre" data-en="Blob">Forme libre</option>
            <option value="star" class="translate" data-fr="Étoile" data-en="Star">Étoile</option>
            <option value="heart" class="translate" data-fr="Cœur" data-en="Heart">Cœur</option>
            <option value="rect" class="translate" data-fr="Rectangle arrondi" data-en="Rounded rectangle">Rectangle arrondi</option>
          </select>
        </div>
        <div class="option-item">
          <p class="teal-label translate" data-fr="Contour actif" data-en="Active outline">Contour actif</p>
          <div class="mask-summary">
            <img id="selectedMaskThumb" alt="aperçu" />
            <div>
              <p id="selectedMaskLabel">&nbsp;</p>
              <p id="presetStatus"></p>
            </div>
          </div>
        </div>
      </div>

      <div class="options-column">
        <div class="option-item upload-actions">
          <button id="openLibraryBtn" class="button translate" type="button"
                  data-fr="Bibliothèque d'images" data-en="Image library">Bibliothèque d'images</button>
          <button id="uploadTrigger" class="button translate" type="button"
                  data-fr="Importer un contour" data-en="Upload outline">Importer un contour</button>
          <input id="outlineUpload" type="file" accept="image/png,image/svg+xml" hidden />
          <button id="resetMaskBtn" class="button translate" type="button"
                  data-fr="Utiliser la forme choisie" data-en="Use selected shape">Utiliser la forme choisie</button>
        </div>
      </div>
    </div>

    <div id="mode-divider"></div>

    <button id="startButton" class="button translate" type="button"
            data-fr="Commencer" data-en="Start">Commencer</button>
  </div>
</div>

<div id="libraryModal" class="library-modal" role="dialog" aria-modal="true" aria-labelledby="libraryTitle">
  <div class="library-dialog">
    <div class="library-header">
      <h3 id="libraryTitle" class="translate" data-fr="Bibliothèque d'images" data-en="Image library">Bibliothèque d'images</h3>
      <button id="libraryClose" class="library-close" type="button" aria-label="Fermer">×</button>
    </div>
    <div class="library-body">
      <p id="libraryStatus" class="library-status translate"
         data-fr="Chargement des images…" data-en="Loading images…">Chargement des images…</p>
      <div class="library-controls">
        <label class="translate" data-fr="Catégorie" data-en="Category">
          Catégorie
          <select id="libraryCategory"></select>
        </label>
      </div>
      <div class="library-carousel">
        <button id="libraryPrev" class="carousel-arrow" type="button" aria-label="Précédent">‹</button>
        <div id="carouselTrack" class="carousel-track" role="listbox"></div>
        <button id="libraryNext" class="carousel-arrow" type="button" aria-label="Suivant">›</button>
      </div>
      <div class="library-preview">
        <img id="libraryPreview" alt="aperçu" />
        <p id="libraryCaption">&nbsp;</p>
      </div>
    </div>
    <div class="library-footer">
      <button id="libraryConfirm" class="button translate" type="button"
              data-fr="Valider" data-en="Confirm">Valider</button>
      <button id="libraryCancel" class="button translate" type="button"
              data-fr="Annuler" data-en="Cancel">Annuler</button>
    </div>
  </div>
</div>

<div id="drawContainer" class="game-container" aria-live="polite">
  <div class="floating-toolbar">
    <button id="toolbarOptions" class="toolbar-btn translate" type="button"
            data-fr="Options" data-en="Options">Options</button>
    <button id="toolbarMode" class="toolbar-btn" type="button">Dessiner</button>
    <button id="toolbarClear" class="toolbar-btn translate" type="button"
            data-fr="Effacer" data-en="Clear">Effacer</button>
    <button id="toolbarSave" class="toolbar-btn primary translate" type="button"
            data-fr="PNG" data-en="PNG">PNG</button>
  </div>
  <div id="drawStage">
    <canvas id="outline" width="1400" height="900" aria-label="Calque du contour"></canvas>
    <canvas id="ink" width="1400" height="900" aria-label="Calque de dessin"></canvas>
  </div>
</div>

<script>
(() => {
  /* =============================
     Language helpers
     ============================= */
  const LS_LANG_KEY = 'siteLanguage';
  const langToggle = document.getElementById('langToggle');
  let currentLang = 'fr';

  function getInitialLang(){
    try {
      const saved = localStorage.getItem(LS_LANG_KEY);
      if (saved === 'fr' || saved === 'en') return saved;
    } catch (err) {}
    return document.documentElement.lang === 'en' ? 'en' : 'fr';
  }

  function applyStaticTranslations(lang){
    document.querySelectorAll('.translate').forEach(el => {
      const fr = el.getAttribute('data-fr');
      const en = el.getAttribute('data-en');
      if (lang === 'fr' && fr != null) el.textContent = fr;
      if (lang === 'en' && en != null) el.textContent = en;
    });
  }

  function setLang(lang){
    currentLang = (lang === 'en') ? 'en' : 'fr';
    document.documentElement.lang = currentLang;
    try { localStorage.setItem(LS_LANG_KEY, currentLang); } catch(err) {}
    applyStaticTranslations(currentLang);
    updateModeButton();
    updateMaskSummary();
    updateLibraryStatus();
    updateLibraryModalStatus();
  }

  langToggle.addEventListener('click', () => {
    setLang(currentLang === 'fr' ? 'en' : 'fr');
  });

  /* =============================
     Elements and state
     ============================= */
  const ink = document.getElementById('ink');
  const out = document.getElementById('outline');
  const ic = ink.getContext('2d');
  const oc = out.getContext('2d');

  const brushEl = document.getElementById('brushSize');
  const brushVal = document.getElementById('brushSizeVal');
  const colorEl = document.getElementById('brushColor');
  const shapeEl = document.getElementById('shapeSelect');
  const clearBtn = document.getElementById('toolbarClear');
  const saveBtn = document.getElementById('toolbarSave');
  const optionsBtn = document.getElementById('toolbarOptions');
  const modeBtn = document.getElementById('toolbarMode');
  const startButton = document.getElementById('startButton');
  const openLibraryBtn = document.getElementById('openLibraryBtn');
  const uploadTrigger = document.getElementById('uploadTrigger');
  const uploadInput = document.getElementById('outlineUpload');
  const resetMaskBtn = document.getElementById('resetMaskBtn');
  const gameOptions = document.getElementById('game-options');
  const drawContainer = document.getElementById('drawContainer');
  const maskLabel = document.getElementById('selectedMaskLabel');
  const maskThumb = document.getElementById('selectedMaskThumb');
  const presetStatus = document.getElementById('presetStatus');

  const libraryModal = document.getElementById('libraryModal');
  const libraryClose = document.getElementById('libraryClose');
  const libraryCancel = document.getElementById('libraryCancel');
  const libraryConfirm = document.getElementById('libraryConfirm');
  const libraryCategory = document.getElementById('libraryCategory');
  const libraryStatus = document.getElementById('libraryStatus');
  const libraryPreview = document.getElementById('libraryPreview');
  const libraryCaption = document.getElementById('libraryCaption');
  const carouselTrack = document.getElementById('carouselTrack');
  const carouselPrev = document.getElementById('libraryPrev');
  const carouselNext = document.getElementById('libraryNext');

  const MODE_LABELS = {
    draw: { fr: 'Dessiner', en: 'Draw' },
    erase: { fr: 'Gommer', en: 'Erase' }
  };

  const SHAPE_LABELS = {
    blob:  { fr: 'Forme libre',        en: 'Blob' },
    star:  { fr: 'Étoile',             en: 'Star' },
    heart: { fr: 'Cœur',               en: 'Heart' },
    rect:  { fr: 'Rectangle arrondi',  en: 'Rounded rectangle' }
  };

  const SUMMARY_TEXT = {
    shapePrefix: { fr: 'Forme :',         en: 'Shape:' },
    presetPrefix:{ fr: 'Bibliothèque :',  en: 'Library:' },
    uploadPrefix:{ fr: 'Importé :',       en: 'Uploaded:' },
    none:        { fr: 'Aucune image personnalisée', en: 'No custom image selected' }
  };

  const LIBRARY_STATUS_TEXT = {
    missing: { fr: 'Bibliothèque indisponible. Ajoutez cviPngArray.js.',
               en: 'Image library unavailable. Add cviPngArray.js.' },
    loaded:  (count, cats) => ({
      fr: `${count} image${count > 1 ? 's' : ''} dans ${cats} catégorie${cats > 1 ? 's' : ''}`,
      en: `${count} image${count > 1 ? 's' : ''} across ${cats} categor${cats > 1 ? 'ies' : 'y'}`
    }),
    prompt: { fr: 'Choisissez une image puis cliquez sur Valider.',
              en: 'Select an image and press Confirm.' }
  };

  let drawing = false;
  let prevPoint = null;
  let isErasing = false;
  let userMask = null;
  let maskMeta = { type: 'shape', id: shapeEl.value };

  const maskCanvas = document.createElement('canvas');
  const maskCtx = maskCanvas.getContext('2d');
  let maskImageData = null;

  const scratch = document.createElement('canvas');
  const sc = scratch.getContext('2d');

  let resizePending = false;
  let libraryData = [];
  let libraryInfo = { available: false, total: 0, categories: 0 };
  let selectedLibraryItem = null;

  /* =============================
     Resize + drawing helpers
     ============================= */
  function fitCanvas(cnv){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = cnv.getBoundingClientRect();
    const w = Math.max(1, Math.round(rect.width * dpr));
    const h = Math.max(1, Math.round(rect.height * dpr));
    if (cnv.width !== w || cnv.height !== h){
      cnv.width = w;
      cnv.height = h;
      const ctx = cnv.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
  }

  function syncScratch(){
    scratch.width = ink.width;
    scratch.height = ink.height;
    sc.setTransform(ic.getTransform());
    sc.clearRect(0,0,scratch.width,scratch.height);
  }

  function resizeAll(){
    fitCanvas(ink);
    fitCanvas(out);
    drawOutline();
    syncScratch();
    rebuildMaskCache();
  }

  function requestResize(){
    if (resizePending) return;
    resizePending = true;
    requestAnimationFrame(() => {
      resizePending = false;
      resizeAll();
    });
  }

  const stageObserver = new ResizeObserver(() => requestResize());
  stageObserver.observe(out);

  /* =============================
     Shapes and outlines
     ============================= */
  let shapePath = null;

  function makePath(kind, w, h){
    const p = new Path2D();
    const pad = Math.min(w,h) * 0.12;
    const cx = w / 2;
    const cy = h / 2;
    if (kind === 'rect'){
      const r = Math.min(w,h) * 0.18;
      const x = pad;
      const y = pad;
      const rw = w - 2 * pad;
      const rh = h - 2 * pad;
      p.moveTo(x + r, y);
      p.arcTo(x + rw, y, x + rw, y + rh, r);
      p.arcTo(x + rw, y + rh, x, y + rh, r);
      p.arcTo(x, y + rh, x, y, r);
      p.arcTo(x, y, x + rw, y, r);
      p.closePath();
    } else if (kind === 'blob'){
      const rx = w * 0.32;
      const ry = h * 0.28;
      p.moveTo(cx, cy - ry);
      p.bezierCurveTo(cx + rx * 0.6, cy - ry, cx + rx, cy - ry * 0.2, cx + rx, cy);
      p.bezierCurveTo(cx + rx, cy + ry * 0.6, cx + rx * 0.4, cy + ry, cx, cy + ry);
      p.bezierCurveTo(cx - rx * 0.6, cy + ry, cx - rx, cy + ry * 0.2, cx - rx, cy);
      p.bezierCurveTo(cx - rx, cy - ry * 0.6, cx - rx * 0.4, cy - ry, cx, cy - ry);
      p.closePath();
    } else if (kind === 'star'){
      const spikes = 5;
      const r = Math.min(w,h) * 0.36;
      const step = Math.PI / spikes;
      let rot = Math.PI / 2 * 3;
      let x = cx;
      let y = cy - r;
      p.moveTo(cx, cy - r);
      for (let i = 0; i < spikes; i++){
        x = cx + Math.cos(rot) * r;
        y = cy + Math.sin(rot) * r;
        p.lineTo(x, y);
        rot += step;
        x = cx + Math.cos(rot) * r * 0.5;
        y = cy + Math.sin(rot) * r * 0.5;
        p.lineTo(x, y);
        rot += step;
      }
      p.closePath();
    } else if (kind === 'heart'){
      const s = Math.min(w,h) * 0.36;
      const top = cy - s * 0.25;
      p.moveTo(cx, top);
      p.bezierCurveTo(cx + s * 0.5, top - s * 0.6, cx + s, cy - s * 0.05, cx, cy + s * 0.75);
      p.bezierCurveTo(cx - s, cy - s * 0.05, cx - s * 0.5, top - s * 0.6, cx, top);
      p.closePath();
    }
    return p;
  }

  function drawOutline(){
    const rect = out.getBoundingClientRect();
    shapePath = makePath(shapeEl.value, rect.width, rect.height);
    oc.clearRect(0,0,out.width,out.height);
    if (userMask){
      redrawMaskGuide();
    } else {
      oc.save();
      oc.fillStyle = '#ffffff';
      oc.globalAlpha = 0.08;
      oc.fill(shapePath);
      oc.globalAlpha = 1;
      oc.lineWidth = 6;
      oc.strokeStyle = '#64748b';
      oc.stroke(shapePath);
      oc.restore();
    }
  }

  function computeContainFit(destW, destH, imgW, imgH){
    const r = imgW / imgH;
    const R = destW / destH;
    let w, h;
    if (R > r){
      h = destH;
      w = destH * r;
    } else {
      w = destW;
      h = destW / r;
    }
    const x = (destW - w) / 2;
    const y = (destH - h) / 2;
    return { x, y, w, h };
  }

  function rebuildMaskCache(){
    if (!userMask){
      maskImageData = null;
      return;
    }
    maskCanvas.width = out.width;
    maskCanvas.height = out.height;
    maskCtx.setTransform(oc.getTransform());
    maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
    const rect = out.getBoundingClientRect();
    const fit = computeContainFit(rect.width, rect.height, userMask.naturalWidth, userMask.naturalHeight);
    maskCtx.drawImage(userMask, fit.x, fit.y, fit.w, fit.h);
    const img = maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);
    const data = img.data;
    for (let i = 0; i < data.length; i += 4){
      data[i] = 255;
      data[i+1] = 255;
      data[i+2] = 255;
      // alpha stays as-is
    }
    maskCtx.putImageData(img, 0, 0);
    maskImageData = img;
  }

  function redrawMaskGuide(){
    oc.clearRect(0,0,out.width,out.height);
    if (!userMask){
      oc.save();
      oc.fillStyle = '#ffffff';
      oc.globalAlpha = 0.08;
      oc.fill(shapePath);
      oc.globalAlpha = 1;
      oc.lineWidth = 6;
      oc.strokeStyle = '#64748b';
      oc.stroke(shapePath);
      oc.restore();
      return;
    }
    const rect = out.getBoundingClientRect();
    const fit = computeContainFit(rect.width, rect.height, userMask.naturalWidth, userMask.naturalHeight);
    oc.save();
    oc.globalAlpha = 0.25;
    oc.drawImage(userMask, fit.x, fit.y, fit.w, fit.h);
    oc.restore();
  }

  /* =============================
     Mask loading helpers
     ============================= */
  function loadUserMaskFromURL(url, revokeAfterLoad = false, meta = null){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        if (revokeAfterLoad) URL.revokeObjectURL(url);
        userMask = img;
        if (meta) maskMeta = meta;
        rebuildMaskCache();
        drawOutline();
        redrawMaskGuide();
        updateMaskSummary();
        resolve();
      };
      img.onerror = () => {
        if (revokeAfterLoad) URL.revokeObjectURL(url);
        alert(currentLang === 'fr' ? 'Impossible de charger l\'image.' : 'Could not load image.');
        reject(new Error('mask-load-error'));
      };
      img.src = url;
    });
  }

  async function loadUserMaskFromFile(file){
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async evt => {
      const dataUrl = evt.target?.result;
      if (typeof dataUrl !== 'string') return;
      const meta = { type: 'upload', name: file.name, preview: dataUrl };
      await loadUserMaskFromURL(dataUrl, false, meta);
    };
    reader.readAsDataURL(file);
  }

  /* =============================
     Drawing logic
     ============================= */
  const supportsPathClip = (() => {
    try {
      const c = document.createElement('canvas').getContext('2d');
      const p = new Path2D();
      p.rect(0,0,1,1);
      c.save();
      c.clip(p);
      c.restore();
      return true;
    } catch(err){
      return false;
    }
  })();

  function getPointerPos(e){
    const r = ink.getBoundingClientRect();
    if (e.touches && e.touches[0]){
      return {
        x: e.touches[0].clientX - r.left,
        y: e.touches[0].clientY - r.top
      };
    }
    return {
      x: (e.clientX ?? e.x) - r.left,
      y: (e.clientY ?? e.y) - r.top
    };
  }

  function beginDraw(e){
    drawing = true;
    prevPoint = getPointerPos(e);
    e.preventDefault();
  }

  function endDraw(){
    drawing = false;
    prevPoint = null;
  }

  function drawStroke(e){
    if (!drawing) return;
    const cur = getPointerPos(e);
    const size = Number(brushEl.value);
    const color = colorEl.value;
    const erasing = isErasing;

    if (userMask){
      sc.save();
      sc.lineCap = 'round';
      sc.lineJoin = 'round';
      sc.lineWidth = size;
      sc.globalCompositeOperation = 'source-over';
      sc.strokeStyle = erasing ? '#000' : color;
      sc.beginPath();
      sc.moveTo(prevPoint.x, prevPoint.y);
      sc.lineTo(cur.x, cur.y);
      sc.stroke();
      sc.globalCompositeOperation = 'destination-in';
      sc.drawImage(maskCanvas, 0, 0);
      sc.restore();

      ic.save();
      ic.globalCompositeOperation = erasing ? 'destination-out' : 'source-over';
      ic.drawImage(scratch, 0, 0);
      ic.restore();
      sc.clearRect(0,0,scratch.width,scratch.height);
    } else {
      if (!shapePath) return;
      if (supportsPathClip){
        ic.save();
        ic.clip(shapePath);
        ic.lineCap = 'round';
        ic.lineJoin = 'round';
        ic.lineWidth = size;
        ic.globalCompositeOperation = erasing ? 'destination-out' : 'source-over';
        ic.strokeStyle = erasing ? 'rgba(0,0,0,1)' : color;
        ic.beginPath();
        ic.moveTo(prevPoint.x, prevPoint.y);
        ic.lineTo(cur.x, cur.y);
        ic.stroke();
        ic.restore();
      } else {
        if (!maskImageData){
          maskCanvas.width = out.width;
          maskCanvas.height = out.height;
          maskCtx.setTransform(oc.getTransform());
          maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
          maskCtx.fillStyle = '#fff';
          maskCtx.fill(shapePath);
          maskImageData = maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);
        }
        sc.save();
        sc.lineCap = 'round';
        sc.lineJoin = 'round';
        sc.lineWidth = size;
        sc.globalCompositeOperation = 'source-over';
        sc.strokeStyle = erasing ? '#000' : color;
        sc.beginPath();
        sc.moveTo(prevPoint.x, prevPoint.y);
        sc.lineTo(cur.x, cur.y);
        sc.stroke();
        sc.globalCompositeOperation = 'destination-in';
        sc.putImageData(maskImageData, 0, 0);
        sc.restore();

        ic.save();
        ic.globalCompositeOperation = erasing ? 'destination-out' : 'source-over';
        ic.drawImage(scratch, 0, 0);
        ic.restore();
        sc.clearRect(0,0,scratch.width,scratch.height);
      }
    }

    prevPoint = cur;
    e.preventDefault();
  }

  ink.addEventListener('pointerdown', beginDraw);
  window.addEventListener('pointerup', endDraw);
  window.addEventListener('pointercancel', endDraw);
  window.addEventListener('pointerout', evt => { if (evt.target === ink) endDraw(); });
  window.addEventListener('pointermove', drawStroke, { passive: false });

  ink.addEventListener('touchstart', beginDraw, { passive: false });
  window.addEventListener('touchend', endDraw, { passive: false });
  window.addEventListener('touchmove', drawStroke, { passive: false });

  /* =============================
     UI events
     ============================= */
  brushEl.addEventListener('input', () => {
    brushVal.textContent = brushEl.value;
  });

  clearBtn.addEventListener('click', () => {
    ic.clearRect(0,0,ink.width,ink.height);
  });

  saveBtn.addEventListener('click', () => {
    const url = mergeForExport();
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dessin.png';
    a.click();
  });

  optionsBtn.addEventListener('click', () => {
    gameOptions.style.display = 'flex';
    document.body.classList.add('menu-open');
  });

  startButton.addEventListener('click', () => {
    gameOptions.style.display = 'none';
    document.body.classList.remove('menu-open');
    drawContainer.classList.add('active');
    requestResize();
  });

  shapeEl.addEventListener('change', () => {
    userMask = null;
    maskImageData = null;
    maskMeta = { type: 'shape', id: shapeEl.value };
    drawOutline();
    updateMaskSummary();
  });

  uploadTrigger.addEventListener('click', () => uploadInput.click());
  uploadInput.addEventListener('change', e => {
    const file = e.target.files && e.target.files[0];
    if (file){
      loadUserMaskFromFile(file);
      e.target.value = '';
    }
  });

  resetMaskBtn.addEventListener('click', () => {
    userMask = null;
    maskImageData = null;
    maskMeta = { type: 'shape', id: shapeEl.value };
    drawOutline();
    updateMaskSummary();
  });

  modeBtn.addEventListener('click', () => {
    isErasing = !isErasing;
    updateModeButton();
  });

  function updateModeButton(){
    modeBtn.classList.toggle('mode-active', isErasing);
    const label = isErasing ? MODE_LABELS.erase[currentLang] : MODE_LABELS.draw[currentLang];
    modeBtn.textContent = label;
  }

  function updateMaskSummary(){
    if (!maskLabel) return;
    let text = SUMMARY_TEXT.none[currentLang];
    if (maskMeta.type === 'shape'){
      const shapeLabel = SHAPE_LABELS[maskMeta.id]?.[currentLang] ?? maskMeta.id;
      text = `${SUMMARY_TEXT.shapePrefix[currentLang]} ${shapeLabel}`;
      maskThumb.classList.remove('show-thumb');
      maskThumb.removeAttribute('src');
    } else if (maskMeta.type === 'preset'){
      const name = maskMeta.name ?? '';
      text = `${SUMMARY_TEXT.presetPrefix[currentLang]} ${name}`;
      if (maskMeta.preview){
        maskThumb.src = maskMeta.preview;
        maskThumb.classList.add('show-thumb');
      } else if (maskMeta.file){
        maskThumb.src = maskMeta.file;
        maskThumb.classList.add('show-thumb');
      } else {
        maskThumb.classList.remove('show-thumb');
      }
    } else if (maskMeta.type === 'upload'){
      const name = maskMeta.name ?? '';
      text = `${SUMMARY_TEXT.uploadPrefix[currentLang]} ${name}`;
      if (maskMeta.preview){
        maskThumb.src = maskMeta.preview;
        maskThumb.classList.add('show-thumb');
      } else {
        maskThumb.classList.remove('show-thumb');
      }
    }
    maskLabel.textContent = text;
  }

  function updateLibraryStatus(){
    if (!presetStatus) return;
    if (!libraryInfo.available){
      presetStatus.textContent = LIBRARY_STATUS_TEXT.missing[currentLang];
    } else {
      const msg = LIBRARY_STATUS_TEXT.loaded(libraryInfo.total, libraryInfo.categories)[currentLang];
      presetStatus.textContent = msg;
    }
    openLibraryBtn.disabled = !libraryInfo.available;
  }

  function updateLibraryModalStatus(){
    if (!libraryInfo.available){
      libraryStatus.textContent = LIBRARY_STATUS_TEXT.missing[currentLang];
    } else if (libraryData.length){
      libraryStatus.textContent = LIBRARY_STATUS_TEXT.prompt[currentLang];
    }
    if (selectedLibraryItem){
      libraryCaption.textContent = selectedLibraryItem.name ?? '';
    }
  }

  /* =============================
     Library modal behaviour
     ============================= */
  function openLibrary(){
    if (!libraryInfo.available) return;
    if (maskMeta.type === 'preset' && maskMeta.category){
      const option = libraryCategory.querySelector(`[value="${maskMeta.category}"]`);
      if (option){
        libraryCategory.value = maskMeta.category;
      }
    }
    renderCarousel();
    libraryModal.classList.add('active');
    updateLibraryModalStatus();
  }

  function closeLibrary(){
    libraryModal.classList.remove('active');
  }

  function renderCarousel(){
    const category = libraryCategory.value;
    const items = libraryData
      .filter(item => item.category === category)
      .sort((a,b) => a.name.localeCompare(b.name));

    carouselTrack.innerHTML = '';
    items.forEach(item => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'carousel-card';
      btn.dataset.file = item.file;
      btn.dataset.name = item.name;
      btn.dataset.category = item.category;
      btn.innerHTML = `<img src="${item.file}" alt="${item.name}"><span>${item.name}</span>`;
      btn.addEventListener('click', () => {
        selectedLibraryItem = {
          type: 'preset',
          name: item.name,
          file: item.file,
          category: item.category,
          preview: item.file
        };
        highlightSelection();
        libraryPreview.src = item.file;
        libraryCaption.textContent = item.name;
      });
      carouselTrack.appendChild(btn);
    });

    if (items.length){
      let targetItem = items[0];
      if (maskMeta.type === 'preset' && maskMeta.name){
        const match = items.find(i => i.name === maskMeta.name);
        if (match) targetItem = match;
      }
      selectedLibraryItem = {
        type: 'preset',
        name: targetItem.name,
        file: targetItem.file,
        category: targetItem.category,
        preview: targetItem.file
      };
      highlightSelection();
      libraryPreview.src = targetItem.file;
      libraryCaption.textContent = targetItem.name;
    } else {
      selectedLibraryItem = null;
      libraryPreview.removeAttribute('src');
      libraryCaption.textContent = '';
    }
  }

  function highlightSelection(){
    const cards = carouselTrack.querySelectorAll('.carousel-card');
    cards.forEach(card => {
      const isSelected = selectedLibraryItem && card.dataset.file === selectedLibraryItem.file;
      card.classList.toggle('selected', isSelected);
    });
  }

  function enableLibrary(){
    if (!Array.isArray(window.PNG_ARRAY) || window.PNG_ARRAY.length === 0){
      libraryInfo = { available: false, total: 0, categories: 0 };
      updateLibraryStatus();
      return;
    }
    libraryData = window.PNG_ARRAY.slice();
    const categories = [...new Set(libraryData.map(item => item.category))].sort((a,b) => a.localeCompare(b));
    libraryInfo = { available: true, total: libraryData.length, categories: categories.length };
    libraryCategory.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    if (categories[0]){
      libraryCategory.value = categories[0];
    }
    renderCarousel();
    updateLibraryStatus();
    updateLibraryModalStatus();
  }

  openLibraryBtn.addEventListener('click', openLibrary);
  libraryClose.addEventListener('click', closeLibrary);
  libraryCancel.addEventListener('click', closeLibrary);
  libraryModal.addEventListener('click', evt => {
    if (evt.target === libraryModal) closeLibrary();
  });

  libraryConfirm.addEventListener('click', async () => {
    if (!selectedLibraryItem) return;
    try {
      await loadUserMaskFromURL(selectedLibraryItem.file, false, selectedLibraryItem);
      closeLibrary();
    } catch (err) {
      // already reported to the user in loadUserMaskFromURL
    }
  });

  libraryCategory.addEventListener('change', () => {
    renderCarousel();
  });

  carouselPrev.addEventListener('click', () => {
    carouselTrack.scrollBy({ left: -220, behavior: 'smooth' });
  });
  carouselNext.addEventListener('click', () => {
    carouselTrack.scrollBy({ left: 220, behavior: 'smooth' });
  });

  /* =============================
     Export helper
     ============================= */
  function mergeForExport(){
    const merge = document.createElement('canvas');
    merge.width = ink.width;
    merge.height = ink.height;
    const mc = merge.getContext('2d');
    mc.setTransform(ic.getTransform());
    mc.drawImage(out, 0, 0);
    mc.drawImage(ink, 0, 0);
    return merge.toDataURL('image/png');
  }

  /* =============================
     Initialization
     ============================= */
  const initialLang = getInitialLang();
  setLang(initialLang);
  updateModeButton();
  updateMaskSummary();
  requestResize();

  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(enableLibrary, 0);
  });
})();
</script>
</body>
</html>
