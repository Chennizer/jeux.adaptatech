<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title class="translate" data-fr="Prairie aux lucioles" data-en="Firefly Meadow" data-ja="ホタルの草原">Prairie aux lucioles</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: "Poppins", "Segoe UI", system-ui, -apple-system, sans-serif;
    }

    body.playing #game-options,
    body.playing #startHint {
      display: none !important;
    }

    #langToggle {
      position: fixed; top:10px; right:10px;
      z-index: 1200;
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 10px; border: 2px solid #009688;
      background: #fff; color: #009688; font-weight: 700; cursor: pointer;
      user-select: none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.22);
    }

    /* Hide native cursor when custom pointer is active */
    .hide-native-cursor, .hide-native-cursor * { cursor: none !important; }

    #arena {
      position: absolute;
      inset: 0;
      overflow: hidden;
      background: #000;
    }

    .badge-value {
      display: inline-block;
      min-width: 44px;
      text-align: center;
      padding: 4px 8px;
      margin-left: 6px;
      border-radius: 10px;
      background: rgba(0, 223, 201, 0.15);
      color: #bffcf6;
      font-variant-numeric: tabular-nums;
    }

    #startHint {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #dffbf6;
      padding: 10px 16px;
      border: 1px solid rgba(0, 223, 201, 0.3);
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      font-weight: 600;
      z-index: 600;
      letter-spacing: 0.02em;
    }

    /* circles */
    .bubble {
      position: absolute;
      left: 0;
      top: 0;
      width: var(--size);
      height: var(--size);
      transform: translate3d(var(--x), var(--y), 0);
      border-radius: 50%;
      background:
        radial-gradient(circle at 45% 40%, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0) 45%),
        radial-gradient(circle at center, color-mix(in srgb, var(--color-base) 82%, #ffffff 18%) 0%, color-mix(in srgb, var(--color-base) 68%, #ffffff 32%) 64%, color-mix(in srgb, var(--color-base) 52%, #ffffff 48%) 100%),
        conic-gradient(from -90deg, color-mix(in srgb, var(--color-peak) calc(70% + var(--progress-ratio) * 30%), rgba(255, 255, 255, 0.6)) var(--progress), rgba(255, 255, 255, 0.16) var(--progress));
      box-shadow:
        0 0 24px rgba(255, 255, 255, 0.32),
        0 0 calc(90px + var(--progress-ratio) * 200px) color-mix(in srgb, var(--glow) 92%, rgba(255, 255, 255, 0.3)),
        0 0 calc(140px + var(--progress-ratio) * 240px) color-mix(in srgb, var(--glow-soft) 95%, rgba(255, 255, 255, 0.18)),
        inset 0 0 22px color-mix(in srgb, var(--color-peak) 80%, #ffffff 20%);
      transition: transform 0.28s ease, box-shadow 0.28s ease, filter 0.28s ease;
      filter: saturate(calc(1.5 + var(--progress-ratio) * 1.6)) brightness(calc(1.6 + var(--progress-ratio) * 1.6));
      pointer-events: auto;
      will-change: transform;
      --size: 160px;
      --progress: 0deg;
      --progress-ratio: 0;
      --color-base: #9ef8ff;
      --color-peak: color-mix(in srgb, var(--color-base) 40%, white 60%);
      --glow: rgba(132, 248, 255, 0.72);
      --glow-soft: rgba(132, 248, 255, 0.26);
    }

    .bubble::before {
      content: "";
      position: absolute;
      inset: 10%;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.5), transparent 62%),
        radial-gradient(circle at 32% 32%, rgba(255, 255, 255, 0.55), transparent 48%);
      box-shadow: inset 0 0 38px rgba(255, 255, 255, 0.32);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .bubble::after {
      content: "";
      position: absolute;
      inset: -8%;
      border-radius: 50%;
      background:
        conic-gradient(color-mix(in srgb, var(--glow-ring) 86%, #ffffff 14%) var(--progress), rgba(255, 255, 255, 0.1) var(--progress)),
        radial-gradient(circle at center, rgba(255, 255, 255, 0.22), transparent 60%);
      mask: radial-gradient(circle at center, transparent 54%, black 60%);
      pointer-events: none;
      transition: opacity 0.2s ease;
      box-shadow:
        0 0 calc(34px + var(--progress-ratio) * 52px) color-mix(in srgb, var(--glow-soft) 88%, transparent),
        0 0 18px rgba(255, 255, 255, 0.3);
      opacity: calc(0.42 + var(--progress-ratio) * 0.9);
    }

    .bubble:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 8px;
    }

    .bubble.dwell {
      transform: translate3d(var(--x), var(--y), 0) scale(1.05);
      box-shadow:
        0 0 40px rgba(255, 255, 255, 0.3),
        0 0 160px color-mix(in srgb, var(--glow) 95%, rgba(255, 255, 255, 0.28)),
        0 0 260px color-mix(in srgb, var(--glow-soft) 95%, transparent);
    }

    .bubble.pop {
      animation: pop 0.5s ease forwards;
    }

    @keyframes pop {
      0% { transform: translate3d(var(--x), var(--y), 0) scale(1.05); opacity: 1; }
      60% { transform: translate3d(var(--x), var(--y), 0) scale(1.3); opacity: 0.9; }
      100% { transform: translate3d(var(--x), var(--y), 0) scale(0.2); opacity: 0; }
    }

    /* end-of-wave celebration */
    .completion-burst {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
      z-index: 500;
    }

    .completion-ring {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: 2px solid var(--ring-color);
      box-shadow: 0 0 28px var(--ring-color-soft), 0 0 60px var(--ring-color-soft);
      animation: ring-burst 1s ease-out forwards;
    }

    .completion-flare {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, var(--ring-color), transparent 68%);
      filter: blur(8px);
      opacity: 0.75;
      animation: flare-fade 1s ease-out forwards;
    }

    @keyframes ring-burst {
      0% { transform: scale(0.2); opacity: 0.85; }
      55% { opacity: 0.65; }
      100% { transform: scale(6); opacity: 0; }
    }

    @keyframes flare-fade {
      0% { transform: scale(0.8); opacity: 0.75; }
      100% { transform: scale(3.6); opacity: 0; }
    }

    /* released fireflies */
    .firefly {
      position: absolute;
      left: 0;
      top: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff 0%, rgba(255, 255, 255, 0.9) 35%, var(--tone) 70%, transparent 80%);
      transform: translate3d(var(--x), var(--y), 0) scale(var(--scale, 1));
      box-shadow: 0 0 10px var(--tone-soft), 0 0 20px var(--tone-soft);
      opacity: 0.92;
      mix-blend-mode: screen;
      pointer-events: none;
      will-change: transform;
      animation: firefly-flicker 2.5s ease-in-out infinite;
    }

    .firefly::after {
      content: "";
      position: absolute;
      inset: -9px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, var(--tone-dim), transparent 65%);
      filter: blur(5px);
      opacity: 0.7;
    }

    @keyframes firefly-flicker {
      0%, 100% {
        opacity: 0.88;
        box-shadow: 0 0 8px var(--tone-soft), 0 0 18px var(--tone-soft);
        filter: drop-shadow(0 0 8px var(--tone-soft));
      }
      48% {
        opacity: 1;
        box-shadow: 0 0 14px var(--tone-soft), 0 0 26px var(--tone-soft);
        filter: drop-shadow(0 0 14px var(--tone-soft));
      }
    }

    #ambient-note {
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      color: #9cfaf0;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(0, 223, 201, 0.25);
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.4);
      z-index: 650;
      letter-spacing: 0.02em;
      font-weight: 600;
    }

    /* custom gaze pointer */
    #gazePointer {
      position: fixed;
      left: 0;
      top: 0;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #fff 0%, rgba(255, 255, 255, 0.8) 38%, rgba(255, 0, 0, 0.9) 78%, rgba(255, 0, 0, 0.4) 100%);
      box-shadow: 0 0 14px rgba(255, 0, 0, 0.9), 0 0 30px rgba(255, 0, 0, 0.45);
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 1500;
      opacity: 0;
      transition: opacity 200ms ease;
    }

    #gazePointer.show {
      opacity: 1;
    }

  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} // eslint-disable-line
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>
<body>
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <div id="game-options" class="modal" role="dialog" aria-modal="true">
    <div>
      <div id="options-title-bar">
        <h1 id="options-main-title" class="translate" data-fr="Prairie aux lucioles" data-en="Firefly Meadow" data-ja="ホタルの草原">Prairie aux lucioles</h1>
        <p id="options-subtitle" class="translate" data-fr="Regardez un cercle. Patientez. Il éclate." data-en="Look at a circle. Dwell. It pops." data-ja="丸を見つめて。待つだけで弾けます。">Regardez un cercle. Patientez. Il éclate.</p>
      </div>

      <div id="control-panel-options">
        <div id="mode-divider"></div>

        <div id="options-inline-container" class="inline">
          <div class="options-column">
            <div class="option-item">
              <div class="teal-label translate" data-fr="Temps de fixation" data-en="Dwell time" data-ja="視線保持時間">Temps de fixation</div>
              <input id="dwellInput" class="styled-slider" type="range" min="500" max="1800" step="50" value="900" />
              <span class="badge-value" id="dwellVal">900 ms</span>
            </div>
            <div class="option-item">
              <div class="teal-label translate" data-fr="Nombre de cercles" data-en="Circle count" data-ja="サークル数">Nombre de cercles</div>
              <input id="countInput" class="styled-slider" type="range" min="3" max="10" step="1" value="6" />
              <span class="badge-value" id="countVal">6</span>
            </div>
          </div>
          <div class="options-column">
            <button id="resetBtn" class="button translate" data-fr="Mélanger" data-en="Shuffle" data-ja="シャッフル">Mélanger</button>
            <button id="startButton" class="button translate" data-fr="Jouer" data-en="Play" data-ja="プレイ">Jouer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="arena" aria-live="polite"></div>

  <div id="ambient-note" class="translate" data-fr="Éclatez tous les cercles : les lucioles restent, de nouveaux cercles reviennent." data-en="Pop every circle; fireflies keep floating until the next wave returns." data-ja="すべての丸をはじけさせるとホタルは浮かび続け、新しい丸がまとめて戻ります。">Éclatez tous les cercles : les lucioles restent, de nouveaux cercles reviennent.</div>

  <div id="startHint" class="translate" data-fr="Appuyer sur Entrée ou Jouer pour démarrer en plein écran" data-en="Press Enter or Play to start in fullscreen" data-ja="Enterキーまたはプレイでフルスクリーン開始">Appuyer sur Entrée ou Jouer pour démarrer en plein écran</div>

  <div id="gazePointer" aria-hidden="true"></div>

  <script>
    const arena = document.getElementById('arena');
    const dwellInput = document.getElementById('dwellInput');
    const countInput = document.getElementById('countInput');
    const dwellVal = document.getElementById('dwellVal');
    const countVal = document.getElementById('countVal');
    const resetBtn = document.getElementById('resetBtn');
    const startButton = document.getElementById('startButton');
    const startHint = document.getElementById('startHint');
    const langToggle = document.getElementById('langToggle');
    const gazePointer = document.getElementById('gazePointer');

    let dwellTime = Number(dwellInput.value);
    let bubbleCount = Number(countInput.value);
    let playing = false;
    let bubbles = [];
    let fireflies = [];
    const MAX_FIREFLIES = 140;
    let completionLock = false;

    const palette = [
      { base: '#ff9ea1', glow: 'rgba(255, 158, 161, 0.6)' },
      { base: '#ffe39d', glow: 'rgba(255, 227, 157, 0.6)' },
      { base: '#7be8f4', glow: 'rgba(123, 232, 244, 0.6)' },
      { base: '#c3b0ff', glow: 'rgba(195, 176, 255, 0.6)' },
      { base: '#a2e5ff', glow: 'rgba(162, 229, 255, 0.6)' },
      { base: '#92f3b3', glow: 'rgba(146, 243, 179, 0.6)' },
    ];

    function updateDwellLabel() {
      dwellVal.textContent = `${dwellTime} ms`;
    }

    function updateCountLabel() {
      countVal.textContent = `${bubbleCount}`;
    }

    function randBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    function pruneFireflies() {
      while (fireflies.length > MAX_FIREFLIES) {
        const oldest = fireflies.shift();
        if (!oldest) continue;
        oldest.el.remove();
      }
    }

    function spawnFireflies(x, y, count = 6, color) {
      const tone = color?.base || '#9cfaf0';
      const toneGlow = color?.glow || 'rgba(156, 250, 240, 0.55)';

      for (let i = 0; i < count; i++) {
        const flyEl = document.createElement('div');
        flyEl.className = 'firefly';
        const angle = randBetween(0, Math.PI * 2);
        const burstDistance = randBetween(30, 90);
        const targetX = x + Math.cos(angle) * burstDistance;
        const targetY = y + Math.sin(angle) * burstDistance;
        const scale = randBetween(0.85, 1.2);
        const vx = randBetween(-38, 38);
        const vy = randBetween(-32, 32);

        flyEl.style.setProperty('--x', `${x}px`);
        flyEl.style.setProperty('--y', `${y}px`);
        flyEl.style.setProperty('--scale', `${scale}`);
        flyEl.style.setProperty('--tone', tone);
        flyEl.style.setProperty('--tone-soft', toneGlow);
        flyEl.style.setProperty('--tone-dim', toneGlow.replace('0.55', '0.2'));
        flyEl.style.transition = 'transform 0.5s ease-out';

        arena.appendChild(flyEl);

        const fly = { el: flyEl, x: targetX, y: targetY, vx, vy };
        fireflies.push(fly);

        requestAnimationFrame(() => {
          flyEl.style.setProperty('--x', `${targetX}px`);
          flyEl.style.setProperty('--y', `${targetY}px`);
        });

        flyEl.addEventListener('transitionend', () => {
          flyEl.style.transition = 'none';
        }, { once: true });
      }

      pruneFireflies();
    }

    let orbitState = null;
    let orbitDone = false;
    let lastFrame = performance.now();
    function animateFireflies(now) {
      const dt = Math.min((now - lastFrame) / 1000, 0.05);
      lastFrame = now;
      const width = window.innerWidth;
      const height = window.innerHeight;

      if (orbitState) {
        const { start, duration, centerX, centerY, turns } = orbitState;
        const rawProgress = (now - start) / duration;
        const clamped = Math.min(Math.max(rawProgress, 0), 1);
        // ease in gently, glide, then ease out
        const eased = clamped < 0.5
          ? 2 * clamped * clamped
          : -1 + (4 - 2 * clamped) * clamped;
        const sweep = eased * (Math.PI * 2 * turns);

        fireflies.forEach((fly, i) => {
          const baseAngle = fly.orbitAngle || ((i / Math.max(fireflies.length, 1)) * Math.PI * 2);
          const angle = baseAngle + sweep;
          const radius = fly.orbitRadius || orbitState.radius;
          fly.x = centerX + Math.cos(angle) * radius;
          fly.y = centerY + Math.sin(angle) * radius;
          fly.el.style.setProperty('--x', `${fly.x}px`);
          fly.el.style.setProperty('--y', `${fly.y}px`);
        });

        if (clamped >= 1 && !orbitDone) {
          orbitDone = true;
          orbitState = null;
          fireflies.forEach((fly) => {
            fly.vx = randBetween(-26, 26);
            fly.vy = randBetween(-22, 22);
          });
          if (typeof orbitCompletionCallback === 'function') orbitCompletionCallback();
          orbitCompletionCallback = null;
        }
      } else {
        fireflies.forEach((fly) => {
          fly.x += fly.vx * dt;
          fly.y += fly.vy * dt;

          if (fly.x < 6 || fly.x > width - 6) {
            fly.vx *= -1;
            fly.x = Math.max(6, Math.min(width - 6, fly.x));
          }
          if (fly.y < 6 || fly.y > height - 6) {
            fly.vy *= -1;
            fly.y = Math.max(6, Math.min(height - 6, fly.y));
          }

          fly.el.style.setProperty('--x', `${fly.x}px`);
          fly.el.style.setProperty('--y', `${fly.y}px`);
        });
      }

      requestAnimationFrame(animateFireflies);
    }
    requestAnimationFrame(animateFireflies);

    function createBubble() {
      const size = randBetween(150, 240);
      const maxX = Math.max(40, window.innerWidth - size - 40);
      const x = randBetween(40, maxX);
      const y = randBetween(40, window.innerHeight - size - 40);
      const color = palette[Math.floor(Math.random() * palette.length)];

      const el = document.createElement('button');
      el.className = 'bubble';
      el.style.setProperty('--size', `${size}px`);
      el.style.setProperty('--x', `${x}px`);
      el.style.setProperty('--y', `${y}px`);
      const softGlow = color.glow.replace(/0\.[0-9]+/, '0.2');

      el.style.setProperty('--color-base', color.base);
      el.style.setProperty('--color-bright', '#fff');
      el.style.setProperty('--glow', color.glow);
      el.style.setProperty('--glow-soft', softGlow);
      el.style.setProperty('--glow-ring', color.base + 'cc');
      el.setAttribute('aria-label', 'cercle coloré');

      const bubble = { el, dwellFrame: null, size, color, x, y, popped: false };

      el.addEventListener('pointerenter', () => startDwell(bubble));
      el.addEventListener('pointerleave', () => cancelDwell(bubble));
      el.addEventListener('focus', () => startDwell(bubble));
      el.addEventListener('blur', () => cancelDwell(bubble));

      arena.appendChild(el);
      bubbles.push(bubble);
    }

    function clearBubbles() {
      bubbles.forEach(b => b.el.remove());
      bubbles = [];
    }

    function populate() {
      completionLock = false;
      clearBubbles();
      for (let i = 0; i < bubbleCount; i++) {
        createBubble();
      }
    }

    function checkRepopulate() {
      if (completionLock) return;
      if (bubbles.length && bubbles.every(b => b.popped)) {
        completionLock = true;
        playCompletionAnimation(() => {
          populate();
        });
      }
    }

    function startDwell(bubble) {
      cancelDwell(bubble);
      bubble.el.classList.add('dwell');
      const start = performance.now();

      const step = (now) => {
        const progress = Math.min((now - start) / dwellTime, 1);
        bubble.el.style.setProperty('--progress', `${progress * 360}deg`);
        bubble.el.style.setProperty('--progress-ratio', progress.toFixed(3));
        if (progress >= 1) {
          popBubble(bubble);
          return;
        }
        bubble.dwellFrame = requestAnimationFrame(step);
      };

      bubble.dwellFrame = requestAnimationFrame(step);
    }

    function cancelDwell(bubble) {
      bubble.el.classList.remove('dwell');
      bubble.el.style.setProperty('--progress', '0deg');
      bubble.el.style.setProperty('--progress-ratio', '0');
      if (bubble.dwellFrame) cancelAnimationFrame(bubble.dwellFrame);
      bubble.dwellFrame = null;
    }

    function popBubble(bubble) {
      cancelDwell(bubble);
      bubble.el.classList.add('pop');
      const centerX = bubble.x + bubble.size / 2;
      const centerY = bubble.y + bubble.size / 2;
      spawnFireflies(centerX, centerY, 7, bubble.color);
      setTimeout(() => {
        bubble.el.remove();
        bubble.popped = true;
        bubble.el.classList.remove('pop');
        checkRepopulate();
      }, 480);
    }

    let orbitCompletionCallback = null;
    function playCompletionAnimation(done) {
      const width = window.innerWidth;
      const height = window.innerHeight;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) * 0.34;
      const duration = 6200;

      if (!fireflies.length) {
        const fallbackColor = palette[Math.floor(Math.random() * palette.length)];
        spawnFireflies(centerX, centerY, 10, fallbackColor);
      }

      fireflies.forEach((fly, i) => {
        fly.orbitAngle = (i / Math.max(fireflies.length, 1)) * Math.PI * 2;
        fly.orbitRadius = radius * randBetween(0.82, 1.08);
        fly.vx = 0;
        fly.vy = 0;
      });

      orbitState = { start: performance.now(), duration, centerX, centerY, turns: 1.1, radius };
      orbitDone = false;
      orbitCompletionCallback = () => {
        completionLock = false;
        if (typeof done === 'function') done();
      };
    }

    /* controls */
    dwellInput.addEventListener('input', (e) => {
      dwellTime = Number(e.target.value);
      updateDwellLabel();
    });

    countInput.addEventListener('input', (e) => {
      bubbleCount = Number(e.target.value);
      updateCountLabel();
      populate();
    });

    resetBtn.addEventListener('click', populate);

    function requestFullscreen() {
      const el = document.documentElement;
      const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
      if (fn) fn.call(el);
    }

    function showPointer() {
      document.body.classList.add('hide-native-cursor');
      gazePointer.classList.add('show');
    }

    function hidePointer() {
      document.body.classList.remove('hide-native-cursor');
      gazePointer.classList.remove('show');
    }

    document.addEventListener('mousemove', (e) => {
      gazePointer.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
    });

    function startGame() {
      requestFullscreen();
      document.body.classList.add('playing');
      playing = true;
      startHint.style.display = 'none';
      showPointer();
    }

    startButton.addEventListener('click', startGame);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !playing) startGame();
    });

    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        playing = false;
        document.body.classList.remove('playing');
        hidePointer();
      }
    });

    function toggleLanguage() {
      const htmlEl = document.querySelector('html');
      const currentLang = htmlEl.getAttribute('lang') || 'fr';
      const nextLang = currentLang === 'fr' ? 'en' : currentLang === 'en' ? 'ja' : 'fr';
      htmlEl.setAttribute('lang', nextLang);
      document.querySelectorAll('.translate').forEach(el => {
        const text = el.dataset[nextLang];
        if (text) {
          el.textContent = text;
        }
      });
    }

    langToggle.addEventListener('click', toggleLanguage);

    updateDwellLabel();
    updateCountLabel();
    populate();
  </script>
</body>
</html>
