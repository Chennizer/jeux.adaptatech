<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="../images/binou.png" />
  <link rel="stylesheet" href="../css/ipadteachh.css" />
  <title>Taille – Petit, Moyen ou Grand</title>

  <script src="../js/themes.js"></script>
  <script src="js/games-config.js"></script>
  <script src="js/session-helpers.js"></script>
  <script src="js/reinforcer-overlay.js"></script>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    :root {
      --shell-max-width: 1100px;
      --shell-radius: 28px;
      --shell-padding: clamp(20px, 5vw, 40px);
      --shell-gap: clamp(20px, 4vw, 36px);
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.14);
      --success: #16a34a;
      --error: #dc2626;
      --surface: #ffffff;
      --text-primary: #0f172a;
      --text-muted: #475569;
    }

    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Nunito', 'Arial', sans-serif;
      background: linear-gradient(145deg, #e0f2fe 0%, #d4d4ff 50%, #f8fafc 100%);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(12px, 4vw, 32px);
    }

    .game-shell {
      width: min(100%, var(--shell-max-width));
      background: var(--surface);
      border-radius: var(--shell-radius);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
      padding: var(--shell-padding);
      display: flex;
      flex-direction: column;
      gap: var(--shell-gap);
      position: relative;
      overflow: hidden;
    }

    .game-header {
      display: flex;
      flex-direction: column;
      gap: clamp(8px, 2vw, 16px);
      align-items: center;
      text-align: center;
    }

    .activity-title {
      font-size: clamp(1.8rem, 2vw + 1rem, 2.6rem);
      font-weight: 800;
      letter-spacing: 0.02em;
    }

    .game-instruction {
      font-size: clamp(1.1rem, 1.2vw + 0.8rem, 1.4rem);
      color: var(--text-muted);
      max-width: 600px;
      margin: 0;
    }

    .size-prompt {
      font-size: clamp(2.4rem, 5vw, 3.4rem);
      font-weight: 900;
      text-transform: uppercase;
      padding: 0.3em 0.9em;
      border-radius: 999px;
      background: linear-gradient(120deg, rgba(37, 99, 235, 0.12), rgba(99, 102, 241, 0.12));
      color: var(--accent);
      border: 3px solid rgba(37, 99, 235, 0.28);
      letter-spacing: 0.08em;
    }

    .size-options {
      display: grid;
      gap: clamp(18px, 4vw, 32px);
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      align-items: end;
    }

    .size-option {
      position: relative;
      border: 4px solid transparent;
      border-radius: 28px;
      background: linear-gradient(160deg, rgba(148, 163, 184, 0.12), rgba(255, 255, 255, 0.75));
      padding: clamp(16px, 2.5vw, 24px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: clamp(12px, 2vw, 18px);
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.2);
      touch-action: manipulation;
    }

    .size-option:focus {
      outline: none;
      border-color: rgba(37, 99, 235, 0.6);
      box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.12);
    }

    .size-option:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.16);
    }

    .size-option.is-correct {
      border-color: rgba(22, 163, 74, 0.8);
      box-shadow: 0 18px 40px rgba(22, 163, 74, 0.22);
      background: linear-gradient(150deg, rgba(34, 197, 94, 0.12), rgba(240, 253, 244, 0.9));
    }

    .size-option.is-wrong {
      border-color: rgba(220, 38, 38, 0.85);
      box-shadow: 0 12px 22px rgba(220, 38, 38, 0.26);
      animation: shake 0.35s ease;
    }

    .size-figure {
      width: clamp(110px, 22vw, 220px);
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      position: relative;
    }

    .size-figure img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transform-origin: bottom center;
      transform: scale(var(--size-scale, 1));
      transition: transform 0.25s ease;
    }

    .size-option .size-label {
      font-size: clamp(1.1rem, 1.2vw + 0.8rem, 1.4rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      50% { transform: translateX(8px); }
      75% { transform: translateX(-8px); }
      100% { transform: translateX(0); }
    }

    #activityNumberOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.75);
      color: #fff;
      z-index: 10000;
      font-size: clamp(4rem, 10vw, 8rem);
      font-weight: 800;
      letter-spacing: 0.1em;
    }

    @media (max-width: 640px) {
      .game-shell {
        border-radius: 24px;
      }

      .size-options {
        grid-template-columns: 1fr;
      }

      .size-option {
        padding: clamp(14px, 4vw, 20px);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .size-option,
      .size-option img {
        transition: none;
      }

      .size-option:hover {
        transform: none;
      }
    }
  </style>
</head>
<body>
  <div id="activityNumberOverlay">
    <div class="number-text"></div>
  </div>

  <div class="game-shell">
    <header class="game-header">
      <div class="activity-title">Choisis la bonne taille</div>
      <p class="game-instruction">Observe le mot affiché puis touche l'image qui correspond : petit, moyen ou grand.</p>
      <div class="size-prompt" aria-live="polite">–</div>
    </header>

    <div class="size-options" id="size-options" aria-live="polite"></div>
  </div>

  <audio id="error-sound" src="" preload="auto"></audio>
  <audio id="word-reward-sound" src="" preload="auto"></audio>
  <audio id="final-reward-sound" src="" preload="auto"></audio>

  <script>
    (function () {
      'use strict';

      const DEFAULT_IMAGE = '../images/binou.png';

      function clamp(value, min, max) {
        const number = Number.parseInt(value, 10);
        if (Number.isNaN(number)) {
          return min;
        }
        return Math.min(Math.max(number, min), max);
      }

      function shuffle(array) {
        for (let index = array.length - 1; index > 0; index -= 1) {
          const j = Math.floor(Math.random() * (index + 1));
          [array[index], array[j]] = [array[j], array[index]];
        }
        return array;
      }

      function prettifyLabel(src) {
        if (!src || typeof src !== 'string') {
          return 'Illustration';
        }
        const fileName = src.split('/').pop() || '';
        const withoutExtension = fileName.replace(/\.[^.]+$/, '');
        const cleaned = withoutExtension.replace(/[-_]+/g, ' ').trim();
        if (!cleaned) {
          return 'Illustration';
        }
        return cleaned.split(' ').map(part => part ? part.charAt(0).toUpperCase() + part.slice(1) : '').join(' ');
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (!window.sessionHelpers || typeof window.sessionHelpers.ensureCurrentGame !== 'function') {
          console.warn('Session helpers not available.');
          return;
        }

        const session = window.sessionHelpers.ensureCurrentGame('taille');
        if (!session) {
          return;
        }

        const { themeData } = session;
        const options = window.sessionHelpers.getCurrentGameOptions(session) || {};
        const totalRounds = clamp(options.rounds, 1, 6);

        const promptEl = document.querySelector('.size-prompt');
        const optionsContainer = document.getElementById('size-options');

        const errorAudio = document.getElementById('error-sound');
        const successAudio = document.getElementById('word-reward-sound');
        const finalAudio = document.getElementById('final-reward-sound');

        if (errorAudio) {
          errorAudio.src = (themeData && themeData.errorSound) || '../sounds/error.mp3';
        }
        if (successAudio) {
          successAudio.src = (themeData && themeData.reinforcerSound) || '../sounds/success3.mp3';
        }
        if (finalAudio) {
          finalAudio.src = (themeData && themeData.finalRewardSound) || '../sounds/victory.mp3';
        }

        const reinforcerController = (window.sessionHelpers && typeof window.sessionHelpers.setupSharedReinforcer === 'function')
          ? window.sessionHelpers.setupSharedReinforcer(session)
          : null;

        function playAudio(audioEl) {
          if (!audioEl) {
            return;
          }
          audioEl.currentTime = 0;
          audioEl.play().catch(() => {});
        }

        function showFinalReinforcer() {
          playAudio(finalAudio);
          if (reinforcerController && typeof reinforcerController.show === 'function') {
            const reinforcerType = (session.selections && session.selections.reinforcerType) || 'shortvideo';
            reinforcerController.show({ reinforcerType });
          } else if (window.sessionHelpers && typeof window.sessionHelpers.advanceToNextGame === 'function') {
            window.sessionHelpers.advanceToNextGame();
          }
        }

        const baseImages = Array.isArray(themeData && themeData.transparentPNGs)
          ? themeData.transparentPNGs.filter(Boolean)
          : [];
        if (baseImages.length === 0) {
          baseImages.push(DEFAULT_IMAGE);
        }

        const sizes = ['petit', 'moyen', 'grand'];
        const sizeScale = {
          petit: 0.6,
          moyen: 0.85,
          grand: 1.1
        };

        let completedRounds = 0;
        let canInteract = true;

        function buildOption(size, imageSrc) {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'size-option';
          button.dataset.size = size;
          button.setAttribute('aria-label', `${size.toUpperCase()} – ${prettifyLabel(imageSrc)}`);

          const figure = document.createElement('div');
          figure.className = 'size-figure';
          figure.style.setProperty('--size-scale', sizeScale[size] || 1);

          const img = document.createElement('img');
          img.src = imageSrc;
          img.alt = `${size.toUpperCase()} – ${prettifyLabel(imageSrc)}`;
          figure.appendChild(img);

          const label = document.createElement('span');
          label.className = 'size-label';
          label.textContent = size.toUpperCase();

          button.appendChild(figure);
          button.appendChild(label);
          return button;
        }

        function renderRound() {
          canInteract = true;
          optionsContainer.innerHTML = '';

          const targetSize = sizes[Math.floor(Math.random() * sizes.length)];
          promptEl.textContent = targetSize.toUpperCase();

          const chosenImage = baseImages[Math.floor(Math.random() * baseImages.length)] || DEFAULT_IMAGE;

          const buttons = sizes.map(size => buildOption(size, chosenImage));
          shuffle(buttons).forEach(button => optionsContainer.appendChild(button));

          buttons.forEach(button => {
            button.addEventListener('click', () => {
              if (!canInteract) {
                return;
              }
              canInteract = false;

              const isCorrect = button.dataset.size === targetSize;
              if (isCorrect) {
                button.classList.add('is-correct');
                playAudio(successAudio);
                completedRounds += 1;
                const delay = completedRounds >= totalRounds ? 900 : 800;
                setTimeout(() => {
                  if (completedRounds >= totalRounds) {
                    showFinalReinforcer();
                  } else {
                    button.classList.remove('is-correct');
                    renderRound();
                  }
                }, delay);
              } else {
                button.classList.add('is-wrong');
                playAudio(errorAudio);
                setTimeout(() => {
                  button.classList.remove('is-wrong');
                  canInteract = true;
                }, 650);
              }
            });
          });
        }

        if (window.sessionHelpers && typeof window.sessionHelpers.showActivityOverlay === 'function') {
          window.sessionHelpers.showActivityOverlay(() => {
            if (typeof window.sessionHelpers.updateActivityMarker === 'function') {
              window.sessionHelpers.updateActivityMarker(session);
            }
            renderRound();
          }, session);
        } else {
          renderRound();
        }
      });
    })();
  </script>
</body>
</html>
