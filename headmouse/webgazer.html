<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WebGazer – Précision améliorée</title>

  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <!-- WebGazer -->
  <script src="https://cdn.jsdelivr.net/npm/webgazer@3.3.0/dist/webgazer.js"
          crossorigin="anonymous"></script>

  <style>
    html,body{margin:0;height:100%;background:#222;font-family:sans-serif;}
    #start-screen{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999}
    #start-btn{font:700 2rem sans-serif;color:#fff;background:#444;border:2px solid #888;border-radius:12px;padding:.8em 2em;cursor:pointer}
    .eye-pointer{position:fixed;width:36px;height:36px;border-radius:50%;background:rgba(255,200,0,.85);box-shadow:0 0 10px 4px #ffc800;transform:translate(-50%,-50%);pointer-events:none;z-index:10000}
    #score-box{position:fixed;top:16px;right:16px;color:#fff;background:#000a;padding:.4em .8em;border-radius:8px;z-index:9000}
    #menu-btn{position:fixed;bottom:16px;left:16px;font-size:2rem;color:#eee;background:none;border:none;cursor:pointer;padding:.1em .4em;border-radius:6px;z-index:9000}
    #menu-modal{position:fixed;inset:0;background:rgba(0,0,0,.82);display:none;align-items:center;justify-content:center;z-index:8000}
    #menu-content{background:#111;padding:2rem;border-radius:14px;color:#eee;display:flex;flex-direction:column;gap:1rem;align-items:center;}
    #camera-box{width:320px;height:240px;position:relative}
    #camera-box canvas,#camera-box video{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:8px;object-fit:contain}
    #calibration-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:10001}
    .calib-dot{position:absolute;width:30px;height:30px;border-radius:50%;background:red;transform:translate(-50%,-50%);cursor:pointer}
  </style>
</head>
<body>

  <div id="start-screen">
    <button id="start-btn">Démarrer</button>
  </div>
  <div id="score-box" style="display:none">Score : 0</div>
  <button id="menu-btn" style="display:none">☰</button>

  <div id="menu-modal">
    <div id="menu-content">
      <h2>Options</h2>
      <div id="camera-box"></div>
      <button id="calib-btn">Calibrer</button>
      <button id="toggle-points">Afficher les points</button>
      <button id="close-menu">Fermer</button>
      <p style="font-size:.85rem;opacity:.7">Touche « M » ouvre/ferme</p>
    </div>
  </div>

  <script>
    let pointerX=innerWidth/2, pointerY=innerHeight/2;
    let showDots=false, score=0;

    // pointer
    const dot = document.body.appendChild(
      Object.assign(document.createElement('div'),{className:'eye-pointer'})
    );

    // DOM shortcuts
    const $=id=>document.getElementById(id);
    const startScr=$('start-screen'), startBtn=$('start-btn');
    const scoreBox=$('score-box'), menuBtn=$('menu-btn');
    const menuModal=$('menu-modal'), calibBtn=$('calib-btn');
    const closeMenu=$('close-menu'), toggleBtn=$('toggle-points');
    const camBox=$('camera-box');

    // calibration points
    const cPoints=[
      {x:.1,y:.1},{x:.5,y:.1},{x:.9,y:.1},
      {x:.1,y:.5},{x:.5,y:.5},{x:.9,y:.5},
      {x:.1,y:.9},{x:.5,y:.9},{x:.9,y:.9}
    ];
    let overlay, idx=0, clicks=0;
    function startCalibration(){
      if(overlay) return;
      idx=0; clicks=0;
      overlay=document.createElement('div');
      overlay.id='calibration-overlay';
      document.body.appendChild(overlay);
      nextCalibDot();
    }
    function nextCalibDot(){
      if(idx>=cPoints.length){
        overlay.remove(); overlay=null;
        alert('Calibration terminée !');
        return;
      }
      const cp=cPoints[idx];
      const d=document.createElement('div');
      d.className='calib-dot';
      d.style.left=`${cp.x*100}%`; d.style.top=`${cp.y*100}%`;
      overlay.innerHTML=''; overlay.appendChild(d);
      d.onclick=()=>{
        webgazer.recordScreenPosition(cp.x*innerWidth,cp.y*innerHeight,'click');
        clicks++;
        if(clicks>=5){ idx++; clicks=0; nextCalibDot(); }
      };
    }

    // start logic
    async function start(){
      if(!document.fullscreenElement){
        try{ await document.documentElement.requestFullscreen(); }catch{}
      }
      startScr.style.display='none';
      menuBtn.style.display='block';
      scoreBox.style.display='block';

      await webgazer
        .begin()
        .applyKalmanFilter(true)              // <-- smoother filter
        .showVideo(true)
        .showFaceOverlay(true)
        .showPredictionPoints(showDots)
        .saveDataAcrossSessions(false);

      // move video & canvases into camera box
      (function moveEls(){
        const ids=['webgazerVideoFeed','webgazerFaceOverlay','webgazerFaceFeedback'];
        const vid=document.getElementById('webgazerVideoFeed');
        if(!vid) return requestAnimationFrame(moveEls);
        ids.forEach(id=>{
          const el=document.getElementById(id);
          if(el){ el.style.position='absolute'; camBox.appendChild(el); }
        });
      })();

      // gaze listener with exponential smoothing
      const smoothingFactor=0.2;  // adjust 0<→1 (lower = slower / smoother)
      webgazer.setGazeListener(data=>{
        if(!data||data.confidence<.15) return;
        const rawX=data.x, rawY=data.y;
        pointerX += (rawX - pointerX)*smoothingFactor;
        pointerY += (rawY - pointerY)*smoothingFactor;
        dot.style.left=pointerX+'px';
        dot.style.top =pointerY+'px';
      }).begin();
    }

    // menu & shortcuts
    function toggleMenu(){
      menuModal.style.display = menuModal.style.display==='flex'?'none':'flex';
    }
    startBtn.onclick=start;
    menuBtn.onclick=toggleMenu;
    closeMenu.onclick=toggleMenu;
    calibBtn.onclick=startCalibration;
    toggleBtn.onclick=()=>{
      showDots=!showDots;
      webgazer.showPredictionPoints(showDots);
      toggleBtn.textContent=showDots?'Cacher les points':'Afficher les points';
    };
    window.addEventListener('keydown',e=>{
      if(e.key.toLowerCase()==='m' && startScr.style.display==='none'){
        e.preventDefault(); toggleMenu();
      }
    });

    // p5 game
    new p5(p=>{
      let tgt={x:0,y:0,r:40,c:'#00b7ff'};
      function spawn(){
        tgt.x=p.random(60,p.width-60);
        tgt.y=p.random(60,p.height-60);
        tgt.r=p.random(30,60);
        tgt.c=p.color(p.random(80,255),p.random(80,255),p.random(80,255));
      }
      p.setup=()=>{
        p.createCanvas(innerWidth,innerHeight).position(0,0).style('z-index','0');
        spawn();
      };
      p.windowResized=()=>p.resizeCanvas(innerWidth,innerHeight);
      p.draw=()=>{
        p.clear(); p.noStroke(); p.fill(tgt.c);
        p.circle(tgt.x,tgt.y,tgt.r*2);
        if(p.dist(pointerX,pointerY,tgt.x,tgt.y)<tgt.r){
          score++; scoreBox.textContent='Score : '+score; spawn();
        }
      };
    });
  </script>
</body>
</html>
