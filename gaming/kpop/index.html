<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title 
    class="translate"
    data-fr="K-pop Demon Hunter"
    data-en="K-pop Demon Hunter">
    K-pop Demon Hunter
  </title>

  <!-- Shared site styles -->
  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Quicksand", "Segoe UI", system-ui, sans-serif;
      min-height: 100vh;
      background: #03000a;
      color: #fef6ff;
      overflow: hidden;
    }

    /* ====== stage visuals ====== */
    .stage {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center 120%, rgba(180, 120, 255, 0.16), rgba(5, 0, 15, 0.95)),
                  radial-gradient(circle at 50% 20%, rgba(255, 245, 200, 0.12), rgba(0, 0, 0, 0.95));
      overflow: hidden;
    }
    .stage::before,
    .stage::after {
      content: "";
      position: absolute;
      inset: -30%;
      background: conic-gradient(from 120deg, rgba(255, 79, 172, 0.1), rgba(111, 72, 255, 0.25), rgba(255, 79, 172, 0.1));
      opacity: 0.6;
      filter: blur(60px);
      transform-origin: center;
      animation: aurora 14s linear infinite;
      pointer-events: none;
    }
    .stage::after { animation-direction: reverse; opacity: 0.45; }

    @keyframes aurora {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.08); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .stage-entry {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 50%, rgba(15, 3, 30, 0.9) 0%, rgba(3, 0, 10, 0.95) 55%, rgba(0, 0, 0, 1) 100%);
      transform: scale(1.35);
      opacity: 1;
      animation: stageReveal 2.6s cubic-bezier(.23,1,.32,1) forwards;
      pointer-events: none;
      z-index: 0;
    }
    @keyframes stageReveal {
      0% { opacity: 0; transform: scale(1.6); }
      20% { opacity: 1; transform: scale(1.6); }
      55% { opacity: 1; transform: scale(1.15); }
      100% { opacity: 0; transform: scale(1); }
    }

    /* ====== idols bottom-left in an L ====== */
    .silhouette-grid {
      position: absolute;
      bottom: clamp(16px, 4vh, 28px);
      left: clamp(16px, 3vw, 32px);
      display: grid;
      grid-template-columns: auto auto;
      grid-template-rows: auto auto;
      gap: clamp(16px, 3vw, 24px);
      align-items: end;
      z-index: 1;
      pointer-events: none;
    }
    .silhouette[data-hero="mira"] { grid-column: 1; grid-row: 1; }
    .silhouette[data-hero="zoey"] { grid-column: 1; grid-row: 2; }
    .silhouette[data-hero="rumi"] { grid-column: 2; grid-row: 2; }

    .silhouette {
      width: clamp(150px, 18vw, 260px);
      aspect-ratio: 3 / 4;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center bottom;
      filter: brightness(0) saturate(0);
      opacity: 0.95;
      transform-origin: bottom center;
      animation: idleBreathe 6s ease-in-out infinite;
      transition: transform 360ms cubic-bezier(.25, .9, .35, 1.4), opacity 360ms ease, filter 360ms ease;
    }
    .silhouette.active {
      opacity: 1;
      filter: brightness(0.22) saturate(0) drop-shadow(0 0 26px rgba(255, 90, 210, 0.45));
      animation: spotlightPulse 1.2s ease-in-out infinite;
    }
    .silhouette.popping {
      opacity: 0;
      transform: translateY(-18px) scale(1.16);
      filter: brightness(0.65) saturate(240%);
      animation: none;
    }
    @keyframes idleBreathe { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-6px) scale(1.02)} }
    @keyframes spotlightPulse { 0%,100%{transform:translateY(-10px) scale(1.05)} 50%{transform:translateY(-4px) scale(1.03)} }

    /* ====== monsters on right ====== */
    .monster-area { position:absolute; inset:0; pointer-events:none; z-index:2; }
    .monster {
      position: absolute;
      width: clamp(140px, 20vw, 220px);
      aspect-ratio: 1;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 0 28px rgba(255, 55, 155, 0.7));
      opacity: 0;
      transform: translate3d(-50%, -50%, 0) scale3d(0.2,0.2,1) rotate(-14deg);
      animation: monsterRise 1s cubic-bezier(.22,1.13,.59,1) forwards;
      overflow: visible;
      will-change: transform, opacity, filter;
      backface-visibility: hidden;
    }
    @keyframes monsterRise {
      0% { opacity: 0; transform: translate3d(-50%, calc(-50% + 120px), 0) scale3d(0.35,0.35,1) rotate(-12deg); }
      60% { opacity: 1; transform: translate3d(-50%, calc(-50% - 12px), 0) scale3d(1.05,1.05,1) rotate(4deg); }
      100% { opacity: 1; transform: translate3d(-50%, -50%, 0) scale3d(1,1,1) rotate(0deg); }
    }
    .monster.banish { animation: monsterBanish 420ms ease-in forwards; }
    @keyframes monsterBanish {
      0% { opacity: 1; transform: translate3d(-50%, -50%, 0) scale3d(1,1,1); filter: drop-shadow(0 0 32px rgba(255,150,230,0.8)); }
      70% { opacity: 0.35; transform: translate3d(-50%, calc(-50% - 40px), 0) scale3d(0.7,0.7,1); }
      100%{ opacity: 0; transform: translate3d(-50%, calc(-50% - 120px),0) scale3d(0.35,0.35,1); }
    }

    /* ===== Idol appear (SMOOTH, ~80vh final, FX) ===== */
    .hero-action {
      position: absolute;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center bottom;
      transform-origin: bottom left;
      opacity: 0;
      pointer-events: none;
      filter: drop-shadow(0 0 8px rgba(255, 140, 240, 0));
      z-index: 4;

      /* Smoothing hints */
      will-change: transform, filter, opacity;
      backface-visibility: hidden;
    }

    /* smoother cubic-bezier and extra keyframe stops for continuous growth */
    .hero-action.from-shadow { 
      animation: heroFromShadow 2000ms cubic-bezier(.22,.85,.25,1) forwards;
    }
    @keyframes heroFromShadow {
      0%   { opacity: 0; transform: translate3d(0, 40px, 0) scale3d(0.22,0.22,1); filter: drop-shadow(0 0 0 rgba(255,140,240,0.0)); }
      20%  { opacity: 0.9; transform: translate3d(0, 10px, 0) scale3d(0.55,0.55,1); filter: drop-shadow(0 0 10px rgba(255,140,240,0.25)); }
      40%  { opacity: 1;   transform: translate3d(0, -4px, 0) scale3d(0.78,0.78,1); filter: drop-shadow(0 0 18px rgba(255,150,245,0.4)); }
      60%  { opacity: 1;   transform: translate3d(0, -2px, 0) scale3d(0.92,0.92,1); filter: drop-shadow(0 0 22px rgba(255,165,250,0.5)); }
      80%  { opacity: 1;   transform: translate3d(0, -1px, 0) scale3d(0.98,0.98,1); filter: drop-shadow(0 0 24px rgba(255,175,255,0.55)); }
      100% { opacity: 1;   transform: translate3d(0, 0, 0)    scale3d(1.00,1.00,1); filter: drop-shadow(0 0 26px rgba(255,185,255,0.6)); }
    }
    .hero-action.exit { animation: heroFade 420ms cubic-bezier(.55,.02,.72,.53) forwards; }
    @keyframes heroFade { 0%{opacity:1;transform:translate3d(0,0,0) scale3d(1,1,1)} 100%{opacity:0;transform:translate3d(0,24px,0) scale3d(0.82,0.82,1)} }

    /* Aura ring + entrance sparkles (unchanged) */
    .hero-aura {
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
      margin: auto; width: 60%; height: 60%;
      border-radius: 50%; pointer-events: none; opacity: 0;
      box-shadow: 0 0 40px 10px rgba(255,180,255,0.25) inset, 0 0 40px rgba(255,180,255,0.35);
      mix-blend-mode: screen; animation: auraPulse 1400ms ease-out forwards; z-index: -1;
      will-change: transform, opacity; backface-visibility: hidden;
    }
    @keyframes auraPulse {
      0%   { opacity: 0; transform: scale(0.6); }
      25%  { opacity: 0.9; transform: scale(1.05); }
      60%  { opacity: 0.5; transform: scale(1.20); }
      100% { opacity: 0; transform: scale(1.35); }
    }
    .hero-spark {
      position: absolute; width: 6px; height: 2px; left: 50%; top: 70%;
      background: white; border-radius: 2px; mix-blend-mode: screen; opacity: 0.95;
      transform-origin: left center; animation: heroSparkFly 900ms ease-out forwards;
      pointer-events: none; z-index: 3; will-change: transform, opacity; backface-visibility: hidden;
    }
    @keyframes heroSparkFly {
      0%   { transform: translate3d(-50%,-50%,0) rotate(var(--ang)) scaleX(0.3); opacity: 1; }
      65%  { transform: translate3d(calc(-50% + var(--dx)), calc(-50% + var(--dy)), 0) rotate(var(--ang)) scaleX(1.05); opacity: 0.9; }
      100% { transform: translate3d(calc(-50% + var(--dx2)), calc(-50% + var(--dy2)), 0) rotate(var(--ang)) scaleX(0.8); opacity: 0; }
    }

    /* ===== X-shaped slice on demon (unchanged) ===== */
    .slice-x {
      position: absolute; left: 50%; top: 50%; height: 12px; width: 170%;
      transform-origin: center center; border-radius: 8px;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 30%,
                                  rgba(255,224,150,0.95) 49%, rgba(255,120,210,0.9) 51%,
                                  rgba(255,255,255,0.2) 70%, rgba(255,255,255,0) 100%);
      mix-blend-mode: screen;
      box-shadow: 0 0 26px rgba(255,210,255,0.6), 0 0 12px rgba(255,240,210,0.85) inset;
      opacity: 0; pointer-events: none; z-index: 3;
      transform: translate3d(-50%,-50%,0) rotate(var(--rot)) scale3d(0.05,1,1);
      animation: sliceXGrow var(--dur, 340ms) ease-out forwards;
      will-change: transform, opacity; backface-visibility: hidden;
    }
    @keyframes sliceXGrow {
      0%   { opacity: 0; transform: translate3d(-50%,-50%,0) rotate(var(--rot)) scale3d(0.05,1,1); }
      35%  { opacity: 1; transform: translate3d(-50%,-50%,0) rotate(var(--rot)) scale3d(1.02,1,1); }
      100% { opacity: 0; transform: translate3d(-50%,-50%,0) rotate(var(--rot)) scale3d(1.2,1,1); }
    }

    .hit-flare {
      position: absolute; left:50%; top:50%; width:240px; height:240px;
      transform: translate3d(-50%,-50%,0) scale3d(0.2,0.2,1);
      background: radial-gradient(circle, rgba(255,255,255,0.85) 0%, rgba(255,220,120,0.6) 40%, rgba(255,0,165,0) 70%);
      mix-blend-mode: screen; opacity: 0; pointer-events:none; z-index:2;
      animation: flare 360ms ease-out forwards; will-change: transform, opacity; backface-visibility: hidden;
    }
    @keyframes flare {
      0%   { opacity: 0; transform: translate3d(-50%,-50%,0) scale3d(0.2,0.2,1); }
      40%  { opacity: 0.85; transform: translate3d(-50%,-50%,0) scale3d(1.05,1.05,1); }
      100% { opacity: 0; transform: translate3d(-50%,-50%,0) scale3d(1.5,1.5,1); }
    }

    .spark {
      position: absolute; left:50%; top:50%; width:6px; height:2px; background:white; mix-blend-mode:screen;
      border-radius:2px; opacity:0.95; transform-origin:left center; pointer-events:none; z-index:3;
      animation: sparkFly 420ms ease-out forwards; will-change: transform, opacity; backface-visibility:hidden;
    }
    @keyframes sparkFly {
      0%   { transform: translate3d(-50%,-50%,0) rotate(var(--ang)) scaleX(0.2); opacity: 1; }
      70%  { transform: translate3d(calc(-50% + var(--dx)), calc(-50% + var(--dy)), 0) rotate(var(--ang)) scaleX(1); opacity: 0.9; }
      100% { transform: translate3d(calc(-50% + var(--dx2)), calc(-50% + var(--dy2)), 0) rotate(var(--ang)) scaleX(0.8); opacity: 0; }
    }

    /* ===== language toggle (menu) ===== */
    #langToggle{
      position: fixed; top:10px; right:10px; z-index:99999;
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:10px; border:2px solid #009688;
      background:#fff; color:#009688; font-weight:700; cursor:pointer;
      user-select:none;
    }
    body.dark #langToggle { background:#111; color:#00b3a4; border-color:#00b3a4; }
    #options-inline-container{ align-items: start; }

    @media (max-width: 768px) {
      .silhouette { width: clamp(130px, 28vw, 200px); }
    }

    /* accessibility: reduce motion */
    @media (prefers-reduced-motion: reduce) {
      .hero-action.from-shadow { animation-duration: 800ms; }
    }
  </style>
</head>
<body class="dark">
  <!-- Language toggle -->
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <!-- ===== Options modal (unchanged) ===== -->
  <div id="game-options" class="modal" style="display:flex;">
    <div id="options-title-bar">
      <h2 id="options-main-title" class="translate"
          data-fr="K-pop Demon Hunter"
          data-en="K-pop Demon Hunter">K-pop Demon Hunter</h2>
    </div>

    <div id="control-panel-options">
      <div id="mode-divider"></div>

      <div id="options-inline-container">
        <div class="options-column">
          <div class="option-item">
            <label for="sfxVol" class="teal-label">
              <span class="translate" data-fr="Volume des sons:" data-en="Sound volume:">Volume des sons:</span>
              <span id="sfxVolVal">100</span>
            </label>
            <input type="range" id="sfxVol" class="styled-slider" min="0" max="100" value="100">
          </div>
          <div class="option-item">
            <label class="teal-label">
              <input type="checkbox" id="muteSFX">
              <span class="translate" data-fr="Désactiver les sons" data-en="Disable sounds">Désactiver les sons</span>
            </label>
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label for="themeSelect" class="teal-label label-block translate"
                   data-fr="Mode" data-en="Theme">Mode</label>
            <select id="themeSelect" class="styled-select">
              <option value="dark" selected class="translate" data-fr="Sombre" data-en="Dark">Sombre</option>
              <option value="light" class="translate" data-fr="Clair" data-en="Light">Clair</option>
            </select>
          </div>

          <div class="option-item">
            <label for="difficultyRange" class="teal-label">
              <span class="translate" data-fr="Difficulté:" data-en="Difficulty:">Difficulté:</span>
              <span id="difficultyLabel">Facile</span>
            </label>
            <input type="range" id="difficultyRange" class="styled-slider" min="1" max="3" step="1" value="1">
            <div style="display:flex; justify-content:space-between; font-size:12px; opacity:0.8; margin-top:4px;">
              <span class="translate" data-fr="Facile" data-en="Easy">Facile</span>
              <span class="translate" data-fr="Moyen"  data-en="Medium">Moyen</span>
              <span class="translate" data-fr="Difficile" data-en="Hard">Difficile</span>
            </div>
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label for="effectSelect" class="teal-label label-block translate"
                   data-fr="Effet de fin" data-en="End effect">Effet de fin</label>
            <select id="effectSelect" class="styled-select">
              <option value="explosion" selected class="translate" data-fr="Boom!" data-en="Boom!">Explosion</option>
              <option value="shrink" class="translate" data-fr="Classique" data-en="Classic">Réduction</option>
            </select>
          </div>

          <div class="option-item">
            <label for="intensityRange" class="teal-label">
              <span class="translate" data-fr="Intensité explosion (base):" data-en="Explosion intensity (base):">Intensité explosion (base):</span>
              <span id="intensityVal">2.20</span>
            </label>
            <input type="range" id="intensityRange" class="styled-slider" min="1.0" max="3.0" step="0.05" value="2.2">
          </div>
        </div>
      </div>

      <div id="mode-divider"></div>
      <button id="startButton" class="button translate" data-fr="Commencer" data-en="Start">Commencer</button>
    </div>
  </div>

  <!-- ===== Game stage ===== -->
  <div class="stage" id="stage" aria-hidden="true">
    <div class="stage-entry" aria-hidden="true"></div>

    <div class="silhouette-grid" aria-hidden="true">
      <div class="silhouette" data-hero="mira" style="background-image:url('../../images/kpop/mira.png')"></div>
      <div class="silhouette" data-hero="zoey" style="background-image:url('../../images/kpop/zoey.png')"></div>
      <div class="silhouette" data-hero="rumi" style="background-image:url('../../images/kpop/rumi.png')"></div>
    </div>

    <div class="monster-area" id="monsterArea"></div>
  </div>

  <script>
    /* ===================== i18n ===================== */
    const LS_LANG_KEY = 'siteLanguage';
    const langToggle  = document.getElementById('langToggle');
    function getLang(){ try{const s=localStorage.getItem(LS_LANG_KEY); if(s==='en'||s==='fr') return s;}catch(e){} return (document.documentElement.lang==='en')?'en':'fr'; }
    function setLang(lang){
      const safe = (lang==='en')?'en':'fr';
      document.documentElement.lang = safe;
      try{ localStorage.setItem(LS_LANG_KEY, safe);}catch(e){}
      document.querySelectorAll('.translate').forEach(el=>{
        const fr=el.getAttribute('data-fr'); const en=el.getAttribute('data-en');
        if(safe==='fr' && fr!=null) el.textContent=fr;
        if(safe==='en' && en!=null) el.textContent=en;
      });
    }
    (function(){ let initial='fr'; try{const s=localStorage.getItem(LS_LANG_KEY); initial=(s==='en'||s==='fr')?s:((document.documentElement.lang==='en')?'en':'fr'); localStorage.setItem(LS_LANG_KEY, initial);}catch(e){ initial=(document.documentElement.lang==='en')?'en':'fr'; } setLang(initial); })();
    langToggle.addEventListener('click', ()=> setLang(getLang()==='fr' ? 'en' : 'fr'));

    /* ===================== Menu bindings ===================== */
    const startBtn        = document.getElementById('startButton');
    const muteSFX         = document.getElementById('muteSFX');
    const sfxVol          = document.getElementById('sfxVol');
    const sfxVolVal       = document.getElementById('sfxVolVal');
    const effectSel       = document.getElementById('effectSelect');
    const themeSelect     = document.getElementById('themeSelect');
    const intensityEl     = document.getElementById('intensityRange');
    const intensityVal    = document.getElementById('intensityVal');
    const difficultyRange = document.getElementById('difficultyRange');
    const difficultyLabel = document.getElementById('difficultyLabel');

    const DIFF_MAP = { 1: 'easy', 2: 'medium', 3: 'hard' };
    const DIFF_LABELS = {
      fr: { easy: 'Facile', medium: 'Moyen', hard: 'Difficile' },
      en: { easy: 'Easy',   medium: 'Medium', hard: 'Hard' }
    };
    function updateDifficultyLabel(){
      const lang = getLang();
      const diff = DIFF_MAP[difficultyRange.value|0] || 'easy';
      difficultyLabel.textContent = DIFF_LABELS[lang][diff];
    }
    difficultyRange.addEventListener('input', updateDifficultyLabel);
    sfxVol.addEventListener('input', ()=> { sfxVolVal.textContent = sfxVol.value; });
    intensityEl.addEventListener('input', ()=> { intensityVal.textContent = (+intensityEl.value).toFixed(2); });
    updateDifficultyLabel();

    function applyTheme(theme){
      const isDark = theme === 'dark';
      document.body.style.backgroundColor = isDark ? '#03000a' : '#ffffff';
      document.body.style.color = isDark ? '#fef6ff' : '#000000';
      document.body.classList.toggle('dark', isDark);
    }

    let started=false, difficulty='easy', spawnTimer=null;

    startBtn.addEventListener('click', () => {
      applyTheme(themeSelect.value);
      document.getElementById('langToggle').style.display = 'none';
      document.getElementById('game-options').style.display = 'none';

      const rootEl = document.documentElement;
      if (rootEl.requestFullscreen) rootEl.requestFullscreen().catch(()=>{});
      else if (rootEl.webkitRequestFullscreen) rootEl.webkitRequestFullscreen();

      difficulty = DIFF_MAP[difficultyRange.value|0] || 'easy';
      started = true;
      document.getElementById('stage')?.setAttribute('aria-hidden','false');

      if (difficulty === 'easy') ensureMusic(true);
      setTimeout(spawnMonster, 800);
      if (difficulty === 'medium') spawnTimer = setInterval(spawnMonster, 15000);
      else if (difficulty === 'hard') spawnTimer = setInterval(spawnMonster, 10000);
    });

    /* ===================== Game logic ===================== */
    const heroes = [
      { id: 'mira', sprite: "../../images/kpop/mira.png" },
      { id: 'zoey', sprite: "../../images/kpop/zoey.png" },
      { id: 'rumi', sprite: "../../images/kpop/rumi.png" }
    ];
    const monsters = [
      "../../images/kpop/monster1.png",
      "../../images/kpop/monster2.png"
    ];

    const state = {
      monsters: [],
      heroElement: null,
      attackInProgress: false,
      music: null,
      musicStarted: false,
      activeSilhouette: null
    };

    const monsterArea = document.getElementById('monsterArea');
    const stage = document.getElementById('stage');

    function ensureMusic(forcePlay=false) {
      if (!state.music) {
        const audio = new Audio("../../songs/kpop/golden.mp3");
        audio.loop = true;
        audio.volume = Math.max(0, Math.min(1, (parseInt(sfxVol.value,10)||100)/100));
        state.music = audio;
      } else {
        state.music.volume = Math.max(0, Math.min(1, (parseInt(sfxVol.value,10)||100)/100));
      }
      if (document.getElementById('muteSFX').checked) { state.music.pause(); state.musicStarted=false; return; }
      if ((forcePlay || !state.musicStarted) && state.music) {
        state.musicStarted = true;
        state.music.play().catch(() => { state.musicStarted = false; });
      }
    }
    function pauseMusic(){ if (state.music) { state.music.pause(); state.musicStarted=false; } }
    function updateMusicByDifficulty(){
      if (difficulty === 'easy') { ensureMusic(true); return; }
      const count = state.monsters.length;
      if (difficulty === 'medium') { if (count >= 4) pauseMusic(); else ensureMusic(); }
      else if (difficulty === 'hard') { if (count >= 2) pauseMusic(); else ensureMusic(); }
    }

    function highlightSilhouette(id) {
      let target = null;
      document.querySelectorAll('.silhouette').forEach(el => {
        const isMatch = el.dataset.hero === id;
        el.classList.toggle('active', isMatch);
        if (isMatch) target = el; else el.classList.remove('popping');
      });
      state.activeSilhouette = target;
      return target;
    }
    function clearHighlight(){ document.querySelectorAll('.silhouette').forEach(el=>el.classList.remove('active','popping')); state.activeSilhouette = null; }

    const randRange = (a,b)=> a + Math.random()*(b-a);

    function spawnMonster() {
      if (!started || !monsterArea) return;
      if (difficulty === 'easy' && state.monsters.length >= 1) return;

      const monster = document.createElement('div');
      monster.className = 'monster';
      monster.style.backgroundImage = `url('${monsters[Math.floor(Math.random() * monsters.length)]}')`;

      const stageRect = stage.getBoundingClientRect();
      const x = randRange(stageRect.width * 0.60, stageRect.width * 0.92);
      const y = randRange(stageRect.height * 0.18, stageRect.height * 0.82);

      monster.style.left = `${x}px`;
      monster.style.top  = `${y}px`;

      monsterArea.appendChild(monster);
      state.monsters.push(monster);
      updateMusicByDifficulty();
    }

    function removeMonster(mon) {
      if (!mon) return;
      state.monsters = state.monsters.filter(m => m !== mon);
      mon.classList.add('banish');
      mon.addEventListener('animationend', () => mon.remove(), { once: true });
      updateMusicByDifficulty();
      if (difficulty === 'easy') setTimeout(spawnMonster, 1600);
    }

    /* ===== ENTRANCE FX ===== */
    function makeHeroAura(heroDiv){
      const aura = document.createElement('div');
      aura.className = 'hero-aura';
      heroDiv.appendChild(aura);
      aura.addEventListener('animationend', ()=> aura.remove(), {once:true});
    }
    function makeHeroSparks(heroDiv){
      const N = 10 + Math.floor(Math.random()*6);
      for (let i=0;i<N;i++){
        const sp = document.createElement('div');
        sp.className = 'hero-spark';
        const ang = (Math.random()*Math.PI*2);
        const r1 = 30 + Math.random()*60;
        const r2 = 90 + Math.random()*120;
        sp.style.setProperty('--ang', ang+'rad');
        sp.style.setProperty('--dx',  Math.cos(ang)*r1+'px');
        sp.style.setProperty('--dy',  Math.sin(ang)*r1+'px');
        sp.style.setProperty('--dx2', Math.cos(ang)*r2+'px');
        sp.style.setProperty('--dy2', Math.sin(ang)*r2+'px');
        heroDiv.appendChild(sp);
        sp.addEventListener('animationend', ()=> sp.remove(), {once:true});
      }
    }

    /* ===== HERO SHOW/HIDE (80vh final, smooth) ===== */
    function showHero(hero, silhouetteEl) {
      if (!silhouetteEl || !stage) return;

      silhouetteEl.classList.add('popping');

      const sRect  = silhouetteEl.getBoundingClientRect();
      const stRect = stage.getBoundingClientRect();

      const targetH = Math.min(window.innerHeight * 0.80, stRect.height * 0.80);
      const ratio   = sRect.width / sRect.height || (3/4);
      const targetW = targetH * ratio;

      const left = sRect.left - stRect.left;
      const top  = (sRect.bottom - stRect.top) - targetH;

      const heroDiv = document.createElement('div');
      heroDiv.className = 'hero-action from-shadow';
      heroDiv.style.backgroundImage = `url('${hero.sprite}')`;
      heroDiv.style.left   = `${left}px`;
      heroDiv.style.top    = `${top}px`;
      heroDiv.style.width  = `${targetW}px`;
      heroDiv.style.height = `${targetH}px`;

      makeHeroAura(heroDiv);
      makeHeroSparks(heroDiv);

      stage.appendChild(heroDiv);
      state.heroElement = heroDiv;
    }

    function hideHero() {
      const silhouette = state.activeSilhouette;
      if (!state.heroElement) {
        if (silhouette) silhouette.classList.remove('popping');
        return Promise.resolve();
      }
      const hero = state.heroElement;
      return new Promise(resolve => {
        hero.classList.remove('from-shadow');
        hero.classList.add('exit');
        hero.addEventListener('animationend', () => {
          hero.remove();
          if (state.heroElement === hero) state.heroElement = null;
          if (silhouette) silhouette.classList.remove('popping');
          resolve();
        }, { once: true });
      });
    }

    /* ===== DEMON HIT FX (X-cut) ===== */
    function makeSparks(mon, baseAngleRad){
      const N = 7 + Math.floor(Math.random()*5);
      for(let i=0;i<N;i++){
        const sp = document.createElement('div');
        sp.className = 'spark';
        const a = baseAngleRad + (Math.random()*Math.PI/2 - Math.PI/4); // ±45°
        const mag1 = 22 + Math.random()*26;
        const mag2 = 52 + Math.random()*38;
        sp.style.setProperty('--ang', a+'rad');
        sp.style.setProperty('--dx',  Math.cos(a)*mag1+'px');
        sp.style.setProperty('--dy',  Math.sin(a)*mag1+'px');
        sp.style.setProperty('--dx2', Math.cos(a)*mag2+'px');
        sp.style.setProperty('--dy2', Math.sin(a)*mag2+'px');
        mon.appendChild(sp);
        sp.addEventListener('animationend', ()=> sp.remove(), {once:true});
      }
    }
    function sliceXOnMonster(mon){
      const arm1 = document.createElement('div'); arm1.className = 'slice-x'; arm1.style.setProperty('--rot','45deg');  arm1.style.setProperty('--dur','360ms');
      const arm2 = document.createElement('div'); arm2.className = 'slice-x'; arm2.style.setProperty('--rot','-45deg'); arm2.style.setProperty('--dur','380ms');
      mon.appendChild(arm1); mon.appendChild(arm2);
      arm1.addEventListener('animationend', ()=> arm1.remove(), {once:true});
      arm2.addEventListener('animationend', ()=> arm2.remove(), {once:true});

      const flare = document.createElement('div'); flare.className = 'hit-flare'; mon.appendChild(flare);
      flare.addEventListener('animationend', ()=> flare.remove(), {once:true});
      makeSparks(mon, Math.PI/4); makeSparks(mon, -Math.PI/4);
    }

    async function runAttack() {
      if (!started || state.attackInProgress) return;
      if (!state.monsters.length) return;
      state.attackInProgress = true;

      ensureMusic(difficulty==='easy');

      const hero = heroes[Math.floor(Math.random() * heroes.length)];
      const silhouetteEl = highlightSilhouette(hero.id);
      showHero(hero, silhouetteEl);

      await new Promise(r => setTimeout(r, 1000));

      const target = state.monsters[0];
      if (target) {
        sliceXOnMonster(target);
        await new Promise(r => setTimeout(r, 200));
        removeMonster(target);
      }

      await new Promise(r => setTimeout(r, 450));
      await hideHero();
      clearHighlight();
      state.attackInProgress = false;
    }

    function handleKey(event) {
      if (!started) return;
      if (event.code === 'Space') { event.preventDefault(); runAttack(); }
    }
    window.addEventListener('keydown', handleKey);
    window.addEventListener('pointerdown', () => { if (started) runAttack(); });

    window.addEventListener('blur',  () => { if (state.music && !document.hasFocus()) { state.music.pause(); state.musicStarted=false; }});
    window.addEventListener('focus', () => { if (!started) return; updateMusicByDifficulty(); });
  </script>
</body>
</html>
