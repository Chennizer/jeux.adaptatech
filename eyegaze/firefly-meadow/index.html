<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title class="translate" data-fr="Prairie aux lucioles" data-en="Firefly Meadow" data-ja="ホタルの草原">Prairie aux lucioles</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root {
      color-scheme: dark;
    }

    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: "Poppins", "Segoe UI", system-ui, -apple-system, sans-serif;
    }

    body.playing #game-options,
    body.playing #startHint {
      display: none !important;
    }

    #langToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1200;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 2px solid #0fd9c5;
      background: rgba(0, 0, 0, 0.75);
      color: #9cfaf0;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
    }

    #arena {
      position: absolute;
      inset: 0;
      overflow: hidden;
      background: #000;
    }

    /* options modal (matches other eyegaze menus) */
    #game-options.modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1400;
    }

    #options-title-bar {
      background: #009688;
      padding: 18px 26px 14px;
      border-radius: 14px 14px 8px 8px;
      text-align: center;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
    }

    #options-main-title {
      margin: 0;
      color: #ffffff;
      font-size: 1.65rem;
      font-weight: 800;
      letter-spacing: 0.02em;
    }

    #options-subtitle {
      margin: 6px 0 0;
      color: #e5fffa;
      opacity: 0.9;
      font-size: 0.95rem;
    }

    #control-panel-options {
      background: rgba(0, 0, 0, 0.9);
      border: 3px solid rgba(0, 150, 136, 0.6);
      border-radius: 16px;
      padding: 18px;
      margin-top: -6px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(4px);
    }

    #options-inline-container {
      align-items: flex-start;
      gap: 18px;
    }

    #control-panel-options .option-item {
      margin-bottom: 14px;
      color: #e9fbf8;
    }

    #control-panel-options .teal-label {
      color: #bdf7ee;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    #control-panel-options .styled-slider,
    #control-panel-options .styled-select,
    #control-panel-options .styled-input {
      background: rgba(255, 255, 255, 0.1);
      color: #f0fffd;
    }

    #control-panel-options .button {
      min-width: 180px;
    }

    .badge-value {
      display: inline-block;
      min-width: 44px;
      text-align: center;
      padding: 4px 8px;
      margin-left: 6px;
      border-radius: 10px;
      background: rgba(0, 223, 201, 0.15);
      color: #bffcf6;
      font-variant-numeric: tabular-nums;
    }

    #startHint {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #dffbf6;
      padding: 10px 16px;
      border: 1px solid rgba(0, 223, 201, 0.3);
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      font-weight: 600;
      z-index: 600;
      letter-spacing: 0.02em;
    }

    /* circles */
    .bubble {
      position: absolute;
      left: 0;
      top: 0;
      width: var(--size);
      height: var(--size);
      transform: translate3d(var(--x), var(--y), 0);
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff 0%, var(--color-bright) 40%, var(--color-base) 78%);
      box-shadow:
        0 0 10px rgba(255, 255, 255, 0.18),
        0 0 28px var(--glow),
        0 0 70px var(--glow-soft);
      transition: transform 0.28s ease, box-shadow 0.28s ease;
      filter: saturate(1.08);
      pointer-events: auto;
      will-change: transform;
      --size: 160px;
      --progress: 0deg;
      --color-base: #5ef9ff;
      --color-bright: #ffffff;
      --glow: rgba(94, 249, 255, 0.45);
      --glow-soft: rgba(94, 249, 255, 0.15);
    }

    .bubble::before {
      content: "";
      position: absolute;
      inset: 10%;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.4), transparent 50%);
      box-shadow: inset 0 0 35px rgba(255, 255, 255, 0.2);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .bubble::after {
      content: "";
      position: absolute;
      inset: -12%;
      border-radius: 50%;
      background:
        conic-gradient(var(--glow-ring) var(--progress), rgba(255, 255, 255, 0.06) var(--progress)),
        radial-gradient(circle at center, rgba(255, 255, 255, 0.18), transparent 60%);
      mask: radial-gradient(circle at center, transparent 58%, black 62%);
      pointer-events: none;
      transition: opacity 0.2s ease;
      box-shadow: 0 0 24px var(--glow-soft);
    }

    .bubble:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 8px;
    }

    .bubble.dwell {
      transform: translate3d(var(--x), var(--y), 0) scale(1.05);
      box-shadow: 0 0 50px var(--glow), 0 0 100px var(--glow-soft);
    }

    .bubble.pop {
      animation: pop 0.5s ease forwards;
    }

    @keyframes pop {
      0% { transform: translate3d(var(--x), var(--y), 0) scale(1.05); opacity: 1; }
      60% { transform: translate3d(var(--x), var(--y), 0) scale(1.3); opacity: 0.9; }
      100% { transform: translate3d(var(--x), var(--y), 0) scale(0.2); opacity: 0; }
    }

    /* released fireflies */
    .firefly {
      position: absolute;
      left: 0;
      top: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff 0%, rgba(255, 255, 255, 0.9) 35%, var(--tone) 70%, transparent 80%);
      transform: translate3d(var(--start-x), var(--start-y), 0) scale(var(--scale, 1));
      box-shadow: 0 0 10px var(--tone-soft), 0 0 20px var(--tone-soft);
      opacity: 0.92;
      mix-blend-mode: screen;
      pointer-events: none;
      animation:
        firefly-path var(--duration, 10s) ease-in-out var(--delay, 0s) infinite alternate,
        firefly-flicker 2.5s ease-in-out infinite;
    }

    .firefly::after {
      content: "";
      position: absolute;
      inset: -9px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, var(--tone-dim), transparent 65%);
      filter: blur(5px);
      opacity: 0.7;
    }

    @keyframes firefly-path {
      0% {
        transform: translate3d(var(--start-x), var(--start-y), 0) scale(var(--scale, 1));
      }
      32% {
        transform: translate3d(calc(var(--start-x) + var(--dx1)), calc(var(--start-y) + var(--dy1)), 0) scale(calc(var(--scale, 1) * 1.05));
      }
      100% {
        transform: translate3d(
          calc(var(--start-x) + var(--dx1) + var(--dx2)),
          calc(var(--start-y) + var(--dy1) + var(--dy2)),
          0
        ) scale(var(--scale, 1));
      }
    }

    @keyframes firefly-flicker {
      0%, 100% {
        opacity: 0.88;
        box-shadow: 0 0 8px var(--tone-soft), 0 0 18px var(--tone-soft);
        filter: drop-shadow(0 0 8px var(--tone-soft));
      }
      48% {
        opacity: 1;
        box-shadow: 0 0 14px var(--tone-soft), 0 0 26px var(--tone-soft);
        filter: drop-shadow(0 0 14px var(--tone-soft));
      }
    }

    #ambient-note {
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      color: #9cfaf0;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(0, 223, 201, 0.25);
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.4);
      z-index: 650;
      letter-spacing: 0.02em;
      font-weight: 600;
    }
  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B45TJG4GBJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} // eslint-disable-line
    gtag('js', new Date());
    gtag('config', 'G-B45TJG4GBJ');
  </script>
</head>
<body>
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <div id="game-options" class="modal" role="dialog" aria-modal="true">
    <div>
      <div id="options-title-bar">
        <h1 id="options-main-title" class="translate" data-fr="Prairie aux lucioles" data-en="Firefly Meadow" data-ja="ホタルの草原">Prairie aux lucioles</h1>
        <p id="options-subtitle" class="translate" data-fr="Regardez un cercle. Patientez. Il éclate." data-en="Look at a circle. Dwell. It pops." data-ja="丸を見つめて。待つだけで弾けます。">Regardez un cercle. Patientez. Il éclate.</p>
      </div>

      <div id="control-panel-options">
        <div id="options-inline-container" class="inline">
          <div>
            <div class="option-item">
              <div class="teal-label translate" data-fr="Temps de fixation" data-en="Dwell time" data-ja="視線保持時間">Temps de fixation</div>
              <input id="dwellInput" class="styled-slider" type="range" min="500" max="1800" step="50" value="900" />
              <span class="badge-value" id="dwellVal">900 ms</span>
            </div>
            <div class="option-item">
              <div class="teal-label translate" data-fr="Nombre de cercles" data-en="Circle count" data-ja="サークル数">Nombre de cercles</div>
              <input id="countInput" class="styled-slider" type="range" min="3" max="10" step="1" value="6" />
              <span class="badge-value" id="countVal">6</span>
            </div>
          </div>
          <div>
            <button id="resetBtn" class="button translate" data-fr="Mélanger" data-en="Shuffle" data-ja="シャッフル">Mélanger</button>
            <button id="startButton" class="button translate" data-fr="Jouer" data-en="Play" data-ja="プレイ">Jouer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="arena" aria-live="polite"></div>

  <div id="ambient-note" class="translate" data-fr="Grandes pastilles colorées sur fond noir." data-en="Big colored circles on a black backdrop." data-ja="黒い背景に大きなカラーサークル。">Grandes pastilles colorées sur fond noir.</div>

  <div id="startHint" class="translate" data-fr="Appuyer sur Entrée ou Jouer pour démarrer en plein écran" data-en="Press Enter or Play to start in fullscreen" data-ja="Enterキーまたはプレイでフルスクリーン開始">Appuyer sur Entrée ou Jouer pour démarrer en plein écran</div>

  <script>
    const arena = document.getElementById('arena');
    const dwellInput = document.getElementById('dwellInput');
    const countInput = document.getElementById('countInput');
    const dwellVal = document.getElementById('dwellVal');
    const countVal = document.getElementById('countVal');
    const resetBtn = document.getElementById('resetBtn');
    const startButton = document.getElementById('startButton');
    const startHint = document.getElementById('startHint');
    const langToggle = document.getElementById('langToggle');

    let dwellTime = Number(dwellInput.value);
    let bubbleCount = Number(countInput.value);
    let playing = false;
    let bubbles = [];
    let fireflies = [];

    const MAX_FIREFLIES = 60;

    const palette = [
      { base: '#ff6b6b', glow: 'rgba(255, 107, 107, 0.55)' },
      { base: '#ffd166', glow: 'rgba(255, 209, 102, 0.55)' },
      { base: '#4dd0e1', glow: 'rgba(77, 208, 225, 0.55)' },
      { base: '#a78bfa', glow: 'rgba(167, 139, 250, 0.55)' },
      { base: '#7dd3fc', glow: 'rgba(125, 211, 252, 0.55)' },
      { base: '#4ade80', glow: 'rgba(74, 222, 128, 0.55)' },
    ];

    function updateDwellLabel() {
      dwellVal.textContent = `${dwellTime} ms`;
    }

    function updateCountLabel() {
      countVal.textContent = `${bubbleCount}`;
    }

    function randBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    function spawnFireflies(x, y, count = 6, color) {
      const tone = color?.base || '#9cfaf0';
      const toneGlow = color?.glow || 'rgba(156, 250, 240, 0.55)';

      for (let i = 0; i < count; i++) {
        const fly = document.createElement('div');
        fly.className = 'firefly';
        const angle = randBetween(0, Math.PI * 2);
        const burstDistance = randBetween(40, 130);
        const driftDistance = randBetween(80, 170);
        const dx1 = Math.cos(angle) * burstDistance;
        const dy1 = Math.sin(angle) * burstDistance;
        const dx2 = Math.cos(angle + randBetween(-0.8, 0.8)) * driftDistance;
        const dy2 = Math.sin(angle + randBetween(-0.8, 0.8)) * driftDistance;
        const duration = randBetween(8, 13);
        const delay = randBetween(0, 0.8);
        const scale = randBetween(0.85, 1.25);

        fly.style.setProperty('--start-x', `${x}px`);
        fly.style.setProperty('--start-y', `${y}px`);
        fly.style.setProperty('--dx1', `${dx1}px`);
        fly.style.setProperty('--dy1', `${dy1}px`);
        fly.style.setProperty('--dx2', `${dx2}px`);
        fly.style.setProperty('--dy2', `${dy2}px`);
        fly.style.setProperty('--duration', `${duration}s`);
        fly.style.setProperty('--delay', `${delay}s`);
        fly.style.setProperty('--scale', `${scale}`);
        fly.style.setProperty('--tone', tone);
        fly.style.setProperty('--tone-soft', toneGlow);
        fly.style.setProperty('--tone-dim', toneGlow.replace('0.55', '0.2'));

        arena.appendChild(fly);
        fireflies.push(fly);

        const lifetime = (duration + delay) * 1000 * 1.5;
        setTimeout(() => {
          fly.remove();
          fireflies = fireflies.filter(f => f !== fly);
        }, lifetime);
      }

      while (fireflies.length > MAX_FIREFLIES) {
        const oldest = fireflies.shift();
        if (oldest) oldest.remove();
      }
    }

    function createBubble() {
      const size = randBetween(150, 240);
      const x = randBetween(40, window.innerWidth - size - 40);
      const y = randBetween(40, window.innerHeight - size - 40);
      const color = palette[Math.floor(Math.random() * palette.length)];

      const el = document.createElement('button');
      el.className = 'bubble';
      el.style.setProperty('--size', `${size}px`);
      el.style.setProperty('--x', `${x}px`);
      el.style.setProperty('--y', `${y}px`);
      el.style.setProperty('--color-base', color.base);
      el.style.setProperty('--color-bright', '#fff');
      el.style.setProperty('--glow', color.glow);
      el.style.setProperty('--glow-soft', color.glow.replace('0.55', '0.2'));
      el.style.setProperty('--glow-ring', color.base + 'cc');
      el.setAttribute('aria-label', 'cercle coloré');

      const bubble = { el, dwellFrame: null, size, color, x, y };

      el.addEventListener('pointerenter', () => startDwell(bubble));
      el.addEventListener('pointerleave', () => cancelDwell(bubble));
      el.addEventListener('focus', () => startDwell(bubble));
      el.addEventListener('blur', () => cancelDwell(bubble));

      arena.appendChild(el);
      bubbles.push(bubble);
    }

    function clearBubbles() {
      bubbles.forEach(b => b.el.remove());
      bubbles = [];
    }

    function populate() {
      clearBubbles();
      for (let i = 0; i < bubbleCount; i++) {
        createBubble();
      }
    }

    function startDwell(bubble) {
      cancelDwell(bubble);
      bubble.el.classList.add('dwell');
      const start = performance.now();

      const step = (now) => {
        const progress = Math.min((now - start) / dwellTime, 1);
        bubble.el.style.setProperty('--progress', `${progress * 360}deg`);
        if (progress >= 1) {
          popBubble(bubble);
          return;
        }
        bubble.dwellFrame = requestAnimationFrame(step);
      };

      bubble.dwellFrame = requestAnimationFrame(step);
    }

    function cancelDwell(bubble) {
      bubble.el.classList.remove('dwell');
      bubble.el.style.setProperty('--progress', '0deg');
      if (bubble.dwellFrame) cancelAnimationFrame(bubble.dwellFrame);
      bubble.dwellFrame = null;
    }

    function popBubble(bubble) {
      cancelDwell(bubble);
      bubble.el.classList.add('pop');
      const centerX = bubble.x + bubble.size / 2;
      const centerY = bubble.y + bubble.size / 2;
      spawnFireflies(centerX, centerY, 7, bubble.color);
      setTimeout(() => {
        repositionBubble(bubble);
        bubble.el.classList.remove('pop');
      }, 480);
    }

    function repositionBubble(bubble) {
      const size = randBetween(150, 240);
      const x = randBetween(40, window.innerWidth - size - 40);
      const y = randBetween(40, window.innerHeight - size - 40);
      const color = palette[Math.floor(Math.random() * palette.length)];

      bubble.el.style.setProperty('--size', `${size}px`);
      bubble.el.style.setProperty('--x', `${x}px`);
      bubble.el.style.setProperty('--y', `${y}px`);
      bubble.el.style.setProperty('--color-base', color.base);
      bubble.el.style.setProperty('--glow', color.glow);
      bubble.el.style.setProperty('--glow-soft', color.glow.replace('0.55', '0.2'));
      bubble.el.style.setProperty('--glow-ring', color.base + 'cc');
      bubble.el.style.setProperty('--progress', '0deg');
      bubble.size = size;
      bubble.x = x;
      bubble.y = y;
      bubble.color = color;
    }

    /* controls */
    dwellInput.addEventListener('input', (e) => {
      dwellTime = Number(e.target.value);
      updateDwellLabel();
    });

    countInput.addEventListener('input', (e) => {
      bubbleCount = Number(e.target.value);
      updateCountLabel();
      populate();
    });

    resetBtn.addEventListener('click', populate);

    function requestFullscreen() {
      const el = document.documentElement;
      const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
      if (fn) fn.call(el);
    }

    function startGame() {
      requestFullscreen();
      document.body.classList.add('playing');
      playing = true;
      startHint.style.display = 'none';
    }

    startButton.addEventListener('click', startGame);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !playing) startGame();
    });

    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        playing = false;
        document.body.classList.remove('playing');
      }
    });

    function toggleLanguage() {
      const htmlEl = document.querySelector('html');
      const currentLang = htmlEl.getAttribute('lang') || 'fr';
      const nextLang = currentLang === 'fr' ? 'en' : currentLang === 'en' ? 'ja' : 'fr';
      htmlEl.setAttribute('lang', nextLang);
      document.querySelectorAll('.translate').forEach(el => {
        const text = el.dataset[nextLang];
        if (text) {
          el.textContent = text;
        }
      });
    }

    langToggle.addEventListener('click', toggleLanguage);

    updateDwellLabel();
    updateCountLabel();
    populate();
  </script>
</body>
</html>
