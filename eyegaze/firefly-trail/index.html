<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title class="translate" data-fr="Sentier de luciole" data-en="Firefly Trail">Sentier de luciole</title>

  <link rel="stylesheet" href="../../css/games.css" />
  <link rel="stylesheet" href="../../css/choiceeyegaze.css" />

  <style>
    :root {
      --dwell-color: rgba(253, 224, 71, 0.45);
      --checkpoint-size: clamp(96px, 16vmin, 168px);
      --hud-bg: rgba(15, 23, 42, 0.76);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Nunito", "Segoe UI", system-ui, sans-serif;
      background: radial-gradient(circle at top, #0f172a 10%, #020617 70%);
      color: #e2e8f0;
      min-height: 100vh;
      overflow: hidden;
    }

    body.dark {
      background: radial-gradient(circle at top, #0f172a 10%, #020617 70%);
      color: #e2e8f0;
    }

    #langToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 2px solid rgba(94, 234, 212, 0.85);
      background: rgba(15, 23, 42, 0.92);
      color: #5eead4;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 16px 40px rgba(45, 212, 191, 0.25);
    }

    #game-options.modal {
      background: rgba(15, 23, 42, 0.9);
    }

    #options-title-bar h2 {
      color: #f8fafc;
    }

    .teal-label,
    label.teal-label span,
    label.teal-label {
      color: #f1f5f9;
    }

    #control-panel-options {
      background: rgba(2, 6, 23, 0.7);
    }

    #mode-divider {
      background: rgba(148, 163, 184, 0.45);
    }

    #startButton {
      background: linear-gradient(135deg, #34d399, #22d3ee);
      color: #022c22;
      border: none;
      box-shadow: 0 16px 40px rgba(45, 212, 191, 0.35);
      position: relative;
      overflow: hidden;
    }

    #startButton:hover,
    #startButton:focus-visible {
      filter: brightness(1.05);
    }

    .styled-select,
    .styled-slider,
    .styled-input {
      background: rgba(15, 23, 42, 0.86);
      color: #f8fafc;
      border-color: rgba(125, 211, 252, 0.42);
    }

    .styled-select option {
      color: #0f172a;
    }

    .game-container {
      display: none;
    }

    #trailExperience {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: none;
      color: #f8fafc;
    }

    #sessionHud {
      position: absolute;
      top: clamp(16px, 5vh, 28px);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 14px 18px 16px;
      border-radius: 24px;
      background: var(--hud-bg);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(14px);
      z-index: 50;
      min-width: min(80vw, 520px);
    }

    #progressLabel {
      font-size: clamp(18px, 2.8vmin, 28px);
      font-weight: 700;
      text-align: center;
      letter-spacing: 0.02em;
    }

    #hudButtons {
      display: inline-flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .hudButton {
      position: relative;
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: clamp(15px, 2.2vmin, 20px);
      font-weight: 600;
      letter-spacing: 0.02em;
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.88), rgba(45, 212, 191, 0.85));
      color: #022c22;
      cursor: pointer;
      box-shadow: 0 12px 28px rgba(56, 189, 248, 0.35);
      overflow: hidden;
    }

    .hudButton:focus-visible {
      outline: 3px solid rgba(56, 189, 248, 0.8);
      outline-offset: 3px;
    }

    #trailPlayfield {
      position: absolute;
      inset: clamp(120px, 16vh, 180px) clamp(5vw, 8vw, 140px) clamp(24px, 8vh, 80px);
      border-radius: 36px;
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.22), rgba(15, 23, 42, 0.92));
      box-shadow: 0 35px 90px rgba(8, 47, 73, 0.48);
      overflow: hidden;
    }

    #trailInner {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #trailSvg {
      width: 100%;
      height: 100%;
      display: block;
      filter: drop-shadow(0 20px 40px rgba(15, 23, 42, 0.6));
    }

    #trailSvg path {
      fill: none;
      stroke: rgba(148, 163, 255, 0.45);
      stroke-width: 22;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 12 34;
    }

    #checkpointLayer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    #checkpointLayer.interactive {
      pointer-events: auto;
    }

    .checkpoint {
      position: absolute;
      width: var(--checkpoint-size);
      height: var(--checkpoint-size);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle at 40% 30%, rgba(255, 255, 255, 0.92), rgba(252, 211, 77, 0.82) 60%, rgba(251, 191, 36, 0.66) 75%, rgba(14, 116, 144, 0.3) 100%);
      border: 4px solid rgba(254, 240, 138, 0.9);
      box-shadow: 0 0 42px rgba(250, 204, 21, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(22px, 4.5vmin, 38px);
      font-weight: 800;
      color: #022c22;
      pointer-events: auto;
      cursor: pointer;
      transition: transform 0.4s ease, box-shadow 0.4s ease, border-color 0.4s ease;
    }

    .checkpoint.start {
      background: radial-gradient(circle at 40% 35%, rgba(94, 234, 212, 0.95), rgba(45, 212, 191, 0.82) 60%, rgba(8, 47, 73, 0.4) 95%);
      border-color: rgba(94, 234, 212, 0.9);
      box-shadow: 0 0 32px rgba(94, 234, 212, 0.75);
      color: #022c22;
    }

    .checkpoint.finish {
      background: radial-gradient(circle at 45% 35%, rgba(255, 255, 255, 0.98), rgba(254, 215, 170, 0.88) 58%, rgba(245, 158, 11, 0.75) 78%, rgba(8, 47, 73, 0.4) 98%);
      border-color: rgba(253, 186, 116, 0.95);
    }

    .checkpoint.active {
      transform: translate(-50%, -50%) scale(1.08);
      box-shadow: 0 0 58px rgba(252, 211, 77, 0.85);
      border-color: rgba(253, 224, 71, 0.95);
    }

    .checkpoint.visited {
      background: radial-gradient(circle at 45% 35%, rgba(240, 253, 244, 0.95), rgba(134, 239, 172, 0.85) 62%, rgba(16, 185, 129, 0.8) 88%, rgba(4, 120, 87, 0.42) 100%);
      border-color: rgba(134, 239, 172, 0.95);
      box-shadow: 0 0 38px rgba(16, 185, 129, 0.75);
      color: #064e3b;
    }

    .checkpoint-number {
      pointer-events: none;
      text-shadow: 0 3px 12px rgba(15, 23, 42, 0.45);
    }

    .checkpoint .dwell,
    .hudButton .dwell,
    #startButton .dwell {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 100%;
      height: 100%;
      transform: translate(-50%, -50%) scale(0.06);
      transform-origin: center center;
      pointer-events: none;
      border-radius: 50%;
      background: var(--dwell-color);
      mix-blend-mode: screen;
      will-change: transform;
      z-index: -1;
    }

    @keyframes dwellGrow {
      from {
        transform: translate(-50%, -50%) scale(0.08);
      }
      to {
        transform: translate(-50%, -50%) scale(1.02);
      }
    }

    #firefly {
      position: absolute;
      width: clamp(58px, 12vmin, 86px);
      height: clamp(58px, 12vmin, 86px);
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 40;
      transition: left 0.9s cubic-bezier(0.4, 0.0, 0.2, 1), top 0.9s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    #firefly.flip {
      transform: translate(-50%, -50%) scaleX(-1);
    }

    #firefly .glow {
      position: absolute;
      inset: -18%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(253, 224, 71, 0.38) 35%, rgba(249, 115, 22, 0.2) 82%, rgba(15, 23, 42, 0));
      animation: fireflyGlow 3.8s ease-in-out infinite;
    }

    #firefly .core {
      position: absolute;
      inset: 22%;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.98), rgba(253, 224, 71, 0.85) 65%, rgba(249, 115, 22, 0.72) 90%);
      box-shadow: 0 0 26px rgba(253, 224, 71, 0.9), 0 0 60px rgba(249, 115, 22, 0.65);
      animation: fireflyPulse 2.8s ease-in-out infinite;
    }

    #firefly .wing {
      position: absolute;
      top: 12%;
      width: 48%;
      height: 60%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.95), rgba(125, 211, 252, 0.55) 65%, rgba(56, 189, 248, 0.0) 100%);
      border-radius: 70% 100% 60% 80%;
      opacity: 0.9;
      animation: wingFlutter 1.8s ease-in-out infinite;
      transform-origin: center;
      filter: drop-shadow(0 6px 14px rgba(56, 189, 248, 0.25));
    }

    #firefly .wing.left {
      left: -6%;
      transform: rotate(-18deg);
    }

    #firefly .wing.right {
      right: -6%;
      transform: rotate(18deg) scaleX(-1);
    }

    @keyframes fireflyGlow {
      0% {
        opacity: 0.8;
        transform: scale(0.9);
      }
      50% {
        opacity: 1;
        transform: scale(1.1);
      }
      100% {
        opacity: 0.82;
        transform: scale(0.92);
      }
    }

    @keyframes fireflyPulse {
      0% {
        transform: scale(0.96);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(0.96);
      }
    }

    @keyframes wingFlutter {
      0%, 100% {
        transform: rotate(-10deg);
      }
      50% {
        transform: rotate(-22deg);
      }
    }

    #completionBanner {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.68);
      backdrop-filter: blur(8px);
      z-index: 60;
    }

    #completionBanner.show {
      display: flex;
    }

    #completionBanner .card {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 28px;
      padding: 28px 32px;
      text-align: center;
      box-shadow: 0 30px 80px rgba(8, 47, 73, 0.7);
      max-width: 420px;
      color: #f8fafc;
    }

    #completionBanner h3 {
      font-size: clamp(24px, 4.4vmin, 32px);
      margin: 0 0 12px;
    }

    #completionMessage {
      font-size: clamp(18px, 3.2vmin, 24px);
      line-height: 1.5;
      margin: 0 0 16px;
    }

    #completionBanner button {
      border-radius: 16px;
      padding: 10px 18px;
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.9), rgba(45, 212, 191, 0.9));
      color: #022c22;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(56, 189, 248, 0.32);
    }

    #completionBanner button:focus-visible {
      outline: 3px solid rgba(125, 211, 252, 0.8);
      outline-offset: 3px;
    }

    @media (max-width: 768px) {
      #trailPlayfield {
        inset: clamp(140px, 22vh, 200px) 4vw clamp(20px, 14vh, 80px);
        border-radius: 24px;
      }

      #sessionHud {
        min-width: calc(100vw - 32px);
        left: 50%;
      }

      .hudButton {
        width: 100%;
        justify-content: center;
      }

      #hudButtons {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body class="dark">
  <button id="langToggle" title="Basculer la langue / Toggle language">FR / EN</button>

  <div id="game-options" class="modal">
    <div id="options-title-bar">
      <h2 id="options-main-title" class="translate" data-fr="Sentier de luciole" data-en="Firefly Trail">Sentier de luciole</h2>
    </div>

    <div id="control-panel-options">
      <div id="mode-divider"></div>

      <div id="options-inline-container">
        <div class="options-column">
          <div class="option-item">
            <label class="teal-label label-block translate" for="dwellSelect" data-fr="Temps de fixation" data-en="Dwell time">Temps de fixation</label>
            <select id="dwellSelect" class="styled-select">
              <option value="800" class="translate" data-fr="Rapide (0,8 s)" data-en="Quick (0.8 s)">Rapide (0,8 s)</option>
              <option value="1200" selected class="translate" data-fr="Confort (1,2 s)" data-en="Comfort (1.2 s)">Confort (1,2 s)</option>
              <option value="1800" class="translate" data-fr="Tranquille (1,8 s)" data-en="Gentle (1.8 s)">Tranquille (1,8 s)</option>
            </select>
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label class="teal-label label-block translate" for="pathSelect" data-fr="Parcours" data-en="Trail layout">Parcours</label>
            <select id="pathSelect" class="styled-select">
              <option value="breeze" selected class="translate" data-fr="Courbes douces" data-en="Gentle curves">Courbes douces</option>
              <option value="twists" class="translate" data-fr="Virages lumineux" data-en="Bright twists">Virages lumineux</option>
              <option value="adventure" class="translate" data-fr="Grande aventure" data-en="Big adventure">Grande aventure</option>
            </select>
          </div>
        </div>

        <div class="options-column">
          <div class="option-item">
            <label class="teal-label label-block translate" for="reinforcementSelect" data-fr="Renforcement verbal" data-en="Verbal reinforcement">Renforcement verbal</label>
            <select id="reinforcementSelect" class="styled-select">
              <option value="none" selected class="translate" data-fr="Aucun" data-en="None">Aucun</option>
              <option value="glow" class="translate" data-fr="Chuchotement calme" data-en="Calm whisper">Chuchotement calme</option>
              <option value="celebration" class="translate" data-fr="Bravo lumineux" data-en="Cheerful bravo">Bravo lumineux</option>
            </select>
          </div>
        </div>
      </div>

      <div id="mode-divider"></div>
      <button id="startButton" class="button translate" data-fr="Commencer l'aventure" data-en="Start the adventure">Commencer l'aventure</button>
    </div>
  </div>

  <div class="game-container" id="trailExperience">
    <div id="sessionHud">
      <div id="progressLabel"></div>
      <div id="hudButtons">
        <button id="restartBtn" class="hudButton translate" data-fr="Recommencer" data-en="Restart">Recommencer</button>
        <button id="optionsBtn" class="hudButton translate" data-fr="Options" data-en="Options">Options</button>
      </div>
    </div>

    <div id="trailPlayfield">
      <div id="trailInner">
        <svg id="trailSvg" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
          <path id="trailPath" d="" />
        </svg>
        <div id="checkpointLayer" aria-hidden="false"></div>
        <div id="firefly" aria-hidden="true">
          <div class="glow"></div>
          <div class="core"></div>
          <div class="wing left"></div>
          <div class="wing right"></div>
        </div>
      </div>
      <div id="completionBanner">
        <div class="card">
          <h3 id="completionTitle" class="translate" data-fr="Mission scintillante accomplie !" data-en="Glowing mission complete!">Mission scintillante accomplie !</h3>
          <p id="completionMessage"></p>
          <button id="playAgainBtn" class="translate" data-fr="Rejouer" data-en="Play again">Rejouer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const LS_LANG_KEY = 'siteLanguage';
    const langToggle = document.getElementById('langToggle');

    function getLang() {
      try {
        const stored = localStorage.getItem(LS_LANG_KEY);
        if (stored === 'en' || stored === 'fr') {
          return stored;
        }
      } catch (err) {}
      return document.documentElement.lang === 'en' ? 'en' : 'fr';
    }

    function setLang(lang) {
      const safe = lang === 'en' ? 'en' : 'fr';
      document.documentElement.lang = safe;
      try {
        localStorage.setItem(LS_LANG_KEY, safe);
      } catch (err) {}
      document.querySelectorAll('.translate').forEach((el) => {
        const fr = el.getAttribute('data-fr');
        const en = el.getAttribute('data-en');
        if (safe === 'fr' && fr != null) {
          el.textContent = fr;
        }
        if (safe === 'en' && en != null) {
          el.textContent = en;
        }
      });
      updateCheckpointLabels();
      updateProgressLabel();
      updateCompletionMessage();
    }

    (function initLang() {
      let initial = 'fr';
      try {
        const saved = localStorage.getItem(LS_LANG_KEY);
        initial = saved === 'en' || saved === 'fr' ? saved : document.documentElement.lang === 'en' ? 'en' : 'fr';
        localStorage.setItem(LS_LANG_KEY, initial);
      } catch (err) {
        initial = document.documentElement.lang === 'en' ? 'en' : 'fr';
      }
      setLang(initial);
    })();

    langToggle.addEventListener('click', () => {
      setLang(getLang() === 'fr' ? 'en' : 'fr');
    });

    const VIEWBOX = { width: 1000, height: 700 };

    const PATH_LIBRARY = {
      breeze: {
        path: 'M 70 610 C 180 520 260 480 340 390 S 540 280 640 320 S 780 470 920 420',
        checkpoints: [
          { x: 70, y: 610 },
          { x: 220, y: 540 },
          { x: 360, y: 420 },
          { x: 520, y: 320 },
          { x: 700, y: 360 },
          { x: 880, y: 420 }
        ],
        summary: {
          fr: "La luciole suit tranquillement les courbes douces du sentier.",
          en: "The firefly glides along a gentle stream of light."
        }
      },
      twists: {
        path: 'M 80 630 C 200 560 160 430 320 360 S 540 360 520 500 S 640 630 780 540 S 900 420 930 300',
        checkpoints: [
          { x: 80, y: 630 },
          { x: 210, y: 560 },
          { x: 260, y: 430 },
          { x: 420, y: 360 },
          { x: 540, y: 420 },
          { x: 520, y: 520 },
          { x: 660, y: 600 },
          { x: 780, y: 500 },
          { x: 880, y: 360 }
        ],
        summary: {
          fr: "Des virages brillants invitent la luciole à explorer en zigzag.",
          en: "Bright twists invite the firefly to weave in playful zigzags."
        }
      },
      adventure: {
        path: 'M 60 620 C 140 520 200 520 220 430 S 260 320 360 300 S 520 320 480 440 S 420 560 520 620 S 700 620 760 520 S 820 410 900 360',
        checkpoints: [
          { x: 60, y: 620 },
          { x: 150, y: 520 },
          { x: 210, y: 460 },
          { x: 280, y: 360 },
          { x: 380, y: 310 },
          { x: 500, y: 360 },
          { x: 470, y: 470 },
          { x: 450, y: 560 },
          { x: 560, y: 610 },
          { x: 700, y: 570 },
          { x: 780, y: 470 },
          { x: 880, y: 380 }
        ],
        summary: {
          fr: "Une grande aventure pleine de détours illumine tout le pré.",
          en: "A looping adventure lights up the meadow from edge to edge."
        }
      }
    };

    const REINFORCEMENT_LIBRARY = {
      none: {
        text: null,
        clip: null
      },
      glow: {
        text: {
          fr: 'Doucement, la lumière grandit.',
          en: 'Soft glow, nicely done.'
        },
        clip: '../../sounds/jingles/funnysound2.mp3'
      },
      celebration: {
        text: {
          fr: 'Bravo, la luciole adore ce trajet !',
          en: 'Bravo! The firefly loves your guiding gaze!'
        },
        clip: '../../sounds/jingles/funnysound6.mp3'
      }
    };

    const CONTROL_DWELL_MS = 1100;

    const gameOptions = document.getElementById('game-options');
    const gameArea = document.getElementById('trailExperience');
    const startButton = document.getElementById('startButton');
    const dwellSelect = document.getElementById('dwellSelect');
    const pathSelect = document.getElementById('pathSelect');
    const reinforcementSelect = document.getElementById('reinforcementSelect');
    const progressLabel = document.getElementById('progressLabel');
    const restartBtn = document.getElementById('restartBtn');
    const optionsBtn = document.getElementById('optionsBtn');
    const firefly = document.getElementById('firefly');
    const pathElement = document.getElementById('trailPath');
    const checkpointLayer = document.getElementById('checkpointLayer');
    const completionBanner = document.getElementById('completionBanner');
    const completionMessage = document.getElementById('completionMessage');
    const playAgainBtn = document.getElementById('playAgainBtn');

    const state = {
      config: null,
      pathDef: null,
      checkpointEls: [],
      reachedIndex: 0,
      activeIndex: 1,
      completed: false
    };

    const audioCache = new Map();
    let isStartingExperience = false;

    function toPercent(pt) {
      return {
        left: (pt.x / VIEWBOX.width) * 100 + '%',
        top: (pt.y / VIEWBOX.height) * 100 + '%'
      };
    }
    function startDwellCircle(el, durationMs) {
      let overlay = el.querySelector('.dwell');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'dwell';
        el.appendChild(overlay);
      }
      overlay.style.animation = 'none';
      overlay.style.transform = 'translate(-50%, -50%) scale(0.08)';
      void overlay.offsetWidth;
      overlay.style.animation = `dwellGrow ${durationMs}ms linear forwards`;
      return overlay;
    }

    function resetDwellCircle(el) {
      const overlay = el.querySelector('.dwell');
      if (overlay) {
        overlay.remove();
      }
    }

    function updateCheckpointLabels() {
      const lang = getLang();
      state.checkpointEls.forEach((el, idx) => {
        const fr = el.getAttribute('data-fr-label');
        const en = el.getAttribute('data-en-label');
        const label = lang === 'fr' ? fr : en;
        if (label) {
          el.setAttribute('aria-label', label);
        }
        if (!state.completed && idx === state.activeIndex) {
          el.setAttribute('data-active', 'true');
        } else {
          el.removeAttribute('data-active');
        }
      });
    }

    function updateProgressLabel() {
      const lang = getLang();
      if (!state.config || !state.pathDef) {
        progressLabel.textContent = lang === 'fr' ? 'Choisissez un parcours lumineux pour commencer.' : 'Choose a glowing trail to begin.';
        return;
      }

      const totalTargets = Math.max(1, state.pathDef.checkpoints.length - 1);

      if (state.completed) {
        progressLabel.textContent = lang === 'fr' ? 'Parcours terminé !' : 'Trail complete!';
        return;
      }

      const nextStep = Math.min(state.activeIndex, state.pathDef.checkpoints.length - 1);
      if (lang === 'fr') {
        progressLabel.textContent = `Point ${nextStep} sur ${totalTargets} — gardez votre regard pour l'allumer.`;
      } else {
        progressLabel.textContent = `Checkpoint ${nextStep} of ${totalTargets} — hold your gaze to light it.`;
      }
    }

    function updateCompletionMessage() {
      if (!state.pathDef) {
        completionMessage.textContent = '';
        return;
      }
      const lang = getLang();
      const summary = state.pathDef.summary?.[lang] || state.pathDef.summary?.fr || '';
      const tail = lang === 'fr' ? 'Touchez « Rejouer » pour un nouveau voyage lumineux.' : 'Select “Play again” for another glowing journey.';
      completionMessage.textContent = summary ? `${summary} ${tail}` : tail;
    }

    function hideCompletionBanner() {
      completionBanner.classList.remove('show');
    }

    function showCompletionBanner() {
      completionBanner.classList.add('show');
      updateCompletionMessage();
    }

    function updateFireflyPosition(pt, immediate = false, prevPt = null) {
      if (!pt) return;
      const { left, top } = toPercent(pt);
      if (immediate) {
        firefly.style.transition = 'none';
        firefly.classList.remove('flip');
        firefly.style.left = left;
        firefly.style.top = top;
        requestAnimationFrame(() => {
          firefly.style.transition = '';
        });
      } else {
        if (prevPt) {
          firefly.classList.toggle('flip', pt.x < prevPt.x);
        }
        firefly.style.left = left;
        firefly.style.top = top;
      }
    }

    function deliverReinforcement(key) {
      const entry = REINFORCEMENT_LIBRARY[key];
      if (!entry) return;

      if (entry.clip) {
        let audio = audioCache.get(entry.clip);
        if (!audio) {
          audio = new Audio(entry.clip);
          audio.preload = 'auto';
          audioCache.set(entry.clip, audio);
        }
        audio.currentTime = 0;
        audio.play().catch(() => {});
      }

      if (entry.text && 'speechSynthesis' in window) {
        const lang = getLang();
        const msg = entry.text[lang] || entry.text.fr;
        if (msg) {
          const utter = new SpeechSynthesisUtterance(msg);
          utter.lang = lang === 'fr' ? 'fr-CA' : 'en-US';
          try {
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
          } catch (err) {}
        }
      }
    }

    function clearCheckpointLayer() {
      while (checkpointLayer.firstChild) {
        checkpointLayer.removeChild(checkpointLayer.firstChild);
      }
      checkpointLayer.classList.remove('interactive');
      state.checkpointEls = [];
    }

    function buildCheckpoints(def) {
      clearCheckpointLayer();
      def.checkpoints.forEach((pt, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'checkpoint';
        if (idx === 0) {
          btn.classList.add('start');
        }
        if (idx === def.checkpoints.length - 1) {
          btn.classList.add('finish');
        }
        const number = document.createElement('span');
        number.className = 'checkpoint-number';
        number.textContent = idx === 0 ? '★' : idx.toString();
        btn.appendChild(number);
        const { left, top } = toPercent(pt);
        btn.style.left = left;
        btn.style.top = top;
        const labelFr = idx === 0 ? 'Point de départ du sentier lumineux' : `Point ${idx} du sentier`;
        const labelEn = idx === 0 ? 'Starting glow of the trail' : `Checkpoint ${idx} on the trail`;
        btn.setAttribute('data-fr-label', labelFr);
        btn.setAttribute('data-en-label', labelEn);
        btn.setAttribute('aria-label', getLang() === 'fr' ? labelFr : labelEn);
        checkpointLayer.appendChild(btn);
        state.checkpointEls.push(btn);
        wireCheckpoint(btn, idx);
      });
      if (state.checkpointEls.length > 0) {
        checkpointLayer.classList.add('interactive');
      }
      updateCheckpointLabels();
    }

    function setActiveCheckpoint(index) {
      state.activeIndex = index;
      state.checkpointEls.forEach((el, i) => {
        if (!state.completed && index >= 0 && i === index) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
      updateCheckpointLabels();
    }

    function wireCheckpoint(el, idx) {
      let dwellTimer = null;

      const clearTimer = () => {
        if (dwellTimer) {
          clearTimeout(dwellTimer);
          dwellTimer = null;
        }
        resetDwellCircle(el);
      };

      const begin = () => {
        if (state.completed) return;
        if (idx !== state.activeIndex) return;
        const dwellMs = state.config?.dwellMs || 1200;
        clearTimer();
        startDwellCircle(el, dwellMs);
        dwellTimer = setTimeout(() => {
          clearTimer();
          resolveCheckpoint(idx);
        }, dwellMs + 12);
      };

      el.addEventListener('mouseenter', begin);
      el.addEventListener('mouseleave', clearTimer);
      el.addEventListener('touchstart', (ev) => {
        ev.preventDefault();
        begin();
      }, { passive: false });
      el.addEventListener('touchend', clearTimer);
      el.addEventListener('touchcancel', clearTimer);
    }

    function resolveCheckpoint(idx) {
      if (idx !== state.activeIndex) return;
      const el = state.checkpointEls[idx];
      if (!el) return;
      el.classList.add('visited');
      deliverReinforcement(state.config?.reinforcement || 'none');
      const prevPt = state.pathDef.checkpoints[state.reachedIndex];
      const targetPt = state.pathDef.checkpoints[idx];
      updateFireflyPosition(targetPt, false, prevPt);
      state.reachedIndex = idx;

      if (idx >= state.pathDef.checkpoints.length - 1) {
        state.completed = true;
        setActiveCheckpoint(-1);
        updateProgressLabel();
        showCompletionBanner();
        return;
      }

      state.completed = false;
      setActiveCheckpoint(idx + 1);
      updateProgressLabel();
    }

    function resetTrailState(def) {
      state.reachedIndex = 0;
      state.completed = false;
      state.checkpointEls.forEach((el, idx) => {
        el.classList.remove('visited', 'active');
        if (idx === 0) {
          el.classList.add('visited');
        }
      });
      const nextIndex = Math.min(1, def.checkpoints.length - 1);
      setActiveCheckpoint(nextIndex >= 0 ? nextIndex : -1);
      updateFireflyPosition(def.checkpoints[0], true);
      hideCompletionBanner();
      updateProgressLabel();
    }

    function enterFullscreen() {
      const el = document.documentElement;
      if (!el || document.fullscreenElement) {
        return Promise.resolve();
      }
      try {
        const req = el.requestFullscreen?.() || el.webkitRequestFullscreen?.() || el.msRequestFullscreen?.();
        if (req && typeof req.then === 'function') {
          return req.catch(() => {});
        }
      } catch (err) {}
      return Promise.resolve();
    }

    function initSessionFromOptions() {
      const dwellMs = parseInt(dwellSelect.value, 10) || 1200;
      const pathKey = PATH_LIBRARY[pathSelect.value] ? pathSelect.value : 'breeze';
      const reinforcementKey = REINFORCEMENT_LIBRARY[reinforcementSelect.value] ? reinforcementSelect.value : 'none';
      state.config = {
        dwellMs,
        pathKey,
        reinforcement: reinforcementKey
      };
      state.pathDef = PATH_LIBRARY[pathKey];
      pathElement.setAttribute('d', state.pathDef.path);
      buildCheckpoints(state.pathDef);
      resetTrailState(state.pathDef);
      updateCompletionMessage();
    }

    function showOptionsPanel() {
      hideCompletionBanner();
      gameArea.style.display = 'none';
      langToggle.style.display = 'inline-flex';
      gameOptions.style.display = 'block';
      resetDwellCircle(startButton);
      if (state.config) {
        dwellSelect.value = String(state.config.dwellMs);
        pathSelect.value = state.config.pathKey;
        reinforcementSelect.value = state.config.reinforcement;
      }
      updateProgressLabel();
    }

    async function launchTrailExperience() {
      if (isStartingExperience) {
        return;
      }
      isStartingExperience = true;
      try {
        resetDwellCircle(startButton);
        await enterFullscreen();
        initSessionFromOptions();
        gameOptions.style.display = 'none';
        langToggle.style.display = 'none';
        gameArea.style.display = 'block';
        updateProgressLabel();
      } finally {
        isStartingExperience = false;
      }
    }

    function wireHudButton(btn, handler) {
      let timer = null;
      const clearTimer = () => {
        if (timer) {
          clearTimeout(timer);
          timer = null;
        }
        resetDwellCircle(btn);
      };
      const begin = () => {
        if (!state.pathDef) {
          handler();
          return;
        }
        clearTimer();
        startDwellCircle(btn, CONTROL_DWELL_MS);
        timer = setTimeout(() => {
          clearTimer();
          handler();
        }, CONTROL_DWELL_MS + 12);
      };
      btn.addEventListener('mouseenter', begin);
      btn.addEventListener('mouseleave', clearTimer);
      btn.addEventListener('touchstart', (ev) => {
        ev.preventDefault();
        begin();
      }, { passive: false });
      btn.addEventListener('touchend', clearTimer);
      btn.addEventListener('touchcancel', clearTimer);
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        handler();
      });
    }

    function wireStartButton(btn) {
      let dwellTimer = null;

      const clearTimer = () => {
        if (dwellTimer) {
          clearTimeout(dwellTimer);
          dwellTimer = null;
        }
        resetDwellCircle(btn);
      };

      const begin = () => {
        if (isStartingExperience) {
          return;
        }
        const dwellMs = parseInt(dwellSelect.value, 10) || 1200;
        clearTimer();
        startDwellCircle(btn, dwellMs);
        dwellTimer = setTimeout(() => {
          clearTimer();
          launchTrailExperience();
        }, dwellMs + 12);
      };

      btn.addEventListener('mouseenter', begin);
      btn.addEventListener('mouseleave', clearTimer);
      btn.addEventListener('touchstart', (ev) => {
        ev.preventDefault();
        begin();
      }, { passive: false });
      btn.addEventListener('touchend', clearTimer);
      btn.addEventListener('touchcancel', clearTimer);
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        launchTrailExperience();
      });
    }

    wireStartButton(startButton);

    playAgainBtn.addEventListener('click', () => {
      if (!state.pathDef) return;
      hideCompletionBanner();
      resetTrailState(state.pathDef);
    });

    wireHudButton(restartBtn, () => {
      if (!state.pathDef) return;
      hideCompletionBanner();
      resetTrailState(state.pathDef);
    });

    wireHudButton(optionsBtn, () => {
      showOptionsPanel();
    });

    showOptionsPanel();
  </script>
</body>
</html>
